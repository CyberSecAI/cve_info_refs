Based on the provided content, here's a breakdown of the vulnerability and its fix:

**CVE ID:** CVE-2020-27152

**Root Cause of Vulnerability:**

The root cause is an infinite recursion loop within the KVM (Kernel-based Virtual Machine) ioapic (I/O Advanced Programmable Interrupt Controller) handling when a virtualized device using INTx interrupts and a resampler was being shut down. During shutdown, the IOAPIC trigger mode is reset to edge-triggered, but the vfio-pci INTx is still registered with a resampler leading to the following call sequence that creates a loop:

```
ioapic_set_irq
-> ioapic_lazy_update_eoi
-> kvm_ioapic_update_eoi_one
-> kvm_notify_acked_irq
-> kvm_notify_acked_gsi
-> (via irq_acked fn ptr) irqfd_resampler_ack
-> kvm_set_irq
-> (via set fn ptr) kvm_set_ioapic_irq
-> kvm_ioapic_set_irq
-> ioapic_set_irq (loop)
```

This recursive loop leads to a kernel stack overflow and DoS. The issue was acknowledged in a previous commit which attempted to avoid the loop but failed because the scenario was already set.

**Weaknesses/Vulnerabilities Present:**

- Infinite recursion: A specific sequence of events during shutdown allows the KVM IOAPIC code to enter an infinite recursion loop.
- Lack of proper synchronization or checks: The code does not properly check or restrict calls to avoid the recursion loop.
- Inadequate handling of edge-triggered interrupts with resamplers: The interaction between edge-triggered interrupts, resamplers, and lazy EOI updates was not handled safely.

**Impact of Exploitation:**

- Kernel stack overflow: The infinite recursion causes the kernel stack to overflow, leading to a crash.
- Denial of service (DoS): The crash of the host kernel results in a DoS condition.

**Attack Vectors:**

- Guest user can trigger the infinite loop during shutdown by manipulating virtualized devices that use INTx interrupts with a resampler.
- The vulnerability is specific to KVM on x86 platforms and affects systems using vfio-pci INTx.

**Required Attacker Capabilities/Position:**

- Ability to control or interact with a virtual machine (guest).
- The guest must be able to trigger INTx interrupts.
- The guest needs to have a device using a resampler registered with the IOAPIC.

**Fix:**

The fix removes the call to `kvm_ioapic_update_eoi_one` from the `ioapic_lazy_update_eoi` function. This eliminates the possibility of the infinite recursion loop. It also notes that SR-IOV assigned devices are not affected as they do not use INTx, only MSI.
The patch also removes the redundant call to `kvm_ioapic_update_eoi_one` from `ioapic_lazy_update_eoi` to prevent recursion.

**Additional Information:**

- This issue is not unique to macOS VMs. Linux guests can also trigger this problem, and it has been observed during PXE boot and shutdown of VMs with certain NIC combinations.
- A workaround was to disable acpiv (`kvm_intel.enable_apicv=0`).
- The issue can occur on Apple hardware too, and is triggered by the commit with ioapic_lazy_update_eoi.
- The vulnerability is due to incorrect interrupt state setting during shutdown and involves vfio-pci INTx and resamplers.

This commit also fixes the issue by removing the call to `kvm_ioapic_update_eoi_one` in `ioapic_lazy_update_eoi`, as i8254 timers are edge-triggered and thus do not require this behavior, as well as having AVIC disabled.