=== Content from git.kernel.org_a903a25e_20250119_111042.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zqiang <qiang.zhang@windriver.com> | 2020-06-05 11:05:33 +0800 |
| --- | --- | --- |
| committer | Felipe Balbi <balbi@kernel.org> | 2020-10-02 09:43:36 +0300 |
| commit | [e8d5f92b8d30bb4ade76494490c3c065e12411b1](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1)) | |
| tree | [ca4d77deb5534e6ea74c74524a9713c6b28df0c5](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1) | |
| parent | [aa8c16e42991be4709ef8cba022bb19a0b81282f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=aa8c16e42991be4709ef8cba022bb19a0b81282f) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1&id2=aa8c16e42991be4709ef8cba022bb19a0b81282f)) | |
| download | [linux-e8d5f92b8d30bb4ade76494490c3c065e12411b1.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e8d5f92b8d30bb4ade76494490c3c065e12411b1.tar.gz) | |

usb: gadget: function: printer: fix use-after-free in \_\_lock\_acquireFix this by increase object reference count.
BUG: KASAN: use-after-free in \_\_lock\_acquire+0x3fd4/0x4180
kernel/locking/lockdep.c:3831
Read of size 8 at addr ffff8880683b0018 by task syz-executor.0/3377
CPU: 1 PID: 3377 Comm: syz-executor.0 Not tainted 5.6.11 #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xce/0x128 lib/dump\_stack.c:118
print\_address\_description.constprop.4+0x21/0x3c0 mm/kasan/report.c:374
\_\_kasan\_report+0x131/0x1b0 mm/kasan/report.c:506
kasan\_report+0x12/0x20 mm/kasan/common.c:641
\_\_asan\_report\_load8\_noabort+0x14/0x20 mm/kasan/generic\_report.c:135
\_\_lock\_acquire+0x3fd4/0x4180 kernel/locking/lockdep.c:3831
lock\_acquire+0x127/0x350 kernel/locking/lockdep.c:4488
\_\_raw\_spin\_lock\_irqsave include/linux/spinlock\_api\_smp.h:110 [inline]
\_raw\_spin\_lock\_irqsave+0x35/0x50 kernel/locking/spinlock.c:159
printer\_ioctl+0x4a/0x110 drivers/usb/gadget/function/f\_printer.c:723
vfs\_ioctl fs/ioctl.c:47 [inline]
ksys\_ioctl+0xfb/0x130 fs/ioctl.c:763
\_\_do\_sys\_ioctl fs/ioctl.c:772 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:770 [inline]
\_\_x64\_sys\_ioctl+0x73/0xb0 fs/ioctl.c:770
do\_syscall\_64+0x9e/0x510 arch/x86/entry/common.c:294
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
RIP: 0033:0x4531a9
Code: ed 60 fc ff c3 66 2e 0f 1f 84 00 00 00 00 00 66 90 48 89 f8 48
89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d
01 f0 ff ff 0f 83 bb 60 fc ff c3 66 2e 0f 1f 84 00 00 00 00
RSP: 002b:00007fd14ad72c78 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
RAX: ffffffffffffffda RBX: 000000000073bfa8 RCX: 00000000004531a9
RDX: fffffffffffffff9 RSI: 000000000000009e RDI: 0000000000000003
RBP: 0000000000000003 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 00000000004bbd61
R13: 00000000004d0a98 R14: 00007fd14ad736d4 R15: 00000000ffffffff
Allocated by task 2393:
save\_stack+0x21/0x90 mm/kasan/common.c:72
set\_track mm/kasan/common.c:80 [inline]
\_\_kasan\_kmalloc.constprop.3+0xa7/0xd0 mm/kasan/common.c:515
kasan\_kmalloc+0x9/0x10 mm/kasan/common.c:529
kmem\_cache\_alloc\_trace+0xfa/0x2d0 mm/slub.c:2813
kmalloc include/linux/slab.h:555 [inline]
kzalloc include/linux/slab.h:669 [inline]
gprinter\_alloc+0xa1/0x870 drivers/usb/gadget/function/f\_printer.c:1416
usb\_get\_function+0x58/0xc0 drivers/usb/gadget/functions.c:61
config\_usb\_cfg\_link+0x1ed/0x3e0 drivers/usb/gadget/configfs.c:444
configfs\_symlink+0x527/0x11d0 fs/configfs/symlink.c:202
vfs\_symlink+0x33d/0x5b0 fs/namei.c:4201
do\_symlinkat+0x11b/0x1d0 fs/namei.c:4228
\_\_do\_sys\_symlinkat fs/namei.c:4242 [inline]
\_\_se\_sys\_symlinkat fs/namei.c:4239 [inline]
\_\_x64\_sys\_symlinkat+0x73/0xb0 fs/namei.c:4239
do\_syscall\_64+0x9e/0x510 arch/x86/entry/common.c:294
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
Freed by task 3368:
save\_stack+0x21/0x90 mm/kasan/common.c:72
set\_track mm/kasan/common.c:80 [inline]
kasan\_set\_free\_info mm/kasan/common.c:337 [inline]
\_\_kasan\_slab\_free+0x135/0x190 mm/kasan/common.c:476
kasan\_slab\_free+0xe/0x10 mm/kasan/common.c:485
slab\_free\_hook mm/slub.c:1444 [inline]
slab\_free\_freelist\_hook mm/slub.c:1477 [inline]
slab\_free mm/slub.c:3034 [inline]
kfree+0xf7/0x410 mm/slub.c:3995
gprinter\_free+0x49/0xd0 drivers/usb/gadget/function/f\_printer.c:1353
usb\_put\_function+0x38/0x50 drivers/usb/gadget/functions.c:87
config\_usb\_cfg\_unlink+0x2db/0x3b0 drivers/usb/gadget/configfs.c:485
configfs\_unlink+0x3b9/0x7f0 fs/configfs/symlink.c:250
vfs\_unlink+0x287/0x570 fs/namei.c:4073
do\_unlinkat+0x4f9/0x620 fs/namei.c:4137
\_\_do\_sys\_unlink fs/namei.c:4184 [inline]
\_\_se\_sys\_unlink fs/namei.c:4182 [inline]
\_\_x64\_sys\_unlink+0x42/0x50 fs/namei.c:4182
do\_syscall\_64+0x9e/0x510 arch/x86/entry/common.c:294
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
The buggy address belongs to the object at ffff8880683b0000
which belongs to the cache kmalloc-1k of size 1024
The buggy address is located 24 bytes inside of
1024-byte region [ffff8880683b0000, ffff8880683b0400)
The buggy address belongs to the page:
page:ffffea0001a0ec00 refcount:1 mapcount:0 mapping:ffff88806c00e300
index:0xffff8880683b1800 compound\_mapcount: 0
flags: 0x100000000010200(slab|head)
raw: 0100000000010200 0000000000000000 0000000600000001 ffff88806c00e300
raw: ffff8880683b1800 000000008010000a 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected
Reported-by: Kyungtae Kim <kt0755@gmail.com>
Signed-off-by: Zqiang <qiang.zhang@windriver.com>
Signed-off-by: Felipe Balbi <balbi@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1)

| -rw-r--r-- | [drivers/usb/gadget/function/f\_printer.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/usb/gadget/function/f_printer.c?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/drivers/usb/gadget/function/f\_printer.c b/drivers/usb/gadget/function/f\_printer.cindex 68697f596066c6..64a4112068fc8b 100644--- a/[drivers/usb/gadget/function/f\_printer.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/usb/gadget/function/f_printer.c?id=aa8c16e42991be4709ef8cba022bb19a0b81282f)+++ b/[drivers/usb/gadget/function/f\_printer.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/usb/gadget/function/f_printer.c?id=e8d5f92b8d30bb4ade76494490c3c065e12411b1)@@ -31,6 +31,7 @@ #include <linux/types.h> #include <linux/ctype.h> #include <linux/cdev.h>+#include <linux/kref.h>  #include <asm/byteorder.h> #include <linux/io.h>@@ -64,7 +65,7 @@ struct printer\_dev { struct usb\_gadget \*gadget; s8 interface; struct usb\_ep \*in\_ep, \*out\_ep;-+ struct kref kref; struct list\_head rx\_reqs; /\* List of free RX structs \*/ struct list\_head rx\_reqs\_active; /\* List of Active RX xfers \*/ struct list\_head rx\_buffers; /\* List of completed xfers \*/@@ -218,6 +219,13 @@ static inline struct usb\_endpoint\_descriptor \*ep\_desc(struct usb\_gadget \*gadget,  /\*-------------------------------------------------------------------------\*/ +static void printer\_dev\_free(struct kref \*kref)+{+ struct printer\_dev \*dev = container\_of(kref, struct printer\_dev, kref);++ kfree(dev);+}+ static struct usb\_request \* printer\_req\_alloc(struct usb\_ep \*ep, unsigned len, gfp\_t gfp\_flags) {@@ -353,6 +361,7 @@ printer\_open(struct inode \*inode, struct file \*fd)  spin\_unlock\_irqrestore(&dev->lock, flags); + kref\_get(&dev->kref); DBG(dev, "printer\_open returned %x\n", ret); return ret; }@@ -370,6 +379,7 @@ printer\_close(struct inode \*inode, struct file \*fd) dev->printer\_status &= ~PRINTER\_SELECTED; spin\_unlock\_irqrestore(&dev->lock, flags); + kref\_put(&dev->kref, printer\_dev\_free); DBG(dev, "printer\_close\n");  return 0;@@ -1386,7 +1396,8 @@ static void gprinter\_free(struct usb\_function \*f) struct f\_printer\_opts \*opts;  opts = container\_of(f->fi, struct f\_printer\_opts, func\_inst);- kfree(dev);++ kref\_put(&dev->kref, printer\_dev\_free); mutex\_lock(&opts->lock); --opts->refcnt; mutex\_unlock(&opts->lock);@@ -1455,6 +1466,7 @@ static struct usb\_function \*gprinter\_alloc(struct usb\_function\_instance \*fi) return ERR\_PTR(-ENOMEM); } + kref\_init(&dev->kref); ++opts->refcnt; dev->minor = opts->minor; dev->pnp\_string = opts->pnp\_string; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-19 10:55:52 +0000


