=== Content from gerrit.wikimedia.org_d4081ab1_20250119_122104.html ===




=== Content from phabricator.wikimedia.org_6b93f59d_20250119_122106.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT265810)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T265810
# mw-ext-FileImporter uses a WMF IP address, does not include XFF for users using this extension (CVE-2020-27621)Closed, Resolved[Public](/policy/explain/PHID-TASK-laulmbrxaamhyuotjent/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/265810/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/265810/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-laulmbrxaamhyuotjent/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-laulmbrxaamhyuotjent/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-laulmbrxaamhyuotjent/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-laulmbrxaamhyuotjent/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-laulmbrxaamhyuotjent/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-laulmbrxaamhyuotjent/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-laulmbrxaamhyuotjent/)
* [Protect as security issue](/wmf/escalate-task/265810/)
* [Award Token](/token/give/PHID-TASK-laulmbrxaamhyuotjent/)
* [Flag For Later](/flag/edit/PHID-TASK-laulmbrxaamhyuotjent/)

Assigned To

|  | [thiemowmde](/p/thiemowmde/) |
| --- | --- |

Authored By

|  | [Risker](/p/Risker/) |
| --- | --- |
| Oct 18 2020, 4:46 AM2020-10-18 04:46:36 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [Move-Files-To-Commons](/tag/move-files-to-commons/) [(Tickets in sprint)](/project/board/2671/)
* [Unplanned-Sprint-Work](/tag/unplanned-sprint-work/)
* [WMDE-QWERTY-Sprint-2020-10-07](/tag/wmde-qwerty-sprint-2020-10-07/) [(Done)](/project/board/5023/)
* [MW-1.36-notes (1.36.0-wmf.13; 2020-10-12)](/project/view/5005/)
* [Vuln-Misconfiguration](/tag/vuln-misconfiguration/) [(Tracked)](/project/board/1344/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [AmandaNP](/p/AmandaNP/) |
| --- | --- |

|  | [Andrew-WMDE](/p/Andrew-WMDE/) |
| --- | --- |

|  | [awight](/p/awight/) |
| --- | --- |

|  | [jrbs](/p/jrbs/) |
| --- | --- |

|  | [• Lea\_WMDE](/p/Lea_WMDE/) |
| --- | --- |

|  | [Lena\_WMDE](/p/Lena_WMDE/) |
| --- | --- |

[View All 16 Subscribers](/subscriptions/list/PHID-TASK-laulmbrxaamhyuotjent/)
# Description

Identified this issue when checkusering a suspicious account; one of the IPs the account used was mw-ext-FileImporter, and at first glance it looked like it was some sort of shared IP because the "readout" on the CU result said:

* 2620:0:860:2:208:80:153:61 (block) (16:40, 21 September 2020 -- 03:33, 12 October 2020) [35] (~2,288 from all users)
* Check of the IP revealed that it ends every CU log entry with IP: 2620:0:860:2:208:80:153:61 mw-ext-FileImporter/\* ([https://www.mediawiki.org/wiki/Extension:FileImporter](https://www.mediawiki.org/wiki/Extension%3AFileImporter))

This is a problem.

\*First, it doesn't give the XFF or true IP address of the person using the extension. It is acting essentially as an open proxy.

\*Second, it's not restricted in its use to people with File Mover permission. The account I was checking does not have that permission.

\*Third, if someone who used this extension recently got blocked with "autoblock" selected (as is standard on English Wikipedia), it would cause cascading blocks to every other user who tried to use the extension during the block period, until we figured out what was happening. It would essentially disable this extension on English Wikipedia.

Not sure how this wasn't noticed/reported before. But I was doing the Checkuser with the expectation that I would be blocking the account involved, and this was a close call. It is only a matter of luck that it hasn't happened already.

# Details

Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Set originalRequest (incl. X-Forwarded-For) for remote edits](https://gerrit.wikimedia.org/r/c/635328) | [mediawiki/extensions/FileImporter](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter/%2B/REL1_35) | +13 -2 |
|  | [Set originalRequest (incl. X-Forwarded-For) for remote edits](https://gerrit.wikimedia.org/r/c/635040) | [mediawiki/extensions/FileImporter](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter) | [wmf/1.36.0-wmf.14](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter/%2B/wmf/1.36.0-wmf.14) | +11 -2 |
|  | [Set originalRequest (incl. X-Forwarded-For) for remote edits](https://gerrit.wikimedia.org/r/c/635039) | [mediawiki/extensions/FileImporter](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter) | [wmf/1.36.0-wmf.13](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter/%2B/wmf/1.36.0-wmf.13) | +11 -2 |
|  | [Set originalRequest (incl. X-Forwarded-For) for remote edits](https://gerrit.wikimedia.org/r/c/635265) | [mediawiki/extensions/FileImporter](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/FileImporter/%2B/master) | +11 -2 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T265810)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  |  |  |  | Restricted Task |
|  |  | Resolved | Security | [thiemowmde](/p/thiemowmde/) | T265810 [mw-ext-FileImporter uses a WMF IP address, does not include XFF for users using this extension (CVE-2020-27621)](/T265810) |

Mentioned In [rEFLIa3f025ff07ad: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLIa3f025ff07adce1046676f67ad35a2f7b985f8a4)
[T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810)
[rEFLI5eee9b773338: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLI5eee9b773338e5181867cabec9faefbdeacf67ca)
[rEFLI5f8d3de14c11: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLI5f8d3de14c116b618f5226419082d5c9a07766fb)
[rEFLIff0ec0ac1ce5: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLIff0ec0ac1ce55d521536e533319a58b886acc82a)
### Event Timeline

[Risker](/p/Risker/) created this task.[Oct 18 2020, 4:46 AM2020-10-18 04:46:36 (UTC+0)](#6557880)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/3943609/)[Oct 18 2020, 4:46 AM2020-10-18 04:46:37 (UTC+0)](#6557891)[SQL](/p/SQL/) added a comment.[Oct 18 2020, 4:48 AM2020-10-18 04:48:42 (UTC+0)](#6557892)Comment Actions

Non-ideal at best. This should report the user's address.

<https://whois.toolforge.org/gateway.py?lookup=true&ip=2620%3A0%3A860%3A2%3A208%3A80%3A153%3A61>

[Aklapper](/p/Aklapper/) added a project: [Move-Files-To-Commons](/tag/move-files-to-commons/).[Oct 18 2020, 9:50 AM2020-10-18 09:50:41 (UTC+0)](#6558005)

[Urbanecm](/p/Urbanecm/) added subscribers: [• Lea\_WMDE](/p/Lea_WMDE/), [awight](/p/awight/), [Lena\_WMDE](/p/Lena_WMDE/), [Urbanecm](/p/Urbanecm/).[Oct 18 2020, 11:02 AM2020-10-18 11:02:17 (UTC+0)](#6558055)Comment Actions

Adding few people from WMDE based on <https://phabricator.wikimedia.org/project/members/2671/>.

[Tks4Fish](/p/Tks4Fish/) subscribed.[Oct 18 2020, 12:40 PM2020-10-18 12:40:20 (UTC+0)](#6558168)[Risker](/p/Risker/) added a subscriber: [AmandaNP](/p/AmandaNP/).[Oct 18 2020, 7:02 PM2020-10-18 19:02:02 (UTC+0)](#6558475)This comment was removed by [Risker](/p/Risker/).[AmandaNP](/p/AmandaNP/) added a parent task: Restricted Task.[Oct 18 2020, 7:06 PM2020-10-18 19:06:09 (UTC+0)](#6558486)[awight](/p/awight/) added subscribers: [Andrew-WMDE](/p/Andrew-WMDE/), [lilients\_WMDE](/p/lilients_WMDE/).[Oct 19 2020, 1:06 PM2020-10-19 13:06:14 (UTC+0)](#6560275)[Reedy](/p/Reedy/) moved this task from [Incoming](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Oct 19 2020, 3:26 PM2020-10-19 15:26:24 (UTC+0)](#6560764)[awight](/p/awight/) added subscribers: [thiemowmde](/p/thiemowmde/), [WMDE-Fisch](/p/WMDE-Fisch/).[Oct 20 2020, 9:05 AM2020-10-20 09:05:01 (UTC+0)](#6563249)[awight](/p/awight/) added projects: [Unplanned-Sprint-Work](/tag/unplanned-sprint-work/), [WMDE-QWERTY-Sprint-2020-10-07](/tag/wmde-qwerty-sprint-2020-10-07/).[Oct 20 2020, 10:15 AM2020-10-20 10:15:09 (UTC+0)](#6563488)[thiemowmde](/p/thiemowmde/) moved this task from [Backlog](/project/board/2671/) to [Tickets in sprint](/project/board/2671/) on the [Move-Files-To-Commons](/tag/move-files-to-commons/) board.[Oct 20 2020, 10:42 AM2020-10-20 10:42:40 (UTC+0)](#6563579)Comment Actions

[@Risker](/p/Risker/), thanks for the report. Based on the idea that an X-Forwarded-For header might be missing somewhere, we reviewed the FileImporter's workflow. So far we can think of only one place that might be related: when FileImporter does an remote edit to mark the file on the source wiki as {{NowCommons}}. I created a proof-of-concept patch at <https://gerrit.wikimedia.org/r/635265>. Unfortunately we aren't able to confirm this at the moment. No team member does have CheckUser rights. Can you point us to a revision ID that was attributed to this awkward FileImporter IP?

[Urbanecm](/p/Urbanecm/) added a comment.Edited · [Oct 20 2020, 11:37 AM2020-10-20 11:37:02 (UTC+0)](#6563775)Comment Actions

[@thiemowmde](/p/thiemowmde/) As long as originalRequest will add the header, your patch seems to be correct. You can find a list of five examples at P13028 (NDA-only paste; you can subscribe other WMDE staff if needed; note almost all pages are deleted, happy to screenshot the history if needed).

[thiemowmde](/p/thiemowmde/) added a comment.[Oct 20 2020, 12:09 PM2020-10-20 12:09:40 (UTC+0)](#6563872)Comment Actions

Awesome, thanks! I don't want to past a user or file name here. But the list confirms this is indeed about the remote edits that mark the source file as being moved to commons. The summary line for all edits in question is This file is now on Wikimedia Commons at https://commons.wikimedia.org/wiki/File:… (moved with FileImporter).

[Lena\_WMDE](/p/Lena_WMDE/) moved this task from [Sprint Backlog](/project/board/5023/) to [Doing](/project/board/5023/) on the [WMDE-QWERTY-Sprint-2020-10-07](/tag/wmde-qwerty-sprint-2020-10-07/) board.[Oct 20 2020, 12:14 PM2020-10-20 12:14:18 (UTC+0)](#6563902)[thiemowmde](/p/thiemowmde/) claimed this task.[Oct 20 2020, 12:22 PM2020-10-20 12:22:59 (UTC+0)](#6563922)[thiemowmde](/p/thiemowmde/) moved this task from [Doing](/project/board/5023/) to [Review](/project/board/5023/) on the [WMDE-QWERTY-Sprint-2020-10-07](/tag/wmde-qwerty-sprint-2020-10-07/) board.Comment Actions

Note the patch will fix this only for future edits. Edits already in the cuc\_ip database table will still contain a wrong IP address. Please let us know if you think this is a problem that needs fixing.

[Urbanecm](/p/Urbanecm/) added a comment.[Oct 20 2020, 12:32 PM2020-10-20 12:32:45 (UTC+0)](#6563977)Comment Actions

[@thiemowmde](/p/thiemowmde/) I don't think you can fix it - the IP isn't stored anywhere now.

[Urbanecm](/p/Urbanecm/) added a comment.[Oct 20 2020, 1:08 PM2020-10-20 13:08:17 (UTC+0)](#6564064)Comment Actions

/me impersonates gerritbot

Change 635265 **approved** by Urbanecm:

[mediawiki/extensions/FileImporter@master] Set originalRequest (incl. X-Forwarded-For) for remote edits

<https://gerrit.wikimedia.org/r/635265>

[Urbanecm](/p/Urbanecm/) added a comment.[Oct 20 2020, 1:26 PM2020-10-20 13:26:48 (UTC+0)](#6564205)Comment Actions

/me impersonates gerritbot

Change 635265 **merged** by jenkins-bot:

[mediawiki/extensions/FileImporter@master] Set originalRequest (incl. X-Forwarded-For) for remote edits

<https://gerrit.wikimedia.org/r/635265>

Change 635039 had a related patch set uploaded (by Urbanecm; owner Urbanecm):

[mediawiki/extensions/FileImporter@wmf/1.36.0-wmf.13] Set originalRequest (incl. X-Forwarded-For) for remote edits

<https://gerrit.wikimedia.org/r/635039>

Change 635040 had a related patch set uploaded (by Urbanecm; owner Urbanecm):

[mediawiki/extensions/FileImporter@wmf/1.36.0-wmf.14] Set originalRequest (incl. X-Forwarded-For) for remote edits

<https://gerrit.wikimedia.org/r/635040>

[thiemowmde](/p/thiemowmde/) mentioned this in [rEFLIff0ec0ac1ce5: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLIff0ec0ac1ce55d521536e533319a58b886acc82a).[Oct 20 2020, 1:31 PM2020-10-20 13:31:08 (UTC+0)](#6564253)[Urbanecm](/p/Urbanecm/) mentioned this in [rEFLI5f8d3de14c11: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLI5f8d3de14c116b618f5226419082d5c9a07766fb).[Oct 20 2020, 2:00 PM2020-10-20 14:00:04 (UTC+0)](#6564367)[Urbanecm](/p/Urbanecm/) mentioned this in [rEFLI5eee9b773338: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLI5eee9b773338e5181867cabec9faefbdeacf67ca).[Oct 20 2020, 2:46 PM2020-10-20 14:46:07 (UTC+0)](#6564529)

[Urbanecm](/p/Urbanecm/) closed this task as Resolved.[Oct 20 2020, 2:48 PM2020-10-20 14:48:21 (UTC+0)](#6564554)Comment Actions

I've deployed the change. Should work fine now.

[Jdforrester-WMF](/p/Jdforrester-WMF/) added a project: [MW-1.36-notes (1.36.0-wmf.16; 2020-11-03)](/project/view/5029/).[Oct 20 2020, 3:00 PM2020-10-20 15:00:05 (UTC+0)](#6564651)

[Urbanecm](/p/Urbanecm/) edited projects, added [MW-1.36-notes (1.36.0-wmf.13; 2020-10-12)](/project/view/5005/); removed [MW-1.36-notes (1.36.0-wmf.16; 2020-11-03)](/project/view/5029/).[Oct 20 2020, 3:02 PM2020-10-20 15:02:44 (UTC+0)](#6564663)Comment Actions

Adding wmf.13 tag, because this is deployed as-of wmf.13.

[sbassett](/p/sbassett/) triaged this task as Low priority.[Oct 20 2020, 4:12 PM2020-10-20 16:12:25 (UTC+0)](#6564944)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-m45djail4lh6d36/)" to "Public (No Login Required)".[sbassett](/p/sbassett/) mentioned this in [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810).[sbassett](/p/sbassett/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Oct 20 2020, 4:14 PM2020-10-20 16:14:26 (UTC+0)](#6564950)[gerritbot](/p/gerritbot/) added a comment.[Oct 20 2020, 4:15 PM2020-10-20 16:15:41 (UTC+0)](#6564956)Comment Actions

Change 635328 had a related patch set uploaded (by Urbanecm; owner: Thiemo Kreuz (WMDE)):

[mediawiki/extensions/FileImporter@REL1\_35] Set originalRequest (incl. X-Forwarded-For) for remote edits

<https://gerrit.wikimedia.org/r/635328>

[gerritbot](/p/gerritbot/) added a comment.[Oct 20 2020, 9:37 PM2020-10-20 21:37:19 (UTC+0)](#6566402)Comment Actions

Change 635328 **merged** by jenkins-bot:

[mediawiki/extensions/FileImporter@REL1\_35] Set originalRequest (incl. X-Forwarded-For) for remote edits

<https://gerrit.wikimedia.org/r/635328>

[thiemowmde](/p/thiemowmde/) mentioned this in [rEFLIa3f025ff07ad: Set originalRequest (incl. X-Forwarded-For) for remote edits](/rEFLIa3f025ff07adce1046676f67ad35a2f7b985f8a4).[Oct 20 2020, 9:39 PM2020-10-20 21:39:53 (UTC+0)](#6566405)[thiemowmde](/p/thiemowmde/) moved this task from [Review](/project/board/5023/) to [Done](/project/board/5023/) on the [WMDE-QWERTY-Sprint-2020-10-07](/tag/wmde-qwerty-sprint-2020-10-07/) board.[Oct 21 2020, 7:05 AM2020-10-21 07:05:01 (UTC+0)](#6566980)[sbassett](/p/sbassett/) renamed this task from mw-ext-FileImporter uses a WMF IP address, does not include XFF for users using this extension to mw-ext-FileImporter uses a WMF IP address, does not include XFF for users using this extension (CVE-2020-27621).[Oct 22 2020, 8:28 PM2020-10-22 20:28:10 (UTC+0)](#6572865)[sbassett](/p/sbassett/) added a project: [Vuln-Misconfiguration](/tag/vuln-misconfiguration/).[Mar 16 2021, 9:29 PM2021-03-16 21:29:59 (UTC+0)](#6919522)[RhinosF1](/p/RhinosF1/) subscribed.[Mar 16 2021, 9:32 PM2021-03-16 21:32:16 (UTC+0)](#6919538)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
