=== Content from phabricator.wikimedia.org_1a30f2c0_20250119_123958.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT265440)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T265440
# Cosmos skin: Mix used of wfMessage() calls with no output mode and Html::rawElement (CVE-2020-27620)Closed, Resolved[Public](/policy/explain/PHID-TASK-lhrzl3mrkjn24cm257tr/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/265440/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/265440/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* [Protect as security issue](/wmf/escalate-task/265440/)
* [Award Token](/token/give/PHID-TASK-lhrzl3mrkjn24cm257tr/)
* [Flag For Later](/flag/edit/PHID-TASK-lhrzl3mrkjn24cm257tr/)

Assigned To

|  | [SamanthaNguyen](/p/SamanthaNguyen/) |
| --- | --- |

Authored By

|  | [SamanthaNguyen](/p/SamanthaNguyen/) |
| --- | --- |
| Oct 14 2020, 1:33 AM2020-10-14 01:33:37 (UTC+0) |

Tags

* [Security](/tag/security/)
* [Vuln-XSS](/tag/vuln-xss/)
* [Cosmos](/tag/cosmos/) [(Done)](/project/board/5017/)
Referenced Files

|  | [F32383972: T265440.patch](/F32383972) |
| --- | --- |
| Oct 14 2020, 2:05 AM2020-10-14 02:05:40 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [alistair3149](/p/alistair3149/) |
| --- | --- |

|  | [DannyS712](/p/DannyS712/) |
| --- | --- |

|  | [RhinosF1](/p/RhinosF1/) |
| --- | --- |

|  | [SamanthaNguyen](/p/SamanthaNguyen/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

|  | [Universal\_Omega](/p/Universal_Omega/) |
| --- | --- |

# Description

The Cosmos skin calls Html::rawElement() many times, and also calls wfMessage(). However, some wfMessage calls are not properly escaped, so this allows XSS injection. There are many cases of this happening, and all of these need to be properly audited...

In CosmosSocialProfile::getUserGroups() ( Lines 44 and Line 58, <https://github.com/wikimedia/mediawiki-skins-Cosmos/blob/master/includes/CosmosSocialProfile.php#L44-L58> ):

```
$usertags = Html::rawElement( 'span', [ 'class' => 'tag tag-blocked' ], wfMessage( 'cosmos-user-blocked' ) );
$usertags .= Html::rawElement( 'span', [ 'class' => 'tag tag-' . Sanitizer::escapeClass( $value ) ], ucfirst( wfMessage( 'group-' . $value . '-member' ) ) );
```

There are many i18n message calls calls in CosmosTemplate, but most of them are either passed through Sanitizer::escapeIdForAttribute() or use the text as the output mode (->text()). These seem to be the only two cases of security issues.

Codesearch query: <https://codesearch.wmcloud.org/skins/?q=(wfMessage%7C%5C%24this-%3EgetMsg)&i=nope&files=&repos=Skin:Cosmos>

# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY [XSS-Injection]: Properly escape i18n message calls that had no output mode](https://gerrit.wikimedia.org/r/c/634752) | [mediawiki/skins/Cosmos](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Cosmos) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Cosmos/%2B/REL1_35) | +2 -2 |
|  | [SECURITY [XSS-Injection]: Properly escape i18n message calls that had no output mode](https://gerrit.wikimedia.org/r/c/634751) | [mediawiki/skins/Cosmos](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Cosmos) | [REL1\_34](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Cosmos/%2B/REL1_34) | +2 -2 |
|  | [SECURITY [XSS-Injection]: Properly escape i18n message calls that had no output mode](https://gerrit.wikimedia.org/r/c/634749) | [mediawiki/skins/Cosmos](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Cosmos) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/skins/Cosmos/%2B/master) | +2 -2 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T265440)
# Related Objects

* Mentions

Mentioned In [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810) Mentioned Here [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810)
### Event Timeline

[SamanthaNguyen](/p/SamanthaNguyen/) created this task.[Oct 14 2020, 1:33 AM2020-10-14 01:33:37 (UTC+0)](#6541181)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  Â· [View Herald Transcript](/herald/transcript/3931989/)[Oct 14 2020, 1:33 AM2020-10-14 01:33:38 (UTC+0)](#6541191)[SamanthaNguyen](/p/SamanthaNguyen/) added a project: [Vuln-XSS](/tag/vuln-xss/).[Oct 14 2020, 1:40 AM2020-10-14 01:40:33 (UTC+0)](#6541196)[SamanthaNguyen](/p/SamanthaNguyen/) added a comment.[Oct 14 2020, 2:05 AM2020-10-14 02:05:40 (UTC+0)](#6541215)Comment Actions

T265440.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/l7ysfjt56i5rsovq37ef/PHID-FILE-k5k4pcjk7rwlmauis6w7/T265440.patch)

[Aklapper](/p/Aklapper/) added a project: [Cosmos](/tag/cosmos/).[Oct 14 2020, 12:33 PM2020-10-14 12:33:54 (UTC+0)](#6542214)[Urbanecm](/p/Urbanecm/) added a subscriber: [DannyS712](/p/DannyS712/).[Oct 14 2020, 5:58 PM2020-10-14 17:58:50 (UTC+0)](#6543583)[Universal\_Omega](/p/Universal_Omega/) moved this task from [Incoming / Backlog](/project/board/5017/) to [Code hygiene](/project/board/5017/) on the [Cosmos](/tag/cosmos/) board.[Oct 14 2020, 6:51 PM2020-10-14 18:51:34 (UTC+0)](#6543858)[SamanthaNguyen](/p/SamanthaNguyen/) moved this task from [Code hygiene](/project/board/5017/) to [In Progress](/project/board/5017/) on the [Cosmos](/tag/cosmos/) board.[Oct 15 2020, 12:09 AM2020-10-15 00:09:35 (UTC+0)](#6544966)[SamanthaNguyen](/p/SamanthaNguyen/) added a comment.[Oct 15 2020, 11:31 PM2020-10-15 23:31:49 (UTC+0)](#6548944)Comment Actions

Hi everyone, I hope this is fine. It's not to rush anyone, its just this is a matter of being a security issue (albeit, not a repository that's deployed on Wikimedia). Does the patch above look OK? I received an OK from Universal Omega on Discord, and I would like to receive at least one more OK so I can push this to master branch and backport it to the other branches as well. Also CC'ing [@DannyS712](/p/DannyS712/), since Urbanecm added them as a subscriber.

[SamanthaNguyen](/p/SamanthaNguyen/) added a subscriber: [alistair3149](/p/alistair3149/).[Oct 15 2020, 11:33 PM2020-10-15 23:33:51 (UTC+0)](#6548945)Comment Actions

Adding [@alistair3149](/p/alistair3149/) as a subscriber, as they recently joined the developer team for the Cosmos skin.

[SamanthaNguyen](/p/SamanthaNguyen/) moved this task from [In Progress](/project/board/5017/) to [Blocked](/project/board/5017/) on the [Cosmos](/tag/cosmos/) board.[Oct 17 2020, 3:31 PM2020-10-17 15:31:52 (UTC+0)](#6557533)[SamanthaNguyen](/p/SamanthaNguyen/) triaged this task as High priority.[Oct 17 2020, 4:17 PM2020-10-17 16:17:01 (UTC+0)](#6557566)[SamanthaNguyen](/p/SamanthaNguyen/) added a comment.[Oct 17 2020, 10:02 PM2020-10-17 22:02:32 (UTC+0)](#6557814)Comment Actions

Patches rolled-out to master, REL1\_35, and REL1\_34:

* master: [https://gerrit.wikimedia.org/r/c/mediawiki/skins/Cosmos/+/634749](https://gerrit.wikimedia.org/r/c/mediawiki/skins/Cosmos/%2B/634749)
* REL1\_35: [https://gerrit.wikimedia.org/r/c/mediawiki/skins/Cosmos/+/634752](https://gerrit.wikimedia.org/r/c/mediawiki/skins/Cosmos/%2B/634752)
* REL1\_34: [https://gerrit.wikimedia.org/r/c/mediawiki/skins/Cosmos/+/634751](https://gerrit.wikimedia.org/r/c/mediawiki/skins/Cosmos/%2B/634751)
[SamanthaNguyen](/p/SamanthaNguyen/) claimed this task.[Oct 17 2020, 10:16 PM2020-10-17 22:16:25 (UTC+0)](#6557819)[SamanthaNguyen](/p/SamanthaNguyen/) moved this task from [Blocked](/project/board/5017/) to [Done](/project/board/5017/) on the [Cosmos](/tag/cosmos/) board.Comment Actions

Not sure whether I should make this task as resolved **and** public, but it's done on our side now, so moving on the Cosmos workboard.

[Reedy](/p/Reedy/) removed a project: [Security-Team](/tag/security-team/).[Oct 19 2020, 3:04 PM2020-10-19 15:04:01 (UTC+0)](#6560634)[sbassett](/p/sbassett/) subscribed.[Oct 19 2020, 4:19 PM2020-10-19 16:19:39 (UTC+0)](#6561117)Comment Actions

[@SamanthaNguyen](/p/SamanthaNguyen/) - I'm not seeing anything on the task that would necessitate this remaining private, so we can make it public if you'd like, just let us know (if you don't have permissions to do so). Also, we can track this at [T263810](/T263810) for increased visibility if you'd like.

[SamanthaNguyen](/p/SamanthaNguyen/) added a comment.[Oct 19 2020, 5:02 PM2020-10-19 17:02:14 (UTC+0)](#6561338)Comment Actions

[@sbassett](/p/sbassett/) Hi! Yes please, I tried looking but I don't see any UI button on my screen to make this task public. Thank you! I don't have access to [T263810](/T263810), but I'm guessing that it would be related to this task then?

[sbassett](/p/sbassett/) closed this task as Resolved.[Oct 19 2020, 5:09 PM2020-10-19 17:09:40 (UTC+0)](#6561372)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-7jdn7sxd6mxmvaf/)" to "Public (No Login Required)".[sbassett](/p/sbassett/) added a comment.[Oct 19 2020, 5:12 PM2020-10-19 17:12:05 (UTC+0)](#6561377)Comment Actions

[@SamanthaNguyen](/p/SamanthaNguyen/) - Ok, I've resolved this task and made it public. [T263810](/T263810) is just the tracking task for the quarterly-ish supplemental exts/skins announcement (recent example: <https://lists.wikimedia.org/pipermail/wikitech-l/2020-September/093904.html>). I subbed you to the task, but perhaps that's not enough to override the current security setting.

[sbassett](/p/sbassett/) mentioned this in [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810).[Oct 19 2020, 5:14 PM2020-10-19 17:14:37 (UTC+0)](#6561387)[SamanthaNguyen](/p/SamanthaNguyen/) added a comment.[Oct 19 2020, 5:15 PM2020-10-19 17:15:34 (UTC+0)](#6561393)Comment Actions

[@sbassett](/p/sbassett/) Thanks for clearing that up. And yeah I'm not sure, it looks like I'm still not able to see the task unfortunately?

[sbassett](/p/sbassett/) added a comment.[Oct 19 2020, 5:17 PM2020-10-19 17:17:11 (UTC+0)](#6561397)Comment Actions
> In [T265440#6561393](/T265440#6561393), [@SamanthaNguyen](/p/SamanthaNguyen/) wrote:
>
> [@sbassett](/p/sbassett/) Thanks for clearing that up. And yeah I'm not sure, it looks like I'm still not able to see the task unfortunately?

Hmm, we might not be able to add folks outside of [acl\*security\_team](/tag/acl_security_team/) then. Sorry about that. I am tracking this task there now and will likely request a CVE for this issue.

[SamanthaNguyen](/p/SamanthaNguyen/) added a comment.[Oct 19 2020, 5:24 PM2020-10-19 17:24:35 (UTC+0)](#6561413)Comment Actions

Okay that's fine, thank you anyways!

[RhinosF1](/p/RhinosF1/) subscribed.[Oct 19 2020, 5:26 PM2020-10-19 17:26:22 (UTC+0)](#6561421)[sbassett](/p/sbassett/) renamed this task from Cosmos skin: Mix used of wfMessage() calls with no output mode and Html::rawElement to Cosmos skin: Mix used of wfMessage() calls with no output mode and Html::rawElement (CVE-2020-27620).[Oct 22 2020, 8:27 PM2020-10-22 20:27:24 (UTC+0)](#6572864)[RhinosF1](/p/RhinosF1/) added a comment.Edited Â· [Oct 22 2020, 9:03 PM2020-10-22 21:03:54 (UTC+0)](#6572938)Comment Actions

Thanks for getting the CVE sorted [@sbassett](/p/sbassett/)

Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. Â· [Wikimedia Foundation](https://wikimediafoundation.org/) Â· [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) Â· [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) Â· [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) Â· [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) Â· [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) Â· [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) Â· [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from gerrit.wikimedia.org_321337e2_20250119_123957.html ===




=== Content from gerrit.wikimedia.org_0f4ccfb6_20250119_123957.html ===




=== Content from gerrit.wikimedia.org_fe6a482b_20250119_123957.html ===



