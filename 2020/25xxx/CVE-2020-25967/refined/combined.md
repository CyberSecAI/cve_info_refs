=== Content from www.cnpanda.net_3427c335_20250119_121507.html ===


[![Panda | 热爱安全的理想少年](https://www.cnpanda.net/logo.png)](https://www.cnpanda.net/)

搜一搜

# fastadmin最新版前台getshell漏洞分析

本文最后更新于 2021.03.17，总计 3097 字，阅读本文大概需要5 ~ 20 分钟。

本文已超过 1403天没有更新。如果文章内容或图片资源失效，请留言反馈，我会及时处理，谢谢！

## 影响版本

V1.0.0.20200506\_beta（最新版）

## 利用限制

/application/config.php 文件中：

```
    //是否开启前台会员中心
    'usercenter'            => true,
```

即需要开启会员中心功能

## 漏洞分析

`/application/index/User.php`文件

第58-67行：

```
 public function _empty($name)
    {
        $data = Hook::listen("user_request_empty", $name);
            foreach ($data as $index => $datum) {
            $this->view->assign($datum);
            }
    return $this->view->fetch($name);
}
```

`user_request_empty`为开发者预留的钩子可以忽视不看，主要看 `return $this->view->fetch($name);`

此方法中的`$name`参数可控，并且将`$name`的值传入到了`fecth()`函数中。

`fetch()`为thinkphp的解析模板函数，其返回模板文件渲染后的内容

`fetch()`函数的关键内容如下：

```
  public function fetch($template, $data = [], $config = [])
    {
        if ('' == pathinfo($template, PATHINFO_EXTENSION)) {
            // 获取模板文件名
            $template = $this->parseTemplate($template);
        }
        // 模板不存在 抛出异常
        if (!is_file($template)) {
            throw new TemplateNotFoundException('template not exists:' . $template, $template);
        }
        // 记录视图信息
        App::$debug && Log::record('[ VIEW ] ' . $template . ' [ ' . var_export(array_keys($data), true) . ' ]', 'info');
        $this->template->fetch($template, $data, $config);
    }
```

继续调用栈可以看下其实这个fetch()函数调用的是内置模板引擎的fetch方法， 这个方法实际上就是将要输出的页面内容赋值给一个变量，为了方便，thinkphp在对模板渲染的过程中，添加了php标签功能，使得其可以解析php代码。

总之一句话，这个漏洞其实就是由于对传入变量过滤不严导致的模板引擎注入漏洞，只要控制了传入模板的文件，就可以利用模板本身的渲染功能，实现包含漏洞getshell

另外需要注意的是，当验证传入的模板是否是文件时，使用的`is_file()`函数，这个函数在Linux下和windows下的判断会有所不同，具体如下：

1、在linux下利用`is_file()`来判断类似于`/****/../../../../etc/passwd`文件时，如果`****`是不存在的目录，则会返回false，在windows下 ，这个目录存在与否，均返回true，如下图所示：

![1.png](https://www.cnpanda.net/usr/uploads/2020/09/510981995.png "1.png")

![2.png](https://www.cnpanda.net/usr/uploads/2020/09/983017212.png "2.png")

2、在linux下，`is_file()`函数判可用于判断符号链接

3、在linux下，`is_file`函数会受到权限的影响，当前用户权限不足或父目录没有设置+x权限时，`is_file()`会返回false

4、windows系统里面`/`和`\` 都可以使用，但是在linux下只能使用`/` 来分隔路径，因此这会导致`is_file()`在不同系统下的返回结果不一致

![3.png](https://www.cnpanda.net/usr/uploads/2020/09/176838480.png "3.png")

![4.png](https://www.cnpanda.net/usr/uploads/2020/09/3439843598.png "4.png")

5、`is_file()`判断文件时，如果文件大小超过2^32时，会判断失败

## 漏洞验证

通过前文可知，这个漏洞的利用点在`_empty()`函数，需要注意的是，在官方文档中通常`_empty()`方法是用来判断一个方法是否存在，如果不存在，则进入该函数。而这里是开发者自定义的方法，因此直接传入`_empty`方法，调用name参数即可。

利用过程如下：

在前台的会员中心，个人资料处，上传修改头像：

![5.png](https://www.cnpanda.net/usr/uploads/2020/09/4037428201.png "5.png")

抓包后修改图片数据（满足图片头格式即可）：

![6.png](https://www.cnpanda.net/usr/uploads/2020/09/2527155175.png "6.png")

记录下路径后，成功getshell

![7.png](https://www.cnpanda.net/usr/uploads/2020/09/3363239619.png "7.png")

在Linux下，通过这种方法会失效，因为在`/public`路径下不存在`user`目录，由前文中的知识点可以知道，当不存在这个目录的时候，无论怎么跳转目录，`is_file()`函数返回的结果始终未false，因此无法利用该漏洞，如下图所示：

![8.png](https://www.cnpanda.net/usr/uploads/2020/09/1042205589.png "8.png")

当我们在`/public`目录下创建文件夹`/user`，在利用，即可成功：

![9.png](https://www.cnpanda.net/usr/uploads/2020/09/553855536.png "9.png")

最后感谢joseph师傅，又学习了一波

#####

「感谢老板送来的软糖/蛋糕/布丁/牛奶/冰阔乐！」

赞赏

×

![](https://www.cnpanda.net/tx.png)panda

 (๑＞ڡ＜)☆谢谢老板~

2元
5元
10元
50元
100元
任意金额

2元

使用微信扫描二维码打赏

![](https://www.cnpanda.net/usr/themes/7TEC/img/alipay-2.jpg)

![](https://www.cnpanda.net/usr/themes/7TEC/img/alipay-btn.png)

![](https://www.cnpanda.net/usr/themes/7TEC/img/wechat-btn.png)

版权属于：

Panda | 热爱安全的理想少年

本文链接：

https://www.cnpanda.net/codeaudit/777.html（转载时请注明本文出处及文章链接）

作品采用：

《[署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)](//creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)》许可协议授权

* [代码审计](https://www.cnpanda.net/category/codeaudit/)
* 2020-09-20
* [2 条评论](https://www.cnpanda.net/codeaudit/777.html#comments)
* 3097 字
* 34709 次浏览

 [【Java 代码审计入门-05】RCE 漏洞原理与实际案例介绍](https://www.cnpanda.net/codeaudit/759.html "【Java 代码审计入门-05】RCE 漏洞原理与实际案例介绍")
1/1
[fastadmin后台低权限拿 shell方法](https://www.cnpanda.net/codeaudit/825.html "fastadmin后台低权限拿 shell方法")

### 暂时无法评论哦~

###### 已有 2 条评论

1. ![](https://sdn.geekzu.org/avatar/e212d03f743f150d1343b5d80b262141?s=96&d=mp&r=g)

   F4NNIU
   访客

   感谢支持 FastAdmin，已经赞赏。

   2020-09-23 09:43:00 |

   1. ![](https://sdn.geekzu.org/avatar/6b2b7dc2b3d66232e462a1f3d374ffc8?s=96&d=mp&r=g)

      [panda](https://www.cnpanda.net)
      作者

      [@F4NNIU](#comment-112)

      啊 感谢支持

      2020-09-23 09:51:28 |

![](/tx.png)

**panda**

---

喜爱程序分析以及研究一些有趣的 Web 安全问题

#####

##### 文章分类[共 76 篇] [[归档](https://www.cnpanda.net/archives.html)]

* [安全研究 (24)](https://www.cnpanda.net/category/sec/)
* [代码审计 (17)](https://www.cnpanda.net/category/codeaudit/)
* [技术杂谈 (12)](https://www.cnpanda.net/category/talksafe/)
* [CTF (10)](https://www.cnpanda.net/category/ctf/)
* [编程算法 (1)](https://www.cnpanda.net/category/program/)
* [理论研究 (3)](https://www.cnpanda.net/category/sci/)
* [生活 (8)](https://www.cnpanda.net/category/life/)

##### 热门文章

* [个人经验泛谈之工控安全入门](https://www.cnpanda.net/sec/592.html "个人经验泛谈之工控安全入门") 106,528 人看过
* [第十届信息安全国赛 Web WriteUp（部分）](https://www.cnpanda.net/ctf/81.html "第十届信息安全国赛 Web WriteUp（部分）") 41,210 人看过
* [fastadmin最新版前台getshell漏洞分析](https://www.cnpanda.net/codeaudit/777.html "fastadmin最新版前台getshell漏洞分析") 34,710 人看过
* [【Java 代码审计入门-01】审计前的准备](https://www.cnpanda.net/codeaudit/588.html "【Java 代码审计入门-01】审计前的准备") 24,792 人看过
* [maccms v8 80w 字符的 RCE 分析](https://www.cnpanda.net/codeaudit/660.html " maccms v8 80w 字符的 RCE 分析") 22,659 人看过
* [【Java 代码审计入门-04】SSRF 漏洞原理与实际案例介绍](https://www.cnpanda.net/codeaudit/678.html "【Java 代码审计入门-04】SSRF 漏洞原理与实际案例介绍") 21,096 人看过
* [T-Star高校挑战赛WP](https://www.cnpanda.net/ctf/731.html "T-Star高校挑战赛WP") 20,778 人看过
* [带你走进 S7COMM 与 MODBUS 工控协议](https://www.cnpanda.net/sec/578.html "带你走进 S7COMM 与 MODBUS 工控协议") 20,410 人看过
* [挖洞神器之XRAY使用初体验](https://www.cnpanda.net/talksafe/657.html "挖洞神器之XRAY使用初体验 ")  19,757 人看过
* [【Java 代码审计入门-05】RCE 漏洞原理与实际案例介绍](https://www.cnpanda.net/codeaudit/759.html "【Java 代码审计入门-05】RCE 漏洞原理与实际案例介绍") 18,923 人看过

##### 标签

[ByteCTF](https://www.cnpanda.net/tag/ByteCTF/ "1 个话题")
[年度总结](https://www.cnpanda.net/tag/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/ "2 个话题")
[logback](https://www.cnpanda.net/tag/logback/ "2 个话题")
[log4j](https://www.cnpanda.net/tag/log4j/ "2 个话题")
[log4j2](https://www.cnpanda.net/tag/log4j2/ "3 个话题")
[jn'di](https://www.cnpanda.net/tag/jn-di/ "1 个话题")
[Thymeleaf Bypass](https://www.cnpanda.net/tag/Thymeleaf-Bypass/ "1 个话题")
[Thymeleaf](https://www.cnpanda.net/tag/Thymeleaf/ "1 个话题")
[SSTI](https://www.cnpanda.net/tag/SSTI/ "1 个话题")
[java 代码审计入门](https://www.cnpanda.net/tag/java-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/ "1 个话题")
[JDK8u20](https://www.cnpanda.net/tag/JDK8u20/ "1 个话题")
[JEP290](https://www.cnpanda.net/tag/JEP290/ "1 个话题")
[Java序列化](https://www.cnpanda.net/tag/Java%E5%BA%8F%E5%88%97%E5%8C%96/ "1 个话题")
[java 序列化](https://www.cnpanda.net/tag/java-%E5%BA%8F%E5%88%97%E5%8C%96/ "2 个话题")
[序列化](https://www.cnpanda.net/tag/%E5%BA%8F%E5%88%97%E5%8C%96/ "3 个话题")
[gadget](https://www.cnpanda.net/tag/gadget/ "1 个话题")
[JDK7U21](https://www.cnpanda.net/tag/JDK7U21/ "1 个话题")
[JDK](https://www.cnpanda.net/tag/JDK/ "2 个话题")
[反序列化](https://www.cnpanda.net/tag/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/ "2 个话题")
[java 反序列化](https://www.cnpanda.net/tag/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/ "4 个话题")
[微擎](https://www.cnpanda.net/tag/%E5%BE%AE%E6%93%8E/ "1 个话题")
[内卷](https://www.cnpanda.net/tag/%E5%86%85%E5%8D%B7/ "1 个话题")
[面试](https://www.cnpanda.net/tag/%E9%9D%A2%E8%AF%95/ "1 个话题")
[生活](https://www.cnpanda.net/tag/%E7%94%9F%E6%B4%BB/ "1 个话题")
[读研](https://www.cnpanda.net/tag/%E8%AF%BB%E7%A0%94/ "1 个话题")
[蚂蚁金服](https://www.cnpanda.net/tag/%E8%9A%82%E8%9A%81%E9%87%91%E6%9C%8D/ "1 个话题")
[非攻实验室](https://www.cnpanda.net/tag/%E9%9D%9E%E6%94%BB%E5%AE%9E%E9%AA%8C%E5%AE%A4/ "1 个话题")
[远程代码执行](https://www.cnpanda.net/tag/%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/ "1 个话题")
[骑士 CMS](https://www.cnpanda.net/tag/%E9%AA%91%E5%A3%AB-CMS/ "1 个话题")
[74cms](https://www.cnpanda.net/tag/74cms/ "1 个话题")

##### 订阅

* [RSS](https://www.cnpanda.net/feed/)

*[皖ICP备16023761号-1](https://beian.miit.gov.cn/)
© 2025 [Panda | 热爱安全的理想少年](https://www.cnpanda.net/).

站点已稳定运行：*


