=== Content from github.com_81feef1b_20250119_111545.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCWRUChielLab%2FCASAuth%2Fpull%2F11)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCWRUChielLab%2FCASAuth%2Fpull%2F11)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=CWRUChielLab%2FCASAuth)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[CWRUChielLab](/CWRUChielLab)
/
**[CASAuth](/CWRUChielLab/CASAuth)**
Public

forked from [arusso/CASAuth](/arusso/CASAuth)

* [Notifications](/login?return_to=%2FCWRUChielLab%2FCASAuth) You must be signed in to change notification settings
* [Fork
  5](/login?return_to=%2FCWRUChielLab%2FCASAuth)
* [Star
   11](/login?return_to=%2FCWRUChielLab%2FCASAuth)

* [Code](/CWRUChielLab/CASAuth)
* [Issues
  6](/CWRUChielLab/CASAuth/issues)
* [Pull requests
  3](/CWRUChielLab/CASAuth/pulls)
* [Actions](/CWRUChielLab/CASAuth/actions)
* [Projects
  0](/CWRUChielLab/CASAuth/projects)
* [Wiki](/CWRUChielLab/CASAuth/wiki)
* [Security](/CWRUChielLab/CASAuth/security)
* [Insights](/CWRUChielLab/CASAuth/pulse)

Additional navigation options

* [Code](/CWRUChielLab/CASAuth)
* [Issues](/CWRUChielLab/CASAuth/issues)
* [Pull requests](/CWRUChielLab/CASAuth/pulls)
* [Actions](/CWRUChielLab/CASAuth/actions)
* [Projects](/CWRUChielLab/CASAuth/projects)
* [Wiki](/CWRUChielLab/CASAuth/wiki)
* [Security](/CWRUChielLab/CASAuth/security)
* [Insights](/CWRUChielLab/CASAuth/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FCWRUChielLab%2FCASAuth%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FCWRUChielLab%2FCASAuth%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Security: more trimmed/mapped chars in user names #11

 Merged

[jpgill86](/jpgill86)
merged 3 commits into
[CWRUChielLab:master](/CWRUChielLab/CASAuth/tree/master "CWRUChielLab/CASAuth:master")
from
[leaf-node:master](/leaf-node/CASAuth/tree/master "leaf-node/CASAuth:master")

Dec 20, 2020

 Merged

# [Security: more trimmed/mapped chars in user names](#top) #11

[jpgill86](/jpgill86)
merged 3 commits into
[CWRUChielLab:master](/CWRUChielLab/CASAuth/tree/master "CWRUChielLab/CASAuth:master")
from
[leaf-node:master](/leaf-node/CASAuth/tree/master "leaf-node/CASAuth:master")

Dec 20, 2020

[Conversation
1](/CWRUChielLab/CASAuth/pull/11)
[Commits
3](/CWRUChielLab/CASAuth/pull/11/commits)
[Checks
0](/CWRUChielLab/CASAuth/pull/11/checks)
[Files changed](/CWRUChielLab/CASAuth/pull/11/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![leaf-node](https://avatars.githubusercontent.com/u/342930?s=60&v=4)](/leaf-node)

Copy link

### @leaf-node **[leaf-node](/leaf-node)** commented [Dec 20, 2020](#issue-771721131)

Hi [@jpgill86](https://github.com/jpgill86)

I have a tweak to the security patch that you merged last week. It blocks additional characters that I found are mapped or stripped from user names. The regexes are based on upstream MediaWiki code.

<https://github.com/wikimedia/mediawiki/blob/master/includes/title/MediaWikiTitleCodec.php#L314-L328>

I also wrote code to reject user names with invalid Unicode, and to not show a stack trace if MediaWiki itself rejects a user name.

I tested these changes on two wikis. Is this something that you are willing to review and merge?

Thanks, : )

Andrew

Sorry, something went wrong.

All reactions

 [leaf-node](/leaf-node)
added 3 commits
[December 20, 2020 15:31](#commits-pushed-b129ed0)

[![@leaf-node](https://avatars.githubusercontent.com/u/342930?s=40&v=4)](/leaf-node)

`[Security: more trimmed/mapped chars in user names](/CWRUChielLab/CASAuth/pull/11/commits/b129ed0e6ce1c66ce2deb1cf8f98d3ac5b0af963 "Security: more trimmed/mapped chars in user names

I found more characters in MediaWiki that are mapped to other chars, or
trimmed from user names. They mostly include bidirectional override
symbols and various forms of blank space.

Blocking these symbols in user names makes it harder to masquerade as a
bureaucrat user.")`
 …

`[b129ed0](/CWRUChielLab/CASAuth/pull/11/commits/b129ed0e6ce1c66ce2deb1cf8f98d3ac5b0af963)`

```
I found more characters in MediaWiki that are mapped to other chars, or
trimmed from user names. They mostly include bidirectional override
symbols and various forms of blank space.

Blocking these symbols in user names makes it harder to masquerade as a
bureaucrat user.
```

[![@leaf-node](https://avatars.githubusercontent.com/u/342930?s=40&v=4)](/leaf-node)

`[Extra precaution for invalid Unicode characters](/CWRUChielLab/CASAuth/pull/11/commits/1ea9db343e61dec38994d19b5a3bd404eedf2ff0 "Extra precaution for invalid Unicode characters

MediaWiki already seems to reject user names that contain invalid
Unicode characters when logging in. However, this code also rejects such
user names, mimicing the way that the `splitTitleString` method trims
invalid characters from user names.")`
 …

`[1ea9db3](/CWRUChielLab/CASAuth/pull/11/commits/1ea9db343e61dec38994d19b5a3bd404eedf2ff0)`

```
MediaWiki already seems to reject user names that contain invalid
Unicode characters when logging in. However, this code also rejects such
user names, mimicing the way that the `splitTitleString` method trims
invalid characters from user names.
```

[![@leaf-node](https://avatars.githubusercontent.com/u/342930?s=40&v=4)](/leaf-node)

`[Don't show error stack trace when MW rejects name](/CWRUChielLab/CASAuth/pull/11/commits/07e41ca9816d2a756a79a982651ff2fae587b5ef "Don't show error stack trace when MW rejects name

If MediaWiki rejects a user name, `User::newFromName` returns false.
Follow the normal procedure for rejecting a login.")`
 …

`[07e41ca](/CWRUChielLab/CASAuth/pull/11/commits/07e41ca9816d2a756a79a982651ff2fae587b5ef)`

```
If MediaWiki rejects a user name, `User::newFromName` returns false.
Follow the normal procedure for rejecting a login.
```

[![@jpgill86](https://avatars.githubusercontent.com/u/241234?s=80&u=10292064ad3e74907007d351ee5ef4c5507bb494&v=4)](/jpgill86)

Copy link

Member

### **[jpgill86](/jpgill86)** commented [Dec 20, 2020](#issuecomment-748678230)

| Same disclaimer as [last time](https://github.com/CWRUChielLab/CASAuth/pull/10#issuecomment-747606414), but it seems OK to me. I will merge. Thanks again! |
| --- |

All reactions

Sorry, something went wrong.

[![@jpgill86](https://avatars.githubusercontent.com/u/241234?s=40&u=10292064ad3e74907007d351ee5ef4c5507bb494&v=4)](/jpgill86)
[jpgill86](/jpgill86)
merged commit [`9db3ebb`](/CWRUChielLab/CASAuth/commit/9db3ebb158358f7d8615b07819169353d658fa91)
into
CWRUChielLab:master

[Dec 20, 2020](https://github.com/CWRUChielLab/CASAuth/pull/11#event-4133735142)

[![@leaf-node](https://avatars.githubusercontent.com/u/342930?s=40&u=5b4333a404702b628e7ab67637a190e420a99b22&v=4)](/leaf-node)
[leaf-node](/leaf-node)
mentioned this pull request
[Dec 22, 2020](#ref-pullrequest-767059324)

[Security patch for the MW CASAuth plugin
#10](/CWRUChielLab/CASAuth/pull/10)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FCWRUChielLab%2FCASAuth%2Fpull%2F11)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@leaf-node](https://avatars.githubusercontent.com/u/342930?s=52&v=4)](/leaf-node) [![@jpgill86](https://avatars.githubusercontent.com/u/241234?s=52&v=4)](/jpgill86)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from phabricator.wikimedia.org_be57f307_20250119_111546.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT263498)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T263498
# Logins to MW with at least one SSO client extension allows masquerading as another user (CVE-2020-35623)Closed, Resolved[Public](/policy/explain/PHID-TASK-svz3kejlxmojcozulwca/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/263498/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/263498/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-svz3kejlxmojcozulwca/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-svz3kejlxmojcozulwca/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-svz3kejlxmojcozulwca/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-svz3kejlxmojcozulwca/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-svz3kejlxmojcozulwca/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-svz3kejlxmojcozulwca/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-svz3kejlxmojcozulwca/)
* [Protect as security issue](/wmf/escalate-task/263498/)
* [Award Token](/token/give/PHID-TASK-svz3kejlxmojcozulwca/)
* [Flag For Later](/flag/edit/PHID-TASK-svz3kejlxmojcozulwca/)

Assigned To

|  | [Sudozero](/p/Sudozero/) |
| --- | --- |

Authored By

|  | [Sudozero](/p/Sudozero/) |
| --- | --- |
| Sep 21 2020, 8:57 PM2020-09-21 20:57:56 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [MediaWiki-Core-AuthManager](/tag/mediawiki-core-authmanager/) [(Backlog)](/project/board/1037/)
* [Vuln-Authn/Session](/tag/vuln-authn_session/) [(Tracked)](/project/board/1345/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Reedy](/p/Reedy/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

|  | [Sudozero](/p/Sudozero/) |
| --- | --- |

Tokens"Like" token, awarded by sbassett.
# Description

I was able to successfully masquerade with another one of my user accounts using the [CASAuth](https://github.com/CWRUChielLab/CASAuth) extension. While that extension has been abandoned, other SSO client extensions may be at risk.

To log in as "foobar", one only need to create an account like: "\_foobar" or "foobar\_" with the SSO provider, and log in with that user name. As a result, one gains access to the "foobar" account. If one's acount is "foo\_bar", then "foo\_\_bar" and "foo bar" also work.

By gaining access to an admin account, one could delete arbitrary pages or otherwise vandalize the site.

This appears to be due to the automatic normalization performed by MW code when creating user names (User:newFromName). The workaround I'm using for now is:

```
--- CASAuth.php.orig    2020-09-21 16:50:52.757932797 -0400
+++ CASAuth.php 2020-09-21 16:29:07.448092263 -0400
@@ -117,6 +117,17 @@
                             return true;
                           }

+                        $collision_0 = "/^_/";
+                        $collision_1 = "/_$/";
+                        $collision_2 = "/__/";
+                        $collision_3 = "/ /";
+                        if(preg_match($collision_0, "$username") || preg_match($collision_1, "$username") || preg_match($collision_2, "$username") || preg_match($collision_3, "$username"))
+                          {
+                            // redirect user to the RestrictRedirect page
+                            $wgOut->redirect($CASAuth["RestrictRedirect"]);
+                            return true;
+                          }
+
                         // Get MediaWiki user
                         $u = User::newFromName($username);

`
```

While I have only tested the CASAuth extension, I fear that this security bug may be more widespread, so I've only reported this issue to other members of the technical team I am a part of at work, and to you.

Does your team generally assist in coordination with multiple extension maintainers, or should I try to contact every maintainer of MW SSO login extensions? I figure that if that there isn't any coordination, that some maintainers may release before others, leading to insight by malicious users.

Thanks for your help. : ) Andrew

# Related Objects

* Mentions

Mentioned In [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810)
[T256341: Obtain CVEs for 1.31.9/1.34.3/1.35.0 security releases](/T256341)
[T256342: Write and send supplementary release announcement for extensions and skins with security patches (1.31.9/1.34.3/1.35.0)](/T256342) Mentioned Here [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810)
[T263802: Release MediaWiki 1.31.11/1.35.1](/T263802)
[T256342: Write and send supplementary release announcement for extensions and skins with security patches (1.31.9/1.34.3/1.35.0)](/T256342)
### Event Timeline

[Sudozero](/p/Sudozero/) created this task.[Sep 21 2020, 8:57 PM2020-09-21 20:57:56 (UTC+0)](#6481599)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/3897342/)[Sep 21 2020, 8:57 PM2020-09-21 20:57:58 (UTC+0)](#6481609)[Reedy](/p/Reedy/) added a project: [MediaWiki-Core-AuthManager](/tag/mediawiki-core-authmanager/).[Sep 22 2020, 1:42 AM2020-09-22 01:42:20 (UTC+0)](#6482315)

[Reedy](/p/Reedy/) subscribed.[Sep 22 2020, 1:45 AM2020-09-22 01:45:26 (UTC+0)](#6482318)Comment Actions

FWIW, any amounts of underscores/spaces get replaced with one. So your mitigation isn't sufficient ;)

```
> echo ( User::getCanonicalName( "Foo______bar" ) );
Foo bar
> echo ( User::getCanonicalName( "Foo      bar" ) );
Foo bar
```
[Reedy](/p/Reedy/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-ap6iwy2xcm7h3oy/)[Sep 22 2020, 2:25 AM2020-09-22 02:25:31 (UTC+0)](#6482402)[Sudozero](/p/Sudozero/) added a comment.[Sep 22 2020, 5:46 PM2020-09-22 17:46:22 (UTC+0)](#6484627)Comment Actions

Thanks for the tip. : ) I think that the regex for /\_\_/ covers it, since three or more underscores in a row should still be matched by two of them. The same goes for the spaces. I don't know if this is the best way to handle this, but it seems like an okay stop-gap measure.

FWIW, we seem to have far more users with one or more spaces in their names (~1K) than we do people who have underscores (~100).

Of course if people are blocked from logging in with their account, they will need to contact me or another admin at my org so we can change their user name, which would allow them to log into our wiki again. Most of those people are unlikely to be actually using their account or visiting our wiki, so there won't be all that many blocks in effect. The main concern is to stop someone from maliciously logging in as admin, or other wiki users.

Thanks! : )

[sbassett](/p/sbassett/) subscribed.[Sep 22 2020, 8:14 PM2020-09-22 20:14:41 (UTC+0)](#6485220)Comment Actions

[@Sudozero](/p/Sudozero/) -

> Thanks for the tip. : ) I think that the regex for /\_\_/ covers it, since three or more underscores in a row should still be matched by two of them. The same goes for the spaces. I don't know if this is the best way to handle this, but it seems like an okay stop-gap measure.

As [@Reedy](/p/Reedy/) implied above, I'd be cautious when using regular expressions to sanitize any data as they can become complicated and unwieldy very quickly. I'd also recommend writing some unit tests for CASAuth ([mediawiki primarily uses phpunit for php code](https://www.mediawiki.org/wiki/Manual%3APHP_unit_testing/Writing_unit_tests_for_extensions)) to ensure you have all of your expected edge cases covered.

> Does your team generally assist in coordination with multiple extension maintainers, or should I try to contact every maintainer of MW SSO login extensions? I figure that if that there isn't any coordination, that some maintainers may release before others, leading to insight by malicious users.

We can help out a bit, but we mainly focus on [Wikimedia-deployed](https://noc.wikimedia.org/conf/extension-list) and [bundled](https://www.mediawiki.org/wiki/Bundled_extensions_and_skins) extensions and skins. For any announcement to potential users of CASAuth, I would probably start with [the wikiapiary list of wikis using the extension](https://wikiapiary.com/w/index.php?title=Special:Ask&offset=0&limit=500&q=%5B%5BHas+extension%3A%3AExtension%3ACASAuth%5D%5D&p=mainlabel%3D-2D%2Fformat%3Dtable%2Flink%3Dall%2Fheaders%3Dshow%2Fintro%3D-3Cb-3EThis-20extension-20is-20in-20use-20on-20the-20following-20websites%3A-3C-2Fb-3E-3Cbr-20-2F-3E%2Fsearchlabel%3D%E2%80%A6-20further-20results%2Fdefault%3DThis-20extension-20is-20no-20longer-20in-20use-20on-20any-20website.%2Fclass%3Dsortable-20wikitable-20smwtable&po=%3FHas+website%3DWiki+name%0A%3FHas+MediaWiki+version%3DMediaWiki+version%0A%3FHas+extension+version%3DExtension+version%0A&sort=Has+website&order=rand) and try to find contacts for those projects to supplement any personal knowledge of users you may have. Once a patch is written and backported to any relevant branches, we can include this task within our tracking task for quarterly security announcements ([T256342](/T256342)) which are sent out to various mediawiki-related mailing lists ([here's a recent example](https://lists.wikimedia.org/pipermail/wikitech-l/2020-June/093541.html)). For code with a canonical repo at github, we can reference any relevant pull requests.

[sbassett](/p/sbassett/) mentioned this in [T256342: Write and send supplementary release announcement for extensions and skins with security patches (1.31.9/1.34.3/1.35.0)](/T256342).[Sep 22 2020, 9:44 PM2020-09-22 21:44:26 (UTC+0)](#6485638)[sbassett](/p/sbassett/) mentioned this in [T256341: Obtain CVEs for 1.31.9/1.34.3/1.35.0 security releases](/T256341).[Sep 23 2020, 9:19 PM2020-09-23 21:19:30 (UTC+0)](#6489540)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Sep 28 2020, 3:21 PM2020-09-28 15:21:53 (UTC+0)](#6498942)[sbassett](/p/sbassett/) mentioned this in [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810).[Nov 17 2020, 10:35 PM2020-11-17 22:35:13 (UTC+0)](#6629042)[sbassett](/p/sbassett/) added a comment.[Dec 1 2020, 9:49 PM2020-12-01 21:49:21 (UTC+0)](#6661254)Comment Actions

[@Sudozero](/p/Sudozero/) - just wanted to check in and see if there was any additional progress made on this effort. Thanks.

[Sudozero](/p/Sudozero/) added a comment.[Dec 2 2020, 12:51 AM2020-12-02 00:51:04 (UTC+0)](#6661625)Comment Actions

Hi [@sbassett](/p/sbassett/)

I emailed site owners about the issue on 2020-11-23, by using mostly technical support contact addresses on their parent sites, but haven't heard back from any of them so far.

I have the patch I quoted earlier working on the wikis that I manage, aside from additional symbols that I need to investigate. However I suspect that not all CAS servers will allow the same set of characters in their user names. I haven't written any tests for the changes. Because I haven't heard back from any admins, I haven't gotten any help for coding a patch.

I am up for at least making an issue with a sample patch on the GitHub project page, but I'm not sure about an official pull request, since that would likely need more work. In my email to site admins, I mentioned that I wanted to give them a head start on patching their systems before I create a GitHub issue upstream, so depending on the timing of your security newsletter, I could create an issue before then, if that sufficient for your announcement.

I know that I have not gone above and beyond regarding this report and patch, but if you have any suggestions, I'm open to hear them.

I know that I mentioned this to an extent earlier, but I'm concerned that others who don't use CASAuth may also be impacted, because this type of vulnerability seems to be based on a trivial assumption about how user names are processed by MW. I don't want malicious actors to attack sites using popular SSO extensions too.

Thanks for checking in. : )

Andrew

[sbassett](/p/sbassett/) added a comment.[Dec 2 2020, 10:27 PM2020-12-02 22:27:04 (UTC+0)](#6665131)Comment Actions
> In [T263498#6661625](/T263498#6661625), [@Sudozero](/p/Sudozero/) wrote:
>
> I emailed site owners about the issue on 2020-11-23, by using mostly technical support contact addresses on their parent sites, but haven't heard back from any of them so far.

Great, that's really all that can be done in most cases. Extreme hand-holding only leads to frustration :)

> I am up for at least making an issue with a sample patch on the GitHub project page, but I'm not sure about an official pull request, since that would likely need more work. In my email to site admins, I mentioned that I wanted to give them a head start on patching their systems before I create a GitHub issue upstream, so depending on the timing of your security newsletter, I could create an issue before then, if that sufficient for your announcement.

Ok, you could likely guard this new functionality with a config variable. Then other users could enable/disable the functionality based upon their needs.

> I know that I have not gone above and beyond regarding this report and patch, but if you have any suggestions, I'm open to hear them.

Oh, I think you've done fine. For any security issue like this, we typically want to make best efforts around addressing the issue, writing a correct patch, informing relevant users/operators and then disclosing the issue and backporting as necessary.

> I know that I mentioned this to an extent earlier, but I'm concerned that others who don't use CASAuth may also be impacted, because this type of vulnerability seems to be based on a trivial assumption about how user names are processed by MW. I don't want malicious actors to attack sites using popular SSO extensions too.

Yes, that's likely something for the maintainers of other SSO extensions to test and confirm. Hopefully addressing and eventually disclosing an issue like this will result in further action on that front.

[Sudozero](/p/Sudozero/) added a comment.[Dec 6 2020, 9:10 PM2020-12-06 21:10:39 (UTC+0)](#6672151)Comment Actions

Is there a rough timeline of when the security announcement will go out? I'd like to get the patch ready before then. Thanks : )

[sbassett](/p/sbassett/) added a comment.Edited · [Dec 8 2020, 9:50 PM2020-12-08 21:50:26 (UTC+0)](#6677701)Comment Actions

[@Sudozero](/p/Sudozero/) - I would guess the current security release ([T263802](/T263802)) will happen sometime over the next two or so weeks? [@Reedy](/p/Reedy/) might have a more specific date in mind. Though if you need more time with any of this, we can always include this within the next supplemental announcement.

[Reedy](/p/Reedy/) added a comment.[Dec 8 2020, 10:47 PM2020-12-08 22:47:30 (UTC+0)](#6677940)Comment Actions
> In [T263498#6677701](/T263498#6677701), [@sbassett](/p/sbassett/) wrote:
>
> [@Sudozero](/p/Sudozero/) - I would guess the current security release ([T263802](/T263802)) will happen sometime over the next two or so weeks? [@Reedy](/p/Reedy/) might have a more specific date in mind. Though if you need more time with any of this, we can always include this within the next supplemental announcement.

Planning for 2020-12-16 or 2020-12-17 so they're out comfortably before Christmas

[Sudozero](/p/Sudozero/) added a comment.[Dec 13 2020, 8:45 PM2020-12-13 20:45:28 (UTC+0)](#6687677)Comment Actions

Okay, I worked on improving my patch, and so I'll put it here for now.

```
--- CASAuth.php.orig    2019-10-10 16:56:19.679560769 -0400
+++ CASAuth.php 2020-12-13 15:35:33.398765653 -0500
@@ -113,6 +113,13 @@
                         // Get username
                         $username = casNameLookup(phpCAS::getUser());

+                        // casNameLookup() says name is invalid
+                        if (is_null($username)) {
+                          // redirect user to the RestrictRedirect page
+                          $wgOut->redirect($CASAuth["RestrictRedirect"]);
+                          return true;
+                        }
+
                         // If we are restricting users AND the user is not in
                         // the allowed users list, lets block the login
                         if($CASAuth["RestrictUsers"]==true
```

And in CASAuthSettings.php, replace the default hook with:

```
function casNameLookup($username) {

  // Some special characters are automatically trimmed from user names when
  // logging in. For instance if a user logs in with the CAS account name
  // "__admin_ user ", they would normally be logged into MediaWiki as
  // "Admin user". This code blocks certain combinations of underscores and
  // spaces in user names. A patch to CASAuth.php is also required.

  // Normally, both "admin_user" and "admin user" both log in as "Admin user".
  // Allow isolated underscores rather than spaces (true or false):
  $preferUnderscore = true;

  $collisions = [ "/^_/", "/_$/", "/^ /", "/ $/", "/  /", "/__/", "/_ /", "/ _/" ];
  $collisions[] = $preferUnderscore ? "/ /" : "/_/";

  foreach ($collisions as $collision) {
    if(preg_match($collision, $username)) {
      unset($collision);
      // reject user name
      return null;
    }
  }
  unset($collision);

  // user name checks out
  return $username;
}
```
[Sudozero](/p/Sudozero/) added a comment.[Dec 14 2020, 7:42 PM2020-12-14 19:42:54 (UTC+0)](#6689905)Comment Actions

[@sbassett](/p/sbassett/) Is it okay for me to post the issue or merge request on GitHub a few days before the planned security announcement email goes out? I can shrink that gap if needed. Thanks.

[sbassett](/p/sbassett/) added a comment.[Dec 14 2020, 7:48 PM2020-12-14 19:48:32 (UTC+0)](#6689929)Comment Actions
> In [T263498#6689905](/T263498#6689905), [@Sudozero](/p/Sudozero/) wrote:
>
> [@sbassett](/p/sbassett/) Is it okay for me to post the issue or merge request on GitHub a few days before the planned security announcement email goes out? I can shrink that gap if needed. Thanks.

If you're happy with the patch and any recent disclosure/communication efforts to relevant users, I'd recommend merging the patch as soon as possible. For extensions like this, which aren't bundled for MediaWiki security releases, the sooner a fix and disclosure can occur, the better. The supplemental announcement can be viewed as something to help increase visibility even further, but does not need to serve as the primary means of disclosure/communication for any security issue.

[Sudozero](/p/Sudozero/) added a comment.[Dec 15 2020, 1:07 AM2020-12-15 01:07:33 (UTC+0)](#6690696)Comment Actions

I created a pull request here: <https://github.com/CWRUChielLab/CASAuth/pull/10>

I also emailed others who have made commits to forks of that repo according to GitHub's network feature.

[sbassett](/p/sbassett/) added a comment.[Dec 15 2020, 4:53 PM2020-12-15 16:53:16 (UTC+0)](#6692660)Comment Actions
> In [T263498#6690696](/T263498#6690696), [@Sudozero](/p/Sudozero/) wrote:
>
> I created a pull request here: <https://github.com/CWRUChielLab/CASAuth/pull/10>
>
> I also emailed others who have made commits to forks of that repo according to GitHub's network feature.

Sounds good. Once you merge that request, I'll include this issue within the next supplemental announcement ([T263810](/T263810)), likely due out next week.

[Sudozero](/p/Sudozero/) added a comment.[Dec 17 2020, 6:12 PM2020-12-17 18:12:42 (UTC+0)](#6699152)Comment Actions

[@sbassett](/p/sbassett/) The patch was merged!

<https://github.com/CWRUChielLab/CASAuth/pull/10>

<https://github.com/CWRUChielLab/CASAuth>

[sbassett](/p/sbassett/) awarded a token.[Dec 17 2020, 9:16 PM2020-12-17 21:16:36 (UTC+0)](#6699821)[Sudozero](/p/Sudozero/) added a comment.[Dec 19 2020, 3:29 PM2020-12-19 15:29:36 (UTC+0)](#6703973)Comment Actions

Should I make a CVE for this security issue?

[sbassett](/p/sbassett/) added a comment.[Dec 20 2020, 7:28 PM2020-12-20 19:28:50 (UTC+0)](#6705053)Comment Actions
> In [T263498#6703973](/T263498#6703973), [@Sudozero](/p/Sudozero/) wrote:
>
> Should I make a CVE for this security issue?

Feel free, otherwise I can tomorrow. [This is the form](https://cveform.mitre.org/) I typically use.

[sbassett](/p/sbassett/) triaged this task as Low priority.[Dec 20 2020, 7:29 PM2020-12-20 19:29:05 (UTC+0)](#6705054)[Sudozero](/p/Sudozero/) added a comment.[Dec 20 2020, 7:29 PM2020-12-20 19:29:14 (UTC+0)](#6705055)Comment Actions

For the sake of reference, the user name normalization appears to occur in the splitTitleString method, in includes/title/MediaWikiTitleCodec.php. There are additional special Unicode characters that are stripped out there.

The characters that get stripped there include bidirectional override characters: /\xE2\x80[\x8E\x8F\xAA-\xAE]/. The following pattern is replaced with '\_': /[ \_\xA0\x{1680}\x{180E}\x{2000}-\x{200A}\x{2028}\x{2029}\x{202F}\x{205F}\x{3000}]+/u.

[Sudozero](/p/Sudozero/) added a comment.[Dec 20 2020, 10:10 PM2020-12-20 22:10:23 (UTC+0)](#6705146)Comment Actions

[@sbassett](/p/sbassett/)

I added another pull request to cover more edge cases: <https://github.com/CWRUChielLab/CASAuth/pull/11>

As for creating the CVE, it might best if you create it.

Thanks : )

[Sudozero](/p/Sudozero/) added a comment.[Dec 20 2020, 10:18 PM2020-12-20 22:18:04 (UTC+0)](#6705159)Comment Actions

That commit was merged upstream.

[sbassett](/p/sbassett/) added a comment.[Dec 21 2020, 8:55 PM2020-12-21 20:55:16 (UTC+0)](#6706720)Comment Actions
> In [T263498#6705146](/T263498#6705146), [@Sudozero](/p/Sudozero/) wrote:
>
> As for creating the CVE, it might best if you create it.

I've now requested a CVE for this issue. The supplemental release should go out tomorrow or Wednesday. Thanks for working on this!

[Sudozero](/p/Sudozero/) added a comment.[Dec 22 2020, 2:10 AM2020-12-22 02:10:11 (UTC+0)](#6707399)Comment Actions

@sbasset Thank you for your guidance and for your help! : )

[sbassett](/p/sbassett/) renamed this task from Logins to MW with at least one SSO client extension allows masquerading as another user to Logins to MW with at least one SSO client extension allows masquerading as another user (CVE-2020-35623).[Dec 22 2020, 8:51 PM2020-12-22 20:51:51 (UTC+0)](#6709088)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-wwbn7fbjz6syls4/)" to "Public (No Login Required)".[sbassett](/p/sbassett/) closed this task as Resolved.[Dec 22 2020, 8:53 PM2020-12-22 20:53:55 (UTC+0)](#6709095)[sbassett](/p/sbassett/) assigned this task to [Sudozero](/p/Sudozero/).[sbassett](/p/sbassett/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[sbassett](/p/sbassett/) added a project: [Vuln-Authn/Session](/tag/vuln-authn_session/).[Mar 16 2021, 9:39 PM2021-03-16 21:39:27 (UTC+0)](#6919551)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
