=== Content from phabricator.wikimedia.org_9316047f_20250119_134200.html ===
[HomePhabricator](/)

* SearchConfigure Global Search
 [Auth](/auth/)  Login

Click the *MediaWiki* button below to connect your [Wikimedia unified account](https://meta.wikimedia.org/wiki/Help%3AUnified_login). Alternatively, click the *Wikitech Account (LDAP)* button to connect your [Developer account](https://www.mediawiki.org/wiki/Developer_account) credentials.

In case of doubt, [check the Phabricator Help](https://www.mediawiki.org/wiki/Phabricator/Help#Creating_your_account).

Log In or RegisterMediaWikiDeveloper Account Log InLDAP Account (IDP)
# Log In or Register with LDAP

LDAP UsernameLDAP PasswordLog In or RegisterTrouble logging in? [Send a login link to your email address.](/login/email/)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from gerrit.wikimedia.org_ab313d54_20250119_115646.html ===




=== Content from phabricator.wikimedia.org_8bfafacb_20250119_115648.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT268341)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T268341
# Possible XSS in SpecialGlobalUsage (CVE-2020-35622)Closed, Resolved[Public](/policy/explain/PHID-TASK-p2shfhzmvnsfjivfb64y/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/268341/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/268341/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* [Protect as security issue](/wmf/escalate-task/268341/)
* [Award Token](/token/give/PHID-TASK-p2shfhzmvnsfjivfb64y/)
* [Flag For Later](/flag/edit/PHID-TASK-p2shfhzmvnsfjivfb64y/)

Assigned To

|  | [Umherirrender](/p/Umherirrender/) |
| --- | --- |

Authored By

|  | [Daimona](/p/Daimona/) |
| --- | --- |
| Nov 20 2020, 2:51 PM2020-11-20 14:51:34 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [GlobalUsage](/tag/globalusage/) [(Backlog)](/project/board/394/)
* [Vuln-XSS](/tag/vuln-xss/)
* [MW-1.36-notes (1.36.0-wmf.21; 2020-12-08)](/project/view/5032/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Ammarpad](/p/Ammarpad/) |
| --- | --- |

|  | [Daimona](/p/Daimona/) |
| --- | --- |

|  | [DannyS712](/p/DannyS712/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

|  | [Umherirrender](/p/Umherirrender/) |
| --- | --- |

|  | [Zabe](/p/Zabe/) |
| --- | --- |

# Description

Seen while upgrading taint-check in [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/GlobalUsage/+/642262](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/GlobalUsage/%2B/642262):

SpecialGlobalUsage.php line 178
```
// @var GlobalUsageQuery $query
foreach ( $query->getSingleImageResult() as $wiki => $result ) {
	// ...
	foreach ( $result as $item ) {
		$out->addHtml( "\t<li>" . self::formatItem( $item ) . "</li>\n" );
	}
```

$query->getSingleImageResult() returns an array of database fields, including page titles. Then we have

```
public static function formatItem( $item ) {
	if ( !$item['namespace'] ) {
		$page = $item['title'];
	} else {
		$page = "{$item['namespace']}:{$item['title']}";
	}

	$link = WikiMap::makeForeignLink( $item['wiki'], $page,
		str_replace( '_', ' ', $page ) );
	// Return only the title if no link can be constructed
	return $link === false ? $page : $link;
}
```

So if the page cannot be found (which I guess is a possibility?), it will echo the DB fields verbatim. In theory, this should be safe thanks to $wgLegalTitleChars, but it's still outputting user-controlled data.

The fix is as simple as escaping $page, so formatItem() will always return an escaped value. I'm creating this task as security-protected just in case, but I guess it can also be made public; leaving this up to the Security Team.

# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Pass escaped html to WikiMap::makeForeignLink for sanity](https://gerrit.wikimedia.org/r/c/651590) | [mediawiki/extensions/GlobalUsage](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalUsage) | [REL1\_31](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalUsage/%2B/REL1_31) | +2 -2 |
|  | [Pass escaped html to WikiMap::makeForeignLink for sanity](https://gerrit.wikimedia.org/r/c/651589) | [mediawiki/extensions/GlobalUsage](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalUsage) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalUsage/%2B/REL1_35) | +2 -2 |
|  | [Pass escaped html to WikiMap::makeForeignLink for sanity](https://gerrit.wikimedia.org/r/c/646744) | [mediawiki/extensions/GlobalUsage](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalUsage) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/GlobalUsage/%2B/master) | +2 -2 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T268341)
# Related Objects

* Mentions

Mentioned In [T274063: "&" in page names displayed as "&amp;" by GlobalUsage](/T274063)
[T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810) Mentioned Here [T274063: "&" in page names displayed as "&amp;" by GlobalUsage](/T274063)
[T268917: Messages userrights-expiry-current and userrights-expiry-none can contain raw html (CVE-2020-35475)](/T268917)
### Event Timeline

[Daimona](/p/Daimona/) created this task.[Nov 20 2020, 2:51 PM2020-11-20 14:51:34 (UTC+0)](#6636819)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/3992936/)[Nov 20 2020, 2:51 PM2020-11-20 14:51:35 (UTC+0)](#6636829)[Daimona](/p/Daimona/) added a project: [GlobalUsage](/tag/globalusage/).[Nov 20 2020, 2:51 PM2020-11-20 14:51:44 (UTC+0)](#6636830)[Daimona](/p/Daimona/) added a subscriber: [Umherirrender](/p/Umherirrender/).[Nov 20 2020, 4:30 PM2020-11-20 16:30:32 (UTC+0)](#6637121)[Reedy](/p/Reedy/) added a project: [Vuln-XSS](/tag/vuln-xss/).[Nov 20 2020, 5:39 PM2020-11-20 17:39:36 (UTC+0)](#6637324)[sbassett](/p/sbassett/) triaged this task as Medium priority.[Nov 23 2020, 4:09 PM2020-11-23 16:09:23 (UTC+0)](#6641312)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[sbassett](/p/sbassett/) subscribed.[DannyS712](/p/DannyS712/) subscribed.[Nov 23 2020, 5:14 PM2020-11-23 17:14:25 (UTC+0)](#6641585)

[Umherirrender](/p/Umherirrender/) claimed this task.Edited · [Dec 7 2020, 4:23 PM2020-12-07 16:23:23 (UTC+0)](#6673600)Comment Actions

Fixed with [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/GlobalUsage/+/646744](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/GlobalUsage/%2B/646744)

Could be public from my point of view

[sbassett](/p/sbassett/) added a comment.[Dec 7 2020, 5:04 PM2020-12-07 17:04:45 (UTC+0)](#6673815)Comment Actions
> In [T268341#6673600](/T268341#6673600), [@Umherirrender](/p/Umherirrender/) wrote:
>
> Could be public from my point of view

Similar to [T268917](/T268917), let's wait for the train deployments this week and then make this task public.

[Jdforrester-WMF](/p/Jdforrester-WMF/) added a project: [MW-1.36-notes (1.36.0-wmf.21; 2020-12-08)](/project/view/5032/).[Dec 7 2020, 5:21 PM2020-12-07 17:21:25 (UTC+0)](#6673901)[sbassett](/p/sbassett/) mentioned this in [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810).[Dec 7 2020, 10:01 PM2020-12-07 22:01:35 (UTC+0)](#6674799)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-yhufuqodhnwakdj/)" to "Public (No Login Required)".[Dec 21 2020, 8:39 PM2020-12-21 20:39:53 (UTC+0)](#6706711)[sbassett](/p/sbassett/) renamed this task from Possible XSS in SpecialGlobalUsage to Possible XSS in SpecialGlobalUsage (CVE-2020-35622).[Dec 22 2020, 8:50 PM2020-12-22 20:50:20 (UTC+0)](#6709086)[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2020, 9:23 PM2020-12-22 21:23:06 (UTC+0)](#6709177)Comment Actions

Change 651589 had a related patch set uploaded (by SBassett; owner: Umherirrender):

[mediawiki/extensions/GlobalUsage@REL1\_35] Pass escaped html to WikiMap::makeForeignLink for sanity

<https://gerrit.wikimedia.org/r/651589>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2020, 9:23 PM2020-12-22 21:23:19 (UTC+0)](#6709178)Comment Actions

Change 651590 had a related patch set uploaded (by SBassett; owner: Umherirrender):

[mediawiki/extensions/GlobalUsage@REL1\_31] Pass escaped html to WikiMap::makeForeignLink for sanity

<https://gerrit.wikimedia.org/r/651590>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2020, 9:39 PM2020-12-22 21:39:48 (UTC+0)](#6709207)Comment Actions

Change 651589 **merged** by jenkins-bot:

[mediawiki/extensions/GlobalUsage@REL1\_35] Pass escaped html to WikiMap::makeForeignLink for sanity

<https://gerrit.wikimedia.org/r/651589>

[gerritbot](/p/gerritbot/) added a comment.[Dec 22 2020, 10:50 PM2020-12-22 22:50:42 (UTC+0)](#6709361)Comment Actions

Change 651590 **merged** by jenkins-bot:

[mediawiki/extensions/GlobalUsage@REL1\_31] Pass escaped html to WikiMap::makeForeignLink for sanity

<https://gerrit.wikimedia.org/r/651590>

[DannyS712](/p/DannyS712/) added a comment.[Dec 22 2020, 11:51 PM2020-12-22 23:51:47 (UTC+0)](#6709428)Comment Actions

Can this be resolved?

[Reedy](/p/Reedy/) closed this task as Resolved.[Dec 22 2020, 11:54 PM2020-12-22 23:54:28 (UTC+0)](#6709439)[sbassett](/p/sbassett/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Dec 23 2020, 3:59 PM2020-12-23 15:59:13 (UTC+0)](#6710379)[Ammarpad](/p/Ammarpad/) mentioned this in [T274063: "&" in page names displayed as "&amp;" by GlobalUsage](/T274063).[May 18 2021, 11:18 AM2021-05-18 11:18:47 (UTC+0)](#7095343)

[Ammarpad](/p/Ammarpad/) subscribed.[May 18 2021, 11:25 AM2021-05-18 11:25:15 (UTC+0)](#7095347)Comment Actions

Caused [T274063](/T274063).

> So if the page cannot be found

While it's good to be preemptive, there are already checks to ensure the file exists before constructing the links (this includes querying the database).

[Daimona](/p/Daimona/) added a comment.[May 18 2021, 12:00 PM2021-05-18 12:00:25 (UTC+0)](#7095440)Comment Actions

Checking this again, I'm not sure that the fix is correct. If WikiMap::makeForeignLink returns false, then we should indeed escape $page before returning it. However, it should not be escaped when passed to makeForeignLink, since then it ends up being passed to Linker::makeExternalLink which escapes $text, which explains the double escape.

[Zabe](/p/Zabe/) subscribed.[May 18 2021, 12:00 PM2021-05-18 12:00:55 (UTC+0)](#7095441)[sbassett](/p/sbassett/) added a comment.Edited · [May 18 2021, 2:57 PM2021-05-18 14:57:41 (UTC+0)](#7095816)Comment Actions

[@Daimona](/p/Daimona/) - so looking at the gerrit change set, we'd just need to remove that first htmlspecialchars in your opinion? Basically change this:

```
$link = WikiMap::makeForeignLink( $item['wiki'], $page,
str_replace( '_', ' ', htmlspecialchars( $page ) ) );
// Return only the title if no link can be constructed
return $link === false ? htmlspecialchars( $page ) : $link;
```

to:

```
$link = WikiMap::makeForeignLink( $item['wiki'], $page,
str_replace( '_', ' ', $page ) );
// Return only the title if no link can be constructed
return $link === false ? htmlspecialchars( $page ) : $link;
```

Also - if we don't really need that underscore faux-normalization, then we shouldn't need the third arg at all, [per the docblock](https://gerrit.wikimedia.org/g/mediawiki/core/%2B/b3a9ef79c50b327c02f9e75ed5780dcb2c1f0dcf/includes/WikiMap.php#146):

@param string|null $text Link's text; optional, default to $page

~~I'll try to get a patch up soon for review.~~ Never mind, I see there's already a patch up on the other bug: <https://gerrit.wikimedia.org/r/692590>

Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
