=== Content from phabricator.wikimedia.org_6c848438_20250119_114242.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT268641)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T268641
# PushToWatch: classic CSRF (CVE-2020-35626)Closed, Resolved[Public](/policy/explain/PHID-TASK-dcf7sb5najsw24spkj2c/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/268641/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/268641/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-dcf7sb5najsw24spkj2c/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-dcf7sb5najsw24spkj2c/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-dcf7sb5najsw24spkj2c/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-dcf7sb5najsw24spkj2c/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-dcf7sb5najsw24spkj2c/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-dcf7sb5najsw24spkj2c/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-dcf7sb5najsw24spkj2c/)
* [Protect as security issue](/wmf/escalate-task/268641/)
* [Award Token](/token/give/PHID-TASK-dcf7sb5najsw24spkj2c/)
* [Flag For Later](/flag/edit/PHID-TASK-dcf7sb5najsw24spkj2c/)

Assigned To

|  | [ashley](/p/ashley/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Nov 24 2020, 3:44 PM2020-11-24 15:44:03 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [MediaWiki-extensions-PushToWatch](/tag/mediawiki-extensions-pushtowatch/) [(Backlog)](/project/board/4500/)
* [Vuln-CSRF](/tag/vuln-csrf/) [(Tracked)](/project/board/907/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [Urbanecm](/p/Urbanecm/) |
| --- | --- |

# Description

While working on [T268627: PushToWatch extension does not show anything in page footer](/T268627) as well as fixing some unrelated issues in that unmaintained codebase, I realized that the form (which currently requires **no authentication whatsoever**, thus rendering the extension 100% unsuitable for a public, world-editable wiki) shown on the page footer doesn't have an edit token, rendering the extension vulnerable to cross-site request forgeries.

Quick patch (on top of [all the patches I currently have open in gerrit against this extension](https://gerrit.wikimedia.org/r/q/owner%3Aashley%2540uncyclomedia.co%2Bproject%3Amediawiki/extensions/PushToWatch)):

```
diff --git a/src/PushToWatch.php b/src/PushToWatch.php
index 9a7f9a2..dd3e6bf 100644
--- a/src/PushToWatch.php
+++ b/src/PushToWatch.php
@@ -85,6 +85,7 @@ class PushToWatch {
                                $output .= Html::rawElement( 'form', [ 'method' => 'post' ],
                                        wfMessage( 'pushtowatch' )->escaped() .
                                        wfMessage( 'word-separator' )->parse() .
+                                       Html::hidden( 'wpPushToWatchToken', RequestContext::getMain()->getUser()->getEditToken() ) .
                                        Html::submitButton( '', [ 'style' => 'display:none' ] ) .
                                        // @todo FIXME: give this element class="mw-autocomplete-user" and add the
                                        // 'mediawiki.userSuggest' ResourceLoader module to output to enable
@@ -107,14 +108,21 @@ class PushToWatch {
         */
        public static function onSkinAddFooterLinks( Skin $sk, string $key, array &$footerLinks ) {
                $title = $sk->getRelevantTitle();
+               $request = $sk->getRequest();
                $output = '<hr />';
+               $isTokenOK = $sk->getUser()->matchEditToken( $request->getVal( 'wpPushToWatchToken' ) );

                try {
-                       $user = $sk->getRequest()->getText( 'pushtowatch_user' );
-                       // FIXME: This destroys all usernames that contain other characters!
-                       $user = preg_replace( "#[^a-z]#i", '', $user );
-                       if ( $user ) {
-                               self::addToWatch( $title, $user );
+                       if ( $request->wasPosted() && $isTokenOK ) {
+                               $user = $request->getText( 'pushtowatch_user' );
+                               // FIXME: This destroys all usernames that contain other characters!
+                               $user = preg_replace( "#[^a-z]#i", '', $user );
+                               if ( $user ) {
+                                       self::addToWatch( $title, $user );
+                               }
+                       } elseif ( $request->wasPosted() && !$isTokenOK ) {
+                               // CSRF attempt or something...
+                               $output .= Html::errorBox( $sk->msg( 'sessionfailure' )->parse() );
                        }
                } catch ( Exception $e ) {
                        $output .= Html::errorBox( $skin->msg( 'pushtowatch-error', $user )->parse() );
```
# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Fix CSRF vulnerability by requiring a valid edit token](https://gerrit.wikimedia.org/r/c/644501) | [mediawiki/extensions/PushToWatch](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PushToWatch) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PushToWatch/%2B/REL1_35) | +145 -0 |
|  | [SECURITY: Fix CSRF vulnerability by requiring a valid edit token](https://gerrit.wikimedia.org/r/c/643575) | [mediawiki/extensions/PushToWatch](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PushToWatch) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/PushToWatch/%2B/master) | +13 -5 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T268641)
# Related Objects

* Mentions

Mentioned In [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810) Mentioned Here [T268627: PushToWatch extension does not show anything in page footer](/T268627)
### Event Timeline

[ashley](/p/ashley/) created this task.[Nov 24 2020, 3:44 PM2020-11-24 15:44:03 (UTC+0)](#6645383)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/3997618/)[Nov 24 2020, 3:44 PM2020-11-24 15:44:04 (UTC+0)](#6645395)[ashley](/p/ashley/) added projects: [MediaWiki-extensions-PushToWatch](/tag/mediawiki-extensions-pushtowatch/), [Vuln-CSRF](/tag/vuln-csrf/).[Nov 24 2020, 3:44 PM2020-11-24 15:44:25 (UTC+0)](#6645396)[ashley](/p/ashley/) added a subscriber: [Bawolff](/p/Bawolff/).[Nov 25 2020, 9:36 AM2020-11-25 09:36:42 (UTC+0)](#6647797)[Bawolff](/p/Bawolff/) added a comment.[Nov 25 2020, 9:49 AM2020-11-25 09:49:35 (UTC+0)](#6647837)Comment Actions

lgtm, although i have no idea why its stripping non alphabetical characters from the username.

[Urbanecm](/p/Urbanecm/) closed this task as Resolved.[Nov 25 2020, 10:44 PM2020-11-25 22:44:52 (UTC+0)](#6650090)[Urbanecm](/p/Urbanecm/) assigned this task to [ashley](/p/ashley/).[Urbanecm](/p/Urbanecm/) subscribed.Comment Actions

Merged as [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PushToWatch/+/643575](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/PushToWatch/%2B/643575).

[Urbanecm](/p/Urbanecm/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-smwl4kfsjn2dbqk/)" to "Public (No Login Required)".[Nov 25 2020, 10:45 PM2020-11-25 22:45:07 (UTC+0)](#6650093)[Urbanecm](/p/Urbanecm/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-ptlx3x7bmmaezwl/)" to "All Users".[sbassett](/p/sbassett/) mentioned this in [T263810: Write and send supplementary release announcement for extensions and skins with security patches (1.31.11/1.35.1)](/T263810).[Dec 1 2020, 9:44 PM2020-12-01 21:44:45 (UTC+0)](#6661242)[gerritbot](/p/gerritbot/) added a comment.[Dec 1 2020, 9:45 PM2020-12-01 21:45:46 (UTC+0)](#6661243)Comment Actions

Change 644501 had a related patch set uploaded (by SBassett; owner: Jack Phoenix):

[mediawiki/extensions/PushToWatch@REL1\_35] SECURITY: Fix CSRF vulnerability by requiring a valid edit token

<https://gerrit.wikimedia.org/r/644501>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Dec 1 2020, 9:45 PM2020-12-01 21:45:47 (UTC+0)](#6661244)Comment Actions

Change 644501 **abandoned** by SBassett:

[mediawiki/extensions/PushToWatch@REL1\_35] SECURITY: Fix CSRF vulnerability by requiring a valid edit token

Reason:

Apparently not applicable to REL1\_35

<https://gerrit.wikimedia.org/r/644501>

[sbassett](/p/sbassett/) renamed this task from PushToWatch: classic CSRF to PushToWatch: classic CSRF (CVE-2020-35626).[Dec 22 2020, 8:49 PM2020-12-22 20:49:02 (UTC+0)](#6709083)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Dec 23 2020, 4:00 PM2020-12-23 16:00:56 (UTC+0)](#6710382)[sbassett](/p/sbassett/) removed a project: [Patch-For-Review](/tag/patch-for-review/).Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from gerrit.wikimedia.org_53f8b1e8_20250119_133016.html ===




=== Content from phabricator.wikimedia.org_ce40a58d_20250119_133017.html ===
[HomePhabricator](/)

* SearchConfigure Global Search
 [Auth](/auth/)  Login

Click the *MediaWiki* button below to connect your [Wikimedia unified account](https://meta.wikimedia.org/wiki/Help%3AUnified_login). Alternatively, click the *Wikitech Account (LDAP)* button to connect your [Developer account](https://www.mediawiki.org/wiki/Developer_account) credentials.

In case of doubt, [check the Phabricator Help](https://www.mediawiki.org/wiki/Phabricator/Help#Creating_your_account).

Log In or RegisterMediaWikiDeveloper Account Log InLDAP Account (IDP)
# Log In or Register with LDAP

LDAP UsernameLDAP PasswordLog In or RegisterTrouble logging in? [Send a login link to your email address.](/login/email/)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from gerrit.wikimedia.org_775d358f_20250119_114241.html ===



