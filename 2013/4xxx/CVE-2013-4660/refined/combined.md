=== Content from nealpoole.com_a2e6f4c6_20250125_223601.html ===

# [Neal Poole](https://nealpoole.com/blog)

* [Home](https://nealpoole.com/blog)
* [About](https://nealpoole.com/blog/about/)
* [Contact](https://nealpoole.com/blog/contact/)
* [Responsible Disclosure](https://nealpoole.com/blog/responsible-disclosure-programs/)

* [Twitter](https://twitter.com/NealPoole "Follow me on Twitter")
* [RSS Feed](https://nealpoole.com/blog/feeds/all.rss.xml "Subscribe to Neal Poole Full RSS Feed")

2013

06.23

## [Code Execution via YAML in JS-YAML Node.js Module](https://nealpoole.com/blog/2013/06/code-execution-via-yaml-in-js-yaml-nodejs-module/ "Permalink to Code Execution via YAML in JS-YAML Node.jsÂ Module")

Category: [Vulnerability Writeups](https://nealpoole.com/blog/category/vulnerability-writeups/) /
Tag: [security](https://nealpoole.com/blog/tag/security/), [web application security](https://nealpoole.com/blog/tag/web-application-security/), [node](https://nealpoole.com/blog/tag/node/), [yaml](https://nealpoole.com/blog/tag/yaml/), [js-yaml](https://nealpoole.com/blog/tag/js-yaml/), [code execution](https://nealpoole.com/blog/tag/code-execution/) / [Add Comment](#respond)

### Summary

The [JS-YAML](https://npmjs.org/package/js-yaml) module for Node.js contained a code execution vulnerability prior
to version 2.0.5. The maintainers of [JS-YAML](https://npmjs.org/package/js-yaml) have patched this vulnerability
and, beginning in version 2.1.0, have provided a `safeLoad` method for parsing YAML.
Developers that use this module should make sure they have upgraded and should
strongly consider porting their code to use the new `safeLoad` method.

***Update:*** The code execution vulnerability has been assigned CVE-2013-4660.

### Vulnerability Details

The module allowed code execution due to a custom data-type that it defined
and parsed called `!!js/function`. The way it would parse the data was to
create a new `Function` object in JavaScript based on the input, which is
equivalent to calling eval on the input:

| ```  1  2  3  4  5  6  7  8  9 10 11 ``` | ``` function resolveJavascriptFunction(object /*, explicit*/) {   /*jslint evil:true*/   var func;    try {     func = new Function('return ' + object);     return func();   } catch (error) {     return NIL;   } }  ``` |
| --- | --- |

That meant the code snippet below, when run, would execute code instead of
simply defining a function:

| ``` 1 2 3 4 5 6 7 8 ``` | ``` var yaml = require('js-yaml');  x = "test: !!js/function > \n  \ function f() { \n    \ console.log(1); \n  \ }();"  yaml.load(x);  ``` |
| --- | --- |

The vulnerability was patched under 24 hours after I initially contacted
the module’s maintainers: the [esprima](https://npmjs.org/package/esprima) package is now used to parse the input
and validate it before execution.[[1]](https://github.com/nodeca/js-yaml/commit/430f88097233695f6bc0cdfa6f594ad126930345)

### Why switch to `safeLoad`

Starting in version 2.1.0, the [JS-YAML](https://npmjs.org/package/js-yaml) module provides a `safeLoad` function for
use by developers. It is recommended by the maintainers as the default,
in place of the `load` function demonstrated above.

The main difference between the two functions is what types are parsed:

* `safeLoad` recognizes a “`DEFAULT_SAFE_SCHEMA`“, which parses
  “all supported YAML types, without unsafe ones (`!!js/undefined`,
  `!!js/regexp` and `!!js/function`)”
* `load` recognizes a “`DEFAULT_FULL_SCHEMA`“, which parses all tags
  (including those which `safeLoad` does not).

A proof of concept from the module’s README demonstrates why `load` can be dangerous:

| ``` 1 2 3 4 ``` | ``` var untrusted_code = '"toString": !<tag:yaml.org,2002:js/function> "function (){very_evil_thing();}"';  // I'm just converting that string, what could possibly go wrong? require('js-yaml').load(untrusted_code) + ''  ``` |
| --- | --- |

By overriding functions like `toString` with arbitrary code or providing
other unexpected input, an attacker can perform malicious actions as part
of a Node application. Switching to `safeLoad` mitigates this risk
because “dangerous” types are not parsed.

### Conclusion

Developers using the [JS-YAML](https://npmjs.org/package/js-yaml) module should make sure that they are working with
an up-to-date version and should strongly consider porting their code to use
`safeLoad` in place of `load`, especially when accepting YAML derived from
user input.

If you’re interested in the security of Node modules, be sure to check out
the [Node Security](http://nodesecurity.io/) project.

### Comments

* ## About Me

  My name is Neal Poole. I'm interested in web application security.
  I'm a Security Engineer on the Product Security team at [Facebook](https://www.facebook.com).
  My posts are my own and do not necessarily reflect the views and opinions of my employer.
* ## Categories

  + [General Musings](https://nealpoole.com/blog/category/general-musings/ "View all posts filed under General Musings")
  + [Rants & Raves](https://nealpoole.com/blog/category/rants-raves/ "View all posts filed under Rants & Raves")
  + [Tips & Tricks](https://nealpoole.com/blog/category/tips-tricks/ "View all posts filed under Tips & Tricks")
  + [Vulnerability Writeups](https://nealpoole.com/blog/category/vulnerability-writeups/ "View all posts filed under Vulnerability Writeups")
* ## Tags

  [0x000006bb](https://nealpoole.com/blog/tag/0x000006bb/)
  [Facebook](https://nealpoole.com/blog/tag/facebook/)
  [Flash](https://nealpoole.com/blog/tag/flash/)
  [HP Officejet](https://nealpoole.com/blog/tag/hp-officejet/)
  [MySQL](https://nealpoole.com/blog/tag/mysql/)
  [Oracle](https://nealpoole.com/blog/tag/oracle/)
  [Oracle October 2011 CPU](https://nealpoole.com/blog/tag/oracle-october-2011-cpu/)
  [PHP](https://nealpoole.com/blog/tag/php/)
  [Plupload](https://nealpoole.com/blog/tag/plupload/)
  [SVN](https://nealpoole.com/blog/tag/svn/)
  [USB](https://nealpoole.com/blog/tag/usb/)
  [Wordpress](https://nealpoole.com/blog/tag/wordpress/)
  [addons.mozilla.org](https://nealpoole.com/blog/tag/addonsmozillaorg/)
  [arbitrary code execution](https://nealpoole.com/blog/tag/arbitrary-code-execution/)
  [arbitrary precision](https://nealpoole.com/blog/tag/arbitrary-precision/)
  [clickjacking](https://nealpoole.com/blog/tag/clickjacking/)
  [code execution](https://nealpoole.com/blog/tag/code-execution/)
  [coinbase](https://nealpoole.com/blog/tag/coinbase/)
  [csrf](https://nealpoole.com/blog/tag/csrf/)
  [directory traversal](https://nealpoole.com/blog/tag/directory-traversal/)
  [ebay](https://nealpoole.com/blog/tag/ebay/)
  [file upload](https://nealpoole.com/blog/tag/file-upload/)
  [firefox](https://nealpoole.com/blog/tag/firefox/)
  [google](https://nealpoole.com/blog/tag/google/)
  [google apps](https://nealpoole.com/blog/tag/google-apps/)
  [google code](https://nealpoole.com/blog/tag/google-code/)
  [google ejabat](https://nealpoole.com/blog/tag/google-ejabat/)
  [google visualization](https://nealpoole.com/blog/tag/google-visualization/)
  [google vulnerability reward program](https://nealpoole.com/blog/tag/google-vulnerability-reward-program/)
  [hackathon](https://nealpoole.com/blog/tag/hackathon/)
  [iconv](https://nealpoole.com/blog/tag/iconv/)
  [java](https://nealpoole.com/blog/tag/java/)
  [java applet](https://nealpoole.com/blog/tag/java-applet/)
  [jsonp](https://nealpoole.com/blog/tag/jsonp/)
  [nginx](https://nealpoole.com/blog/tag/nginx/)
  [node](https://nealpoole.com/blog/tag/node/)
  [programming](https://nealpoole.com/blog/tag/programming/)
  [reddit](https://nealpoole.com/blog/tag/reddit/)
  [security](https://nealpoole.com/blog/tag/security/)
  [ssh](https://nealpoole.com/blog/tag/ssh/)
  [textpattern](https://nealpoole.com/blog/tag/textpattern/)
  [web application security](https://nealpoole.com/blog/tag/web-application-security/)
  [xss](https://nealpoole.com/blog/tag/xss/)
  [yaml](https://nealpoole.com/blog/tag/yaml/)
  [yandex](https://nealpoole.com/blog/tag/yandex/)
* ## Archives

  + [July 2013](https://nealpoole.com/blog/2013/07 "July 2013") (3)
  + [June 2013](https://nealpoole.com/blog/2013/06 "June 2013") (3)
  + [April 2013](https://nealpoole.com/blog/2013/04 "April 2013") (2)
  + [March 2013](https://nealpoole.com/blog/2013/03 "March 2013") (3)
  + [January 2013](https://nealpoole.com/blog/2013/01 "January 2013") (1)
  + [May 2012](https://nealpoole.com/blog/2012/05 "May 2012") (1)
  + [April 2012](https://nealpoole.com/blog/2012/04 "April 2012") (1)
  + [March 2012](https://nealpoole.com/blog/2012/03 "March 2012") (1)
  + [October 2011](https://nealpoole.com/blog/2011/10 "October 2011") (3)
  + [August 2011](https://nealpoole.com/blog/2011/08 "August 2011") (4)
  + [May 2011](https://nealpoole.com/blog/2011/05 "May 2011") (1)
  + [April 2011](https://nealpoole.com/blog/2011/04 "April 2011") (4)
  + [March 2011](https://nealpoole.com/blog/2011/03 "March 2011") (3)
  + [February 2011](https://nealpoole.com/blog/2011/02 "February 2011") (5)
  + [January 2011](https://nealpoole.com/blog/2011/01 "January 2011") (3)
  + [December 2010](https://nealpoole.com/blog/2010/12 "December 2010") (6)
  + [November 2010](https://nealpoole.com/blog/2010/11 "November 2010") (4)
  + [August 2010](https://nealpoole.com/blog/2010/08 "August 2010") (5)
  + [July 2010](https://nealpoole.com/blog/2010/07 "July 2010") (6)
  + [June 2010](https://nealpoole.com/blog/2010/06 "June 2010") (4)

© Neal Poole. Proudly powered by [Pelican](http://getpelican.com/),
which takes great advantage of [Python](http://python.org).
Theme based on [Pyrmont V2](http://imotta.cn/ "Pyrmont V2 theme").


