=== Content from access.redhat.com_0f2703d1_20250126_042612.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from www.kernel.org_181d3edd_20250124_232131.html ===
commit e6577f3189d82a729b13e38f3d135f1becd6d294
Author: Greg Kroah-Hartman
Date: Fri Jan 11 09:19:28 2013 -0800
Linux 3.7.2
commit 1dcfb28724803c27657b335dbb8f4494067d10e5
Author: Jeff Layton
Date: Tue Dec 18 06:35:10 2012 -0500
cifs: don't compare uniqueids in cifs\_prime\_dcache unless server inode numbers are in use
commit 2f2591a34db6c9361faa316c91a6e320cb4e6aee upstream.
Oliver reported that commit cd60042c caused his cifs mounts to
continually thrash through new inodes on readdir. His servers are not
sending inode numbers (or he's not using them), and the new test in
that function doesn't account for that sort of setup correctly.
If we're not using server inode numbers, then assume that the inode
attached to the dentry hasn't changed. Go ahead and update the
attributes in place, but keep the same inode number.
Reported-and-Tested-by: Oliver MÃ¶ssinger
Signed-off-by: Jeff Layton
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 862dc356d36fd84c5673af61364447bd38b453c6
Author: Jeff Layton
Date: Mon Dec 3 06:05:37 2012 -0500
cifs: rename cifs\_readdir\_lookup to cifs\_prime\_dcache and make it void return
commit eb1b3fa5cdb9c27bdec8f262acf757a06588eb2d upstream.
The caller doesn't do anything with the dentry, so there's no point in
holding a reference to it on return. Also cifs\_prime\_dcache better
describes the actual purpose of the function.
Signed-off-by: Jeff Layton
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 76e59b0f305a6f2e2ebcfdb8c14750d08ff037ba
Author: Alexander Stein
Date: Tue Nov 27 08:52:34 2012 +0100
can: Do not call dev\_put if restart timer is running upon close
commit ab48b03ec9ae1840a1e427e2375bd0d9d554b4ed upstream.
If the restart timer is running due to BUS-OFF and the device is
disconnected an dev\_put will decrease the usage counter to -1 thus
blocking the interface removal, resulting in the following dmesg
lines repeating every 10s:
can: notifier: receive list not found for dev can0
can: notifier: receive list not found for dev can0
can: notifier: receive list not found for dev can0
unregister\_netdevice: waiting for can0 to become free. Usage count = -1
Signed-off-by: Alexander Stein
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 50e54c2c8d010f933b49176b33961e7ad72c0c33
Author: Ben Hutchings
Date: Sun Dec 2 14:38:23 2012 +0000
HID: Add Apple wireless keyboard 2011 ANSI to special driver list
commit f9af7b9edccb87d4d80b58687ab63e58f3b64c4c upstream.
Commit 0a97e1e9f9a6 ('HID: apple: Add Apple wireless keyboard 2011 ANSI PID')
did not update the special driver list in hid-core.c, so hid-generic may
still bind to this device.
Reported-by: Ari Pollak
References: http://bugs.debian.org/694546
Signed-off-by: Ben Hutchings
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit e4ada2b44499ce77e6053679e1f60cad42611b91
Author: Guenter Roeck
Date: Thu Dec 20 15:05:42 2012 -0800
linux/kernel.h: fix DIV\_ROUND\_CLOSEST with unsigned divisors
commit c4e18497d8fd92eef2c6e7eadcc1a107ccd115ea upstream.
Commit 263a523d18bc ("linux/kernel.h: Fix warning seen with W=1 due to
change in DIV\_ROUND\_CLOSEST") fixes a warning seen with W=1 due to
change in DIV\_ROUND\_CLOSEST.
Unfortunately, the C compiler converts divide operations with unsigned
divisors to unsigned, even if the dividend is signed and negative (for
example, -10 / 5U = 858993457). The C standard says "If one operand has
unsigned int type, the other operand is converted to unsigned int", so
the compiler is not to blame. As a result, DIV\_ROUND\_CLOSEST(0, 2U) and
similar operations now return bad values, since the automatic conversion
of expressions such as "0 - 2U/2" to unsigned was not taken into
account.
Fix by checking for the divisor variable type when deciding which
operation to perform. This fixes DIV\_ROUND\_CLOSEST(0, 2U), but still
returns bad values for negative dividends divided by unsigned divisors.
Mark the latter case as unsupported.
One observed effect of this problem is that the s2c\_hwmon driver reports
a value of 4198403 instead of 0 if the ADC reads 0.
Other impact is unpredictable. Problem is seen if the divisor is an
unsigned variable or constant and the dividend is less than (divisor/2).
Signed-off-by: Guenter Roeck
Reported-by: Juergen Beisert
Tested-by: Juergen Beisert
Cc: Jean Delvare
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 787f7301074ccd07a3e82236ca41eefd245f4e07
Author: Michal Hocko
Date: Fri Jan 4 15:35:12 2013 -0800
mm: limit mmu\_gather batching to fix soft lockups on !CONFIG\_PREEMPT
commit 53a59fc67f97374758e63a9c785891ec62324c81 upstream.
Since commit e303297e6c3a ("mm: extended batches for generic
mmu\_gather") we are batching pages to be freed until either
tlb\_next\_batch cannot allocate a new batch or we are done.
This works just fine most of the time but we can get in troubles with
non-preemptible kernel (CONFIG\_PREEMPT\_NONE or CONFIG\_PREEMPT\_VOLUNTARY)
on large machines where too aggressive batching might lead to soft
lockups during process exit path (exit\_mmap) because there are no
scheduling points down the free\_pages\_and\_swap\_cache path and so the
freeing can take long enough to trigger the soft lockup.
The lockup is harmless except when the system is setup to panic on
softlockup which is not that unusual.
The simplest way to work around this issue is to limit the maximum
number of batches in a single mmu\_gather. 10k of collected pages should
be safe to prevent from soft lockups (we would have 2ms for one) even if
they are all freed without an explicit scheduling point.
This patch doesn't add any new explicit scheduling points because it
relies on zap\_pmd\_range during page tables zapping which calls
cond\_resched per PMD.
The following lockup has been reported for 3.0 kernel with a huge
process (in order of hundreds gigs but I do know any more details).
BUG: soft lockup - CPU#56 stuck for 22s! [kernel:31053]
Modules linked in: af\_packet nfs lockd fscache auth\_rpcgss nfs\_acl sunrpc mptctl mptbase autofs4 binfmt\_misc dm\_round\_robin dm\_multipath bonding cpufreq\_conservative cpufreq\_userspace cpufreq\_powersave pcc\_cpufreq mperf microcode fuse loop osst sg sd\_mod crc\_t10dif st qla2xxx scsi\_transport\_fc scsi\_tgt netxen\_nic i7core\_edac iTCO\_wdt joydev e1000e serio\_raw pcspkr edac\_core iTCO\_vendor\_support acpi\_power\_meter rtc\_cmos hpwdt hpilo button container usbhid hid dm\_mirror dm\_region\_hash dm\_log linear uhci\_hcd ehci\_hcd usbcore usb\_common scsi\_dh\_emc scsi\_dh\_alua scsi\_dh\_hp\_sw scsi\_dh\_rdac scsi\_dh dm\_snapshot pcnet32 mii edd dm\_mod raid1 ext3 mbcache jbd fan thermal processor thermal\_sys hwmon cciss scsi\_mod
Supported: Yes
CPU 56
Pid: 31053, comm: kernel Not tainted 3.0.31-0.9-default #1 HP ProLiant DL580 G7
RIP: 0010: \_raw\_spin\_unlock\_irqrestore+0x8/0x10
RSP: 0018:ffff883ec1037af0 EFLAGS: 00000206
RAX: 0000000000000e00 RBX: ffffea01a0817e28 RCX: ffff88803ffd9e80
RDX: 0000000000000200 RSI: 0000000000000206 RDI: 0000000000000206
RBP: 0000000000000002 R08: 0000000000000001 R09: ffff887ec724a400
R10: 0000000000000000 R11: dead000000200200 R12: ffffffff8144c26e
R13: 0000000000000030 R14: 0000000000000297 R15: 000000000000000e
FS: 00007ed834282700(0000) GS:ffff88c03f200000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 000000008005003b
CR2: 000000000068b240 CR3: 0000003ec13c5000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
Process kernel (pid: 31053, threadinfo ffff883ec1036000, task ffff883ebd5d4100)
Call Trace:
release\_pages+0xc5/0x260
free\_pages\_and\_swap\_cache+0x9d/0xc0
tlb\_flush\_mmu+0x5c/0x80
tlb\_finish\_mmu+0xe/0x50
exit\_mmap+0xbd/0x120
mmput+0x49/0x120
exit\_mm+0x122/0x160
do\_exit+0x17a/0x430
do\_group\_exit+0x3d/0xb0
get\_signal\_to\_deliver+0x247/0x480
do\_signal+0x71/0x1b0
do\_notify\_resume+0x98/0xb0
int\_signal+0x12/0x17
DWARF2 unwinder stuck at int\_signal+0x12/0x17
Signed-off-by: Michal Hocko
Cc: Mel Gorman
Cc: Rik van Riel
Cc: Peter Zijlstra
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit bc2eb9ea9eae3cd2485dad9bb1541f18dffa6c5c
Author: Tony Prisk
Date: Fri Jan 4 15:35:48 2013 -0800
drivers/rtc/rtc-vt8500.c: fix handling of data passed in struct rtc\_time
commit 2f90b68309683f2c5765a1b04ca23d71e51f1494 upstream.
tm\_mon is 0..11, whereas vt8500 expects 1..12 for the month field,
causing invalid date errors for January, and causing the day field to
roll over incorrectly.
The century flag is only handled in vt8500\_rtc\_read\_time, but not set in
vt8500\_rtc\_set\_time. This patch corrects the behaviour of the century
flag.
Signed-off-by: Edgar Toernig
Signed-off-by: Tony Prisk
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit a28690b32d01b12edb03da62b1180b83fdc5a8b3
Author: Tony Prisk
Date: Fri Jan 4 15:35:47 2013 -0800
drivers/rtc/rtc-vt8500.c: correct handling of CR\_24H bitfield
commit 532db570e5181abc8f4f7bfa6c77c69ec2240198 upstream.
Control register bitfield for 12H/24H mode is handled incorrectly.
Setting CR\_24H actually enables 12H mode. This patch renames the define
and changes the initialization code to correctly set 24H mode.
Signed-off-by: Tony Prisk
Cc: Edgar Toernig
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 287376ad9f4cf330c786ac84d9f6a416d9ac0d09
Author: Andrew Morton
Date: Thu Dec 20 15:05:34 2012 -0800
revert "rtc: recycle id when unloading a rtc driver"
commit 5abe257af8b95857b95fa0ba694530b446ae32d8 upstream.
Revert commit 2830a6d20139df2198d63235df7957712adb28e5.
We already perform the ida\_simple\_remove() in rtc\_device\_release(),
which is an appropriate place. Commit 2830a6d20 ("rtc: recycle id when
unloading a rtc driver") caused the kernel to emit
ida\_remove called for id=0 which is not allocated.
warnings when rtc\_device\_release() tries to release an alread-released
ID.
Let's restore things to their previous state and then work out why
Vincent's kernel wasn't calling rtc\_device\_release() - presumably a bug
in a specific sub-driver.
Reported-by: Lothar Waßmann
Acked-by: Alexander Holler
Cc: Vincent Palatin
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 423fccba308720afd02ec192c9ca59a167ca3717
Author: Corey Minyard
Date: Tue Dec 18 14:21:19 2012 -0800
CRIS: fix I/O macros
commit c24bf9b4cc6a0f330ea355d73bfdf1dae7e63a05 upstream.
The inb/outb macros for CRIS are broken from a number of points of view,
missing () around parameters and they have an unprotected if statement
in them. This was breaking the compile of IPMI on CRIS and thus I was
being annoyed by build regressions, so I fixed them.
Plus I don't think they would have worked at all, since the data values
were missing "&" and the outsl had a "3" instead of a "4" for the size.
From what I can tell, this stuff is not used at all, so this can't be
any more broken than it was before, anyway.
Signed-off-by: Corey Minyard
Cc: Jesper Nilsson
Cc: Mikael Starvik
Acked-by: Geert Uytterhoeven
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3f0f3b1f1d41775078ee2f2a12b148191d5ac8de
Author: Artem Bityutskiy
Date: Mon Dec 17 16:03:17 2012 -0800
proc: pid/status: show all supplementary groups
commit 8d238027b87e654be552eabdf492042a34c5c300 upstream.
We display a list of supplementary group for each process in
/proc//status. However, we show only the first 32 groups, not all of
them.
Although this is rare, but sometimes processes do have more than 32
supplementary groups, and this kernel limitation breaks user-space apps
that rely on the group list in /proc//status.
Number 32 comes from the internal NGROUPS\_SMALL macro which defines the
length for the internal kernel "small" groups buffer. There is no
apparent reason to limit to this value.
This patch removes the 32 groups printing limit.
The Linux kernel limits the amount of supplementary groups by NGROUPS\_MAX,
which is currently set to 65536. And this is the maximum count of groups
we may possibly print.
Signed-off-by: Artem Bityutskiy
Acked-by: Serge E. Hallyn
Acked-by: Kees Cook
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 65bacde551e409a27dd86dae3801e3726b97ca28
Author: Stephen Boyd
Date: Wed Dec 19 23:39:48 2012 -0800
lib: atomic64: Initialize locks statically to fix early users
commit fcc16882ac4532aaa644bff444f0c5d6228ba71e upstream.
The atomic64 library uses a handful of static spin locks to implement
atomic 64-bit operations on architectures without support for atomic
64-bit instructions.
Unfortunately, the spinlocks are initialized in a pure initcall and that
is too late for the vfs namespace code which wants to use atomic64
operations before the initcall is run.
This became a problem as of commit 8823c079ba71: "vfs: Add setns support
for the mount namespace".
This leads to BUG messages such as:
BUG: spinlock bad magic on CPU#0, swapper/0/0
lock: atomic64\_lock+0x240/0x400, .magic: 00000000, .owner: /-1, .owner\_cpu: 0
do\_raw\_spin\_lock+0x158/0x198
\_raw\_spin\_lock\_irqsave+0x4c/0x58
atomic64\_add\_return+0x30/0x5c
alloc\_mnt\_ns.clone.14+0x44/0xac
create\_mnt\_ns+0xc/0x54
mnt\_init+0x120/0x1d4
vfs\_caches\_init+0xe0/0x10c
start\_kernel+0x29c/0x300
coming out early on during boot when spinlock debugging is enabled.
Fix this by initializing the spinlocks statically at compile time.
Reported-and-tested-by: Vaibhav Bedia
Tested-by: Tony Lindgren
Cc: Eric W. Biederman
Signed-off-by: Stephen Boyd
Signed-off-by: Linus Torvalds
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit 3d8c1e480a910cf0940f7b375875b567a5a9a771
Author: Gustavo Padovan
Date: Mon Dec 3 15:36:51 2012 -0200
Revert "Bluetooth: Fix possible deadlock in SCO code"
commit 0b27a4b97cb1874503c78453c0903df53c0c86b2 upstream.
This reverts commit 269c4845d5b3627b95b1934107251bacbe99bb68.
The commit was causing dead locks and NULL dereferences in the sco code:
[28084.104013] BUG: soft lockup - CPU#0 stuck for 22s! [kworker/u:0H:7]
[28084.104021] Modules linked in: btusb bluetooth ] \_raw\_spin\_lock+0xd/0x10
[28084.104021] [] sco\_conn\_del+0x58/0x1b0 [bluetooth]
[28084.104021] [] sco\_connect\_cfm+0xb9/0x2b0 [bluetooth]
[28084.104021] []
hci\_sync\_conn\_complete\_evt.isra.94+0x1c9/0x260 [bluetooth]
[28084.104021] [] hci\_event\_packet+0x74d/0x2b40 [bluetooth]
[28084.104021] [] ? \_\_kfree\_skb+0x3d/0x90
[28084.104021] [] ? kfree\_skb+0x36/0x90
[28084.104021] [] ? hci\_send\_to\_monitor+0x10e/0x190 [bluetooth]
[28084.104021] [] ? hci\_send\_to\_monitor+0x10e/0x190 [bluetooth]
Reported-by: Chan-yeol Park
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit c7cf062d05129d6d75dabfcb96f5c5a4a92d824c
Author: Gustavo Padovan
Date: Wed Nov 21 00:50:21 2012 -0200
Bluetooth: cancel power\_on work when unregistering the device
commit b9b5ef188e5a2222cfc16ef62a4703080750b451 upstream.
We need to cancel the hci\_power\_on work in order to avoid it run when we
try to free the hdev.
[ 1434.201149] ------------[ cut here ]------------
[ 1434.204998] WARNING: at lib/debugobjects.c:261 debug\_print\_object+0x8e/0xb0()
[ 1434.208324] ODEBUG: free active (active state 0) object type: work\_struct hint: hci
\_power\_on+0x0/0x90
[ 1434.210386] Pid: 8564, comm: trinity-child25 Tainted: G W 3.7.0-rc5-next-
20121112-sasha-00018-g2f4ce0e #127
[ 1434.210760] Call Trace:
[ 1434.210760] [] ? debug\_print\_object+0x8e/0xb0
[ 1434.210760] [] warn\_slowpath\_common+0x87/0xb0
[ 1434.210760] [] warn\_slowpath\_fmt+0x41/0x50
[ 1434.210760] [] debug\_print\_object+0x8e/0xb0
[ 1434.210760] [] ? hci\_dev\_open+0x310/0x310
[ 1434.210760] [] ? \_raw\_spin\_unlock\_irqrestore+0x55/0xa0
[ 1434.210760] [] \_\_debug\_check\_no\_obj\_freed+0xa5/0x230
[ 1434.210760] [] ? bt\_host\_release+0x10/0x20
[ 1434.210760] [] debug\_check\_no\_obj\_freed+0x15/0x20
[ 1434.210760] [] kfree+0x227/0x330
[ 1434.210760] [] bt\_host\_release+0x10/0x20
[ 1434.210760] [] device\_release+0x65/0xc0
[ 1434.210760] [] kobject\_cleanup+0x145/0x190
[ 1434.210760] [] kobject\_release+0xd/0x10
[ 1434.210760] [] kobject\_put+0x4c/0x60
[ 1434.210760] [] put\_device+0x12/0x20
[ 1434.210760] [] hci\_free\_dev+0x24/0x30
[ 1434.210760] [] vhci\_release+0x31/0x60
[ 1434.210760] [] \_\_fput+0x122/0x250
[ 1434.210760] [] ? rcu\_user\_exit+0x9d/0xd0
[ 1434.210760] [] \_\_\_\_fput+0x9/0x10
[ 1434.210760] [] task\_work\_run+0xb2/0xf0
[ 1434.210760] [] do\_notify\_resume+0x77/0xa0
[ 1434.210760] [] int\_signal+0x12/0x17
[ 1434.210760] ---[ end trace a6d57fefbc8a8cc7 ]---
Reported-by: Sasha Levin
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 5795b170bfde23d424fb15d2c945d5dfb827e063
Author: Gustavo Padovan
Date: Tue Nov 20 23:25:54 2012 -0200
Bluetooth: Add missing lock nesting notation
commit dc2a0e20fbc85a71c63aa4330b496fda33f6bf80 upstream.
This patch fixes the following report, it happens when accepting rfcomm
connections:
[ 228.165378] =============================================
[ 228.165378] [ INFO: possible recursive locking detected ]
[ 228.165378] 3.7.0-rc1-00536-gc1d5dc4 #120 Tainted: G W
[ 228.165378] ---------------------------------------------
[ 228.165378] bluetoothd/1341 is trying to acquire lock:
[ 228.165378] (sk\_lock-AF\_BLUETOOTH-BTPROTO\_RFCOMM){+.+...}, at:
[] bt\_accept\_dequeue+0xa0/0x180 [bluetooth]
[ 228.165378]
[ 228.165378] but task is already holding lock:
[ 228.165378] (sk\_lock-AF\_BLUETOOTH-BTPROTO\_RFCOMM){+.+...}, at:
[] rfcomm\_sock\_accept+0x58/0x2d0 [rfcomm]
[ 228.165378]
[ 228.165378] other info that might help us debug this:
[ 228.165378] Possible unsafe locking scenario:
[ 228.165378]
[ 228.165378] CPU0
[ 228.165378] ----
[ 228.165378] lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_RFCOMM);
[ 228.165378] lock(sk\_lock-AF\_BLUETOOTH-BTPROTO\_RFCOMM);
[ 228.165378]
[ 228.165378] \*\*\* DEADLOCK \*\*\*
[ 228.165378]
[ 228.165378] May be due to missing lock nesting notation
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 2ea3e85ea577adc61acef73b3b83da5ed781da99
Author: Jeff Cook
Date: Fri Nov 9 16:39:48 2012 -0700
Bluetooth: Add support for BCM20702A0 [0b05, 17b5]
commit 1ee3ff6110c16acfc915a79b1e3feb5013c41e75 upstream.
Vendor-specific ID for BCM20702A0.
Support for bluetooth over Asus Wi-Fi GO!, included with Asus P8Z77-V
Deluxe.
T: Bus=07 Lev=02 Prnt=02 Port=00 Cnt=01 Dev#= 3 Spd=12 MxCh= 0
D: Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
P: Vendor=0b05 ProdID=17b5 Rev=01.12
S: Manufacturer=Broadcom Corp
S: Product=BCM20702A0
S: SerialNumber=94DBC98AC113
C: #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=0mA
I: If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
I: If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
I: If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
I: If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
Signed-off-by: Jeff Cook
Signed-off-by: Gustavo Padovan
Signed-off-by: Greg Kroah-Hartman
commit 63be10e5ace81580bd2944aa2f283d75bd2f0a01
Author: Myron Stowe
Date: Wed Dec 26 10:39:23 2012 -0700
PCI: Work around Stratus ftServer broken PCIe hierarchy (fix DMI check)
commit 1278998f8ff6d66044ed00b581bbf14aacaba215 upstream.
Commit 284f5f9 was intended to disable the "only\_one\_child()" optimization
on Stratus ftServer systems, but its DMI check is wrong. It looks for
DMI\_SYS\_VENDOR that contains "ftServer", when it should look for
DMI\_SYS\_VENDOR containing "Stratus" and DMI\_PRODUCT\_NAME containing
"ftServer".
Tested on Stratus ftServer 6400.
Reported-by: Fadeeva Marina
Reference: https://bugzilla.kernel.org/show\_bug.cgi?id=51331
Signed-off-by: Myron Stowe
Signed-off-by: Bjorn Helgaas
Signed-off-by: Greg Kroah-Hartman
commit dc0e6fecca56cc2ad5c8ce9023e1be6737441cb3
Author: Huang Ying
Date: Wed Dec 26 10:39:23 2012 -0700
PCI/PM: Do not suspend port if any subordinate device needs PME polling
commit c733b77475707cc3980542c86ee0ad5c841d544c upstream.
Ulrich reported that his USB3 cardreader does not work reliably when
connected to the USB3 port. It turns out that USB3 controller failed to
awaken when plugging in the USB3 cardreader. Further experiments found
that the USB3 host controller can only be awakened via polling, not via PME
interrupt. But if the PCIe port to which the USB3 host controller is
connected is suspended, we cannot poll the controller because its config
space is not accessible when the PCIe port is in a low power state.
To solve the issue, the PCIe port will not be suspended if any subordinate
device needs PME polling.
[bhelgaas: use bool consistently rather than mixing int/bool]
Reference: http://lkml.kernel.org/r/50841CCC.9030809@uli-eckhardt.de
Reported-by: Ulrich Eckhardt
Tested-by: Sarah Sharp
Signed-off-by: Huang Ying
Signed-off-by: Bjorn Helgaas
Acked-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit c9b184487ae4e1ec9c8d11b4ed1a23293fabb2ce
Author: Andy Lutomirski
Date: Sat Dec 1 12:37:20 2012 -0800
PCI: Reduce Ricoh 0xe822 SD card reader base clock frequency to 50MHz
commit 812089e01b9f65f90fc8fc670d8cce72a0e01fbb upstream.
Otherwise it fails like this on cards like the Transcend 16GB SDHC card:
mmc0: new SDHC card at address b368
mmcblk0: mmc0:b368 SDC 15.0 GiB
mmcblk0: error -110 sending status command, retrying
mmcblk0: error -84 transferring data, sector 0, nr 8, cmd response 0x900, card status 0xb0
Tested on my Lenovo x200 laptop.
[bhelgaas: changelog]
Signed-off-by: Andy Lutomirski
Signed-off-by: Bjorn Helgaas
Acked-by: Chris Ball
CC: Manoj Iyer
Signed-off-by: Greg Kroah-Hartman
commit 0635ca9a8069d8b12debcf0e99cab47a5437997f
Author: Huang Ying
Date: Tue Nov 20 16:08:22 2012 +0800
PCI/PM: Keep runtime PM enabled for unbound PCI devices
commit 967577b062417b4e4b8e27b711220f4124f5153a upstream.
For unbound PCI devices, what we need is:
- Always in D0 state, because some devices do not work again after
being put into D3 by the PCI bus.
- In SUSPENDED state if allowed, so that the parent devices can still
be put into low power state.
To satisfy these requirements, the runtime PM for the unbound PCI
devices are disabled and set to SUSPENDED state. One issue of this
solution is that the PCI devices will be put into SUSPENDED state even
if the SUSPENDED state is forbidden via the sysfs interface
(.../power/control) of the device. This is not an issue for most
devices, because most PCI devices are not used at all if unbound.
But there are exceptions. For example, unbound VGA card can be used
for display, but suspending its parents makes it stop working.
To fix the issue, we keep the runtime PM enabled when the PCI devices
are unbound. But the runtime PM callbacks will do nothing if the PCI
devices are unbound. This way, we can put the PCI devices into
SUSPENDED state without putting the PCI devices into D3 state.
Reference: https://bugzilla.kernel.org/show\_bug.cgi?id=48201
Signed-off-by: Huang Ying
Signed-off-by: Bjorn Helgaas
Acked-by: Alan Stern
Acked-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 6e9fd9fbb4f2dd2506e708af835e39d00264d8e6
Author: David Woodhouse
Date: Tue Dec 11 14:57:14 2012 +0000
solos-pci: fix double-free of TX skb in DMA mode
commit cae49ede00ec3d0cda290b03fee55b72b49efc11 upstream.
We weren't clearing card->tx\_skb[port] when processing the TX done interrupt.
If there wasn't another skb ready to transmit immediately, this led to a
double-free because we'd free it \*again\* next time we did have a packet to
send.
Signed-off-by: David Woodhouse
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 756c3f692b7c5158dfe545fe56c517b6e065688b
Author: Jeff Layton
Date: Thu Dec 27 08:05:03 2012 -0500
cifs: adjust sequence number downward after signing NT\_CANCEL request
commit 31efee60f489c759c341454d755a9fd13de8c03d upstream.
When a call goes out, the signing code adjusts the sequence number
upward by two to account for the request and the response. An NT\_CANCEL
however doesn't get a response of its own, it just hurries the server
along to get it to respond to the original request more quickly.
Therefore, we must adjust the sequence number back down by one after
signing a NT\_CANCEL request.
Reported-by: Tim Perry
Signed-off-by: Jeff Layton
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 7696b6d4dcfbc9fb8bd4c91774424197a4b2cc39
Author: Jeff Layton
Date: Thu Dec 27 07:28:55 2012 -0500
cifs: move check for NULL socket into smb\_send\_rqst
commit ea702b80e0bbb2448e201472127288beb82ca2fe upstream.
Cai reported this oops:
[90701.616664] BUG: unable to handle kernel NULL pointer dereference at 0000000000000028
[90701.625438] IP: [] kernel\_setsockopt+0x2e/0x60
[90701.632167] PGD fea319067 PUD 103fda4067 PMD 0
[90701.637255] Oops: 0000 [#1] SMP
[90701.640878] Modules linked in: des\_generic md4 nls\_utf8 cifs dns\_resolver binfmt\_misc tun sg igb iTCO\_wdt iTCO\_vendor\_support lpc\_ich pcspkr i2c\_i801 i2c\_core i7core\_edac edac\_core ioatdma dca mfd\_core coretemp kvm\_intel kvm crc32c\_intel microcode sr\_mod cdrom ata\_generic sd\_mod pata\_acpi crc\_t10dif ata\_piix libata megaraid\_sas dm\_mirror dm\_region\_hash dm\_log dm\_mod
[90701.677655] CPU 10
[90701.679808] Pid: 9627, comm: ls Tainted: G W 3.7.1+ #10 QCI QSSC-S4R/QSSC-S4R
[90701.688950] RIP: 0010:[] [] kernel\_setsockopt+0x2e/0x60
[90701.698383] RSP: 0018:ffff88177b431bb8 EFLAGS: 00010206
[90701.704309] RAX: ffff88177b431fd8 RBX: 00007ffffffff000 RCX: ffff88177b431bec
[90701.712271] RDX: 0000000000000003 RSI: 0000000000000006 RDI: 0000000000000000
[90701.720223] RBP: ffff88177b431bc8 R08: 0000000000000004 R09: 0000000000000000
[90701.728185] R10: 0000000000000001 R11: 0000000000000000 R12: 0000000000000001
[90701.736147] R13: ffff88184ef92000 R14: 0000000000000023 R15: ffff88177b431c88
[90701.744109] FS: 00007fd56a1a47c0(0000) GS:ffff88105fc40000(0000) knlGS:0000000000000000
[90701.753137] CS: 0010 DS: 0000 ES: 0000 CR0: 000000008005003b
[90701.759550] CR2: 0000000000000028 CR3: 000000104f15f000 CR4: 00000000000007e0
[90701.767512] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[90701.775465] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
[90701.783428] Process ls (pid: 9627, threadinfo ffff88177b430000, task ffff88185ca4cb60)
[90701.792261] Stack:
[90701.794505] 0000000000000023 ffff88177b431c50 ffff88177b431c38 ffffffffa014fcb1
[90701.802809] ffff88184ef921bc 0000000000000000 00000001ffffffff ffff88184ef921c0
[90701.811123] ffff88177b431c08 ffffffff815ca3d9 ffff88177b431c18 ffff880857758000
[90701.819433] Call Trace:
[90701.822183] [] smb\_send\_rqst+0x71/0x1f0 [cifs]
[90701.828991] [] ? schedule+0x29/0x70
[90701.834736] [] smb\_sendv+0x3d/0x40 [cifs]
[90701.841062] [] smb\_send+0x26/0x30 [cifs]
[90701.847291] [] send\_nt\_cancel+0x6f/0xd0 [cifs]
[90701.854102] [] SendReceive+0x18e/0x360 [cifs]
[90701.860814] [] CIFSFindFirst+0x1a8/0x3f0 [cifs]
[90701.867724] [] ? build\_path\_from\_dentry+0xf1/0x260 [cifs]
[90701.875601] [] ? build\_path\_from\_dentry+0xf1/0x260 [cifs]
[90701.883477] [] cifs\_query\_dir\_first+0x26/0x30 [cifs]
[90701.890869] [] initiate\_cifs\_search+0xed/0x250 [cifs]
[90701.898354] [] ? fillonedir+0x100/0x100
[90701.904486] [] cifs\_readdir+0x45b/0x8f0 [cifs]
[90701.911288] [] ? fillonedir+0x100/0x100
[90701.917410] [] ? fillonedir+0x100/0x100
[90701.923533] [] ? fillonedir+0x100/0x100
[90701.929657] [] vfs\_readdir+0xb8/0xe0
[90701.935490] [] sys\_getdents+0x8f/0x110
[90701.941521] [] system\_call\_fastpath+0x16/0x1b
[90701.948222] Code: 66 90 55 65 48 8b 04 25 f0 c6 00 00 48 89 e5 53 48 83 ec 08 83 fe 01 48 8b 98 48 e0 ff ff 48 c7 80 48 e0 ff ff ff ff ff ff 74 22 <48> 8b 47 28 ff 50 68 65 48 8b 14 25 f0 c6 00 00 48 89 9a 48 e0
[90701.970313] RIP [] kernel\_setsockopt+0x2e/0x60
[90701.977125] RSP
[90701.981018] CR2: 0000000000000028
[90701.984809] ---[ end trace 24bd602971110a43 ]---
This is likely due to a race vs. a reconnection event.
The current code checks for a NULL socket in smb\_send\_kvec, but that's
too late. By the time that check is done, the socket will already have
been passed to kernel\_setsockopt. Move the check into smb\_send\_rqst, so
that it's checked earlier.
In truth, this is a bit of a half-assed fix. The -ENOTSOCK error
return here looks like it could bubble back up to userspace. The locking
rules around the ssocket pointer are really unclear as well. There are
cases where the ssocket pointer is changed without holding the srv\_mutex,
but I'm not clear whether there's a potential race here yet or not.
This code seems like it could benefit from some fundamental re-think of
how the socket handling should behave. Until then though, this patch
should at least fix the above oops in most cases.
Reported-and-Tested-by: CAI Qian
Signed-off-by: Jeff Layton
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit ff68026c74ea60403004010c4cc1f81b1f4faa2a
Author: Jan Kara
Date: Wed Dec 5 14:40:14 2012 +0100
fs: Fix imbalance in freeze protection in mark\_files\_ro()
commit 72651cac884b1e285fa8e8314b10e9f1b8458802 upstream.
File descriptors (even those for writing) do not hold freeze protection.
Thus mark\_files\_ro() must call \_\_mnt\_drop\_write() to only drop protection
against remount read-only. Calling mnt\_drop\_write\_file() as we do now
results in:
[ BUG: bad unlock balance detected! ]
3.7.0-rc6-00028-g88e75b6 #101 Not tainted
-------------------------------------
kworker/1:2/79 is trying to release lock (sb\_writers) at:
[] mnt\_drop\_write+0x24/0x30
but there are no more locks to release!
Reported-by: Zdenek Kabelac
Signed-off-by: Jan Kara
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit bbe614b3f9a1cab9cdd88ecdd9415bd3dd04efd3
Author: Will Deacon
Date: Wed Dec 19 15:01:08 2012 +0100
ARM: 7606/1: cache: flush to LoUU instead of LoUIS on uniprocessor CPUs
commit d056a699dd3d9366dd3b4d9996e7848209199cda upstream.
flush\_cache\_louis flushes the D-side caches to the point of unification
inner-shareable. On uniprocessor CPUs, this is defined as zero and
therefore no flushing will take place. Rather than invent a new interface
for UP systems, instead use our SMP\_ON\_UP patching code to read the
LoUU from the CLIDR instead.
Cc: Lorenzo Pieralisi
Tested-by: Guennadi Liakhovetski
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 4faefc4ea2f866e9d924f47eacea45a114b8d0d1
Author: Will Deacon
Date: Wed Dec 19 15:01:50 2012 +0100
ARM: 7607/1: realview: fix private peripheral memory base for EB rev. B boards
commit e6ee4b2b57a8e0d8e551031173de080b338d3969 upstream.
Commit 34ae6c96a6a7 ("ARM: 7298/1: realview: fix mapping of MPCore
private memory region") accidentally broke the definition for the base
address of the private peripheral region on revision B Realview-EB
boards.
This patch uses the correct address for REALVIEW\_EB11MP\_PRIV\_MEM\_BASE.
Acked-by: Marc Zyngier
Tested-by: Florian Fainelli
Signed-off-by: Will Deacon
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit f41983f43cfa6643ff0d1f1c310d4d3eb3412770
Author: Al Viro
Date: Sun Dec 16 00:25:57 2012 +0000
ARM: missing ->mmap\_sem around find\_vma() in swp\_emulate.c
commit 7bf9b7bef881aac820bf1f2e9951a17b09bd7e04 upstream.
find\_vma() is \*not\* safe when somebody else is removing vmas. Not just
the return value might get bogus just as you are getting it (this instance
doesn't try to dereference the resulting vma), the search itself can get
buggered in rather spectacular ways. IOW, ->mmap\_sem really, really is
not optional here.
Signed-off-by: Al Viro
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 3f6c363d7bf291a026e4c3d2abe1d0767b0468e1
Author: Will Deacon
Date: Tue Sep 18 19:18:35 2012 +0100
ARM: mm: use pteval\_t to represent page protection values
commit 864aa04cd02979c2c755cb28b5f4fe56039171c0 upstream.
When updating the page protection map after calculating the user\_pgprot
value, the base protection map is temporarily stored in an unsigned long
type, causing truncation of the protection bits when LPAE is enabled.
This effectively means that calls to mprotect() will corrupt the upper
page attributes, clearing the XN bit unconditionally.
This patch uses pteval\_t to store the intermediate protection values,
preserving the upper bits for 64-bit descriptors.
Acked-by: Nicolas Pitre
Acked-by: Catalin Marinas
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit 7a13eba369913bfd2f363b722d2831db5c3669df
Author: Al Viro
Date: Wed Dec 5 11:48:56 2012 +0000
arm64: compat for clock\_adjtime(2) is miswired
commit 18a80376ddb0bdc466995ff58c844d6fd0a65e61 upstream.
struct timex is different on arm and arm64; adjtimex(2) takes care to
convert, clock\_adjtime(2) doesn't...
Signed-off-by: Al Viro
Acked-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit f8b723cc9f1a9eec83c8527d67eedc6249b7fb66
Author: Dave Chinner
Date: Wed Nov 28 13:01:02 2012 +1100
xfs: fix stray dquot unlock when reclaiming dquots
commit b870553cdecb26d5291af09602352b763e323df2 upstream.
When we fail to get a dquot lock during reclaim, we jump to an error
handler that unlocks the dquot. This is wrong as we didn't lock the
dquot, and unlocking it means who-ever is holding the lock has had
it silently taken away, and hence it results in a lock imbalance.
Found by inspection while modifying the code for the numa-lru
patchset. This fixes a random hang I've been seeing on xfstest 232
for the past several months.
Signed-off-by: Dave Chinner
Reviewed-by: Christoph Hellwig
Signed-off-by: Ben Myers
Signed-off-by: Greg Kroah-Hartman
commit 82251473514fde36ce8dc0167f41eaf7ef6a4cb9
Author: Dave Chinner
Date: Wed Nov 28 13:01:00 2012 +1100
xfs: fix direct IO nested transaction deadlock.
commit 437a255aa23766666aec78af63be4c253faa8d57 upstream.
The direct IO path can do a nested transaction reservation when
writing past the EOF. The first transaction is the append
transaction for setting the filesize at IO completion, but we can
also need a transaction for allocation of blocks. If the log is low
on space due to reservations and small log, the append transaction
can be granted after wating for space as the only active transaction
in the system. This then attempts a reservation for an allocation,
which there isn't space in the log for, and the reservation sleeps.
The result is that there is nothing left in the system to wake up
all the processes waiting for log space to come free.
The stack trace that shows this deadlock is relatively innocuous:
xlog\_grant\_head\_wait
xlog\_grant\_head\_check
xfs\_log\_reserve
xfs\_trans\_reserve
xfs\_iomap\_write\_direct
\_\_xfs\_get\_blocks
xfs\_get\_blocks\_direct
do\_blockdev\_direct\_IO
\_\_blockdev\_direct\_IO
xfs\_vm\_direct\_IO
generic\_file\_direct\_write
xfs\_file\_dio\_aio\_writ
xfs\_file\_aio\_write
do\_sync\_write
vfs\_write
This was discovered on a filesystem with a log of only 10MB, and a
log stripe unit of 256k whih increased the base reservations by
512k. Hence a allocation transaction requires 1.2MB of log space to
be available instead of only 260k, and so greatly increased the
chance that there wouldn't be enough log space available for the
nested transaction to succeed. The key to reproducing it is this
mkfs command:
mkfs.xfs -f -d agcount=16,su=256k,sw=12 -l su=256k,size=2560b $SCRATCH\_DEV
The test case was a 1000 fsstress processes running with random
freeze and unfreezes every few seconds. Thanks to Eryu Guan
(eguan@redhat.com) for writing the test that found this on a system
with a somewhat unique default configuration....
Signed-off-by: Dave Chinner
Reviewed-by: Christoph Hellwig
Reviewed-by: Andrew Dahl
Signed-off-by: Ben Myers
Signed-off-by: Greg Kroah-Hartman
commit 5a88b8abb0a0f7b4611daaf5305c6cc08cdf5d2b
Author: Oleg Nesterov
Date: Sat Jan 5 19:13:13 2013 +0100
signals: sys\_ssetmask() uses uninitialized newmask
commit 5ba53ff648e785445a32ba39112ed07e4cf588d0 upstream.
Commit 77097ae503b1 ("most of set\_current\_blocked() callers want
SIGKILL/SIGSTOP removed from set") removed the initialization of newmask
by accident, causing ltp to complain like this:
ssetmask01 1 TFAIL : sgetmask() failed: TEST\_ERRNO=???(0): Success
Restore the proper initialization.
Reported-and-tested-by: CAI Qian
Signed-off-by: Oleg Nesterov
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit bcfab4b51440df476ed319f44c21043ceb317198
Author: Roland Dreier
Date: Fri Jan 4 15:35:50 2013 -0800
printk: fix incorrect length from print\_time() when seconds > 99999
commit 35dac27cedd14c3b6fcd4ba7bc3c31738cfd1831 upstream.
print\_prefix() passes a NULL buf to print\_time() to get the length of
the time prefix; when printk times are enabled, the current code just
returns the constant 15, which matches the format "[%5lu.%06lu] " used
to print the time value. However, this is obviously incorrect when the
whole seconds part of the time gets beyond 5 digits (100000 seconds is a
bit more than a day of uptime).
The simple fix is to use snprintf(NULL, 0, ...) to calculate the actual
length of the time prefix. This could be micro-optimized but it seems
better to have simpler, more readable code here.
The bug leads to the syslog system call miscomputing which messages fit
into the userspace buffer. If there are enough messages to fill
log\_buf\_len and some have a timestamp >= 100000, dmesg may fail with:
# dmesg
klogctl: Bad address
When this happens, strace shows that the failure is indeed EFAULT due to
the kernel mistakenly accessing past the end of dmesg's buffer, since
dmesg asks the kernel how big a buffer it needs, allocates a bit more,
and then gets an error when it asks the kernel to fill it:
syslog(0xa, 0, 0) = 1048576
mmap(NULL, 1052672, PROT\_READ|PROT\_WRITE, MAP\_PRIVATE|MAP\_ANONYMOUS, -1, 0) = 0x7fa4d25d2000
syslog(0x3, 0x7fa4d25d2010, 0x100008) = -1 EFAULT (Bad address)
As far as I can see, the bug has been there as long as print\_time(),
which comes from commit 084681d14e42 ("printk: flush continuation lines
immediately to console") in 3.5-rc5.
Signed-off-by: Roland Dreier
Signed-off-by: Greg Kroah-Hartman
Cc: Joe Perches
Cc: Sylvain Munaut
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 191199ac78d4707fbf1e841224d62e2672bd6902
Author: Eric Dumazet
Date: Sun Jan 6 18:21:49 2013 +0000
tcp: fix MSG\_SENDPAGE\_NOTLAST logic
[ Upstream commit ae62ca7b03217be5e74759dc6d7698c95df498b3 ]
commit 35f9c09fe9c72e (tcp: tcp\_sendpages() should call tcp\_push() once)
added an internal flag : MSG\_SENDPAGE\_NOTLAST meant to be set on all
frags but the last one for a splice() call.
The condition used to set the flag in pipe\_to\_sendpage() relied on
splice() user passing the exact number of bytes present in the pipe,
or a smaller one.
But some programs pass an arbitrary high value, and the test fails.
The effect of this bug is a lack of tcp\_push() at the end of a
splice(pipe -> socket) call, and possibly very slow or erratic TCP
sessions.
We should both test sd->total\_len and fact that another fragment
is in the pipe (pipe->nrbufs > 1)
Many thanks to Willy for providing very clear bug report, bisection
and test programs.
Reported-by: Willy Tarreau
Bisected-by: Willy Tarreau
Tested-by: Willy Tarreau
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b5810b8da2248adc73a1bf3def752d99beb87cca
Author: Daniel Borkmann
Date: Sat Dec 15 10:12:43 2012 +0000
sctp: jsctp\_sf\_eat\_sack: fix jprobes function signature mismatch
[ Upstream commit 4cb9d6eaf85ecdd266a9a5c6d825c56ca9eefc14 ]
Commit 24cb81a6a (sctp: Push struct net down into all of the
state machine functions) introduced the net structure into all
state machine functions, but jsctp\_sf\_eat\_sack was not updated,
hence when SCTP association probing is enabled in the kernel,
any simple SCTP client/server program from userspace will panic
the kernel.
Cc: Vlad Yasevich
Signed-off-by: Daniel Borkmann
Acked-by: Vlad Yasevich
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 316899aceab5510d296f9437e410401409e9ce19
Author: Stefan Hasko
Date: Fri Dec 21 15:04:59 2012 +0000
net: sched: integer overflow fix
[ Upstream commit d2fe85da52e89b8012ffad010ef352a964725d5f ]
Fixed integer overflow in function htb\_dequeue
Signed-off-by: Stefan Hasko
Acked-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ae51878d61c4b39eae37d1bf29032e185b8e6501
Author: Alexander Aring
Date: Wed Jan 2 01:01:10 2013 +0000
mac802154: fix NOHZ local\_softirq\_pending 08 warning
[ Upstream commit 5ff3fec6d3fc848753c2fa30b18607358f89a202 ]
When using nanosleep() in an userspace application we get a
ratelimit warning
NOHZ: local\_softirq\_pending 08
for 10 times.
This patch replaces netif\_rx() with netif\_rx\_ni() which has
to be used from process/softirq context.
The process/softirq context will be called from fakelb driver.
See linux-kernel commit 481a819 for similar fix.
Signed-off-by: Alexander Aring
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 29a21388c86ffa0d18018a7ddf49aa129588a339
Author: Duan Jiong
Date: Fri Dec 14 02:59:59 2012 +0000
ipv6: Change skb->data before using icmpv6\_notify() to propagate redirect
[ Upstream commit 093d04d42fa094f6740bb188f0ad0c215ff61e2c ]
In function ndisc\_redirect\_rcv(), the skb->data points to the transport
header, but function icmpv6\_notify() need the skb->data points to the
inner IP packet. So before using icmpv6\_notify() to propagate redirect,
change skb->data to point the inner IP packet that triggered the sending
of the Redirect, and introduce struct rd\_msg to make it easy.
Signed-off-by: Duan Jiong
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9ce4b845ed059b9104f3bb204db6306e52b25d1b
Author: Christoph Paasch
Date: Fri Dec 14 04:07:58 2012 +0000
inet: Fix kmemleak in tcp\_v4/6\_syn\_recv\_sock and dccp\_v4/6\_request\_recv\_sock
[ Upstream commit e337e24d6624e74a558aa69071e112a65f7b5758 ]
If in either of the above functions inet\_csk\_route\_child\_sock() or
\_\_inet\_inherit\_port() fails, the newsk will not be freed:
unreferenced object 0xffff88022e8a92c0 (size 1592):
comm "softirq", pid 0, jiffies 4294946244 (age 726.160s)
hex dump (first 32 bytes):
0a 01 01 01 0a 01 01 02 00 00 00 00 a7 cc 16 00 ................
02 00 03 01 00 00 00 00 00 00 00 00 00 00 00 00 ................
backtrace:
[] kmemleak\_alloc+0x21/0x3e
[] kmem\_cache\_alloc+0xb5/0xc5
[] sk\_prot\_alloc.isra.53+0x2b/0xcd
[] sk\_clone\_lock+0x16/0x21e
[] inet\_csk\_clone\_lock+0x10/0x7b
[] tcp\_create\_openreq\_child+0x21/0x481
[] tcp\_v4\_syn\_recv\_sock+0x3a/0x23b
[] tcp\_check\_req+0x29f/0x416
[] tcp\_v4\_do\_rcv+0x161/0x2bc
[] tcp\_v4\_rcv+0x6c9/0x701
[] ip\_local\_deliver\_finish+0x70/0xc4
[] ip\_local\_deliver+0x4e/0x7f
[] ip\_rcv\_finish+0x1fc/0x233
[] ip\_rcv+0x217/0x267
[] \_\_netif\_receive\_skb+0x49e/0x553
[] netif\_receive\_skb+0x50/0x82
This happens, because sk\_clone\_lock initializes sk\_refcnt to 2, and thus
a single sock\_put() is not enough to free the memory. Additionally, things
like xfrm, memcg, cookie\_values,... may have been initialized.
We have to free them properly.
This is fixed by forcing a call to tcp\_done(), ending up in
inet\_csk\_destroy\_sock, doing the final sock\_put(). tcp\_done() is necessary,
because it ends up doing all the cleanup on xfrm, memcg, cookie\_values,
xfrm,...
Before calling tcp\_done, we have to set the socket to SOCK\_DEAD, to
force it entering inet\_csk\_destroy\_sock. To avoid the warning in
inet\_csk\_destroy\_sock, inet\_num has to be set to 0.
As inet\_csk\_destroy\_sock does a dec on orphan\_count, we first have to
increase it.
Calling tcp\_done() allows us to remove the calls to
tcp\_clear\_xmit\_timer() and tcp\_cleanup\_congestion\_control().
A similar approach is taken for dccp by calling dccp\_done().
This is in the kernel since 093d282321 (tproxy: fix hash locking issue
when using port redirection in \_\_inet\_inherit\_port()), thus since
version >= 2.6.37.
Signed-off-by: Christoph Paasch
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6558b40d737d831bad3214a40eac72b226190673
Author: Akinobu Mita
Date: Wed Dec 26 02:32:10 2012 +0000
batman-adv: fix random jitter calculation
[ Upstream commit 143cdd8f33909ff5a153e3f02048738c5964ba26 ]
batadv\_iv\_ogm\_emit\_send\_time() attempts to calculates a random integer
in the range of 'orig\_interval +- BATADV\_JITTER' by the below lines.
msecs = atomic\_read(&bat\_priv->orig\_interval) - BATADV\_JITTER;
msecs += (random32() % 2 \* BATADV\_JITTER);
But it actually gets 'orig\_interval' or 'orig\_interval - BATADV\_JITTER'
because '%' and '\*' have same precedence and associativity is
left-to-right.
This adds the parentheses at the appropriate position so that it matches
original intension.
Signed-off-by: Akinobu Mita
Acked-by: Antonio Quartulli
Cc: Marek Lindner
Cc: Simon Wunderlich
Cc: Antonio Quartulli
Cc: b.a.t.m.a.n@lists.open-mesh.org
Cc: "David S. Miller"
Cc: netdev@vger.kernel.org
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d7371e1b63cf51b89415381bff47b7312cdcef77
Author: David S. Miller
Date: Wed Dec 19 15:44:31 2012 -0800
sparc64: Set CRYPTO\_TFM\_REQ\_MAY\_SLEEP consistently in CAMELLIA code.
[ Upstream commit 62ba63dc892cf836ecb9ce4fdb7644d45c95070b ]
We use the FPU and therefore cannot sleep during the crypto
loops.
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7716902f6503082b33b7dc79a09467ed110cc95b
Author: David S. Miller
Date: Wed Dec 19 15:43:38 2012 -0800
sparc64: Set CRYPTO\_TFM\_REQ\_MAY\_SLEEP consistently in DES code.
[ Upstream commit b3a37947074fa0a488d6c7ede58125b2278ab4e8 ]
We use the FPU and therefore cannot sleep during the crypto
loops.
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a74864cb91b49bc6c54f1358dd07a12135b510f7
Author: David S. Miller
Date: Wed Dec 19 15:30:07 2012 -0800
sparc64: Fix ECB looping constructs in AES code.
[ Upstream commit ce6889515d5d481a5bd8ce5913dfed18f08310ea ]
Things works better when you increment the source buffer pointer
properly.
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fe4ddcf94392f83f27b690f32cdd162ccd0f7eb3
Author: David S. Miller
Date: Wed Dec 19 15:22:03 2012 -0800
sparc64: Set CRYPTO\_TFM\_REQ\_MAY\_SLEEP consistently in AES code.
[ Upstream commit b35d282ef7345320b594d48d8d70caedfa962a01 ]
We use the FPU and therefore cannot sleep during the crypto
loops.
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6d2446753d8fa56e2dbc7147965a063b37bbdf56
Author: David S. Miller
Date: Wed Dec 19 15:20:23 2012 -0800
sparc64: Fix AES ctr mode block size.
[ Upstream commit a8d97cef2168ffe5af1aeed6bf6cdc3ce53f3d0b ]
Like the generic versions, we need to support a block size
of '1' for CTR mode AES.
This was discovered thanks to all of the new test cases added by
Jussi Kivilinna.
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0041cdc62ea0350c4be9b7d7dfb03d89310c8765
Author: David S. Miller
Date: Wed Dec 19 15:19:11 2012 -0800
sparc64: Fix unrolled AES 256-bit key loops.
[ Upstream commit 9f28ffc03e93343ac04874fda9edb7affea45165 ]
The basic scheme of the block mode assembler is that we start by
enabling the FPU, loading the key into the floating point registers,
then iterate calling the encrypt/decrypt routine for each block.
For the 256-bit key cases, we run short on registers in the unrolled
loops.
So the {ENCRYPT,DECRYPT}\_256\_2() macros reload the key registers that
get clobbered.
The unrolled macros, {ENCRYPT,DECRYPT}\_256(), are not mindful of this.
So if we have a mix of multi-block and single-block calls, the
single-block unrolled 256-bit encrypt/decrypt can run with some
of the key registers clobbered.
Handle this by always explicitly loading those registers before using
the non-unrolled 256-bit macro.
This was discovered thanks to all of the new test cases added by
Jussi Kivilinna.
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 98a4f4ed3db015aa4755d1f6d39c6a03bc29c5d5
Author: Dave Kleikamp
Date: Mon Dec 17 11:52:47 2012 -0600
sparc: huge\_ptep\_set\_\* functions need to call set\_huge\_pte\_at()
[ Upstream commit 6cb9c3697585c47977c42c5cc1b9fc49247ac530 ]
Modifying the huge pte's requires that all the underlying pte's be
modified.
Version 2: added missing flush\_tlb\_page()
Signed-off-by: Dave Kleikamp
Cc: "David S. Miller"
Cc: sparclinux@vger.kernel.org
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a288c9a403bc7d8b9fb6d97183a691aac793337b
Author: Tejun Heo
Date: Tue Oct 16 15:03:14 2012 -0700
freezer: add missing mb's to freezer\_count() and freezer\_should\_skip()
commit dd67d32dbc5de299d70cc9e10c6c1e29ffa56b92 upstream.
A task is considered frozen enough between freezer\_do\_not\_count() and
freezer\_count() and freezers use freezer\_should\_skip() to test this
condition. This supposedly works because freezer\_count() always calls
try\_to\_freezer() after clearing %PF\_FREEZER\_SKIP.
However, there currently is nothing which guarantees that
freezer\_count() sees %true freezing() after clearing %PF\_FREEZER\_SKIP
when freezing is in progress, and vice-versa. A task can escape the
freezing condition in effect by freezer\_count() seeing !freezing() and
freezer\_should\_skip() seeing %PF\_FREEZER\_SKIP.
This patch adds smp\_mb()'s to freezer\_count() and
freezer\_should\_skip() such that either %true freezing() is visible to
freezer\_count() or !PF\_FREEZER\_SKIP is visible to
freezer\_should\_skip().
Signed-off-by: Tejun Heo
Cc: Oleg Nesterov
Cc: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit e1593cb019046a8e29442a3376d8b30230e6a15d
Author: Steve French
Date: Tue Dec 4 16:56:37 2012 -0600
SMB3 mounts fail with access denied to some servers
commit 52c0f4ad8ed462d81f1d37f56a74a71dc0c9bf0f upstream.
We were checking incorrectly if signatures were required to be sent,
so were always sending signatures after the initial session establishment.
For SMB3 mounts (vers=3.0) this was a problem because we were putting
SMB2 signatures in SMB3 requests which would cause access denied
on mount (the tree connection would fail).
This might also be worth considering for stable (for 3.7), as the
error message on mount (access denied) is confusing to users and
there is no workaround if the server is configured to only
support smb3.0. I am ok either way.
Signed-off-by: Steve French
Reviewed-by: Jeff Layton
Signed-off-by: Greg Kroah-Hartman
commit 4fc832846b7e2afb0775be4521bcd801c60eba1f
Author: Andy Gross
Date: Tue Oct 16 00:17:40 2012 -0500
staging: drm/omap: Fix include error during make
commit b9ed9f0ecf1b5675c64d069e9b53effe276b6f01 upstream.
Fixed include error for drm\_mode.h
Signed-off-by: Andy Gross
Signed-off-by: Greg Kroah-Hartman
commit 61001c0a21fef142d5a462db15810afbcd95b416
Author: Jianguo Wu
Date: Tue Dec 18 14:23:19 2012 -0800
mm/hugetlb: create hugetlb cgroup file in hugetlb\_init
commit 7179e7bf4592ac5a7b30257a7df6259ee81e51da upstream.
Build kernel with CONFIG\_HUGETLBFS=y,CONFIG\_HUGETLB\_PAGE=y and
CONFIG\_CGROUP\_HUGETLB=y, then specify hugepagesz=xx boot option, system
will fail to boot.
This failure is caused by following code path:
setup\_hugepagesz
hugetlb\_add\_hstate
hugetlb\_cgroup\_file\_init
cgroup\_add\_cftypes
kzalloc <--slab is \*not available\* yet
For this path, slab is not available yet, so memory allocated will be
failed, and cause WARN\_ON() in hugetlb\_cgroup\_file\_init().
So I move hugetlb\_cgroup\_file\_init() into hugetlb\_init().
[akpm@linux-foundation.org: tweak coding-style, remove pointless \_\_init on inlined function]
[akpm@linux-foundation.org: fix warning]
Signed-off-by: Jianguo Wu
Signed-off-by: Jiang Liu
Reviewed-by: Aneesh Kumar K.V
Acked-by: Michal Hocko
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5778e9e966423d834a01de616f29c6bf834c0d8a
Author: Gao feng
Date: Thu Dec 6 14:38:57 2012 +0800
cgroup\_rm\_file: don't delete the uncreated files
commit f33fddc2b9573d8359f1007d4bbe5cd587a0c093 upstream.
in cgroup\_add\_file,when creating files for cgroup,
some of creation may be skipped. So we need to avoid
deleting these uncreated files in cgroup\_rm\_file,
otherwise the warning msg will be triggered.
"cgroup\_addrm\_files: failed to remove memory\_pressure\_enabled, err=-2"
Signed-off-by: Gao feng
Acked-by: Li Zefan
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit d36994375807d655612b0a3f3967e8039bb41100
Author: Tejun Heo
Date: Mon Nov 19 08:13:35 2012 -0800
cgroup: remove incorrect dget/dput() pair in cgroup\_create\_dir()
commit 175431635ec09b1d1bba04979b006b99e8305a83 upstream.
cgroup\_create\_dir() does weird dancing with dentry refcnt. On
success, it gets and then puts it achieving nothing. On failure, it
puts but there isn't no matching get anywhere leading to the following
oops if cgroup\_create\_file() fails for whatever reason.
------------[ cut here ]------------
kernel BUG at /work/os/work/fs/dcache.c:552!
invalid opcode: 0000 [#1] PREEMPT SMP DEBUG\_PAGEALLOC
Modules linked in:
CPU 2
Pid: 697, comm: mkdir Not tainted 3.7.0-rc4-work+ #3 Bochs Bochs
RIP: 0010:[] [] dput+0x1dc/0x1e0
RSP: 0018:ffff88001a3ebef8 EFLAGS: 00010246
RAX: 0000000000000000 RBX: ffff88000e5b1ef8 RCX: 0000000000000403
RDX: 0000000000000303 RSI: 2000000000000000 RDI: ffff88000e5b1f58
RBP: ffff88001a3ebf18 R08: ffffffff82c76960 R09: 0000000000000001
R10: ffff880015022080 R11: ffd9bed70f48a041 R12: 00000000ffffffea
R13: 0000000000000001 R14: ffff88000e5b1f58 R15: 00007fff57656d60
FS: 00007ff05fcb3800(0000) GS:ffff88001fd00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00000000004046f0 CR3: 000000001315f000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
Process mkdir (pid: 697, threadinfo ffff88001a3ea000, task ffff880015022080)
Stack:
ffff88001a3ebf48 00000000ffffffea 0000000000000001 0000000000000000
ffff88001a3ebf38 ffffffff811cc889 0000000000000001 ffff88000e5b1ef8
ffff88001a3ebf68 ffffffff811d1fc9 ffff8800198d7f18 ffff880019106ef8
Call Trace:
[] done\_path\_create+0x19/0x50
[] sys\_mkdirat+0x59/0x80
[] sys\_mkdir+0x19/0x20
[] system\_call\_fastpath+0x16/0x1b
Code: 00 48 8d 90 18 01 00 00 48 89 93 c0 00 00 00 4c 89 a0 18 01 00 00 48 8b 83 a0 00 00 00 83 80 28 01 00 00 01 e8 e6 6f a0 00 eb 92 <0f> 0b 66 90 0f 1f 44 00 00 55 48 89 e5 41 57 41 56 49 89 fe 41
RIP [] dput+0x1dc/0x1e0
RSP
---[ end trace 1277bcfd9561ddb0 ]---
Fix it by dropping the unnecessary dget/dput() pair.
Signed-off-by: Tejun Heo
Acked-by: Li Zefan
Signed-off-by: Greg Kroah-Hartman
commit 838a4f8bb1a039ee4ea6de544624d8fd620bf455
Author: Tejun Heo
Date: Tue Oct 16 15:03:14 2012 -0700
cgroup: cgroup\_subsys->fork() should be called after the task is added to css\_set
commit 5edee61edeaaebafe584f8fb7074c1ef4658596b upstream.
cgroup core has a bug which violates a basic rule about event
notifications - when a new entity needs to be added, you add that to
the notification list first and then make the new entity conform to
the current state. If done in the reverse order, an event happening
inbetween will be lost.
cgroup\_subsys->fork() is invoked way before the new task is added to
the css\_set. Currently, cgroup\_freezer is the only user of ->fork()
and uses it to make new tasks conform to the current state of the
freezer. If FROZEN state is requested while fork is in progress
between cgroup\_fork\_callbacks() and cgroup\_post\_fork(), the child
could escape freezing - the cgroup isn't frozen when ->fork() is
called and the freezer couldn't see the new task on the css\_set.
This patch moves cgroup\_subsys->fork() invocation to
cgroup\_post\_fork() after the new task is added to the css\_set.
cgroup\_fork\_callbacks() is removed.
Because now a task may be migrated during cgroup\_subsys->fork(),
freezer\_fork() is updated so that it adheres to the usual RCU locking
and the rather pointless comment on why locking can be different there
is removed (if it doesn't make anything simpler, why even bother?).
Signed-off-by: Tejun Heo
Cc: Oleg Nesterov
Cc: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 27f0a83c49a639749f9e26c5af4b70164922f304
Author: Russell Webb
Date: Fri Nov 9 13:58:49 2012 -0800
xhci: Add Lynx Point LP to list of Intel switchable hosts
commit bb1e5dd7113d2fd178d3af9aca8f480ae0468edf upstream.
Like Lynx Point, Lynx Point LP is also switchable. See
1c12443ab8eba71a658fae4572147e56d1f84f66 for more details.
This patch should be backported to stable kernels as old as 3.0,
that contain commit 69e848c2090aebba5698a1620604c7dccb448684
"Intel xhci: Support EHCI/xHCI port switching."
Signed-off-by: Russell Webb
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit 702b2581032ced74efff3f908a3c3133947198fc
Author: Alexis R. Cortes
Date: Thu Nov 8 16:59:27 2012 -0600
usb: host: xhci: Stricter conditional for Z1 system models for Compliance Mode Patch
commit b0e4e606ff6ff26da0f60826e75577b56ba4e463 upstream.
This minor patch creates a more stricter conditional for the Z1 sytems for applying
the Compliance Mode Patch, this to avoid the quirk to be applied to models that
contain a "Z1" in their dmi product string but are different from Z1 systems.
This patch should be backported to stable kernels as old as 3.2, that
contain the commit 71c731a296f1b08a3724bd1b514b64f1bda87a23 "usb: host:
xhci: Fix Compliance Mode on SN65LVPE502CP Hardware"
Signed-off-by: Alexis R. Cortes
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit d0abdff42cb550ae036f9ac3aa168ea7c867f464
Author: Alan Stern
Date: Wed Nov 7 10:31:30 2012 -0500
USB: fix endpoint-disabling for failed config changes
commit 36caff5d795429c572443894e8789c2150dd796b upstream.
This patch (as1631) fixes a bug that shows up when a config change
fails for a device under an xHCI controller. The controller needs to
be told to disable the endpoints that have been enabled for the new
config. The existing code does this, but before storing the
information about which endpoints were enabled! As a result, any
second attempt to install the new config is doomed to fail because
xhci-hcd will refuse to enable an endpoint that is already enabled.
The patch optimistically initializes the new endpoints' device
structures before asking the device to switch to the new config. If
the request fails then the endpoint information is already stored, so
we can use usb\_hcd\_alloc\_bandwidth() to disable the endpoints with no
trouble. The rest of the error path is slightly more complex now; we
have to disable the new interfaces and call put\_device() rather than
simply deallocating them.
Signed-off-by: Alan Stern
Reported-and-tested-by: Matthias Schniedermeyer
CC: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit 3f853877eee9cf53adcce9a52b25db56ff763941
Author: Julius Werner
Date: Thu Nov 1 12:47:59 2012 -0700
xhci: fix null-pointer dereference when destroying half-built segment rings
commit 68e5254adb88bede68285f11fb442a4d34fb550c upstream.
xhci\_alloc\_segments\_for\_ring() builds a list of xhci\_segments and links
the tail to head at the end (forming a ring). When it bails out for OOM
reasons half-way through, it tries to destroy its half-built list with
xhci\_free\_segments\_for\_ring(), even though it is not a ring yet. This
causes a null-pointer dereference upon hitting the last element.
Furthermore, one of its callers (xhci\_ring\_alloc()) mistakenly believes
the output parameters to be valid upon this kind of OOM failure, and
calls xhci\_ring\_free() on them. Since the (incomplete) list/ring should
already be destroyed in that case, this would lead to a use after free.
This patch fixes those issues by having xhci\_alloc\_segments\_for\_ring()
destroy its half-built, non-circular list manually and destroying the
invalid struct xhci\_ring in xhci\_ring\_alloc() with a plain kfree().
This patch should be backported to kernels as old as 2.6.31, that
contains the commit 0ebbab37422315a5d0cb29792271085bafdf38c0 "USB: xhci:
Ring allocation and initialization."
A separate patch will need to be developed for kernels older than 3.4,
since the ring allocation code was refactored in that kernel.
Signed-off-by: Julius Werner
Signed-off-by: Sarah Sharp
Signed-off-by: Greg Kroah-Hartman
commit 056f8bdd03a4a9e3237295696909cee11a3bb651
Author: Sarah Sharp
Date: Thu Oct 25 15:56:40 2012 -0700
xHCI: Fix TD Size calculation on 1.0 hosts.
commit 4525c0a10dff7ad3669763c28016c7daffc3900e upstream.
The xHCI 1.0 specification made a change to the TD Size field in TRBs.
The value is now the number of packets that remain to be sent in the TD,
not including this TRB. The TD Size value for the last TRB in a TD must
always be zero.
The xHCI function xhci\_v1\_0\_td\_remainder() attempts to calculate this,
but it gets it wrong. First, it erroneously reuses the old
xhci\_td\_remainder function, which will right shift the value by 10. The
xHCI 1.0 spec as of June 2011 says nothing about right shifting by 10.
Second, it does not set the TD size for the last TRB in a TD to zero.
Third, it uses roundup instead of DIV\_ROUND\_UP. The total packet count
is supposed to be the total number of bytes in this TD, divided by the
max packet size, rounded up. DIV\_ROUND\_UP is the right function to use
in that case.
With the old code, a TD on an endpoint with max packet size 1024 would
be set up like so:
TRB 1, TRB length = 600 bytes, TD size = 0
TRB 1, TRB length = 200 bytes, TD size = 0
TRB 1, TRB length = 100 bytes, TD size = 0
With the new code, the TD would be set up like this:
TRB 1, TRB length = 600 bytes, TD size = 1
TRB 1, TRB length = 200 bytes, TD size = 1
TRB 1, TRB length = 100 bytes, TD size = 0
This commit should be backported to kernels as old as 3.0, that contain
the commit 4da6e6f247a2601ab9f1e63424e4d944ed4124f3 "xhci 1.0: Update TD
size field format."
Signed-off-by: Sarah Sharp
Reported-by: Chintan Mehta
Reported-by: Shimmer Huang
Tested-by: Bhavik Kothari
Tested-by: Shimmer Huang
Signed-off-by: Greg Kroah-Hartman
commit 3f605c4b4424a7042bd3ba656af10e3a405d5663
Author: Sarah Sharp
Date: Thu Oct 25 13:44:12 2012 -0700
xhci: Fix conditional check in bandwidth calculation.
commit 392a07ae3316f2b90b39ce41e66d6f6b5c95de90 upstream.
David reports that at drivers/usb/host/xhci.c:2257:
static bool xhci\_is\_sync\_in\_ep(unsigned int ep\_type)
{
return (ep\_type == ISOC\_IN\_EP || ep\_type != INT\_IN\_EP);
}
The static analyser cppcheck says
[linux-3.7-rc2/drivers/usb/host/xhci.c:2257]: (style) Redundant condition: If ep\_type == 5, the comparison ep\_type != 7 is always true.
Maybe the original programmer intention was something like
static bool xhci\_is\_sync\_in\_ep(unsigned int ep\_type)
{
return (ep\_type == ISOC\_IN\_EP || ep\_type == INT\_IN\_EP);
}
Fix this.
This patch should be backported to stable kernels as old as 3.2, that
contain the commit 2b69899934c63b7b9432568584fb4c4a2924f40c "xhci: USB
3.0 BW checking."
Signed-off-by: Sarah Sharp
Reported-by: David Binderman
Signed-off-by: Greg Kroah-Hartman
commit 2a90b6baab1021ebbd7fdbb4b894ea315650d360
Author: Afzal Mohammed
Date: Tue Nov 6 20:47:24 2012 +0530
Revert "usb: musb: dsps: remove explicit NOP device creation"
commit d75542263a0b005876d112bbf9ffb23180cc3149 upstream.
This reverts commit d8c3ef256f88b7c6ecd673d03073b5645be9c5e4.
Above mentioned change was made along with multi usb phy change and
adding DT support for nop transceiver. But other two changes did not
make it to mainline. This in effect makes dsps musb wrapper unusable
even for single instance.
Hence revert it so that at least single instance can be supported.
Signed-off-by: Afzal Mohammed
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit d18d223714855658c62d17fdd8721bb00ad3cd69
Author: Sergei Shtylyov
Date: Mon Nov 5 22:26:40 2012 +0300
usb: musb: cppi\_dma: export cppi\_interrupt()
commit 8b416b0b25d5d8ddb3a91c1d20e1373582c50405 upstream.
Now that DaVinci glue layer can be modular, we must export cppi\_interrupt()
that it may call...
Signed-off-by: Sergei Shtylyov
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit fc34a7d5ad5dc9df67bbc9969824fb0949dcceb0
Author: Thomas Gleixner
Date: Sat Nov 3 11:52:09 2012 +0100
genirq: Always force thread affinity
commit 04aa530ec04f61875b99c12721162e2964e3318c upstream.
Sankara reported that the genirq core code fails to adjust the
affinity of an interrupt thread in several cases:
1) On request/setup\_irq() the call to setup\_affinity() happens before
the new action is registered, so the new thread is not notified.
2) For secondary shared interrupts nothing notifies the new thread to
change its affinity.
3) Interrupts which have the IRQ\_NO\_BALANCE flag set are not moving
the thread either.
Fix this by setting the thread affinity flag right on thread creation
time. This ensures that under all circumstances the thread moves to
the right place. Requires a check in irq\_thread\_check\_affinity for an
existing affinity mask (CONFIG\_CPU\_MASK\_OFFSTACK=y)
Reported-and-tested-by: Sankara Muthukrishnan
Link: http://lkml.kernel.org/r/alpine.LFD.2.02.1209041738200.2754@ionos
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit dfcffbb7f048e69812ad92a293ea71a6514e4077
Author: Dmitry Torokhov
Date: Mon Dec 24 09:32:46 2012 -0800
Input: gpio\_keys - defer probing if GPIO probing is deferred
commit e324ce61ef483dd26d03502d35666ad48a2e1b33 upstream.
If of\_get\_gpio\_flags() returns an error (as in case when GPIO probe is
deferred) the driver would attempt to claim invalid GPIO. It should
propagate the error code up the stack instead so that the probe either
fails or will be retried later (in case of -EPROBE\_DEFER).
Reported-by: Gabor Juhos
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit d9f5f4bc9a6ca2558588eee434027b0b2af2f121
Author: Gabor Juhos
Date: Sun Dec 23 01:54:58 2012 -0800
Input: gpio\_keys\_polled - defer probing if GPIO probing is deferred
commit d46329a708c1a3301e272a029266b69339c0877f upstream.
If GPIO probing is deferred, the driver tries to claim an invalid GPIO line
which leads to an error message like this:
gpio-keys-polled buttons.2: unable to claim gpio 4294966779, err=-22
gpio-keys-polled: probe of buttons.2 failed with error -22
We should make sure that error code returned by of\_get\_gpio\_flags (including
-EPROBE\_DEFER) is propagated up the stack.
Signed-off-by: Gabor Juhos
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 459825b716b4f7f71d3d0a0da9c7e4192eb371c6
Author: Christophe TORDEUX
Date: Mon Dec 24 09:20:40 2012 -0800
Input: sentelic - only report position of first finger as ST coordinates
commit a25461659050b913e114d282bf58823682eb56b6 upstream.
Report only the position of the first finger as absolute non-MT coordinates,
instead of reporting both fingers alternatively. Actual MT events are
unaffected.
This fixes horizontal and improves vertical scrolling with the touchpad.
Signed-off-by: Christophe TORDEUX
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 2bf3364673ef36af85003ead8247313f78df515a
Author: Diego Calleja
Date: Mon Dec 3 21:16:11 2012 -0800
Input: wacom - fix touch support for Bamboo Fun CTH-461
commit e12b3cecf221644ccab64d7c30a6df58b7630cb0 upstream.
Commit f393ee2b814e3291c12565000210b3cf10aa5c1d forgot to add the
touch\_max property for Wacom Bamboo Fun CTH-461/S, ID 056a:00d2.
This broke the touch functionality for that device. This patch,
(done with help of Ping Cheng), adds the correct value and makes
touch work again.
Signed-off-by: Diego Calleja
Reviewed-by: Ping Cheng
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit df433c41eb955760b92949c2d7a229ace30789db
Author: Peter Popovec
Date: Fri Dec 14 22:57:25 2012 -0800
Input: walkera0701 - fix crash on startup
commit a455e2985f57e2a71566bb8850094af38b2c932d upstream.
The driver's timer must be set up before enabling IRQ handler, otherwise
bad things may happen.
Reported-and-tested-by: Fengguang Wu
Signed-off-by: Peter Popovec
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit dfde3c6d130f2e679024bd7b8692a4d00bac4ef8
Author: NeilBrown
Date: Thu Nov 8 16:09:37 2012 -0800
vfs: d\_obtain\_alias() needs to use "/" as default name.
commit b911a6bdeef5848c468597d040e3407e0aee04ce upstream.
NFS appears to use d\_obtain\_alias() to create the root dentry rather than
d\_make\_root. This can cause 'prepend\_path()' to complain that the root
has a weird name if an NFS filesystem is lazily unmounted. e.g. if
"/mnt" is an NFS mount then
{ cd /mnt; umount -l /mnt ; ls -l /proc/self/cwd; }
will cause a WARN message like
WARNING: at /home/git/linux/fs/dcache.c:2624 prepend\_path+0x1d7/0x1e0()
...
Root dentry has weird name <>
to appear in kernel logs.
So change d\_obtain\_alias() to use "/" rather than "" as the anonymous
name.
Signed-off-by: NeilBrown
Cc: Trond Myklebust
Cc: Al Viro
Signed-off-by: Andrew Morton
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit 2fc2d6907a79876e6c9dc3d3cd4565b319756750
Author: Nickolai Zeldovich
Date: Sat Jan 5 14:19:51 2013 -0500
nfs: avoid dereferencing null pointer in initiate\_bulk\_draining
commit ecf0eb9edbb607d74f74b73c14af8b43f3729528 upstream.
Fix an inverted null pointer check in initiate\_bulk\_draining().
Signed-off-by: Nickolai Zeldovich
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 25191192f7f136dbad081a19cd72521789268f2a
Author: Trond Myklebust
Date: Fri Jan 4 12:47:04 2013 -0500
NFS: Ensure that we free the rpc\_task after read and write cleanups are done
commit 6db6dd7d3fd8f7c765dabc376493d6791ab28bd6 upstream.
This patch ensures that we free the rpc\_task after the cleanup callbacks
are done in order to avoid a deadlock problem that can be triggered if
the callback needs to wait for another workqueue item to complete.
Signed-off-by: Trond Myklebust
Cc: Weston Andros Adamson
Cc: Tejun Heo
Cc: Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit bb3330c18aa9340c600706e60de7d8fdf5260420
Author: Xi Wang
Date: Fri Jan 4 03:22:57 2013 -0500
nfs: fix null checking in nfs\_get\_option\_str()
commit e25fbe380c4e3c09afa98bcdcd9d3921443adab8 upstream.
The following null pointer check is broken.
\*option = match\_strdup(args);
return !option;
The pointer `option' must be non-null, and thus `!option' is always false.
Use `!\*option' instead.
The bug was introduced in commit c5cb09b6f8 ("Cleanup: Factor out some
cut-and-paste code.").
Signed-off-by: Xi Wang
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 0b7d74eb80d06be3b5792cbdd2c77d1ccb05cc4b
Author: Yanchuan Nian
Date: Fri Jan 4 20:19:49 2013 +0800
pnfs: Increase the refcount when LAYOUTGET fails the first time
commit 39e88fcfb1d5c6c4b1ff76ca2ab76cf449b850e8 upstream.
The layout will be set unusable if LAYOUTGET fails. Is it reasonable to
increase the refcount iff LAYOUTGET fails the first time?
Signed-off-by: Yanchuan Nian
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 5865afd9e73a8981f38344ddcb42d9f2049c1469
Author: Weston Andros Adamson
Date: Thu Jan 3 16:42:29 2013 -0500
NFS: Fix access to suid/sgid executables
commit f8d9a897d4384b77f13781ea813156568f68b83e upstream.
nfs\_open\_permission\_mask() should only check MAY\_EXEC for files that
are opened with \_\_FMODE\_EXEC.
Also fix NFSv4 access-in-open path in a similar way -- openflags must be
used because fmode will not always have FMODE\_EXEC set.
This patch fixes https://bugzilla.kernel.org/show\_bug.cgi?id=49101
Signed-off-by: Weston Andros Adamson
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit e13ddf6bbcfe7ea1f83b9a7a9f698ef461cdff82
Author: Neil Brown
Date: Fri Dec 7 15:40:55 2012 -0500
nfsd: avoid permission checks on EXCLUSIVE\_CREATE replay
commit 7007c90fb9fef593b4aeaeee57e6a6754276c97c upstream.
With NFSv4, if we create a file then open it we explicit avoid checking
the permissions on the file during the open because the fact that we
created it ensures we should be allow to open it (the create and the
open should appear to be a single operation).
However if the reply to an EXCLUSIVE create gets lots and the client
resends the create, the current code will perform the permission check -
because it doesn't realise that it did the open already..
This patch should fix this.
Note that I haven't actually seen this cause a problem. I was just
looking at the code trying to figure out a different EXCLUSIVE open
related issue, and this looked wrong.
(Fix confirmed with pynfs 4.0 test OPEN4--bfields)
Signed-off-by: NeilBrown
[bfields: use OWNER\_OVERRIDE and update for 4.1]
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit e5926fdb4ef0eac63dee54009a74878e53777716
Author: J. Bruce Fields
Date: Tue Dec 4 18:25:10 2012 -0500
nfsd4: fix oops on unusual readlike compound
commit d5f50b0c290431c65377c4afa1c764e2c3fe5305 upstream.
If the argument and reply together exceed the maximum payload size, then
a reply with a read-like operation can overlow the rq\_pages array.
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 9dbe75d2b4111884596c498ca0acbaf71952ae97
Author: J. Bruce Fields
Date: Fri Nov 16 15:22:43 2012 -0500
nfsd: fix v4 reply caching
commit 57d276d71aef7d8305ff002a070cb98deb2edced upstream.
Very embarassing: 1091006c5eb15cba56785bd5b498a8d0b9546903 "nfsd: turn
on reply cache for NFSv4" missed a line, effectively leaving the reply
cache off in the v4 case. I thought I'd tested that, but I guess not.
This time, wrote a pynfs test to confirm it works.
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 7063a3eea85cf9246cdc917096d25d96f1cc341a
Author: Yanchuan Nian
Date: Wed Oct 24 14:44:19 2012 +0800
nfs: fix wrong object type in lockowner\_slab
commit 3c40794b2dd0f355ef4e6bf8d85af5dcd7da7ece upstream.
The object type in the cache of lockowner\_slab is wrong, and it is
better to fix it.
Signed-off-by: Yanchuan Nian
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 4cc423d6e6a6f0003c8e757d47aacec58e729f21
Author: Trond Myklebust
Date: Sat Dec 15 17:12:14 2012 -0500
NFS: Don't use SetPageError in the NFS writeback code
commit ada8e20d044c0fa5610e504ce6fb4578ebd3edd9 upstream.
The writeback code is already capable of passing errors back to user space
by means of the open\_context->error. In the case of ENOSPC, Neil Brown
is reporting seeing 2 errors being returned.
Neil writes:
"e.g. if /mnt2/ if an nfs mounted filesystem that has no space then
strace dd if=/dev/zero conv=fsync >> /mnt2/afile count=1
reported Input/output error and the relevant parts of the strace output are:
write(1, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 512) = 512
fsync(1) = -1 EIO (Input/output error)
close(1) = -1 ENOSPC (No space left on device)"
Neil then shows that the duplication of error messages appears to be due to
the use of the PageError() mechanism, which causes filemap\_fdatawait\_range
to return the extra EIO. The regression was introduced by
commit 7b281ee026552f10862b617a2a51acf49c829554 (NFS: fsync() must exit
with an error if page writeback failed).
Fix this by removing the call to SetPageError(), and just relying on
open\_context->error reporting the ENOSPC back to fsync().
Reported-by: Neil Brown
Tested-by: Neil Brown
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit fe32340b7fc58c8323eca13e111367be75d61918
Author: Trond Myklebust
Date: Fri Dec 14 16:38:46 2012 -0500
NFS: Fix calls to drop\_nlink()
commit 1f018458b30b0d5c535c94e577aa0acbb92e1395 upstream.
It is almost always wrong for NFS to call drop\_nlink() after removing a
file. What we really want is to mark the inode's attributes for
revalidation, and we want to ensure that the VFS drops it if we're
reasonably sure that this is the final unlink().
Do the former using the usual cache validity flags, and the latter
by testing if inode->i\_nlink == 1, and clearing it in that case.
This also fixes the following warning reported by Neil Brown and
Jeff Layton (among others).
[634155.004438] WARNING:
at /home/abuild/rpmbuild/BUILD/kernel-desktop-3.5.0/lin [634155.004442]
Hardware name: Latitude E6510 [634155.004577] crc\_itu\_t crc32c\_intel
snd\_hwdep snd\_pcm snd\_timer snd soundcor [634155.004609] Pid: 13402, comm:
bash Tainted: G W 3.5.0-36-desktop # [634155.004611] Call Trace:
[634155.004630] [] dump\_trace+0xaa/0x2b0
[634155.004641] [] dump\_stack+0x69/0x6f
[634155.004653] [] warn\_slowpath\_common+0x7b/0xc0
[634155.004662] [] drop\_nlink+0x34/0x40
[634155.004687] [] nfs\_dentry\_iput+0x33/0x70 [nfs]
[634155.004714] [] dput+0x12e/0x230
[634155.004726] [] \_\_fput+0x170/0x230
[634155.004735] [] filp\_close+0x5f/0x90
[634155.004743] [] sys\_close+0x97/0x100
[634155.004754] [] system\_call\_fastpath+0x16/0x1b
[634155.004767] [<00007f2a73a0d110>] 0x7f2a73a0d10f
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 22ad97385fd0d4d7d28f54c6a504203e5f498c9e
Author: NeilBrown
Date: Thu Dec 13 15:14:36 2012 +1100
NFS: avoid NULL dereference in nfs\_destroy\_server
commit f259613a1e4b44a0cf85a5dafd931be96ee7c9e5 upstream.
In rare circumstances, nfs\_clone\_server() of a v2 or v3 server can get
an error between setting server->destory (to nfs\_destroy\_server), and
calling nfs\_start\_lockd (which will set server->nlm\_host).
If this happens, nfs\_clone\_server will call nfs\_free\_server which
will call nfs\_destroy\_server and thence nlmclnt\_done(NULL). This
causes the NULL to be dereferenced.
So add a guard to only call nlmclnt\_done() if ->nlm\_host is not NULL.
The other guards there are irrelevant as nlm\_host can only be non-NULL
if one of these flags are set - so remove those tests. (Thanks to Trond
for this suggestion).
This is suitable for any stable kernel since 2.6.25.
Signed-off-by: NeilBrown
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 9883793305d5fbcf79c565f3572ba44d2493f8f5
Author: Jeff Layton
Date: Wed Dec 12 11:38:44 2012 -0500
nfs: don't zero out the rest of the page if we hit the EOF on a DIO READ
commit 67fad106a219e083c91c79695bd1807dde1bf7b9 upstream.
Eryu provided a test program that would segfault when attempting to read
past the EOF on file that was opened O\_DIRECT. The buffer given to the
read() call was on the stack, and when he attempted to read past it it
would scribble over the rest of the stack page.
If we hit the end of the file on a DIO READ request, then we don't want
to zero out the rest of the buffer. These aren't pagecache pages after
all, and there's no guarantee that the buffers that were passed in
represent entire pages.
Reported-by: Eryu Guan
Cc: Fred Isaman
Signed-off-by: Jeff Layton
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 43d1640924a2bd61e5f8ad156930353bd410e36d
Author: Sven Wegener
Date: Sat Dec 8 15:30:18 2012 +0100
NFSv4: Check for buffer length in \_\_nfs4\_get\_acl\_uncached
commit 7d3e91a89b7adbc2831334def9e494dd9892f9af upstream.
Commit 1f1ea6c "NFSv4: Fix buffer overflow checking in
\_\_nfs4\_get\_acl\_uncached" accidently dropped the checking for too small
result buffer length.
If someone uses getxattr on "system.nfs4\_acl" on an NFSv4 mount
supporting ACLs, the ACL has not been cached and the buffer suplied is
too short, we still copy the complete ACL, resulting in kernel and user
space memory corruption.
Signed-off-by: Sven Wegener
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 62ec24f42255d4c140a77f206068b76262c01c53
Author: Jeff Layton
Date: Mon Dec 10 09:25:48 2012 -0500
nfs: don't extend writes to cover entire page if pagecache is invalid
commit 81d9bce5309288086b58b4d97a644e495fef75f2 upstream.
Jian reported that the following sequence would leave "testfile" with
corrupt data:
# mount localhost:/export /mnt/nfs/ -o vers=3
# echo abc > /mnt/nfs/testfile; echo def >> /export/testfile; echo ghi >> /mnt/nfs/testfile
# cat -v /export/testfile
abc
^@^@^@^@ghi
While there's no locking involved here, the operations are serialized,
so CTO should prevent corruption.
The first write to the file is fine and writes 4 bytes. The file is then
extended on the server. When it's reopened a GETATTR is issued and the
size change is noticed. This causes NFS\_INO\_INVALID\_DATA to be set on
the file. Because the file is opened for write only,
nfs\_want\_read\_modify\_write() returns 0 to nfs\_write\_begin().
nfs\_updatepage then calls nfs\_write\_pageuptodate() to see if it should
extend the nfs\_page to cover the whole page. NFS\_INO\_INVALID\_DATA is
still set on the file at that point, but that flag is ignored and
nfs\_pageuptodate erroneously extends the write to cover the whole page,
with the write done on the server side filled in with zeroes.
This patch just has that function check for NFS\_INO\_INVALID\_DATA in
addition to NFS\_INO\_REVAL\_PAGECACHE. This fixes the bug, but looking
over the code, I wonder if we might have a similar bug in
nfs\_revalidate\_size(). The difference between those two flags is very
subtle, so it seems like we ought to be checking for
NFS\_INO\_INVALID\_DATA in most of the places that we look for
NFS\_INO\_REVAL\_PAGECACHE.
I believe this is regression introduced by commit 8d197a568. The code
did check for NFS\_INO\_INVALID\_DATA prior to that patch.
Original bug report is here:
https://bugzilla.redhat.com/show\_bug.cgi?id=885743
Reported-by: Jian Li
Signed-off-by: Jeff Layton
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 4d436f1d25a6bf4788dfc5eeed043137b47115f3
Author: Bryan Schumaker
Date: Mon Nov 12 16:55:38 2012 -0500
NFS: Add sequence\_priviliged\_ops for nfs4\_proc\_sequence()
commit 6bdb5f213c4344324f600dde885f25768fbd14db upstream.
If I mount an NFS v4.1 server to a single client multiple times and then
run xfstests over each mountpoint I usually get the client into a state
where recovery deadlocks. The server informs the client of a
cb\_path\_down sequence error, the client then does a
bind\_connection\_to\_session and checks the status of the lease.
I found that bind\_connection\_to\_session sets the NFS4\_SESSION\_DRAINING
flag on the client, but this flag is never unset before
nfs4\_check\_lease() reaches nfs4\_proc\_sequence(). This causes the client
to deadlock, halting all NFS activity to the server. nfs4\_proc\_sequence()
is only called by the state manager, so I can change it to run in privileged
mode to bypass the NFS4\_SESSION\_DRAINING check and avoid the deadlock.
Signed-off-by: Bryan Schumaker
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit b500eb39c56d89b45c088cba868f20abcfd63cbf
Author: Rafael J. Wysocki
Date: Fri Jan 4 23:00:54 2013 +0100
ACPI / scan: Do not use dummy HID for system bus ACPI nodes
commit 4f5f64cf0cc916220aaa055992e31195470cfe37 upstream.
At one point acpi\_device\_set\_id() checks if acpi\_device\_hid(device)
returns NULL, but that never happens, so system bus devices with an
empty list of PNP IDs are given the dummy HID ("device") instead of
the "system bus HID" ("LNXSYBUS"). Fix the code to use the right
check.
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 100865b4ba20cbe67875b4acf1c0a6711afd41ef
Author: Aaron Lu
Date: Mon Nov 26 13:55:25 2012 +0800
libata: restore acpi disable functionality
commit 0d0cdb028f9d9771e2b346038707734121f906e3 upstream.
Commit 66fa7f215 "libata-acpi: improve ACPI disabling" introdcued the
behaviour of disabling ATA ACPI if ata\_acpi\_on\_devcfg failed the 2nd
time, but commit 30dcf76ac dropped this behaviour and this caused
problem for Dimitris Damigos, where his laptop can not resume correctly.
The bugzilla page for it is:
https://bugzilla.kernel.org/show\_bug.cgi?id=49331
The problem is, ata\_dev\_push\_id will fail the 2nd time it is invoked,
and due to disabling ACPI code is dropped, ata\_acpi\_on\_devcfg which
calls ata\_dev\_push\_id will keep failing and eventually made the device
disabled.
This patch restores the original behaviour, if acpi failed the 2nd time,
disable acpi functionality for the device(and we do not event need to
add a debug message for this as it is still there ;-).
Reported-by: Dimitris Damigos
Signed-off-by: Aaron Lu
Signed-off-by: Jeff Garzik
Signed-off-by: Greg Kroah-Hartman
commit b8d74ea021f1b07c4d09c8f6b8b7689e4488abe5
Author: Zhang Rui
Date: Fri Nov 30 12:57:03 2012 +0100
ACPI: do acpisleep dmi check when CONFIG\_ACPI\_SLEEP is set
commit 0ac1b1d7b7424cd6f129b5454b504b3cae746f0e upstream.
The current acpisleep DMI checks only run when CONFIG\_SUSPEND is set.
And this may break hibernation on some platforms when CONFIG\_SUSPEND
is cleared.
Move acpisleep DMI check into #ifdef CONFIG\_ACPI\_SLEEP instead.
[rjw: Added acpi\_sleep\_dmi\_check() and rebased on top of earlier
patches adding entries to acpisleep\_dmi\_table[].]
References: https://bugzilla.kernel.org/show\_bug.cgi?id=45921
Signed-off-by: Zhang Rui
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 192847f2597e954488a175e40607dcb396bec6c1
Author: Sebastian Andrzej Siewior
Date: Mon Oct 22 22:15:00 2012 +0200
usb: gadget: network: fix bind() error path
commit e79cc615a9bb44da72c499ccfa2c9c4bbea3aa84 upstream.
I think this is wrong since 72c973dd ("usb: gadget: add
usb\_endpoint\_descriptor to struct usb\_ep"). If we fail to allocate an ep
or bail out early we shouldn't check for the descriptor which is
assigned at ep\_enable() time.
Signed-off-by: Sebastian Andrzej Siewior
Cc: Tatyana Brokhman
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 065f5561a20659cf17aae5f72b32b5c2695c8e00
Author: Sebastian Andrzej Siewior
Date: Mon Oct 22 22:15:05 2012 +0200
usb: gadget: uvc: fix error path in uvc\_function\_bind()
commit 0f9df939385527049c8062a099fbfa1479fe7ce0 upstream.
The "video->minor = -1" assigment is done in V4L2 by
video\_register\_device() so it is removed here.
Now. uvc\_function\_bind() calls in error case uvc\_function\_unbind() for
cleanup. The problem is that uvc\_function\_unbind() frees the uvc struct
and uvc\_bind\_config() does as well in error case of usb\_add\_function().
Removing kfree() in usb\_add\_function() would make the patch smaller but
it would look odd because the new allocated memory is not cleaned up.
However it is not guaranteed that if we call usb\_add\_function() we also
get to the bind function.
Therefore the patch extracts the conditional cleanup from
uvc\_function\_unbind() applies to uvc\_function\_bind().
uvc\_function\_unbind() now contains only the complete cleanup which is
required once everything has been registrated.
Signed-off-by: Sebastian Andrzej Siewior
Cc: Laurent Pinchart
Cc: Bhupesh Sharma
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 7347f50b3f034bd4da7778e55ce91076bf3f39c6
Author: Sebastian Andrzej Siewior
Date: Mon Oct 22 22:14:56 2012 +0200
usb: gadget: tcm\_usb\_gadget: NULL terminate the FS descriptor list
commit fad8deb274edcef1c8ca38946338f5f4f8126fe2 upstream.
The descriptor list for FS speed was not NULL terminated. This patch
fixes this.
While here one of the twe two bAlternateSetting assignments for the BOT
interface. Both assign 0, one is enough.
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit f3aab9240ef932c777727b3165ef583eaa9ab5a7
Author: Sebastian Andrzej Siewior
Date: Mon Oct 22 22:15:04 2012 +0200
usb: gadget: phonet: free requests in pn\_bind()'s error path
commit d0eca719dd11ad0619e8dd6a1f3eceb95b0216dd upstream.
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 364b6ddb217bb3c08ca1d02fc39efae277624d27
Author: Sebastian Andrzej Siewior
Date: Mon Oct 22 22:15:02 2012 +0200
usb: gadget: midi: free hs descriptors
commit d185039f7982eb82cf8d03b6fb6689587ca5af24 upstream.
The HS descriptors are only created if HS is supported by the UDC but we
never free them.
Signed-off-by: Sebastian Andrzej Siewior
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 8af66623ab9c6d0c8b1517d578f7f3ad1e323cc9
Author: Lothar Waßmann
Date: Thu Nov 22 10:11:25 2012 +0100
USB: chipidea: fix use after free bug
commit 98c35534420d3147553bd3071a5fc63cd56de5b1 upstream.
The pointer to a platform\_device struct must not be dereferenced after
the device has been unregistered.
This bug produces a crash when unloading the ci13xxx kernel module
compiled with CONFIG\_PAGE\_POISONING enabled.
Signed-off-by: Lothar Waßmann
Acked-by: Alexander Shishkin
Signed-off-by: Greg Kroah-Hartman
commit 7564b3b7f18d55c017346ae061f5359872e0a281
Author: Christian Lamparter
Date: Thu Dec 27 15:18:20 2012 +0100
p54usb: add USBIDs for two more p54usb devices
commit 4010fe21a315b4223c25376714c6a2b61b722e5c upstream.
This patch adds USBIDs for:
- DrayTek Vigor 530
- Zoom 4410a
It also adds a note about Gemtek WUBI-100GW
and SparkLAN WL-682 USBID conflict [WUBI-100GW
is a ISL3886+NET2280 (LM86 firmare) solution,
whereas WL-682 is a ISL3887 (LM87 firmware)]
device.
Source:
Signed-off-by: Christian Lamparter
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit ea32c619bde5c88e0a53b4f98883efc07038305f
Author: Tomasz Guszkowski
Date: Sat Dec 22 18:30:01 2012 +0100
p54usb: add USB ID for T-Com Sinus 154 data II
commit 3194b7fcdf6caea338b5d2c72d76fed80437649c upstream.
Added USB ID for T-Com Sinus 154 data II.
Signed-off-by: Tomasz Guszkowski
Acked-by: Christian Lamparter
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit ffbbf80d13d77ef0b533d7410dd2097f37dd24c2
Author: Jussi Kivilinna
Date: Thu Dec 20 16:24:43 2012 +0200
rtlwifi: fix incorrect use of usb\_alloc\_coherent with usb\_control\_msg
commit 4c3de5920c486b8eefa6187ee6a181864c161100 upstream.
Incorrect use of usb\_alloc\_coherent memory as input buffer to usb\_control\_msg
can cause problems in arch DMA code, for example kernel BUG at
'arch/arm/include/asm/dma-mapping.h:321' on ARM (linux-3.4).
Change \_usb\_writeN\_sync use kmalloc'd buffer instead.
Signed-off-by: Jussi Kivilinna
Acked-by: Larry Finger
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit e6ad3201c5b9c54cf09fd30d420378f0a9476780
Author: Dan Williams
Date: Mon Dec 17 08:17:41 2012 +0000
qmi\_wwan/cdc\_ether: add Dell Wireless 5800 (Novatel E362) USB IDs
commit 0370acd4d4d2595a11b0b0a793acb506e19b9d4c upstream.
Signed-off-by: Dan Williams
Acked-by: Bjørn Mork
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b862579a9398a1c68a99a6f1edb53fb1837c3737
Author: David Henningsson
Date: Mon Jan 7 12:03:47 2013 +0100
ALSA: hda - add mute LED for HP Pavilion 17 (Realtek codec)
commit 6d3cd5d444223c41eabb70dccff14fae4e8cb8b1 upstream.
The mute LED is in this case connected to the Mic1 VREF.
The machine also exposes the following string in BIOS:
"HP\_Mute\_LED\_0\_A", so if more machines are coming, it probably
makes sense to try to do something more generic, like for the
IDT codec.
BugLink: https://bugs.launchpad.net/bugs/1096789
Signed-off-by: David Henningsson
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit de9cd896f7f3a43440a88f56a71826382227eddc
Author: Takashi Iwai
Date: Thu Dec 13 14:33:42 2012 +0100
ALSA: hda - Fix pin configuration of HP Pavilion dv7
commit 8ae5865ec77c22462c736846a0679947a6953548 upstream.
Fix the quirk entry for HP Pavilion dv7 in order to make the bass
speaker working.
Reported-and-tested-by: Tomas Pospisek
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit db7a240b19ac3e8bcad0520f3575b3036b44b75b
Author: Takashi Iwai
Date: Mon Dec 17 20:06:49 2012 +0100
ALSA: hda - Fix the wrong pincaps set in ALC861VD dallas/hp fixup
commit b78562b10fa66175e30b76073e32a0ad8d92aa83 upstream.
The workaround to force VREF50 for dallas/hp model with ALC861VD
was introduced in commit 8fdcb6fe4204bdb4c6991652717ab5063751414e,
but it contained wrong pincap override bits.
This patch fixes to exclude VREF80 pincap bit correctly.
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 2626d16bbdedcd64c6af3c519aecd5a6f2356e58
Author: Takashi Iwai
Date: Fri Dec 14 10:22:35 2012 +0100
ALSA: hda - Always turn on pins for HDMI/DP
commit 6169b673618bf0b2518ce413b54925782a603f06 upstream.
We've seen the broken HDMI \*video\* output on some machines with GM965,
and the debugging session pointed that the culprit is the disabled
audio output pins. Toggling these pins dynamically on demand caused
flickering of HDMI TV.
This patch changes the behavior to keep the pin ON constantly.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=51421
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 13602ca9cbb1ef190bdda351ccbfc75d8c92fd74
Author: Takashi Iwai
Date: Wed Dec 12 12:10:01 2012 +0100
ALSA: hda - Add stereo-dmic fixup for Acer Aspire One 522
commit 63a077e27648b4043b1ca1b4e29f0c42d99616b6 upstream.
Acer Aspire One 522 has the infamous digital mic unit that needs the
phase inversion fixup for stereo.
Bugzilla: https://bugzilla.novell.com/show\_bug.cgi?id=715737
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit eeada90a5340368310a59c4b620982055fb022f0
Author: Takashi Iwai
Date: Wed Dec 12 11:50:12 2012 +0100
ALSA: hda - Move runtime PM check to runtime\_idle callback
commit 6eb827d23577a4efec2b10a9c4cc9ded268a1d1c upstream.
The runtime\_idle callback is the right place to check the suspend
capability, but currently we do it wrongly in the runtime\_suspend
callback. This leads to a kernel error message like:
pci\_pm\_runtime\_suspend(): azx\_runtime\_suspend+0x0/0x50 [snd\_hda\_intel] returns -11
and the runtime PM core would even repeat the attempts.
Reported-and-tested-by: Borislav Petkov
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 8be35acfe0265662971b77b09bced6cf28781325
Author: Takashi Iwai
Date: Mon Dec 3 11:30:50 2012 +0100
ALSA: usb-audio: Fix missing autopm for MIDI input
commit f5f165418cabf2218eb466c0e94693b8b1aee88b upstream.
The commit [88a8516a: ALSA: usbaudio: implement USB autosuspend] added
the support of autopm for USB MIDI output, but it didn't take the MIDI
input into account.
This patch adds the following for fixing the autopm:
- Manage the URB start at the first MIDI input stream open, instead of
the time of instance creation
- Move autopm code to the common substream\_open()
- Make snd\_usbmidi\_input\_start/\_stop() more robust and add the running
state check
Reviewd-by: Clemens Ladisch
Tested-by: Clemens Ladisch
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 08588e3a7dc15d729b145a6d589af5f1ca8fa7ba
Author: Takashi Iwai
Date: Mon Dec 3 11:12:46 2012 +0100
ALSA: usb-audio: Avoid autopm calls after disconnection
commit 59866da9e4ae54819e3c4e0a8f426bdb0c2ef993 upstream.
Add a similar protection against the disconnection race and the
invalid use of usb instance after disconnection, as well as we've done
for the USB audio PCM.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=51201
Reviewd-by: Clemens Ladisch
Tested-by: Clemens Ladisch
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 680dfe59174a569b842cbcb1cecaf517923e8fc1
Author: Hugh Dickins
Date: Wed Jan 2 02:01:33 2013 -0800
tmpfs mempolicy: fix /proc/mounts corrupting memory
commit f2a07f40dbc603c15f8b06e6ec7f768af67b424f upstream.
Recently I suggested using "mount -o remount,mpol=local /tmp" in NUMA
mempolicy testing. Very nasty. Reading /proc/mounts, /proc/pid/mounts
or /proc/pid/mountinfo may then corrupt one bit of kernel memory, often
in a page table (causing "Bad swap" or "Bad page map" warning or "Bad
pagetable" oops), sometimes in a vm\_area\_struct or rbnode or somewhere
worse. "mpol=prefer" and "mpol=prefer:Node" are equally toxic.
Recent NUMA enhancements are not to blame: this dates back to 2.6.35,
when commit e17f74af351c "mempolicy: don't call mpol\_set\_nodemask() when
no\_context" skipped mpol\_parse\_str()'s call to mpol\_set\_nodemask(),
which used to initialize v.preferred\_node, or set MPOL\_F\_LOCAL in flags.
With slab poisoning, you can then rely on mpol\_to\_str() to set the bit
for node 0x6b6b, probably in the next page above the caller's stack.
mpol\_parse\_str() is only called from shmem\_parse\_options(): no\_context
is always true, so call it unused for now, and remove !no\_context code.
Set v.nodes or v.preferred\_node or MPOL\_F\_LOCAL as mpol\_to\_str() might
expect. Then mpol\_to\_str() can ignore its no\_context argument also,
the mpol being appropriately initialized whether contextualized or not.
Rename its no\_context unused too, and let subsequent patch remove them
(that's not needed for stable backporting, which would involve rejects).
I don't understand why MPOL\_LOCAL is described as a pseudo-policy:
it's a reasonable policy which suffers from a confusing implementation
in terms of MPOL\_PREFERRED with MPOL\_F\_LOCAL. I believe this would be
much more robust if MPOL\_LOCAL were recognized in switch statements
throughout, MPOL\_F\_LOCAL deleted, and MPOL\_PREFERRED use the (possibly
empty) nodes mask like everyone else, instead of its preferred\_node
variant (I presume an optimization from the days before MPOL\_LOCAL).
But that would take me too long to get right and fully tested.
Signed-off-by: Hugh Dickins
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 59c66ed69072ccb09c10d06b79339ebfb25a5394
Author: Christoffer Dall
Date: Fri Dec 21 13:03:50 2012 -0500
mm: Fix PageHead when !CONFIG\_PAGEFLAGS\_EXTENDED
commit ad4b3fb7ff9940bcdb1e4cd62bd189d10fa636ba upstream.
Unfortunately with !CONFIG\_PAGEFLAGS\_EXTENDED, (!PageHead) is false, and
(PageHead) is true, for tail pages. If this is indeed the intended
behavior, which I doubt because it breaks cache cleaning on some ARM
systems, then the nomenclature is highly problematic.
This patch makes sure PageHead is only true for head pages and PageTail
is only true for tail pages, and neither is true for non-compound pages.
[ This buglet seems ancient - seems to have been introduced back in Apr
2008 in commit 6a1e7f777f61: "pageflags: convert to the use of new
macros". And the reason nobody noticed is because the PageHead()
tests are almost all about just sanity-checking, and only used on
pages that are actual page heads. The fact that the old code returned
true for tail pages too was thus not really noticeable. - Linus ]
Signed-off-by: Christoffer Dall
Acked-by: Andrea Arcangeli
Cc: Andrew Morton
Cc: Will Deacon
Cc: Steve Capper
Cc: Christoph Lameter
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 9359dd031b11100a3532ef7bfc04f2fc7f23c33b
Author: Sonny Rao
Date: Thu Dec 20 15:05:07 2012 -0800
mm: fix calculation of dirtyable memory
commit c8b74c2f6604923de91f8aa6539f8bb934736754 upstream.
The system uses global\_dirtyable\_memory() to calculate number of
dirtyable pages/pages that can be allocated to the page cache. A bug
causes an underflow thus making the page count look like a big unsigned
number. This in turn confuses the dirty writeback throttling to
aggressively write back pages as they become dirty (usually 1 page at a
time). This generally only affects systems with highmem because the
underflowed count gets subtracted from the global count of dirtyable
memory.
The problem was introduced with v3.2-4896-gab8fabd
Fix is to ensure we don't get an underflowed total of either highmem or
global dirtyable memory.
Signed-off-by: Sonny Rao
Signed-off-by: Puneet Kumar
Acked-by: Johannes Weiner
Tested-by: Damien Wyart
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 4250fc1e957d8b86f124593ecdad534009b89733
Author: Will Deacon
Date: Fri Oct 19 14:03:33 2012 +0100
virtio: force vring descriptors to be allocated from lowmem
commit b92b1b89a33c172c075edccf6afb0edc41d851fd upstream.
Virtio devices may attempt to add descriptors to a virtqueue from atomic
context using GFP\_ATOMIC allocation. This is problematic because such
allocations can fall outside of the lowmem mapping, causing virt\_to\_phys
to report bogus physical addresses which are subsequently passed to
userspace via the buffers for the virtual device.
This patch masks out \_\_GFP\_HIGH and \_\_GFP\_HIGHMEM from the requested
flags when allocating descriptors for a virtqueue. If an atomic
allocation is requested and later fails, we will return -ENOSPC which
will be handled by the driver.
Signed-off-by: Will Deacon
Cc: Sasha Levin
Signed-off-by: Rusty Russell
Signed-off-by: Greg Kroah-Hartman
commit 7420b25f0873f561e70c7cda716587014cee95c3
Author: Will Deacon
Date: Fri Oct 19 14:03:32 2012 +0100
virtio: 9p: correctly pass physical address to userspace for high pages
commit b9cdc88df8e63e81c723b82c286fc97f5d0dc325 upstream.
When using a virtio transport, the 9p net device may pass the physical
address of a kernel buffer to userspace via a scatterlist inside a
virtqueue. If the kernel buffer is mapped outside of the linear mapping
(e.g. highmem), then virt\_to\_page will return a bogus value and we will
populate the scatterlist with junk.
This patch uses kmap\_to\_page when populating the page array for a kernel
buffer.
Signed-off-by: Will Deacon
Cc: Sasha Levin
Signed-off-by: Rusty Russell
Signed-off-by: Greg Kroah-Hartman
commit 4a8d5b926259721cf7b931967b8e3f9e3936c2d7
Author: Will Deacon
Date: Fri Oct 19 14:03:31 2012 +0100
mm: highmem: export kmap\_to\_page for modules
commit f0263d2d222e9e25f2587e51a9dc58c6fb2a9352 upstream.
Some virtio device drivers (9p) need to translate high virtual addresses
to physical addresses, which are inserted into the virtqueue for
processing by userspace.
This patch exports the kmap\_to\_page symbol, so that the affected drivers
can be compiled as modules.
Signed-off-by: Will Deacon
Signed-off-by: Rusty Russell
Signed-off-by: Greg Kroah-Hartman
commit 2dfc7a391af637b6a820c0ded3964c2b9efd417f
Author: Ondrej Zary
Date: Tue Dec 11 22:18:05 2012 +0100
x86, 8042: Enable A20 using KBC to fix S3 resume on some MSI laptops
commit ad68652412276f68ad4fe3e1ecf5ee6880876783 upstream.
Some MSI laptop BIOSes are broken - INT 15h code uses port 92h to enable A20
line but resume code assumes that KBC was used.
The laptop will not resume from S3 otherwise but powers off after a while
and then powers on again stuck with a blank screen.
Fix it by enabling A20 using KBC in i8042\_platform\_init for x86.
Fixes https://bugzilla.kernel.org/show\_bug.cgi?id=12878
Signed-off-by: Ondrej Zary
Cc: Dmitry Torokhov
Cc: Alan Cox
Cc: Rafael J. Wysocki
Link: http://lkml.kernel.org/r/201212112218.06551.linux@rainbow-software.org
Signed-off-by: H. Peter Anvin
Signed-off-by: Greg Kroah-Hartman
commit 7dafc8952dc0964cead9646039a8d66a9ed4cf73
Author: Will Deacon
Date: Fri Nov 23 12:34:13 2012 +0000
arm64: signal: push the unwinding prologue on the signal stack
commit 304ef4e8367244b547734143c792a2ab764831e8 upstream.
To allow debuggers to unwind through signal frames, we create a fake
stack unwinding prologue containing the link register and frame pointer
of the interrupted context. The signal frame is then offset by 16 bytes
to make room for the two saved registers which are pushed onto the frame
of the \*interrupted\* context, rather than placed directly above the
signal stack.
This doesn't work when an alternative signal stack is set up for a SEGV
handler, which is raised in response to RLIMIT\_STACK being reached. In
this case, we try to push the unwinding prologue onto the full stack and
subsequently take a fault which we fail to resolve, causing setup\_return
to return -EFAULT and handle\_signal to force\_sigsegv on the current task.
This patch fixes the problem by including the unwinding prologue as part
of the rt\_sigframe definition, which is populated during setup\_sigframe,
ensuring that it always ends up on the signal stack.
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit a5220f902e102b27f529ffe3b9ef221583378597
Author: Catalin Marinas
Date: Wed Nov 28 17:06:05 2012 +0000
arm64: Make !dirty ptes read-only
commit 33eaa58f854770dc9c98411a356c98e3a53edfda upstream.
The AArch64 Linux port relies on the mm code to wrprotect clean ptes.
This however is not the case with newly created ptes and
PAGE\_SHARED(\_EXEC) is writable but !dirty.
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 21838dbf96ce1e94d1ba80fdd491f9a0a6352ff1
Author: Kees Cook
Date: Thu Dec 20 15:05:16 2012 -0800
exec: do not leave bprm->interp on stack
commit b66c5984017533316fd1951770302649baf1aa33 upstream.
If a series of scripts are executed, each triggering module loading via
unprintable bytes in the script header, kernel stack contents can leak
into the command line.
Normally execution of binfmt\_script and binfmt\_misc happens recursively.
However, when modules are enabled, and unprintable bytes exist in the
bprm->buf, execution will restart after attempting to load matching
binfmt modules. Unfortunately, the logic in binfmt\_script and
binfmt\_misc does not expect to get restarted. They leave bprm->interp
pointing to their local stack. This means on restart bprm->interp is
left pointing into unused stack memory which can then be copied into the
userspace argv areas.
After additional study, it seems that both recursion and restart remains
the desirable way to handle exec with scripts, misc, and modules. As
such, we need to protect the changes to interp.
This changes the logic to require allocation for any changes to the
bprm->interp. To avoid adding a new kmalloc to every exec, the default
value is left as-is. Only when passing through binfmt\_script or
binfmt\_misc does an allocation take place.
For a proof of concept, see DoTest.sh from:
http://www.halfdog.net/Security/2012/LinuxKernelBinfmtScriptStackDataDisclosure/
Signed-off-by: Kees Cook
Cc: halfdog
Cc: P J P
Cc: Alexander Viro
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit cae5b83f40f584969767996e294a0cd322856c8b
Author: Robin Holt
Date: Thu Dec 20 15:05:50 2012 -0800
SGI-XP: handle non-fatal traps
commit 891348ca0f66206f1dc0e30d63757e3df1ae2d15 upstream.
We found a user code which was raising a divide-by-zero trap. That trap
would lead to XPC connections between system-partitions being torn down
due to the die\_chain notifier callouts it received.
This also revealed a different issue where multiple callers into
xpc\_die\_deactivate() would all attempt to do the disconnect in parallel
which would sometimes lock up but often overwhelm the console on very
large machines as each would print at least one line of output at the
end of the deactivate.
I reviewed all the users of the die\_chain notifier and changed the code
to ignore the notifier callouts for reasons which will not actually lead
to a system to continue on to call die().
[akpm@linux-foundation.org: fix ia64]
Signed-off-by: Robin Holt
Cc: Thomas Gleixner
Cc: Ingo Molnar
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit fe33f310343a8b2d733a8ab286c0f6b9bae08ed6
Author: Alan Cox
Date: Fri Dec 7 23:11:14 2012 +0100
pnpacpi: fix incorrect TEST\_ALPHA() test
commit cdc87c5a30f407ed1ce43d8a22261116873d5ef1 upstream.
TEST\_ALPHA() is broken and always returns 0.
[akpm@linux-foundation.org: return false for '@' as well, per Bjorn]
Signed-off-by: Alan Cox
Signed-off-by: Andrew Morton
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit c0343ba858128ce45ca9350922f53b7f03a1d590
Author: Felix Fietkau
Date: Mon Dec 10 17:40:21 2012 +0100
b43: fix tx path skb leaks
commit 78f18df4b323d2ac14d6c82e2fc3c8dc4556bccc upstream.
ieee80211\_free\_txskb() needs to be used instead of dev\_kfree\_skb\_any for
tx packets passed to the driver from mac80211
Signed-off-by: Felix Fietkau
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit 6a9c6804719aa5c6e17037b947875ed614c2e7b2
Author: Larry Finger
Date: Thu Dec 6 21:55:16 2012 -0600
b43legacy: Fix firmware loading when driver is built into the kernel
commit 576d28a7c73013717311cfcb514dbcae27c82eeb upstream.
Recent versions of udev cause synchronous firmware loading from the
probe routine to fail because the request to user space times out.
The original fix for b43legacy (commit a3ea2c7) moved the firmware
load from the probe routine to a work queue, but it still used synchronous
firmware loading. This method is OK when b43legacy is built as a module;
however, it fails when the driver is compiled into the kernel.
This version changes the code to load the initial firmware file
using request\_firmware\_nowait(). A completion event is used to
hold the work queue until that file is available. The remaining
firmware files are read synchronously.
Signed-off-by: Larry Finger
Signed-off-by: John W. Linville
Signed-off-by: Greg Kroah-Hartman
commit 235db1e98f49a39427b87b491388cf645406e5fc
Author: Chuansheng Liu
Date: Sat Nov 10 01:27:22 2012 +0800
firmware loader: Fix the concurrent request\_firmware() race for kref\_get/put
commit bd9eb7fbe69111ea0ff1f999ef4a5f26d223d1d5 upstream.
There is one race that both request\_firmware() with the same
firmware name.
The race scenerio is as below:
CPU1 CPU2
request\_firmware() -->
\_request\_firmware\_load() return err another request\_firmware() is coming -->
\_request\_firmware\_cleanup is called --> \_request\_firmware\_prepare -->
release\_firmware ---> fw\_lookup\_and\_allocate\_buf -->
spin\_lock(&fwc->lock)
... \_\_fw\_lookup\_buf() return true
fw\_free\_buf() will be called --> ...
kref\_put -->
decrease the refcount to 0
kref\_get(&tmp->ref) ==> it will trigger warning
due to refcount == 0
\_\_fw\_free\_buf() -->
... spin\_unlock(&fwc->lock)
spin\_lock(&fwc->lock)
list\_del(&buf->list)
spin\_unlock(&fwc->lock)
kfree(buf)
After that, the freed buf will be used.
The key race is decreasing refcount to 0 and list\_del is not protected together by
fwc->lock, and it is possible another thread try to get it between refcount==0
and list\_del.
Fix it here to protect it together.
Acked-by: Ming Lei
Signed-off-by: liu chuansheng
Signed-off-by: Greg Kroah-Hartman
commit 42b5489a2b5163c01e2fe23a609d397facfd0509
Author: Chuansheng Liu
Date: Thu Nov 8 19:14:40 2012 +0800
firmware loader: Fix the race FW\_STATUS\_DONE is followed by class\_timeout
commit ce2fcbd99cef580623116bb33531dbc3e6f690b0 upstream.
There is a race as below when calling request\_firmware():
CPU1 CPU2
write 0 > loading
mutex\_lock(&fw\_lock)
...
set\_bit FW\_STATUS\_DONE class\_timeout is coming
set\_bit FW\_STATUS\_ABORT
complete\_all &completion
...
mutex\_unlock(&fw\_lock)
In this time, the bit FW\_STATUS\_DONE and FW\_STATUS\_ABORT are set,
and request\_firmware() will return failure due to condition in
\_request\_firmware\_load():
if (!buf->size || test\_bit(FW\_STATUS\_ABORT, &buf->status))
retval = -ENOENT;
But from the above scenerio, it should be a successful requesting.
So we need judge if the bit FW\_STATUS\_DONE is already set before
calling fw\_load\_abort() in timeout function.
As Ming's proposal, we need change the timer into sched\_work to
benefit from using &fw\_lock mutex also.
Signed-off-by: liu chuansheng
Acked-by: Ming Lei
Signed-off-by: Greg Kroah-Hartman
commit e66e367bf75bb2e153f286a76592c2e23afc660d
Author: Eric Dumazet
Date: Mon Dec 10 12:32:03 2012 +0000
net: fix a race in gro\_cell\_poll()
[ Upstream commit f8e8f97c11d5ff3cc47d85b97c7c35e443dcf490 ]
Dmitry Kravkov reported packet drops for GRE packets since GRO support
was added.
There is a race in gro\_cell\_poll() because we call napi\_complete()
without any synchronization with a concurrent gro\_cells\_receive()
Once bug was triggered, we queued packets but did not schedule NAPI
poll.
We can fix this issue using the spinlock protected the napi\_skbs queue,
as we have to hold it to perform skb dequeue anyway.
As we open-code skb\_dequeue(), we no longer need to mask IRQS, as both
producer and consumer run under BH context.
Bug added in commit c9e6bc644e (net: add gro\_cells infrastructure)
Reported-by: Dmitry Kravkov
Signed-off-by: Eric Dumazet
Tested-by: Dmitry Kravkov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman


=== Content from bugzilla.redhat.com_f64ab945_20250124_232133.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D952260)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D952260)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D952260)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 952260

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 952260**](show_bug.cgi?id=952260)
(CVE-2013-3302)
- [CVE-2013-3302](https://access.redhat.com/security/cve/CVE-2013-3302) Kernel: cifs: NULL pointer dereference

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2013-3302 Kernel: cifs: NULL pointer dereference

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED WONTFIX | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2013-3302 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | low | | [Severity:](page.cgi?id=fields.html#bug_severity) | low | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [904594](show_bug.cgi?id=904594) | | TreeView+ | [depends on](buglist.cgi?bug_id=952260&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=952260&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2013-04-15 13:49 UTC by Prasad Pandit | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2021-02-17 07:49 UTC ([History](show_activity.cgi?id=952260)) | | [CC List:](page.cgi?id=fields.html#cclist) | 24 users (show)  agordeev anton bhu davej dhoward esammons fhrbata gansalmon iboverma itamar jforbes jkacur jonathan jwboyer kernel-maint kernel-mgr lgoncalv lwang madhu.chinakonda mcressma plougher rt-maint rvrbovsk williams | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: |  | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2014-06-10 05:34:07 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=952260#c0)  Prasad Pandit    2013-04-15 13:49:25 UTC  ``` Linux kernels built with CIFS(CONFIG_CIFS) network file system support are vulnerable to a NULL pointer dereference flaw. It could occur during a reconnection attempt.  An unprivileged user/program could use this flaw to crash the system, resulting in DoS.  Upstream fix: -------------  -> <https://git.kernel.org/linus/ea702b80e0bbb2448e201472127288beb82ca2fe>   ```  [Comment 1](show_bug.cgi?id=952260#c1)  Prasad Pandit    2013-04-15 13:52:24 UTC  ``` Statement:  This issue does not affect the versions of the kernel package as shipped with Red Hat Enterprise Linux 5, 6 and Red Hat Enterprise MRG 2.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=952260&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from www.openwall.com_8d37c354_20250124_232132.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[thread-next>]](../../../2013/04/29/4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <alpine.LFD.2.03.1304151923260.29146@erqung.pbz>
Date: Mon, 15 Apr 2013 19:26:50 +0530 (IST)
From: P J P <ppandit@...hat.com>
To: oss security list <oss-security@...ts.openwall.com>
Subject: CVE request: Linux kernel: cifs: NULL pointer dereference

   Hello,

Linux kernel built with CIFS(CONFIG_CIFS) network file system support is
vulnerable to a NULL pointer dereference flaw. It could occur during a
re-connection attempt.

A user/program could use this flaw to crash the system resulting in a DoS.

Upstream fix:
-------------
  -> <https://git.kernel.org/linus/ea702b80e0bbb2448e201472127288beb82ca2fe>

Reference:
----------
  -> <https://bugzilla.redhat.com/show_bug.cgi?id=952260>

Thank you.
--
Prasad J Pandit / Red Hat Security Response Team
DB7A 84C5 D3F9 7CD1 B5EB  C939 D048 7860 3655 602B

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_cf10b12b_20250124_232134.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fea702b80e0bbb2448e201472127288beb82ca2fe)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fea702b80e0bbb2448e201472127288beb82ca2fe)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/ea702b80e0bbb2448e201472127288beb82ca2fe)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

cifs: move check for NULL socket into smb\_send\_rqst

[Browse files](/torvalds/linux/tree/ea702b80e0bbb2448e201472127288beb82ca2fe)
Browse the repository at this point in the history

```
Cai reported this oops:

[90701.616664] BUG: unable to handle kernel NULL pointer dereference at 0000000000000028
[90701.625438] IP: [<ffffffff814a343e>] kernel_setsockopt+0x2e/0x60
[90701.632167] PGD fea319067 PUD 103fda4067 PMD 0
[90701.637255] Oops: 0000 [#1] SMP
[90701.640878] Modules linked in: des_generic md4 nls_utf8 cifs dns_resolver binfmt_misc tun sg igb iTCO_wdt iTCO_vendor_support lpc_ich pcspkr i2c_i801 i2c_core i7core_edac edac_core ioatdma dca mfd_core coretemp kvm_intel kvm crc32c_intel microcode sr_mod cdrom ata_generic sd_mod pata_acpi crc_t10dif ata_piix libata megaraid_sas dm_mirror dm_region_hash dm_log dm_mod
[90701.677655] CPU 10
[90701.679808] Pid: 9627, comm: ls Tainted: G        W    3.7.1+ [#10](https://github.com/torvalds/linux/pull/10) QCI QSSC-S4R/QSSC-S4R
[90701.688950] RIP: 0010:[<ffffffff814a343e>]  [<ffffffff814a343e>] kernel_setsockopt+0x2e/0x60
[90701.698383] RSP: 0018:ffff88177b431bb8  EFLAGS: 00010206
[90701.704309] RAX: ffff88177b431fd8 RBX: 00007ffffffff000 RCX: ffff88177b431bec
[90701.712271] RDX: 0000000000000003 RSI: 0000000000000006 RDI: 0000000000000000
[90701.720223] RBP: ffff88177b431bc8 R08: 0000000000000004 R09: 0000000000000000
[90701.728185] R10: 0000000000000001 R11: 0000000000000000 R12: 0000000000000001
[90701.736147] R13: ffff88184ef92000 R14: 0000000000000023 R15: ffff88177b431c88
[90701.744109] FS:  00007fd56a1a47c0(0000) GS:ffff88105fc40000(0000) knlGS:0000000000000000
[90701.753137] CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
[90701.759550] CR2: 0000000000000028 CR3: 000000104f15f000 CR4: 00000000000007e0
[90701.767512] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[90701.775465] DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
[90701.783428] Process ls (pid: 9627, threadinfo ffff88177b430000, task ffff88185ca4cb60)
[90701.792261] Stack:
[90701.794505]  0000000000000023 ffff88177b431c50 ffff88177b431c38 ffffffffa014fcb1
[90701.802809]  ffff88184ef921bc 0000000000000000 00000001ffffffff ffff88184ef921c0
[90701.811123]  ffff88177b431c08 ffffffff815ca3d9 ffff88177b431c18 ffff880857758000
[90701.819433] Call Trace:
[90701.822183]  [<ffffffffa014fcb1>] smb_send_rqst+0x71/0x1f0 [cifs]
[90701.828991]  [<ffffffff815ca3d9>] ? schedule+0x29/0x70
[90701.834736]  [<ffffffffa014fe6d>] smb_sendv+0x3d/0x40 [cifs]
[90701.841062]  [<ffffffffa014fe96>] smb_send+0x26/0x30 [cifs]
[90701.847291]  [<ffffffffa015801f>] send_nt_cancel+0x6f/0xd0 [cifs]
[90701.854102]  [<ffffffffa015075e>] SendReceive+0x18e/0x360 [cifs]
[90701.860814]  [<ffffffffa0134a78>] CIFSFindFirst+0x1a8/0x3f0 [cifs]
[90701.867724]  [<ffffffffa013f731>] ? build_path_from_dentry+0xf1/0x260 [cifs]
[90701.875601]  [<ffffffffa013f731>] ? build_path_from_dentry+0xf1/0x260 [cifs]
[90701.883477]  [<ffffffffa01578e6>] cifs_query_dir_first+0x26/0x30 [cifs]
[90701.890869]  [<ffffffffa015480d>] initiate_cifs_search+0xed/0x250 [cifs]
[90701.898354]  [<ffffffff81195970>] ? fillonedir+0x100/0x100
[90701.904486]  [<ffffffffa01554cb>] cifs_readdir+0x45b/0x8f0 [cifs]
[90701.911288]  [<ffffffff81195970>] ? fillonedir+0x100/0x100
[90701.917410]  [<ffffffff81195970>] ? fillonedir+0x100/0x100
[90701.923533]  [<ffffffff81195970>] ? fillonedir+0x100/0x100
[90701.929657]  [<ffffffff81195848>] vfs_readdir+0xb8/0xe0
[90701.935490]  [<ffffffff81195b9f>] sys_getdents+0x8f/0x110
[90701.941521]  [<ffffffff815d3b99>] system_call_fastpath+0x16/0x1b
[90701.948222] Code: 66 90 55 65 48 8b 04 25 f0 c6 00 00 48 89 e5 53 48 83 ec 08 83 fe 01 48 8b 98 48 e0 ff ff 48 c7 80 48 e0 ff ff ff ff ff ff 74 22 <48> 8b 47 28 ff 50 68 65 48 8b 14 25 f0 c6 00 00 48 89 9a 48 e0
[90701.970313] RIP  [<ffffffff814a343e>] kernel_setsockopt+0x2e/0x60
[90701.977125]  RSP <ffff88177b431bb8>
[90701.981018] CR2: 0000000000000028
[90701.984809] ---[ end trace 24bd602971110a43 ]---

This is likely due to a race vs. a reconnection event.

The current code checks for a NULL socket in smb_send_kvec, but that's
too late. By the time that check is done, the socket will already have
been passed to kernel_setsockopt. Move the check into smb_send_rqst, so
that it's checked earlier.

In truth, this is a bit of a half-assed fix. The -ENOTSOCK error
return here looks like it could bubble back up to userspace. The locking
rules around the ssocket pointer are really unclear as well. There are
cases where the ssocket pointer is changed without holding the srv_mutex,
but I'm not clear whether there's a potential race here yet or not.

This code seems like it could benefit from some fundamental re-think of
how the socket handling should behave. Until then though, this patch
should at least fix the above oops in most cases.

Cc: <stable@vger.kernel.org> # 3.7+
Reported-and-Tested-by: CAI Qian <caiqian@redhat.com>
Signed-off-by: Jeff Layton <jlayton@redhat.com>
Signed-off-by: Steve French <smfrench@gmail.com>
```

* Loading branch information

[![@jtlayton](https://avatars.githubusercontent.com/u/10671515?s=40&v=4)](/jtlayton) [![@smfrench](https://avatars.githubusercontent.com/u/15021814?s=40&v=4)](/smfrench)

[jtlayton](/torvalds/linux/commits?author=jtlayton "View all commits by jtlayton")
authored and
[smfrench](/torvalds/linux/commits?author=smfrench "View all commits by smfrench")
committed
Dec 30, 2012

1 parent
[ecccd12](/torvalds/linux/commit/ecccd1248d6e6986130ffcc3b0d003cb46a485c0)

commit ea702b8

Showing
**1 changed file**
with
**3 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 3 additions & 3 deletions

6
[fs/cifs/transport.c](#diff-f8b55262a89edf4f64e98aba929e6d3a400601cf6df5c0fbbe3c9e3b9bf30be2 "fs/cifs/transport.c")

Show comments

[View file](/torvalds/linux/blob/ea702b80e0bbb2448e201472127288beb82ca2fe/fs/cifs/transport.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -144,9 +144,6 @@ smb\_send\_kvec(struct TCP\_Server\_Info \*server, struct kvec \*iov, size\_t n\_vec, |
|  |  |  |
|  |  | \*sent = 0; |
|  |  |  |
|  |  | if (ssocket == NULL) |
|  |  | return -ENOTSOCK; /\* BB eventually add reconnect code here \*/ |
|  |  |  |
|  |  | smb\_msg.msg\_name = (struct sockaddr \*) &server->dstaddr; |
|  |  | smb\_msg.msg\_namelen = sizeof(struct sockaddr); |
|  |  | smb\_msg.msg\_control = NULL; |
| Expand Down  Expand Up | | @@ -291,6 +288,9 @@ smb\_send\_rqst(struct TCP\_Server\_Info \*server, struct smb\_rqst \*rqst) |
|  |  | struct socket \*ssocket = server->ssocket; |
|  |  | int val = 1; |
|  |  |  |
|  |  | if (ssocket == NULL) |
|  |  | return -ENOTSOCK; |
|  |  |  |
|  |  | cFYI(1, "Sending smb: smb\_len=%u", smb\_buf\_length); |
|  |  | dump\_smb(iov[0].iov\_base, iov[0].iov\_len); |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ea702b8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fea702b80e0bbb2448e201472127288beb82ca2fe) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


